# Comparing `tmp/megfile-2.2.0-py3-none-any.whl.zip` & `tmp/megfile-2.2.0.post1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,47 +1,47 @@
-Zip file size: 109401 bytes, number of entries: 45
+Zip file size: 109689 bytes, number of entries: 45
 -rw-rw-r--  2.0 unx     5721 b- defN 23-Aug-01 02:09 megfile/__init__.py
--rw-rw-r--  2.0 unx    12797 b- defN 23-Aug-01 01:53 megfile/cli.py
--rw-rw-r--  2.0 unx    11349 b- defN 23-Jun-16 11:38 megfile/errors.py
+-rw-rw-r--  2.0 unx    12806 b- defN 23-Aug-03 05:11 megfile/cli.py
+-rw-rw-r--  2.0 unx    11491 b- defN 23-Aug-03 05:11 megfile/errors.py
 -rw-rw-r--  2.0 unx    11621 b- defN 23-Jul-24 07:01 megfile/fs.py
 -rw-rw-r--  2.0 unx    38532 b- defN 23-Jul-07 05:32 megfile/fs_path.py
 -rw-rw-r--  2.0 unx     2477 b- defN 23-Jul-24 07:01 megfile/http.py
 -rw-rw-r--  2.0 unx     5360 b- defN 23-Jul-11 07:49 megfile/http_path.py
 -rw-rw-r--  2.0 unx     6219 b- defN 23-Jul-07 04:07 megfile/interfaces.py
 -rw-rw-r--  2.0 unx    29307 b- defN 23-Jul-07 04:07 megfile/pathlike.py
 -rw-rw-r--  2.0 unx    12437 b- defN 23-Jul-24 07:01 megfile/s3.py
--rw-rw-r--  2.0 unx    84754 b- defN 23-Jul-10 05:12 megfile/s3_path.py
+-rw-rw-r--  2.0 unx    85287 b- defN 23-Aug-03 06:45 megfile/s3_path.py
 -rw-rw-r--  2.0 unx    11943 b- defN 23-Jul-24 07:01 megfile/sftp.py
--rw-rw-r--  2.0 unx    47103 b- defN 23-Jul-27 10:06 megfile/sftp_path.py
+-rw-rw-r--  2.0 unx    47288 b- defN 23-Aug-03 06:45 megfile/sftp_path.py
 -rw-rw-r--  2.0 unx    32694 b- defN 23-Jul-24 03:23 megfile/smart.py
 -rw-rw-r--  2.0 unx     6708 b- defN 23-Jul-21 05:33 megfile/smart_path.py
 -rw-rw-r--  2.0 unx      559 b- defN 23-Jul-24 07:01 megfile/stdio.py
 -rw-rw-r--  2.0 unx     2682 b- defN 23-Jun-16 02:18 megfile/stdio_path.py
--rw-rw-r--  2.0 unx       19 b- defN 23-Aug-01 02:31 megfile/version.py
+-rw-rw-r--  2.0 unx       25 b- defN 23-Aug-03 06:59 megfile/version.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-May-25 06:42 megfile/lib/__init__.py
--rw-rw-r--  2.0 unx     4546 b- defN 23-Aug-01 01:57 megfile/lib/combine_reader.py
+-rw-rw-r--  2.0 unx     4546 b- defN 23-Aug-03 06:32 megfile/lib/combine_reader.py
 -rw-rw-r--  2.0 unx     2233 b- defN 23-Jun-13 05:49 megfile/lib/compare.py
 -rw-rw-r--  2.0 unx     3033 b- defN 23-Aug-01 01:53 megfile/lib/compat.py
 -rw-rw-r--  2.0 unx     4054 b- defN 23-May-25 06:42 megfile/lib/fnmatch.py
 -rw-rw-r--  2.0 unx     9732 b- defN 23-Jul-07 05:32 megfile/lib/glob.py
 -rw-rw-r--  2.0 unx      929 b- defN 23-May-25 06:42 megfile/lib/joinpath.py
 -rw-rw-r--  2.0 unx     1915 b- defN 23-May-25 06:42 megfile/lib/lazy_handler.py
 -rw-rw-r--  2.0 unx     6934 b- defN 23-May-25 06:42 megfile/lib/s3_buffered_writer.py
 -rw-rw-r--  2.0 unx     1322 b- defN 23-May-25 06:42 megfile/lib/s3_cached_handler.py
 -rw-rw-r--  2.0 unx     6037 b- defN 23-Jul-07 05:32 megfile/lib/s3_limited_seekable_writer.py
 -rw-rw-r--  2.0 unx     3725 b- defN 23-May-25 06:42 megfile/lib/s3_memory_handler.py
 -rw-rw-r--  2.0 unx     3384 b- defN 23-Jul-07 05:32 megfile/lib/s3_pipe_handler.py
--rw-rw-r--  2.0 unx    15033 b- defN 23-Jul-07 05:32 megfile/lib/s3_prefetch_reader.py
--rw-rw-r--  2.0 unx     3771 b- defN 23-Aug-01 01:57 megfile/lib/s3_share_cache_reader.py
+-rw-rw-r--  2.0 unx    15113 b- defN 23-Aug-03 06:45 megfile/lib/s3_prefetch_reader.py
+-rw-rw-r--  2.0 unx     3771 b- defN 23-Aug-03 06:32 megfile/lib/s3_share_cache_reader.py
 -rw-rw-r--  2.0 unx     2683 b- defN 23-May-25 06:42 megfile/lib/shadow_handler.py
 -rw-rw-r--  2.0 unx     2044 b- defN 23-May-25 06:42 megfile/lib/stdio_handler.py
 -rw-rw-r--  2.0 unx      103 b- defN 23-Jun-16 02:18 megfile/lib/url.py
 -rw-rw-r--  2.0 unx     9005 b- defN 23-Jul-07 05:32 megfile/utils/__init__.py
 -rw-rw-r--  2.0 unx     2538 b- defN 23-Jul-13 03:47 megfile/utils/mutex.py
--rw-rw-r--  2.0 unx    11357 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/LICENSE
--rw-rw-r--  2.0 unx     1080 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/LICENSE.pyre
--rw-rw-r--  2.0 unx    10595 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/WHEEL
--rw-rw-r--  2.0 unx       49 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        8 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3603 b- defN 23-Aug-01 02:32 megfile-2.2.0.dist-info/RECORD
-45 files, 432087 bytes uncompressed, 103771 bytes compressed:  76.0%
+-rw-rw-r--  2.0 unx    11357 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     1080 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/LICENSE.pyre
+-rw-rw-r--  2.0 unx    10601 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       49 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        8 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     3645 b- defN 23-Aug-03 06:59 megfile-2.2.0.post1.dist-info/RECORD
+45 files, 433090 bytes uncompressed, 103975 bytes compressed:  76.0%
```

## zipnote {}

```diff
@@ -108,29 +108,29 @@
 
 Filename: megfile/utils/__init__.py
 Comment: 
 
 Filename: megfile/utils/mutex.py
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/LICENSE
+Filename: megfile-2.2.0.post1.dist-info/LICENSE
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/LICENSE.pyre
+Filename: megfile-2.2.0.post1.dist-info/LICENSE.pyre
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/METADATA
+Filename: megfile-2.2.0.post1.dist-info/METADATA
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/WHEEL
+Filename: megfile-2.2.0.post1.dist-info/WHEEL
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/entry_points.txt
+Filename: megfile-2.2.0.post1.dist-info/entry_points.txt
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/top_level.txt
+Filename: megfile-2.2.0.post1.dist-info/top_level.txt
 Comment: 
 
-Filename: megfile-2.2.0.dist-info/RECORD
+Filename: megfile-2.2.0.post1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## megfile/cli.py

```diff
@@ -315,21 +315,22 @@
     '-n',
     '--lines',
     type=click.INT,
     default=10,
     help='print the first NUM lines')
 def head(path: str, lines: int):
     with smart_open(path, 'rb') as f:
-        f.seek(0, os.SEEK_END)
-        file_size = f.tell()
-        f.seek(0, os.SEEK_SET)
         for _ in range(lines):
-            click.echo(f.readline().strip(b'\n'))
-            if f.tell() >= file_size:
+            try:
+                content = f.readline()
+                if not content:
+                    break
+            except EOFError:
                 break
+            click.echo(content.strip(b'\n'))
 
 
 @cli.command(
     short_help='Concatenate any files and send last n lines of them to stdout.')
 @click.argument('path')
 @click.option(
     '-n',
```

## megfile/errors.py

```diff
@@ -135,24 +135,27 @@
             before_callback(*args, **kwargs)
 
         for retries in range(1, max_retries + 1):
             try:
                 result = func(*args, **kwargs)
                 if after_callback is not None:
                     result = after_callback(result, *args, **kwargs)
+                if retries > 1:
+                    _logger.info(
+                        f'Error already fixed by retry {retries - 1} times')
                 return result
             except Exception as error:
                 if not should_retry(error):
                     raise
                 if retry_callback is not None:
                     retry_callback(error, *args, **kwargs)
                 if retries == max_retries:
                     raise
                 retry_interval = min(0.1 * 2**retries, 30)
-                _logger.debug(
+                _logger.info(
                     'unknown error encountered: %s, retry in %0.1f seconds after %d tries'
                     % (full_error_message(error), retry_interval, retries))
                 time.sleep(retry_interval)
 
     return wrapper
```

## megfile/s3_path.py

```diff
@@ -1927,3372 +1927,3405 @@
 00007860: 7065 7269 6f64 6963 616c 6c79 2064 7572  periodically dur
 00007870: 696e 6720 636f 7079 2c20 616e 6420 7468  ing copy, and th
 00007880: 6520 696e 7075 7420 7061 7261 6d65 7465  e input paramete
 00007890: 7220 6973 2074 6865 2064 6174 6120 7369  r is the data si
 000078a0: 7a65 2028 696e 2062 7974 6573 2920 6f66  ze (in bytes) of
 000078b0: 2063 6f70 7920 7369 6e63 6520 7468 6520   copy since the 
 000078c0: 6c61 7374 2063 616c 6c0a 2020 2020 2727  last call.    ''
-000078d0: 270a 2020 2020 7372 635f 7572 6c20 3d20  '.    src_url = 
-000078e0: 5333 5061 7468 2873 7263 5f75 726c 290a  S3Path(src_url).
-000078f0: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
-00007900: 6b73 3a0a 2020 2020 2020 2020 7472 793a  ks:.        try:
-00007910: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
-00007920: 5f75 726c 203d 2073 7263 5f75 726c 2e72  _url = src_url.r
-00007930: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
-00007940: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
-00007950: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
-00007960: 2020 2020 2020 7061 7373 0a20 2020 2073        pass.    s
-00007970: 7263 5f62 7563 6b65 742c 2073 7263 5f6b  rc_bucket, src_k
-00007980: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00007990: 6c28 7372 635f 7572 6c2e 7061 7468 5f77  l(src_url.path_w
-000079a0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-000079b0: 2020 6966 206e 6f74 2073 7263 5f62 7563    if not src_buc
-000079c0: 6b65 743a 0a20 2020 2020 2020 2072 6169  ket:.        rai
-000079d0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-000079e0: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
-000079f0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
-00007a00: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
-00007a10: 7372 635f 7572 6c2e 7061 7468 5f77 6974  src_url.path_wit
-00007a20: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
-00007a30: 2069 6620 6e6f 7420 7372 635f 7572 6c2e   if not src_url.
-00007a40: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
-00007a50: 2020 7261 6973 6520 5333 4669 6c65 4e6f    raise S3FileNo
-00007a60: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
-00007a70: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
-00007a80: 6f74 2066 6f75 6e64 3a20 2572 2720 2520  ot found: %r' % 
-00007a90: 7372 635f 7572 6c2e 7061 7468 5f77 6974  src_url.path_wit
-00007aa0: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
-00007ab0: 2069 6620 6e6f 7420 7372 635f 7572 6c2e   if not src_url.
-00007ac0: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
-00007ad0: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
-00007ae0: 7265 6374 6f72 7945 7272 6f72 280a 2020  rectoryError(.  
-00007af0: 2020 2020 2020 2020 2020 2749 7320 6120            'Is a 
-00007b00: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
-00007b10: 2073 7263 5f75 726c 2e70 6174 685f 7769   src_url.path_wi
-00007b20: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
-00007b30: 2020 6473 745f 7572 6c20 3d20 6673 7061    dst_url = fspa
-00007b40: 7468 2864 7374 5f75 726c 290a 2020 2020  th(dst_url).    
-00007b50: 6966 206e 6f74 2064 7374 5f75 726c 206f  if not dst_url o
-00007b60: 7220 6473 745f 7572 6c2e 656e 6473 7769  r dst_url.endswi
-00007b70: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-00007b80: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-00007b90: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-00007ba0: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-00007bb0: 2520 6473 745f 7572 6c29 0a0a 2020 2020  % dst_url)..    
-00007bc0: 6473 745f 6469 7265 6374 6f72 7920 3d20  dst_directory = 
-00007bd0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
-00007be0: 6473 745f 7572 6c29 0a20 2020 2069 6620  dst_url).    if 
-00007bf0: 6473 745f 6469 7265 6374 6f72 7920 213d  dst_directory !=
-00007c00: 2027 273a 0a20 2020 2020 2020 206f 732e   '':.        os.
-00007c10: 6d61 6b65 6469 7273 2864 7374 5f64 6972  makedirs(dst_dir
-00007c20: 6563 746f 7279 2c20 6578 6973 745f 6f6b  ectory, exist_ok
-00007c30: 3d54 7275 6529 0a0a 2020 2020 636c 6965  =True)..    clie
-00007c40: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
-00007c50: 6e74 2870 726f 6669 6c65 5f6e 616d 653d  nt(profile_name=
-00007c60: 7372 635f 7572 6c2e 5f70 726f 6669 6c65  src_url._profile
-00007c70: 5f6e 616d 6529 0a20 2020 2074 7279 3a0a  _name).    try:.
-00007c80: 2020 2020 2020 2020 636c 6965 6e74 2e64          client.d
-00007c90: 6f77 6e6c 6f61 645f 6669 6c65 2873 7263  ownload_file(src
-00007ca0: 5f62 7563 6b65 742c 2073 7263 5f6b 6579  _bucket, src_key
-00007cb0: 2c20 6473 745f 7572 6c2c 2043 616c 6c62  , dst_url, Callb
-00007cc0: 6163 6b3d 6361 6c6c 6261 636b 290a 2020  ack=callback).  
-00007cd0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00007ce0: 6f6e 2061 7320 6572 726f 723a 0a20 2020  on as error:.   
-00007cf0: 2020 2020 2065 7272 6f72 203d 2074 7261       error = tra
-00007d00: 6e73 6c61 7465 5f66 735f 6572 726f 7228  nslate_fs_error(
-00007d10: 6572 726f 722c 2064 7374 5f75 726c 290a  error, dst_url).
-00007d20: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
-00007d30: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
-00007d40: 6f72 2865 7272 6f72 2c20 7372 635f 7572  or(error, src_ur
-00007d50: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
-00007d60: 6f63 6f6c 290a 2020 2020 2020 2020 7261  ocol).        ra
-00007d70: 6973 6520 6572 726f 720a 0a20 2020 2073  ise error..    s
-00007d80: 7263 5f73 7461 7420 3d20 7372 635f 7572  rc_stat = src_ur
-00007d90: 6c2e 7374 6174 2829 0a20 2020 206f 732e  l.stat().    os.
-00007da0: 7574 696d 6528 6473 745f 7572 6c2c 2028  utime(dst_url, (
-00007db0: 7372 635f 7374 6174 2e73 745f 6d74 696d  src_stat.st_mtim
-00007dc0: 652c 2073 7263 5f73 7461 742e 7374 5f6d  e, src_stat.st_m
-00007dd0: 7469 6d65 2929 0a0a 0a64 6566 2073 335f  time))...def s3_
-00007de0: 7570 6c6f 6164 280a 2020 2020 2020 2020  upload(.        
-00007df0: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
-00007e00: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
-00007e10: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-00007e20: 2020 2020 2020 6361 6c6c 6261 636b 3a20        callback: 
-00007e30: 4f70 7469 6f6e 616c 5b43 616c 6c61 626c  Optional[Callabl
-00007e40: 655b 5b69 6e74 5d2c 204e 6f6e 655d 5d20  e[[int], None]] 
-00007e50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00007e60: 2a2a 6b77 6172 6773 2920 2d3e 204e 6f6e  **kwargs) -> Non
-00007e70: 653a 0a20 2020 2027 2727 0a20 2020 2055  e:.    '''.    U
-00007e80: 706c 6f61 6473 2061 2066 696c 6520 6672  ploads a file fr
-00007e90: 6f6d 206c 6f63 616c 2066 696c 6573 7973  om local filesys
-00007ea0: 7465 6d20 746f 2073 332e 0a20 2020 203a  tem to s3..    :
-00007eb0: 7061 7261 6d20 7372 635f 7572 6c3a 2073  param src_url: s
-00007ec0: 6f75 7263 6520 6673 2070 6174 680a 2020  ource fs path.  
-00007ed0: 2020 3a70 6172 616d 2064 7374 5f75 726c    :param dst_url
-00007ee0: 3a20 7461 7267 6574 2073 3320 7061 7468  : target s3 path
-00007ef0: 0a20 2020 203a 7061 7261 6d20 6361 6c6c  .    :param call
-00007f00: 6261 636b 3a20 4361 6c6c 6564 2070 6572  back: Called per
-00007f10: 696f 6469 6361 6c6c 7920 6475 7269 6e67  iodically during
-00007f20: 2063 6f70 792c 2061 6e64 2074 6865 2069   copy, and the i
-00007f30: 6e70 7574 2070 6172 616d 6574 6572 2069  nput parameter i
-00007f40: 7320 7468 6520 6461 7461 2073 697a 6520  s the data size 
-00007f50: 2869 6e20 6279 7465 7329 206f 6620 636f  (in bytes) of co
-00007f60: 7079 2073 696e 6365 2074 6865 206c 6173  py since the las
-00007f70: 7420 6361 6c6c 0a20 2020 2027 2727 0a20  t call.    '''. 
-00007f80: 2020 2064 7374 5f62 7563 6b65 742c 2064     dst_bucket, d
-00007f90: 7374 5f6b 6579 203d 2070 6172 7365 5f73  st_key = parse_s
-00007fa0: 335f 7572 6c28 6473 745f 7572 6c29 0a20  3_url(dst_url). 
-00007fb0: 2020 2069 6620 6e6f 7420 6473 745f 6275     if not dst_bu
-00007fc0: 636b 6574 3a0a 2020 2020 2020 2020 7261  cket:.        ra
-00007fd0: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-00007fe0: 6f75 6e64 4572 726f 7228 2745 6d70 7479  oundError('Empty
-00007ff0: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
-00008000: 2720 2520 6473 745f 7572 6c29 0a20 2020  ' % dst_url).   
-00008010: 2069 6620 6e6f 7420 6473 745f 6b65 7920   if not dst_key 
-00008020: 6f72 2064 7374 5f6b 6579 2e65 6e64 7377  or dst_key.endsw
-00008030: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
-00008040: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
-00008050: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
-00008060: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
-00008070: 2025 2064 7374 5f75 726c 290a 0a20 2020   % dst_url)..   
-00008080: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-00008090: 5f63 6c69 656e 7428 7072 6f66 696c 655f  _client(profile_
-000080a0: 6e61 6d65 3d53 3350 6174 6828 6473 745f  name=S3Path(dst_
-000080b0: 7572 6c29 2e5f 7072 6f66 696c 655f 6e61  url)._profile_na
-000080c0: 6d65 290a 2020 2020 7769 7468 206f 7065  me).    with ope
-000080d0: 6e28 7372 635f 7572 6c2c 2027 7262 2729  n(src_url, 'rb')
-000080e0: 2061 7320 7372 633a 0a20 2020 2020 2020   as src:.       
-000080f0: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
-00008100: 7272 6f72 2864 7374 5f75 726c 293a 0a20  rror(dst_url):. 
-00008110: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-00008120: 742e 7570 6c6f 6164 5f66 696c 656f 626a  t.upload_fileobj
-00008130: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008140: 2020 7372 632c 2042 7563 6b65 743d 6473    src, Bucket=ds
-00008150: 745f 6275 636b 6574 2c20 4b65 793d 6473  t_bucket, Key=ds
-00008160: 745f 6b65 792c 2043 616c 6c62 6163 6b3d  t_key, Callback=
-00008170: 6361 6c6c 6261 636b 290a 0a0a 6465 6620  callback)...def 
-00008180: 7333 5f6c 6f61 645f 636f 6e74 656e 7428  s3_load_content(
-00008190: 0a20 2020 2020 2020 2073 335f 7572 6c2c  .        s3_url,
-000081a0: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
-000081b0: 4f70 7469 6f6e 616c 5b69 6e74 5d20 3d20  Optional[int] = 
-000081c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7374  None,.        st
-000081d0: 6f70 3a20 4f70 7469 6f6e 616c 5b69 6e74  op: Optional[int
-000081e0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
-000081f0: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-00008200: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
-00008210: 6279 7465 733a 0a20 2020 2027 2727 0a20  bytes:.    '''. 
-00008220: 2020 2047 6574 2073 7065 6369 6669 6564     Get specified
-00008230: 2066 696c 6520 6672 6f6d 205b 7374 6172   file from [star
-00008240: 742c 2073 746f 7029 2069 6e20 6279 7465  t, stop) in byte
-00008250: 730a 0a20 2020 203a 7061 7261 6d20 7333  s..    :param s3
-00008260: 5f75 726c 3a20 5370 6563 6966 6965 6420  _url: Specified 
-00008270: 7061 7468 0a20 2020 203a 7061 7261 6d20  path.    :param 
-00008280: 7374 6172 743a 2073 7461 7274 2069 6e64  start: start ind
-00008290: 6578 0a20 2020 203a 7061 7261 6d20 7374  ex.    :param st
-000082a0: 6f70 3a20 7374 6f70 2069 6e64 6578 0a20  op: stop index. 
-000082b0: 2020 203a 7265 7475 726e 733a 2062 7974     :returns: byt
-000082c0: 6573 2063 6f6e 7465 6e74 2069 6e20 7261  es content in ra
-000082d0: 6e67 6520 5b73 7461 7274 2c20 7374 6f70  nge [start, stop
-000082e0: 290a 2020 2020 2727 270a 0a20 2020 2064  ).    '''..    d
-000082f0: 6566 205f 6765 745f 6f62 6a65 6374 2863  ef _get_object(c
-00008300: 6c69 656e 742c 2062 7563 6b65 742c 206b  lient, bucket, k
-00008310: 6579 2c20 7261 6e67 655f 7374 7229 3a0a  ey, range_str):.
-00008320: 2020 2020 2020 2020 7265 7475 726e 2063          return c
-00008330: 6c69 656e 742e 6765 745f 6f62 6a65 6374  lient.get_object
-00008340: 280a 2020 2020 2020 2020 2020 2020 4275  (.            Bu
-00008350: 636b 6574 3d62 7563 6b65 742c 204b 6579  cket=bucket, Key
-00008360: 3d6b 6579 2c20 5261 6e67 653d 7261 6e67  =key, Range=rang
-00008370: 655f 7374 7229 5b27 426f 6479 275d 2e72  e_str)['Body'].r
-00008380: 6561 6428 290a 0a20 2020 2073 335f 7572  ead()..    s3_ur
-00008390: 6c20 3d20 5333 5061 7468 2873 335f 7572  l = S3Path(s3_ur
-000083a0: 6c29 0a20 2020 2069 6620 666f 6c6c 6f77  l).    if follow
-000083b0: 6c69 6e6b 733a 0a20 2020 2020 2020 2074  links:.        t
-000083c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000083d0: 7333 5f75 726c 203d 2073 335f 7572 6c2e  s3_url = s3_url.
-000083e0: 7265 6164 6c69 6e6b 2829 0a20 2020 2020  readlink().     
-000083f0: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
-00008400: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
-00008410: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00008420: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
-00008430: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
-00008440: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
-00008450: 746f 636f 6c29 0a20 2020 2069 6620 6e6f  tocol).    if no
-00008460: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-00008470: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
-00008480: 4e6f 7446 6f75 6e64 4572 726f 7228 2745  NotFoundError('E
-00008490: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
-000084a0: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
-000084b0: 2020 2020 6966 206e 6f74 206b 6579 206f      if not key o
-000084c0: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
-000084d0: 2f27 293a 0a20 2020 2020 2020 2072 6169  /'):.        rai
-000084e0: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
-000084f0: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
-00008500: 6563 746f 7279 3a20 2572 2720 2520 7333  ectory: %r' % s3
-00008510: 5f75 726c 290a 0a20 2020 2073 7461 7274  _url)..    start
-00008520: 2c20 7374 6f70 203d 2067 6574 5f63 6f6e  , stop = get_con
-00008530: 7465 6e74 5f6f 6666 7365 7428 0a20 2020  tent_offset(.   
-00008540: 2020 2020 2073 7461 7274 2c20 7374 6f70       start, stop
-00008550: 2c20 7333 5f75 726c 2e67 6574 7369 7a65  , s3_url.getsize
-00008560: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
-00008570: 3d46 616c 7365 2929 0a20 2020 2069 6620  =False)).    if 
-00008580: 7374 6172 7420 3d3d 2030 2061 6e64 2073  start == 0 and s
-00008590: 746f 7020 3d3d 2030 3a0a 2020 2020 2020  top == 0:.      
-000085a0: 2020 7265 7475 726e 2062 2727 0a20 2020    return b''.   
-000085b0: 2072 616e 6765 5f73 7472 203d 2027 6279   range_str = 'by
-000085c0: 7465 733d 2564 2d25 6427 2025 2028 7374  tes=%d-%d' % (st
-000085d0: 6172 742c 2073 746f 7020 2d20 3129 0a0a  art, stop - 1)..
-000085e0: 2020 2020 636c 6965 6e74 203d 2067 6574      client = get
-000085f0: 5f73 335f 636c 6965 6e74 2870 726f 6669  _s3_client(profi
-00008600: 6c65 5f6e 616d 653d 7333 5f75 726c 2e5f  le_name=s3_url._
-00008610: 7072 6f66 696c 655f 6e61 6d65 290a 2020  profile_name).  
-00008620: 2020 7769 7468 2072 6169 7365 5f73 335f    with raise_s3_
-00008630: 6572 726f 7228 7333 5f75 726c 2e70 6174  error(s3_url.pat
-00008640: 6829 3a0a 2020 2020 2020 2020 7265 7475  h):.        retu
-00008650: 726e 2070 6174 6368 5f6d 6574 686f 6428  rn patch_method(
-00008660: 0a20 2020 2020 2020 2020 2020 205f 6765  .            _ge
-00008670: 745f 6f62 6a65 6374 2c0a 2020 2020 2020  t_object,.      
-00008680: 2020 2020 2020 6d61 785f 7265 7472 6965        max_retrie
-00008690: 733d 6d61 785f 7265 7472 6965 732c 0a20  s=max_retries,. 
-000086a0: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
-000086b0: 645f 7265 7472 793d 7333 5f73 686f 756c  d_retry=s3_shoul
-000086c0: 645f 7265 7472 792c 0a20 2020 2020 2020  d_retry,.       
-000086d0: 2029 2863 6c69 656e 742c 2062 7563 6b65   )(client, bucke
-000086e0: 742c 206b 6579 2c20 7261 6e67 655f 7374  t, key, range_st
-000086f0: 7229 0a0a 0a64 6566 2073 335f 7265 6164  r)...def s3_read
-00008700: 6c69 6e6b 2870 6174 6829 202d 3e20 7374  link(path) -> st
-00008710: 723a 0a20 2020 2027 2727 0a20 2020 2052  r:.    '''.    R
-00008720: 6574 7572 6e20 6120 7374 7269 6e67 2072  eturn a string r
-00008730: 6570 7265 7365 6e74 696e 6720 7468 6520  epresenting the 
-00008740: 7061 7468 2074 6f20 7768 6963 6820 7468  path to which th
-00008750: 6520 7379 6d62 6f6c 6963 206c 696e 6b20  e symbolic link 
-00008760: 706f 696e 7473 2e0a 0a20 2020 203a 7265  points...    :re
-00008770: 7475 726e 733a 2052 6574 7572 6e20 6120  turns: Return a 
-00008780: 7374 7269 6e67 2072 6570 7265 7365 6e74  string represent
-00008790: 696e 6720 7468 6520 7061 7468 2074 6f20  ing the path to 
-000087a0: 7768 6963 6820 7468 6520 7379 6d62 6f6c  which the symbol
-000087b0: 6963 206c 696e 6b20 706f 696e 7473 2e0a  ic link points..
-000087c0: 2020 2020 3a72 6169 7365 733a 2053 334e      :raises: S3N
-000087d0: 616d 6554 6f6f 4c6f 6e67 4572 726f 722c  ameTooLongError,
-000087e0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-000087f0: 6445 7272 6f72 2c20 5333 4973 4144 6972  dError, S3IsADir
-00008800: 6563 746f 7279 4572 726f 722c 2053 334e  ectoryError, S3N
-00008810: 6f74 414c 696e 6b45 7272 6f72 0a20 2020  otALinkError.   
-00008820: 2027 2727 0a20 2020 2072 6574 7572 6e20   '''.    return 
-00008830: 5333 5061 7468 2870 6174 6829 2e72 6561  S3Path(path).rea
-00008840: 646c 696e 6b28 292e 7061 7468 5f77 6974  dlink().path_wit
-00008850: 685f 7072 6f74 6f63 6f6c 0a0a 0a64 6566  h_protocol...def
-00008860: 2073 335f 7265 6e61 6d65 2873 7263 5f75   s3_rename(src_u
-00008870: 726c 3a20 5061 7468 4c69 6b65 2c20 6473  rl: PathLike, ds
-00008880: 745f 7572 6c3a 2050 6174 684c 696b 6529  t_url: PathLike)
-00008890: 3a0a 2020 2020 2727 270a 2020 2020 4d6f  :.    '''.    Mo
-000088a0: 7665 2073 3320 6669 6c65 2070 6174 6820  ve s3 file path 
-000088b0: 6672 6f6d 2073 7263 5f75 726c 2074 6f20  from src_url to 
-000088c0: 6473 745f 7572 6c0a 0a20 2020 203a 7061  dst_url..    :pa
-000088d0: 7261 6d20 6473 745f 7572 6c3a 2047 6976  ram dst_url: Giv
-000088e0: 656e 2064 6573 7469 6e61 7469 6f6e 2070  en destination p
-000088f0: 6174 680a 2020 2020 2727 270a 2020 2020  ath.    '''.    
-00008900: 7372 635f 7061 7468 5f69 6e73 203d 2053  src_path_ins = S
-00008910: 3350 6174 6828 7372 635f 7572 6c29 0a20  3Path(src_url). 
-00008920: 2020 2069 6620 7372 635f 7061 7468 5f69     if src_path_i
-00008930: 6e73 2e69 735f 6669 6c65 2829 3a0a 2020  ns.is_file():.  
-00008940: 2020 2020 2020 7372 635f 7061 7468 5f69        src_path_i
-00008950: 6e73 2e63 6f70 7928 6473 745f 7572 6c29  ns.copy(dst_url)
-00008960: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00008970: 2020 2073 7263 5f70 6174 685f 696e 732e     src_path_ins.
-00008980: 7379 6e63 2864 7374 5f75 726c 290a 2020  sync(dst_url).  
-00008990: 2020 7372 635f 7061 7468 5f69 6e73 2e72    src_path_ins.r
-000089a0: 656d 6f76 6528 290a 0a0a 636c 6173 7320  emove()...class 
-000089b0: 5333 4361 6368 6572 2846 696c 6543 6163  S3Cacher(FileCac
-000089c0: 6865 7229 3a0a 2020 2020 6361 6368 655f  her):.    cache_
-000089d0: 7061 7468 203d 204e 6f6e 650a 0a20 2020  path = None..   
-000089e0: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
-000089f0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00008a00: 2070 6174 683a 2073 7472 2c20 6361 6368   path: str, cach
-00008a10: 655f 7061 7468 3a20 4f70 7469 6f6e 616c  e_path: Optional
-00008a20: 5b73 7472 5d20 3d20 4e6f 6e65 2c20 6d6f  [str] = None, mo
-00008a30: 6465 3a20 7374 7220 3d20 2772 2729 3a0a  de: str = 'r'):.
-00008a40: 2020 2020 2020 2020 6966 206d 6f64 6520          if mode 
-00008a50: 6e6f 7420 696e 2028 2772 272c 2027 7727  not in ('r', 'w'
-00008a60: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
-00008a70: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00008a80: 7272 6f72 2827 756e 6163 6365 7074 6162  rror('unacceptab
-00008a90: 6c65 206d 6f64 653a 2025 7227 2025 206d  le mode: %r' % m
-00008aa0: 6f64 6529 0a20 2020 2020 2020 2069 6620  ode).        if 
-00008ab0: 6d6f 6465 2069 6e20 2827 7227 2c20 2761  mode in ('r', 'a
-00008ac0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00008ad0: 6966 2063 6163 6865 5f70 6174 6820 6973  if cache_path is
-00008ae0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00008af0: 2020 2020 2020 2063 6163 6865 5f70 6174         cache_pat
-00008b00: 6820 3d20 6765 6e65 7261 7465 5f63 6163  h = generate_cac
-00008b10: 6865 5f70 6174 6828 7061 7468 290a 2020  he_path(path).  
-00008b20: 2020 2020 2020 2020 2020 7333 5f64 6f77            s3_dow
-00008b30: 6e6c 6f61 6428 7061 7468 2c20 6361 6368  nload(path, cach
-00008b40: 655f 7061 7468 290a 2020 2020 2020 2020  e_path).        
-00008b50: 7365 6c66 2e6e 616d 6520 3d20 7061 7468  self.name = path
-00008b60: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
-00008b70: 6465 203d 206d 6f64 650a 2020 2020 2020  de = mode.      
-00008b80: 2020 7365 6c66 2e63 6163 6865 5f70 6174    self.cache_pat
-00008b90: 6820 3d20 6361 6368 655f 7061 7468 0a0a  h = cache_path..
-00008ba0: 2020 2020 6465 6620 5f63 6c6f 7365 2873      def _close(s
-00008bb0: 656c 6629 3a0a 2020 2020 2020 2020 6966  elf):.        if
-00008bc0: 2073 656c 662e 6361 6368 655f 7061 7468   self.cache_path
-00008bd0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-00008be0: 205c 0a20 2020 2020 2020 2020 2020 206f   \.            o
-00008bf0: 732e 7061 7468 2e65 7869 7374 7328 7365  s.path.exists(se
-00008c00: 6c66 2e63 6163 6865 5f70 6174 6829 3a0a  lf.cache_path):.
-00008c10: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00008c20: 656c 662e 6d6f 6465 2069 6e20 2827 7727  elf.mode in ('w'
-00008c30: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
-00008c40: 2020 2020 2020 2020 7333 5f75 706c 6f61          s3_uploa
-00008c50: 6428 7365 6c66 2e63 6163 6865 5f70 6174  d(self.cache_pat
-00008c60: 682c 2073 656c 662e 6e61 6d65 290a 2020  h, self.name).  
-00008c70: 2020 2020 2020 2020 2020 6f73 2e75 6e6c            os.unl
-00008c80: 696e 6b28 7365 6c66 2e63 6163 6865 5f70  ink(self.cache_p
-00008c90: 6174 6829 0a0a 0a64 6566 2073 335f 676c  ath)...def s3_gl
-00008ca0: 6f62 280a 2020 2020 2020 2020 7061 7468  ob(.        path
-00008cb0: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-00008cc0: 2020 2020 7265 6375 7273 6976 653a 2062      recursive: b
-00008cd0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-00008ce0: 2020 2020 6d69 7373 696e 675f 6f6b 3a20      missing_ok: 
-00008cf0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00008d00: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-00008d10: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
-00008d20: 2920 2d3e 204c 6973 745b 7374 725d 3a0a  ) -> List[str]:.
-00008d30: 2020 2020 2727 2752 6574 7572 6e20 7333      '''Return s3
-00008d40: 2070 6174 6820 6c69 7374 2069 6e20 6173   path list in as
-00008d50: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
-00008d60: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
-00008d70: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
-00008d80: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
-00008d90: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
-00008da0: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
-00008db0: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
-00008dc0: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
-00008dd0: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
-00008de0: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
-00008df0: 7274 6564 4572 726f 720a 0a20 2020 203a  rtedError..    :
-00008e00: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
-00008e10: 2049 6620 4661 6c73 652c 2060 2a2a 6020   If False, `**` 
-00008e20: 7769 6c6c 206e 6f74 2073 6561 7263 6820  will not search 
-00008e30: 6469 7265 6374 6f72 7920 7265 6375 7273  directory recurs
-00008e40: 6976 656c 790a 2020 2020 3a70 6172 616d  ively.    :param
-00008e50: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
-00008e60: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
-00008e70: 2070 6174 6820 646f 6573 6e27 7420 6d61   path doesn't ma
-00008e80: 7463 6820 616e 7920 6669 6c65 2c20 7261  tch any file, ra
-00008e90: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
-00008ea0: 4572 726f 720a 2020 2020 3a72 6169 7365  Error.    :raise
-00008eb0: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
-00008ec0: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
-00008ed0: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
-00008ee0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-00008ef0: 7273 0a20 2020 203a 7265 7475 726e 733a  rs.    :returns:
-00008f00: 2041 206c 6973 7420 636f 6e74 6169 6e73   A list contains
-00008f10: 2070 6174 6873 206d 6174 6368 2060 7333   paths match `s3
-00008f20: 5f70 6174 686e 616d 6560 0a20 2020 2027  _pathname`.    '
-00008f30: 2727 0a20 2020 2072 6574 7572 6e20 6c69  ''.    return li
-00008f40: 7374 280a 2020 2020 2020 2020 7333 5f69  st(.        s3_i
-00008f50: 676c 6f62 280a 2020 2020 2020 2020 2020  glob(.          
-00008f60: 2020 7061 7468 3d70 6174 682c 0a20 2020    path=path,.   
-00008f70: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
-00008f80: 7665 3d72 6563 7572 7369 7665 2c0a 2020  ve=recursive,.  
-00008f90: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
-00008fa0: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
-00008fb0: 0a20 2020 2020 2020 2020 2020 2066 6f6c  .            fol
-00008fc0: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
-00008fd0: 696e 6b73 2929 0a0a 0a64 6566 2073 335f  inks))...def s3_
-00008fe0: 676c 6f62 5f73 7461 7428 0a20 2020 2020  glob_stat(.     
-00008ff0: 2020 2070 6174 683a 2050 6174 684c 696b     path: PathLik
-00009000: 652c 0a20 2020 2020 2020 2072 6563 7572  e,.        recur
-00009010: 7369 7665 3a20 626f 6f6c 203d 2054 7275  sive: bool = Tru
-00009020: 652c 0a20 2020 2020 2020 206d 6973 7369  e,.        missi
-00009030: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
-00009040: 7565 2c0a 2020 2020 2020 2020 666f 6c6c  ue,.        foll
-00009050: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-00009060: 4661 6c73 6529 202d 3e20 4974 6572 6174  False) -> Iterat
-00009070: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
-00009080: 2020 2027 2727 5265 7475 726e 2061 2067     '''Return a g
-00009090: 656e 6572 6174 6f72 2063 6f6e 7461 696e  enerator contain
-000090a0: 7320 7475 706c 6573 206f 6620 7061 7468  s tuples of path
-000090b0: 2061 6e64 2066 696c 6520 7374 6174 2c20   and file stat, 
-000090c0: 696e 2061 7363 656e 6469 6e67 2061 6c70  in ascending alp
-000090d0: 6861 6265 7469 6361 6c20 6f72 6465 722c  habetical order,
-000090e0: 2069 6e20 7768 6963 6820 7061 7468 206d   in which path m
-000090f0: 6174 6368 6573 2067 6c6f 6220 7061 7474  atches glob patt
-00009100: 6572 6e0a 2020 2020 4e6f 7465 733a 204f  ern.    Notes: O
-00009110: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
-00009120: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
-00009130: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
-00009140: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
-00009150: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
-00009160: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
-00009170: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
-00009180: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
-00009190: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
-000091a0: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
-000091b0: 6563 7572 7369 7665 6c79 0a20 2020 203a  ecursively.    :
-000091c0: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
-000091d0: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
-000091e0: 6172 6765 7420 7061 7468 2064 6f65 736e  arget path doesn
-000091f0: 2774 206d 6174 6368 2061 6e79 2066 696c  't match any fil
-00009200: 652c 2072 6169 7365 2046 696c 654e 6f74  e, raise FileNot
-00009210: 466f 756e 6445 7272 6f72 0a20 2020 203a  FoundError.    :
-00009220: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
-00009230: 7465 6445 7272 6f72 2c20 7768 656e 2062  tedError, when b
-00009240: 7563 6b65 7420 7061 7274 2063 6f6e 7461  ucket part conta
-00009250: 696e 7320 7769 6c64 6361 7264 2063 6861  ins wildcard cha
-00009260: 7261 6374 6572 730a 2020 2020 3a72 6574  racters.    :ret
-00009270: 7572 6e73 3a20 4120 6765 6e65 7261 746f  urns: A generato
-00009280: 7220 636f 6e74 6169 6e73 2074 7570 6c65  r contains tuple
-00009290: 7320 6f66 2070 6174 6820 616e 6420 6669  s of path and fi
-000092a0: 6c65 2073 7461 742c 2069 6e20 7768 6963  le stat, in whic
-000092b0: 6820 7061 7468 7320 6d61 7463 6820 6073  h paths match `s
-000092c0: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
-000092d0: 2727 270a 2020 2020 7265 7475 726e 2053  '''.    return S
-000092e0: 3350 6174 6828 7061 7468 292e 676c 6f62  3Path(path).glob
-000092f0: 5f73 7461 7428 0a20 2020 2020 2020 2070  _stat(.        p
-00009300: 6174 7465 726e 3d22 222c 0a20 2020 2020  attern="",.     
-00009310: 2020 2072 6563 7572 7369 7665 3d72 6563     recursive=rec
-00009320: 7572 7369 7665 2c0a 2020 2020 2020 2020  ursive,.        
-00009330: 6d69 7373 696e 675f 6f6b 3d6d 6973 7369  missing_ok=missi
-00009340: 6e67 5f6f 6b2c 0a20 2020 2020 2020 2066  ng_ok,.        f
-00009350: 6f6c 6c6f 776c 696e 6b73 3d66 6f6c 6c6f  ollowlinks=follo
-00009360: 776c 696e 6b73 290a 0a0a 6465 6620 7333  wlinks)...def s3
-00009370: 5f69 676c 6f62 280a 2020 2020 2020 2020  _iglob(.        
-00009380: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
-00009390: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
-000093a0: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-000093b0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
-000093c0: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
-000093d0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
-000093e0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-000093f0: 7365 2c0a 2920 2d3e 2049 7465 7261 746f  se,.) -> Iterato
-00009400: 725b 7374 725d 3a0a 2020 2020 2727 2752  r[str]:.    '''R
-00009410: 6574 7572 6e20 7333 2070 6174 6820 6974  eturn s3 path it
-00009420: 6572 6174 6f72 2069 6e20 6173 6365 6e64  erator in ascend
-00009430: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
-00009440: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
-00009450: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
-00009460: 6f62 2070 6174 7465 726e 0a20 2020 204e  ob pattern.    N
-00009470: 6f74 6573 3a20 4f6e 6c79 2067 6c6f 6220  otes: Only glob 
-00009480: 696e 2062 7563 6b65 742e 2049 6620 7472  in bucket. If tr
-00009490: 7969 6e67 2074 6f20 6d61 7463 6820 6275  ying to match bu
-000094a0: 636b 6574 2077 6974 6820 7769 6c64 6361  cket with wildca
-000094b0: 7264 2063 6861 7261 6374 6572 732c 2072  rd characters, r
-000094c0: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
-000094d0: 4572 726f 720a 0a20 2020 203a 7061 7261  Error..    :para
-000094e0: 6d20 7265 6375 7273 6976 653a 2049 6620  m recursive: If 
-000094f0: 4661 6c73 652c 2060 2a2a 6020 7769 6c6c  False, `**` will
-00009500: 206e 6f74 2073 6561 7263 6820 6469 7265   not search dire
-00009510: 6374 6f72 7920 7265 6375 7273 6976 656c  ctory recursivel
-00009520: 790a 2020 2020 3a70 6172 616d 206d 6973  y.    :param mis
-00009530: 7369 6e67 5f6f 6b3a 2049 6620 4661 6c73  sing_ok: If Fals
-00009540: 6520 616e 6420 7461 7267 6574 2070 6174  e and target pat
-00009550: 6820 646f 6573 6e27 7420 6d61 7463 6820  h doesn't match 
-00009560: 616e 7920 6669 6c65 2c20 7261 6973 6520  any file, raise 
-00009570: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-00009580: 720a 2020 2020 3a72 6169 7365 733a 2055  r.    :raises: U
-00009590: 6e73 7570 706f 7274 6564 4572 726f 722c  nsupportedError,
-000095a0: 2077 6865 6e20 6275 636b 6574 2070 6172   when bucket par
-000095b0: 7420 636f 6e74 6169 6e73 2077 696c 6463  t contains wildc
-000095c0: 6172 6420 6368 6172 6163 7465 7273 0a20  ard characters. 
-000095d0: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
-000095e0: 6974 6572 6174 6f72 2063 6f6e 7461 696e  iterator contain
-000095f0: 7320 7061 7468 7320 6d61 7463 6820 6073  s paths match `s
-00009600: 335f 7061 7468 6e61 6d65 600a 2020 2020  3_pathname`.    
-00009610: 2727 270a 2020 2020 666f 7220 7061 7468  '''.    for path
-00009620: 5f6f 626a 2069 6e20 5333 5061 7468 2870  _obj in S3Path(p
-00009630: 6174 6829 2e69 676c 6f62 2870 6174 7465  ath).iglob(patte
-00009640: 726e 3d22 222c 2072 6563 7572 7369 7665  rn="", recursive
-00009650: 3d72 6563 7572 7369 7665 2c0a 2020 2020  =recursive,.    
-00009660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009680: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
-00009690: 7373 696e 675f 6f6b 2c0a 2020 2020 2020  ssing_ok,.      
-000096a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096c0: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
-000096d0: 6c6f 776c 696e 6b73 293a 0a20 2020 2020  lowlinks):.     
-000096e0: 2020 2079 6965 6c64 2070 6174 685f 6f62     yield path_ob
-000096f0: 6a2e 7061 7468 5f77 6974 685f 7072 6f74  j.path_with_prot
-00009700: 6f63 6f6c 0a0a 0a64 6566 2073 335f 6d61  ocol...def s3_ma
-00009710: 6b65 6469 7273 2870 6174 683a 2050 6174  kedirs(path: Pat
-00009720: 684c 696b 652c 2065 7869 7374 5f6f 6b3a  hLike, exist_ok:
-00009730: 2062 6f6f 6c20 3d20 4661 6c73 6529 3a0a   bool = False):.
-00009740: 2020 2020 2727 270a 2020 2020 4372 6561      '''.    Crea
-00009750: 7465 2061 6e20 7333 2064 6972 6563 746f  te an s3 directo
-00009760: 7279 2e0a 2020 2020 5075 7265 6c79 2063  ry..    Purely c
-00009770: 7265 6174 696e 6720 6469 7265 6374 6f72  reating director
-00009780: 7920 6973 2069 6e76 616c 6964 2062 6563  y is invalid bec
-00009790: 6175 7365 2069 7427 7320 756e 6176 6169  ause it's unavai
-000097a0: 6c61 626c 6520 6f6e 204f 5353 2e0a 2020  lable on OSS..  
-000097b0: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
-000097c0: 6973 2074 6f20 7465 7374 2074 6865 2074  is to test the t
-000097d0: 6172 6765 7420 6275 636b 6574 2068 6176  arget bucket hav
-000097e0: 6520 5752 4954 4520 6163 6365 7373 2e0a  e WRITE access..
-000097f0: 0a20 2020 203a 7061 7261 6d20 7061 7468  .    :param path
-00009800: 3a20 4769 7665 6e20 7061 7468 0a20 2020  : Given path.   
-00009810: 203a 7061 7261 6d20 6578 6973 745f 6f6b   :param exist_ok
-00009820: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
-00009830: 6172 6765 7420 6469 7265 6374 6f72 7920  arget directory 
-00009840: 6578 6973 7473 2c20 7261 6973 6520 5333  exists, raise S3
-00009850: 4669 6c65 4578 6973 7473 4572 726f 720a  FileExistsError.
-00009860: 2020 2020 3a72 6169 7365 733a 2053 3342      :raises: S3B
-00009870: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-00009880: 6f72 2c20 5333 4669 6c65 4578 6973 7473  or, S3FileExists
-00009890: 4572 726f 720a 2020 2020 2727 270a 2020  Error.    '''.  
-000098a0: 2020 7265 7475 726e 2053 3350 6174 6828    return S3Path(
-000098b0: 7061 7468 292e 6d6b 6469 7228 7061 7265  path).mkdir(pare
-000098c0: 6e74 733d 5472 7565 2c20 6578 6973 745f  nts=True, exist_
-000098d0: 6f6b 3d65 7869 7374 5f6f 6b29 0a0a 0a64  ok=exist_ok)...d
-000098e0: 6566 205f 6772 6f75 705f 7372 635f 7061  ef _group_src_pa
-000098f0: 7468 735f 6279 5f62 6c6f 636b 280a 2020  ths_by_block(.  
-00009900: 2020 2020 2020 7372 635f 7061 7468 733a        src_paths:
-00009910: 204c 6973 745b 5061 7468 4c69 6b65 5d2c   List[PathLike],
-00009920: 2062 6c6f 636b 5f73 697a 653a 2069 6e74   block_size: int
-00009930: 203d 2044 4546 4155 4c54 5f42 4c4f 434b   = DEFAULT_BLOCK
-00009940: 5f53 495a 450a 2920 2d3e 204c 6973 745b  _SIZE.) -> List[
-00009950: 4c69 7374 5b54 7570 6c65 5b50 6174 684c  List[Tuple[PathL
-00009960: 696b 652c 204f 7074 696f 6e61 6c5b 7374  ike, Optional[st
-00009970: 725d 5d5d 5d3a 0a20 2020 2067 726f 7570  r]]]]:.    group
-00009980: 7320 3d20 5b5d 0a20 2020 2063 7572 7265  s = [].    curre
-00009990: 6e74 5f67 726f 7570 2c20 6375 7272 656e  nt_group, curren
-000099a0: 745f 6772 6f75 705f 7369 7a65 203d 205b  t_group_size = [
-000099b0: 5d2c 2030 0a20 2020 2066 6f72 2073 7263  ], 0.    for src
-000099c0: 5f70 6174 6820 696e 2073 7263 5f70 6174  _path in src_pat
-000099d0: 6873 3a0a 2020 2020 2020 2020 6375 7272  hs:.        curr
-000099e0: 656e 745f 6669 6c65 5f73 697a 6520 3d20  ent_file_size = 
-000099f0: 5333 5061 7468 2873 7263 5f70 6174 6829  S3Path(src_path)
-00009a00: 2e73 7461 7428 292e 7369 7a65 0a20 2020  .stat().size.   
-00009a10: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
-00009a20: 6669 6c65 5f73 697a 6520 3d3d 2030 3a0a  file_size == 0:.
-00009a30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00009a40: 696e 7565 0a0a 2020 2020 2020 2020 6966  inue..        if
-00009a50: 2063 7572 7265 6e74 5f66 696c 655f 7369   current_file_si
-00009a60: 7a65 203e 3d20 626c 6f63 6b5f 7369 7a65  ze >= block_size
-00009a70: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00009a80: 206c 656e 2867 726f 7570 7329 203d 3d20   len(groups) == 
-00009a90: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00009aa0: 2020 2069 6620 6375 7272 656e 745f 6772     if current_gr
-00009ab0: 6f75 705f 7369 7a65 202b 2063 7572 7265  oup_size + curre
-00009ac0: 6e74 5f66 696c 655f 7369 7a65 203e 2032  nt_file_size > 2
-00009ad0: 202a 2062 6c6f 636b 5f73 697a 653a 0a20   * block_size:. 
-00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009af0: 2020 2067 726f 7570 5f6c 6163 6b5f 7369     group_lack_si
-00009b00: 7a65 203d 2062 6c6f 636b 5f73 697a 6520  ze = block_size 
-00009b10: 2d20 6375 7272 656e 745f 6772 6f75 705f  - current_group_
-00009b20: 7369 7a65 0a20 2020 2020 2020 2020 2020  size.           
-00009b30: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00009b40: 5f67 726f 7570 2e61 7070 656e 6428 0a20  _group.append(. 
-00009b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b60: 2020 2020 2020 2028 7372 635f 7061 7468         (src_path
-00009b70: 2c20 6627 6279 7465 733d 302d 7b67 726f  , f'bytes=0-{gro
-00009b80: 7570 5f6c 6163 6b5f 7369 7a65 2d31 7d27  up_lack_size-1}'
-00009b90: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00009ba0: 2020 2020 2020 2067 726f 7570 732e 6578         groups.ex
-00009bb0: 7465 6e64 280a 2020 2020 2020 2020 2020  tend(.          
-00009bc0: 2020 2020 2020 2020 2020 2020 2020 5b0a                [.
-00009bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009be0: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-00009bf0: 656e 745f 6772 6f75 702c 0a20 2020 2020  ent_group,.     
-00009c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c10: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00009c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c30: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-00009c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00009c60: 7263 5f70 6174 682c 0a20 2020 2020 2020  rc_path,.       
-00009c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c80: 2020 2020 2020 2020 2020 2020 2066 2762               f'b
-00009c90: 7974 6573 3d7b 6772 6f75 705f 6c61 636b  ytes={group_lack
-00009ca0: 5f73 697a 657d 2d7b 6375 7272 656e 745f  _size}-{current_
-00009cb0: 6669 6c65 5f73 697a 652d 317d 270a 2020  file_size-1}'.  
-00009cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cd0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00009ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009cf0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d10: 2020 2020 2020 5d29 0a20 2020 2020 2020        ]).       
-00009d20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00009d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d40: 2020 2063 7572 7265 6e74 5f67 726f 7570     current_group
-00009d50: 2e61 7070 656e 6428 2873 7263 5f70 6174  .append((src_pat
-00009d60: 682c 204e 6f6e 6529 290a 2020 2020 2020  h, None)).      
-00009d70: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00009d80: 6f75 7073 2e61 7070 656e 6428 6375 7272  oups.append(curr
-00009d90: 656e 745f 6772 6f75 7029 0a20 2020 2020  ent_group).     
-00009da0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00009db0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00009dc0: 7570 735b 2d31 5d2e 6578 7465 6e64 2863  ups[-1].extend(c
-00009dd0: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
-00009de0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00009df0: 6f75 7073 2e61 7070 656e 6428 5b28 7372  oups.append([(sr
-00009e00: 635f 7061 7468 2c20 4e6f 6e65 295d 290a  c_path, None)]).
-00009e10: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-00009e20: 656e 745f 6772 6f75 702c 2063 7572 7265  ent_group, curre
-00009e30: 6e74 5f67 726f 7570 5f73 697a 6520 3d20  nt_group_size = 
-00009e40: 5b5d 2c20 300a 2020 2020 2020 2020 656c  [], 0.        el
-00009e50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009e60: 6375 7272 656e 745f 6772 6f75 702e 6170  current_group.ap
-00009e70: 7065 6e64 2828 7372 635f 7061 7468 2c20  pend((src_path, 
-00009e80: 4e6f 6e65 2929 0a20 2020 2020 2020 2020  None)).         
-00009e90: 2020 2063 7572 7265 6e74 5f67 726f 7570     current_group
-00009ea0: 5f73 697a 6520 2b3d 2063 7572 7265 6e74  _size += current
-00009eb0: 5f66 696c 655f 7369 7a65 0a20 2020 2020  _file_size.     
-00009ec0: 2020 2020 2020 2069 6620 6375 7272 656e         if curren
-00009ed0: 745f 6772 6f75 705f 7369 7a65 203e 3d20  t_group_size >= 
-00009ee0: 626c 6f63 6b5f 7369 7a65 3a0a 2020 2020  block_size:.    
-00009ef0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00009f00: 7073 2e61 7070 656e 6428 6375 7272 656e  ps.append(curren
-00009f10: 745f 6772 6f75 7029 0a20 2020 2020 2020  t_group).       
-00009f20: 2020 2020 2020 2020 2063 7572 7265 6e74           current
-00009f30: 5f67 726f 7570 2c20 6375 7272 656e 745f  _group, current_
-00009f40: 6772 6f75 705f 7369 7a65 203d 205b 5d2c  group_size = [],
-00009f50: 2030 0a20 2020 2069 6620 6375 7272 656e   0.    if curren
-00009f60: 745f 6772 6f75 703a 0a20 2020 2020 2020  t_group:.       
-00009f70: 2067 726f 7570 732e 6170 7065 6e64 2863   groups.append(c
-00009f80: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
-00009f90: 2020 7265 7475 726e 2067 726f 7570 730a    return groups.
-00009fa0: 0a0a 6465 6620 7333 5f63 6f6e 6361 7428  ..def s3_concat(
-00009fb0: 0a20 2020 2020 2020 2073 7263 5f70 6174  .        src_pat
-00009fc0: 6873 3a20 4c69 7374 5b50 6174 684c 696b  hs: List[PathLik
-00009fd0: 655d 2c0a 2020 2020 2020 2020 6473 745f  e],.        dst_
-00009fe0: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
-00009ff0: 2020 2020 2020 2020 626c 6f63 6b5f 7369          block_si
-0000a000: 7a65 3a20 696e 7420 3d20 4445 4641 554c  ze: int = DEFAUL
-0000a010: 545f 424c 4f43 4b5f 5349 5a45 2c0a 2020  T_BLOCK_SIZE,.  
-0000a020: 2020 2020 2020 6d61 785f 776f 726b 6572        max_worker
-0000a030: 733a 2069 6e74 203d 2047 4c4f 4241 4c5f  s: int = GLOBAL_
-0000a040: 4d41 585f 574f 524b 4552 5329 202d 3e20  MAX_WORKERS) -> 
-0000a050: 4e6f 6e65 3a0a 2020 2020 2727 2743 6f6e  None:.    '''Con
-0000a060: 6361 7465 6e61 7465 2073 3320 6669 6c65  catenate s3 file
-0000a070: 7320 746f 206f 6e65 2066 696c 652e 0a0a  s to one file...
-0000a080: 2020 2020 3a70 6172 616d 2073 7263 5f70      :param src_p
-0000a090: 6174 6873 3a20 4769 7665 6e20 736f 7572  aths: Given sour
-0000a0a0: 6365 2070 6174 6873 0a20 2020 203a 7061  ce paths.    :pa
-0000a0b0: 7261 6d20 6473 745f 7061 7468 3a20 4769  ram dst_path: Gi
-0000a0c0: 7665 6e20 6465 7374 696e 6174 696f 6e20  ven destination 
-0000a0d0: 7061 7468 0a20 2020 2027 2727 0a20 2020  path.    '''.   
-0000a0e0: 2063 6c69 656e 7420 3d20 5333 5061 7468   client = S3Path
-0000a0f0: 2864 7374 5f70 6174 6829 2e5f 636c 6965  (dst_path)._clie
-0000a100: 6e74 0a20 2020 2077 6974 6820 7261 6973  nt.    with rais
-0000a110: 655f 7333 5f65 7272 6f72 2864 7374 5f70  e_s3_error(dst_p
-0000a120: 6174 6829 3a0a 2020 2020 2020 2020 6966  ath):.        if
-0000a130: 2062 6c6f 636b 5f73 697a 6520 3d3d 2030   block_size == 0
-0000a140: 3a0a 2020 2020 2020 2020 2020 2020 6772  :.            gr
-0000a150: 6f75 7073 203d 205b 5b28 7372 635f 7061  oups = [[(src_pa
-0000a160: 7468 2c20 4e6f 6e65 295d 2066 6f72 2073  th, None)] for s
-0000a170: 7263 5f70 6174 6820 696e 2073 7263 5f70  rc_path in src_p
-0000a180: 6174 6873 5d0a 2020 2020 2020 2020 656c  aths].        el
-0000a190: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a1a0: 6772 6f75 7073 203d 205f 6772 6f75 705f  groups = _group_
-0000a1b0: 7372 635f 7061 7468 735f 6279 5f62 6c6f  src_paths_by_blo
-0000a1c0: 636b 2873 7263 5f70 6174 6873 2c20 626c  ck(src_paths, bl
-0000a1d0: 6f63 6b5f 7369 7a65 3d62 6c6f 636b 5f73  ock_size=block_s
-0000a1e0: 697a 6529 0a0a 2020 2020 2020 2020 7769  ize)..        wi
-0000a1f0: 7468 204d 756c 7469 5061 7274 5772 6974  th MultiPartWrit
-0000a200: 6572 2863 6c69 656e 742c 2064 7374 5f70  er(client, dst_p
-0000a210: 6174 6829 2061 7320 7772 6974 6572 2c20  ath) as writer, 
-0000a220: 5468 7265 6164 506f 6f6c 4578 6563 7574  ThreadPoolExecut
-0000a230: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000a240: 2020 2020 6d61 785f 776f 726b 6572 733d      max_workers=
-0000a250: 6d61 785f 776f 726b 6572 7329 2061 7320  max_workers) as 
-0000a260: 6578 6563 7574 6f72 3a0a 2020 2020 2020  executor:.      
-0000a270: 2020 2020 2020 666f 7220 696e 6465 782c        for index,
-0000a280: 2067 726f 7570 2069 6e20 656e 756d 6572   group in enumer
-0000a290: 6174 6528 6772 6f75 7073 2c20 7374 6172  ate(groups, star
-0000a2a0: 743d 3129 3a0a 2020 2020 2020 2020 2020  t=1):.          
-0000a2b0: 2020 2020 2020 6966 206c 656e 2867 726f        if len(gro
-0000a2c0: 7570 2920 3d3d 2031 3a0a 2020 2020 2020  up) == 1:.      
-0000a2d0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0000a2e0: 6563 7574 6f72 2e73 7562 6d69 7428 0a20  ecutor.submit(. 
-0000a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a300: 2020 2020 2020 2077 7269 7465 722e 7570         writer.up
-0000a310: 6c6f 6164 5f70 6172 745f 636f 7079 2c20  load_part_copy, 
-0000a320: 696e 6465 782c 2067 726f 7570 5b30 5d5b  index, group[0][
-0000a330: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-0000a340: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-0000a350: 705b 305d 5b31 5d29 0a20 2020 2020 2020  p[0][1]).       
-0000a360: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a380: 2020 2065 7865 6375 746f 722e 7375 626d     executor.subm
-0000a390: 6974 2877 7269 7465 722e 7570 6c6f 6164  it(writer.upload
-0000a3a0: 5f70 6172 745f 6279 5f70 6174 6873 2c20  _part_by_paths, 
-0000a3b0: 696e 6465 782c 2067 726f 7570 290a 0a0a  index, group)...
-0000a3c0: 4053 6d61 7274 5061 7468 2e72 6567 6973  @SmartPath.regis
-0000a3d0: 7465 720a 636c 6173 7320 5333 5061 7468  ter.class S3Path
-0000a3e0: 2855 5249 5061 7468 293a 0a0a 2020 2020  (URIPath):..    
-0000a3f0: 7072 6f74 6f63 6f6c 203d 2022 7333 220a  protocol = "s3".
-0000a400: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0000a410: 5f28 7365 6c66 2c20 7061 7468 3a20 2250  _(self, path: "P
-0000a420: 6174 684c 696b 6522 2c20 2a6f 7468 6572  athLike", *other
-0000a430: 5f70 6174 6873 3a20 2250 6174 684c 696b  _paths: "PathLik
-0000a440: 6522 293a 0a20 2020 2020 2020 2073 7570  e"):.        sup
-0000a450: 6572 2829 2e5f 5f69 6e69 745f 5f28 7061  er().__init__(pa
-0000a460: 7468 2c20 2a6f 7468 6572 5f70 6174 6873  th, *other_paths
-0000a470: 290a 2020 2020 2020 2020 7072 6f74 6f63  ).        protoc
-0000a480: 6f6c 203d 2067 6574 5f75 726c 5f73 6368  ol = get_url_sch
-0000a490: 656d 6528 7365 6c66 2e70 6174 6829 0a20  eme(self.path). 
-0000a4a0: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
-0000a4b0: 746f 636f 6c5f 7769 7468 5f70 726f 6669  tocol_with_profi
-0000a4c0: 6c65 203d 2073 656c 662e 7072 6f74 6f63  le = self.protoc
-0000a4d0: 6f6c 0a20 2020 2020 2020 2073 656c 662e  ol.        self.
-0000a4e0: 5f70 726f 6669 6c65 5f6e 616d 6520 3d20  _profile_name = 
-0000a4f0: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
-0000a500: 7072 6f74 6f63 6f6c 2e73 7461 7274 7377  protocol.startsw
-0000a510: 6974 6828 2773 332b 2729 3a0a 2020 2020  ith('s3+'):.    
-0000a520: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-0000a530: 6f74 6f63 6f6c 5f77 6974 685f 7072 6f66  otocol_with_prof
-0000a540: 696c 6520 3d20 7072 6f74 6f63 6f6c 0a20  ile = protocol. 
-0000a550: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000a560: 5f70 726f 6669 6c65 5f6e 616d 6520 3d20  _profile_name = 
-0000a570: 7072 6f74 6f63 6f6c 5b33 3a5d 0a20 2020  protocol[3:].   
-0000a580: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-0000a590: 335f 7061 7468 203d 2066 2273 333a 2f2f  3_path = f"s3://
-0000a5a0: 7b73 656c 662e 7061 7468 5b6c 656e 2870  {self.path[len(p
-0000a5b0: 726f 746f 636f 6c29 2b33 3a5d 7d22 0a20  rotocol)+3:]}". 
-0000a5c0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
-0000a5d0: 7072 6f74 6f63 6f6c 3a0a 2020 2020 2020  protocol:.      
-0000a5e0: 2020 2020 2020 7365 6c66 2e5f 7333 5f70        self._s3_p
-0000a5f0: 6174 6820 3d20 6622 7333 3a2f 2f7b 7365  ath = f"s3://{se
-0000a600: 6c66 2e70 6174 682e 6c73 7472 6970 2827  lf.path.lstrip('
-0000a610: 2f27 297d 220a 2020 2020 2020 2020 656c  /')}".        el
-0000a620: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a630: 7365 6c66 2e5f 7333 5f70 6174 6820 3d20  self._s3_path = 
-0000a640: 7365 6c66 2e70 6174 680a 0a20 2020 2040  self.path..    @
-0000a650: 6361 6368 6564 7072 6f70 6572 7479 0a20  cachedproperty. 
-0000a660: 2020 2064 6566 2070 6174 685f 7769 7468     def path_with
-0000a670: 5f70 726f 746f 636f 6c28 7365 6c66 2920  _protocol(self) 
-0000a680: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000a690: 2727 2752 6574 7572 6e20 7061 7468 2077  '''Return path w
-0000a6a0: 6974 6820 7072 6f74 6f63 6f6c 2c20 6c69  ith protocol, li
-0000a6b0: 6b65 2066 696c 653a 2f2f 2f72 6f6f 742c  ke file:///root,
-0000a6c0: 2073 333a 2f2f 6275 636b 6574 2f6b 6579   s3://bucket/key
-0000a6d0: 2727 270a 2020 2020 2020 2020 7061 7468  '''.        path
-0000a6e0: 203d 2073 656c 662e 7061 7468 0a20 2020   = self.path.   
-0000a6f0: 2020 2020 2070 726f 746f 636f 6c5f 7072       protocol_pr
-0000a700: 6566 6978 203d 2073 656c 662e 5f70 726f  efix = self._pro
-0000a710: 746f 636f 6c5f 7769 7468 5f70 726f 6669  tocol_with_profi
-0000a720: 6c65 202b 2022 3a2f 2f22 0a20 2020 2020  le + "://".     
-0000a730: 2020 2069 6620 7061 7468 2e73 7461 7274     if path.start
-0000a740: 7377 6974 6828 7072 6f74 6f63 6f6c 5f70  swith(protocol_p
-0000a750: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
-0000a760: 2020 2020 7265 7475 726e 2070 6174 680a      return path.
-0000a770: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000a780: 726f 746f 636f 6c5f 7072 6566 6978 202b  rotocol_prefix +
-0000a790: 2070 6174 682e 6c73 7472 6970 2827 2f27   path.lstrip('/'
-0000a7a0: 290a 0a20 2020 2040 6361 6368 6564 7072  )..    @cachedpr
-0000a7b0: 6f70 6572 7479 0a20 2020 2064 6566 2070  operty.    def p
-0000a7c0: 6174 685f 7769 7468 6f75 745f 7072 6f74  ath_without_prot
-0000a7d0: 6f63 6f6c 2873 656c 6629 202d 3e20 7374  ocol(self) -> st
-0000a7e0: 723a 0a20 2020 2020 2020 2027 2727 5265  r:.        '''Re
-0000a7f0: 7475 726e 2070 6174 6820 7769 7468 6f75  turn path withou
-0000a800: 7420 7072 6f74 6f63 6f6c 2c20 6578 616d  t protocol, exam
-0000a810: 706c 653a 2069 6620 7061 7468 2069 7320  ple: if path is 
-0000a820: 7333 3a2f 2f62 7563 6b65 742f 6b65 792c  s3://bucket/key,
-0000a830: 2072 6574 7572 6e20 6275 636b 6574 2f6b   return bucket/k
-0000a840: 6579 2727 270a 2020 2020 2020 2020 7061  ey'''.        pa
-0000a850: 7468 203d 2073 656c 662e 7061 7468 0a20  th = self.path. 
-0000a860: 2020 2020 2020 2070 726f 746f 636f 6c5f         protocol_
-0000a870: 7072 6566 6978 203d 2073 656c 662e 5f70  prefix = self._p
-0000a880: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
-0000a890: 6669 6c65 202b 2022 3a2f 2f22 0a20 2020  file + "://".   
-0000a8a0: 2020 2020 2069 6620 7061 7468 2e73 7461       if path.sta
-0000a8b0: 7274 7377 6974 6828 7072 6f74 6f63 6f6c  rtswith(protocol
-0000a8c0: 5f70 7265 6669 7829 3a0a 2020 2020 2020  _prefix):.      
-0000a8d0: 2020 2020 2020 7061 7468 203d 2070 6174        path = pat
-0000a8e0: 685b 6c65 6e28 7072 6f74 6f63 6f6c 5f70  h[len(protocol_p
-0000a8f0: 7265 6669 7829 3a5d 0a20 2020 2020 2020  refix):].       
-0000a900: 2072 6574 7572 6e20 7061 7468 0a0a 2020   return path..  
-0000a910: 2020 4063 6163 6865 6470 726f 7065 7274    @cachedpropert
-0000a920: 790a 2020 2020 6465 6620 5f63 6c69 656e  y.    def _clien
-0000a930: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-0000a940: 2072 6574 7572 6e20 6765 745f 7333 5f63   return get_s3_c
-0000a950: 6c69 656e 7428 7072 6f66 696c 655f 6e61  lient(profile_na
-0000a960: 6d65 3d73 656c 662e 5f70 726f 6669 6c65  me=self._profile
-0000a970: 5f6e 616d 6529 0a0a 2020 2020 6465 6620  _name)..    def 
-0000a980: 5f73 335f 6765 745f 6d65 7461 6461 7461  _s3_get_metadata
-0000a990: 2873 656c 6629 202d 3e20 6469 6374 3a0a  (self) -> dict:.
-0000a9a0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000a9b0: 2020 2020 4765 7420 6f62 6a65 6374 206d      Get object m
-0000a9c0: 6574 6164 6174 610a 0a20 2020 2020 2020  etadata..       
-0000a9d0: 203a 7061 7261 6d20 7061 7468 3a20 4f62   :param path: Ob
-0000a9e0: 6a65 6374 2070 6174 680a 2020 2020 2020  ject path.      
-0000a9f0: 2020 3a72 6574 7572 6e73 3a20 4f62 6a65    :returns: Obje
-0000aa00: 6374 206d 6574 6164 6174 610a 2020 2020  ct metadata.    
-0000aa10: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000aa20: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-0000aa30: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-0000aa40: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000aa50: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000aa60: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
-0000aa70: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
-0000aa80: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000aa90: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
-0000aaa0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
-0000aab0: 2020 2020 2020 7265 7475 726e 207b 7d0a        return {}.
-0000aac0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000aad0: 2020 2020 2020 2020 2077 6974 6820 7261           with ra
-0000aae0: 6973 655f 7333 5f65 7272 6f72 2873 656c  ise_s3_error(sel
-0000aaf0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000ab00: 6f63 6f6c 293a 0a20 2020 2020 2020 2020  ocol):.         
-0000ab10: 2020 2020 2020 2072 6573 7020 3d20 7365         resp = se
-0000ab20: 6c66 2e5f 636c 6965 6e74 2e68 6561 645f  lf._client.head_
-0000ab30: 6f62 6a65 6374 2842 7563 6b65 743d 6275  object(Bucket=bu
-0000ab40: 636b 6574 2c20 4b65 793d 6b65 7929 0a20  cket, Key=key). 
-0000ab50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000ab60: 6e20 6469 6374 280a 2020 2020 2020 2020  n dict(.        
-0000ab70: 2020 2020 2020 2020 286b 6579 2e6c 6f77          (key.low
-0000ab80: 6572 2829 2c20 7661 6c75 6529 2066 6f72  er(), value) for
-0000ab90: 206b 6579 2c20 7661 6c75 6520 696e 2072   key, value in r
-0000aba0: 6573 705b 274d 6574 6164 6174 6127 5d2e  esp['Metadata'].
-0000abb0: 6974 656d 7328 2929 0a20 2020 2020 2020  items()).       
-0000abc0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-0000abd0: 6e20 6173 2065 7272 6f72 3a0a 2020 2020  n as error:.    
-0000abe0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0000abf0: 7461 6e63 6528 6572 726f 722c 0a20 2020  tance(error,.   
-0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac10: 2020 2020 2020 2028 5333 556e 6b6e 6f77         (S3Unknow
-0000ac20: 6e45 7272 6f72 2c20 5333 436f 6e66 6967  nError, S3Config
-0000ac30: 4572 726f 722c 2053 3350 6572 6d69 7373  Error, S3Permiss
-0000ac40: 696f 6e45 7272 6f72 2929 3a0a 2020 2020  ionError)):.    
-0000ac50: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000ac60: 6520 6572 726f 720a 2020 2020 2020 2020  e error.        
-0000ac70: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
-0000ac80: 2020 2064 6566 2061 6363 6573 7328 0a20     def access(. 
-0000ac90: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-0000aca0: 206d 6f64 653a 2041 6363 6573 7320 3d20   mode: Access = 
-0000acb0: 4163 6365 7373 2e52 4541 442c 0a20 2020  Access.READ,.   
-0000acc0: 2020 2020 2020 2020 2066 6f6c 6c6f 776c           followl
-0000acd0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-0000ace0: 7365 2920 2d3e 2062 6f6f 6c3a 0a20 2020  se) -> bool:.   
-0000acf0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000ad00: 2054 6573 7420 6966 2070 6174 6820 6861   Test if path ha
-0000ad10: 7320 6163 6365 7373 2070 6572 6d69 7373  s access permiss
-0000ad20: 696f 6e20 6465 7363 7269 6265 6420 6279  ion described by
-0000ad30: 206d 6f64 650a 2020 2020 2020 2020 5573   mode.        Us
-0000ad40: 696e 6720 6865 6164 5f62 7563 6b65 7428  ing head_bucket(
-0000ad50: 292c 206e 6f77 2052 4541 442f 5752 4954  ), now READ/WRIT
-0000ad60: 4520 6172 6520 7361 6d65 2e0a 0a20 2020  E are same...   
-0000ad70: 2020 2020 203a 7061 7261 6d20 6d6f 6465       :param mode
-0000ad80: 3a20 6163 6365 7373 206d 6f64 650a 2020  : access mode.  
-0000ad90: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000ada0: 626f 6f6c 2c20 6966 2074 6865 2062 7563  bool, if the buc
-0000adb0: 6b65 7420 6f66 2073 335f 7572 6c20 6861  ket of s3_url ha
-0000adc0: 7320 7265 6164 2f77 7269 7465 2061 6363  s read/write acc
-0000add0: 6573 732e 0a20 2020 2020 2020 2027 2727  ess..        '''
-0000ade0: 0a20 2020 2020 2020 2073 335f 7572 6c20  .        s3_url 
-0000adf0: 3d20 7365 6c66 2e70 6174 685f 7769 7468  = self.path_with
-0000ae00: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
-0000ae10: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
-0000ae20: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-0000ae30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000ae40: 2020 2073 335f 7572 6c20 3d20 7365 6c66     s3_url = self
-0000ae50: 2e72 6561 646c 696e 6b28 292e 7061 7468  .readlink().path
-0000ae60: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a20  _with_protocol. 
-0000ae70: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000ae80: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
-0000ae90: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000aea0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-0000aeb0: 6275 636b 6574 2c20 5f20 3d20 7061 7273  bucket, _ = pars
-0000aec0: 655f 7333 5f75 726c 2873 335f 7572 6c29  e_s3_url(s3_url)
-0000aed0: 2020 2320 6f6e 6c79 2063 6865 636b 2062    # only check b
-0000aee0: 7563 6b65 7420 6163 6365 7373 6962 696c  ucket accessibil
-0000aef0: 6974 790a 2020 2020 2020 2020 6966 206e  ity.        if n
-0000af00: 6f74 2062 7563 6b65 743a 0a20 2020 2020  ot bucket:.     
-0000af10: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-0000af20: 6570 7469 6f6e 2822 4e6f 2061 7661 696c  eption("No avail
-0000af30: 6162 6c65 2062 7563 6b65 7422 290a 2020  able bucket").  
-0000af40: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-0000af50: 6e73 7461 6e63 6528 6d6f 6465 2c20 4163  nstance(mode, Ac
-0000af60: 6365 7373 293a 0a20 2020 2020 2020 2020  cess):.         
-0000af70: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
-0000af80: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000af90: 2020 2020 2755 6e73 7570 706f 7274 6564      'Unsupported
-0000afa0: 206d 6f64 653a 207b 7d20 2d2d 204d 6f64   mode: {} -- Mod
-0000afb0: 6520 7368 6f75 6c64 2075 7365 206f 6e65  e should use one
-0000afc0: 206f 6620 7468 6520 656e 756d 7320 6265   of the enums be
-0000afd0: 6c6f 6e67 696e 6720 746f 3a20 207b 7d27  longing to:  {}'
-0000afe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000aff0: 202e 666f 726d 6174 286d 6f64 652c 2027   .format(mode, '
-0000b000: 2c20 272e 6a6f 696e 285b 7374 7228 6129  , '.join([str(a)
-0000b010: 2066 6f72 2061 2069 6e20 4163 6365 7373   for a in Access
-0000b020: 5d29 2929 0a20 2020 2020 2020 2069 6620  ]))).        if 
-0000b030: 6d6f 6465 206e 6f74 2069 6e20 2841 6363  mode not in (Acc
-0000b040: 6573 732e 5245 4144 2c20 4163 6365 7373  ess.READ, Access
-0000b050: 2e57 5249 5445 293a 0a20 2020 2020 2020  .WRITE):.       
-0000b060: 2020 2020 2072 6169 7365 2054 7970 6545       raise TypeE
-0000b070: 7272 6f72 2827 556e 7375 7070 6f72 7465  rror('Unsupporte
-0000b080: 6420 6d6f 6465 3a20 7b7d 272e 666f 726d  d mode: {}'.form
-0000b090: 6174 286d 6f64 6529 290a 2020 2020 2020  at(mode)).      
-0000b0a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000b0b0: 2020 2073 656c 662e 5f63 6c69 656e 742e     self._client.
-0000b0c0: 6865 6164 5f62 7563 6b65 7428 4275 636b  head_bucket(Buck
-0000b0d0: 6574 3d62 7563 6b65 7429 0a20 2020 2020  et=bucket).     
-0000b0e0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0000b0f0: 696f 6e20 6173 2065 7272 6f72 3a0a 2020  ion as error:.  
-0000b100: 2020 2020 2020 2020 2020 6572 726f 7220            error 
-0000b110: 3d20 7472 616e 736c 6174 655f 7333 5f65  = translate_s3_e
-0000b120: 7272 6f72 2865 7272 6f72 2c20 7333 5f75  rror(error, s3_u
-0000b130: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
-0000b140: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
-0000b150: 726f 722c 2028 5333 5065 726d 6973 7369  ror, (S3Permissi
-0000b160: 6f6e 4572 726f 722c 2053 3346 696c 654e  onError, S3FileN
-0000b170: 6f74 466f 756e 6445 7272 6f72 2c0a 2020  otFoundError,.  
-0000b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1a0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-0000b1b0: 4572 726f 7229 293a 0a20 2020 2020 2020  Error)):.       
-0000b1c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000b1d0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-0000b1e0: 2020 7261 6973 6520 6572 726f 720a 2020    raise error.  
-0000b1f0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0000b200: 650a 0a20 2020 2064 6566 2065 7869 7374  e..    def exist
-0000b210: 7328 7365 6c66 2c20 666f 6c6c 6f77 6c69  s(self, followli
-0000b220: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-0000b230: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
-0000b240: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000b250: 5465 7374 2069 6620 7333 5f75 726c 2065  Test if s3_url e
-0000b260: 7869 7374 730a 0a20 2020 2020 2020 2049  xists..        I
-0000b270: 6620 7468 6520 6275 636b 6574 206f 6620  f the bucket of 
-0000b280: 7333 5f75 726c 2061 7265 206e 6f74 2070  s3_url are not p
-0000b290: 6572 6d69 7474 6564 2074 6f20 7265 6164  ermitted to read
-0000b2a0: 2c20 7265 7475 726e 2046 616c 7365 0a0a  , return False..
-0000b2b0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000b2c0: 3a20 5472 7565 2069 6620 7333 5f75 726c  : True if s3_url
-0000b2d0: 2065 6978 7374 732c 2065 6c73 6520 4661   eixsts, else Fa
-0000b2e0: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
-0000b2f0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
-0000b300: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-0000b310: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
-0000b320: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000b330: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
-0000b340: 743a 2020 2320 7333 3a2f 2f20 3d3e 2054  t:  # s3:// => T
-0000b350: 7275 652c 2073 333a 2f2f 2f6b 6579 203d  rue, s3:///key =
-0000b360: 3e20 4661 6c73 650a 2020 2020 2020 2020  > False.        
-0000b370: 2020 2020 7265 7475 726e 206e 6f74 206b      return not k
-0000b380: 6579 0a0a 2020 2020 2020 2020 7265 7475  ey..        retu
-0000b390: 726e 2073 656c 662e 6973 5f64 6972 2829  rn self.is_dir()
-0000b3a0: 206f 7220 7365 6c66 2e69 735f 6669 6c65   or self.is_file
-0000b3b0: 2866 6f6c 6c6f 776c 696e 6b73 290a 0a20  (followlinks).. 
-0000b3c0: 2020 2064 6566 2067 6574 6d74 696d 6528     def getmtime(
-0000b3d0: 7365 6c66 2c20 666f 6c6c 6f77 5f73 796d  self, follow_sym
-0000b3e0: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-0000b3f0: 6c73 6529 202d 3e20 666c 6f61 743a 0a20  lse) -> float:. 
-0000b400: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000b410: 2020 2047 6574 206c 6173 742d 6d6f 6469     Get last-modi
-0000b420: 6669 6564 2074 696d 6520 6f66 2074 6865  fied time of the
-0000b430: 2066 696c 6520 6f6e 2074 6865 2067 6976   file on the giv
-0000b440: 656e 2073 335f 7572 6c20 7061 7468 2028  en s3_url path (
-0000b450: 696e 2055 6e69 7820 7469 6d65 7374 616d  in Unix timestam
-0000b460: 7020 666f 726d 6174 292e 0a20 2020 2020  p format)..     
-0000b470: 2020 2049 6620 7468 6520 7061 7468 2069     If the path i
-0000b480: 7320 616e 2065 7869 7374 656e 7420 6469  s an existent di
-0000b490: 7265 6374 6f72 792c 2072 6574 7572 6e20  rectory, return 
-0000b4a0: 7468 6520 6c61 7465 7374 206d 6f64 6966  the latest modif
-0000b4b0: 6965 6420 7469 6d65 206f 6620 616c 6c20  ied time of all 
-0000b4c0: 6669 6c65 2069 6e20 6974 2e20 5468 6520  file in it. The 
-0000b4d0: 6d74 696d 6520 6f66 2065 6d70 7479 2064  mtime of empty d
-0000b4e0: 6972 6563 746f 7279 2069 7320 3139 3730  irectory is 1970
-0000b4f0: 2d30 312d 3031 2030 303a 3030 3a30 300a  -01-01 00:00:00.
-0000b500: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
-0000b510: 726c 2069 7320 6e6f 7420 616e 2065 7869  rl is not an exi
-0000b520: 7374 656e 7420 7061 7468 2c20 7768 6963  stent path, whic
-0000b530: 6820 6d65 616e 7320 7333 5f65 7869 7374  h means s3_exist
-0000b540: 2873 335f 7572 6c29 2072 6574 7572 6e73  (s3_url) returns
-0000b550: 2046 616c 7365 2c20 7468 656e 2072 6169   False, then rai
-0000b560: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-0000b570: 6445 7272 6f72 0a0a 2020 2020 2020 2020  dError..        
-0000b580: 3a72 6574 7572 6e73 3a20 4c61 7374 2d6d  :returns: Last-m
-0000b590: 6f64 6966 6965 6420 7469 6d65 0a20 2020  odified time.   
-0000b5a0: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-0000b5b0: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000b5c0: 722c 2055 6e73 7570 706f 7274 6564 4572  r, UnsupportedEr
-0000b5d0: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
-0000b5e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000b5f0: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
-0000b600: 7379 6d6c 696e 6b73 3d66 6f6c 6c6f 775f  symlinks=follow_
-0000b610: 7379 6d6c 696e 6b73 292e 6d74 696d 650a  symlinks).mtime.
-0000b620: 0a20 2020 2064 6566 2067 6574 7369 7a65  .    def getsize
-0000b630: 2873 656c 662c 2066 6f6c 6c6f 775f 7379  (self, follow_sy
-0000b640: 6d6c 696e 6b73 3a20 626f 6f6c 203d 2046  mlinks: bool = F
-0000b650: 616c 7365 2920 2d3e 2069 6e74 3a0a 2020  alse) -> int:.  
-0000b660: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000b670: 2020 4765 7420 6669 6c65 2073 697a 6520    Get file size 
-0000b680: 6f6e 2074 6865 2067 6976 656e 2073 335f  on the given s3_
-0000b690: 7572 6c20 7061 7468 2028 696e 2062 7974  url path (in byt
-0000b6a0: 6573 292e 0a20 2020 2020 2020 2049 6620  es)..        If 
-0000b6b0: 7468 6520 7061 7468 2069 6e20 6120 6469  the path in a di
-0000b6c0: 7265 6374 6f72 792c 2072 6574 7572 6e20  rectory, return 
-0000b6d0: 7468 6520 7375 6d20 6f66 2061 6c6c 2066  the sum of all f
-0000b6e0: 696c 6520 7369 7a65 2069 6e20 6974 2c20  ile size in it, 
-0000b6f0: 696e 636c 7564 696e 6720 6669 6c65 2069  including file i
-0000b700: 6e20 7375 6264 6972 6563 746f 7269 6573  n subdirectories
-0000b710: 2028 6966 2065 7869 7374 292e 0a20 2020   (if exist)..   
-0000b720: 2020 2020 2054 6865 2072 6573 756c 7420       The result 
-0000b730: 6578 636c 7564 6573 2074 6865 2073 697a  excludes the siz
-0000b740: 6520 6f66 2064 6972 6563 746f 7279 2069  e of directory i
-0000b750: 7473 656c 662e 2049 6e20 6f74 6865 7220  tself. In other 
-0000b760: 776f 7264 732c 2072 6574 7572 6e20 3020  words, return 0 
-0000b770: 4279 7465 206f 6e20 616e 2065 6d70 7479  Byte on an empty
-0000b780: 2064 6972 6563 746f 7279 2070 6174 682e   directory path.
-0000b790: 0a0a 2020 2020 2020 2020 4966 2073 335f  ..        If s3_
-0000b7a0: 7572 6c20 6973 206e 6f74 2061 6e20 6578  url is not an ex
-0000b7b0: 6973 7465 6e74 2070 6174 682c 2077 6869  istent path, whi
-0000b7c0: 6368 206d 6561 6e73 2073 335f 6578 6973  ch means s3_exis
-0000b7d0: 7428 7333 5f75 726c 2920 7265 7475 726e  t(s3_url) return
-0000b7e0: 7320 4661 6c73 652c 2074 6865 6e20 7261  s False, then ra
-0000b7f0: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
-0000b800: 6e64 4572 726f 720a 0a20 2020 2020 2020  ndError..       
-0000b810: 203a 7265 7475 726e 733a 2046 696c 6520   :returns: File 
-0000b820: 7369 7a65 0a20 2020 2020 2020 203a 7261  size.        :ra
-0000b830: 6973 6573 3a20 5333 4669 6c65 4e6f 7446  ises: S3FileNotF
-0000b840: 6f75 6e64 4572 726f 722c 2055 6e73 7570  oundError, Unsup
-0000b850: 706f 7274 6564 4572 726f 720a 2020 2020  portedError.    
-0000b860: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000b870: 7265 7475 726e 2073 656c 662e 7374 6174  return self.stat
-0000b880: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
-0000b890: 3d66 6f6c 6c6f 775f 7379 6d6c 696e 6b73  =follow_symlinks
-0000b8a0: 292e 7369 7a65 0a0a 2020 2020 6465 6620  ).size..    def 
-0000b8b0: 676c 6f62 280a 2020 2020 2020 2020 2020  glob(.          
-0000b8c0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0000b8d0: 2020 2020 7061 7474 6572 6e2c 0a20 2020      pattern,.   
-0000b8e0: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
-0000b8f0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
-0000b900: 0a20 2020 2020 2020 2020 2020 206d 6973  .            mis
-0000b910: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
-0000b920: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-0000b930: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-0000b940: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0000b950: 2029 202d 3e20 4c69 7374 5b27 5333 5061   ) -> List['S3Pa
-0000b960: 7468 275d 3a0a 2020 2020 2020 2020 2727  th']:.        ''
-0000b970: 2752 6574 7572 6e20 7333 2070 6174 6820  'Return s3 path 
-0000b980: 6c69 7374 2069 6e20 6173 6365 6e64 696e  list in ascendin
-0000b990: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
-0000b9a0: 7264 6572 2c20 696e 2077 6869 6368 2070  rder, in which p
-0000b9b0: 6174 6820 6d61 7463 6865 7320 676c 6f62  ath matches glob
-0000b9c0: 2070 6174 7465 726e 0a20 2020 2020 2020   pattern.       
-0000b9d0: 204e 6f74 6573 3a20 4f6e 6c79 2067 6c6f   Notes: Only glo
-0000b9e0: 6220 696e 2062 7563 6b65 742e 2049 6620  b in bucket. If 
-0000b9f0: 7472 7969 6e67 2074 6f20 6d61 7463 6820  trying to match 
-0000ba00: 6275 636b 6574 2077 6974 6820 7769 6c64  bucket with wild
-0000ba10: 6361 7264 2063 6861 7261 6374 6572 732c  card characters,
-0000ba20: 2072 6169 7365 2055 6e73 7570 706f 7274   raise Unsupport
-0000ba30: 6564 4572 726f 720a 0a20 2020 2020 2020  edError..       
-0000ba40: 203a 7061 7261 6d20 7061 7474 6572 6e3a   :param pattern:
-0000ba50: 2047 6c6f 6220 7468 6520 6769 7665 6e20   Glob the given 
-0000ba60: 7265 6c61 7469 7665 2070 6174 7465 726e  relative pattern
-0000ba70: 2069 6e20 7468 6520 6469 7265 6374 6f72   in the director
-0000ba80: 7920 7265 7072 6573 656e 7465 6420 6279  y represented by
-0000ba90: 2074 6869 7320 7061 7468 0a20 2020 2020   this path.     
-0000baa0: 2020 203a 7061 7261 6d20 7265 6375 7273     :param recurs
-0000bab0: 6976 653a 2049 6620 4661 6c73 652c 2060  ive: If False, `
-0000bac0: 2a2a 6020 7769 6c6c 206e 6f74 2073 6561  **` will not sea
-0000bad0: 7263 6820 6469 7265 6374 6f72 7920 7265  rch directory re
-0000bae0: 6375 7273 6976 656c 790a 2020 2020 2020  cursively.      
-0000baf0: 2020 3a70 6172 616d 206d 6973 7369 6e67    :param missing
-0000bb00: 5f6f 6b3a 2049 6620 4661 6c73 6520 616e  _ok: If False an
-0000bb10: 6420 7461 7267 6574 2070 6174 6820 646f  d target path do
-0000bb20: 6573 6e27 7420 6d61 7463 6820 616e 7920  esn't match any 
-0000bb30: 6669 6c65 2c20 7261 6973 6520 4669 6c65  file, raise File
-0000bb40: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
-0000bb50: 2020 2020 2020 3a72 6169 7365 733a 2055        :raises: U
-0000bb60: 6e73 7570 706f 7274 6564 4572 726f 722c  nsupportedError,
-0000bb70: 2077 6865 6e20 6275 636b 6574 2070 6172   when bucket par
-0000bb80: 7420 636f 6e74 6169 6e73 2077 696c 6463  t contains wildc
-0000bb90: 6172 6420 6368 6172 6163 7465 7273 0a20  ard characters. 
-0000bba0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000bbb0: 2041 206c 6973 7420 636f 6e74 6169 6e73   A list contains
-0000bbc0: 2070 6174 6873 206d 6174 6368 2060 7333   paths match `s3
-0000bbd0: 5f70 6174 686e 616d 6560 0a20 2020 2020  _pathname`.     
-0000bbe0: 2020 2027 2727 0a20 2020 2020 2020 2072     '''.        r
-0000bbf0: 6574 7572 6e20 6c69 7374 280a 2020 2020  eturn list(.    
-0000bc00: 2020 2020 2020 2020 7365 6c66 2e69 676c          self.igl
-0000bc10: 6f62 280a 2020 2020 2020 2020 2020 2020  ob(.            
-0000bc20: 2020 2020 7061 7474 6572 6e3d 7061 7474      pattern=patt
-0000bc30: 6572 6e2c 0a20 2020 2020 2020 2020 2020  ern,.           
-0000bc40: 2020 2020 2072 6563 7572 7369 7665 3d72       recursive=r
-0000bc50: 6563 7572 7369 7665 2c0a 2020 2020 2020  ecursive,.      
-0000bc60: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
-0000bc70: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
-0000bc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bc90: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
-0000bca0: 6c6f 776c 696e 6b73 2929 0a0a 2020 2020  lowlinks))..    
-0000bcb0: 6465 6620 676c 6f62 5f73 7461 7428 0a20  def glob_stat(. 
-0000bcc0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-0000bcd0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-0000bce0: 7465 726e 2c0a 2020 2020 2020 2020 2020  tern,.          
-0000bcf0: 2020 7265 6375 7273 6976 653a 2062 6f6f    recursive: boo
-0000bd00: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-0000bd10: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
-0000bd20: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-0000bd30: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
-0000bd40: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-0000bd50: 616c 7365 2920 2d3e 2049 7465 7261 746f  alse) -> Iterato
-0000bd60: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
-0000bd70: 2020 2020 2020 2727 2752 6574 7572 6e20        '''Return 
-0000bd80: 6120 6765 6e65 7261 746f 7220 636f 6e74  a generator cont
-0000bd90: 6169 6e73 2074 7570 6c65 7320 6f66 2070  ains tuples of p
-0000bda0: 6174 6820 616e 6420 6669 6c65 2073 7461  ath and file sta
-0000bdb0: 742c 2069 6e20 6173 6365 6e64 696e 6720  t, in ascending 
-0000bdc0: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
-0000bdd0: 6572 2c20 696e 2077 6869 6368 2070 6174  er, in which pat
-0000bde0: 6820 6d61 7463 6865 7320 676c 6f62 2070  h matches glob p
-0000bdf0: 6174 7465 726e 0a20 2020 2020 2020 204e  attern.        N
-0000be00: 6f74 6573 3a20 4f6e 6c79 2067 6c6f 6220  otes: Only glob 
-0000be10: 696e 2062 7563 6b65 742e 2049 6620 7472  in bucket. If tr
-0000be20: 7969 6e67 2074 6f20 6d61 7463 6820 6275  ying to match bu
-0000be30: 636b 6574 2077 6974 6820 7769 6c64 6361  cket with wildca
-0000be40: 7264 2063 6861 7261 6374 6572 732c 2072  rd characters, r
-0000be50: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
-0000be60: 4572 726f 720a 0a20 2020 2020 2020 203a  Error..        :
-0000be70: 7061 7261 6d20 7061 7474 6572 6e3a 2047  param pattern: G
-0000be80: 6c6f 6220 7468 6520 6769 7665 6e20 7265  lob the given re
-0000be90: 6c61 7469 7665 2070 6174 7465 726e 2069  lative pattern i
-0000bea0: 6e20 7468 6520 6469 7265 6374 6f72 7920  n the directory 
-0000beb0: 7265 7072 6573 656e 7465 6420 6279 2074  represented by t
-0000bec0: 6869 7320 7061 7468 0a20 2020 2020 2020  his path.       
-0000bed0: 203a 7061 7261 6d20 7265 6375 7273 6976   :param recursiv
-0000bee0: 653a 2049 6620 4661 6c73 652c 2060 2a2a  e: If False, `**
-0000bef0: 6020 7769 6c6c 206e 6f74 2073 6561 7263  ` will not searc
-0000bf00: 6820 6469 7265 6374 6f72 7920 7265 6375  h directory recu
-0000bf10: 7273 6976 656c 790a 2020 2020 2020 2020  rsively.        
-0000bf20: 3a70 6172 616d 206d 6973 7369 6e67 5f6f  :param missing_o
-0000bf30: 6b3a 2049 6620 4661 6c73 6520 616e 6420  k: If False and 
-0000bf40: 7461 7267 6574 2070 6174 6820 646f 6573  target path does
-0000bf50: 6e27 7420 6d61 7463 6820 616e 7920 6669  n't match any fi
-0000bf60: 6c65 2c20 7261 6973 6520 4669 6c65 4e6f  le, raise FileNo
-0000bf70: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
-0000bf80: 2020 2020 3a72 6169 7365 733a 2055 6e73      :raises: Uns
-0000bf90: 7570 706f 7274 6564 4572 726f 722c 2077  upportedError, w
-0000bfa0: 6865 6e20 6275 636b 6574 2070 6172 7420  hen bucket part 
-0000bfb0: 636f 6e74 6169 6e73 2077 696c 6463 6172  contains wildcar
-0000bfc0: 6420 6368 6172 6163 7465 7273 0a20 2020  d characters.   
-0000bfd0: 2020 2020 203a 7265 7475 726e 733a 2041       :returns: A
-0000bfe0: 2067 656e 6572 6174 6f72 2063 6f6e 7461   generator conta
-0000bff0: 696e 7320 7475 706c 6573 206f 6620 7061  ins tuples of pa
-0000c000: 7468 2061 6e64 2066 696c 6520 7374 6174  th and file stat
-0000c010: 2c20 696e 2077 6869 6368 2070 6174 6873  , in which paths
-0000c020: 206d 6174 6368 2060 7333 5f70 6174 686e   match `s3_pathn
-0000c030: 616d 6560 0a20 2020 2020 2020 2027 2727  ame`.        '''
-0000c040: 0a20 2020 2020 2020 2067 6c6f 625f 7061  .        glob_pa
-0000c050: 7468 203d 2073 656c 662e 5f73 335f 7061  th = self._s3_pa
-0000c060: 7468 0a20 2020 2020 2020 2069 6620 7061  th.        if pa
-0000c070: 7474 6572 6e3a 0a20 2020 2020 2020 2020  ttern:.         
-0000c080: 2020 2067 6c6f 625f 7061 7468 203d 2073     glob_path = s
-0000c090: 656c 662e 6a6f 696e 7061 7468 2870 6174  elf.joinpath(pat
-0000c0a0: 7465 726e 292e 5f73 335f 7061 7468 2020  tern)._s3_path  
-0000c0b0: 2320 7079 7479 7065 3a20 6469 7361 626c  # pytype: disabl
-0000c0c0: 653d 6174 7472 6962 7574 652d 6572 726f  e=attribute-erro
-0000c0d0: 720a 2020 2020 2020 2020 7333 5f70 6174  r.        s3_pat
-0000c0e0: 686e 616d 6520 3d20 6673 7061 7468 2867  hname = fspath(g
-0000c0f0: 6c6f 625f 7061 7468 290a 0a20 2020 2020  lob_path)..     
-0000c100: 2020 2064 6566 2063 7265 6174 655f 6765     def create_ge
-0000c110: 6e65 7261 746f 7228 293a 0a20 2020 2020  nerator():.     
-0000c120: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
-0000c130: 5f73 335f 7061 7468 6e61 6d65 5f31 2069  _s3_pathname_1 i
-0000c140: 6e20 5f67 726f 7570 5f73 3370 6174 685f  n _group_s3path_
-0000c150: 6279 5f62 7563 6b65 7428 0a20 2020 2020  by_bucket(.     
-0000c160: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000c170: 335f 7061 7468 6e61 6d65 2c20 7365 6c66  3_pathname, self
-0000c180: 2e5f 7072 6f66 696c 655f 6e61 6d65 293a  ._profile_name):
-0000c190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c1a0: 2066 6f72 2067 726f 7570 5f73 335f 7061   for group_s3_pa
-0000c1b0: 7468 6e61 6d65 5f32 2069 6e20 5f67 726f  thname_2 in _gro
-0000c1c0: 7570 5f73 3370 6174 685f 6279 5f70 7265  up_s3path_by_pre
-0000c1d0: 6669 7828 0a20 2020 2020 2020 2020 2020  fix(.           
-0000c1e0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-0000c1f0: 7570 5f73 335f 7061 7468 6e61 6d65 5f31  up_s3_pathname_1
-0000c200: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c210: 2020 2020 2020 2066 6f72 2066 696c 655f         for file_
-0000c220: 656e 7472 7920 696e 205f 7333 5f67 6c6f  entry in _s3_glo
-0000c230: 625f 7374 6174 5f73 696e 676c 655f 7061  b_stat_single_pa
-0000c240: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
-0000c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c260: 6772 6f75 705f 7333 5f70 6174 686e 616d  group_s3_pathnam
-0000c270: 655f 322c 2072 6563 7572 7369 7665 2c20  e_2, recursive, 
-0000c280: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
-0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2a0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-0000c2b0: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 732c  nks=followlinks,
-0000c2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c2d0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0000c2e0: 6669 6c65 5f6e 616d 653d 7365 6c66 2e5f  file_name=self._
-0000c2f0: 7072 6f66 696c 655f 6e61 6d65 293a 0a20  profile_name):. 
-0000c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c310: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0000c320: 7072 6f66 696c 655f 6e61 6d65 3a0a 2020  profile_name:.  
-0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c340: 2020 2020 2020 2020 2020 6669 6c65 5f65            file_e
-0000c350: 6e74 7279 203d 2066 696c 655f 656e 7472  ntry = file_entr
-0000c360: 792e 5f72 6570 6c61 6365 280a 2020 2020  y._replace(.    
+000078d0: 270a 2020 2020 6672 6f6d 206d 6567 6669  '.    from megfi
+000078e0: 6c65 2e66 7320 696d 706f 7274 2069 735f  le.fs import is_
+000078f0: 6673 0a20 2020 2066 726f 6d20 6d65 6766  fs.    from megf
+00007900: 696c 652e 6673 5f70 6174 6820 696d 706f  ile.fs_path impo
+00007910: 7274 2046 5350 6174 680a 0a20 2020 2073  rt FSPath..    s
+00007920: 7263 5f75 726c 203d 2053 3350 6174 6828  rc_url = S3Path(
+00007930: 7372 635f 7572 6c29 0a20 2020 2069 6620  src_url).    if 
+00007940: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
+00007950: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00007960: 2020 2020 2020 7372 635f 7572 6c20 3d20        src_url = 
+00007970: 7372 635f 7572 6c2e 7265 6164 6c69 6e6b  src_url.readlink
+00007980: 2829 0a20 2020 2020 2020 2065 7863 6570  ().        excep
+00007990: 7420 5333 4e6f 7441 4c69 6e6b 4572 726f  t S3NotALinkErro
+000079a0: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
+000079b0: 6173 730a 2020 2020 7372 635f 6275 636b  ass.    src_buck
+000079c0: 6574 2c20 7372 635f 6b65 7920 3d20 7061  et, src_key = pa
+000079d0: 7273 655f 7333 5f75 726c 2873 7263 5f75  rse_s3_url(src_u
+000079e0: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
+000079f0: 746f 636f 6c29 0a20 2020 2069 6620 6e6f  tocol).    if no
+00007a00: 7420 7372 635f 6275 636b 6574 3a0a 2020  t src_bucket:.  
+00007a10: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00007a20: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00007a30: 7228 0a20 2020 2020 2020 2020 2020 2027  r(.            '
+00007a40: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
+00007a50: 653a 2025 7227 2025 2073 7263 5f75 726c  e: %r' % src_url
+00007a60: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00007a70: 636f 6c29 0a0a 2020 2020 6966 206e 6f74  col)..    if not
+00007a80: 2073 7263 5f75 726c 2e65 7869 7374 7328   src_url.exists(
+00007a90: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+00007aa0: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+00007ab0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00007ac0: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
+00007ad0: 643a 2025 7227 2025 2073 7263 5f75 726c  d: %r' % src_url
+00007ae0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00007af0: 636f 6c29 0a0a 2020 2020 6966 206e 6f74  col)..    if not
+00007b00: 2073 7263 5f75 726c 2e69 735f 6669 6c65   src_url.is_file
+00007b10: 2829 3a0a 2020 2020 2020 2020 7261 6973  ():.        rais
+00007b20: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
+00007b30: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00007b40: 2020 2027 4973 2061 2064 6972 6563 746f     'Is a directo
+00007b50: 7279 3a20 2572 2720 2520 7372 635f 7572  ry: %r' % src_ur
+00007b60: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00007b70: 6f63 6f6c 290a 0a20 2020 2064 7374 5f75  ocol)..    dst_u
+00007b80: 726c 203d 2066 7370 6174 6828 6473 745f  rl = fspath(dst_
+00007b90: 7572 6c29 0a20 2020 2069 6620 6e6f 7420  url).    if not 
+00007ba0: 6973 5f66 7328 6473 745f 7572 6c29 3a0a  is_fs(dst_url):.
+00007bb0: 2020 2020 2020 2020 7261 6973 6520 4f53          raise OS
+00007bc0: 4572 726f 7228 6627 6473 745f 7572 6c20  Error(f'dst_url 
+00007bd0: 6973 206e 6f74 2066 7320 7061 7468 3a20  is not fs path: 
+00007be0: 7b64 7374 5f75 726c 7d27 290a 2020 2020  {dst_url}').    
+00007bf0: 6966 206e 6f74 2064 7374 5f75 726c 206f  if not dst_url o
+00007c00: 7220 6473 745f 7572 6c2e 656e 6473 7769  r dst_url.endswi
+00007c10: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+00007c20: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
+00007c30: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
+00007c40: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
+00007c50: 2520 6473 745f 7572 6c29 0a0a 2020 2020  % dst_url)..    
+00007c60: 6473 745f 7061 7468 203d 2046 5350 6174  dst_path = FSPat
+00007c70: 6828 6473 745f 7572 6c29 0a20 2020 2064  h(dst_url).    d
+00007c80: 7374 5f64 6972 6563 746f 7279 203d 206f  st_directory = o
+00007c90: 732e 7061 7468 2e64 6972 6e61 6d65 2864  s.path.dirname(d
+00007ca0: 7374 5f70 6174 682e 7061 7468 5f77 6974  st_path.path_wit
+00007cb0: 686f 7574 5f70 726f 746f 636f 6c29 0a20  hout_protocol). 
+00007cc0: 2020 2069 6620 6473 745f 6469 7265 6374     if dst_direct
+00007cd0: 6f72 7920 213d 2027 273a 0a20 2020 2020  ory != '':.     
+00007ce0: 2020 206f 732e 6d61 6b65 6469 7273 2864     os.makedirs(d
+00007cf0: 7374 5f64 6972 6563 746f 7279 2c20 6578  st_directory, ex
+00007d00: 6973 745f 6f6b 3d54 7275 6529 0a0a 2020  ist_ok=True)..  
+00007d10: 2020 636c 6965 6e74 203d 2067 6574 5f73    client = get_s
+00007d20: 335f 636c 6965 6e74 2870 726f 6669 6c65  3_client(profile
+00007d30: 5f6e 616d 653d 7372 635f 7572 6c2e 5f70  _name=src_url._p
+00007d40: 726f 6669 6c65 5f6e 616d 6529 0a20 2020  rofile_name).   
+00007d50: 2074 7279 3a0a 2020 2020 2020 2020 636c   try:.        cl
+00007d60: 6965 6e74 2e64 6f77 6e6c 6f61 645f 6669  ient.download_fi
+00007d70: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+00007d80: 7372 635f 6275 636b 6574 2c0a 2020 2020  src_bucket,.    
+00007d90: 2020 2020 2020 2020 7372 635f 6b65 792c          src_key,
+00007da0: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
+00007db0: 5f70 6174 682e 7061 7468 5f77 6974 686f  _path.path_witho
+00007dc0: 7574 5f70 726f 746f 636f 6c2c 0a20 2020  ut_protocol,.   
+00007dd0: 2020 2020 2020 2020 2043 616c 6c62 6163           Callbac
+00007de0: 6b3d 6361 6c6c 6261 636b 290a 2020 2020  k=callback).    
+00007df0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00007e00: 2061 7320 6572 726f 723a 0a20 2020 2020   as error:.     
+00007e10: 2020 2065 7272 6f72 203d 2074 7261 6e73     error = trans
+00007e20: 6c61 7465 5f66 735f 6572 726f 7228 6572  late_fs_error(er
+00007e30: 726f 722c 2064 7374 5f75 726c 290a 2020  ror, dst_url).  
+00007e40: 2020 2020 2020 6572 726f 7220 3d20 7472        error = tr
+00007e50: 616e 736c 6174 655f 7333 5f65 7272 6f72  anslate_s3_error
+00007e60: 2865 7272 6f72 2c20 7372 635f 7572 6c2e  (error, src_url.
+00007e70: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+00007e80: 6f6c 290a 2020 2020 2020 2020 7261 6973  ol).        rais
+00007e90: 6520 6572 726f 720a 0a20 2020 2073 7263  e error..    src
+00007ea0: 5f73 7461 7420 3d20 7372 635f 7572 6c2e  _stat = src_url.
+00007eb0: 7374 6174 2829 0a20 2020 206f 732e 7574  stat().    os.ut
+00007ec0: 696d 6528 0a20 2020 2020 2020 2064 7374  ime(.        dst
+00007ed0: 5f70 6174 682e 7061 7468 5f77 6974 686f  _path.path_witho
+00007ee0: 7574 5f70 726f 746f 636f 6c2c 2028 7372  ut_protocol, (sr
+00007ef0: 635f 7374 6174 2e73 745f 6d74 696d 652c  c_stat.st_mtime,
+00007f00: 2073 7263 5f73 7461 742e 7374 5f6d 7469   src_stat.st_mti
+00007f10: 6d65 2929 0a0a 0a64 6566 2073 335f 7570  me))...def s3_up
+00007f20: 6c6f 6164 280a 2020 2020 2020 2020 7372  load(.        sr
+00007f30: 635f 7572 6c3a 2050 6174 684c 696b 652c  c_url: PathLike,
+00007f40: 0a20 2020 2020 2020 2064 7374 5f75 726c  .        dst_url
+00007f50: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+00007f60: 2020 2020 6361 6c6c 6261 636b 3a20 4f70      callback: Op
+00007f70: 7469 6f6e 616c 5b43 616c 6c61 626c 655b  tional[Callable[
+00007f80: 5b69 6e74 5d2c 204e 6f6e 655d 5d20 3d20  [int], None]] = 
+00007f90: 4e6f 6e65 2c0a 2020 2020 2020 2020 2a2a  None,.        **
+00007fa0: 6b77 6172 6773 2920 2d3e 204e 6f6e 653a  kwargs) -> None:
+00007fb0: 0a20 2020 2027 2727 0a20 2020 2055 706c  .    '''.    Upl
+00007fc0: 6f61 6473 2061 2066 696c 6520 6672 6f6d  oads a file from
+00007fd0: 206c 6f63 616c 2066 696c 6573 7973 7465   local filesyste
+00007fe0: 6d20 746f 2073 332e 0a20 2020 203a 7061  m to s3..    :pa
+00007ff0: 7261 6d20 7372 635f 7572 6c3a 2073 6f75  ram src_url: sou
+00008000: 7263 6520 6673 2070 6174 680a 2020 2020  rce fs path.    
+00008010: 3a70 6172 616d 2064 7374 5f75 726c 3a20  :param dst_url: 
+00008020: 7461 7267 6574 2073 3320 7061 7468 0a20  target s3 path. 
+00008030: 2020 203a 7061 7261 6d20 6361 6c6c 6261     :param callba
+00008040: 636b 3a20 4361 6c6c 6564 2070 6572 696f  ck: Called perio
+00008050: 6469 6361 6c6c 7920 6475 7269 6e67 2063  dically during c
+00008060: 6f70 792c 2061 6e64 2074 6865 2069 6e70  opy, and the inp
+00008070: 7574 2070 6172 616d 6574 6572 2069 7320  ut parameter is 
+00008080: 7468 6520 6461 7461 2073 697a 6520 2869  the data size (i
+00008090: 6e20 6279 7465 7329 206f 6620 636f 7079  n bytes) of copy
+000080a0: 2073 696e 6365 2074 6865 206c 6173 7420   since the last 
+000080b0: 6361 6c6c 0a20 2020 2027 2727 0a20 2020  call.    '''.   
+000080c0: 2066 726f 6d20 6d65 6766 696c 652e 6673   from megfile.fs
+000080d0: 2069 6d70 6f72 7420 6973 5f66 730a 2020   import is_fs.  
+000080e0: 2020 6672 6f6d 206d 6567 6669 6c65 2e66    from megfile.f
+000080f0: 735f 7061 7468 2069 6d70 6f72 7420 4653  s_path import FS
+00008100: 5061 7468 0a0a 2020 2020 6966 206e 6f74  Path..    if not
+00008110: 2069 735f 6673 2873 7263 5f75 726c 293a   is_fs(src_url):
+00008120: 0a20 2020 2020 2020 2072 6169 7365 204f  .        raise O
+00008130: 5345 7272 6f72 2866 2773 7263 5f75 726c  SError(f'src_url
+00008140: 2069 7320 6e6f 7420 6673 2070 6174 683a   is not fs path:
+00008150: 207b 7372 635f 7572 6c7d 2729 0a20 2020   {src_url}').   
+00008160: 2073 7263 5f70 6174 6820 3d20 4653 5061   src_path = FSPa
+00008170: 7468 2873 7263 5f75 726c 290a 0a20 2020  th(src_url)..   
+00008180: 2064 7374 5f62 7563 6b65 742c 2064 7374   dst_bucket, dst
+00008190: 5f6b 6579 203d 2070 6172 7365 5f73 335f  _key = parse_s3_
+000081a0: 7572 6c28 6473 745f 7572 6c29 0a20 2020  url(dst_url).   
+000081b0: 2069 6620 6e6f 7420 6473 745f 6275 636b   if not dst_buck
+000081c0: 6574 3a0a 2020 2020 2020 2020 7261 6973  et:.        rais
+000081d0: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
+000081e0: 6e64 4572 726f 7228 2745 6d70 7479 2062  ndError('Empty b
+000081f0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
+00008200: 2520 6473 745f 7572 6c29 0a20 2020 2069  % dst_url).    i
+00008210: 6620 6e6f 7420 6473 745f 6b65 7920 6f72  f not dst_key or
+00008220: 2064 7374 5f6b 6579 2e65 6e64 7377 6974   dst_key.endswit
+00008230: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+00008240: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
+00008250: 746f 7279 4572 726f 7228 2749 7320 6120  toryError('Is a 
+00008260: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
+00008270: 2064 7374 5f75 726c 290a 0a20 2020 2063   dst_url)..    c
+00008280: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
+00008290: 6c69 656e 7428 7072 6f66 696c 655f 6e61  lient(profile_na
+000082a0: 6d65 3d53 3350 6174 6828 6473 745f 7572  me=S3Path(dst_ur
+000082b0: 6c29 2e5f 7072 6f66 696c 655f 6e61 6d65  l)._profile_name
+000082c0: 290a 2020 2020 7769 7468 206f 7065 6e28  ).    with open(
+000082d0: 7372 635f 7061 7468 2e70 6174 685f 7769  src_path.path_wi
+000082e0: 7468 6f75 745f 7072 6f74 6f63 6f6c 2c20  thout_protocol, 
+000082f0: 2772 6227 2920 6173 2073 7263 3a0a 2020  'rb') as src:.  
+00008300: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+00008310: 5f73 335f 6572 726f 7228 6473 745f 7572  _s3_error(dst_ur
+00008320: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
+00008330: 636c 6965 6e74 2e75 706c 6f61 645f 6669  client.upload_fi
+00008340: 6c65 6f62 6a28 0a20 2020 2020 2020 2020  leobj(.         
+00008350: 2020 2020 2020 2073 7263 2c20 4275 636b         src, Buck
+00008360: 6574 3d64 7374 5f62 7563 6b65 742c 204b  et=dst_bucket, K
+00008370: 6579 3d64 7374 5f6b 6579 2c20 4361 6c6c  ey=dst_key, Call
+00008380: 6261 636b 3d63 616c 6c62 6163 6b29 0a0a  back=callback)..
+00008390: 0a64 6566 2073 335f 6c6f 6164 5f63 6f6e  .def s3_load_con
+000083a0: 7465 6e74 280a 2020 2020 2020 2020 7333  tent(.        s3
+000083b0: 5f75 726c 2c0a 2020 2020 2020 2020 7374  _url,.        st
+000083c0: 6172 743a 204f 7074 696f 6e61 6c5b 696e  art: Optional[in
+000083d0: 745d 203d 204e 6f6e 652c 0a20 2020 2020  t] = None,.     
+000083e0: 2020 2073 746f 703a 204f 7074 696f 6e61     stop: Optiona
+000083f0: 6c5b 696e 745d 203d 204e 6f6e 652c 0a20  l[int] = None,. 
+00008400: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+00008410: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+00008420: 2920 2d3e 2062 7974 6573 3a0a 2020 2020  ) -> bytes:.    
+00008430: 2727 270a 2020 2020 4765 7420 7370 6563  '''.    Get spec
+00008440: 6966 6965 6420 6669 6c65 2066 726f 6d20  ified file from 
+00008450: 5b73 7461 7274 2c20 7374 6f70 2920 696e  [start, stop) in
+00008460: 2062 7974 6573 0a0a 2020 2020 3a70 6172   bytes..    :par
+00008470: 616d 2073 335f 7572 6c3a 2053 7065 6369  am s3_url: Speci
+00008480: 6669 6564 2070 6174 680a 2020 2020 3a70  fied path.    :p
+00008490: 6172 616d 2073 7461 7274 3a20 7374 6172  aram start: star
+000084a0: 7420 696e 6465 780a 2020 2020 3a70 6172  t index.    :par
+000084b0: 616d 2073 746f 703a 2073 746f 7020 696e  am stop: stop in
+000084c0: 6465 780a 2020 2020 3a72 6574 7572 6e73  dex.    :returns
+000084d0: 3a20 6279 7465 7320 636f 6e74 656e 7420  : bytes content 
+000084e0: 696e 2072 616e 6765 205b 7374 6172 742c  in range [start,
+000084f0: 2073 746f 7029 0a20 2020 2027 2727 0a0a   stop).    '''..
+00008500: 2020 2020 6465 6620 5f67 6574 5f6f 626a      def _get_obj
+00008510: 6563 7428 636c 6965 6e74 2c20 6275 636b  ect(client, buck
+00008520: 6574 2c20 6b65 792c 2072 616e 6765 5f73  et, key, range_s
+00008530: 7472 293a 0a20 2020 2020 2020 2072 6574  tr):.        ret
+00008540: 7572 6e20 636c 6965 6e74 2e67 6574 5f6f  urn client.get_o
+00008550: 626a 6563 7428 0a20 2020 2020 2020 2020  bject(.         
+00008560: 2020 2042 7563 6b65 743d 6275 636b 6574     Bucket=bucket
+00008570: 2c20 4b65 793d 6b65 792c 2052 616e 6765  , Key=key, Range
+00008580: 3d72 616e 6765 5f73 7472 295b 2742 6f64  =range_str)['Bod
+00008590: 7927 5d2e 7265 6164 2829 0a0a 2020 2020  y'].read()..    
+000085a0: 7333 5f75 726c 203d 2053 3350 6174 6828  s3_url = S3Path(
+000085b0: 7333 5f75 726c 290a 2020 2020 6966 2066  s3_url).    if f
+000085c0: 6f6c 6c6f 776c 696e 6b73 3a0a 2020 2020  ollowlinks:.    
+000085d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000085e0: 2020 2020 2073 335f 7572 6c20 3d20 7333       s3_url = s3
+000085f0: 5f75 726c 2e72 6561 646c 696e 6b28 290a  _url.readlink().
+00008600: 2020 2020 2020 2020 6578 6365 7074 2053          except S
+00008610: 334e 6f74 414c 696e 6b45 7272 6f72 3a0a  3NotALinkError:.
+00008620: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00008630: 0a0a 2020 2020 6275 636b 6574 2c20 6b65  ..    bucket, ke
+00008640: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00008650: 2873 335f 7572 6c2e 7061 7468 5f77 6974  (s3_url.path_wit
+00008660: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00008670: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
+00008680: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
+00008690: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+000086a0: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
+000086b0: 206e 616d 653a 2025 7227 2025 2073 335f   name: %r' % s3_
+000086c0: 7572 6c29 0a20 2020 2069 6620 6e6f 7420  url).    if not 
+000086d0: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
+000086e0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+000086f0: 2020 7261 6973 6520 5333 4973 4144 6972    raise S3IsADir
+00008700: 6563 746f 7279 4572 726f 7228 2749 7320  ectoryError('Is 
+00008710: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
+00008720: 2025 2073 335f 7572 6c29 0a0a 2020 2020   % s3_url)..    
+00008730: 7374 6172 742c 2073 746f 7020 3d20 6765  start, stop = ge
+00008740: 745f 636f 6e74 656e 745f 6f66 6673 6574  t_content_offset
+00008750: 280a 2020 2020 2020 2020 7374 6172 742c  (.        start,
+00008760: 2073 746f 702c 2073 335f 7572 6c2e 6765   stop, s3_url.ge
+00008770: 7473 697a 6528 666f 6c6c 6f77 5f73 796d  tsize(follow_sym
+00008780: 6c69 6e6b 733d 4661 6c73 6529 290a 2020  links=False)).  
+00008790: 2020 6966 2073 7461 7274 203d 3d20 3020    if start == 0 
+000087a0: 616e 6420 7374 6f70 203d 3d20 303a 0a20  and stop == 0:. 
+000087b0: 2020 2020 2020 2072 6574 7572 6e20 6227         return b'
+000087c0: 270a 2020 2020 7261 6e67 655f 7374 7220  '.    range_str 
+000087d0: 3d20 2762 7974 6573 3d25 642d 2564 2720  = 'bytes=%d-%d' 
+000087e0: 2520 2873 7461 7274 2c20 7374 6f70 202d  % (start, stop -
+000087f0: 2031 290a 0a20 2020 2063 6c69 656e 7420   1)..    client 
+00008800: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
+00008810: 7072 6f66 696c 655f 6e61 6d65 3d73 335f  profile_name=s3_
+00008820: 7572 6c2e 5f70 726f 6669 6c65 5f6e 616d  url._profile_nam
+00008830: 6529 0a20 2020 2077 6974 6820 7261 6973  e).    with rais
+00008840: 655f 7333 5f65 7272 6f72 2873 335f 7572  e_s3_error(s3_ur
+00008850: 6c2e 7061 7468 293a 0a20 2020 2020 2020  l.path):.       
+00008860: 2072 6574 7572 6e20 7061 7463 685f 6d65   return patch_me
+00008870: 7468 6f64 280a 2020 2020 2020 2020 2020  thod(.          
+00008880: 2020 5f67 6574 5f6f 626a 6563 742c 0a20    _get_object,. 
+00008890: 2020 2020 2020 2020 2020 206d 6178 5f72             max_r
+000088a0: 6574 7269 6573 3d6d 6178 5f72 6574 7269  etries=max_retri
+000088b0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+000088c0: 7368 6f75 6c64 5f72 6574 7279 3d73 335f  should_retry=s3_
+000088d0: 7368 6f75 6c64 5f72 6574 7279 2c0a 2020  should_retry,.  
+000088e0: 2020 2020 2020 2928 636c 6965 6e74 2c20        )(client, 
+000088f0: 6275 636b 6574 2c20 6b65 792c 2072 616e  bucket, key, ran
+00008900: 6765 5f73 7472 290a 0a0a 6465 6620 7333  ge_str)...def s3
+00008910: 5f72 6561 646c 696e 6b28 7061 7468 2920  _readlink(path) 
+00008920: 2d3e 2073 7472 3a0a 2020 2020 2727 270a  -> str:.    '''.
+00008930: 2020 2020 5265 7475 726e 2061 2073 7472      Return a str
+00008940: 696e 6720 7265 7072 6573 656e 7469 6e67  ing representing
+00008950: 2074 6865 2070 6174 6820 746f 2077 6869   the path to whi
+00008960: 6368 2074 6865 2073 796d 626f 6c69 6320  ch the symbolic 
+00008970: 6c69 6e6b 2070 6f69 6e74 732e 0a0a 2020  link points...  
+00008980: 2020 3a72 6574 7572 6e73 3a20 5265 7475    :returns: Retu
+00008990: 726e 2061 2073 7472 696e 6720 7265 7072  rn a string repr
+000089a0: 6573 656e 7469 6e67 2074 6865 2070 6174  esenting the pat
+000089b0: 6820 746f 2077 6869 6368 2074 6865 2073  h to which the s
+000089c0: 796d 626f 6c69 6320 6c69 6e6b 2070 6f69  ymbolic link poi
+000089d0: 6e74 732e 0a20 2020 203a 7261 6973 6573  nts..    :raises
+000089e0: 3a20 5333 4e61 6d65 546f 6f4c 6f6e 6745  : S3NameTooLongE
+000089f0: 7272 6f72 2c20 5333 4275 636b 6574 4e6f  rror, S3BucketNo
+00008a00: 7446 6f75 6e64 4572 726f 722c 2053 3349  tFoundError, S3I
+00008a10: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
+00008a20: 2c20 5333 4e6f 7441 4c69 6e6b 4572 726f  , S3NotALinkErro
+00008a30: 720a 2020 2020 2727 270a 2020 2020 7265  r.    '''.    re
+00008a40: 7475 726e 2053 3350 6174 6828 7061 7468  turn S3Path(path
+00008a50: 292e 7265 6164 6c69 6e6b 2829 2e70 6174  ).readlink().pat
+00008a60: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
+00008a70: 0a0a 6465 6620 7333 5f72 656e 616d 6528  ..def s3_rename(
+00008a80: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
+00008a90: 652c 2064 7374 5f75 726c 3a20 5061 7468  e, dst_url: Path
+00008aa0: 4c69 6b65 293a 0a20 2020 2027 2727 0a20  Like):.    '''. 
+00008ab0: 2020 204d 6f76 6520 7333 2066 696c 6520     Move s3 file 
+00008ac0: 7061 7468 2066 726f 6d20 7372 635f 7572  path from src_ur
+00008ad0: 6c20 746f 2064 7374 5f75 726c 0a0a 2020  l to dst_url..  
+00008ae0: 2020 3a70 6172 616d 2064 7374 5f75 726c    :param dst_url
+00008af0: 3a20 4769 7665 6e20 6465 7374 696e 6174  : Given destinat
+00008b00: 696f 6e20 7061 7468 0a20 2020 2027 2727  ion path.    '''
+00008b10: 0a20 2020 2073 7263 5f70 6174 685f 696e  .    src_path_in
+00008b20: 7320 3d20 5333 5061 7468 2873 7263 5f75  s = S3Path(src_u
+00008b30: 726c 290a 2020 2020 6966 2073 7263 5f70  rl).    if src_p
+00008b40: 6174 685f 696e 732e 6973 5f66 696c 6528  ath_ins.is_file(
+00008b50: 293a 0a20 2020 2020 2020 2073 7263 5f70  ):.        src_p
+00008b60: 6174 685f 696e 732e 636f 7079 2864 7374  ath_ins.copy(dst
+00008b70: 5f75 726c 290a 2020 2020 656c 7365 3a0a  _url).    else:.
+00008b80: 2020 2020 2020 2020 7372 635f 7061 7468          src_path
+00008b90: 5f69 6e73 2e73 796e 6328 6473 745f 7572  _ins.sync(dst_ur
+00008ba0: 6c29 0a20 2020 2073 7263 5f70 6174 685f  l).    src_path_
+00008bb0: 696e 732e 7265 6d6f 7665 2829 0a0a 0a63  ins.remove()...c
+00008bc0: 6c61 7373 2053 3343 6163 6865 7228 4669  lass S3Cacher(Fi
+00008bd0: 6c65 4361 6368 6572 293a 0a20 2020 2063  leCacher):.    c
+00008be0: 6163 6865 5f70 6174 6820 3d20 4e6f 6e65  ache_path = None
+00008bf0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00008c00: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
+00008c10: 7365 6c66 2c20 7061 7468 3a20 7374 722c  self, path: str,
+00008c20: 2063 6163 6865 5f70 6174 683a 204f 7074   cache_path: Opt
+00008c30: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00008c40: 652c 206d 6f64 653a 2073 7472 203d 2027  e, mode: str = '
+00008c50: 7227 293a 0a20 2020 2020 2020 2069 6620  r'):.        if 
+00008c60: 6d6f 6465 206e 6f74 2069 6e20 2827 7227  mode not in ('r'
+00008c70: 2c20 2777 272c 2027 6127 293a 0a20 2020  , 'w', 'a'):.   
+00008c80: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00008c90: 616c 7565 4572 726f 7228 2775 6e61 6363  alueError('unacc
+00008ca0: 6570 7461 626c 6520 6d6f 6465 3a20 2572  eptable mode: %r
+00008cb0: 2720 2520 6d6f 6465 290a 2020 2020 2020  ' % mode).      
+00008cc0: 2020 6966 206d 6f64 6520 696e 2028 2772    if mode in ('r
+00008cd0: 272c 2027 6127 293a 0a20 2020 2020 2020  ', 'a'):.       
+00008ce0: 2020 2020 2069 6620 6361 6368 655f 7061       if cache_pa
+00008cf0: 7468 2069 7320 4e6f 6e65 3a0a 2020 2020  th is None:.    
+00008d00: 2020 2020 2020 2020 2020 2020 6361 6368              cach
+00008d10: 655f 7061 7468 203d 2067 656e 6572 6174  e_path = generat
+00008d20: 655f 6361 6368 655f 7061 7468 2870 6174  e_cache_path(pat
+00008d30: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
+00008d40: 335f 646f 776e 6c6f 6164 2870 6174 682c  3_download(path,
+00008d50: 2063 6163 6865 5f70 6174 6829 0a20 2020   cache_path).   
+00008d60: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
+00008d70: 2070 6174 680a 2020 2020 2020 2020 7365   path.        se
+00008d80: 6c66 2e6d 6f64 6520 3d20 6d6f 6465 0a20  lf.mode = mode. 
+00008d90: 2020 2020 2020 2073 656c 662e 6361 6368         self.cach
+00008da0: 655f 7061 7468 203d 2063 6163 6865 5f70  e_path = cache_p
+00008db0: 6174 680a 0a20 2020 2064 6566 205f 636c  ath..    def _cl
+00008dc0: 6f73 6528 7365 6c66 293a 0a20 2020 2020  ose(self):.     
+00008dd0: 2020 2069 6620 7365 6c66 2e63 6163 6865     if self.cache
+00008de0: 5f70 6174 6820 6973 206e 6f74 204e 6f6e  _path is not Non
+00008df0: 6520 616e 6420 5c0a 2020 2020 2020 2020  e and \.        
+00008e00: 2020 2020 6f73 2e70 6174 682e 6578 6973      os.path.exis
+00008e10: 7473 2873 656c 662e 6361 6368 655f 7061  ts(self.cache_pa
+00008e20: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+00008e30: 2069 6620 7365 6c66 2e6d 6f64 6520 696e   if self.mode in
+00008e40: 2028 2777 272c 2027 6127 293a 0a20 2020   ('w', 'a'):.   
+00008e50: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
+00008e60: 7570 6c6f 6164 2873 656c 662e 6361 6368  upload(self.cach
+00008e70: 655f 7061 7468 2c20 7365 6c66 2e6e 616d  e_path, self.nam
+00008e80: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+00008e90: 732e 756e 6c69 6e6b 2873 656c 662e 6361  s.unlink(self.ca
+00008ea0: 6368 655f 7061 7468 290a 0a0a 6465 6620  che_path)...def 
+00008eb0: 7333 5f67 6c6f 6228 0a20 2020 2020 2020  s3_glob(.       
+00008ec0: 2070 6174 683a 2050 6174 684c 696b 652c   path: PathLike,
+00008ed0: 0a20 2020 2020 2020 2072 6563 7572 7369  .        recursi
+00008ee0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
+00008ef0: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
+00008f00: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
+00008f10: 2c0a 2020 2020 2020 2020 666f 6c6c 6f77  ,.        follow
+00008f20: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+00008f30: 6c73 652c 0a29 202d 3e20 4c69 7374 5b73  lse,.) -> List[s
+00008f40: 7472 5d3a 0a20 2020 2027 2727 5265 7475  tr]:.    '''Retu
+00008f50: 726e 2073 3320 7061 7468 206c 6973 7420  rn s3 path list 
+00008f60: 696e 2061 7363 656e 6469 6e67 2061 6c70  in ascending alp
+00008f70: 6861 6265 7469 6361 6c20 6f72 6465 722c  habetical order,
+00008f80: 2069 6e20 7768 6963 6820 7061 7468 206d   in which path m
+00008f90: 6174 6368 6573 2067 6c6f 6220 7061 7474  atches glob patt
+00008fa0: 6572 6e0a 2020 2020 4e6f 7465 733a 204f  ern.    Notes: O
+00008fb0: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
+00008fc0: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
+00008fd0: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
+00008fe0: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
+00008ff0: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
+00009000: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
+00009010: 2020 2020 3a70 6172 616d 2072 6563 7572      :param recur
+00009020: 7369 7665 3a20 4966 2046 616c 7365 2c20  sive: If False, 
+00009030: 602a 2a60 2077 696c 6c20 6e6f 7420 7365  `**` will not se
+00009040: 6172 6368 2064 6972 6563 746f 7279 2072  arch directory r
+00009050: 6563 7572 7369 7665 6c79 0a20 2020 203a  ecursively.    :
+00009060: 7061 7261 6d20 6d69 7373 696e 675f 6f6b  param missing_ok
+00009070: 3a20 4966 2046 616c 7365 2061 6e64 2074  : If False and t
+00009080: 6172 6765 7420 7061 7468 2064 6f65 736e  arget path doesn
+00009090: 2774 206d 6174 6368 2061 6e79 2066 696c  't match any fil
+000090a0: 652c 2072 6169 7365 2046 696c 654e 6f74  e, raise FileNot
+000090b0: 466f 756e 6445 7272 6f72 0a20 2020 203a  FoundError.    :
+000090c0: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
+000090d0: 7465 6445 7272 6f72 2c20 7768 656e 2062  tedError, when b
+000090e0: 7563 6b65 7420 7061 7274 2063 6f6e 7461  ucket part conta
+000090f0: 696e 7320 7769 6c64 6361 7264 2063 6861  ins wildcard cha
+00009100: 7261 6374 6572 730a 2020 2020 3a72 6574  racters.    :ret
+00009110: 7572 6e73 3a20 4120 6c69 7374 2063 6f6e  urns: A list con
+00009120: 7461 696e 7320 7061 7468 7320 6d61 7463  tains paths matc
+00009130: 6820 6073 335f 7061 7468 6e61 6d65 600a  h `s3_pathname`.
+00009140: 2020 2020 2727 270a 2020 2020 7265 7475      '''.    retu
+00009150: 726e 206c 6973 7428 0a20 2020 2020 2020  rn list(.       
+00009160: 2073 335f 6967 6c6f 6228 0a20 2020 2020   s3_iglob(.     
+00009170: 2020 2020 2020 2070 6174 683d 7061 7468         path=path
+00009180: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00009190: 6375 7273 6976 653d 7265 6375 7273 6976  cursive=recursiv
+000091a0: 652c 0a20 2020 2020 2020 2020 2020 206d  e,.            m
+000091b0: 6973 7369 6e67 5f6f 6b3d 6d69 7373 696e  issing_ok=missin
+000091c0: 675f 6f6b 2c0a 2020 2020 2020 2020 2020  g_ok,.          
+000091d0: 2020 666f 6c6c 6f77 6c69 6e6b 733d 666f    followlinks=fo
+000091e0: 6c6c 6f77 6c69 6e6b 7329 290a 0a0a 6465  llowlinks))...de
+000091f0: 6620 7333 5f67 6c6f 625f 7374 6174 280a  f s3_glob_stat(.
+00009200: 2020 2020 2020 2020 7061 7468 3a20 5061          path: Pa
+00009210: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
+00009220: 7265 6375 7273 6976 653a 2062 6f6f 6c20  recursive: bool 
+00009230: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+00009240: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
+00009250: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+00009260: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
+00009270: 6f6c 203d 2046 616c 7365 2920 2d3e 2049  ol = False) -> I
+00009280: 7465 7261 746f 725b 4669 6c65 456e 7472  terator[FileEntr
+00009290: 795d 3a0a 2020 2020 2727 2752 6574 7572  y]:.    '''Retur
+000092a0: 6e20 6120 6765 6e65 7261 746f 7220 636f  n a generator co
+000092b0: 6e74 6169 6e73 2074 7570 6c65 7320 6f66  ntains tuples of
+000092c0: 2070 6174 6820 616e 6420 6669 6c65 2073   path and file s
+000092d0: 7461 742c 2069 6e20 6173 6365 6e64 696e  tat, in ascendin
+000092e0: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
+000092f0: 7264 6572 2c20 696e 2077 6869 6368 2070  rder, in which p
+00009300: 6174 6820 6d61 7463 6865 7320 676c 6f62  ath matches glob
+00009310: 2070 6174 7465 726e 0a20 2020 204e 6f74   pattern.    Not
+00009320: 6573 3a20 4f6e 6c79 2067 6c6f 6220 696e  es: Only glob in
+00009330: 2062 7563 6b65 742e 2049 6620 7472 7969   bucket. If tryi
+00009340: 6e67 2074 6f20 6d61 7463 6820 6275 636b  ng to match buck
+00009350: 6574 2077 6974 6820 7769 6c64 6361 7264  et with wildcard
+00009360: 2063 6861 7261 6374 6572 732c 2072 6169   characters, rai
+00009370: 7365 2055 6e73 7570 706f 7274 6564 4572  se UnsupportedEr
+00009380: 726f 720a 0a20 2020 203a 7061 7261 6d20  ror..    :param 
+00009390: 7265 6375 7273 6976 653a 2049 6620 4661  recursive: If Fa
+000093a0: 6c73 652c 2060 2a2a 6020 7769 6c6c 206e  lse, `**` will n
+000093b0: 6f74 2073 6561 7263 6820 6469 7265 6374  ot search direct
+000093c0: 6f72 7920 7265 6375 7273 6976 656c 790a  ory recursively.
+000093d0: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
+000093e0: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
+000093f0: 616e 6420 7461 7267 6574 2070 6174 6820  and target path 
+00009400: 646f 6573 6e27 7420 6d61 7463 6820 616e  doesn't match an
+00009410: 7920 6669 6c65 2c20 7261 6973 6520 4669  y file, raise Fi
+00009420: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
+00009430: 2020 2020 3a72 6169 7365 733a 2055 6e73      :raises: Uns
+00009440: 7570 706f 7274 6564 4572 726f 722c 2077  upportedError, w
+00009450: 6865 6e20 6275 636b 6574 2070 6172 7420  hen bucket part 
+00009460: 636f 6e74 6169 6e73 2077 696c 6463 6172  contains wildcar
+00009470: 6420 6368 6172 6163 7465 7273 0a20 2020  d characters.   
+00009480: 203a 7265 7475 726e 733a 2041 2067 656e   :returns: A gen
+00009490: 6572 6174 6f72 2063 6f6e 7461 696e 7320  erator contains 
+000094a0: 7475 706c 6573 206f 6620 7061 7468 2061  tuples of path a
+000094b0: 6e64 2066 696c 6520 7374 6174 2c20 696e  nd file stat, in
+000094c0: 2077 6869 6368 2070 6174 6873 206d 6174   which paths mat
+000094d0: 6368 2060 7333 5f70 6174 686e 616d 6560  ch `s3_pathname`
+000094e0: 0a20 2020 2027 2727 0a20 2020 2072 6574  .    '''.    ret
+000094f0: 7572 6e20 5333 5061 7468 2870 6174 6829  urn S3Path(path)
+00009500: 2e67 6c6f 625f 7374 6174 280a 2020 2020  .glob_stat(.    
+00009510: 2020 2020 7061 7474 6572 6e3d 2222 2c0a      pattern="",.
+00009520: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
+00009530: 653d 7265 6375 7273 6976 652c 0a20 2020  e=recursive,.   
+00009540: 2020 2020 206d 6973 7369 6e67 5f6f 6b3d       missing_ok=
+00009550: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
+00009560: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733d      followlinks=
+00009570: 666f 6c6c 6f77 6c69 6e6b 7329 0a0a 0a64  followlinks)...d
+00009580: 6566 2073 335f 6967 6c6f 6228 0a20 2020  ef s3_iglob(.   
+00009590: 2020 2020 2070 6174 683a 2050 6174 684c       path: PathL
+000095a0: 696b 652c 0a20 2020 2020 2020 2072 6563  ike,.        rec
+000095b0: 7572 7369 7665 3a20 626f 6f6c 203d 2054  ursive: bool = T
+000095c0: 7275 652c 0a20 2020 2020 2020 206d 6973  rue,.        mis
+000095d0: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
+000095e0: 5472 7565 2c0a 2020 2020 2020 2020 666f  True,.        fo
+000095f0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+00009600: 3d20 4661 6c73 652c 0a29 202d 3e20 4974  = False,.) -> It
+00009610: 6572 6174 6f72 5b73 7472 5d3a 0a20 2020  erator[str]:.   
+00009620: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
+00009630: 7468 2069 7465 7261 746f 7220 696e 2061  th iterator in a
+00009640: 7363 656e 6469 6e67 2061 6c70 6861 6265  scending alphabe
+00009650: 7469 6361 6c20 6f72 6465 722c 2069 6e20  tical order, in 
+00009660: 7768 6963 6820 7061 7468 206d 6174 6368  which path match
+00009670: 6573 2067 6c6f 6220 7061 7474 6572 6e0a  es glob pattern.
+00009680: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
+00009690: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
+000096a0: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
+000096b0: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
+000096c0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+000096d0: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
+000096e0: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
+000096f0: 3a70 6172 616d 2072 6563 7572 7369 7665  :param recursive
+00009700: 3a20 4966 2046 616c 7365 2c20 602a 2a60  : If False, `**`
+00009710: 2077 696c 6c20 6e6f 7420 7365 6172 6368   will not search
+00009720: 2064 6972 6563 746f 7279 2072 6563 7572   directory recur
+00009730: 7369 7665 6c79 0a20 2020 203a 7061 7261  sively.    :para
+00009740: 6d20 6d69 7373 696e 675f 6f6b 3a20 4966  m missing_ok: If
+00009750: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
+00009760: 7420 7061 7468 2064 6f65 736e 2774 206d  t path doesn't m
+00009770: 6174 6368 2061 6e79 2066 696c 652c 2072  atch any file, r
+00009780: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
+00009790: 6445 7272 6f72 0a20 2020 203a 7261 6973  dError.    :rais
+000097a0: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
+000097b0: 7272 6f72 2c20 7768 656e 2062 7563 6b65  rror, when bucke
+000097c0: 7420 7061 7274 2063 6f6e 7461 696e 7320  t part contains 
+000097d0: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
+000097e0: 6572 730a 2020 2020 3a72 6574 7572 6e73  ers.    :returns
+000097f0: 3a20 416e 2069 7465 7261 746f 7220 636f  : An iterator co
+00009800: 6e74 6169 6e73 2070 6174 6873 206d 6174  ntains paths mat
+00009810: 6368 2060 7333 5f70 6174 686e 616d 6560  ch `s3_pathname`
+00009820: 0a20 2020 2027 2727 0a20 2020 2066 6f72  .    '''.    for
+00009830: 2070 6174 685f 6f62 6a20 696e 2053 3350   path_obj in S3P
+00009840: 6174 6828 7061 7468 292e 6967 6c6f 6228  ath(path).iglob(
+00009850: 7061 7474 6572 6e3d 2222 2c20 7265 6375  pattern="", recu
+00009860: 7273 6976 653d 7265 6375 7273 6976 652c  rsive=recursive,
+00009870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009890: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+000098a0: 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c 0a20  ok=missing_ok,. 
+000098b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000098d0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+000098e0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 3a0a  s=followlinks):.
+000098f0: 2020 2020 2020 2020 7969 656c 6420 7061          yield pa
+00009900: 7468 5f6f 626a 2e70 6174 685f 7769 7468  th_obj.path_with
+00009910: 5f70 726f 746f 636f 6c0a 0a0a 6465 6620  _protocol...def 
+00009920: 7333 5f6d 616b 6564 6972 7328 7061 7468  s3_makedirs(path
+00009930: 3a20 5061 7468 4c69 6b65 2c20 6578 6973  : PathLike, exis
+00009940: 745f 6f6b 3a20 626f 6f6c 203d 2046 616c  t_ok: bool = Fal
+00009950: 7365 293a 0a20 2020 2027 2727 0a20 2020  se):.    '''.   
+00009960: 2043 7265 6174 6520 616e 2073 3320 6469   Create an s3 di
+00009970: 7265 6374 6f72 792e 0a20 2020 2050 7572  rectory..    Pur
+00009980: 656c 7920 6372 6561 7469 6e67 2064 6972  ely creating dir
+00009990: 6563 746f 7279 2069 7320 696e 7661 6c69  ectory is invali
+000099a0: 6420 6265 6361 7573 6520 6974 2773 2075  d because it's u
+000099b0: 6e61 7661 696c 6162 6c65 206f 6e20 4f53  navailable on OS
+000099c0: 532e 0a20 2020 2054 6869 7320 6675 6e63  S..    This func
+000099d0: 7469 6f6e 2069 7320 746f 2074 6573 7420  tion is to test 
+000099e0: 7468 6520 7461 7267 6574 2062 7563 6b65  the target bucke
+000099f0: 7420 6861 7665 2057 5249 5445 2061 6363  t have WRITE acc
+00009a00: 6573 732e 0a0a 2020 2020 3a70 6172 616d  ess...    :param
+00009a10: 2070 6174 683a 2047 6976 656e 2070 6174   path: Given pat
+00009a20: 680a 2020 2020 3a70 6172 616d 2065 7869  h.    :param exi
+00009a30: 7374 5f6f 6b3a 2049 6620 4661 6c73 6520  st_ok: If False 
+00009a40: 616e 6420 7461 7267 6574 2064 6972 6563  and target direc
+00009a50: 746f 7279 2065 7869 7374 732c 2072 6169  tory exists, rai
+00009a60: 7365 2053 3346 696c 6545 7869 7374 7345  se S3FileExistsE
+00009a70: 7272 6f72 0a20 2020 203a 7261 6973 6573  rror.    :raises
+00009a80: 3a20 5333 4275 636b 6574 4e6f 7446 6f75  : S3BucketNotFou
+00009a90: 6e64 4572 726f 722c 2053 3346 696c 6545  ndError, S3FileE
+00009aa0: 7869 7374 7345 7272 6f72 0a20 2020 2027  xistsError.    '
+00009ab0: 2727 0a20 2020 2072 6574 7572 6e20 5333  ''.    return S3
+00009ac0: 5061 7468 2870 6174 6829 2e6d 6b64 6972  Path(path).mkdir
+00009ad0: 2870 6172 656e 7473 3d54 7275 652c 2065  (parents=True, e
+00009ae0: 7869 7374 5f6f 6b3d 6578 6973 745f 6f6b  xist_ok=exist_ok
+00009af0: 290a 0a0a 6465 6620 5f67 726f 7570 5f73  )...def _group_s
+00009b00: 7263 5f70 6174 6873 5f62 795f 626c 6f63  rc_paths_by_bloc
+00009b10: 6b28 0a20 2020 2020 2020 2073 7263 5f70  k(.        src_p
+00009b20: 6174 6873 3a20 4c69 7374 5b50 6174 684c  aths: List[PathL
+00009b30: 696b 655d 2c20 626c 6f63 6b5f 7369 7a65  ike], block_size
+00009b40: 3a20 696e 7420 3d20 4445 4641 554c 545f  : int = DEFAULT_
+00009b50: 424c 4f43 4b5f 5349 5a45 0a29 202d 3e20  BLOCK_SIZE.) -> 
+00009b60: 4c69 7374 5b4c 6973 745b 5475 706c 655b  List[List[Tuple[
+00009b70: 5061 7468 4c69 6b65 2c20 4f70 7469 6f6e  PathLike, Option
+00009b80: 616c 5b73 7472 5d5d 5d5d 3a0a 2020 2020  al[str]]]]:.    
+00009b90: 6772 6f75 7073 203d 205b 5d0a 2020 2020  groups = [].    
+00009ba0: 6375 7272 656e 745f 6772 6f75 702c 2063  current_group, c
+00009bb0: 7572 7265 6e74 5f67 726f 7570 5f73 697a  urrent_group_siz
+00009bc0: 6520 3d20 5b5d 2c20 300a 2020 2020 666f  e = [], 0.    fo
+00009bd0: 7220 7372 635f 7061 7468 2069 6e20 7372  r src_path in sr
+00009be0: 635f 7061 7468 733a 0a20 2020 2020 2020  c_paths:.       
+00009bf0: 2063 7572 7265 6e74 5f66 696c 655f 7369   current_file_si
+00009c00: 7a65 203d 2053 3350 6174 6828 7372 635f  ze = S3Path(src_
+00009c10: 7061 7468 292e 7374 6174 2829 2e73 697a  path).stat().siz
+00009c20: 650a 2020 2020 2020 2020 6966 2063 7572  e.        if cur
+00009c30: 7265 6e74 5f66 696c 655f 7369 7a65 203d  rent_file_size =
+00009c40: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00009c50: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+00009c60: 2020 2069 6620 6375 7272 656e 745f 6669     if current_fi
+00009c70: 6c65 5f73 697a 6520 3e3d 2062 6c6f 636b  le_size >= block
+00009c80: 5f73 697a 653a 0a20 2020 2020 2020 2020  _size:.         
+00009c90: 2020 2069 6620 6c65 6e28 6772 6f75 7073     if len(groups
+00009ca0: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00009cb0: 2020 2020 2020 2020 6966 2063 7572 7265          if curre
+00009cc0: 6e74 5f67 726f 7570 5f73 697a 6520 2b20  nt_group_size + 
+00009cd0: 6375 7272 656e 745f 6669 6c65 5f73 697a  current_file_siz
+00009ce0: 6520 3e20 3220 2a20 626c 6f63 6b5f 7369  e > 2 * block_si
+00009cf0: 7a65 3a0a 2020 2020 2020 2020 2020 2020  ze:.            
+00009d00: 2020 2020 2020 2020 6772 6f75 705f 6c61          group_la
+00009d10: 636b 5f73 697a 6520 3d20 626c 6f63 6b5f  ck_size = block_
+00009d20: 7369 7a65 202d 2063 7572 7265 6e74 5f67  size - current_g
+00009d30: 726f 7570 5f73 697a 650a 2020 2020 2020  roup_size.      
+00009d40: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00009d50: 7272 656e 745f 6772 6f75 702e 6170 7065  rrent_group.appe
+00009d60: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+00009d70: 2020 2020 2020 2020 2020 2020 2873 7263              (src
+00009d80: 5f70 6174 682c 2066 2762 7974 6573 3d30  _path, f'bytes=0
+00009d90: 2d7b 6772 6f75 705f 6c61 636b 5f73 697a  -{group_lack_siz
+00009da0: 652d 317d 2729 290a 2020 2020 2020 2020  e-1}')).        
+00009db0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00009dc0: 7073 2e65 7874 656e 6428 0a20 2020 2020  ps.extend(.     
+00009dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009de0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00009df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e00: 2063 7572 7265 6e74 5f67 726f 7570 2c0a   current_group,.
+00009e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e20: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+00009e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e40: 2020 2020 2020 2020 2020 2020 2020 280a                (.
+00009e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e70: 2020 2020 7372 635f 7061 7468 2c0a 2020      src_path,.  
+00009e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ea0: 2020 6627 6279 7465 733d 7b67 726f 7570    f'bytes={group
+00009eb0: 5f6c 6163 6b5f 7369 7a65 7d2d 7b63 7572  _lack_size}-{cur
+00009ec0: 7265 6e74 5f66 696c 655f 7369 7a65 2d31  rent_file_size-1
+00009ed0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00009ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ef0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00009f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f10: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
+00009f20: 2020 2020 2020 2020 2020 205d 290a 2020             ]).  
+00009f30: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00009f40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00009f50: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00009f60: 6772 6f75 702e 6170 7065 6e64 2828 7372  group.append((sr
+00009f70: 635f 7061 7468 2c20 4e6f 6e65 2929 0a20  c_path, None)). 
+00009f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f90: 2020 2067 726f 7570 732e 6170 7065 6e64     groups.append
+00009fa0: 2863 7572 7265 6e74 5f67 726f 7570 290a  (current_group).
+00009fb0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00009fc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009fd0: 2020 6772 6f75 7073 5b2d 315d 2e65 7874    groups[-1].ext
+00009fe0: 656e 6428 6375 7272 656e 745f 6772 6f75  end(current_grou
+00009ff0: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
+0000a000: 2020 2067 726f 7570 732e 6170 7065 6e64     groups.append
+0000a010: 285b 2873 7263 5f70 6174 682c 204e 6f6e  ([(src_path, Non
+0000a020: 6529 5d29 0a20 2020 2020 2020 2020 2020  e)]).           
+0000a030: 2063 7572 7265 6e74 5f67 726f 7570 2c20   current_group, 
+0000a040: 6375 7272 656e 745f 6772 6f75 705f 7369  current_group_si
+0000a050: 7a65 203d 205b 5d2c 2030 0a20 2020 2020  ze = [], 0.     
+0000a060: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000a070: 2020 2020 2063 7572 7265 6e74 5f67 726f       current_gro
+0000a080: 7570 2e61 7070 656e 6428 2873 7263 5f70  up.append((src_p
+0000a090: 6174 682c 204e 6f6e 6529 290a 2020 2020  ath, None)).    
+0000a0a0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+0000a0b0: 6772 6f75 705f 7369 7a65 202b 3d20 6375  group_size += cu
+0000a0c0: 7272 656e 745f 6669 6c65 5f73 697a 650a  rrent_file_size.
+0000a0d0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0000a0e0: 7572 7265 6e74 5f67 726f 7570 5f73 697a  urrent_group_siz
+0000a0f0: 6520 3e3d 2062 6c6f 636b 5f73 697a 653a  e >= block_size:
+0000a100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a110: 2067 726f 7570 732e 6170 7065 6e64 2863   groups.append(c
+0000a120: 7572 7265 6e74 5f67 726f 7570 290a 2020  urrent_group).  
+0000a130: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+0000a140: 7272 656e 745f 6772 6f75 702c 2063 7572  rrent_group, cur
+0000a150: 7265 6e74 5f67 726f 7570 5f73 697a 6520  rent_group_size 
+0000a160: 3d20 5b5d 2c20 300a 2020 2020 6966 2063  = [], 0.    if c
+0000a170: 7572 7265 6e74 5f67 726f 7570 3a0a 2020  urrent_group:.  
+0000a180: 2020 2020 2020 6772 6f75 7073 2e61 7070        groups.app
+0000a190: 656e 6428 6375 7272 656e 745f 6772 6f75  end(current_grou
+0000a1a0: 7029 0a20 2020 2072 6574 7572 6e20 6772  p).    return gr
+0000a1b0: 6f75 7073 0a0a 0a64 6566 2073 335f 636f  oups...def s3_co
+0000a1c0: 6e63 6174 280a 2020 2020 2020 2020 7372  ncat(.        sr
+0000a1d0: 635f 7061 7468 733a 204c 6973 745b 5061  c_paths: List[Pa
+0000a1e0: 7468 4c69 6b65 5d2c 0a20 2020 2020 2020  thLike],.       
+0000a1f0: 2064 7374 5f70 6174 683a 2050 6174 684c   dst_path: PathL
+0000a200: 696b 652c 0a20 2020 2020 2020 2062 6c6f  ike,.        blo
+0000a210: 636b 5f73 697a 653a 2069 6e74 203d 2044  ck_size: int = D
+0000a220: 4546 4155 4c54 5f42 4c4f 434b 5f53 495a  EFAULT_BLOCK_SIZ
+0000a230: 452c 0a20 2020 2020 2020 206d 6178 5f77  E,.        max_w
+0000a240: 6f72 6b65 7273 3a20 696e 7420 3d20 474c  orkers: int = GL
+0000a250: 4f42 414c 5f4d 4158 5f57 4f52 4b45 5253  OBAL_MAX_WORKERS
+0000a260: 2920 2d3e 204e 6f6e 653a 0a20 2020 2027  ) -> None:.    '
+0000a270: 2727 436f 6e63 6174 656e 6174 6520 7333  ''Concatenate s3
+0000a280: 2066 696c 6573 2074 6f20 6f6e 6520 6669   files to one fi
+0000a290: 6c65 2e0a 0a20 2020 203a 7061 7261 6d20  le...    :param 
+0000a2a0: 7372 635f 7061 7468 733a 2047 6976 656e  src_paths: Given
+0000a2b0: 2073 6f75 7263 6520 7061 7468 730a 2020   source paths.  
+0000a2c0: 2020 3a70 6172 616d 2064 7374 5f70 6174    :param dst_pat
+0000a2d0: 683a 2047 6976 656e 2064 6573 7469 6e61  h: Given destina
+0000a2e0: 7469 6f6e 2070 6174 680a 2020 2020 2727  tion path.    ''
+0000a2f0: 270a 2020 2020 636c 6965 6e74 203d 2053  '.    client = S
+0000a300: 3350 6174 6828 6473 745f 7061 7468 292e  3Path(dst_path).
+0000a310: 5f63 6c69 656e 740a 2020 2020 7769 7468  _client.    with
+0000a320: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
+0000a330: 6473 745f 7061 7468 293a 0a20 2020 2020  dst_path):.     
+0000a340: 2020 2069 6620 626c 6f63 6b5f 7369 7a65     if block_size
+0000a350: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0000a360: 2020 2067 726f 7570 7320 3d20 5b5b 2873     groups = [[(s
+0000a370: 7263 5f70 6174 682c 204e 6f6e 6529 5d20  rc_path, None)] 
+0000a380: 666f 7220 7372 635f 7061 7468 2069 6e20  for src_path in 
+0000a390: 7372 635f 7061 7468 735d 0a20 2020 2020  src_paths].     
+0000a3a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000a3b0: 2020 2020 2067 726f 7570 7320 3d20 5f67       groups = _g
+0000a3c0: 726f 7570 5f73 7263 5f70 6174 6873 5f62  roup_src_paths_b
+0000a3d0: 795f 626c 6f63 6b28 7372 635f 7061 7468  y_block(src_path
+0000a3e0: 732c 2062 6c6f 636b 5f73 697a 653d 626c  s, block_size=bl
+0000a3f0: 6f63 6b5f 7369 7a65 290a 0a20 2020 2020  ock_size)..     
+0000a400: 2020 2077 6974 6820 4d75 6c74 6950 6172     with MultiPar
+0000a410: 7457 7269 7465 7228 636c 6965 6e74 2c20  tWriter(client, 
+0000a420: 6473 745f 7061 7468 2920 6173 2077 7269  dst_path) as wri
+0000a430: 7465 722c 2054 6872 6561 6450 6f6f 6c45  ter, ThreadPoolE
+0000a440: 7865 6375 746f 7228 0a20 2020 2020 2020  xecutor(.       
+0000a450: 2020 2020 2020 2020 206d 6178 5f77 6f72           max_wor
+0000a460: 6b65 7273 3d6d 6178 5f77 6f72 6b65 7273  kers=max_workers
+0000a470: 2920 6173 2065 7865 6375 746f 723a 0a20  ) as executor:. 
+0000a480: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0000a490: 6e64 6578 2c20 6772 6f75 7020 696e 2065  ndex, group in e
+0000a4a0: 6e75 6d65 7261 7465 2867 726f 7570 732c  numerate(groups,
+0000a4b0: 2073 7461 7274 3d31 293a 0a20 2020 2020   start=1):.     
+0000a4c0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+0000a4d0: 6e28 6772 6f75 7029 203d 3d20 313a 0a20  n(group) == 1:. 
+0000a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4f0: 2020 2065 7865 6375 746f 722e 7375 626d     executor.subm
+0000a500: 6974 280a 2020 2020 2020 2020 2020 2020  it(.            
+0000a510: 2020 2020 2020 2020 2020 2020 7772 6974              writ
+0000a520: 6572 2e75 706c 6f61 645f 7061 7274 5f63  er.upload_part_c
+0000a530: 6f70 792c 2069 6e64 6578 2c20 6772 6f75  opy, index, grou
+0000a540: 705b 305d 5b30 5d2c 0a20 2020 2020 2020  p[0][0],.       
+0000a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a560: 2067 726f 7570 5b30 5d5b 315d 290a 2020   group[0][1]).  
+0000a570: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000a580: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000a590: 2020 2020 2020 2020 6578 6563 7574 6f72          executor
+0000a5a0: 2e73 7562 6d69 7428 7772 6974 6572 2e75  .submit(writer.u
+0000a5b0: 706c 6f61 645f 7061 7274 5f62 795f 7061  pload_part_by_pa
+0000a5c0: 7468 732c 2069 6e64 6578 2c20 6772 6f75  ths, index, grou
+0000a5d0: 7029 0a0a 0a40 536d 6172 7450 6174 682e  p)...@SmartPath.
+0000a5e0: 7265 6769 7374 6572 0a63 6c61 7373 2053  register.class S
+0000a5f0: 3350 6174 6828 5552 4950 6174 6829 3a0a  3Path(URIPath):.
+0000a600: 0a20 2020 2070 726f 746f 636f 6c20 3d20  .    protocol = 
+0000a610: 2273 3322 0a0a 2020 2020 6465 6620 5f5f  "s3"..    def __
+0000a620: 696e 6974 5f5f 2873 656c 662c 2070 6174  init__(self, pat
+0000a630: 683a 2022 5061 7468 4c69 6b65 222c 202a  h: "PathLike", *
+0000a640: 6f74 6865 725f 7061 7468 733a 2022 5061  other_paths: "Pa
+0000a650: 7468 4c69 6b65 2229 3a0a 2020 2020 2020  thLike"):.      
+0000a660: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+0000a670: 5f5f 2870 6174 682c 202a 6f74 6865 725f  __(path, *other_
+0000a680: 7061 7468 7329 0a20 2020 2020 2020 2070  paths).        p
+0000a690: 726f 746f 636f 6c20 3d20 6765 745f 7572  rotocol = get_ur
+0000a6a0: 6c5f 7363 6865 6d65 2873 656c 662e 7061  l_scheme(self.pa
+0000a6b0: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
+0000a6c0: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
+0000a6d0: 7072 6f66 696c 6520 3d20 7365 6c66 2e70  profile = self.p
+0000a6e0: 726f 746f 636f 6c0a 2020 2020 2020 2020  rotocol.        
+0000a6f0: 7365 6c66 2e5f 7072 6f66 696c 655f 6e61  self._profile_na
+0000a700: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
+0000a710: 2020 6966 2070 726f 746f 636f 6c2e 7374    if protocol.st
+0000a720: 6172 7473 7769 7468 2827 7333 2b27 293a  artswith('s3+'):
+0000a730: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000a740: 662e 5f70 726f 746f 636f 6c5f 7769 7468  f._protocol_with
+0000a750: 5f70 726f 6669 6c65 203d 2070 726f 746f  _profile = proto
+0000a760: 636f 6c0a 2020 2020 2020 2020 2020 2020  col.            
+0000a770: 7365 6c66 2e5f 7072 6f66 696c 655f 6e61  self._profile_na
+0000a780: 6d65 203d 2070 726f 746f 636f 6c5b 333a  me = protocol[3:
+0000a790: 5d0a 2020 2020 2020 2020 2020 2020 7365  ].            se
+0000a7a0: 6c66 2e5f 7333 5f70 6174 6820 3d20 6622  lf._s3_path = f"
+0000a7b0: 7333 3a2f 2f7b 7365 6c66 2e70 6174 685b  s3://{self.path[
+0000a7c0: 6c65 6e28 7072 6f74 6f63 6f6c 292b 333a  len(protocol)+3:
+0000a7d0: 5d7d 220a 2020 2020 2020 2020 656c 6966  ]}".        elif
+0000a7e0: 206e 6f74 2070 726f 746f 636f 6c3a 0a20   not protocol:. 
+0000a7f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000a800: 5f73 335f 7061 7468 203d 2066 2273 333a  _s3_path = f"s3:
+0000a810: 2f2f 7b73 656c 662e 7061 7468 2e6c 7374  //{self.path.lst
+0000a820: 7269 7028 272f 2729 7d22 0a20 2020 2020  rip('/')}".     
+0000a830: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000a840: 2020 2020 2073 656c 662e 5f73 335f 7061       self._s3_pa
+0000a850: 7468 203d 2073 656c 662e 7061 7468 0a0a  th = self.path..
+0000a860: 2020 2020 4063 6163 6865 6470 726f 7065      @cachedprope
+0000a870: 7274 790a 2020 2020 6465 6620 7061 7468  rty.    def path
+0000a880: 5f77 6974 685f 7072 6f74 6f63 6f6c 2873  _with_protocol(s
+0000a890: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+0000a8a0: 2020 2020 2027 2727 5265 7475 726e 2070       '''Return p
+0000a8b0: 6174 6820 7769 7468 2070 726f 746f 636f  ath with protoco
+0000a8c0: 6c2c 206c 696b 6520 6669 6c65 3a2f 2f2f  l, like file:///
+0000a8d0: 726f 6f74 2c20 7333 3a2f 2f62 7563 6b65  root, s3://bucke
+0000a8e0: 742f 6b65 7927 2727 0a20 2020 2020 2020  t/key'''.       
+0000a8f0: 2070 6174 6820 3d20 7365 6c66 2e70 6174   path = self.pat
+0000a900: 680a 2020 2020 2020 2020 7072 6f74 6f63  h.        protoc
+0000a910: 6f6c 5f70 7265 6669 7820 3d20 7365 6c66  ol_prefix = self
+0000a920: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
+0000a930: 7072 6f66 696c 6520 2b20 223a 2f2f 220a  profile + "://".
+0000a940: 2020 2020 2020 2020 6966 2070 6174 682e          if path.
+0000a950: 7374 6172 7473 7769 7468 2870 726f 746f  startswith(proto
+0000a960: 636f 6c5f 7072 6566 6978 293a 0a20 2020  col_prefix):.   
+0000a970: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000a980: 7061 7468 0a20 2020 2020 2020 2072 6574  path.        ret
+0000a990: 7572 6e20 7072 6f74 6f63 6f6c 5f70 7265  urn protocol_pre
+0000a9a0: 6669 7820 2b20 7061 7468 2e6c 7374 7269  fix + path.lstri
+0000a9b0: 7028 272f 2729 0a0a 2020 2020 4063 6163  p('/')..    @cac
+0000a9c0: 6865 6470 726f 7065 7274 790a 2020 2020  hedproperty.    
+0000a9d0: 6465 6620 7061 7468 5f77 6974 686f 7574  def path_without
+0000a9e0: 5f70 726f 746f 636f 6c28 7365 6c66 2920  _protocol(self) 
+0000a9f0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+0000aa00: 2727 2752 6574 7572 6e20 7061 7468 2077  '''Return path w
+0000aa10: 6974 686f 7574 2070 726f 746f 636f 6c2c  ithout protocol,
+0000aa20: 2065 7861 6d70 6c65 3a20 6966 2070 6174   example: if pat
+0000aa30: 6820 6973 2073 333a 2f2f 6275 636b 6574  h is s3://bucket
+0000aa40: 2f6b 6579 2c20 7265 7475 726e 2062 7563  /key, return buc
+0000aa50: 6b65 742f 6b65 7927 2727 0a20 2020 2020  ket/key'''.     
+0000aa60: 2020 2070 6174 6820 3d20 7365 6c66 2e70     path = self.p
+0000aa70: 6174 680a 2020 2020 2020 2020 7072 6f74  ath.        prot
+0000aa80: 6f63 6f6c 5f70 7265 6669 7820 3d20 7365  ocol_prefix = se
+0000aa90: 6c66 2e5f 7072 6f74 6f63 6f6c 5f77 6974  lf._protocol_wit
+0000aaa0: 685f 7072 6f66 696c 6520 2b20 223a 2f2f  h_profile + "://
+0000aab0: 220a 2020 2020 2020 2020 6966 2070 6174  ".        if pat
+0000aac0: 682e 7374 6172 7473 7769 7468 2870 726f  h.startswith(pro
+0000aad0: 746f 636f 6c5f 7072 6566 6978 293a 0a20  tocol_prefix):. 
+0000aae0: 2020 2020 2020 2020 2020 2070 6174 6820             path 
+0000aaf0: 3d20 7061 7468 5b6c 656e 2870 726f 746f  = path[len(proto
+0000ab00: 636f 6c5f 7072 6566 6978 293a 5d0a 2020  col_prefix):].  
+0000ab10: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
+0000ab20: 680a 0a20 2020 2040 6361 6368 6564 7072  h..    @cachedpr
+0000ab30: 6f70 6572 7479 0a20 2020 2064 6566 205f  operty.    def _
+0000ab40: 636c 6965 6e74 2873 656c 6629 3a0a 2020  client(self):.  
+0000ab50: 2020 2020 2020 7265 7475 726e 2067 6574        return get
+0000ab60: 5f73 335f 636c 6965 6e74 2870 726f 6669  _s3_client(profi
+0000ab70: 6c65 5f6e 616d 653d 7365 6c66 2e5f 7072  le_name=self._pr
+0000ab80: 6f66 696c 655f 6e61 6d65 290a 0a20 2020  ofile_name)..   
+0000ab90: 2064 6566 205f 7333 5f67 6574 5f6d 6574   def _s3_get_met
+0000aba0: 6164 6174 6128 7365 6c66 2920 2d3e 2064  adata(self) -> d
+0000abb0: 6963 743a 0a20 2020 2020 2020 2027 2727  ict:.        '''
+0000abc0: 0a20 2020 2020 2020 2047 6574 206f 626a  .        Get obj
+0000abd0: 6563 7420 6d65 7461 6461 7461 0a0a 2020  ect metadata..  
+0000abe0: 2020 2020 2020 3a70 6172 616d 2070 6174        :param pat
+0000abf0: 683a 204f 626a 6563 7420 7061 7468 0a20  h: Object path. 
+0000ac00: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000ac10: 204f 626a 6563 7420 6d65 7461 6461 7461   Object metadata
+0000ac20: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000ac30: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
+0000ac40: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+0000ac50: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000ac60: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+0000ac70: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
+0000ac80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000ac90: 726e 207b 7d0a 2020 2020 2020 2020 6966  rn {}.        if
+0000aca0: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
+0000acb0: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
+0000acc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000acd0: 6e20 7b7d 0a20 2020 2020 2020 2074 7279  n {}.        try
+0000ace0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+0000acf0: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
+0000ad00: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
+0000ad10: 5f70 726f 746f 636f 6c29 3a0a 2020 2020  _protocol):.    
+0000ad20: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+0000ad30: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
+0000ad40: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
+0000ad50: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
+0000ad60: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+0000ad70: 7265 7475 726e 2064 6963 7428 0a20 2020  return dict(.   
+0000ad80: 2020 2020 2020 2020 2020 2020 2028 6b65               (ke
+0000ad90: 792e 6c6f 7765 7228 292c 2076 616c 7565  y.lower(), value
+0000ada0: 2920 666f 7220 6b65 792c 2076 616c 7565  ) for key, value
+0000adb0: 2069 6e20 7265 7370 5b27 4d65 7461 6461   in resp['Metada
+0000adc0: 7461 275d 2e69 7465 6d73 2829 290a 2020  ta'].items()).  
+0000add0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0000ade0: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
+0000adf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000ae00: 6973 696e 7374 616e 6365 2865 7272 6f72  isinstance(error
+0000ae10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ae20: 2020 2020 2020 2020 2020 2020 2853 3355              (S3U
+0000ae30: 6e6b 6e6f 776e 4572 726f 722c 2053 3343  nknownError, S3C
+0000ae40: 6f6e 6669 6745 7272 6f72 2c20 5333 5065  onfigError, S3Pe
+0000ae50: 726d 6973 7369 6f6e 4572 726f 7229 293a  rmissionError)):
+0000ae60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ae70: 2072 6169 7365 2065 7272 6f72 0a20 2020   raise error.   
+0000ae80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000ae90: 7b7d 0a0a 2020 2020 6465 6620 6163 6365  {}..    def acce
+0000aea0: 7373 280a 2020 2020 2020 2020 2020 2020  ss(.            
+0000aeb0: 7365 6c66 2c20 6d6f 6465 3a20 4163 6365  self, mode: Acce
+0000aec0: 7373 203d 2041 6363 6573 732e 5245 4144  ss = Access.READ
+0000aed0: 2c0a 2020 2020 2020 2020 2020 2020 666f  ,.            fo
+0000aee0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000aef0: 3d20 4661 6c73 6529 202d 3e20 626f 6f6c  = False) -> bool
+0000af00: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+0000af10: 2020 2020 2020 5465 7374 2069 6620 7061        Test if pa
+0000af20: 7468 2068 6173 2061 6363 6573 7320 7065  th has access pe
+0000af30: 726d 6973 7369 6f6e 2064 6573 6372 6962  rmission describ
+0000af40: 6564 2062 7920 6d6f 6465 0a20 2020 2020  ed by mode.     
+0000af50: 2020 2055 7369 6e67 2068 6561 645f 6275     Using head_bu
+0000af60: 636b 6574 2829 2c20 6e6f 7720 5245 4144  cket(), now READ
+0000af70: 2f57 5249 5445 2061 7265 2073 616d 652e  /WRITE are same.
+0000af80: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000af90: 206d 6f64 653a 2061 6363 6573 7320 6d6f   mode: access mo
+0000afa0: 6465 0a20 2020 2020 2020 203a 7265 7475  de.        :retu
+0000afb0: 726e 733a 2062 6f6f 6c2c 2069 6620 7468  rns: bool, if th
+0000afc0: 6520 6275 636b 6574 206f 6620 7333 5f75  e bucket of s3_u
+0000afd0: 726c 2068 6173 2072 6561 642f 7772 6974  rl has read/writ
+0000afe0: 6520 6163 6365 7373 2e0a 2020 2020 2020  e access..      
+0000aff0: 2020 2727 270a 2020 2020 2020 2020 7333    '''.        s3
+0000b000: 5f75 726c 203d 2073 656c 662e 7061 7468  _url = self.path
+0000b010: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a20  _with_protocol. 
+0000b020: 2020 2020 2020 2069 6620 666f 6c6c 6f77         if follow
+0000b030: 6c69 6e6b 733a 0a20 2020 2020 2020 2020  links:.         
+0000b040: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000b050: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
+0000b060: 2073 656c 662e 7265 6164 6c69 6e6b 2829   self.readlink()
+0000b070: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000b080: 636f 6c0a 2020 2020 2020 2020 2020 2020  col.            
+0000b090: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
+0000b0a0: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
+0000b0b0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+0000b0c0: 2020 2020 2062 7563 6b65 742c 205f 203d       bucket, _ =
+0000b0d0: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
+0000b0e0: 5f75 726c 2920 2023 206f 6e6c 7920 6368  _url)  # only ch
+0000b0f0: 6563 6b20 6275 636b 6574 2061 6363 6573  eck bucket acces
+0000b100: 7369 6269 6c69 7479 0a20 2020 2020 2020  sibility.       
+0000b110: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
+0000b120: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000b130: 6520 4578 6365 7074 696f 6e28 224e 6f20  e Exception("No 
+0000b140: 6176 6169 6c61 626c 6520 6275 636b 6574  available bucket
+0000b150: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
+0000b160: 7420 6973 696e 7374 616e 6365 286d 6f64  t isinstance(mod
+0000b170: 652c 2041 6363 6573 7329 3a0a 2020 2020  e, Access):.    
+0000b180: 2020 2020 2020 2020 7261 6973 6520 5479          raise Ty
+0000b190: 7065 4572 726f 7228 0a20 2020 2020 2020  peError(.       
+0000b1a0: 2020 2020 2020 2020 2027 556e 7375 7070           'Unsupp
+0000b1b0: 6f72 7465 6420 6d6f 6465 3a20 7b7d 202d  orted mode: {} -
+0000b1c0: 2d20 4d6f 6465 2073 686f 756c 6420 7573  - Mode should us
+0000b1d0: 6520 6f6e 6520 6f66 2074 6865 2065 6e75  e one of the enu
+0000b1e0: 6d73 2062 656c 6f6e 6769 6e67 2074 6f3a  ms belonging to:
+0000b1f0: 2020 7b7d 270a 2020 2020 2020 2020 2020    {}'.          
+0000b200: 2020 2020 2020 2e66 6f72 6d61 7428 6d6f        .format(mo
+0000b210: 6465 2c20 272c 2027 2e6a 6f69 6e28 5b73  de, ', '.join([s
+0000b220: 7472 2861 2920 666f 7220 6120 696e 2041  tr(a) for a in A
+0000b230: 6363 6573 735d 2929 290a 2020 2020 2020  ccess]))).      
+0000b240: 2020 6966 206d 6f64 6520 6e6f 7420 696e    if mode not in
+0000b250: 2028 4163 6365 7373 2e52 4541 442c 2041   (Access.READ, A
+0000b260: 6363 6573 732e 5752 4954 4529 3a0a 2020  ccess.WRITE):.  
+0000b270: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000b280: 5479 7065 4572 726f 7228 2755 6e73 7570  TypeError('Unsup
+0000b290: 706f 7274 6564 206d 6f64 653a 207b 7d27  ported mode: {}'
+0000b2a0: 2e66 6f72 6d61 7428 6d6f 6465 2929 0a20  .format(mode)). 
+0000b2b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000b2c0: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+0000b2d0: 6965 6e74 2e68 6561 645f 6275 636b 6574  ient.head_bucket
+0000b2e0: 2842 7563 6b65 743d 6275 636b 6574 290a  (Bucket=bucket).
+0000b2f0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000b300: 7863 6570 7469 6f6e 2061 7320 6572 726f  xception as erro
+0000b310: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
+0000b320: 7272 6f72 203d 2074 7261 6e73 6c61 7465  rror = translate
+0000b330: 5f73 335f 6572 726f 7228 6572 726f 722c  _s3_error(error,
+0000b340: 2073 335f 7572 6c29 0a20 2020 2020 2020   s3_url).       
+0000b350: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000b360: 6365 2865 7272 6f72 2c20 2853 3350 6572  ce(error, (S3Per
+0000b370: 6d69 7373 696f 6e45 7272 6f72 2c20 5333  missionError, S3
+0000b380: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000b390: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3b0: 2020 2020 2053 3342 7563 6b65 744e 6f74       S3BucketNot
+0000b3c0: 466f 756e 6445 7272 6f72 2929 3a0a 2020  FoundError)):.  
+0000b3d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000b3e0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
+0000b3f0: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
+0000b400: 6f72 0a20 2020 2020 2020 2072 6574 7572  or.        retur
+0000b410: 6e20 5472 7565 0a0a 2020 2020 6465 6620  n True..    def 
+0000b420: 6578 6973 7473 2873 656c 662c 2066 6f6c  exists(self, fol
+0000b430: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+0000b440: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
+0000b450: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000b460: 2020 2020 2054 6573 7420 6966 2073 335f       Test if s3_
+0000b470: 7572 6c20 6578 6973 7473 0a0a 2020 2020  url exists..    
+0000b480: 2020 2020 4966 2074 6865 2062 7563 6b65      If the bucke
+0000b490: 7420 6f66 2073 335f 7572 6c20 6172 6520  t of s3_url are 
+0000b4a0: 6e6f 7420 7065 726d 6974 7465 6420 746f  not permitted to
+0000b4b0: 2072 6561 642c 2072 6574 7572 6e20 4661   read, return Fa
+0000b4c0: 6c73 650a 0a20 2020 2020 2020 203a 7265  lse..        :re
+0000b4d0: 7475 726e 733a 2054 7275 6520 6966 2073  turns: True if s
+0000b4e0: 335f 7572 6c20 6569 7873 7473 2c20 656c  3_url eixsts, el
+0000b4f0: 7365 2046 616c 7365 0a20 2020 2020 2020  se False.       
+0000b500: 2027 2727 0a20 2020 2020 2020 2062 7563   '''.        buc
+0000b510: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+0000b520: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
+0000b530: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+0000b540: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000b550: 6275 636b 6574 3a20 2023 2073 333a 2f2f  bucket:  # s3://
+0000b560: 203d 3e20 5472 7565 2c20 7333 3a2f 2f2f   => True, s3:///
+0000b570: 6b65 7920 3d3e 2046 616c 7365 0a20 2020  key => False.   
+0000b580: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000b590: 6e6f 7420 6b65 790a 0a20 2020 2020 2020  not key..       
+0000b5a0: 2072 6574 7572 6e20 7365 6c66 2e69 735f   return self.is_
+0000b5b0: 6469 7228 2920 6f72 2073 656c 662e 6973  dir() or self.is
+0000b5c0: 5f66 696c 6528 666f 6c6c 6f77 6c69 6e6b  _file(followlink
+0000b5d0: 7329 0a0a 2020 2020 6465 6620 6765 746d  s)..    def getm
+0000b5e0: 7469 6d65 2873 656c 662c 2066 6f6c 6c6f  time(self, follo
+0000b5f0: 775f 7379 6d6c 696e 6b73 3a20 626f 6f6c  w_symlinks: bool
+0000b600: 203d 2046 616c 7365 2920 2d3e 2066 6c6f   = False) -> flo
+0000b610: 6174 3a0a 2020 2020 2020 2020 2727 270a  at:.        '''.
+0000b620: 2020 2020 2020 2020 4765 7420 6c61 7374          Get last
+0000b630: 2d6d 6f64 6966 6965 6420 7469 6d65 206f  -modified time o
+0000b640: 6620 7468 6520 6669 6c65 206f 6e20 7468  f the file on th
+0000b650: 6520 6769 7665 6e20 7333 5f75 726c 2070  e given s3_url p
+0000b660: 6174 6820 2869 6e20 556e 6978 2074 696d  ath (in Unix tim
+0000b670: 6573 7461 6d70 2066 6f72 6d61 7429 2e0a  estamp format)..
+0000b680: 2020 2020 2020 2020 4966 2074 6865 2070          If the p
+0000b690: 6174 6820 6973 2061 6e20 6578 6973 7465  ath is an existe
+0000b6a0: 6e74 2064 6972 6563 746f 7279 2c20 7265  nt directory, re
+0000b6b0: 7475 726e 2074 6865 206c 6174 6573 7420  turn the latest 
+0000b6c0: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
+0000b6d0: 2061 6c6c 2066 696c 6520 696e 2069 742e   all file in it.
+0000b6e0: 2054 6865 206d 7469 6d65 206f 6620 656d   The mtime of em
+0000b6f0: 7074 7920 6469 7265 6374 6f72 7920 6973  pty directory is
+0000b700: 2031 3937 302d 3031 2d30 3120 3030 3a30   1970-01-01 00:0
+0000b710: 303a 3030 0a0a 2020 2020 2020 2020 4966  0:00..        If
+0000b720: 2073 335f 7572 6c20 6973 206e 6f74 2061   s3_url is not a
+0000b730: 6e20 6578 6973 7465 6e74 2070 6174 682c  n existent path,
+0000b740: 2077 6869 6368 206d 6561 6e73 2073 335f   which means s3_
+0000b750: 6578 6973 7428 7333 5f75 726c 2920 7265  exist(s3_url) re
+0000b760: 7475 726e 7320 4661 6c73 652c 2074 6865  turns False, the
+0000b770: 6e20 7261 6973 6520 5333 4669 6c65 4e6f  n raise S3FileNo
+0000b780: 7446 6f75 6e64 4572 726f 720a 0a20 2020  tFoundError..   
+0000b790: 2020 2020 203a 7265 7475 726e 733a 204c       :returns: L
+0000b7a0: 6173 742d 6d6f 6469 6669 6564 2074 696d  ast-modified tim
+0000b7b0: 650a 2020 2020 2020 2020 3a72 6169 7365  e.        :raise
+0000b7c0: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
+0000b7d0: 6445 7272 6f72 2c20 556e 7375 7070 6f72  dError, Unsuppor
+0000b7e0: 7465 6445 7272 6f72 0a20 2020 2020 2020  tedError.       
+0000b7f0: 2027 2727 0a20 2020 2020 2020 2072 6574   '''.        ret
+0000b800: 7572 6e20 7365 6c66 2e73 7461 7428 666f  urn self.stat(fo
+0000b810: 6c6c 6f77 5f73 796d 6c69 6e6b 733d 666f  llow_symlinks=fo
+0000b820: 6c6c 6f77 5f73 796d 6c69 6e6b 7329 2e6d  llow_symlinks).m
+0000b830: 7469 6d65 0a0a 2020 2020 6465 6620 6765  time..    def ge
+0000b840: 7473 697a 6528 7365 6c66 2c20 666f 6c6c  tsize(self, foll
+0000b850: 6f77 5f73 796d 6c69 6e6b 733a 2062 6f6f  ow_symlinks: boo
+0000b860: 6c20 3d20 4661 6c73 6529 202d 3e20 696e  l = False) -> in
+0000b870: 743a 0a20 2020 2020 2020 2027 2727 0a20  t:.        '''. 
+0000b880: 2020 2020 2020 2047 6574 2066 696c 6520         Get file 
+0000b890: 7369 7a65 206f 6e20 7468 6520 6769 7665  size on the give
+0000b8a0: 6e20 7333 5f75 726c 2070 6174 6820 2869  n s3_url path (i
+0000b8b0: 6e20 6279 7465 7329 2e0a 2020 2020 2020  n bytes)..      
+0000b8c0: 2020 4966 2074 6865 2070 6174 6820 696e    If the path in
+0000b8d0: 2061 2064 6972 6563 746f 7279 2c20 7265   a directory, re
+0000b8e0: 7475 726e 2074 6865 2073 756d 206f 6620  turn the sum of 
+0000b8f0: 616c 6c20 6669 6c65 2073 697a 6520 696e  all file size in
+0000b900: 2069 742c 2069 6e63 6c75 6469 6e67 2066   it, including f
+0000b910: 696c 6520 696e 2073 7562 6469 7265 6374  ile in subdirect
+0000b920: 6f72 6965 7320 2869 6620 6578 6973 7429  ories (if exist)
+0000b930: 2e0a 2020 2020 2020 2020 5468 6520 7265  ..        The re
+0000b940: 7375 6c74 2065 7863 6c75 6465 7320 7468  sult excludes th
+0000b950: 6520 7369 7a65 206f 6620 6469 7265 6374  e size of direct
+0000b960: 6f72 7920 6974 7365 6c66 2e20 496e 206f  ory itself. In o
+0000b970: 7468 6572 2077 6f72 6473 2c20 7265 7475  ther words, retu
+0000b980: 726e 2030 2042 7974 6520 6f6e 2061 6e20  rn 0 Byte on an 
+0000b990: 656d 7074 7920 6469 7265 6374 6f72 7920  empty directory 
+0000b9a0: 7061 7468 2e0a 0a20 2020 2020 2020 2049  path...        I
+0000b9b0: 6620 7333 5f75 726c 2069 7320 6e6f 7420  f s3_url is not 
+0000b9c0: 616e 2065 7869 7374 656e 7420 7061 7468  an existent path
+0000b9d0: 2c20 7768 6963 6820 6d65 616e 7320 7333  , which means s3
+0000b9e0: 5f65 7869 7374 2873 335f 7572 6c29 2072  _exist(s3_url) r
+0000b9f0: 6574 7572 6e73 2046 616c 7365 2c20 7468  eturns False, th
+0000ba00: 656e 2072 6169 7365 2053 3346 696c 654e  en raise S3FileN
+0000ba10: 6f74 466f 756e 6445 7272 6f72 0a0a 2020  otFoundError..  
+0000ba20: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+0000ba30: 4669 6c65 2073 697a 650a 2020 2020 2020  File size.      
+0000ba40: 2020 3a72 6169 7365 733a 2053 3346 696c    :raises: S3Fil
+0000ba50: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
+0000ba60: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+0000ba70: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000ba80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000ba90: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
+0000baa0: 6c69 6e6b 733d 666f 6c6c 6f77 5f73 796d  links=follow_sym
+0000bab0: 6c69 6e6b 7329 2e73 697a 650a 0a20 2020  links).size..   
+0000bac0: 2064 6566 2067 6c6f 6228 0a20 2020 2020   def glob(.     
+0000bad0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000bae0: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
+0000baf0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+0000bb00: 6375 7273 6976 653a 2062 6f6f 6c20 3d20  cursive: bool = 
+0000bb10: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000bb20: 2020 6d69 7373 696e 675f 6f6b 3a20 626f    missing_ok: bo
+0000bb30: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+0000bb40: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+0000bb50: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+0000bb60: 2c0a 2020 2020 2920 2d3e 204c 6973 745b  ,.    ) -> List[
+0000bb70: 2753 3350 6174 6827 5d3a 0a20 2020 2020  'S3Path']:.     
+0000bb80: 2020 2027 2727 5265 7475 726e 2073 3320     '''Return s3 
+0000bb90: 7061 7468 206c 6973 7420 696e 2061 7363  path list in asc
+0000bba0: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
+0000bbb0: 6361 6c20 6f72 6465 722c 2069 6e20 7768  cal order, in wh
+0000bbc0: 6963 6820 7061 7468 206d 6174 6368 6573  ich path matches
+0000bbd0: 2067 6c6f 6220 7061 7474 6572 6e0a 2020   glob pattern.  
+0000bbe0: 2020 2020 2020 4e6f 7465 733a 204f 6e6c        Notes: Onl
+0000bbf0: 7920 676c 6f62 2069 6e20 6275 636b 6574  y glob in bucket
+0000bc00: 2e20 4966 2074 7279 696e 6720 746f 206d  . If trying to m
+0000bc10: 6174 6368 2062 7563 6b65 7420 7769 7468  atch bucket with
+0000bc20: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
+0000bc30: 7465 7273 2c20 7261 6973 6520 556e 7375  ters, raise Unsu
+0000bc40: 7070 6f72 7465 6445 7272 6f72 0a0a 2020  pportedError..  
+0000bc50: 2020 2020 2020 3a70 6172 616d 2070 6174        :param pat
+0000bc60: 7465 726e 3a20 476c 6f62 2074 6865 2067  tern: Glob the g
+0000bc70: 6976 656e 2072 656c 6174 6976 6520 7061  iven relative pa
+0000bc80: 7474 6572 6e20 696e 2074 6865 2064 6972  ttern in the dir
+0000bc90: 6563 746f 7279 2072 6570 7265 7365 6e74  ectory represent
+0000bca0: 6564 2062 7920 7468 6973 2070 6174 680a  ed by this path.
+0000bcb0: 2020 2020 2020 2020 3a70 6172 616d 2072          :param r
+0000bcc0: 6563 7572 7369 7665 3a20 4966 2046 616c  ecursive: If Fal
+0000bcd0: 7365 2c20 602a 2a60 2077 696c 6c20 6e6f  se, `**` will no
+0000bce0: 7420 7365 6172 6368 2064 6972 6563 746f  t search directo
+0000bcf0: 7279 2072 6563 7572 7369 7665 6c79 0a20  ry recursively. 
+0000bd00: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
+0000bd10: 7373 696e 675f 6f6b 3a20 4966 2046 616c  ssing_ok: If Fal
+0000bd20: 7365 2061 6e64 2074 6172 6765 7420 7061  se and target pa
+0000bd30: 7468 2064 6f65 736e 2774 206d 6174 6368  th doesn't match
+0000bd40: 2061 6e79 2066 696c 652c 2072 6169 7365   any file, raise
+0000bd50: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
+0000bd60: 6f72 0a20 2020 2020 2020 203a 7261 6973  or.        :rais
+0000bd70: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
+0000bd80: 7272 6f72 2c20 7768 656e 2062 7563 6b65  rror, when bucke
+0000bd90: 7420 7061 7274 2063 6f6e 7461 696e 7320  t part contains 
+0000bda0: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
+0000bdb0: 6572 730a 2020 2020 2020 2020 3a72 6574  ers.        :ret
+0000bdc0: 7572 6e73 3a20 4120 6c69 7374 2063 6f6e  urns: A list con
+0000bdd0: 7461 696e 7320 7061 7468 7320 6d61 7463  tains paths matc
+0000bde0: 6820 6073 335f 7061 7468 6e61 6d65 600a  h `s3_pathname`.
+0000bdf0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000be00: 2020 2020 7265 7475 726e 206c 6973 7428      return list(
+0000be10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000be20: 662e 6967 6c6f 6228 0a20 2020 2020 2020  f.iglob(.       
+0000be30: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
+0000be40: 3d70 6174 7465 726e 2c0a 2020 2020 2020  =pattern,.      
+0000be50: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
+0000be60: 6976 653d 7265 6375 7273 6976 652c 0a20  ive=recursive,. 
+0000be70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000be80: 6973 7369 6e67 5f6f 6b3d 6d69 7373 696e  issing_ok=missin
+0000be90: 675f 6f6b 2c0a 2020 2020 2020 2020 2020  g_ok,.          
+0000bea0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+0000beb0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 290a  s=followlinks)).
+0000bec0: 0a20 2020 2064 6566 2067 6c6f 625f 7374  .    def glob_st
+0000bed0: 6174 280a 2020 2020 2020 2020 2020 2020  at(.            
+0000bee0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+0000bef0: 2020 7061 7474 6572 6e2c 0a20 2020 2020    pattern,.     
+0000bf00: 2020 2020 2020 2072 6563 7572 7369 7665         recursive
+0000bf10: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+0000bf20: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0000bf30: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
+0000bf40: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+0000bf50: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+0000bf60: 6c20 3d20 4661 6c73 6529 202d 3e20 4974  l = False) -> It
+0000bf70: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
+0000bf80: 5d3a 0a20 2020 2020 2020 2027 2727 5265  ]:.        '''Re
+0000bf90: 7475 726e 2061 2067 656e 6572 6174 6f72  turn a generator
+0000bfa0: 2063 6f6e 7461 696e 7320 7475 706c 6573   contains tuples
+0000bfb0: 206f 6620 7061 7468 2061 6e64 2066 696c   of path and fil
+0000bfc0: 6520 7374 6174 2c20 696e 2061 7363 656e  e stat, in ascen
+0000bfd0: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
+0000bfe0: 6c20 6f72 6465 722c 2069 6e20 7768 6963  l order, in whic
+0000bff0: 6820 7061 7468 206d 6174 6368 6573 2067  h path matches g
+0000c000: 6c6f 6220 7061 7474 6572 6e0a 2020 2020  lob pattern.    
+0000c010: 2020 2020 4e6f 7465 733a 204f 6e6c 7920      Notes: Only 
+0000c020: 676c 6f62 2069 6e20 6275 636b 6574 2e20  glob in bucket. 
+0000c030: 4966 2074 7279 696e 6720 746f 206d 6174  If trying to mat
+0000c040: 6368 2062 7563 6b65 7420 7769 7468 2077  ch bucket with w
+0000c050: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+0000c060: 7273 2c20 7261 6973 6520 556e 7375 7070  rs, raise Unsupp
+0000c070: 6f72 7465 6445 7272 6f72 0a0a 2020 2020  ortedError..    
+0000c080: 2020 2020 3a70 6172 616d 2070 6174 7465      :param patte
+0000c090: 726e 3a20 476c 6f62 2074 6865 2067 6976  rn: Glob the giv
+0000c0a0: 656e 2072 656c 6174 6976 6520 7061 7474  en relative patt
+0000c0b0: 6572 6e20 696e 2074 6865 2064 6972 6563  ern in the direc
+0000c0c0: 746f 7279 2072 6570 7265 7365 6e74 6564  tory represented
+0000c0d0: 2062 7920 7468 6973 2070 6174 680a 2020   by this path.  
+0000c0e0: 2020 2020 2020 3a70 6172 616d 2072 6563        :param rec
+0000c0f0: 7572 7369 7665 3a20 4966 2046 616c 7365  ursive: If False
+0000c100: 2c20 602a 2a60 2077 696c 6c20 6e6f 7420  , `**` will not 
+0000c110: 7365 6172 6368 2064 6972 6563 746f 7279  search directory
+0000c120: 2072 6563 7572 7369 7665 6c79 0a20 2020   recursively.   
+0000c130: 2020 2020 203a 7061 7261 6d20 6d69 7373       :param miss
+0000c140: 696e 675f 6f6b 3a20 4966 2046 616c 7365  ing_ok: If False
+0000c150: 2061 6e64 2074 6172 6765 7420 7061 7468   and target path
+0000c160: 2064 6f65 736e 2774 206d 6174 6368 2061   doesn't match a
+0000c170: 6e79 2066 696c 652c 2072 6169 7365 2046  ny file, raise F
+0000c180: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000c190: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+0000c1a0: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
+0000c1b0: 6f72 2c20 7768 656e 2062 7563 6b65 7420  or, when bucket 
+0000c1c0: 7061 7274 2063 6f6e 7461 696e 7320 7769  part contains wi
+0000c1d0: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+0000c1e0: 730a 2020 2020 2020 2020 3a72 6574 7572  s.        :retur
+0000c1f0: 6e73 3a20 4120 6765 6e65 7261 746f 7220  ns: A generator 
+0000c200: 636f 6e74 6169 6e73 2074 7570 6c65 7320  contains tuples 
+0000c210: 6f66 2070 6174 6820 616e 6420 6669 6c65  of path and file
+0000c220: 2073 7461 742c 2069 6e20 7768 6963 6820   stat, in which 
+0000c230: 7061 7468 7320 6d61 7463 6820 6073 335f  paths match `s3_
+0000c240: 7061 7468 6e61 6d65 600a 2020 2020 2020  pathname`.      
+0000c250: 2020 2727 270a 2020 2020 2020 2020 676c    '''.        gl
+0000c260: 6f62 5f70 6174 6820 3d20 7365 6c66 2e5f  ob_path = self._
+0000c270: 7333 5f70 6174 680a 2020 2020 2020 2020  s3_path.        
+0000c280: 6966 2070 6174 7465 726e 3a0a 2020 2020  if pattern:.    
+0000c290: 2020 2020 2020 2020 676c 6f62 5f70 6174          glob_pat
+0000c2a0: 6820 3d20 7365 6c66 2e6a 6f69 6e70 6174  h = self.joinpat
+0000c2b0: 6828 7061 7474 6572 6e29 2e5f 7333 5f70  h(pattern)._s3_p
+0000c2c0: 6174 6820 2023 2070 7974 7970 653a 2064  ath  # pytype: d
+0000c2d0: 6973 6162 6c65 3d61 7474 7269 6275 7465  isable=attribute
+0000c2e0: 2d65 7272 6f72 0a20 2020 2020 2020 2073  -error.        s
+0000c2f0: 335f 7061 7468 6e61 6d65 203d 2066 7370  3_pathname = fsp
+0000c300: 6174 6828 676c 6f62 5f70 6174 6829 0a0a  ath(glob_path)..
+0000c310: 2020 2020 2020 2020 6465 6620 6372 6561          def crea
+0000c320: 7465 5f67 656e 6572 6174 6f72 2829 3a0a  te_generator():.
+0000c330: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000c340: 6772 6f75 705f 7333 5f70 6174 686e 616d  group_s3_pathnam
+0000c350: 655f 3120 696e 205f 6772 6f75 705f 7333  e_1 in _group_s3
+0000c360: 7061 7468 5f62 795f 6275 636b 6574 280a  path_by_bucket(.
 0000c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c380: 2020 2020 2020 2020 2020 2020 7061 7468              path
-0000c390: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-0000c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3b0: 2020 6622 7b73 656c 662e 5f70 726f 746f    f"{self._proto
-0000c3c0: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
-0000c3d0: 7d3a 2f2f 7b66 696c 655f 656e 7472 792e  }://{file_entry.
-0000c3e0: 7061 7468 5b35 3a5d 7d22 0a20 2020 2020  path[5:]}".     
+0000c380: 2020 2020 7333 5f70 6174 686e 616d 652c      s3_pathname,
+0000c390: 2073 656c 662e 5f70 726f 6669 6c65 5f6e   self._profile_n
+0000c3a0: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
+0000c3b0: 2020 2020 2020 666f 7220 6772 6f75 705f        for group_
+0000c3c0: 7333 5f70 6174 686e 616d 655f 3220 696e  s3_pathname_2 in
+0000c3d0: 205f 6772 6f75 705f 7333 7061 7468 5f62   _group_s3path_b
+0000c3e0: 795f 7072 6566 6978 280a 2020 2020 2020  y_prefix(.      
 0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c400: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c420: 2079 6965 6c64 2066 696c 655f 656e 7472   yield file_entr
-0000c430: 790a 0a20 2020 2020 2020 2072 6574 7572  y..        retur
-0000c440: 6e20 5f63 7265 6174 655f 6d69 7373 696e  n _create_missin
-0000c450: 675f 6f6b 5f67 656e 6572 6174 6f72 280a  g_ok_generator(.
-0000c460: 2020 2020 2020 2020 2020 2020 6372 6561              crea
-0000c470: 7465 5f67 656e 6572 6174 6f72 2829 2c20  te_generator(), 
-0000c480: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
-0000c490: 2020 2020 2020 2020 5333 4669 6c65 4e6f          S3FileNo
-0000c4a0: 7446 6f75 6e64 4572 726f 7228 274e 6f20  tFoundError('No 
-0000c4b0: 6d61 7463 6820 6669 6c65 3a20 2572 2720  match file: %r' 
-0000c4c0: 2520 7333 5f70 6174 686e 616d 6529 290a  % s3_pathname)).
-0000c4d0: 0a20 2020 2064 6566 2069 676c 6f62 280a  .    def iglob(.
-0000c4e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000c4f0: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
-0000c500: 7474 6572 6e2c 0a20 2020 2020 2020 2020  ttern,.         
-0000c510: 2020 2072 6563 7572 7369 7665 3a20 626f     recursive: bo
-0000c520: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-0000c530: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
-0000c540: 6b3a 2062 6f6f 6c20 3d20 5472 7565 2c0a  k: bool = True,.
-0000c550: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
-0000c560: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000c570: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
-0000c580: 4974 6572 6174 6f72 5b27 5333 5061 7468  Iterator['S3Path
-0000c590: 275d 3a0a 2020 2020 2020 2020 2727 2752  ']:.        '''R
-0000c5a0: 6574 7572 6e20 7333 2070 6174 6820 6974  eturn s3 path it
-0000c5b0: 6572 6174 6f72 2069 6e20 6173 6365 6e64  erator in ascend
-0000c5c0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
-0000c5d0: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
-0000c5e0: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
-0000c5f0: 6f62 2070 6174 7465 726e 0a20 2020 2020  ob pattern.     
-0000c600: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
-0000c610: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
-0000c620: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
-0000c630: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
-0000c640: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
-0000c650: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
-0000c660: 7274 6564 4572 726f 720a 0a20 2020 2020  rtedError..     
-0000c670: 2020 203a 7061 7261 6d20 7061 7474 6572     :param patter
-0000c680: 6e3a 2047 6c6f 6220 7468 6520 6769 7665  n: Glob the give
-0000c690: 6e20 7265 6c61 7469 7665 2070 6174 7465  n relative patte
-0000c6a0: 726e 2069 6e20 7468 6520 6469 7265 6374  rn in the direct
-0000c6b0: 6f72 7920 7265 7072 6573 656e 7465 6420  ory represented 
-0000c6c0: 6279 2074 6869 7320 7061 7468 0a20 2020  by this path.   
-0000c6d0: 2020 2020 203a 7061 7261 6d20 7265 6375       :param recu
-0000c6e0: 7273 6976 653a 2049 6620 4661 6c73 652c  rsive: If False,
-0000c6f0: 2060 2a2a 6020 7769 6c6c 206e 6f74 2073   `**` will not s
-0000c700: 6561 7263 6820 6469 7265 6374 6f72 7920  earch directory 
-0000c710: 7265 6375 7273 6976 656c 790a 2020 2020  recursively.    
-0000c720: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
-0000c730: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
-0000c740: 616e 6420 7461 7267 6574 2070 6174 6820  and target path 
-0000c750: 646f 6573 6e27 7420 6d61 7463 6820 616e  doesn't match an
-0000c760: 7920 6669 6c65 2c20 7261 6973 6520 4669  y file, raise Fi
-0000c770: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
-0000c780: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
-0000c790: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
-0000c7a0: 722c 2077 6865 6e20 6275 636b 6574 2070  r, when bucket p
-0000c7b0: 6172 7420 636f 6e74 6169 6e73 2077 696c  art contains wil
-0000c7c0: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
-0000c7d0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000c7e0: 733a 2041 6e20 6974 6572 6174 6f72 2063  s: An iterator c
-0000c7f0: 6f6e 7461 696e 7320 7061 7468 7320 6d61  ontains paths ma
-0000c800: 7463 6820 6073 335f 7061 7468 6e61 6d65  tch `s3_pathname
-0000c810: 600a 2020 2020 2020 2020 2727 270a 2020  `.        '''.  
-0000c820: 2020 2020 2020 666f 7220 6669 6c65 5f65        for file_e
-0000c830: 6e74 7279 2069 6e20 7365 6c66 2e67 6c6f  ntry in self.glo
-0000c840: 625f 7374 6174 2870 6174 7465 726e 3d70  b_stat(pattern=p
-0000c850: 6174 7465 726e 2c20 7265 6375 7273 6976  attern, recursiv
-0000c860: 653d 7265 6375 7273 6976 652c 0a20 2020  e=recursive,.   
-0000c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c890: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
-0000c8a0: 3d6d 6973 7369 6e67 5f6f 6b2c 0a20 2020  =missing_ok,.   
-0000c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8d0: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-0000c8e0: 733d 666f 6c6c 6f77 6c69 6e6b 7329 3a0a  s=followlinks):.
-0000c8f0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-0000c900: 6420 7365 6c66 2e66 726f 6d5f 7061 7468  d self.from_path
-0000c910: 2866 696c 655f 656e 7472 792e 7061 7468  (file_entry.path
-0000c920: 290a 0a20 2020 2064 6566 2069 735f 6469  )..    def is_di
-0000c930: 7228 7365 6c66 2c20 666f 6c6c 6f77 6c69  r(self, followli
-0000c940: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-0000c950: 6529 202d 3e20 626f 6f6c 3a0a 2020 2020  e) -> bool:.    
-0000c960: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000c970: 5465 7374 2069 6620 616e 2073 3320 7572  Test if an s3 ur
-0000c980: 6c20 6973 2064 6972 6563 746f 7279 0a20  l is directory. 
-0000c990: 2020 2020 2020 2053 7065 6369 6669 6320         Specific 
-0000c9a0: 7072 6f63 6564 7572 6573 2061 7265 2061  procedures are a
-0000c9b0: 7320 666f 6c6c 6f77 733a 0a20 2020 2020  s follows:.     
-0000c9c0: 2020 2049 6620 7468 6572 6520 6578 6973     If there exis
-0000c9d0: 7473 2061 2073 7566 6669 782c 206f 6620  ts a suffix, of 
-0000c9e0: 7768 6963 6820 6060 6f73 2e70 6174 682e  which ``os.path.
-0000c9f0: 6a6f 696e 2873 335f 7572 6c2c 2073 7566  join(s3_url, suf
-0000ca00: 6669 7829 6060 2069 7320 6120 6669 6c65  fix)`` is a file
-0000ca10: 0a20 2020 2020 2020 2049 6620 7468 6520  .        If the 
-0000ca20: 7572 6c20 6973 2065 6d70 7479 2062 7563  url is empty buc
-0000ca30: 6b65 7420 6f72 2073 333a 2f2f 0a0a 2020  ket or s3://..  
-0000ca40: 2020 2020 2020 3a70 6172 616d 2066 6f6c        :param fol
-0000ca50: 6c6f 776c 696e 6b73 3a20 7768 6574 6865  lowlinks: whethe
-0000ca60: 7220 666f 6c6c 6f77 6c69 6e6b 7320 6973  r followlinks is
-0000ca70: 2054 7275 6520 6f72 2046 616c 7365 2c20   True or False, 
-0000ca80: 7265 7375 6c74 2069 7320 7468 6520 7361  result is the sa
-0000ca90: 6d65 2e20 4265 6361 7573 6520 7333 2073  me. Because s3 s
-0000caa0: 796d 6c69 6e6b 206e 6f74 2073 7570 706f  ymlink not suppo
-0000cab0: 7274 2064 6972 2e0a 2020 2020 2020 2020  rt dir..        
-0000cac0: 3a72 6574 7572 6e73 3a20 5472 7565 2069  :returns: True i
-0000cad0: 6620 7061 7468 2069 7320 7333 2064 6972  f path is s3 dir
-0000cae0: 6563 746f 7279 2c20 656c 7365 2046 616c  ectory, else Fal
-0000caf0: 7365 0a20 2020 2020 2020 2027 2727 0a20  se.        '''. 
-0000cb00: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-0000cb10: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-0000cb20: 6c28 7365 6c66 2e70 6174 685f 7769 7468  l(self.path_with
-0000cb30: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-0000cb40: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
-0000cb50: 3a20 2023 2073 333a 2f2f 203d 3e20 5472  :  # s3:// => Tr
-0000cb60: 7565 2c20 7333 3a2f 2f2f 6b65 7920 3d3e  ue, s3:///key =>
-0000cb70: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000cb80: 2020 2072 6574 7572 6e20 6e6f 7420 6b65     return not ke
-0000cb90: 790a 2020 2020 2020 2020 7072 6566 6978  y.        prefix
-0000cba0: 203d 205f 6265 636f 6d65 5f70 7265 6669   = _become_prefi
-0000cbb0: 7828 6b65 7929 0a20 2020 2020 2020 2074  x(key).        t
-0000cbc0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000cbd0: 7265 7370 203d 2073 656c 662e 5f63 6c69  resp = self._cli
-0000cbe0: 656e 742e 6c69 7374 5f6f 626a 6563 7473  ent.list_objects
-0000cbf0: 5f76 3228 0a20 2020 2020 2020 2020 2020  _v2(.           
-0000cc00: 2020 2020 2042 7563 6b65 743d 6275 636b       Bucket=buck
-0000cc10: 6574 2c20 5072 6566 6978 3d70 7265 6669  et, Prefix=prefi
-0000cc20: 782c 2044 656c 696d 6974 6572 3d27 2f27  x, Delimiter='/'
-0000cc30: 2c20 4d61 784b 6579 733d 3129 0a20 2020  , MaxKeys=1).   
-0000cc40: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000cc50: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
-0000cc60: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-0000cc70: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
-0000cc80: 5f65 7272 6f72 2865 7272 6f72 2c20 7365  _error(error, se
-0000cc90: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000cca0: 746f 636f 6c29 0a20 2020 2020 2020 2020  tocol).         
-0000ccb0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000ccc0: 2865 7272 6f72 2c0a 2020 2020 2020 2020  (error,.        
-0000ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cce0: 2020 2853 3355 6e6b 6e6f 776e 4572 726f    (S3UnknownErro
-0000ccf0: 722c 2053 3343 6f6e 6669 6745 7272 6f72  r, S3ConfigError
-0000cd00: 2c20 5333 5065 726d 6973 7369 6f6e 4572  , S3PermissionEr
-0000cd10: 726f 7229 293a 0a20 2020 2020 2020 2020  ror)):.         
-0000cd20: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
-0000cd30: 6f72 0a20 2020 2020 2020 2020 2020 2072  or.            r
-0000cd40: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-0000cd50: 2020 2020 2069 6620 6e6f 7420 6b65 793a       if not key:
-0000cd60: 2020 2320 6275 636b 6574 2069 7320 6163    # bucket is ac
-0000cd70: 6365 7373 6962 6c65 0a20 2020 2020 2020  cessible.       
-0000cd80: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0000cd90: 0a0a 2020 2020 2020 2020 6966 2027 4b65  ..        if 'Ke
-0000cda0: 7943 6f75 6e74 2720 696e 2072 6573 703a  yCount' in resp:
-0000cdb0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000cdc0: 7572 6e20 7265 7370 5b27 4b65 7943 6f75  urn resp['KeyCou
-0000cdd0: 6e74 275d 203e 2030 0a0a 2020 2020 2020  nt'] > 0..      
-0000cde0: 2020 7265 7475 726e 206c 656e 2872 6573    return len(res
-0000cdf0: 702e 6765 7428 2743 6f6e 7465 6e74 7327  p.get('Contents'
-0000ce00: 2c20 5b5d 2929 203e 2030 206f 7220 5c0a  , [])) > 0 or \.
-0000ce10: 2020 2020 2020 2020 2020 2020 6c65 6e28              len(
-0000ce20: 7265 7370 2e67 6574 2827 436f 6d6d 6f6e  resp.get('Common
-0000ce30: 5072 6566 6978 6573 272c 205b 5d29 2920  Prefixes', [])) 
-0000ce40: 3e20 300a 0a20 2020 2064 6566 2069 735f  > 0..    def is_
-0000ce50: 6669 6c65 2873 656c 662c 2066 6f6c 6c6f  file(self, follo
-0000ce60: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-0000ce70: 616c 7365 2920 2d3e 2062 6f6f 6c3a 0a20  alse) -> bool:. 
-0000ce80: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000ce90: 2020 2054 6573 7420 6966 2061 6e20 7333     Test if an s3
-0000cea0: 5f75 726c 2069 7320 6669 6c65 0a0a 2020  _url is file..  
-0000ceb0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000cec0: 5472 7565 2069 6620 7061 7468 2069 7320  True if path is 
-0000ced0: 7333 2066 696c 652c 2065 6c73 6520 4661  s3 file, else Fa
-0000cee0: 6c73 650a 2020 2020 2020 2020 2727 270a  lse.        '''.
-0000cef0: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
-0000cf00: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-0000cf10: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
-0000cf20: 2069 6620 666f 6c6c 6f77 6c69 6e6b 733a   if followlinks:
-0000cf30: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-0000cf40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cf50: 2020 7333 5f75 726c 203d 2073 656c 662e    s3_url = self.
-0000cf60: 7265 6164 6c69 6e6b 2829 2e70 6174 685f  readlink().path_
-0000cf70: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
-0000cf80: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0000cf90: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
-0000cfa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cfb0: 2020 7061 7373 0a20 2020 2020 2020 2062    pass.        b
-0000cfc0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-0000cfd0: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
-0000cfe0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0000cff0: 2062 7563 6b65 7420 6f72 206e 6f74 206b   bucket or not k
-0000d000: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
-0000d010: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-0000d020: 2020 2020 2023 2073 333a 2f2f 2c20 7333       # s3://, s3
-0000d030: 3a2f 2f2f 6b65 792c 2073 333a 2f2f 6275  :///key, s3://bu
-0000d040: 636b 6574 2c20 7333 3a2f 2f62 7563 6b65  cket, s3://bucke
-0000d050: 742f 7072 6566 6978 2f0a 2020 2020 2020  t/prefix/.      
-0000d060: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0000d070: 7365 0a20 2020 2020 2020 2074 7279 3a0a  se.        try:.
-0000d080: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000d090: 2e5f 636c 6965 6e74 2e68 6561 645f 6f62  ._client.head_ob
-0000d0a0: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
-0000d0b0: 6574 2c20 4b65 793d 6b65 7929 0a20 2020  et, Key=key).   
-0000d0c0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000d0d0: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
-0000d0e0: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-0000d0f0: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
-0000d100: 5f65 7272 6f72 2865 7272 6f72 2c20 7333  _error(error, s3
-0000d110: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
-0000d120: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000d130: 6572 726f 722c 0a20 2020 2020 2020 2020  error,.         
-0000d140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d150: 2028 5333 556e 6b6e 6f77 6e45 7272 6f72   (S3UnknownError
-0000d160: 2c20 5333 436f 6e66 6967 4572 726f 722c  , S3ConfigError,
-0000d170: 2053 3350 6572 6d69 7373 696f 6e45 7272   S3PermissionErr
-0000d180: 6f72 2929 3a0a 2020 2020 2020 2020 2020  or)):.          
-0000d190: 2020 2020 2020 7261 6973 6520 6572 726f        raise erro
-0000d1a0: 720a 2020 2020 2020 2020 2020 2020 7265  r.            re
-0000d1b0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-0000d1c0: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
-0000d1d0: 2020 2020 6465 6620 6c69 7374 6469 7228      def listdir(
-0000d1e0: 7365 6c66 2c20 666f 6c6c 6f77 6c69 6e6b  self, followlink
-0000d1f0: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
-0000d200: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
-0000d210: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000d220: 2020 2047 6574 2061 6c6c 2063 6f6e 7465     Get all conte
-0000d230: 6e74 7320 6f66 2067 6976 656e 2073 335f  nts of given s3_
-0000d240: 7572 6c2e 2054 6865 2072 6573 756c 7420  url. The result 
-0000d250: 6973 2069 6e20 6163 7365 6e64 696e 6720  is in acsending 
-0000d260: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
-0000d270: 6572 2e0a 0a20 2020 2020 2020 203a 7265  er...        :re
-0000d280: 7475 726e 733a 2041 6c6c 2063 6f6e 7465  turns: All conte
-0000d290: 6e74 7320 6861 7665 2070 7265 6669 7820  nts have prefix 
-0000d2a0: 6f66 2073 335f 7572 6c20 696e 2061 6373  of s3_url in acs
-0000d2b0: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
-0000d2c0: 6361 6c20 6f72 6465 720a 2020 2020 2020  cal order.      
-0000d2d0: 2020 3a72 6169 7365 733a 2053 3346 696c    :raises: S3Fil
-0000d2e0: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
-0000d2f0: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
-0000d300: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
-0000d310: 0a20 2020 2020 2020 2065 6e74 7269 6573  .        entries
-0000d320: 203d 206c 6973 7428 7365 6c66 2e73 6361   = list(self.sca
-0000d330: 6e64 6972 2866 6f6c 6c6f 776c 696e 6b73  ndir(followlinks
-0000d340: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a20  =followlinks)). 
-0000d350: 2020 2020 2020 2072 6574 7572 6e20 736f         return so
-0000d360: 7274 6564 285b 656e 7472 792e 6e61 6d65  rted([entry.name
-0000d370: 2066 6f72 2065 6e74 7279 2069 6e20 656e   for entry in en
-0000d380: 7472 6965 735d 290a 0a20 2020 2064 6566  tries])..    def
-0000d390: 2069 7465 7264 6972 2873 656c 662c 2066   iterdir(self, f
-0000d3a0: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
-0000d3b0: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
-0000d3c0: 7261 746f 725b 2753 3350 6174 6827 5d3a  rator['S3Path']:
-0000d3d0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000d3e0: 2020 2020 2047 6574 2061 6c6c 2063 6f6e       Get all con
-0000d3f0: 7465 6e74 7320 6f66 2067 6976 656e 2073  tents of given s
-0000d400: 335f 7572 6c2e 2054 6865 2072 6573 756c  3_url. The resul
-0000d410: 7420 6973 2069 6e20 6163 7365 6e64 696e  t is in acsendin
-0000d420: 6720 616c 7068 6162 6574 6963 616c 206f  g alphabetical o
-0000d430: 7264 6572 2e0a 0a20 2020 2020 2020 203a  rder...        :
-0000d440: 7265 7475 726e 733a 2041 6c6c 2063 6f6e  returns: All con
-0000d450: 7465 6e74 7320 6861 7665 2070 7265 6669  tents have prefi
-0000d460: 7820 6f66 2073 335f 7572 6c20 696e 2061  x of s3_url in a
-0000d470: 6373 656e 6469 6e67 2061 6c70 6861 6265  csending alphabe
-0000d480: 7469 6361 6c20 6f72 6465 720a 2020 2020  tical order.    
-0000d490: 2020 2020 3a72 6169 7365 733a 2053 3346      :raises: S3F
-0000d4a0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000d4b0: 2c20 5333 4e6f 7441 4469 7265 6374 6f72  , S3NotADirector
-0000d4c0: 7945 7272 6f72 0a20 2020 2020 2020 2027  yError.        '
-0000d4d0: 2727 0a20 2020 2020 2020 2066 6f72 2070  ''.        for p
-0000d4e0: 6174 6820 696e 2073 656c 662e 6c69 7374  ath in self.list
-0000d4f0: 6469 7228 666f 6c6c 6f77 6c69 6e6b 733d  dir(followlinks=
-0000d500: 666f 6c6c 6f77 6c69 6e6b 7329 3a0a 2020  followlinks):.  
-0000d510: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-0000d520: 7365 6c66 2e6a 6f69 6e70 6174 6828 7061  self.joinpath(pa
-0000d530: 7468 2920 2023 2074 7970 653a 2069 676e  th)  # type: ign
-0000d540: 6f72 650a 0a20 2020 2064 6566 206c 6f61  ore..    def loa
-0000d550: 6428 7365 6c66 2c20 666f 6c6c 6f77 6c69  d(self, followli
-0000d560: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-0000d570: 6529 202d 3e20 4269 6e61 7279 494f 3a0a  e) -> BinaryIO:.
-0000d580: 2020 2020 2020 2020 2727 2752 6561 6420          '''Read 
-0000d590: 616c 6c20 636f 6e74 656e 7420 696e 2062  all content in b
-0000d5a0: 696e 6172 7920 6f6e 2073 7065 6369 6669  inary on specifi
-0000d5b0: 6564 2070 6174 6820 616e 6420 7772 6974  ed path and writ
-0000d5c0: 6520 696e 746f 206d 656d 6f72 790a 0a20  e into memory.. 
-0000d5d0: 2020 2020 2020 2055 7365 7220 7368 6f75         User shou
-0000d5e0: 6c64 2063 6c6f 7365 2074 6865 2042 696e  ld close the Bin
-0000d5f0: 6172 7949 4f20 6d61 6e75 616c 6c79 0a0a  aryIO manually..
-0000d600: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000d610: 3a20 4269 6e61 7279 494f 0a20 2020 2020  : BinaryIO.     
-0000d620: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
-0000d630: 335f 7572 6c20 3d20 7365 6c66 2e70 6174  3_url = self.pat
-0000d640: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
-0000d650: 2020 2020 2020 2020 6966 2066 6f6c 6c6f          if follo
-0000d660: 776c 696e 6b73 3a0a 2020 2020 2020 2020  wlinks:.        
-0000d670: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000d680: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
-0000d690: 3d20 7365 6c66 2e72 6561 646c 696e 6b28  = self.readlink(
-0000d6a0: 292e 7061 7468 5f77 6974 685f 7072 6f74  ).path_with_prot
-0000d6b0: 6f63 6f6c 0a20 2020 2020 2020 2020 2020  ocol.           
-0000d6c0: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
-0000d6d0: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
-0000d6e0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-0000d6f0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
-0000d700: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-0000d710: 2873 335f 7572 6c29 0a20 2020 2020 2020  (s3_url).       
-0000d720: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
-0000d730: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000d740: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
-0000d750: 6e64 4572 726f 7228 2745 6d70 7479 2062  ndError('Empty b
-0000d760: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
-0000d770: 2520 7333 5f75 726c 290a 2020 2020 2020  % s3_url).      
-0000d780: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
-0000d790: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
-0000d7a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000d7b0: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
-0000d7c0: 6f72 7945 7272 6f72 2827 4973 2061 2064  oryError('Is a d
-0000d7d0: 6972 6563 746f 7279 3a20 2572 2720 2520  irectory: %r' % 
-0000d7e0: 7333 5f75 726c 290a 0a20 2020 2020 2020  s3_url)..       
-0000d7f0: 2062 7566 6665 7220 3d20 696f 2e42 7974   buffer = io.Byt
-0000d800: 6573 494f 2829 0a20 2020 2020 2020 2077  esIO().        w
-0000d810: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
-0000d820: 6f72 2873 335f 7572 6c29 3a0a 2020 2020  or(s3_url):.    
-0000d830: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-0000d840: 6965 6e74 2e64 6f77 6e6c 6f61 645f 6669  ient.download_fi
-0000d850: 6c65 6f62 6a28 6275 636b 6574 2c20 6b65  leobj(bucket, ke
-0000d860: 792c 2062 7566 6665 7229 0a20 2020 2020  y, buffer).     
-0000d870: 2020 2062 7566 6665 722e 7365 656b 2830     buffer.seek(0
-0000d880: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000d890: 2062 7566 6665 720a 0a20 2020 2064 6566   buffer..    def
-0000d8a0: 2068 6173 6275 636b 6574 2873 656c 6629   hasbucket(self)
-0000d8b0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-0000d8c0: 2020 2727 270a 2020 2020 2020 2020 5465    '''.        Te
-0000d8d0: 7374 2069 6620 7468 6520 6275 636b 6574  st if the bucket
-0000d8e0: 206f 6620 7333 5f75 726c 2065 7869 7374   of s3_url exist
-0000d8f0: 730a 0a20 2020 2020 2020 203a 7265 7475  s..        :retu
-0000d900: 726e 733a 2054 7275 6520 6966 2062 7563  rns: True if buc
-0000d910: 6b65 7420 6f66 2073 335f 7572 6c20 6569  ket of s3_url ei
-0000d920: 7873 7473 2c20 656c 7365 2046 616c 7365  xsts, else False
-0000d930: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000d940: 2020 2020 2062 7563 6b65 742c 205f 203d       bucket, _ =
-0000d950: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-0000d960: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000d970: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-0000d980: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
-0000d990: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000d9a0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0000d9b0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000d9c0: 2073 656c 662e 5f63 6c69 656e 742e 6865   self._client.he
-0000d9d0: 6164 5f62 7563 6b65 7428 4275 636b 6574  ad_bucket(Bucket
-0000d9e0: 3d62 7563 6b65 7429 0a20 2020 2020 2020  =bucket).       
-0000d9f0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-0000da00: 6e20 6173 2065 7272 6f72 3a0a 2020 2020  n as error:.    
-0000da10: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
-0000da20: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
-0000da30: 6f72 2865 7272 6f72 2c20 7365 6c66 2e70  or(error, self.p
-0000da40: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000da50: 6c29 0a20 2020 2020 2020 2020 2020 2069  l).            i
-0000da60: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
-0000da70: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0000da80: 2020 2020 2020 2020 2020 2020 2020 2853                (S
-0000da90: 3355 6e6b 6e6f 776e 4572 726f 722c 2053  3UnknownError, S
-0000daa0: 3343 6f6e 6669 6745 7272 6f72 2c20 5333  3ConfigError, S3
-0000dab0: 5065 726d 6973 7369 6f6e 4572 726f 7229  PermissionError)
-0000dac0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000dad0: 2020 2072 6169 7365 2065 7272 6f72 0a20     raise error. 
-0000dae0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0000daf0: 696e 7374 616e 6365 2865 7272 6f72 2c20  instance(error, 
-0000db00: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
-0000db10: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000db20: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0000db30: 7365 0a0a 2020 2020 2020 2020 7265 7475  se..        retu
-0000db40: 726e 2054 7275 650a 0a20 2020 2064 6566  rn True..    def
-0000db50: 206d 6b64 6972 2873 656c 662c 206d 6f64   mkdir(self, mod
-0000db60: 653d 306f 3737 372c 2070 6172 656e 7473  e=0o777, parents
-0000db70: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
-0000db80: 6578 6973 745f 6f6b 3a20 626f 6f6c 203d  exist_ok: bool =
-0000db90: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
-0000dba0: 2027 2727 0a20 2020 2020 2020 2043 7265   '''.        Cre
-0000dbb0: 6174 6520 616e 2073 3320 6469 7265 6374  ate an s3 direct
-0000dbc0: 6f72 792e 0a20 2020 2020 2020 2050 7572  ory..        Pur
-0000dbd0: 656c 7920 6372 6561 7469 6e67 2064 6972  ely creating dir
-0000dbe0: 6563 746f 7279 2069 7320 696e 7661 6c69  ectory is invali
-0000dbf0: 6420 6265 6361 7573 6520 6974 2773 2075  d because it's u
-0000dc00: 6e61 7661 696c 6162 6c65 206f 6e20 4f53  navailable on OS
-0000dc10: 532e 0a20 2020 2020 2020 2054 6869 7320  S..        This 
-0000dc20: 6675 6e63 7469 6f6e 2069 7320 746f 2074  function is to t
-0000dc30: 6573 7420 7468 6520 7461 7267 6574 2062  est the target b
-0000dc40: 7563 6b65 7420 6861 7665 2057 5249 5445  ucket have WRITE
-0000dc50: 2061 6363 6573 732e 0a0a 2020 2020 2020   access...      
-0000dc60: 2020 3a70 6172 616d 206d 6f64 653a 206d    :param mode: m
-0000dc70: 6f64 6520 6973 2069 676e 6f72 6564 2c20  ode is ignored, 
-0000dc80: 6f6e 6c79 2062 6520 636f 6d70 6174 6962  only be compatib
-0000dc90: 6c65 2077 6974 6820 7061 7468 6c69 622e  le with pathlib.
-0000dca0: 5061 7468 0a20 2020 2020 2020 203a 7061  Path.        :pa
-0000dcb0: 7261 6d20 7061 7265 6e74 733a 2070 6172  ram parents: par
-0000dcc0: 656e 7473 2069 7320 6967 6e6f 7265 642c  ents is ignored,
-0000dcd0: 206f 6e6c 7920 6265 2063 6f6d 7061 7469   only be compati
-0000dce0: 626c 6520 7769 7468 2070 6174 686c 6962  ble with pathlib
-0000dcf0: 2e50 6174 680a 2020 2020 2020 2020 3a70  .Path.        :p
-0000dd00: 6172 616d 2065 7869 7374 5f6f 6b3a 2049  aram exist_ok: I
-0000dd10: 6620 4661 6c73 6520 616e 6420 7461 7267  f False and targ
-0000dd20: 6574 2064 6972 6563 746f 7279 2065 7869  et directory exi
-0000dd30: 7374 732c 2072 6169 7365 2053 3346 696c  sts, raise S3Fil
-0000dd40: 6545 7869 7374 7345 7272 6f72 0a20 2020  eExistsError.   
-0000dd50: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-0000dd60: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
-0000dd70: 726f 722c 2053 3346 696c 6545 7869 7374  ror, S3FileExist
-0000dd80: 7345 7272 6f72 0a20 2020 2020 2020 2027  sError.        '
-0000dd90: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
-0000dda0: 742c 205f 203d 2070 6172 7365 5f73 335f  t, _ = parse_s3_
-0000ddb0: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
-0000ddc0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-0000ddd0: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-0000dde0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-0000ddf0: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-0000de00: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
-0000de10: 2020 2020 2020 2020 2020 2020 2027 456d               'Em
-0000de20: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
-0000de30: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
-0000de40: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000de50: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0000de60: 656c 662e 6861 7362 7563 6b65 7428 293a  elf.hasbucket():
-0000de70: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000de80: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-0000de90: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
-0000dea0: 2020 2020 2020 2020 2020 274e 6f20 7375            'No su
-0000deb0: 6368 2062 7563 6b65 743a 2025 7227 2025  ch bucket: %r' %
-0000dec0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-0000ded0: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-0000dee0: 2020 6966 2065 7869 7374 5f6f 6b3a 0a20    if exist_ok:. 
-0000def0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000df00: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
-0000df10: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000df20: 6973 6520 5333 4669 6c65 4578 6973 7473  ise S3FileExists
-0000df30: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000df40: 2020 2020 2020 2020 2020 2027 4669 6c65             'File
-0000df50: 2065 7869 7374 733a 2025 7227 2025 2073   exists: %r' % s
-0000df60: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000df70: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000df80: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-0000df90: 2020 2069 6620 7365 6c66 2e65 7869 7374     if self.exist
-0000dfa0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000dfb0: 2072 6169 7365 2053 3346 696c 6545 7869   raise S3FileExi
-0000dfc0: 7374 7345 7272 6f72 2827 4669 6c65 2065  stsError('File e
-0000dfd0: 7869 7374 733a 2025 7227 2025 2073 656c  xists: %r' % sel
-0000dfe0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000dff0: 6f63 6f6c 290a 0a20 2020 2064 6566 206d  ocol)..    def m
-0000e000: 6f76 6528 7365 6c66 2c20 6473 745f 7572  ove(self, dst_ur
-0000e010: 6c3a 2050 6174 684c 696b 6529 202d 3e20  l: PathLike) -> 
-0000e020: 4e6f 6e65 3a0a 2020 2020 2020 2020 2727  None:.        ''
-0000e030: 270a 2020 2020 2020 2020 4d6f 7665 2066  '.        Move f
-0000e040: 696c 652f 6469 7265 6374 6f72 7920 7061  ile/directory pa
-0000e050: 7468 2066 726f 6d20 7372 635f 7572 6c20  th from src_url 
-0000e060: 746f 2064 7374 5f75 726c 0a0a 2020 2020  to dst_url..    
-0000e070: 2020 2020 3a70 6172 616d 2064 7374 5f75      :param dst_u
-0000e080: 726c 3a20 4769 7665 6e20 6465 7374 696e  rl: Given destin
-0000e090: 6174 696f 6e20 7061 7468 0a20 2020 2020  ation path.     
-0000e0a0: 2020 2027 2727 0a20 2020 2020 2020 2066     '''.        f
-0000e0b0: 6f72 2073 7263 5f66 696c 655f 7061 7468  or src_file_path
-0000e0c0: 2c20 6473 745f 6669 6c65 5f70 6174 6820  , dst_file_path 
-0000e0d0: 696e 205f 7333 5f73 6361 6e5f 7061 6972  in _s3_scan_pair
-0000e0e0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-0000e0f0: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
-0000e100: 685f 7072 6f74 6f63 6f6c 2c20 6473 745f  h_protocol, dst_
-0000e110: 7572 6c29 3a0a 2020 2020 2020 2020 2020  url):.          
-0000e120: 2020 5333 5061 7468 2873 7263 5f66 696c    S3Path(src_fil
-0000e130: 655f 7061 7468 292e 7265 6e61 6d65 2864  e_path).rename(d
-0000e140: 7374 5f66 696c 655f 7061 7468 290a 0a20  st_file_path).. 
-0000e150: 2020 2064 6566 2072 656d 6f76 6528 7365     def remove(se
-0000e160: 6c66 2c20 6d69 7373 696e 675f 6f6b 3a20  lf, missing_ok: 
-0000e170: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-0000e180: 204e 6f6e 653a 0a20 2020 2020 2020 2027   None:.        '
-0000e190: 2727 0a20 2020 2020 2020 2052 656d 6f76  ''.        Remov
-0000e1a0: 6520 7468 6520 6669 6c65 206f 7220 6469  e the file or di
-0000e1b0: 7265 6374 6f72 7920 6f6e 2073 332c 2060  rectory on s3, `
-0000e1c0: 7333 3a2f 2f60 2061 6e64 2060 7333 3a2f  s3://` and `s3:/
-0000e1d0: 2f62 7563 6b65 7460 2061 7265 206e 6f74  /bucket` are not
-0000e1e0: 2070 6572 6d69 7474 6564 2074 6f20 7265   permitted to re
-0000e1f0: 6d6f 7665 0a0a 2020 2020 2020 2020 3a70  move..        :p
-0000e200: 6172 616d 206d 6973 7369 6e67 5f6f 6b3a  aram missing_ok:
-0000e210: 2069 6620 4661 6c73 6520 616e 6420 7461   if False and ta
-0000e220: 7267 6574 2066 696c 652f 6469 7265 6374  rget file/direct
-0000e230: 6f72 7920 6e6f 7420 6578 6973 7473 2c20  ory not exists, 
-0000e240: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
-0000e250: 6f75 6e64 4572 726f 720a 2020 2020 2020  oundError.      
-0000e260: 2020 3a72 6169 7365 733a 2053 3350 6572    :raises: S3Per
-0000e270: 6d69 7373 696f 6e45 7272 6f72 2c20 5333  missionError, S3
-0000e280: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000e290: 722c 2055 6e73 7570 706f 7274 6564 4572  r, UnsupportedEr
-0000e2a0: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
-0000e2b0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
-0000e2c0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-0000e2d0: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
-0000e2e0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000e2f0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
-0000e300: 743a 0a20 2020 2020 2020 2020 2020 2069  t:.            i
-0000e310: 6620 6e6f 7420 6b65 793a 0a20 2020 2020  f not key:.     
-0000e320: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000e330: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
-0000e340: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0000e350: 2020 2020 2020 2027 5265 6d6f 7665 2077         'Remove w
-0000e360: 686f 6c65 2073 3327 2c20 7365 6c66 2e70  hole s3', self.p
-0000e370: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000e380: 6c29 0a20 2020 2020 2020 2020 2020 2072  l).            r
-0000e390: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
-0000e3a0: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
-0000e3b0: 2020 2020 2020 2020 2020 2020 2745 6d70              'Emp
-0000e3c0: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
-0000e3d0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
-0000e3e0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-0000e3f0: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
-0000e400: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
-0000e410: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
-0000e420: 4572 726f 7228 2752 656d 6f76 6520 6275  Error('Remove bu
-0000e430: 636b 6574 272c 2073 656c 662e 7061 7468  cket', self.path
-0000e440: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000e450: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0000e460: 656c 662e 6578 6973 7473 2829 3a0a 2020  elf.exists():.  
-0000e470: 2020 2020 2020 2020 2020 6966 206d 6973            if mis
-0000e480: 7369 6e67 5f6f 6b3a 0a20 2020 2020 2020  sing_ok:.       
-0000e490: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0000e4a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000e4b0: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
-0000e4c0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000e4d0: 2020 2020 2020 2027 4e6f 2073 7563 6820         'No such 
-0000e4e0: 6669 6c65 206f 7220 6469 7265 6374 6f72  file or director
-0000e4f0: 793a 2025 7227 2025 2073 656c 662e 7061  y: %r' % self.pa
-0000e500: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000e510: 290a 0a20 2020 2020 2020 2063 6c69 656e  )..        clien
-0000e520: 7420 3d20 7365 6c66 2e5f 636c 6965 6e74  t = self._client
-0000e530: 0a20 2020 2020 2020 2077 6974 6820 7261  .        with ra
-0000e540: 6973 655f 7333 5f65 7272 6f72 2873 656c  ise_s3_error(sel
-0000e550: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000e560: 6f63 6f6c 293a 0a20 2020 2020 2020 2020  ocol):.         
-0000e570: 2020 2069 6620 7365 6c66 2e69 735f 6669     if self.is_fi
-0000e580: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
-0000e590: 2020 2020 2020 636c 6965 6e74 2e64 656c        client.del
-0000e5a0: 6574 655f 6f62 6a65 6374 2842 7563 6b65  ete_object(Bucke
-0000e5b0: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
-0000e5c0: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
-0000e5d0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0000e5e0: 2020 2020 2020 7072 6566 6978 203d 205f        prefix = _
-0000e5f0: 6265 636f 6d65 5f70 7265 6669 7828 6b65  become_prefix(ke
-0000e600: 7929 0a20 2020 2020 2020 2020 2020 2074  y).            t
-0000e610: 6f74 616c 5f63 6f75 6e74 2c20 6572 726f  otal_count, erro
-0000e620: 725f 636f 756e 7420 3d20 302c 2030 0a20  r_count = 0, 0. 
-0000e630: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
-0000e640: 6573 7020 696e 205f 6c69 7374 5f6f 626a  esp in _list_obj
-0000e650: 6563 7473 5f72 6563 7572 7369 7665 2863  ects_recursive(c
-0000e660: 6c69 656e 742c 2062 7563 6b65 742c 2070  lient, bucket, p
-0000e670: 7265 6669 7829 3a0a 2020 2020 2020 2020  refix):.        
-0000e680: 2020 2020 2020 2020 6966 2027 436f 6e74          if 'Cont
-0000e690: 656e 7473 2720 696e 2072 6573 703a 0a20  ents' in resp:. 
-0000e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6b0: 2020 206b 6579 7320 3d20 5b0a 2020 2020     keys = [.    
-0000e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0000e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e6f0: 2020 274b 6579 273a 2063 6f6e 7465 6e74    'Key': content
-0000e700: 5b27 4b65 7927 5d0a 2020 2020 2020 2020  ['Key'].        
-0000e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e720: 7d20 666f 7220 636f 6e74 656e 7420 696e  } for content in
-0000e730: 2072 6573 705b 2743 6f6e 7465 6e74 7327   resp['Contents'
-0000e740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000e750: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0000e760: 2020 2020 2020 2020 2020 2020 746f 7461              tota
-0000e770: 6c5f 636f 756e 7420 2b3d 206c 656e 286b  l_count += len(k
-0000e780: 6579 7329 0a20 2020 2020 2020 2020 2020  eys).           
-0000e790: 2020 2020 2020 2020 2065 7272 6f72 7320           errors 
-0000e7a0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-0000e7b0: 2020 2020 2020 2020 2072 6574 7269 6573           retries
-0000e7c0: 203d 2032 0a20 2020 2020 2020 2020 2020   = 2.           
-0000e7d0: 2020 2020 2020 2020 2072 6574 7279 5f69           retry_i
-0000e7e0: 6e74 6572 7661 6c20 3d20 6d69 6e28 302e  nterval = min(0.
-0000e7f0: 3120 2a20 322a 2a72 6574 7269 6573 2c20  1 * 2**retries, 
-0000e800: 3330 290a 2020 2020 2020 2020 2020 2020  30).            
-0000e810: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-0000e820: 2072 616e 6765 2872 6574 7269 6573 293a   range(retries):
-0000e830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e840: 2020 2020 2020 2020 2023 2064 6f63 3a20           # doc: 
-0000e850: 6874 7470 733a 2f2f 626f 746f 332e 616d  https://boto3.am
-0000e860: 617a 6f6e 6177 732e 636f 6d2f 7631 2f64  azonaws.com/v1/d
-0000e870: 6f63 756d 656e 7461 7469 6f6e 2f61 7069  ocumentation/api
-0000e880: 2f6c 6174 6573 742f 7265 6665 7265 6e63  /latest/referenc
-0000e890: 652f 7365 7276 6963 6573 2f73 332e 6874  e/services/s3.ht
-0000e8a0: 6d6c 2353 332e 436c 6965 6e74 2e64 656c  ml#S3.Client.del
-0000e8b0: 6574 655f 6f62 6a65 6374 730a 2020 2020  ete_objects.    
-0000e8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8d0: 2020 2020 6966 206e 6f74 206b 6579 733a      if not keys:
-0000e8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e8f0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0000e900: 616b 0a20 2020 2020 2020 2020 2020 2020  ak.             
-0000e910: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-0000e920: 6e73 6520 3d20 636c 6965 6e74 2e64 656c  nse = client.del
-0000e930: 6574 655f 6f62 6a65 6374 7328 0a20 2020  ete_objects(.   
-0000e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e950: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
-0000e960: 6275 636b 6574 2c20 4465 6c65 7465 3d7b  bucket, Delete={
-0000e970: 274f 626a 6563 7473 273a 206b 6579 737d  'Objects': keys}
-0000e980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000e990: 2020 2020 2020 2020 2020 6b65 7973 203d            keys =
-0000e9a0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0000e9b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000e9c0: 6572 726f 725f 696e 666f 2069 6e20 7265  error_info in re
-0000e9d0: 7370 6f6e 7365 2e67 6574 2827 4572 726f  sponse.get('Erro
-0000e9e0: 7273 272c 205b 5d29 3a0a 2020 2020 2020  rs', []):.      
-0000e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea00: 2020 2020 2020 6966 2073 335f 6572 726f        if s3_erro
-0000ea10: 725f 636f 6465 5f73 686f 756c 645f 7265  r_code_should_re
-0000ea20: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
-0000ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea40: 2020 2020 2020 2020 2065 7272 6f72 5f69           error_i
-0000ea50: 6e66 6f2e 6765 7428 2743 6f64 6527 2929  nfo.get('Code'))
-0000ea60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea80: 2020 6572 726f 725f 6c6f 6767 6572 2e77    error_logger.w
-0000ea90: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-0000eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eab0: 2020 2020 2020 2020 2020 2020 2272 6574              "ret
-0000eac0: 7279 2025 7320 7469 6d65 732c 2072 656d  ry %s times, rem
-0000ead0: 6f76 696e 6720 6669 6c65 3a20 2573 2c20  oving file: %s, 
-0000eae0: 7769 7468 2065 7272 6f72 2025 733a 2025  with error %s: %
-0000eaf0: 7322 0a20 2020 2020 2020 2020 2020 2020  s".             
+0000c400: 2020 6772 6f75 705f 7333 5f70 6174 686e    group_s3_pathn
+0000c410: 616d 655f 3129 3a0a 2020 2020 2020 2020  ame_1):.        
+0000c420: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000c430: 6669 6c65 5f65 6e74 7279 2069 6e20 5f73  file_entry in _s
+0000c440: 335f 676c 6f62 5f73 7461 745f 7369 6e67  3_glob_stat_sing
+0000c450: 6c65 5f70 6174 6828 0a20 2020 2020 2020  le_path(.       
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c470: 2020 2020 2067 726f 7570 5f73 335f 7061       group_s3_pa
+0000c480: 7468 6e61 6d65 5f32 2c20 7265 6375 7273  thname_2, recurs
+0000c490: 6976 652c 206d 6973 7369 6e67 5f6f 6b2c  ive, missing_ok,
+0000c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c4b0: 2020 2020 2020 2020 2020 2020 2066 6f6c               fol
+0000c4c0: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
+0000c4d0: 696e 6b73 2c0a 2020 2020 2020 2020 2020  inks,.          
+0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4f0: 2020 7072 6f66 696c 655f 6e61 6d65 3d73    profile_name=s
+0000c500: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
+0000c510: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000c520: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000c530: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
+0000c540: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000c560: 696c 655f 656e 7472 7920 3d20 6669 6c65  ile_entry = file
+0000c570: 5f65 6e74 7279 2e5f 7265 706c 6163 6528  _entry._replace(
+0000c580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5a0: 2070 6174 683d 0a20 2020 2020 2020 2020   path=.         
+0000c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5c0: 2020 2020 2020 2066 227b 7365 6c66 2e5f         f"{self._
+0000c5d0: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
+0000c5e0: 6f66 696c 657d 3a2f 2f7b 6669 6c65 5f65  ofile}://{file_e
+0000c5f0: 6e74 7279 2e70 6174 685b 353a 5d7d 220a  ntry.path[5:]}".
+0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c610: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c630: 2020 2020 2020 7969 656c 6420 6669 6c65        yield file
+0000c640: 5f65 6e74 7279 0a0a 2020 2020 2020 2020  _entry..        
+0000c650: 7265 7475 726e 205f 6372 6561 7465 5f6d  return _create_m
+0000c660: 6973 7369 6e67 5f6f 6b5f 6765 6e65 7261  issing_ok_genera
+0000c670: 746f 7228 0a20 2020 2020 2020 2020 2020  tor(.           
+0000c680: 2063 7265 6174 655f 6765 6e65 7261 746f   create_generato
+0000c690: 7228 292c 206d 6973 7369 6e67 5f6f 6b2c  r(), missing_ok,
+0000c6a0: 0a20 2020 2020 2020 2020 2020 2053 3346  .            S3F
+0000c6b0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+0000c6c0: 2827 4e6f 206d 6174 6368 2066 696c 653a  ('No match file:
+0000c6d0: 2025 7227 2025 2073 335f 7061 7468 6e61   %r' % s3_pathna
+0000c6e0: 6d65 2929 0a0a 2020 2020 6465 6620 6967  me))..    def ig
+0000c6f0: 6c6f 6228 0a20 2020 2020 2020 2020 2020  lob(.           
+0000c700: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
+0000c710: 2020 2070 6174 7465 726e 2c0a 2020 2020     pattern,.    
+0000c720: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
+0000c730: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
+0000c740: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
+0000c750: 696e 675f 6f6b 3a20 626f 6f6c 203d 2054  ing_ok: bool = T
+0000c760: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0000c770: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
+0000c780: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+0000c790: 2920 2d3e 2049 7465 7261 746f 725b 2753  ) -> Iterator['S
+0000c7a0: 3350 6174 6827 5d3a 0a20 2020 2020 2020  3Path']:.       
+0000c7b0: 2027 2727 5265 7475 726e 2073 3320 7061   '''Return s3 pa
+0000c7c0: 7468 2069 7465 7261 746f 7220 696e 2061  th iterator in a
+0000c7d0: 7363 656e 6469 6e67 2061 6c70 6861 6265  scending alphabe
+0000c7e0: 7469 6361 6c20 6f72 6465 722c 2069 6e20  tical order, in 
+0000c7f0: 7768 6963 6820 7061 7468 206d 6174 6368  which path match
+0000c800: 6573 2067 6c6f 6220 7061 7474 6572 6e0a  es glob pattern.
+0000c810: 2020 2020 2020 2020 4e6f 7465 733a 204f          Notes: O
+0000c820: 6e6c 7920 676c 6f62 2069 6e20 6275 636b  nly glob in buck
+0000c830: 6574 2e20 4966 2074 7279 696e 6720 746f  et. If trying to
+0000c840: 206d 6174 6368 2062 7563 6b65 7420 7769   match bucket wi
+0000c850: 7468 2077 696c 6463 6172 6420 6368 6172  th wildcard char
+0000c860: 6163 7465 7273 2c20 7261 6973 6520 556e  acters, raise Un
+0000c870: 7375 7070 6f72 7465 6445 7272 6f72 0a0a  supportedError..
+0000c880: 2020 2020 2020 2020 3a70 6172 616d 2070          :param p
+0000c890: 6174 7465 726e 3a20 476c 6f62 2074 6865  attern: Glob the
+0000c8a0: 2067 6976 656e 2072 656c 6174 6976 6520   given relative 
+0000c8b0: 7061 7474 6572 6e20 696e 2074 6865 2064  pattern in the d
+0000c8c0: 6972 6563 746f 7279 2072 6570 7265 7365  irectory represe
+0000c8d0: 6e74 6564 2062 7920 7468 6973 2070 6174  nted by this pat
+0000c8e0: 680a 2020 2020 2020 2020 3a70 6172 616d  h.        :param
+0000c8f0: 2072 6563 7572 7369 7665 3a20 4966 2046   recursive: If F
+0000c900: 616c 7365 2c20 602a 2a60 2077 696c 6c20  alse, `**` will 
+0000c910: 6e6f 7420 7365 6172 6368 2064 6972 6563  not search direc
+0000c920: 746f 7279 2072 6563 7572 7369 7665 6c79  tory recursively
+0000c930: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000c940: 6d69 7373 696e 675f 6f6b 3a20 4966 2046  missing_ok: If F
+0000c950: 616c 7365 2061 6e64 2074 6172 6765 7420  alse and target 
+0000c960: 7061 7468 2064 6f65 736e 2774 206d 6174  path doesn't mat
+0000c970: 6368 2061 6e79 2066 696c 652c 2072 6169  ch any file, rai
+0000c980: 7365 2046 696c 654e 6f74 466f 756e 6445  se FileNotFoundE
+0000c990: 7272 6f72 0a20 2020 2020 2020 203a 7261  rror.        :ra
+0000c9a0: 6973 6573 3a20 556e 7375 7070 6f72 7465  ises: Unsupporte
+0000c9b0: 6445 7272 6f72 2c20 7768 656e 2062 7563  dError, when buc
+0000c9c0: 6b65 7420 7061 7274 2063 6f6e 7461 696e  ket part contain
+0000c9d0: 7320 7769 6c64 6361 7264 2063 6861 7261  s wildcard chara
+0000c9e0: 6374 6572 730a 2020 2020 2020 2020 3a72  cters.        :r
+0000c9f0: 6574 7572 6e73 3a20 416e 2069 7465 7261  eturns: An itera
+0000ca00: 746f 7220 636f 6e74 6169 6e73 2070 6174  tor contains pat
+0000ca10: 6873 206d 6174 6368 2060 7333 5f70 6174  hs match `s3_pat
+0000ca20: 686e 616d 6560 0a20 2020 2020 2020 2027  hname`.        '
+0000ca30: 2727 0a20 2020 2020 2020 2066 6f72 2066  ''.        for f
+0000ca40: 696c 655f 656e 7472 7920 696e 2073 656c  ile_entry in sel
+0000ca50: 662e 676c 6f62 5f73 7461 7428 7061 7474  f.glob_stat(patt
+0000ca60: 6572 6e3d 7061 7474 6572 6e2c 2072 6563  ern=pattern, rec
+0000ca70: 7572 7369 7665 3d72 6563 7572 7369 7665  ursive=recursive
+0000ca80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000caa0: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0000cab0: 6e67 5f6f 6b3d 6d69 7373 696e 675f 6f6b  ng_ok=missing_ok
+0000cac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cae0: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
+0000caf0: 776c 696e 6b73 3d66 6f6c 6c6f 776c 696e  wlinks=followlin
+0000cb00: 6b73 293a 0a20 2020 2020 2020 2020 2020  ks):.           
+0000cb10: 2079 6965 6c64 2073 656c 662e 6672 6f6d   yield self.from
+0000cb20: 5f70 6174 6828 6669 6c65 5f65 6e74 7279  _path(file_entry
+0000cb30: 2e70 6174 6829 0a0a 2020 2020 6465 6620  .path)..    def 
+0000cb40: 6973 5f64 6972 2873 656c 662c 2066 6f6c  is_dir(self, fol
+0000cb50: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+0000cb60: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
+0000cb70: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000cb80: 2020 2020 2054 6573 7420 6966 2061 6e20       Test if an 
+0000cb90: 7333 2075 726c 2069 7320 6469 7265 6374  s3 url is direct
+0000cba0: 6f72 790a 2020 2020 2020 2020 5370 6563  ory.        Spec
+0000cbb0: 6966 6963 2070 726f 6365 6475 7265 7320  ific procedures 
+0000cbc0: 6172 6520 6173 2066 6f6c 6c6f 7773 3a0a  are as follows:.
+0000cbd0: 2020 2020 2020 2020 4966 2074 6865 7265          If there
+0000cbe0: 2065 7869 7374 7320 6120 7375 6666 6978   exists a suffix
+0000cbf0: 2c20 6f66 2077 6869 6368 2060 606f 732e  , of which ``os.
+0000cc00: 7061 7468 2e6a 6f69 6e28 7333 5f75 726c  path.join(s3_url
+0000cc10: 2c20 7375 6666 6978 2960 6020 6973 2061  , suffix)`` is a
+0000cc20: 2066 696c 650a 2020 2020 2020 2020 4966   file.        If
+0000cc30: 2074 6865 2075 726c 2069 7320 656d 7074   the url is empt
+0000cc40: 7920 6275 636b 6574 206f 7220 7333 3a2f  y bucket or s3:/
+0000cc50: 2f0a 0a20 2020 2020 2020 203a 7061 7261  /..        :para
+0000cc60: 6d20 666f 6c6c 6f77 6c69 6e6b 733a 2077  m followlinks: w
+0000cc70: 6865 7468 6572 2066 6f6c 6c6f 776c 696e  hether followlin
+0000cc80: 6b73 2069 7320 5472 7565 206f 7220 4661  ks is True or Fa
+0000cc90: 6c73 652c 2072 6573 756c 7420 6973 2074  lse, result is t
+0000cca0: 6865 2073 616d 652e 2042 6563 6175 7365  he same. Because
+0000ccb0: 2073 3320 7379 6d6c 696e 6b20 6e6f 7420   s3 symlink not 
+0000ccc0: 7375 7070 6f72 7420 6469 722e 0a20 2020  support dir..   
+0000ccd0: 2020 2020 203a 7265 7475 726e 733a 2054       :returns: T
+0000cce0: 7275 6520 6966 2070 6174 6820 6973 2073  rue if path is s
+0000ccf0: 3320 6469 7265 6374 6f72 792c 2065 6c73  3 directory, els
+0000cd00: 6520 4661 6c73 650a 2020 2020 2020 2020  e False.        
+0000cd10: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
+0000cd20: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
+0000cd30: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
+0000cd40: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000cd50: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+0000cd60: 7563 6b65 743a 2020 2320 7333 3a2f 2f20  ucket:  # s3:// 
+0000cd70: 3d3e 2054 7275 652c 2073 333a 2f2f 2f6b  => True, s3:///k
+0000cd80: 6579 203d 3e20 4661 6c73 650a 2020 2020  ey => False.    
+0000cd90: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+0000cda0: 6f74 206b 6579 0a20 2020 2020 2020 2070  ot key.        p
+0000cdb0: 7265 6669 7820 3d20 5f62 6563 6f6d 655f  refix = _become_
+0000cdc0: 7072 6566 6978 286b 6579 290a 2020 2020  prefix(key).    
+0000cdd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000cde0: 2020 2020 2072 6573 7020 3d20 7365 6c66       resp = self
+0000cdf0: 2e5f 636c 6965 6e74 2e6c 6973 745f 6f62  ._client.list_ob
+0000ce00: 6a65 6374 735f 7632 280a 2020 2020 2020  jects_v2(.      
+0000ce10: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
+0000ce20: 3d62 7563 6b65 742c 2050 7265 6669 783d  =bucket, Prefix=
+0000ce30: 7072 6566 6978 2c20 4465 6c69 6d69 7465  prefix, Delimite
+0000ce40: 723d 272f 272c 204d 6178 4b65 7973 3d31  r='/', MaxKeys=1
+0000ce50: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0000ce60: 2045 7863 6570 7469 6f6e 2061 7320 6572   Exception as er
+0000ce70: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0000ce80: 2065 7272 6f72 203d 2074 7261 6e73 6c61   error = transla
+0000ce90: 7465 5f73 335f 6572 726f 7228 6572 726f  te_s3_error(erro
+0000cea0: 722c 2073 656c 662e 7061 7468 5f77 6974  r, self.path_wit
+0000ceb0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000cec0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0000ced0: 7461 6e63 6528 6572 726f 722c 0a20 2020  tance(error,.   
+0000cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cef0: 2020 2020 2020 2028 5333 556e 6b6e 6f77         (S3Unknow
+0000cf00: 6e45 7272 6f72 2c20 5333 436f 6e66 6967  nError, S3Config
+0000cf10: 4572 726f 722c 2053 3350 6572 6d69 7373  Error, S3Permiss
+0000cf20: 696f 6e45 7272 6f72 2929 3a0a 2020 2020  ionError)):.    
+0000cf30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000cf40: 6520 6572 726f 720a 2020 2020 2020 2020  e error.        
+0000cf50: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+0000cf60: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0000cf70: 206b 6579 3a20 2023 2062 7563 6b65 7420   key:  # bucket 
+0000cf80: 6973 2061 6363 6573 7369 626c 650a 2020  is accessible.  
+0000cf90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000cfa0: 2054 7275 650a 0a20 2020 2020 2020 2069   True..        i
+0000cfb0: 6620 274b 6579 436f 756e 7427 2069 6e20  f 'KeyCount' in 
+0000cfc0: 7265 7370 3a0a 2020 2020 2020 2020 2020  resp:.          
+0000cfd0: 2020 7265 7475 726e 2072 6573 705b 274b    return resp['K
+0000cfe0: 6579 436f 756e 7427 5d20 3e20 300a 0a20  eyCount'] > 0.. 
+0000cff0: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
+0000d000: 6e28 7265 7370 2e67 6574 2827 436f 6e74  n(resp.get('Cont
+0000d010: 656e 7473 272c 205b 5d29 2920 3e20 3020  ents', [])) > 0 
+0000d020: 6f72 205c 0a20 2020 2020 2020 2020 2020  or \.           
+0000d030: 206c 656e 2872 6573 702e 6765 7428 2743   len(resp.get('C
+0000d040: 6f6d 6d6f 6e50 7265 6669 7865 7327 2c20  ommonPrefixes', 
+0000d050: 5b5d 2929 203e 2030 0a0a 2020 2020 6465  [])) > 0..    de
+0000d060: 6620 6973 5f66 696c 6528 7365 6c66 2c20  f is_file(self, 
+0000d070: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+0000d080: 6c20 3d20 4661 6c73 6529 202d 3e20 626f  l = False) -> bo
+0000d090: 6f6c 3a0a 2020 2020 2020 2020 2727 270a  ol:.        '''.
+0000d0a0: 2020 2020 2020 2020 5465 7374 2069 6620          Test if 
+0000d0b0: 616e 2073 335f 7572 6c20 6973 2066 696c  an s3_url is fil
+0000d0c0: 650a 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
+0000d0d0: 726e 733a 2054 7275 6520 6966 2070 6174  rns: True if pat
+0000d0e0: 6820 6973 2073 3320 6669 6c65 2c20 656c  h is s3 file, el
+0000d0f0: 7365 2046 616c 7365 0a20 2020 2020 2020  se False.       
+0000d100: 2027 2727 0a20 2020 2020 2020 2073 335f   '''.        s3_
+0000d110: 7572 6c20 3d20 7365 6c66 2e70 6174 685f  url = self.path_
+0000d120: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
+0000d130: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
+0000d140: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
+0000d150: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000d160: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
+0000d170: 7365 6c66 2e72 6561 646c 696e 6b28 292e  self.readlink().
+0000d180: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000d190: 6f6c 0a20 2020 2020 2020 2020 2020 2065  ol.            e
+0000d1a0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
+0000d1b0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0000d1c0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+0000d1d0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+0000d1e0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+0000d1f0: 335f 7572 6c29 0a20 2020 2020 2020 2069  3_url).        i
+0000d200: 6620 6e6f 7420 6275 636b 6574 206f 7220  f not bucket or 
+0000d210: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
+0000d220: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
+0000d230: 2020 2020 2020 2020 2020 2320 7333 3a2f            # s3:/
+0000d240: 2f2c 2073 333a 2f2f 2f6b 6579 2c20 7333  /, s3:///key, s3
+0000d250: 3a2f 2f62 7563 6b65 742c 2073 333a 2f2f  ://bucket, s3://
+0000d260: 6275 636b 6574 2f70 7265 6669 782f 0a20  bucket/prefix/. 
+0000d270: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000d280: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
+0000d290: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d2a0: 2073 656c 662e 5f63 6c69 656e 742e 6865   self._client.he
+0000d2b0: 6164 5f6f 626a 6563 7428 4275 636b 6574  ad_object(Bucket
+0000d2c0: 3d62 7563 6b65 742c 204b 6579 3d6b 6579  =bucket, Key=key
+0000d2d0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0000d2e0: 2045 7863 6570 7469 6f6e 2061 7320 6572   Exception as er
+0000d2f0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0000d300: 2065 7272 6f72 203d 2074 7261 6e73 6c61   error = transla
+0000d310: 7465 5f73 335f 6572 726f 7228 6572 726f  te_s3_error(erro
+0000d320: 722c 2073 335f 7572 6c29 0a20 2020 2020  r, s3_url).     
+0000d330: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000d340: 616e 6365 2865 7272 6f72 2c0a 2020 2020  ance(error,.    
+0000d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d360: 2020 2020 2020 2853 3355 6e6b 6e6f 776e        (S3Unknown
+0000d370: 4572 726f 722c 2053 3343 6f6e 6669 6745  Error, S3ConfigE
+0000d380: 7272 6f72 2c20 5333 5065 726d 6973 7369  rror, S3Permissi
+0000d390: 6f6e 4572 726f 7229 293a 0a20 2020 2020  onError)):.     
+0000d3a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000d3b0: 2065 7272 6f72 0a20 2020 2020 2020 2020   error.         
+0000d3c0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0000d3d0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000d3e0: 7275 650a 0a20 2020 2064 6566 206c 6973  rue..    def lis
+0000d3f0: 7464 6972 2873 656c 662c 2066 6f6c 6c6f  tdir(self, follo
+0000d400: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000d410: 616c 7365 2920 2d3e 204c 6973 745b 7374  alse) -> List[st
+0000d420: 725d 3a0a 2020 2020 2020 2020 2727 270a  r]:.        '''.
+0000d430: 2020 2020 2020 2020 4765 7420 616c 6c20          Get all 
+0000d440: 636f 6e74 656e 7473 206f 6620 6769 7665  contents of give
+0000d450: 6e20 7333 5f75 726c 2e20 5468 6520 7265  n s3_url. The re
+0000d460: 7375 6c74 2069 7320 696e 2061 6373 656e  sult is in acsen
+0000d470: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
+0000d480: 6c20 6f72 6465 722e 0a0a 2020 2020 2020  l order...      
+0000d490: 2020 3a72 6574 7572 6e73 3a20 416c 6c20    :returns: All 
+0000d4a0: 636f 6e74 656e 7473 2068 6176 6520 7072  contents have pr
+0000d4b0: 6566 6978 206f 6620 7333 5f75 726c 2069  efix of s3_url i
+0000d4c0: 6e20 6163 7365 6e64 696e 6720 616c 7068  n acsending alph
+0000d4d0: 6162 6574 6963 616c 206f 7264 6572 0a20  abetical order. 
+0000d4e0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+0000d4f0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+0000d500: 726f 722c 2053 334e 6f74 4144 6972 6563  ror, S3NotADirec
+0000d510: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
+0000d520: 2020 2727 270a 2020 2020 2020 2020 656e    '''.        en
+0000d530: 7472 6965 7320 3d20 6c69 7374 2873 656c  tries = list(sel
+0000d540: 662e 7363 616e 6469 7228 666f 6c6c 6f77  f.scandir(follow
+0000d550: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
+0000d560: 7329 290a 2020 2020 2020 2020 7265 7475  s)).        retu
+0000d570: 726e 2073 6f72 7465 6428 5b65 6e74 7279  rn sorted([entry
+0000d580: 2e6e 616d 6520 666f 7220 656e 7472 7920  .name for entry 
+0000d590: 696e 2065 6e74 7269 6573 5d29 0a0a 2020  in entries])..  
+0000d5a0: 2020 6465 6620 6974 6572 6469 7228 7365    def iterdir(se
+0000d5b0: 6c66 2c20 666f 6c6c 6f77 6c69 6e6b 733a  lf, followlinks:
+0000d5c0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+0000d5d0: 3e20 4974 6572 6174 6f72 5b27 5333 5061  > Iterator['S3Pa
+0000d5e0: 7468 275d 3a0a 2020 2020 2020 2020 2727  th']:.        ''
+0000d5f0: 270a 2020 2020 2020 2020 4765 7420 616c  '.        Get al
+0000d600: 6c20 636f 6e74 656e 7473 206f 6620 6769  l contents of gi
+0000d610: 7665 6e20 7333 5f75 726c 2e20 5468 6520  ven s3_url. The 
+0000d620: 7265 7375 6c74 2069 7320 696e 2061 6373  result is in acs
+0000d630: 656e 6469 6e67 2061 6c70 6861 6265 7469  ending alphabeti
+0000d640: 6361 6c20 6f72 6465 722e 0a0a 2020 2020  cal order...    
+0000d650: 2020 2020 3a72 6574 7572 6e73 3a20 416c      :returns: Al
+0000d660: 6c20 636f 6e74 656e 7473 2068 6176 6520  l contents have 
+0000d670: 7072 6566 6978 206f 6620 7333 5f75 726c  prefix of s3_url
+0000d680: 2069 6e20 6163 7365 6e64 696e 6720 616c   in acsending al
+0000d690: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
+0000d6a0: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+0000d6b0: 3a20 5333 4669 6c65 4e6f 7446 6f75 6e64  : S3FileNotFound
+0000d6c0: 4572 726f 722c 2053 334e 6f74 4144 6972  Error, S3NotADir
+0000d6d0: 6563 746f 7279 4572 726f 720a 2020 2020  ectoryError.    
+0000d6e0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000d6f0: 666f 7220 7061 7468 2069 6e20 7365 6c66  for path in self
+0000d700: 2e6c 6973 7464 6972 2866 6f6c 6c6f 776c  .listdir(followl
+0000d710: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
+0000d720: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
+0000d730: 6965 6c64 2073 656c 662e 6a6f 696e 7061  ield self.joinpa
+0000d740: 7468 2870 6174 6829 2020 2320 7479 7065  th(path)  # type
+0000d750: 3a20 6967 6e6f 7265 0a0a 2020 2020 6465  : ignore..    de
+0000d760: 6620 6c6f 6164 2873 656c 662c 2066 6f6c  f load(self, fol
+0000d770: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+0000d780: 2046 616c 7365 2920 2d3e 2042 696e 6172   False) -> Binar
+0000d790: 7949 4f3a 0a20 2020 2020 2020 2027 2727  yIO:.        '''
+0000d7a0: 5265 6164 2061 6c6c 2063 6f6e 7465 6e74  Read all content
+0000d7b0: 2069 6e20 6269 6e61 7279 206f 6e20 7370   in binary on sp
+0000d7c0: 6563 6966 6965 6420 7061 7468 2061 6e64  ecified path and
+0000d7d0: 2077 7269 7465 2069 6e74 6f20 6d65 6d6f   write into memo
+0000d7e0: 7279 0a0a 2020 2020 2020 2020 5573 6572  ry..        User
+0000d7f0: 2073 686f 756c 6420 636c 6f73 6520 7468   should close th
+0000d800: 6520 4269 6e61 7279 494f 206d 616e 7561  e BinaryIO manua
+0000d810: 6c6c 790a 0a20 2020 2020 2020 203a 7265  lly..        :re
+0000d820: 7475 726e 733a 2042 696e 6172 7949 4f0a  turns: BinaryIO.
+0000d830: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000d840: 2020 2020 7333 5f75 726c 203d 2073 656c      s3_url = sel
+0000d850: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000d860: 6f63 6f6c 0a20 2020 2020 2020 2069 6620  ocol.        if 
+0000d870: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
+0000d880: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000d890: 2020 2020 2020 2020 2020 2020 2020 7333                s3
+0000d8a0: 5f75 726c 203d 2073 656c 662e 7265 6164  _url = self.read
+0000d8b0: 6c69 6e6b 2829 2e70 6174 685f 7769 7468  link().path_with
+0000d8c0: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
+0000d8d0: 2020 2020 2020 6578 6365 7074 2053 334e        except S3N
+0000d8e0: 6f74 414c 696e 6b45 7272 6f72 3a0a 2020  otALinkError:.  
+0000d8f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0000d900: 7373 0a20 2020 2020 2020 2062 7563 6b65  ss.        bucke
+0000d910: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000d920: 335f 7572 6c28 7333 5f75 726c 290a 2020  3_url(s3_url).  
+0000d930: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+0000d940: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+0000d950: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
+0000d960: 6f74 466f 756e 6445 7272 6f72 2827 456d  otFoundError('Em
+0000d970: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+0000d980: 2025 7227 2025 2073 335f 7572 6c29 0a20   %r' % s3_url). 
+0000d990: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
+0000d9a0: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
+0000d9b0: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+0000d9c0: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
+0000d9d0: 6972 6563 746f 7279 4572 726f 7228 2749  irectoryError('I
+0000d9e0: 7320 6120 6469 7265 6374 6f72 793a 2025  s a directory: %
+0000d9f0: 7227 2025 2073 335f 7572 6c29 0a0a 2020  r' % s3_url)..  
+0000da00: 2020 2020 2020 6275 6666 6572 203d 2069        buffer = i
+0000da10: 6f2e 4279 7465 7349 4f28 290a 2020 2020  o.BytesIO().    
+0000da20: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
+0000da30: 335f 6572 726f 7228 7333 5f75 726c 293a  3_error(s3_url):
+0000da40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000da50: 662e 5f63 6c69 656e 742e 646f 776e 6c6f  f._client.downlo
+0000da60: 6164 5f66 696c 656f 626a 2862 7563 6b65  ad_fileobj(bucke
+0000da70: 742c 206b 6579 2c20 6275 6666 6572 290a  t, key, buffer).
+0000da80: 2020 2020 2020 2020 6275 6666 6572 2e73          buffer.s
+0000da90: 6565 6b28 3029 0a20 2020 2020 2020 2072  eek(0).        r
+0000daa0: 6574 7572 6e20 6275 6666 6572 0a0a 2020  eturn buffer..  
+0000dab0: 2020 6465 6620 6861 7362 7563 6b65 7428    def hasbucket(
+0000dac0: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
+0000dad0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000dae0: 2020 2054 6573 7420 6966 2074 6865 2062     Test if the b
+0000daf0: 7563 6b65 7420 6f66 2073 335f 7572 6c20  ucket of s3_url 
+0000db00: 6578 6973 7473 0a0a 2020 2020 2020 2020  exists..        
+0000db10: 3a72 6574 7572 6e73 3a20 5472 7565 2069  :returns: True i
+0000db20: 6620 6275 636b 6574 206f 6620 7333 5f75  f bucket of s3_u
+0000db30: 726c 2065 6978 7374 732c 2065 6c73 6520  rl eixsts, else 
+0000db40: 4661 6c73 650a 2020 2020 2020 2020 2727  False.        ''
+0000db50: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
+0000db60: 2c20 5f20 3d20 7061 7273 655f 7333 5f75  , _ = parse_s3_u
+0000db70: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
+0000db80: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000db90: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+0000dba0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+0000dbb0: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+0000dbc0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0000dbd0: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
+0000dbe0: 6e74 2e68 6561 645f 6275 636b 6574 2842  nt.head_bucket(B
+0000dbf0: 7563 6b65 743d 6275 636b 6574 290a 2020  ucket=bucket).  
+0000dc00: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0000dc10: 6570 7469 6f6e 2061 7320 6572 726f 723a  eption as error:
+0000dc20: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+0000dc30: 6f72 203d 2074 7261 6e73 6c61 7465 5f73  or = translate_s
+0000dc40: 335f 6572 726f 7228 6572 726f 722c 2073  3_error(error, s
+0000dc50: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000dc60: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+0000dc70: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000dc80: 6528 6572 726f 722c 0a20 2020 2020 2020  e(error,.       
+0000dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dca0: 2020 2028 5333 556e 6b6e 6f77 6e45 7272     (S3UnknownErr
+0000dcb0: 6f72 2c20 5333 436f 6e66 6967 4572 726f  or, S3ConfigErro
+0000dcc0: 722c 2053 3350 6572 6d69 7373 696f 6e45  r, S3PermissionE
+0000dcd0: 7272 6f72 2929 3a0a 2020 2020 2020 2020  rror)):.        
+0000dce0: 2020 2020 2020 2020 7261 6973 6520 6572          raise er
+0000dcf0: 726f 720a 2020 2020 2020 2020 2020 2020  ror.            
+0000dd00: 6966 2069 7369 6e73 7461 6e63 6528 6572  if isinstance(er
+0000dd10: 726f 722c 2053 3346 696c 654e 6f74 466f  ror, S3FileNotFo
+0000dd20: 756e 6445 7272 6f72 293a 0a20 2020 2020  undError):.     
+0000dd30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000dd40: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
+0000dd50: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+0000dd60: 2020 6465 6620 6d6b 6469 7228 7365 6c66    def mkdir(self
+0000dd70: 2c20 6d6f 6465 3d30 6f37 3737 2c20 7061  , mode=0o777, pa
+0000dd80: 7265 6e74 733a 2062 6f6f 6c20 3d20 4661  rents: bool = Fa
+0000dd90: 6c73 652c 2065 7869 7374 5f6f 6b3a 2062  lse, exist_ok: b
+0000dda0: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
+0000ddb0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000ddc0: 2020 4372 6561 7465 2061 6e20 7333 2064    Create an s3 d
+0000ddd0: 6972 6563 746f 7279 2e0a 2020 2020 2020  irectory..      
+0000dde0: 2020 5075 7265 6c79 2063 7265 6174 696e    Purely creatin
+0000ddf0: 6720 6469 7265 6374 6f72 7920 6973 2069  g directory is i
+0000de00: 6e76 616c 6964 2062 6563 6175 7365 2069  nvalid because i
+0000de10: 7427 7320 756e 6176 6169 6c61 626c 6520  t's unavailable 
+0000de20: 6f6e 204f 5353 2e0a 2020 2020 2020 2020  on OSS..        
+0000de30: 5468 6973 2066 756e 6374 696f 6e20 6973  This function is
+0000de40: 2074 6f20 7465 7374 2074 6865 2074 6172   to test the tar
+0000de50: 6765 7420 6275 636b 6574 2068 6176 6520  get bucket have 
+0000de60: 5752 4954 4520 6163 6365 7373 2e0a 0a20  WRITE access... 
+0000de70: 2020 2020 2020 203a 7061 7261 6d20 6d6f         :param mo
+0000de80: 6465 3a20 6d6f 6465 2069 7320 6967 6e6f  de: mode is igno
+0000de90: 7265 642c 206f 6e6c 7920 6265 2063 6f6d  red, only be com
+0000dea0: 7061 7469 626c 6520 7769 7468 2070 6174  patible with pat
+0000deb0: 686c 6962 2e50 6174 680a 2020 2020 2020  hlib.Path.      
+0000dec0: 2020 3a70 6172 616d 2070 6172 656e 7473    :param parents
+0000ded0: 3a20 7061 7265 6e74 7320 6973 2069 676e  : parents is ign
+0000dee0: 6f72 6564 2c20 6f6e 6c79 2062 6520 636f  ored, only be co
+0000def0: 6d70 6174 6962 6c65 2077 6974 6820 7061  mpatible with pa
+0000df00: 7468 6c69 622e 5061 7468 0a20 2020 2020  thlib.Path.     
+0000df10: 2020 203a 7061 7261 6d20 6578 6973 745f     :param exist_
+0000df20: 6f6b 3a20 4966 2046 616c 7365 2061 6e64  ok: If False and
+0000df30: 2074 6172 6765 7420 6469 7265 6374 6f72   target director
+0000df40: 7920 6578 6973 7473 2c20 7261 6973 6520  y exists, raise 
+0000df50: 5333 4669 6c65 4578 6973 7473 4572 726f  S3FileExistsErro
+0000df60: 720a 2020 2020 2020 2020 3a72 6169 7365  r.        :raise
+0000df70: 733a 2053 3342 7563 6b65 744e 6f74 466f  s: S3BucketNotFo
+0000df80: 756e 6445 7272 6f72 2c20 5333 4669 6c65  undError, S3File
+0000df90: 4578 6973 7473 4572 726f 720a 2020 2020  ExistsError.    
+0000dfa0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000dfb0: 6275 636b 6574 2c20 5f20 3d20 7061 7273  bucket, _ = pars
+0000dfc0: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
+0000dfd0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000dfe0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0000dff0: 2062 7563 6b65 743a 0a20 2020 2020 2020   bucket:.       
+0000e000: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
+0000e010: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+0000e020: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000e030: 2020 2745 6d70 7479 2062 7563 6b65 7420    'Empty bucket 
+0000e040: 6e61 6d65 3a20 2572 2720 2520 7365 6c66  name: %r' % self
+0000e050: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000e060: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
+0000e070: 6e6f 7420 7365 6c66 2e68 6173 6275 636b  not self.hasbuck
+0000e080: 6574 2829 3a0a 2020 2020 2020 2020 2020  et():.          
+0000e090: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+0000e0a0: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
+0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000e0c0: 4e6f 2073 7563 6820 6275 636b 6574 3a20  No such bucket: 
+0000e0d0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+0000e0e0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000e0f0: 2020 2020 2020 2069 6620 6578 6973 745f         if exist_
+0000e100: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+0000e110: 6966 2073 656c 662e 6973 5f66 696c 6528  if self.is_file(
+0000e120: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000e130: 2020 2072 6169 7365 2053 3346 696c 6545     raise S3FileE
+0000e140: 7869 7374 7345 7272 6f72 280a 2020 2020  xistsError(.    
+0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e160: 2746 696c 6520 6578 6973 7473 3a20 2572  'File exists: %r
+0000e170: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+0000e180: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+0000e190: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0000e1a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000e1b0: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+0000e1c0: 2020 2020 2020 7261 6973 6520 5333 4669        raise S3Fi
+0000e1d0: 6c65 4578 6973 7473 4572 726f 7228 2746  leExistsError('F
+0000e1e0: 696c 6520 6578 6973 7473 3a20 2572 2720  ile exists: %r' 
+0000e1f0: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
+0000e200: 5f70 726f 746f 636f 6c29 0a0a 2020 2020  _protocol)..    
+0000e210: 6465 6620 6d6f 7665 2873 656c 662c 2064  def move(self, d
+0000e220: 7374 5f75 726c 3a20 5061 7468 4c69 6b65  st_url: PathLike
+0000e230: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0000e240: 2020 2027 2727 0a20 2020 2020 2020 204d     '''.        M
+0000e250: 6f76 6520 6669 6c65 2f64 6972 6563 746f  ove file/directo
+0000e260: 7279 2070 6174 6820 6672 6f6d 2073 7263  ry path from src
+0000e270: 5f75 726c 2074 6f20 6473 745f 7572 6c0a  _url to dst_url.
+0000e280: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000e290: 6473 745f 7572 6c3a 2047 6976 656e 2064  dst_url: Given d
+0000e2a0: 6573 7469 6e61 7469 6f6e 2070 6174 680a  estination path.
+0000e2b0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000e2c0: 2020 2020 666f 7220 7372 635f 6669 6c65      for src_file
+0000e2d0: 5f70 6174 682c 2064 7374 5f66 696c 655f  _path, dst_file_
+0000e2e0: 7061 7468 2069 6e20 5f73 335f 7363 616e  path in _s3_scan
+0000e2f0: 5f70 6169 7273 280a 2020 2020 2020 2020  _pairs(.        
+0000e300: 2020 2020 2020 2020 7365 6c66 2e70 6174          self.pat
+0000e310: 685f 7769 7468 5f70 726f 746f 636f 6c2c  h_with_protocol,
+0000e320: 2064 7374 5f75 726c 293a 0a20 2020 2020   dst_url):.     
+0000e330: 2020 2020 2020 2053 3350 6174 6828 7372         S3Path(sr
+0000e340: 635f 6669 6c65 5f70 6174 6829 2e72 656e  c_file_path).ren
+0000e350: 616d 6528 6473 745f 6669 6c65 5f70 6174  ame(dst_file_pat
+0000e360: 6829 0a0a 2020 2020 6465 6620 7265 6d6f  h)..    def remo
+0000e370: 7665 2873 656c 662c 206d 6973 7369 6e67  ve(self, missing
+0000e380: 5f6f 6b3a 2062 6f6f 6c20 3d20 4661 6c73  _ok: bool = Fals
+0000e390: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+0000e3a0: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000e3b0: 5265 6d6f 7665 2074 6865 2066 696c 6520  Remove the file 
+0000e3c0: 6f72 2064 6972 6563 746f 7279 206f 6e20  or directory on 
+0000e3d0: 7333 2c20 6073 333a 2f2f 6020 616e 6420  s3, `s3://` and 
+0000e3e0: 6073 333a 2f2f 6275 636b 6574 6020 6172  `s3://bucket` ar
+0000e3f0: 6520 6e6f 7420 7065 726d 6974 7465 6420  e not permitted 
+0000e400: 746f 2072 656d 6f76 650a 0a20 2020 2020  to remove..     
+0000e410: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
+0000e420: 675f 6f6b 3a20 6966 2046 616c 7365 2061  g_ok: if False a
+0000e430: 6e64 2074 6172 6765 7420 6669 6c65 2f64  nd target file/d
+0000e440: 6972 6563 746f 7279 206e 6f74 2065 7869  irectory not exi
+0000e450: 7374 732c 2072 6169 7365 2053 3346 696c  sts, raise S3Fil
+0000e460: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
+0000e470: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+0000e480: 5333 5065 726d 6973 7369 6f6e 4572 726f  S3PermissionErro
+0000e490: 722c 2053 3346 696c 654e 6f74 466f 756e  r, S3FileNotFoun
+0000e4a0: 6445 7272 6f72 2c20 556e 7375 7070 6f72  dError, Unsuppor
+0000e4b0: 7465 6445 7272 6f72 0a20 2020 2020 2020  tedError.       
+0000e4c0: 2027 2727 0a20 2020 2020 2020 2062 7563   '''.        buc
+0000e4d0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+0000e4e0: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
+0000e4f0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+0000e500: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000e510: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
+0000e520: 2020 2020 6966 206e 6f74 206b 6579 3a0a      if not key:.
+0000e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e540: 7261 6973 6520 556e 7375 7070 6f72 7465  raise Unsupporte
+0000e550: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
+0000e560: 2020 2020 2020 2020 2020 2020 2752 656d              'Rem
+0000e570: 6f76 6520 7768 6f6c 6520 7333 272c 2073  ove whole s3', s
+0000e580: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000e590: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+0000e5a0: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
+0000e5b0: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
+0000e5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e5d0: 2027 456d 7074 7920 6275 636b 6574 206e   'Empty bucket n
+0000e5e0: 616d 653a 2025 7227 2025 2073 656c 662e  ame: %r' % self.
+0000e5f0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000e600: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
+0000e610: 6f74 206b 6579 3a0a 2020 2020 2020 2020  ot key:.        
+0000e620: 2020 2020 7261 6973 6520 556e 7375 7070      raise Unsupp
+0000e630: 6f72 7465 6445 7272 6f72 2827 5265 6d6f  ortedError('Remo
+0000e640: 7665 2062 7563 6b65 7427 2c20 7365 6c66  ve bucket', self
+0000e650: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000e660: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
+0000e670: 6e6f 7420 7365 6c66 2e65 7869 7374 7328  not self.exists(
+0000e680: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0000e690: 6620 6d69 7373 696e 675f 6f6b 3a0a 2020  f missing_ok:.  
+0000e6a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000e6b0: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0000e6c0: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
+0000e6d0: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
+0000e6e0: 2020 2020 2020 2020 2020 2020 274e 6f20              'No 
+0000e6f0: 7375 6368 2066 696c 6520 6f72 2064 6972  such file or dir
+0000e700: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
+0000e710: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000e720: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
+0000e730: 636c 6965 6e74 203d 2073 656c 662e 5f63  client = self._c
+0000e740: 6c69 656e 740a 2020 2020 2020 2020 7769  lient.        wi
+0000e750: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
+0000e760: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
+0000e770: 5f70 726f 746f 636f 6c29 3a0a 2020 2020  _protocol):.    
+0000e780: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000e790: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
+0000e7a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0000e7b0: 742e 6465 6c65 7465 5f6f 626a 6563 7428  t.delete_object(
+0000e7c0: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
+0000e7d0: 6579 3d6b 6579 290a 2020 2020 2020 2020  ey=key).        
+0000e7e0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0000e7f0: 2020 2020 2020 2020 2020 2070 7265 6669             prefi
+0000e800: 7820 3d20 5f62 6563 6f6d 655f 7072 6566  x = _become_pref
+0000e810: 6978 286b 6579 290a 2020 2020 2020 2020  ix(key).        
+0000e820: 2020 2020 746f 7461 6c5f 636f 756e 742c      total_count,
+0000e830: 2065 7272 6f72 5f63 6f75 6e74 203d 2030   error_count = 0
+0000e840: 2c20 300a 2020 2020 2020 2020 2020 2020  , 0.            
+0000e850: 666f 7220 7265 7370 2069 6e20 5f6c 6973  for resp in _lis
+0000e860: 745f 6f62 6a65 6374 735f 7265 6375 7273  t_objects_recurs
+0000e870: 6976 6528 636c 6965 6e74 2c20 6275 636b  ive(client, buck
+0000e880: 6574 2c20 7072 6566 6978 293a 0a20 2020  et, prefix):.   
+0000e890: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000e8a0: 2743 6f6e 7465 6e74 7327 2069 6e20 7265  'Contents' in re
+0000e8b0: 7370 3a0a 2020 2020 2020 2020 2020 2020  sp:.            
+0000e8c0: 2020 2020 2020 2020 6b65 7973 203d 205b          keys = [
+0000e8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e8e0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0000e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e900: 2020 2020 2020 2027 4b65 7927 3a20 636f         'Key': co
+0000e910: 6e74 656e 745b 274b 6579 275d 0a20 2020  ntent['Key'].   
+0000e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e930: 2020 2020 207d 2066 6f72 2063 6f6e 7465       } for conte
+0000e940: 6e74 2069 6e20 7265 7370 5b27 436f 6e74  nt in resp['Cont
+0000e950: 656e 7473 275d 0a20 2020 2020 2020 2020  ents'].         
+0000e960: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+0000e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e980: 2074 6f74 616c 5f63 6f75 6e74 202b 3d20   total_count += 
+0000e990: 6c65 6e28 6b65 7973 290a 2020 2020 2020  len(keys).      
+0000e9a0: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000e9b0: 726f 7273 203d 205b 5d0a 2020 2020 2020  rors = [].      
+0000e9c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000e9d0: 7472 6965 7320 3d20 320a 2020 2020 2020  tries = 2.      
+0000e9e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0000e9f0: 7472 795f 696e 7465 7276 616c 203d 206d  try_interval = m
+0000ea00: 696e 2830 2e31 202a 2032 2a2a 7265 7472  in(0.1 * 2**retr
+0000ea10: 6965 732c 2033 3029 0a20 2020 2020 2020  ies, 30).       
+0000ea20: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000ea30: 2069 2069 6e20 7261 6e67 6528 7265 7472   i in range(retr
+0000ea40: 6965 7329 3a0a 2020 2020 2020 2020 2020  ies):.          
+0000ea50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000ea60: 646f 633a 2068 7474 7073 3a2f 2f62 6f74  doc: https://bot
+0000ea70: 6f33 2e61 6d61 7a6f 6e61 7773 2e63 6f6d  o3.amazonaws.com
+0000ea80: 2f76 312f 646f 6375 6d65 6e74 6174 696f  /v1/documentatio
+0000ea90: 6e2f 6170 692f 6c61 7465 7374 2f72 6566  n/api/latest/ref
+0000eaa0: 6572 656e 6365 2f73 6572 7669 6365 732f  erence/services/
+0000eab0: 7333 2e68 746d 6c23 5333 2e43 6c69 656e  s3.html#S3.Clien
+0000eac0: 742e 6465 6c65 7465 5f6f 626a 6563 7473  t.delete_objects
+0000ead0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eae0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0000eaf0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
 0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb10: 2020 2020 2020 2025 2028 0a20 2020 2020         % (.     
+0000eb10: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
 0000eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb40: 2020 2069 202b 2031 2c20 6572 726f 725f     i + 1, error_
-0000eb50: 696e 666f 5b27 4b65 7927 5d2c 0a20 2020  info['Key'],.   
-0000eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb80: 2020 2020 2065 7272 6f72 5f69 6e66 6f5b       error_info[
-0000eb90: 2743 6f64 6527 5d2c 0a20 2020 2020 2020  'Code'],.       
-0000eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebc0: 2065 7272 6f72 5f69 6e66 6f5b 274d 6573   error_info['Mes
-0000ebd0: 7361 6765 275d 2929 0a20 2020 2020 2020  sage'])).       
-0000ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebf0: 2020 2020 2020 2020 206b 6579 732e 6170           keys.ap
-0000ec00: 7065 6e64 287b 274b 6579 273a 2065 7272  pend({'Key': err
-0000ec10: 6f72 5f69 6e66 6f5b 274b 6579 275d 7d29  or_info['Key']})
-0000ec20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ec30: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000ec40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec60: 2020 2065 7272 6f72 732e 6170 7065 6e64     errors.append
-0000ec70: 2865 7272 6f72 5f69 6e66 6f29 0a20 2020  (error_info).   
+0000eb30: 7265 7370 6f6e 7365 203d 2063 6c69 656e  response = clien
+0000eb40: 742e 6465 6c65 7465 5f6f 626a 6563 7473  t.delete_objects
+0000eb50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000eb60: 2020 2020 2020 2020 2020 2020 2020 4275                Bu
+0000eb70: 636b 6574 3d62 7563 6b65 742c 2044 656c  cket=bucket, Del
+0000eb80: 6574 653d 7b27 4f62 6a65 6374 7327 3a20  ete={'Objects': 
+0000eb90: 6b65 7973 7d29 0a20 2020 2020 2020 2020  keys}).         
+0000eba0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0000ebb0: 6579 7320 3d20 5b5d 0a20 2020 2020 2020  eys = [].       
+0000ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebd0: 2066 6f72 2065 7272 6f72 5f69 6e66 6f20   for error_info 
+0000ebe0: 696e 2072 6573 706f 6e73 652e 6765 7428  in response.get(
+0000ebf0: 2745 7272 6f72 7327 2c20 5b5d 293a 0a20  'Errors', []):. 
+0000ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec10: 2020 2020 2020 2020 2020 2069 6620 7333             if s3
+0000ec20: 5f65 7272 6f72 5f63 6f64 655f 7368 6f75  _error_code_shou
+0000ec30: 6c64 5f72 6574 7279 280a 2020 2020 2020  ld_retry(.      
+0000ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec50: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000ec60: 726f 725f 696e 666f 2e67 6574 2827 436f  ror_info.get('Co
+0000ec70: 6465 2729 293a 0a20 2020 2020 2020 2020  de')):.         
 0000ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec90: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
-0000eca0: 7265 7472 795f 696e 7465 7276 616c 290a  retry_interval).
+0000ec90: 2020 2020 2020 2065 7272 6f72 5f6c 6f67         error_log
+0000eca0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
 0000ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecc0: 2020 2020 666f 7220 6572 726f 725f 696e      for error_in
-0000ecd0: 666f 2069 6e20 6572 726f 7273 3a0a 2020  fo in errors:.  
-0000ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecf0: 2020 2020 2020 6572 726f 725f 6c6f 6767        error_logg
-0000ed00: 6572 2e65 7272 6f72 280a 2020 2020 2020  er.error(.      
+0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecd0: 2022 7265 7472 7920 2573 2074 696d 6573   "retry %s times
+0000ece0: 2c20 7265 6d6f 7669 6e67 2066 696c 653a  , removing file:
+0000ecf0: 2025 732c 2077 6974 6820 6572 726f 7220   %s, with error 
+0000ed00: 2573 3a20 2573 220a 2020 2020 2020 2020  %s: %s".        
 0000ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed20: 2020 2020 2020 2266 6169 6c65 6420 7265        "failed re
-0000ed30: 6d6f 7665 2066 696c 653a 2025 732c 2077  move file: %s, w
-0000ed40: 6974 6820 6572 726f 7220 2573 3a20 2573  ith error %s: %s
-0000ed50: 2220 2520 280a 2020 2020 2020 2020 2020  " % (.          
-0000ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed70: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
-0000ed80: 5b27 4b65 7927 5d2c 2065 7272 6f72 5f69  ['Key'], error_i
-0000ed90: 6e66 6f5b 2743 6f64 6527 5d2c 0a20 2020  nfo['Code'],.   
-0000eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000edb0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0000edc0: 6f72 5f69 6e66 6f5b 274d 6573 7361 6765  or_info['Message
-0000edd0: 275d 2929 0a20 2020 2020 2020 2020 2020  '])).           
-0000ede0: 2020 2020 2020 2020 2065 7272 6f72 5f63           error_c
-0000edf0: 6f75 6e74 202b 3d20 6c65 6e28 6572 726f  ount += len(erro
-0000ee00: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
-0000ee10: 6966 2065 7272 6f72 5f63 6f75 6e74 203e  if error_count >
-0000ee20: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0000ee30: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
-0000ee40: 2266 6169 6c65 6420 7265 6d6f 7665 2070  "failed remove p
-0000ee50: 6174 683a 2025 732c 2074 6f74 616c 2066  ath: %s, total f
-0000ee60: 696c 6520 636f 756e 743a 2025 732c 2066  ile count: %s, f
-0000ee70: 6169 6c65 6420 636f 756e 743a 2025 7322  ailed count: %s"
-0000ee80: 2025 2028 0a20 2020 2020 2020 2020 2020   % (.           
-0000ee90: 2020 2020 2020 2020 2073 656c 662e 7061           self.pa
-0000eea0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000eeb0: 2c20 746f 7461 6c5f 636f 756e 742c 2065  , total_count, e
-0000eec0: 7272 6f72 5f63 6f75 6e74 290a 2020 2020  rror_count).    
-0000eed0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000eee0: 6520 5333 556e 6b6e 6f77 6e45 7272 6f72  e S3UnknownError
-0000eef0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000ef00: 2020 2020 2020 4578 6365 7074 696f 6e28        Exception(
-0000ef10: 6572 726f 725f 6d73 6729 2c20 7365 6c66  error_msg), self
-0000ef20: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000ef30: 636f 6c29 0a0a 2020 2020 6465 6620 7265  col)..    def re
-0000ef40: 6e61 6d65 2873 656c 662c 2064 7374 5f70  name(self, dst_p
-0000ef50: 6174 683a 2050 6174 684c 696b 6529 202d  ath: PathLike) -
-0000ef60: 3e20 2753 3350 6174 6827 3a0a 2020 2020  > 'S3Path':.    
-0000ef70: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000ef80: 4d6f 7665 2073 3320 6669 6c65 2070 6174  Move s3 file pat
-0000ef90: 6820 6672 6f6d 2073 7263 5f75 726c 2074  h from src_url t
-0000efa0: 6f20 6473 745f 7572 6c0a 0a20 2020 2020  o dst_url..     
-0000efb0: 2020 203a 7061 7261 6d20 6473 745f 7061     :param dst_pa
-0000efc0: 7468 3a20 4769 7665 6e20 6465 7374 696e  th: Given destin
-0000efd0: 6174 696f 6e20 7061 7468 0a20 2020 2020  ation path.     
-0000efe0: 2020 2027 2727 0a20 2020 2020 2020 2073     '''.        s
-0000eff0: 335f 7265 6e61 6d65 2873 656c 662e 7061  3_rename(self.pa
-0000f000: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000f010: 2c20 6473 745f 7061 7468 290a 2020 2020  , dst_path).    
-0000f020: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000f030: 6672 6f6d 5f70 6174 6828 6473 745f 7061  from_path(dst_pa
-0000f040: 7468 290a 0a20 2020 2064 6566 2073 6361  th)..    def sca
-0000f050: 6e28 7365 6c66 2c20 6d69 7373 696e 675f  n(self, missing_
-0000f060: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
-0000f070: 0a20 2020 2020 2020 2020 2020 2020 666f  .             fo
-0000f080: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
-0000f090: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
-0000f0a0: 6174 6f72 5b73 7472 5d3a 0a20 2020 2020  ator[str]:.     
-0000f0b0: 2020 2027 2727 0a20 2020 2020 2020 2049     '''.        I
-0000f0c0: 7465 7261 7469 7665 6c79 2074 7261 7665  teratively trave
-0000f0d0: 7273 6520 6f6e 6c79 2066 696c 6573 2069  rse only files i
-0000f0e0: 6e20 6769 7665 6e20 7333 2064 6972 6563  n given s3 direc
-0000f0f0: 746f 7279 2c20 696e 2061 6c70 6861 6265  tory, in alphabe
-0000f100: 7469 6361 6c20 6f72 6465 722e 0a20 2020  tical order..   
-0000f110: 2020 2020 2045 7665 7279 2069 7465 7261       Every itera
-0000f120: 7469 6f6e 206f 6e20 6765 6e65 7261 746f  tion on generato
-0000f130: 7220 7969 656c 6473 2061 2070 6174 6820  r yields a path 
-0000f140: 7374 7269 6e67 2e0a 0a20 2020 2020 2020  string...       
-0000f150: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
-0000f160: 6669 6c65 2070 6174 682c 2079 6965 6c64  file path, yield
-0000f170: 7320 7468 6520 6669 6c65 206f 6e6c 790a  s the file only.
-0000f180: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
-0000f190: 6c20 6973 2061 206e 6f6e 2d65 7869 7374  l is a non-exist
-0000f1a0: 656e 7420 7061 7468 2c20 7265 7475 726e  ent path, return
-0000f1b0: 2061 6e20 656d 7074 7920 6765 6e65 7261   an empty genera
-0000f1c0: 746f 720a 2020 2020 2020 2020 4966 2073  tor.        If s
-0000f1d0: 335f 7572 6c20 6973 2061 2062 7563 6b65  3_url is a bucke
-0000f1e0: 7420 7061 7468 2c20 7265 7475 726e 2061  t path, return a
-0000f1f0: 6c6c 2066 696c 6520 7061 7468 7320 696e  ll file paths in
-0000f200: 2074 6865 2062 7563 6b65 740a 2020 2020   the bucket.    
-0000f210: 2020 2020 4966 2073 335f 7572 6c20 6973      If s3_url is
-0000f220: 2061 6e20 656d 7074 7920 6275 636b 6574   an empty bucket
-0000f230: 2c20 7265 7475 726e 2061 6e20 656d 7074  , return an empt
-0000f240: 7920 6765 6e65 7261 746f 720a 2020 2020  y generator.    
-0000f250: 2020 2020 4966 2073 335f 7572 6c20 646f      If s3_url do
-0000f260: 6573 6e27 7420 636f 6e74 6169 6e20 616e  esn't contain an
-0000f270: 7920 6275 636b 6574 2c20 7768 6963 6820  y bucket, which 
-0000f280: 6973 2073 335f 7572 6c20 3d3d 2027 7333  is s3_url == 's3
-0000f290: 3a2f 2f27 2c20 7261 6973 6520 556e 7375  ://', raise Unsu
-0000f2a0: 7070 6f72 7465 6445 7272 6f72 2e20 7761  pportedError. wa
-0000f2b0: 6c6b 2829 206f 6e20 636f 6d70 6c65 7465  lk() on complete
-0000f2c0: 2073 3320 6973 206e 6f74 2073 7570 706f   s3 is not suppo
-0000f2d0: 7274 6564 2069 6e20 6d65 6766 696c 650a  rted in megfile.
-0000f2e0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000f2f0: 6d69 7373 696e 675f 6f6b 3a20 4966 2046  missing_ok: If F
-0000f300: 616c 7365 2061 6e64 2074 6865 7265 2773  alse and there's
-0000f310: 206e 6f20 6669 6c65 2069 6e20 7468 6520   no file in the 
-0000f320: 6469 7265 6374 6f72 792c 2072 6169 7365  directory, raise
-0000f330: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
-0000f340: 6f72 0a20 2020 2020 2020 203a 7261 6973  or.        :rais
-0000f350: 6573 3a20 556e 7375 7070 6f72 7465 6445  es: UnsupportedE
-0000f360: 7272 6f72 0a20 2020 2020 2020 203a 7265  rror.        :re
-0000f370: 7475 726e 733a 2041 2066 696c 6520 7061  turns: A file pa
-0000f380: 7468 2067 656e 6572 6174 6f72 0a20 2020  th generator.   
-0000f390: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000f3a0: 2073 6361 6e5f 7374 6174 5f69 7465 7220   scan_stat_iter 
-0000f3b0: 3d20 7365 6c66 2e73 6361 6e5f 7374 6174  = self.scan_stat
-0000f3c0: 280a 2020 2020 2020 2020 2020 2020 6d69  (.            mi
-0000f3d0: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
-0000f3e0: 5f6f 6b2c 2066 6f6c 6c6f 776c 696e 6b73  _ok, followlinks
-0000f3f0: 3d66 6f6c 6c6f 776c 696e 6b73 290a 0a20  =followlinks).. 
-0000f400: 2020 2020 2020 2064 6566 2063 7265 6174         def creat
-0000f410: 655f 6765 6e65 7261 746f 7228 2920 2d3e  e_generator() ->
-0000f420: 2049 7465 7261 746f 725b 7374 725d 3a0a   Iterator[str]:.
-0000f430: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000f440: 6669 6c65 5f65 6e74 7279 2069 6e20 7363  file_entry in sc
-0000f450: 616e 5f73 7461 745f 6974 6572 3a0a 2020  an_stat_iter:.  
-0000f460: 2020 2020 2020 2020 2020 2020 2020 7969                yi
-0000f470: 656c 6420 6669 6c65 5f65 6e74 7279 2e70  eld file_entry.p
-0000f480: 6174 680a 0a20 2020 2020 2020 2072 6574  ath..        ret
-0000f490: 7572 6e20 6372 6561 7465 5f67 656e 6572  urn create_gener
-0000f4a0: 6174 6f72 2829 0a0a 2020 2020 6465 6620  ator()..    def 
-0000f4b0: 7363 616e 5f73 7461 7428 7365 6c66 2c20  scan_stat(self, 
-0000f4c0: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
-0000f4d0: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-0000f4e0: 2020 2020 2020 2020 2020 2066 6f6c 6c6f             follo
-0000f4f0: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-0000f500: 616c 7365 2920 2d3e 2049 7465 7261 746f  alse) -> Iterato
-0000f510: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
-0000f520: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000f530: 2020 4974 6572 6174 6976 656c 7920 7472    Iteratively tr
-0000f540: 6176 6572 7365 206f 6e6c 7920 6669 6c65  averse only file
-0000f550: 7320 696e 2067 6976 656e 2064 6972 6563  s in given direc
-0000f560: 746f 7279 2c20 696e 2061 6c70 6861 6265  tory, in alphabe
-0000f570: 7469 6361 6c20 6f72 6465 722e 0a20 2020  tical order..   
-0000f580: 2020 2020 2045 7665 7279 2069 7465 7261       Every itera
-0000f590: 7469 6f6e 206f 6e20 6765 6e65 7261 746f  tion on generato
-0000f5a0: 7220 7969 656c 6473 2061 2074 7570 6c65  r yields a tuple
-0000f5b0: 206f 6620 7061 7468 2073 7472 696e 6720   of path string 
-0000f5c0: 616e 6420 6669 6c65 2073 7461 740a 0a20  and file stat.. 
-0000f5d0: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
-0000f5e0: 7373 696e 675f 6f6b 3a20 4966 2046 616c  ssing_ok: If Fal
-0000f5f0: 7365 2061 6e64 2074 6865 7265 2773 206e  se and there's n
-0000f600: 6f20 6669 6c65 2069 6e20 7468 6520 6469  o file in the di
-0000f610: 7265 6374 6f72 792c 2072 6169 7365 2046  rectory, raise F
-0000f620: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000f630: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000f640: 3a20 556e 7375 7070 6f72 7465 6445 7272  : UnsupportedErr
-0000f650: 6f72 0a20 2020 2020 2020 203a 7265 7475  or.        :retu
-0000f660: 726e 733a 2041 2066 696c 6520 7061 7468  rns: A file path
-0000f670: 2067 656e 6572 6174 6f72 0a20 2020 2020   generator.     
-0000f680: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-0000f690: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-0000f6a0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-0000f6b0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000f6c0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-0000f6d0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-0000f6e0: 2020 2020 2020 7261 6973 6520 556e 7375        raise Unsu
-0000f6f0: 7070 6f72 7465 6445 7272 6f72 2827 5363  pportedError('Sc
-0000f700: 616e 2077 686f 6c65 2073 3327 2c20 7365  an whole s3', se
-0000f710: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000f720: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
-0000f730: 6465 6620 6372 6561 7465 5f67 656e 6572  def create_gener
-0000f740: 6174 6f72 2829 202d 3e20 4974 6572 6174  ator() -> Iterat
-0000f750: 6f72 5b46 696c 6545 6e74 7279 5d3a 0a20  or[FileEntry]:. 
-0000f760: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0000f770: 7420 7365 6c66 2e69 735f 6469 7228 293a  t self.is_dir():
-0000f780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f790: 2069 6620 7365 6c66 2e69 735f 6669 6c65   if self.is_file
-0000f7a0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0000f7b0: 2020 2020 2020 2020 2320 4f6e 2073 332c          # On s3,
-0000f7c0: 2066 696c 6520 616e 6420 6469 7265 6374   file and direct
-0000f7d0: 6f72 7920 6d61 7920 6265 206f 6620 7361  ory may be of sa
-0000f7e0: 6d65 206e 616d 6520 616e 6420 6c65 7665  me name and leve
-0000f7f0: 6c2c 2073 6f20 6e65 6564 2074 6f20 7465  l, so need to te
-0000f800: 7374 2074 6865 2070 6174 6820 6973 2066  st the path is f
-0000f810: 696c 6520 6f72 2064 6972 6563 746f 7279  ile or directory
-0000f820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f830: 2020 2020 2079 6965 6c64 2046 696c 6545       yield FileE
-0000f840: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
-0000f850: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0000f860: 6c66 2e6e 616d 652c 2066 7370 6174 6828  lf.name, fspath(
-0000f870: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-0000f880: 726f 746f 636f 6c29 2c0a 2020 2020 2020  rotocol),.      
-0000f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8a0: 2020 7365 6c66 2e73 7461 7428 666f 6c6c    self.stat(foll
-0000f8b0: 6f77 5f73 796d 6c69 6e6b 733d 666f 6c6c  ow_symlinks=foll
-0000f8c0: 6f77 6c69 6e6b 7329 290a 2020 2020 2020  owlinks)).      
-0000f8d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000f8e0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0000f8f0: 206e 6f74 206b 6579 2e65 6e64 7377 6974   not key.endswit
-0000f900: 6828 272f 2729 2061 6e64 2073 656c 662e  h('/') and self.
-0000f910: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
-0000f920: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-0000f930: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
-0000f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f950: 7365 6c66 2e6e 616d 652c 2066 7370 6174  self.name, fspat
-0000f960: 6828 7365 6c66 2e70 6174 685f 7769 7468  h(self.path_with
-0000f970: 5f70 726f 746f 636f 6c29 2c0a 2020 2020  _protocol),.    
-0000f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f990: 7365 6c66 2e73 7461 7428 666f 6c6c 6f77  self.stat(follow
-0000f9a0: 5f73 796d 6c69 6e6b 733d 666f 6c6c 6f77  _symlinks=follow
-0000f9b0: 6c69 6e6b 7329 290a 0a20 2020 2020 2020  links))..       
-0000f9c0: 2020 2020 2070 7265 6669 7820 3d20 5f62       prefix = _b
-0000f9d0: 6563 6f6d 655f 7072 6566 6978 286b 6579  ecome_prefix(key
-0000f9e0: 290a 2020 2020 2020 2020 2020 2020 636c  ).            cl
-0000f9f0: 6965 6e74 203d 2073 656c 662e 5f63 6c69  ient = self._cli
-0000fa00: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-0000fa10: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
-0000fa20: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
-0000fa30: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
-0000fa40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000fa50: 7220 7265 7370 2069 6e20 5f6c 6973 745f  r resp in _list_
-0000fa60: 6f62 6a65 6374 735f 7265 6375 7273 6976  objects_recursiv
-0000fa70: 6528 636c 6965 6e74 2c20 6275 636b 6574  e(client, bucket
-0000fa80: 2c20 7072 6566 6978 293a 0a20 2020 2020  , prefix):.     
-0000fa90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000faa0: 6f72 2063 6f6e 7465 6e74 2069 6e20 7265  or content in re
-0000fab0: 7370 2e67 6574 2827 436f 6e74 656e 7473  sp.get('Contents
-0000fac0: 272c 205b 5d29 3a0a 2020 2020 2020 2020  ', []):.        
-0000fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fae0: 6675 6c6c 5f70 6174 6820 3d20 7333 5f70  full_path = s3_p
-0000faf0: 6174 685f 6a6f 696e 280a 2020 2020 2020  ath_join(.      
-0000fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb10: 2020 2020 2020 6627 7b73 656c 662e 5f70        f'{self._p
-0000fb20: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
-0000fb30: 6669 6c65 7d3a 2f2f 272c 2062 7563 6b65  file}://', bucke
-0000fb40: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0000fb50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000fb60: 6f6e 7465 6e74 5b27 4b65 7927 5d29 0a20  ontent['Key']). 
-0000fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb80: 2020 2020 2020 2079 6965 6c64 2046 696c         yield Fil
-0000fb90: 6545 6e74 7279 280a 2020 2020 2020 2020  eEntry(.        
-0000fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbb0: 2020 2020 5333 5061 7468 2866 756c 6c5f      S3Path(full_
-0000fbc0: 7061 7468 292e 6e61 6d65 2c20 6675 6c6c  path).name, full
-0000fbd0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbf0: 2020 205f 6d61 6b65 5f73 7461 7428 636f     _make_stat(co
-0000fc00: 6e74 656e 7429 290a 0a20 2020 2020 2020  ntent))..       
-0000fc10: 2072 6574 7572 6e20 5f63 7265 6174 655f   return _create_
-0000fc20: 6d69 7373 696e 675f 6f6b 5f67 656e 6572  missing_ok_gener
-0000fc30: 6174 6f72 280a 2020 2020 2020 2020 2020  ator(.          
-0000fc40: 2020 6372 6561 7465 5f67 656e 6572 6174    create_generat
-0000fc50: 6f72 2829 2c20 6d69 7373 696e 675f 6f6b  or(), missing_ok
-0000fc60: 2c0a 2020 2020 2020 2020 2020 2020 5333  ,.            S3
-0000fc70: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000fc80: 7228 274e 6f20 6d61 7463 6820 6669 6c65  r('No match file
-0000fc90: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-0000fca0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000fcb0: 290a 0a20 2020 2064 6566 2073 6361 6e64  )..    def scand
-0000fcc0: 6972 2873 656c 662c 2066 6f6c 6c6f 776c  ir(self, followl
-0000fcd0: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
-0000fce0: 7365 2920 2d3e 2049 7465 7261 746f 725b  se) -> Iterator[
-0000fcf0: 4669 6c65 456e 7472 795d 3a0a 2020 2020  FileEntry]:.    
-0000fd00: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-0000fd10: 4765 7420 616c 6c20 636f 6e74 656e 7473  Get all contents
-0000fd20: 206f 6620 6769 7665 6e20 7333 5f75 726c   of given s3_url
-0000fd30: 2c20 7468 6520 6f72 6465 7220 6f66 2072  , the order of r
-0000fd40: 6573 756c 7420 6973 206e 6f74 2067 7561  esult is not gua
-0000fd50: 7261 6e74 6565 642e 0a0a 2020 2020 2020  ranteed...      
-0000fd60: 2020 3a72 6574 7572 6e73 3a20 416c 6c20    :returns: All 
-0000fd70: 636f 6e74 656e 7473 2068 6176 6520 7072  contents have pr
-0000fd80: 6566 6978 206f 6620 7333 5f75 726c 0a20  efix of s3_url. 
-0000fd90: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
-0000fda0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
-0000fdb0: 726f 722c 2053 334e 6f74 4144 6972 6563  ror, S3NotADirec
-0000fdc0: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
-0000fdd0: 2020 2727 270a 2020 2020 2020 2020 6275    '''.        bu
-0000fde0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-0000fdf0: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-0000fe00: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000fe10: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0000fe20: 2062 7563 6b65 7420 616e 6420 6b65 793a   bucket and key:
-0000fe30: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-0000fe40: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-0000fe50: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
-0000fe60: 2020 2020 2020 2020 2020 2745 6d70 7479            'Empty
-0000fe70: 2062 7563 6b65 7420 6e61 6d65 3a20 2572   bucket name: %r
-0000fe80: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-0000fe90: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
-0000fea0: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
-0000feb0: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-0000fec0: 2020 2020 2072 6169 7365 2053 334e 6f74       raise S3Not
-0000fed0: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
-0000fee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fef0: 2027 4e6f 7420 6120 6469 7265 6374 6f72   'Not a director
-0000ff00: 793a 2025 7227 2025 2073 656c 662e 7061  y: %r' % self.pa
-0000ff10: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-0000ff20: 290a 2020 2020 2020 2020 656c 6966 206e  ).        elif n
-0000ff30: 6f74 2073 656c 662e 6973 5f64 6972 2829  ot self.is_dir()
-0000ff40: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-0000ff50: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
-0000ff60: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
-0000ff70: 2020 2020 2020 2020 2027 4e6f 2073 7563           'No suc
-0000ff80: 6820 6469 7265 6374 6f72 793a 2025 7227  h directory: %r'
-0000ff90: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
-0000ffa0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000ffb0: 2020 2020 7072 6566 6978 203d 205f 6265      prefix = _be
-0000ffc0: 636f 6d65 5f70 7265 6669 7828 6b65 7929  come_prefix(key)
-0000ffd0: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
-0000ffe0: 3d20 7365 6c66 2e5f 636c 6965 6e74 0a0a  = self._client..
-0000fff0: 2020 2020 2020 2020 2320 496e 206f 7264          # In ord
-00010000: 6572 2074 6f20 646f 2063 6865 636b 206f  er to do check o
-00010010: 6e20 6372 6561 7469 6f6e 2c0a 2020 2020  n creation,.    
-00010020: 2020 2020 2320 7765 206e 6565 6420 746f      # we need to
-00010030: 2077 7261 7020 7468 6520 6974 6572 6174   wrap the iterat
-00010040: 6f72 2069 6e20 616e 6f74 6865 7220 6675  or in another fu
-00010050: 6e63 7469 6f6e 0a20 2020 2020 2020 2064  nction.        d
-00010060: 6566 2063 7265 6174 655f 6765 6e65 7261  ef create_genera
-00010070: 746f 7228 2920 2d3e 2049 7465 7261 746f  tor() -> Iterato
-00010080: 725b 4669 6c65 456e 7472 795d 3a0a 2020  r[FileEntry]:.  
-00010090: 2020 2020 2020 2020 2020 7769 7468 2072            with r
-000100a0: 6169 7365 5f73 335f 6572 726f 7228 7365  aise_s3_error(se
-000100b0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-000100c0: 746f 636f 6c29 3a0a 0a20 2020 2020 2020  tocol):..       
-000100d0: 2020 2020 2020 2020 2064 6566 2067 656e           def gen
-000100e0: 6572 6174 655f 7333 5f70 6174 6828 0a20  erate_s3_path(. 
-000100f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010100: 2020 2020 2020 2070 726f 746f 636f 6c3a         protocol:
-00010110: 2073 7472 2c20 6275 636b 6574 3a20 7374   str, bucket: st
-00010120: 722c 206b 6579 3a20 7374 7229 202d 3e20  r, key: str) -> 
-00010130: 7374 723a 0a20 2020 2020 2020 2020 2020  str:.           
-00010140: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00010150: 2225 733a 2f2f 2573 2f25 7322 2025 2028  "%s://%s/%s" % (
-00010160: 7072 6f74 6f63 6f6c 2c20 6275 636b 6574  protocol, bucket
-00010170: 2c20 6b65 7929 0a0a 2020 2020 2020 2020  , key)..        
-00010180: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-00010190: 7563 6b65 7420 616e 6420 6e6f 7420 6b65  ucket and not ke
-000101a0: 793a 2020 2320 6c69 7374 2062 7563 6b65  y:  # list bucke
-000101b0: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-000101c0: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-000101d0: 3d20 636c 6965 6e74 2e6c 6973 745f 6275  = client.list_bu
-000101e0: 636b 6574 7328 290a 2020 2020 2020 2020  ckets().        
-000101f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00010200: 636f 6e74 656e 7420 696e 2072 6573 706f  content in respo
-00010210: 6e73 655b 2742 7563 6b65 7473 275d 3a0a  nse['Buckets']:.
-00010220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010230: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
-00010240: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
-00010250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010260: 2020 2020 2063 6f6e 7465 6e74 5b27 4e61       content['Na
-00010270: 6d65 275d 2c20 6622 7333 3a2f 2f7b 636f  me'], f"s3://{co
-00010280: 6e74 656e 745b 274e 616d 6527 5d7d 222c  ntent['Name']}",
-00010290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000102a0: 2020 2020 2020 2020 2020 2020 2053 7461               Sta
-000102b0: 7452 6573 756c 7428 0a20 2020 2020 2020  tResult(.       
-000102c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102d0: 2020 2020 2020 2020 2063 7469 6d65 3d63           ctime=c
-000102e0: 6f6e 7465 6e74 5b27 4372 6561 7469 6f6e  ontent['Creation
-000102f0: 4461 7465 275d 2e74 696d 6573 7461 6d70  Date'].timestamp
-00010300: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010320: 2020 2020 6973 6469 723d 5472 7565 2c0a      isdir=True,.
-00010330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010350: 6578 7472 613d 636f 6e74 656e 742c 0a20  extra=content,. 
-00010360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010370: 2020 2020 2020 2020 2020 2029 290a 2020             )).  
-00010380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010390: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-000103a0: 2020 2020 2020 2020 2020 666f 7220 7265            for re
-000103b0: 7370 2069 6e20 5f6c 6973 745f 6f62 6a65  sp in _list_obje
-000103c0: 6374 735f 7265 6375 7273 6976 6528 636c  cts_recursive(cl
-000103d0: 6965 6e74 2c20 6275 636b 6574 2c20 7072  ient, bucket, pr
-000103e0: 6566 6978 2c0a 2020 2020 2020 2020 2020  efix,.          
-000103f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed20: 2020 2020 2020 2020 2020 2020 2520 280a              % (.
+0000ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed50: 2020 2020 2020 2020 6920 2b20 312c 2065          i + 1, e
+0000ed60: 7272 6f72 5f69 6e66 6f5b 274b 6579 275d  rror_info['Key']
+0000ed70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed90: 2020 2020 2020 2020 2020 6572 726f 725f            error_
+0000eda0: 696e 666f 5b27 436f 6465 275d 2c0a 2020  info['Code'],.  
+0000edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edd0: 2020 2020 2020 6572 726f 725f 696e 666f        error_info
+0000ede0: 5b27 4d65 7373 6167 6527 5d29 290a 2020  ['Message'])).  
+0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee00: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+0000ee10: 7973 2e61 7070 656e 6428 7b27 4b65 7927  ys.append({'Key'
+0000ee20: 3a20 6572 726f 725f 696e 666f 5b27 4b65  : error_info['Ke
+0000ee30: 7927 5d7d 290a 2020 2020 2020 2020 2020  y']}).          
+0000ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee70: 2020 2020 2020 2020 6572 726f 7273 2e61          errors.a
+0000ee80: 7070 656e 6428 6572 726f 725f 696e 666f  ppend(error_info
+0000ee90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000eea0: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
+0000eeb0: 6c65 6570 2872 6574 7279 5f69 6e74 6572  leep(retry_inter
+0000eec0: 7661 6c29 0a20 2020 2020 2020 2020 2020  val).           
+0000eed0: 2020 2020 2020 2020 2066 6f72 2065 7272           for err
+0000eee0: 6f72 5f69 6e66 6f20 696e 2065 7272 6f72  or_info in error
+0000eef0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000ef00: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+0000ef10: 5f6c 6f67 6765 722e 6572 726f 7228 0a20  _logger.error(. 
+0000ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef30: 2020 2020 2020 2020 2020 2022 6661 696c             "fail
+0000ef40: 6564 2072 656d 6f76 6520 6669 6c65 3a20  ed remove file: 
+0000ef50: 2573 2c20 7769 7468 2065 7272 6f72 2025  %s, with error %
+0000ef60: 733a 2025 7322 2025 2028 0a20 2020 2020  s: %s" % (.     
+0000ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef80: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+0000ef90: 5f69 6e66 6f5b 274b 6579 275d 2c20 6572  _info['Key'], er
+0000efa0: 726f 725f 696e 666f 5b27 436f 6465 275d  ror_info['Code']
+0000efb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efd0: 2020 6572 726f 725f 696e 666f 5b27 4d65    error_info['Me
+0000efe0: 7373 6167 6527 5d29 290a 2020 2020 2020  ssage'])).      
+0000eff0: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000f000: 726f 725f 636f 756e 7420 2b3d 206c 656e  ror_count += len
+0000f010: 2865 7272 6f72 7329 0a20 2020 2020 2020  (errors).       
+0000f020: 2020 2020 2069 6620 6572 726f 725f 636f       if error_co
+0000f030: 756e 7420 3e20 303a 0a20 2020 2020 2020  unt > 0:.       
+0000f040: 2020 2020 2020 2020 2065 7272 6f72 5f6d           error_m
+0000f050: 7367 203d 2022 6661 696c 6564 2072 656d  sg = "failed rem
+0000f060: 6f76 6520 7061 7468 3a20 2573 2c20 746f  ove path: %s, to
+0000f070: 7461 6c20 6669 6c65 2063 6f75 6e74 3a20  tal file count: 
+0000f080: 2573 2c20 6661 696c 6564 2063 6f75 6e74  %s, failed count
+0000f090: 3a20 2573 2220 2520 280a 2020 2020 2020  : %s" % (.      
+0000f0a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000f0b0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000f0c0: 746f 636f 6c2c 2074 6f74 616c 5f63 6f75  tocol, total_cou
+0000f0d0: 6e74 2c20 6572 726f 725f 636f 756e 7429  nt, error_count)
+0000f0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f0f0: 2072 6169 7365 2053 3355 6e6b 6e6f 776e   raise S3Unknown
+0000f100: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0000f110: 2020 2020 2020 2020 2020 2045 7863 6570             Excep
+0000f120: 7469 6f6e 2865 7272 6f72 5f6d 7367 292c  tion(error_msg),
+0000f130: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+0000f140: 7072 6f74 6f63 6f6c 290a 0a20 2020 2064  protocol)..    d
+0000f150: 6566 2072 656e 616d 6528 7365 6c66 2c20  ef rename(self, 
+0000f160: 6473 745f 7061 7468 3a20 5061 7468 4c69  dst_path: PathLi
+0000f170: 6b65 2920 2d3e 2027 5333 5061 7468 273a  ke) -> 'S3Path':
+0000f180: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000f190: 2020 2020 204d 6f76 6520 7333 2066 696c       Move s3 fil
+0000f1a0: 6520 7061 7468 2066 726f 6d20 7372 635f  e path from src_
+0000f1b0: 7572 6c20 746f 2064 7374 5f75 726c 0a0a  url to dst_url..
+0000f1c0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+0000f1d0: 7374 5f70 6174 683a 2047 6976 656e 2064  st_path: Given d
+0000f1e0: 6573 7469 6e61 7469 6f6e 2070 6174 680a  estination path.
+0000f1f0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000f200: 2020 2020 7333 5f72 656e 616d 6528 7365      s3_rename(se
+0000f210: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000f220: 746f 636f 6c2c 2064 7374 5f70 6174 6829  tocol, dst_path)
+0000f230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f240: 7365 6c66 2e66 726f 6d5f 7061 7468 2864  self.from_path(d
+0000f250: 7374 5f70 6174 6829 0a0a 2020 2020 6465  st_path)..    de
+0000f260: 6620 7363 616e 2873 656c 662c 206d 6973  f scan(self, mis
+0000f270: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
+0000f280: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000f290: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
+0000f2a0: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+0000f2b0: 2049 7465 7261 746f 725b 7374 725d 3a0a   Iterator[str]:.
+0000f2c0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000f2d0: 2020 2020 4974 6572 6174 6976 656c 7920      Iteratively 
+0000f2e0: 7472 6176 6572 7365 206f 6e6c 7920 6669  traverse only fi
+0000f2f0: 6c65 7320 696e 2067 6976 656e 2073 3320  les in given s3 
+0000f300: 6469 7265 6374 6f72 792c 2069 6e20 616c  directory, in al
+0000f310: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
+0000f320: 2e0a 2020 2020 2020 2020 4576 6572 7920  ..        Every 
+0000f330: 6974 6572 6174 696f 6e20 6f6e 2067 656e  iteration on gen
+0000f340: 6572 6174 6f72 2079 6965 6c64 7320 6120  erator yields a 
+0000f350: 7061 7468 2073 7472 696e 672e 0a0a 2020  path string...  
+0000f360: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
+0000f370: 6973 2061 2066 696c 6520 7061 7468 2c20  is a file path, 
+0000f380: 7969 656c 6473 2074 6865 2066 696c 6520  yields the file 
+0000f390: 6f6e 6c79 0a20 2020 2020 2020 2049 6620  only.        If 
+0000f3a0: 7333 5f75 726c 2069 7320 6120 6e6f 6e2d  s3_url is a non-
+0000f3b0: 6578 6973 7465 6e74 2070 6174 682c 2072  existent path, r
+0000f3c0: 6574 7572 6e20 616e 2065 6d70 7479 2067  eturn an empty g
+0000f3d0: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
+0000f3e0: 2049 6620 7333 5f75 726c 2069 7320 6120   If s3_url is a 
+0000f3f0: 6275 636b 6574 2070 6174 682c 2072 6574  bucket path, ret
+0000f400: 7572 6e20 616c 6c20 6669 6c65 2070 6174  urn all file pat
+0000f410: 6873 2069 6e20 7468 6520 6275 636b 6574  hs in the bucket
+0000f420: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
+0000f430: 726c 2069 7320 616e 2065 6d70 7479 2062  rl is an empty b
+0000f440: 7563 6b65 742c 2072 6574 7572 6e20 616e  ucket, return an
+0000f450: 2065 6d70 7479 2067 656e 6572 6174 6f72   empty generator
+0000f460: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
+0000f470: 726c 2064 6f65 736e 2774 2063 6f6e 7461  rl doesn't conta
+0000f480: 696e 2061 6e79 2062 7563 6b65 742c 2077  in any bucket, w
+0000f490: 6869 6368 2069 7320 7333 5f75 726c 203d  hich is s3_url =
+0000f4a0: 3d20 2773 333a 2f2f 272c 2072 6169 7365  = 's3://', raise
+0000f4b0: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000f4c0: 722e 2077 616c 6b28 2920 6f6e 2063 6f6d  r. walk() on com
+0000f4d0: 706c 6574 6520 7333 2069 7320 6e6f 7420  plete s3 is not 
+0000f4e0: 7375 7070 6f72 7465 6420 696e 206d 6567  supported in meg
+0000f4f0: 6669 6c65 0a0a 2020 2020 2020 2020 3a70  file..        :p
+0000f500: 6172 616d 206d 6973 7369 6e67 5f6f 6b3a  aram missing_ok:
+0000f510: 2049 6620 4661 6c73 6520 616e 6420 7468   If False and th
+0000f520: 6572 6527 7320 6e6f 2066 696c 6520 696e  ere's no file in
+0000f530: 2074 6865 2064 6972 6563 746f 7279 2c20   the directory, 
+0000f540: 7261 6973 6520 4669 6c65 4e6f 7446 6f75  raise FileNotFou
+0000f550: 6e64 4572 726f 720a 2020 2020 2020 2020  ndError.        
+0000f560: 3a72 6169 7365 733a 2055 6e73 7570 706f  :raises: Unsuppo
+0000f570: 7274 6564 4572 726f 720a 2020 2020 2020  rtedError.      
+0000f580: 2020 3a72 6574 7572 6e73 3a20 4120 6669    :returns: A fi
+0000f590: 6c65 2070 6174 6820 6765 6e65 7261 746f  le path generato
+0000f5a0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
+0000f5b0: 2020 2020 2020 7363 616e 5f73 7461 745f        scan_stat_
+0000f5c0: 6974 6572 203d 2073 656c 662e 7363 616e  iter = self.scan
+0000f5d0: 5f73 7461 7428 0a20 2020 2020 2020 2020  _stat(.         
+0000f5e0: 2020 206d 6973 7369 6e67 5f6f 6b3d 6d69     missing_ok=mi
+0000f5f0: 7373 696e 675f 6f6b 2c20 666f 6c6c 6f77  ssing_ok, follow
+0000f600: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
+0000f610: 7329 0a0a 2020 2020 2020 2020 6465 6620  s)..        def 
+0000f620: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+0000f630: 2829 202d 3e20 4974 6572 6174 6f72 5b73  () -> Iterator[s
+0000f640: 7472 5d3a 0a20 2020 2020 2020 2020 2020  tr]:.           
+0000f650: 2066 6f72 2066 696c 655f 656e 7472 7920   for file_entry 
+0000f660: 696e 2073 6361 6e5f 7374 6174 5f69 7465  in scan_stat_ite
+0000f670: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000f680: 2020 2079 6965 6c64 2066 696c 655f 656e     yield file_en
+0000f690: 7472 792e 7061 7468 0a0a 2020 2020 2020  try.path..      
+0000f6a0: 2020 7265 7475 726e 2063 7265 6174 655f    return create_
+0000f6b0: 6765 6e65 7261 746f 7228 290a 0a20 2020  generator()..   
+0000f6c0: 2064 6566 2073 6361 6e5f 7374 6174 2873   def scan_stat(s
+0000f6d0: 656c 662c 206d 6973 7369 6e67 5f6f 6b3a  elf, missing_ok:
+0000f6e0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+0000f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f700: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+0000f710: 6c20 3d20 4661 6c73 6529 202d 3e20 4974  l = False) -> It
+0000f720: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
+0000f730: 5d3a 0a20 2020 2020 2020 2027 2727 0a20  ]:.        '''. 
+0000f740: 2020 2020 2020 2049 7465 7261 7469 7665         Iterative
+0000f750: 6c79 2074 7261 7665 7273 6520 6f6e 6c79  ly traverse only
+0000f760: 2066 696c 6573 2069 6e20 6769 7665 6e20   files in given 
+0000f770: 6469 7265 6374 6f72 792c 2069 6e20 616c  directory, in al
+0000f780: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
+0000f790: 2e0a 2020 2020 2020 2020 4576 6572 7920  ..        Every 
+0000f7a0: 6974 6572 6174 696f 6e20 6f6e 2067 656e  iteration on gen
+0000f7b0: 6572 6174 6f72 2079 6965 6c64 7320 6120  erator yields a 
+0000f7c0: 7475 706c 6520 6f66 2070 6174 6820 7374  tuple of path st
+0000f7d0: 7269 6e67 2061 6e64 2066 696c 6520 7374  ring and file st
+0000f7e0: 6174 0a0a 2020 2020 2020 2020 3a70 6172  at..        :par
+0000f7f0: 616d 206d 6973 7369 6e67 5f6f 6b3a 2049  am missing_ok: I
+0000f800: 6620 4661 6c73 6520 616e 6420 7468 6572  f False and ther
+0000f810: 6527 7320 6e6f 2066 696c 6520 696e 2074  e's no file in t
+0000f820: 6865 2064 6972 6563 746f 7279 2c20 7261  he directory, ra
+0000f830: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
+0000f840: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
+0000f850: 6169 7365 733a 2055 6e73 7570 706f 7274  aises: Unsupport
+0000f860: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
+0000f870: 3a72 6574 7572 6e73 3a20 4120 6669 6c65  :returns: A file
+0000f880: 2070 6174 6820 6765 6e65 7261 746f 720a   path generator.
+0000f890: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000f8a0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+0000f8b0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+0000f8c0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000f8d0: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+0000f8e0: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
+0000f8f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000f900: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000f910: 7228 2753 6361 6e20 7768 6f6c 6520 7333  r('Scan whole s3
+0000f920: 272c 2073 656c 662e 7061 7468 5f77 6974  ', self.path_wit
+0000f930: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
+0000f940: 2020 2020 2064 6566 2063 7265 6174 655f       def create_
+0000f950: 6765 6e65 7261 746f 7228 2920 2d3e 2049  generator() -> I
+0000f960: 7465 7261 746f 725b 4669 6c65 456e 7472  terator[FileEntr
+0000f970: 795d 3a0a 2020 2020 2020 2020 2020 2020  y]:.            
+0000f980: 6966 206e 6f74 2073 656c 662e 6973 5f64  if not self.is_d
+0000f990: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
+0000f9a0: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
+0000f9b0: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
+0000f9c0: 2020 2020 2020 2020 2020 2020 2023 204f               # O
+0000f9d0: 6e20 7333 2c20 6669 6c65 2061 6e64 2064  n s3, file and d
+0000f9e0: 6972 6563 746f 7279 206d 6179 2062 6520  irectory may be 
+0000f9f0: 6f66 2073 616d 6520 6e61 6d65 2061 6e64  of same name and
+0000fa00: 206c 6576 656c 2c20 736f 206e 6565 6420   level, so need 
+0000fa10: 746f 2074 6573 7420 7468 6520 7061 7468  to test the path
+0000fa20: 2069 7320 6669 6c65 206f 7220 6469 7265   is file or dire
+0000fa30: 6374 6f72 790a 2020 2020 2020 2020 2020  ctory.          
+0000fa40: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+0000fa50: 4669 6c65 456e 7472 7928 0a20 2020 2020  FileEntry(.     
+0000fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa70: 2020 2073 656c 662e 6e61 6d65 2c20 6673     self.name, fs
+0000fa80: 7061 7468 2873 656c 662e 7061 7468 5f77  path(self.path_w
+0000fa90: 6974 685f 7072 6f74 6f63 6f6c 292c 0a20  ith_protocol),. 
+0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fab0: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
+0000fac0: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
+0000fad0: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a20  =followlinks)). 
+0000fae0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000faf0: 6574 7572 6e0a 0a20 2020 2020 2020 2020  eturn..         
+0000fb00: 2020 2069 6620 6e6f 7420 6b65 792e 656e     if not key.en
+0000fb10: 6473 7769 7468 2827 2f27 2920 616e 6420  dswith('/') and 
+0000fb20: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
+0000fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb40: 7969 656c 6420 4669 6c65 456e 7472 7928  yield FileEntry(
+0000fb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fb60: 2020 2020 2073 656c 662e 6e61 6d65 2c20       self.name, 
+0000fb70: 6673 7061 7468 2873 656c 662e 7061 7468  fspath(self.path
+0000fb80: 5f77 6974 685f 7072 6f74 6f63 6f6c 292c  _with_protocol),
+0000fb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fba0: 2020 2020 2073 656c 662e 7374 6174 2866       self.stat(f
+0000fbb0: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3d66  ollow_symlinks=f
+0000fbc0: 6f6c 6c6f 776c 696e 6b73 2929 0a0a 2020  ollowlinks))..  
+0000fbd0: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
+0000fbe0: 203d 205f 6265 636f 6d65 5f70 7265 6669   = _become_prefi
+0000fbf0: 7828 6b65 7929 0a20 2020 2020 2020 2020  x(key).         
+0000fc00: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
+0000fc10: 2e5f 636c 6965 6e74 0a20 2020 2020 2020  ._client.       
+0000fc20: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
+0000fc30: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
+0000fc40: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000fc50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000fc60: 2020 2066 6f72 2072 6573 7020 696e 205f     for resp in _
+0000fc70: 6c69 7374 5f6f 626a 6563 7473 5f72 6563  list_objects_rec
+0000fc80: 7572 7369 7665 2863 6c69 656e 742c 2062  ursive(client, b
+0000fc90: 7563 6b65 742c 2070 7265 6669 7829 3a0a  ucket, prefix):.
+0000fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fcb0: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
+0000fcc0: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
+0000fcd0: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
+0000fce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fcf0: 2020 2020 2066 756c 6c5f 7061 7468 203d       full_path =
+0000fd00: 2073 335f 7061 7468 5f6a 6f69 6e28 0a20   s3_path_join(. 
+0000fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd20: 2020 2020 2020 2020 2020 2066 277b 7365             f'{se
+0000fd30: 6c66 2e5f 7072 6f74 6f63 6f6c 5f77 6974  lf._protocol_wit
+0000fd40: 685f 7072 6f66 696c 657d 3a2f 2f27 2c20  h_profile}://', 
+0000fd50: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+0000fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd70: 2020 2020 636f 6e74 656e 745b 274b 6579      content['Key
+0000fd80: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
+0000fd90: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0000fda0: 6420 4669 6c65 456e 7472 7928 0a20 2020  d FileEntry(.   
+0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdc0: 2020 2020 2020 2020 2053 3350 6174 6828           S3Path(
+0000fdd0: 6675 6c6c 5f70 6174 6829 2e6e 616d 652c  full_path).name,
+0000fde0: 2066 756c 6c5f 7061 7468 2c0a 2020 2020   full_path,.    
+0000fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe00: 2020 2020 2020 2020 5f6d 616b 655f 7374          _make_st
+0000fe10: 6174 2863 6f6e 7465 6e74 2929 0a0a 2020  at(content))..  
+0000fe20: 2020 2020 2020 7265 7475 726e 205f 6372        return _cr
+0000fe30: 6561 7465 5f6d 6973 7369 6e67 5f6f 6b5f  eate_missing_ok_
+0000fe40: 6765 6e65 7261 746f 7228 0a20 2020 2020  generator(.     
+0000fe50: 2020 2020 2020 2063 7265 6174 655f 6765         create_ge
+0000fe60: 6e65 7261 746f 7228 292c 206d 6973 7369  nerator(), missi
+0000fe70: 6e67 5f6f 6b2c 0a20 2020 2020 2020 2020  ng_ok,.         
+0000fe80: 2020 2053 3346 696c 654e 6f74 466f 756e     S3FileNotFoun
+0000fe90: 6445 7272 6f72 2827 4e6f 206d 6174 6368  dError('No match
+0000fea0: 2066 696c 653a 2025 7227 2025 2073 656c   file: %r' % sel
+0000feb0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000fec0: 6f63 6f6c 2929 0a0a 2020 2020 6465 6620  ocol))..    def 
+0000fed0: 7363 616e 6469 7228 7365 6c66 2c20 666f  scandir(self, fo
+0000fee0: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000fef0: 3d20 4661 6c73 6529 202d 3e20 4974 6572  = False) -> Iter
+0000ff00: 6174 6f72 5b46 696c 6545 6e74 7279 5d3a  ator[FileEntry]:
+0000ff10: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000ff20: 2020 2020 2047 6574 2061 6c6c 2063 6f6e       Get all con
+0000ff30: 7465 6e74 7320 6f66 2067 6976 656e 2073  tents of given s
+0000ff40: 335f 7572 6c2c 2074 6865 206f 7264 6572  3_url, the order
+0000ff50: 206f 6620 7265 7375 6c74 2069 7320 6e6f   of result is no
+0000ff60: 7420 6775 6172 616e 7465 6564 2e0a 0a20  t guaranteed... 
+0000ff70: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000ff80: 2041 6c6c 2063 6f6e 7465 6e74 7320 6861   All contents ha
+0000ff90: 7665 2070 7265 6669 7820 6f66 2073 335f  ve prefix of s3_
+0000ffa0: 7572 6c0a 2020 2020 2020 2020 3a72 6169  url.        :rai
+0000ffb0: 7365 733a 2053 3346 696c 654e 6f74 466f  ses: S3FileNotFo
+0000ffc0: 756e 6445 7272 6f72 2c20 5333 4e6f 7441  undError, S3NotA
+0000ffd0: 4469 7265 6374 6f72 7945 7272 6f72 0a20  DirectoryError. 
+0000ffe0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000fff0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00010000: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
+00010010: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00010020: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+00010030: 6620 6e6f 7420 6275 636b 6574 2061 6e64  f not bucket and
+00010040: 206b 6579 3a0a 2020 2020 2020 2020 2020   key:.          
+00010050: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+00010060: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
+00010070: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00010080: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
+00010090: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
+000100a0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+000100b0: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+000100c0: 6c66 2e69 735f 6669 6c65 2829 3a0a 2020  lf.is_file():.  
+000100d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000100e0: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
+000100f0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00010100: 2020 2020 2020 274e 6f74 2061 2064 6972        'Not a dir
+00010110: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
+00010120: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00010130: 746f 636f 6c29 0a20 2020 2020 2020 2065  tocol).        e
+00010140: 6c69 6620 6e6f 7420 7365 6c66 2e69 735f  lif not self.is_
+00010150: 6469 7228 293a 0a20 2020 2020 2020 2020  dir():.         
+00010160: 2020 2072 6169 7365 2053 3346 696c 654e     raise S3FileN
+00010170: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
+00010180: 2020 2020 2020 2020 2020 2020 2020 274e                'N
+00010190: 6f20 7375 6368 2064 6972 6563 746f 7279  o such directory
+000101a0: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+000101b0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+000101c0: 0a20 2020 2020 2020 2070 7265 6669 7820  .        prefix 
+000101d0: 3d20 5f62 6563 6f6d 655f 7072 6566 6978  = _become_prefix
+000101e0: 286b 6579 290a 2020 2020 2020 2020 636c  (key).        cl
+000101f0: 6965 6e74 203d 2073 656c 662e 5f63 6c69  ient = self._cli
+00010200: 656e 740a 0a20 2020 2020 2020 2023 2049  ent..        # I
+00010210: 6e20 6f72 6465 7220 746f 2064 6f20 6368  n order to do ch
+00010220: 6563 6b20 6f6e 2063 7265 6174 696f 6e2c  eck on creation,
+00010230: 0a20 2020 2020 2020 2023 2077 6520 6e65  .        # we ne
+00010240: 6564 2074 6f20 7772 6170 2074 6865 2069  ed to wrap the i
+00010250: 7465 7261 746f 7220 696e 2061 6e6f 7468  terator in anoth
+00010260: 6572 2066 756e 6374 696f 6e0a 2020 2020  er function.    
+00010270: 2020 2020 6465 6620 6372 6561 7465 5f67      def create_g
+00010280: 656e 6572 6174 6f72 2829 202d 3e20 4974  enerator() -> It
+00010290: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
+000102a0: 5d3a 0a20 2020 2020 2020 2020 2020 2077  ]:.            w
+000102b0: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
+000102c0: 6f72 2873 656c 662e 7061 7468 5f77 6974  or(self.path_wit
+000102d0: 685f 7072 6f74 6f63 6f6c 293a 0a0a 2020  h_protocol):..  
+000102e0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+000102f0: 6620 6765 6e65 7261 7465 5f73 335f 7061  f generate_s3_pa
+00010300: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
+00010310: 2020 2020 2020 2020 2020 2020 7072 6f74              prot
+00010320: 6f63 6f6c 3a20 7374 722c 2062 7563 6b65  ocol: str, bucke
+00010330: 743a 2073 7472 2c20 6b65 793a 2073 7472  t: str, key: str
+00010340: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00010350: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00010360: 7475 726e 2022 2573 3a2f 2f25 732f 2573  turn "%s://%s/%s
+00010370: 2220 2520 2870 726f 746f 636f 6c2c 2062  " % (protocol, b
+00010380: 7563 6b65 742c 206b 6579 290a 0a20 2020  ucket, key)..   
+00010390: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000103a0: 6e6f 7420 6275 636b 6574 2061 6e64 206e  not bucket and n
+000103b0: 6f74 206b 6579 3a20 2023 206c 6973 7420  ot key:  # list 
+000103c0: 6275 636b 6574 730a 2020 2020 2020 2020  buckets.        
+000103d0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+000103e0: 6f6e 7365 203d 2063 6c69 656e 742e 6c69  onse = client.li
+000103f0: 7374 5f62 7563 6b65 7473 2829 0a20 2020  st_buckets().   
 00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010410: 2020 2020 2020 2020 2020 272f 2729 3a0a            '/'):.
-00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010430: 2020 2020 666f 7220 636f 6d6d 6f6e 5f70      for common_p
-00010440: 7265 6669 7820 696e 2072 6573 702e 6765  refix in resp.ge
-00010450: 7428 2743 6f6d 6d6f 6e50 7265 6669 7865  t('CommonPrefixe
-00010460: 7327 2c20 5b5d 293a 0a20 2020 2020 2020  s', []):.       
-00010470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010480: 2079 6965 6c64 2046 696c 6545 6e74 7279   yield FileEntry
-00010490: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000104a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000104b0: 6d6d 6f6e 5f70 7265 6669 785b 2750 7265  mmon_prefix['Pre
-000104c0: 6669 7827 5d5b 6c65 6e28 7072 6566 6978  fix'][len(prefix
-000104d0: 293a 2d31 5d2c 0a20 2020 2020 2020 2020  ):-1],.         
-000104e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104f0: 2020 2067 656e 6572 6174 655f 7333 5f70     generate_s3_p
-00010500: 6174 6828 0a20 2020 2020 2020 2020 2020  ath(.           
-00010510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010520: 2020 2020 2073 656c 662e 5f70 726f 746f       self._proto
-00010530: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
-00010540: 2c20 6275 636b 6574 2c0a 2020 2020 2020  , bucket,.      
+00010410: 2066 6f72 2063 6f6e 7465 6e74 2069 6e20   for content in 
+00010420: 7265 7370 6f6e 7365 5b27 4275 636b 6574  response['Bucket
+00010430: 7327 5d3a 0a20 2020 2020 2020 2020 2020  s']:.           
+00010440: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+00010450: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
+00010460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010470: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
+00010480: 745b 274e 616d 6527 5d2c 2066 2273 333a  t['Name'], f"s3:
+00010490: 2f2f 7b63 6f6e 7465 6e74 5b27 4e61 6d65  //{content['Name
+000104a0: 275d 7d22 2c0a 2020 2020 2020 2020 2020  ']}",.          
+000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104c0: 2020 5374 6174 5265 7375 6c74 280a 2020    StatResult(.  
+000104d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104e0: 2020 2020 2020 2020 2020 2020 2020 6374                ct
+000104f0: 696d 653d 636f 6e74 656e 745b 2743 7265  ime=content['Cre
+00010500: 6174 696f 6e44 6174 6527 5d2e 7469 6d65  ationDate'].time
+00010510: 7374 616d 7028 292c 0a20 2020 2020 2020  stamp(),.       
+00010520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010530: 2020 2020 2020 2020 2069 7364 6972 3d54           isdir=T
+00010540: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
 00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010560: 2020 2020 2020 2020 2020 636f 6d6d 6f6e            common
-00010570: 5f70 7265 6669 785b 2750 7265 6669 7827  _prefix['Prefix'
-00010580: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00010590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105a0: 5374 6174 5265 7375 6c74 2869 7364 6972  StatResult(isdir
-000105b0: 3d54 7275 652c 2065 7874 7261 3d63 6f6d  =True, extra=com
-000105c0: 6d6f 6e5f 7072 6566 6978 2929 0a20 2020  mon_prefix)).   
-000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105e0: 2066 6f72 2063 6f6e 7465 6e74 2069 6e20   for content in 
-000105f0: 7265 7370 2e67 6574 2827 436f 6e74 656e  resp.get('Conten
-00010600: 7473 272c 205b 5d29 3a0a 2020 2020 2020  ts', []):.      
+00010560: 2020 2020 2065 7874 7261 3d63 6f6e 7465       extra=conte
+00010570: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010590: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000105a0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+000105b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000105c0: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
+000105d0: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
+000105e0: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
+000105f0: 742c 2070 7265 6669 782c 0a20 2020 2020  t, prefix,.     
+00010600: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00010610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010620: 2020 7372 635f 7572 6c20 3d20 6765 6e65    src_url = gene
-00010630: 7261 7465 5f73 335f 7061 7468 280a 2020  rate_s3_path(.  
-00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010650: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00010660: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
-00010670: 6f66 696c 652c 2062 7563 6b65 742c 2063  ofile, bucket, c
-00010680: 6f6e 7465 6e74 5b27 4b65 7927 5d29 0a0a  ontent['Key'])..
-00010690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106a0: 2020 2020 2020 2020 6966 2066 6f6c 6c6f          if follo
-000106b0: 776c 696e 6b73 2061 6e64 2053 3350 6174  wlinks and S3Pat
-000106c0: 6828 7372 635f 7572 6c29 2e69 735f 7379  h(src_url).is_sy
-000106d0: 6d6c 696e 6b28 293a 0a20 2020 2020 2020  mlink():.       
-000106e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106f0: 2020 2020 2063 6f6e 7465 6e74 5b27 6973       content['is
-00010700: 6c6e 6b27 5d20 3d20 5472 7565 0a0a 2020  lnk'] = True..  
-00010710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010720: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
-00010730: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
-00010740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010750: 2020 2063 6f6e 7465 6e74 5b27 4b65 7927     content['Key'
-00010760: 5d5b 6c65 6e28 7072 6566 6978 293a 5d2c  ][len(prefix):],
-00010770: 2073 7263 5f75 726c 2c0a 2020 2020 2020   src_url,.      
-00010780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010790: 2020 2020 2020 5f6d 616b 655f 7374 6174        _make_stat
-000107a0: 2863 6f6e 7465 6e74 2929 0a0a 2020 2020  (content))..    
-000107b0: 2020 2020 7265 7475 726e 2043 6f6e 7465      return Conte
-000107c0: 7874 4974 6572 6174 6f72 2863 7265 6174  xtIterator(creat
-000107d0: 655f 6765 6e65 7261 746f 7228 2929 0a0a  e_generator())..
-000107e0: 2020 2020 6465 6620 5f67 6574 6469 7273      def _getdirs
-000107f0: 7461 7428 7365 6c66 2920 2d3e 2053 7461  tat(self) -> Sta
-00010800: 7452 6573 756c 743a 0a20 2020 2020 2020  tResult:.       
-00010810: 2027 2727 0a20 2020 2020 2020 2052 6574   '''.        Ret
-00010820: 7572 6e20 5374 6174 5265 7375 6c74 206f  urn StatResult o
-00010830: 6620 6769 7665 6e20 7333 5f75 726c 2064  f given s3_url d
-00010840: 6972 6563 746f 7279 2c20 696e 636c 7564  irectory, includ
-00010850: 696e 673a 200a 0a20 2020 2020 2020 2031  ing: ..        1
-00010860: 2e20 4469 7265 6374 6f72 7920 7369 7a65  . Directory size
-00010870: 3a20 7468 6520 7375 6d20 6f66 2061 6c6c  : the sum of all
-00010880: 2066 696c 6520 7369 7a65 2069 6e20 6974   file size in it
-00010890: 2c20 696e 636c 7564 696e 6720 6669 6c65  , including file
-000108a0: 2069 6e20 7375 6264 6972 6563 746f 7269   in subdirectori
-000108b0: 6573 2028 6966 2065 7869 7374 292e 0a20  es (if exist).. 
-000108c0: 2020 2020 2020 2054 6865 2072 6573 756c         The resul
-000108d0: 7420 6578 636c 7564 6573 2074 6865 2073  t excludes the s
-000108e0: 697a 6520 6f66 2064 6972 6563 746f 7279  ize of directory
-000108f0: 2069 7473 656c 662e 2049 6e20 6f74 6865   itself. In othe
-00010900: 7220 776f 7264 732c 2072 6574 7572 6e20  r words, return 
-00010910: 3020 4279 7465 206f 6e20 616e 2065 6d70  0 Byte on an emp
-00010920: 7479 2064 6972 6563 746f 7279 2070 6174  ty directory pat
-00010930: 680a 2020 2020 2020 2020 322e 204c 6173  h.        2. Las
-00010940: 742d 6d6f 6469 6669 6564 2074 696d 6520  t-modified time 
-00010950: 6f66 2064 6972 6563 746f 7279 3a20 7265  of directory: re
-00010960: 7475 726e 2074 6865 206c 6174 6573 7420  turn the latest 
-00010970: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
-00010980: 2061 6c6c 2066 696c 6520 696e 2069 742e   all file in it.
-00010990: 2054 6865 206d 7469 6d65 206f 6620 656d   The mtime of em
-000109a0: 7074 7920 6469 7265 6374 6f72 7920 6973  pty directory is
-000109b0: 2031 3937 302d 3031 2d30 3120 3030 3a30   1970-01-01 00:0
-000109c0: 303a 3030 0a0a 2020 2020 2020 2020 3a72  0:00..        :r
-000109d0: 6574 7572 6e73 3a20 416e 2069 6e74 2069  eturns: An int i
-000109e0: 6e64 6963 6174 6573 2073 697a 6520 696e  ndicates size in
-000109f0: 2042 7974 6573 0a20 2020 2020 2020 2027   Bytes.        '
-00010a00: 2727 0a20 2020 2020 2020 2069 6620 6e6f  ''.        if no
-00010a10: 7420 7365 6c66 2e69 735f 6469 7228 293a  t self.is_dir():
-00010a20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00010a30: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-00010a40: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-00010a50: 2020 2020 2020 2020 274e 6f20 7375 6368          'No such
-00010a60: 2066 696c 6520 6f72 2064 6972 6563 746f   file or directo
-00010a70: 7279 3a20 2572 2720 2520 7365 6c66 2e70  ry: %r' % self.p
-00010a80: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00010a90: 6c29 0a0a 2020 2020 2020 2020 6275 636b  l)..        buck
-00010aa0: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-00010ab0: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
-00010ac0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-00010ad0: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
-00010ae0: 205f 6265 636f 6d65 5f70 7265 6669 7828   _become_prefix(
-00010af0: 6b65 7929 0a20 2020 2020 2020 2063 6c69  key).        cli
-00010b00: 656e 7420 3d20 7365 6c66 2e5f 636c 6965  ent = self._clie
-00010b10: 6e74 0a20 2020 2020 2020 2073 697a 6520  nt.        size 
-00010b20: 3d20 300a 2020 2020 2020 2020 6d74 696d  = 0.        mtim
-00010b30: 6520 3d20 302e 300a 2020 2020 2020 2020  e = 0.0.        
-00010b40: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
-00010b50: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
-00010b60: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
-00010b70: 2020 2020 2020 2020 2020 666f 7220 7265            for re
-00010b80: 7370 2069 6e20 5f6c 6973 745f 6f62 6a65  sp in _list_obje
-00010b90: 6374 735f 7265 6375 7273 6976 6528 636c  cts_recursive(cl
-00010ba0: 6965 6e74 2c20 6275 636b 6574 2c20 7072  ient, bucket, pr
-00010bb0: 6566 6978 293a 0a20 2020 2020 2020 2020  efix):.         
-00010bc0: 2020 2020 2020 2066 6f72 2063 6f6e 7465         for conte
-00010bd0: 6e74 2069 6e20 7265 7370 2e67 6574 2827  nt in resp.get('
-00010be0: 436f 6e74 656e 7473 272c 205b 5d29 3a0a  Contents', []):.
-00010bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c00: 2020 2020 7369 7a65 202b 3d20 636f 6e74      size += cont
-00010c10: 656e 745b 2753 697a 6527 5d0a 2020 2020  ent['Size'].    
-00010c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c30: 6c61 7374 5f6d 6f64 6966 6965 6420 3d20  last_modified = 
-00010c40: 636f 6e74 656e 745b 274c 6173 744d 6f64  content['LastMod
-00010c50: 6966 6965 6427 5d2e 7469 6d65 7374 616d  ified'].timestam
-00010c60: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00010c70: 2020 2020 2020 2020 6966 206d 7469 6d65          if mtime
-00010c80: 203c 206c 6173 745f 6d6f 6469 6669 6564   < last_modified
-00010c90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010ca0: 2020 2020 2020 2020 2020 6d74 696d 6520            mtime 
-00010cb0: 3d20 6c61 7374 5f6d 6f64 6966 6965 640a  = last_modified.
-00010cc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00010cd0: 5374 6174 5265 7375 6c74 2873 697a 653d  StatResult(size=
-00010ce0: 7369 7a65 2c20 6d74 696d 653d 6d74 696d  size, mtime=mtim
-00010cf0: 652c 2069 7364 6972 3d54 7275 6529 0a0a  e, isdir=True)..
-00010d00: 2020 2020 6465 6620 7374 6174 2873 656c      def stat(sel
-00010d10: 662c 2066 6f6c 6c6f 775f 7379 6d6c 696e  f, follow_symlin
-00010d20: 6b73 3d54 7275 6529 202d 3e20 5374 6174  ks=True) -> Stat
-00010d30: 5265 7375 6c74 3a0a 2020 2020 2020 2020  Result:.        
-00010d40: 2727 270a 2020 2020 2020 2020 4765 7420  '''.        Get 
-00010d50: 5374 6174 5265 7375 6c74 206f 6620 7333  StatResult of s3
-00010d60: 5f75 726c 2066 696c 652c 2069 6e63 6c75  _url file, inclu
-00010d70: 6469 6e67 2066 696c 6520 7369 7a65 2061  ding file size a
-00010d80: 6e64 206d 7469 6d65 2c20 7265 6665 7272  nd mtime, referr
-00010d90: 696e 6720 746f 2073 335f 6765 7473 697a  ing to s3_getsiz
-00010da0: 6520 616e 6420 7333 5f67 6574 6d74 696d  e and s3_getmtim
-00010db0: 650a 0a20 2020 2020 2020 2049 6620 7333  e..        If s3
-00010dc0: 5f75 726c 2069 7320 6e6f 7420 616e 2065  _url is not an e
-00010dd0: 7869 7374 656e 7420 7061 7468 2c20 7768  xistent path, wh
-00010de0: 6963 6820 6d65 616e 7320 7333 5f65 7869  ich means s3_exi
-00010df0: 7374 2873 335f 7572 6c29 2072 6574 7572  st(s3_url) retur
-00010e00: 6e73 2046 616c 7365 2c20 7468 656e 2072  ns False, then r
-00010e10: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
-00010e20: 756e 6445 7272 6f72 0a20 2020 2020 2020  undError.       
-00010e30: 2049 6620 6174 7465 6d70 7420 746f 2067   If attempt to g
-00010e40: 6574 2053 7461 7452 6573 756c 7420 6f66  et StatResult of
-00010e50: 2063 6f6d 706c 6574 6520 7333 2c20 7375   complete s3, su
-00010e60: 6368 2061 7320 7333 5f64 6972 5f75 726c  ch as s3_dir_url
-00010e70: 203d 3d20 2773 333a 2f2f 272c 2072 6169   == 's3://', rai
-00010e80: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-00010e90: 756e 6445 7272 6f72 0a0a 2020 2020 2020  undError..      
-00010ea0: 2020 3a72 6574 7572 6e73 3a20 5374 6174    :returns: Stat
-00010eb0: 5265 7375 6c74 0a20 2020 2020 2020 203a  Result.        :
-00010ec0: 7261 6973 6573 3a20 5333 4669 6c65 4e6f  raises: S3FileNo
-00010ed0: 7446 6f75 6e64 4572 726f 722c 2053 3342  tFoundError, S3B
-00010ee0: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-00010ef0: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
-00010f00: 2020 2020 2020 2069 736c 6e6b 203d 2046         islnk = F
-00010f10: 616c 7365 0a20 2020 2020 2020 2062 7563  alse.        buc
-00010f20: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
-00010f30: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
-00010f40: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00010f50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00010f60: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-00010f70: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-00010f80: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-00010f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010fa0: 2027 456d 7074 7920 6275 636b 6574 206e   'Empty bucket n
-00010fb0: 616d 653a 2025 7227 2025 2073 656c 662e  ame: %r' % self.
-00010fc0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00010fd0: 6f6c 290a 0a20 2020 2020 2020 2069 6620  ol)..        if 
-00010fe0: 6e6f 7420 7365 6c66 2e69 735f 6669 6c65  not self.is_file
-00010ff0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00011000: 7265 7475 726e 2073 656c 662e 5f67 6574  return self._get
-00011010: 6469 7273 7461 7428 290a 0a20 2020 2020  dirstat()..     
-00011020: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00011030: 2e5f 636c 6965 6e74 0a20 2020 2020 2020  ._client.       
-00011040: 2077 6974 6820 7261 6973 655f 7333 5f65   with raise_s3_e
-00011050: 7272 6f72 2873 656c 662e 7061 7468 5f77  rror(self.path_w
-00011060: 6974 685f 7072 6f74 6f63 6f6c 293a 0a20  ith_protocol):. 
-00011070: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-00011080: 6e74 203d 2063 6c69 656e 742e 6865 6164  nt = client.head
-00011090: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
-000110a0: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
-000110b0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-000110c0: 4d65 7461 6461 7461 2720 696e 2063 6f6e  Metadata' in con
-000110d0: 7465 6e74 3a0a 2020 2020 2020 2020 2020  tent:.          
-000110e0: 2020 2020 2020 6d65 7461 6461 7461 203d        metadata =
-000110f0: 2064 6963 7428 0a20 2020 2020 2020 2020   dict(.         
-00011100: 2020 2020 2020 2020 2020 2028 6b65 792e             (key.
-00011110: 6c6f 7765 7228 292c 2076 616c 7565 290a  lower(), value).
-00011120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011130: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
-00011140: 7565 2069 6e20 636f 6e74 656e 745b 274d  ue in content['M
-00011150: 6574 6164 6174 6127 5d2e 6974 656d 7328  etadata'].items(
-00011160: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00011170: 2020 2069 6620 6d65 7461 6461 7461 2061     if metadata a
-00011180: 6e64 2027 7379 6d6c 696e 6b5f 746f 2720  nd 'symlink_to' 
-00011190: 696e 206d 6574 6164 6174 613a 0a20 2020  in metadata:.   
-000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111b0: 2069 736c 6e6b 203d 2054 7275 650a 2020   islnk = True.  
-000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111d0: 2020 6966 2069 736c 6e6b 2061 6e64 2066    if islnk and f
-000111e0: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3a0a  ollow_symlinks:.
-000111f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011200: 2020 2020 2020 2020 7333 5f75 726c 203d          s3_url =
-00011210: 206d 6574 6164 6174 615b 2773 796d 6c69   metadata['symli
-00011220: 6e6b 5f74 6f27 5d0a 2020 2020 2020 2020  nk_to'].        
-00011230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011240: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-00011250: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
-00011260: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
-00011270: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-00011280: 6e74 203d 2063 6c69 656e 742e 6865 6164  nt = client.head
-00011290: 5f6f 626a 6563 7428 4275 636b 6574 3d62  _object(Bucket=b
-000112a0: 7563 6b65 742c 204b 6579 3d6b 6579 290a  ucket, Key=key).
-000112b0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-000112c0: 5f72 6563 6f72 6420 3d20 5374 6174 5265  _record = StatRe
-000112d0: 7375 6c74 280a 2020 2020 2020 2020 2020  sult(.          
-000112e0: 2020 2020 2020 6973 6c6e 6b3d 6973 6c6e        islnk=isln
-000112f0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-00011300: 2020 2073 697a 653d 636f 6e74 656e 745b     size=content[
-00011310: 2743 6f6e 7465 6e74 4c65 6e67 7468 275d  'ContentLength']
-00011320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011330: 2020 6d74 696d 653d 636f 6e74 656e 745b    mtime=content[
-00011340: 274c 6173 744d 6f64 6966 6965 6427 5d2e  'LastModified'].
-00011350: 7469 6d65 7374 616d 7028 292c 0a20 2020  timestamp(),.   
-00011360: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-00011370: 7261 3d63 6f6e 7465 6e74 290a 2020 2020  ra=content).    
-00011380: 2020 2020 7265 7475 726e 2073 7461 745f      return stat_
-00011390: 7265 636f 7264 0a0a 2020 2020 6465 6620  record..    def 
-000113a0: 6c73 7461 7428 7365 6c66 2920 2d3e 2053  lstat(self) -> S
-000113b0: 7461 7452 6573 756c 743a 0a20 2020 2020  tatResult:.     
-000113c0: 2020 2027 2727 4c69 6b65 2050 6174 682e     '''Like Path.
-000113d0: 7374 6174 2829 2062 7574 2c20 6966 2074  stat() but, if t
-000113e0: 6865 2070 6174 6820 706f 696e 7473 2074  he path points t
-000113f0: 6f20 6120 7379 6d62 6f6c 6963 206c 696e  o a symbolic lin
-00011400: 6b2c 2072 6574 7572 6e20 7468 6520 7379  k, return the sy
-00011410: 6d62 6f6c 6963 206c 696e 6be2 8099 7320  mbolic link...s 
-00011420: 696e 666f 726d 6174 696f 6e20 7261 7468  information rath
-00011430: 6572 2074 6861 6e20 6974 7320 7461 7267  er than its targ
-00011440: 6574 e280 9973 2e27 2727 0a20 2020 2020  et...s.'''.     
-00011450: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-00011460: 7461 7428 666f 6c6c 6f77 5f73 796d 6c69  tat(follow_symli
-00011470: 6e6b 733d 4661 6c73 6529 0a0a 2020 2020  nks=False)..    
-00011480: 6465 6620 756e 6c69 6e6b 2873 656c 662c  def unlink(self,
-00011490: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
-000114a0: 6c20 3d20 4661 6c73 6529 202d 3e20 4e6f  l = False) -> No
-000114b0: 6e65 3a0a 2020 2020 2020 2020 2727 270a  ne:.        '''.
-000114c0: 2020 2020 2020 2020 5265 6d6f 7665 2074          Remove t
-000114d0: 6865 2066 696c 6520 6f6e 2073 330a 0a20  he file on s3.. 
-000114e0: 2020 2020 2020 203a 7061 7261 6d20 6d69         :param mi
-000114f0: 7373 696e 675f 6f6b 3a20 6966 2046 616c  ssing_ok: if Fal
-00011500: 7365 2061 6e64 2074 6172 6765 7420 6669  se and target fi
-00011510: 6c65 206e 6f74 2065 7869 7374 732c 2072  le not exists, r
-00011520: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
-00011530: 756e 6445 7272 6f72 0a20 2020 2020 2020  undError.       
-00011540: 203a 7261 6973 6573 3a20 5333 5065 726d   :raises: S3Perm
-00011550: 6973 7369 6f6e 4572 726f 722c 2053 3346  issionError, S3F
-00011560: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-00011570: 2c20 5333 4973 4144 6972 6563 746f 7279  , S3IsADirectory
-00011580: 4572 726f 720a 2020 2020 2020 2020 2727  Error.        ''
-00011590: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
-000115a0: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-000115b0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-000115c0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-000115d0: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
-000115e0: 6b65 7420 6f72 206e 6f74 206b 6579 206f  ket or not key o
-000115f0: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
-00011600: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-00011610: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-00011620: 6374 6f72 7945 7272 6f72 280a 2020 2020  ctoryError(.    
-00011630: 2020 2020 2020 2020 2020 2020 2749 7320              'Is 
-00011640: 6120 6469 7265 6374 6f72 793a 2025 7227  a directory: %r'
-00011650: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
-00011660: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-00011670: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-00011680: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
-00011690: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
-000116a0: 675f 6f6b 3a0a 2020 2020 2020 2020 2020  g_ok:.          
-000116b0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000116c0: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-000116d0: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-000116e0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000116f0: 2020 2020 274e 6f20 7375 6368 2066 696c      'No such fil
-00011700: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
-00011710: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00011720: 290a 0a20 2020 2020 2020 2077 6974 6820  )..        with 
-00011730: 7261 6973 655f 7333 5f65 7272 6f72 2873  raise_s3_error(s
-00011740: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00011750: 6f74 6f63 6f6c 293a 0a20 2020 2020 2020  otocol):.       
-00011760: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
-00011770: 742e 6465 6c65 7465 5f6f 626a 6563 7428  t.delete_object(
-00011780: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
-00011790: 6579 3d6b 6579 290a 0a20 2020 2064 6566  ey=key)..    def
-000117a0: 2077 616c 6b28 7365 6c66 2c20 666f 6c6c   walk(self, foll
-000117b0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-000117c0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-000117d0: 2020 2920 2d3e 2049 7465 7261 746f 725b    ) -> Iterator[
-000117e0: 5475 706c 655b 7374 722c 204c 6973 745b  Tuple[str, List[
-000117f0: 7374 725d 2c20 4c69 7374 5b73 7472 5d5d  str], List[str]]
-00011800: 5d3a 0a20 2020 2020 2020 2027 2727 0a20  ]:.        '''. 
-00011810: 2020 2020 2020 2049 7465 7261 7469 7665         Iterative
-00011820: 6c79 2074 7261 7665 7273 6520 7468 6520  ly traverse the 
-00011830: 6769 7665 6e20 7333 2064 6972 6563 746f  given s3 directo
-00011840: 7279 2c20 696e 2074 6f70 2d62 6f74 746f  ry, in top-botto
-00011850: 6d20 6f72 6465 722e 2049 6e20 6f74 6865  m order. In othe
-00011860: 7220 776f 7264 732c 2066 6972 7374 6c79  r words, firstly
-00011870: 2074 7261 7665 7273 6520 7061 7265 6e74   traverse parent
-00011880: 2064 6972 6563 746f 7279 2c20 6966 2073   directory, if s
-00011890: 7562 6469 7265 6374 6f72 6965 7320 6578  ubdirectories ex
-000118a0: 6973 742c 2074 7261 7665 7273 6520 7468  ist, traverse th
-000118b0: 6520 7375 6264 6972 6563 746f 7269 6573  e subdirectories
-000118c0: 2069 6e20 616c 7068 6162 6574 6963 616c   in alphabetical
-000118d0: 206f 7264 6572 2e0a 2020 2020 2020 2020   order..        
-000118e0: 4576 6572 7920 6974 6572 6174 696f 6e20  Every iteration 
-000118f0: 6f6e 2067 656e 6572 6174 6f72 2079 6965  on generator yie
-00011900: 6c64 7320 6120 332d 7475 706c 653a 2028  lds a 3-tuple: (
-00011910: 726f 6f74 2c20 6469 7273 2c20 6669 6c65  root, dirs, file
-00011920: 7329 0a0a 2020 2020 2020 2020 2d20 726f  s)..        - ro
-00011930: 6f74 3a20 4375 7272 656e 7420 7333 2070  ot: Current s3 p
-00011940: 6174 683b 0a20 2020 2020 2020 202d 2064  ath;.        - d
-00011950: 6972 733a 204e 616d 6520 6c69 7374 206f  irs: Name list o
-00011960: 6620 7375 6264 6972 6563 746f 7269 6573  f subdirectories
-00011970: 2069 6e20 6375 7272 656e 7420 6469 7265   in current dire
-00011980: 6374 6f72 792e 2054 6865 206c 6973 7420  ctory. The list 
-00011990: 6973 2073 6f72 7465 6420 6279 206e 616d  is sorted by nam
-000119a0: 6520 696e 2061 7363 656e 6469 6e67 2061  e in ascending a
-000119b0: 6c70 6861 6265 7469 6361 6c20 6f72 6465  lphabetical orde
-000119c0: 723b 0a20 2020 2020 2020 202d 2066 696c  r;.        - fil
-000119d0: 6573 3a20 4e61 6d65 206c 6973 7420 6f66  es: Name list of
-000119e0: 2066 696c 6573 2069 6e20 6375 7272 656e   files in curren
-000119f0: 7420 6469 7265 6374 6f72 792e 2054 6865  t directory. The
-00011a00: 206c 6973 7420 6973 2073 6f72 7465 6420   list is sorted 
-00011a10: 6279 206e 616d 6520 696e 2061 7363 656e  by name in ascen
-00011a20: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
-00011a30: 6c20 6f72 6465 723b 0a0a 2020 2020 2020  l order;..      
-00011a40: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
-00011a50: 2066 696c 6520 7061 7468 2c20 7265 7475   file path, retu
-00011a60: 726e 2061 6e20 656d 7074 7920 6765 6e65  rn an empty gene
-00011a70: 7261 746f 720a 2020 2020 2020 2020 4966  rator.        If
-00011a80: 2073 335f 7572 6c20 6973 2061 206e 6f6e   s3_url is a non
-00011a90: 2d65 7869 7374 656e 7420 7061 7468 2c20  -existent path, 
-00011aa0: 7265 7475 726e 2061 6e20 656d 7074 7920  return an empty 
-00011ab0: 6765 6e65 7261 746f 720a 2020 2020 2020  generator.      
-00011ac0: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
-00011ad0: 2062 7563 6b65 7420 7061 7468 2c20 6275   bucket path, bu
-00011ae0: 636b 6574 2077 696c 6c20 6265 2074 6865  cket will be the
-00011af0: 2074 6f70 2064 6972 6563 746f 7279 2c20   top directory, 
-00011b00: 616e 6420 7769 6c6c 2062 6520 7265 7475  and will be retu
-00011b10: 726e 6564 2061 7420 6669 7273 7420 6974  rned at first it
-00011b20: 6572 6174 696f 6e20 6f66 2067 656e 6572  eration of gener
-00011b30: 6174 6f72 0a20 2020 2020 2020 2049 6620  ator.        If 
-00011b40: 7333 5f75 726c 2069 7320 616e 2065 6d70  s3_url is an emp
-00011b50: 7479 2062 7563 6b65 742c 206f 6e6c 7920  ty bucket, only 
-00011b60: 7969 656c 6420 6f6e 6520 332d 7475 706c  yield one 3-tupl
-00011b70: 6520 286e 6f74 6573 3a20 7333 2064 6f65  e (notes: s3 doe
-00011b80: 736e 2774 2068 6176 6520 656d 7074 7920  sn't have empty 
-00011b90: 6469 7265 6374 6f72 7929 0a20 2020 2020  directory).     
-00011ba0: 2020 2049 6620 7333 5f75 726c 2064 6f65     If s3_url doe
-00011bb0: 736e 2774 2063 6f6e 7461 696e 2061 6e79  sn't contain any
-00011bc0: 2062 7563 6b65 742c 2077 6869 6368 2069   bucket, which i
-00011bd0: 7320 7333 5f75 726c 203d 3d20 2773 333a  s s3_url == 's3:
-00011be0: 2f2f 272c 2072 6169 7365 2055 6e73 7570  //', raise Unsup
-00011bf0: 706f 7274 6564 4572 726f 722e 2077 616c  portedError. wal
-00011c00: 6b28 2920 6f6e 2063 6f6d 706c 6574 6520  k() on complete 
-00011c10: 7333 2069 7320 6e6f 7420 7375 7070 6f72  s3 is not suppor
-00011c20: 7465 6420 696e 206d 6567 6669 6c65 0a0a  ted in megfile..
-00011c30: 2020 2020 2020 2020 3a70 6172 616d 2066          :param f
-00011c40: 6f6c 6c6f 776c 696e 6b73 3a20 7768 6574  ollowlinks: whet
-00011c50: 6865 7220 666f 6c6c 6f77 6c69 6e6b 7320  her followlinks 
-00011c60: 6973 2054 7275 6520 6f72 2046 616c 7365  is True or False
-00011c70: 2c20 7265 7375 6c74 2069 7320 7468 6520  , result is the 
-00011c80: 7361 6d65 2e20 4265 6361 7573 6520 7333  same. Because s3
-00011c90: 2073 796d 6c69 6e6b 206e 6f74 2073 7570   symlink not sup
-00011ca0: 706f 7274 2064 6972 2e0a 2020 2020 2020  port dir..      
-00011cb0: 2020 3a72 6169 7365 733a 2055 6e73 7570    :raises: Unsup
-00011cc0: 706f 7274 6564 4572 726f 720a 2020 2020  portedError.    
-00011cd0: 2020 2020 3a72 6574 7572 6e73 3a20 4120      :returns: A 
-00011ce0: 332d 7475 706c 6520 6765 6e65 7261 746f  3-tuple generato
-00011cf0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
-00011d00: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
-00011d10: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-00011d20: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
-00011d30: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-00011d40: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
-00011d50: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00011d60: 7365 2055 6e73 7570 706f 7274 6564 4572  se UnsupportedEr
-00011d70: 726f 7228 2757 616c 6b20 7768 6f6c 6520  ror('Walk whole 
-00011d80: 7333 272c 2073 656c 662e 7061 7468 5f77  s3', self.path_w
-00011d90: 6974 685f 7072 6f74 6f63 6f6c 290a 0a20  ith_protocol).. 
-00011da0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00011db0: 6c66 2e69 735f 6469 7228 293a 0a20 2020  lf.is_dir():.   
-00011dc0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00011dd0: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
-00011de0: 205b 6b65 795d 0a20 2020 2020 2020 2063   [key].        c
-00011df0: 6c69 656e 7420 3d20 7365 6c66 2e5f 636c  lient = self._cl
-00011e00: 6965 6e74 0a20 2020 2020 2020 2077 6869  ient.        whi
-00011e10: 6c65 206c 656e 2873 7461 636b 2920 3e20  le len(stack) > 
-00011e20: 303a 0a20 2020 2020 2020 2020 2020 2063  0:.            c
-00011e30: 7572 7265 6e74 203d 205f 6265 636f 6d65  urrent = _become
-00011e40: 5f70 7265 6669 7828 7374 6163 6b2e 706f  _prefix(stack.po
-00011e50: 7028 2929 0a20 2020 2020 2020 2020 2020  p()).           
-00011e60: 2064 6972 732c 2066 696c 6573 203d 205b   dirs, files = [
-00011e70: 5d2c 205b 5d0a 2020 2020 2020 2020 2020  ], [].          
-00011e80: 2020 666f 7220 7265 7370 2069 6e20 5f6c    for resp in _l
-00011e90: 6973 745f 6f62 6a65 6374 735f 7265 6375  ist_objects_recu
-00011ea0: 7273 6976 6528 636c 6965 6e74 2c20 6275  rsive(client, bu
-00011eb0: 636b 6574 2c20 6375 7272 656e 742c 2027  cket, current, '
-00011ec0: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-00011ed0: 2020 2020 2066 6f72 2063 6f6d 6d6f 6e5f       for common_
-00011ee0: 7072 6566 6978 2069 6e20 7265 7370 2e67  prefix in resp.g
-00011ef0: 6574 2827 436f 6d6d 6f6e 5072 6566 6978  et('CommonPrefix
-00011f00: 6573 272c 205b 5d29 3a0a 2020 2020 2020  es', []):.      
-00011f10: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00011f20: 7273 2e61 7070 656e 6428 636f 6d6d 6f6e  rs.append(common
-00011f30: 5f70 7265 6669 785b 2750 7265 6669 7827  _prefix['Prefix'
-00011f40: 5d5b 3a2d 315d 290a 2020 2020 2020 2020  ][:-1]).        
-00011f50: 2020 2020 2020 2020 666f 7220 636f 6e74          for cont
-00011f60: 656e 7420 696e 2072 6573 702e 6765 7428  ent in resp.get(
-00011f70: 2743 6f6e 7465 6e74 7327 2c20 5b5d 293a  'Contents', []):
-00011f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011f90: 2020 2020 2066 696c 6573 2e61 7070 656e       files.appen
-00011fa0: 6428 636f 6e74 656e 745b 274b 6579 275d  d(content['Key']
-00011fb0: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
-00011fc0: 6972 7320 3d20 736f 7274 6564 2864 6972  irs = sorted(dir
-00011fd0: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
-00011fe0: 7461 636b 2e65 7874 656e 6428 7265 7665  tack.extend(reve
-00011ff0: 7273 6564 2864 6972 7329 290a 0a20 2020  rsed(dirs))..   
-00012000: 2020 2020 2020 2020 2072 6f6f 7420 3d20           root = 
-00012010: 7333 5f70 6174 685f 6a6f 696e 280a 2020  s3_path_join(.  
-00012020: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00012030: 7b73 656c 662e 5f70 726f 746f 636f 6c5f  {self._protocol_
-00012040: 7769 7468 5f70 726f 6669 6c65 7d3a 2f2f  with_profile}://
-00012050: 272c 2062 7563 6b65 742c 2063 7572 7265  ', bucket, curre
-00012060: 6e74 295b 3a2d 315d 0a20 2020 2020 2020  nt)[:-1].       
-00012070: 2020 2020 2064 6972 7320 3d20 5b70 6174       dirs = [pat
-00012080: 685b 6c65 6e28 6375 7272 656e 7429 3a5d  h[len(current):]
-00012090: 2066 6f72 2070 6174 6820 696e 2064 6972   for path in dir
-000120a0: 735d 0a20 2020 2020 2020 2020 2020 2066  s].            f
-000120b0: 696c 6573 203d 2073 6f72 7465 6428 7061  iles = sorted(pa
-000120c0: 7468 5b6c 656e 2863 7572 7265 6e74 293a  th[len(current):
-000120d0: 5d20 666f 7220 7061 7468 2069 6e20 6669  ] for path in fi
-000120e0: 6c65 7329 0a20 2020 2020 2020 2020 2020  les).           
-000120f0: 2079 6965 6c64 2072 6f6f 742c 2064 6972   yield root, dir
-00012100: 732c 2066 696c 6573 0a0a 2020 2020 6465  s, files..    de
-00012110: 6620 6d64 3528 7365 6c66 2c20 7265 6361  f md5(self, reca
-00012120: 6c63 756c 6174 653a 2062 6f6f 6c20 3d20  lculate: bool = 
-00012130: 4661 6c73 652c 2066 6f6c 6c6f 776c 696e  False, followlin
-00012140: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-00012150: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00012160: 2020 2727 270a 2020 2020 2020 2020 4765    '''.        Ge
-00012170: 7420 6d64 3520 6d65 7461 2069 6e66 6f20  t md5 meta info 
-00012180: 696e 2066 696c 6573 2074 6861 7420 7570  in files that up
-00012190: 6c6f 6164 6564 2f63 6f70 6965 6420 7669  loaded/copied vi
-000121a0: 6120 6d65 6766 696c 650a 0a20 2020 2020  a megfile..     
-000121b0: 2020 2049 6620 6d65 7461 2069 6e66 6f20     If meta info 
-000121c0: 6973 206c 6f73 7420 6f72 206e 6f6e 2d65  is lost or non-e
-000121d0: 7869 7374 656e 742c 2072 6574 7572 6e20  xistent, return 
-000121e0: 4e6f 6e65 0a0a 2020 2020 2020 2020 3a70  None..        :p
-000121f0: 6172 616d 2072 6563 616c 6375 6c61 7465  aram recalculate
-00012200: 3a20 6361 6c63 756c 6174 6520 6d64 3520  : calculate md5 
-00012210: 696e 2072 6561 6c2d 7469 6d65 206f 7220  in real-time or 
-00012220: 7265 7475 726e 2073 3320 6574 6167 0a20  return s3 etag. 
-00012230: 2020 2020 2020 203a 7061 7261 6d20 666f         :param fo
-00012240: 6c6c 6f77 6c69 6e6b 733a 2049 6620 6973  llowlinks: If is
-00012250: 2054 7275 652c 2063 616c 6375 6c61 7465   True, calculate
-00012260: 206d 6435 2066 6f72 2072 6561 6c20 6669   md5 for real fi
-00012270: 6c65 0a20 2020 2020 2020 203a 7265 7475  le.        :retu
-00012280: 726e 733a 206d 6435 206d 6574 6120 696e  rns: md5 meta in
-00012290: 666f 0a20 2020 2020 2020 2027 2727 0a20  fo.        '''. 
-000122a0: 2020 2020 2020 2062 7563 6b65 742c 205f         bucket, _
-000122b0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-000122c0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-000122d0: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
-000122e0: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
-000122f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00012300: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
-00012310: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
-00012320: 2020 2020 2020 2020 2027 456d 7074 7920           'Empty 
-00012330: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
-00012340: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
-00012350: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-00012360: 2020 2020 7374 6174 203d 2073 656c 662e      stat = self.
-00012370: 7374 6174 2866 6f6c 6c6f 775f 7379 6d6c  stat(follow_syml
-00012380: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-00012390: 290a 2020 2020 2020 2020 6966 2073 7461  ).        if sta
-000123a0: 742e 6973 6469 723a 0a20 2020 2020 2020  t.isdir:.       
-000123b0: 2020 2020 2068 6173 685f 6d64 3520 3d20       hash_md5 = 
-000123c0: 6861 7368 6c69 622e 6d64 3528 2920 2023  hashlib.md5()  #
-000123d0: 206e 6f73 6563 0a20 2020 2020 2020 2020   nosec.         
-000123e0: 2020 2066 6f72 2066 696c 655f 6e61 6d65     for file_name
-000123f0: 2069 6e20 7365 6c66 2e6c 6973 7464 6972   in self.listdir
-00012400: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00012410: 2020 2020 6368 756e 6b20 3d20 5333 5061      chunk = S3Pa
-00012420: 7468 280a 2020 2020 2020 2020 2020 2020  th(.            
-00012430: 2020 2020 2020 2020 7333 5f70 6174 685f          s3_path_
-00012440: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00012450: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00012460: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00012470: 746f 636f 6c2c 0a20 2020 2020 2020 2020  tocol,.         
-00012480: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00012490: 696c 655f 6e61 6d65 2929 2e6d 6435 2872  ile_name)).md5(r
-000124a0: 6563 616c 6375 6c61 7465 3d72 6563 616c  ecalculate=recal
-000124b0: 6375 6c61 7465 292e 656e 636f 6465 2829  culate).encode()
-000124c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000124d0: 2068 6173 685f 6d64 352e 7570 6461 7465   hash_md5.update
-000124e0: 2863 6875 6e6b 290a 2020 2020 2020 2020  (chunk).        
-000124f0: 2020 2020 7265 7475 726e 2068 6173 685f      return hash_
-00012500: 6d64 352e 6865 7864 6967 6573 7428 290a  md5.hexdigest().
-00012510: 2020 2020 2020 2020 6966 2072 6563 616c          if recal
-00012520: 6375 6c61 7465 3a0a 2020 2020 2020 2020  culate:.        
-00012530: 2020 2020 7061 7468 5f69 6e73 7461 6e63      path_instanc
-00012540: 6520 3d20 7365 6c66 0a20 2020 2020 2020  e = self.       
-00012550: 2020 2020 2069 6620 666f 6c6c 6f77 6c69       if followli
-00012560: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
-00012570: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00012580: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00012590: 7468 5f69 6e73 7461 6e63 6520 3d20 7365  th_instance = se
-000125a0: 6c66 2e72 6561 646c 696e 6b28 290a 2020  lf.readlink().  
-000125b0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-000125c0: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
-000125d0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-000125e0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-000125f0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00012600: 7061 7468 5f69 6e73 7461 6e63 652e 6f70  path_instance.op
-00012610: 656e 2827 7262 2729 2061 7320 663a 0a20  en('rb') as f:. 
-00012620: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00012630: 6574 7572 6e20 6361 6c63 756c 6174 655f  eturn calculate_
-00012640: 6d64 3528 6629 0a20 2020 2020 2020 2072  md5(f).        r
-00012650: 6574 7572 6e20 7374 6174 2e65 7874 7261  eturn stat.extra
-00012660: 2e67 6574 2827 4554 6167 272c 2027 2729  .get('ETag', '')
-00012670: 5b31 3a2d 315d 0a0a 2020 2020 6465 6620  [1:-1]..    def 
-00012680: 636f 7079 280a 2020 2020 2020 2020 2020  copy(.          
-00012690: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-000126a0: 2020 2020 6473 745f 7572 6c3a 2050 6174      dst_url: Pat
-000126b0: 684c 696b 652c 0a20 2020 2020 2020 2020  hLike,.         
-000126c0: 2020 2066 6f6c 6c6f 776c 696e 6b73 3a20     followlinks: 
-000126d0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-000126e0: 2020 2020 2020 2020 2020 6361 6c6c 6261            callba
-000126f0: 636b 3a20 4f70 7469 6f6e 616c 5b43 616c  ck: Optional[Cal
-00012700: 6c61 626c 655b 5b69 6e74 5d2c 204e 6f6e  lable[[int], Non
-00012710: 655d 5d20 3d20 4e6f 6e65 2920 2d3e 204e  e]] = None) -> N
-00012720: 6f6e 653a 0a20 2020 2020 2020 2027 2727  one:.        '''
-00012730: 2046 696c 6520 636f 7079 206f 6e20 5333   File copy on S3
-00012740: 0a20 2020 2020 2020 2043 6f70 7920 636f  .        Copy co
-00012750: 6e74 656e 7420 6f66 2066 696c 6520 6f6e  ntent of file on
-00012760: 2060 7372 635f 7061 7468 6020 746f 2060   `src_path` to `
-00012770: 6473 745f 7061 7468 602e 0a20 2020 2020  dst_path`..     
-00012780: 2020 2049 7427 7320 6361 6c6c 6572 2773     It's caller's
-00012790: 2072 6573 706f 6e73 6562 696c 6974 7920   responsebility 
-000127a0: 746f 2065 6e73 7572 6520 7468 6520 7333  to ensure the s3
-000127b0: 5f69 7366 696c 6528 7372 635f 7572 6c29  _isfile(src_url)
-000127c0: 203d 3d20 5472 7565 0a0a 2020 2020 2020   == True..      
-000127d0: 2020 3a70 6172 616d 2064 7374 5f70 6174    :param dst_pat
-000127e0: 683a 2054 6172 6765 7420 6669 6c65 2070  h: Target file p
-000127f0: 6174 680a 2020 2020 2020 2020 3a70 6172  ath.        :par
-00012800: 616d 2063 616c 6c62 6163 6b3a 2043 616c  am callback: Cal
-00012810: 6c65 6420 7065 7269 6f64 6963 616c 6c79  led periodically
-00012820: 2064 7572 696e 6720 636f 7079 2c20 616e   during copy, an
-00012830: 6420 7468 6520 696e 7075 7420 7061 7261  d the input para
-00012840: 6d65 7465 7220 6973 2074 6865 2064 6174  meter is the dat
-00012850: 6120 7369 7a65 2028 696e 2062 7974 6573  a size (in bytes
-00012860: 2920 6f66 2063 6f70 7920 7369 6e63 6520  ) of copy since 
-00012870: 7468 6520 6c61 7374 2063 616c 6c0a 2020  the last call.  
-00012880: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00012890: 2020 7372 635f 7572 6c20 3d20 7365 6c66    src_url = self
-000128a0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-000128b0: 636f 6c0a 2020 2020 2020 2020 7372 635f  col.        src_
-000128c0: 6275 636b 6574 2c20 7372 635f 6b65 7920  bucket, src_key 
-000128d0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-000128e0: 7263 5f75 726c 290a 2020 2020 2020 2020  rc_url).        
-000128f0: 6473 745f 6275 636b 6574 2c20 6473 745f  dst_bucket, dst_
-00012900: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-00012910: 726c 2864 7374 5f75 726c 290a 0a20 2020  rl(dst_url)..   
-00012920: 2020 2020 2069 6620 6e6f 7420 7372 635f       if not src_
-00012930: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-00012940: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-00012950: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-00012960: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
-00012970: 6d65 3a20 2572 2720 2520 7372 635f 7572  me: %r' % src_ur
-00012980: 6c29 0a20 2020 2020 2020 2069 6620 7365  l).        if se
-00012990: 6c66 2e69 735f 6469 7228 293a 0a20 2020  lf.is_dir():.   
-000129a0: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-000129b0: 3349 7341 4469 7265 6374 6f72 7945 7272  3IsADirectoryErr
-000129c0: 6f72 2827 4973 2061 2064 6972 6563 746f  or('Is a directo
-000129d0: 7279 3a20 2572 2720 2520 7372 635f 7572  ry: %r' % src_ur
-000129e0: 6c29 0a0a 2020 2020 2020 2020 6966 206e  l)..        if n
-000129f0: 6f74 2064 7374 5f62 7563 6b65 743a 0a20  ot dst_bucket:. 
-00012a00: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00012a10: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00012a20: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
-00012a30: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00012a40: 2064 7374 5f75 726c 290a 2020 2020 2020   dst_url).      
-00012a50: 2020 6966 206e 6f74 2064 7374 5f6b 6579    if not dst_key
-00012a60: 206f 7220 6473 745f 6b65 792e 656e 6473   or dst_key.ends
-00012a70: 7769 7468 2827 2f27 293a 0a20 2020 2020  with('/'):.     
-00012a80: 2020 2020 2020 2072 6169 7365 2053 3349         raise S3I
-00012a90: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
-00012aa0: 2827 4973 2061 2064 6972 6563 746f 7279  ('Is a directory
-00012ab0: 3a20 2572 2720 2520 6473 745f 7572 6c29  : %r' % dst_url)
-00012ac0: 0a0a 2020 2020 2020 2020 6966 2066 6f6c  ..        if fol
-00012ad0: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
-00012ae0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00012af0: 2020 2020 2020 2020 2020 2073 335f 7572             s3_ur
-00012b00: 6c20 3d20 7365 6c66 2e72 6561 646c 696e  l = self.readlin
-00012b10: 6b28 292e 7061 7468 0a20 2020 2020 2020  k().path.       
-00012b20: 2020 2020 2020 2020 2073 7263 5f62 7563           src_buc
-00012b30: 6b65 742c 2073 7263 5f6b 6579 203d 2070  ket, src_key = p
-00012b40: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
-00012b50: 726c 290a 2020 2020 2020 2020 2020 2020  rl).            
-00012b60: 6578 6365 7074 2053 334e 6f74 414c 696e  except S3NotALin
-00012b70: 6b45 7272 6f72 3a0a 2020 2020 2020 2020  kError:.        
-00012b80: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00012b90: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00012ba0: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
-00012bb0: 656e 742e 636f 7079 280a 2020 2020 2020  ent.copy(.      
-00012bc0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00012bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012be0: 2742 7563 6b65 7427 3a20 7372 635f 6275  'Bucket': src_bu
-00012bf0: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
-00012c00: 2020 2020 2020 2020 2020 274b 6579 273a            'Key':
-00012c10: 2073 7263 5f6b 6579 2c0a 2020 2020 2020   src_key,.      
-00012c20: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00012c30: 2020 2020 2020 2020 2020 2020 2042 7563               Buc
-00012c40: 6b65 743d 6473 745f 6275 636b 6574 2c0a  ket=dst_bucket,.
-00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c60: 4b65 793d 6473 745f 6b65 792c 0a20 2020  Key=dst_key,.   
-00012c70: 2020 2020 2020 2020 2020 2020 2043 616c               Cal
-00012c80: 6c62 6163 6b3d 6361 6c6c 6261 636b 290a  lback=callback).
-00012c90: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00012ca0: 7863 6570 7469 6f6e 2061 7320 6572 726f  xception as erro
-00012cb0: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
-00012cc0: 7272 6f72 203d 2074 7261 6e73 6c61 7465  rror = translate
-00012cd0: 5f73 335f 6572 726f 7228 6572 726f 722c  _s3_error(error,
-00012ce0: 2064 7374 5f75 726c 290a 2020 2020 2020   dst_url).      
-00012cf0: 2020 2020 2020 2320 4572 726f 7220 6361        # Error ca
-00012d00: 6e27 7420 6865 6c70 2074 656c 6c20 7768  n't help tell wh
-00012d10: 6963 6820 6973 2070 726f 626c 656d 6174  ich is problemat
-00012d20: 6963 0a20 2020 2020 2020 2020 2020 2069  ic.            i
-00012d30: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
-00012d40: 6f72 2c20 5333 4275 636b 6574 4e6f 7446  or, S3BucketNotF
-00012d50: 6f75 6e64 4572 726f 7229 3a0a 2020 2020  oundError):.    
-00012d60: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00012d70: 6f74 2073 656c 662e 6861 7362 7563 6b65  ot self.hasbucke
-00012d80: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
-00012d90: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00012da0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-00012db0: 7272 6f72 2827 4e6f 2073 7563 6820 6275  rror('No such bu
-00012dc0: 636b 6574 3a20 2572 2720 2520 7372 635f  cket: %r' % src_
-00012dd0: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
-00012de0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
-00012df0: 2865 7272 6f72 2c20 5333 4669 6c65 4e6f  (error, S3FileNo
-00012e00: 7446 6f75 6e64 4572 726f 7229 3a0a 2020  tFoundError):.  
-00012e10: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00012e20: 206e 6f74 2073 656c 662e 6973 5f66 696c   not self.is_fil
-00012e30: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
-00012e40: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00012e50: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-00012e60: 6f72 2827 4e6f 2073 7563 6820 6669 6c65  or('No such file
-00012e70: 3a20 2572 2720 2520 7372 635f 7572 6c29  : %r' % src_url)
-00012e80: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00012e90: 7365 2065 7272 6f72 0a0a 2020 2020 6465  se error..    de
-00012ea0: 6620 7379 6e63 2873 656c 662c 2064 7374  f sync(self, dst
-00012eb0: 5f75 726c 3a20 5061 7468 4c69 6b65 2c20  _url: PathLike, 
-00012ec0: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00012ed0: 6c20 3d20 4661 6c73 6529 202d 3e20 4e6f  l = False) -> No
-00012ee0: 6e65 3a0a 2020 2020 2020 2020 2727 270a  ne:.        '''.
-00012ef0: 2020 2020 2020 2020 436f 7079 2066 696c          Copy fil
-00012f00: 652f 6469 7265 6374 6f72 7920 6f6e 2073  e/directory on s
-00012f10: 7263 5f75 726c 2074 6f20 6473 745f 7572  rc_url to dst_ur
-00012f20: 6c0a 0a20 2020 2020 2020 203a 7061 7261  l..        :para
-00012f30: 6d20 6473 745f 7572 6c3a 2047 6976 656e  m dst_url: Given
-00012f40: 2064 6573 7469 6e61 7469 6f6e 2070 6174   destination pat
-00012f50: 680a 2020 2020 2020 2020 2727 270a 2020  h.        '''.  
-00012f60: 2020 2020 2020 666f 7220 7372 635f 6669        for src_fi
-00012f70: 6c65 5f70 6174 682c 2064 7374 5f66 696c  le_path, dst_fil
-00012f80: 655f 7061 7468 2069 6e20 5f73 335f 7363  e_path in _s3_sc
-00012f90: 616e 5f70 6169 7273 280a 2020 2020 2020  an_pairs(.      
-00012fa0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00012fb0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00012fc0: 6c2c 2064 7374 5f75 726c 293a 0a20 2020  l, dst_url):.   
-00012fd0: 2020 2020 2020 2020 2073 7263 5f66 696c           src_fil
-00012fe0: 655f 7061 7468 203d 2073 656c 662e 6672  e_path = self.fr
-00012ff0: 6f6d 5f70 6174 6828 7372 635f 6669 6c65  om_path(src_file
-00013000: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-00013010: 2020 2064 7374 5f66 696c 655f 7061 7468     dst_file_path
-00013020: 203d 2073 656c 662e 6672 6f6d 5f70 6174   = self.from_pat
-00013030: 6828 6473 745f 6669 6c65 5f70 6174 6829  h(dst_file_path)
-00013040: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013050: 6473 745f 6669 6c65 5f70 6174 682e 6578  dst_file_path.ex
-00013060: 6973 7473 2829 2061 6e64 2069 735f 7361  ists() and is_sa
-00013070: 6d65 5f66 696c 6528 0a20 2020 2020 2020  me_file(.       
-00013080: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00013090: 5f66 696c 655f 7061 7468 2e73 7461 7428  _file_path.stat(
-000130a0: 292c 2064 7374 5f66 696c 655f 7061 7468  ), dst_file_path
-000130b0: 2e73 7461 7428 292c 2027 636f 7079 2729  .stat(), 'copy')
-000130c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000130d0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-000130e0: 2020 2020 2020 2073 7263 5f66 696c 655f         src_file_
-000130f0: 7061 7468 2e63 6f70 7928 6473 745f 6669  path.copy(dst_fi
-00013100: 6c65 5f70 6174 682c 2066 6f6c 6c6f 776c  le_path, followl
-00013110: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-00013120: 290a 0a20 2020 2064 6566 2073 796d 6c69  )..    def symli
-00013130: 6e6b 2873 656c 662c 2064 7374 5f70 6174  nk(self, dst_pat
-00013140: 683a 2050 6174 684c 696b 6529 202d 3e20  h: PathLike) -> 
-00013150: 4e6f 6e65 3a0a 2020 2020 2020 2020 2727  None:.        ''
-00013160: 270a 2020 2020 2020 2020 4372 6561 7465  '.        Create
-00013170: 2061 2073 796d 626f 6c69 6320 6c69 6e6b   a symbolic link
-00013180: 2070 6f69 6e74 696e 6720 746f 2073 7263   pointing to src
-00013190: 5f70 6174 6820 6e61 6d65 6420 6473 745f  _path named dst_
-000131a0: 7061 7468 2e0a 0a20 2020 2020 2020 203a  path...        :
-000131b0: 7061 7261 6d20 6473 745f 7061 7468 3a20  param dst_path: 
-000131c0: 4465 7369 6e61 7469 6f6e 2070 6174 680a  Desination path.
-000131d0: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
-000131e0: 2053 334e 616d 6554 6f6f 4c6f 6e67 4572   S3NameTooLongEr
-000131f0: 726f 722c 2053 3342 7563 6b65 744e 6f74  ror, S3BucketNot
-00013200: 466f 756e 6445 7272 6f72 2c20 5333 4973  FoundError, S3Is
-00013210: 4144 6972 6563 746f 7279 4572 726f 720a  ADirectoryError.
-00013220: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-00013230: 2020 2020 6966 206c 656e 2873 7472 2873      if len(str(s
-00013240: 656c 662e 5f73 335f 7061 7468 292e 656e  elf._s3_path).en
-00013250: 636f 6465 2829 2920 3e20 3130 3234 3a0a  code()) > 1024:.
-00013260: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00013270: 6520 5333 4e61 6d65 546f 6f4c 6f6e 6745  e S3NameTooLongE
-00013280: 7272 6f72 2827 4669 6c65 206e 616d 6520  rror('File name 
-00013290: 746f 6f20 6c6f 6e67 3a20 2572 2720 2520  too long: %r' % 
-000132a0: 6473 745f 7061 7468 290a 2020 2020 2020  dst_path).      
-000132b0: 2020 7372 635f 6275 636b 6574 2c20 7372    src_bucket, sr
-000132c0: 635f 6b65 7920 3d20 7061 7273 655f 7333  c_key = parse_s3
-000132d0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-000132e0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-000132f0: 2020 2020 2020 6473 745f 6275 636b 6574        dst_bucket
-00013300: 2c20 6473 745f 6b65 7920 3d20 7061 7273  , dst_key = pars
-00013310: 655f 7333 5f75 726c 2864 7374 5f70 6174  e_s3_url(dst_pat
-00013320: 6829 0a0a 2020 2020 2020 2020 6966 206e  h)..        if n
-00013330: 6f74 2073 7263 5f62 7563 6b65 743a 0a20  ot src_bucket:. 
-00013340: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013350: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00013360: 6445 7272 6f72 2827 456d 7074 7920 6275  dError('Empty bu
-00013370: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00013380: 2073 656c 662e 7061 7468 290a 2020 2020   self.path).    
-00013390: 2020 2020 6966 206e 6f74 2064 7374 5f62      if not dst_b
-000133a0: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
-000133b0: 2020 2072 6169 7365 2053 3342 7563 6b65     raise S3Bucke
-000133c0: 744e 6f74 466f 756e 6445 7272 6f72 2827  tNotFoundError('
-000133d0: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
-000133e0: 653a 2025 7227 2025 2064 7374 5f70 6174  e: %r' % dst_pat
-000133f0: 6829 0a20 2020 2020 2020 2069 6620 6e6f  h).        if no
-00013400: 7420 6473 745f 6b65 7920 6f72 2064 7374  t dst_key or dst
-00013410: 5f6b 6579 2e65 6e64 7377 6974 6828 272f  _key.endswith('/
-00013420: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00013430: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
-00013440: 746f 7279 4572 726f 7228 2749 7320 6120  toryError('Is a 
-00013450: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
-00013460: 2064 7374 5f70 6174 6829 0a0a 2020 2020   dst_path)..    
-00013470: 2020 2020 7372 635f 7061 7468 203d 2073      src_path = s
-00013480: 656c 662e 5f73 335f 7061 7468 0a20 2020  elf._s3_path.   
-00013490: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000134a0: 2020 2020 2020 7372 635f 7061 7468 203d        src_path =
-000134b0: 2073 656c 662e 7265 6164 6c69 6e6b 2829   self.readlink()
-000134c0: 2e5f 7333 5f70 6174 680a 2020 2020 2020  ._s3_path.      
-000134d0: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
-000134e0: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
-000134f0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-00013500: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
-00013510: 5f65 7272 6f72 2864 7374 5f70 6174 6829  _error(dst_path)
-00013520: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00013530: 6c66 2e5f 636c 6965 6e74 2e70 7574 5f6f  lf._client.put_o
-00013540: 626a 6563 7428 0a20 2020 2020 2020 2020  bject(.         
-00013550: 2020 2020 2020 2042 7563 6b65 743d 6473         Bucket=ds
-00013560: 745f 6275 636b 6574 2c0a 2020 2020 2020  t_bucket,.      
-00013570: 2020 2020 2020 2020 2020 4b65 793d 6473            Key=ds
-00013580: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
-00013590: 2020 2020 2020 204d 6574 6164 6174 613d         Metadata=
-000135a0: 7b22 7379 6d6c 696e 6b5f 746f 223a 2073  {"symlink_to": s
-000135b0: 7263 5f70 6174 687d 290a 0a20 2020 2064  rc_path})..    d
-000135c0: 6566 2072 6561 646c 696e 6b28 7365 6c66  ef readlink(self
-000135d0: 2920 2d3e 2027 5333 5061 7468 273a 0a20  ) -> 'S3Path':. 
-000135e0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-000135f0: 2020 2052 6574 7572 6e20 6120 5333 5061     Return a S3Pa
-00013600: 7468 2069 6e73 7461 6e63 6520 7265 7072  th instance repr
-00013610: 6573 656e 7469 6e67 2074 6865 2070 6174  esenting the pat
-00013620: 6820 746f 2077 6869 6368 2074 6865 2073  h to which the s
-00013630: 796d 626f 6c69 6320 6c69 6e6b 2070 6f69  ymbolic link poi
-00013640: 6e74 732e 0a0a 2020 2020 2020 2020 3a72  nts...        :r
-00013650: 6574 7572 6e73 3a20 5265 7475 726e 2061  eturns: Return a
-00013660: 2053 3350 6174 6820 696e 7374 616e 6365   S3Path instance
-00013670: 2072 6570 7265 7365 6e74 696e 6720 7468   representing th
-00013680: 6520 7061 7468 2074 6f20 7768 6963 6820  e path to which 
-00013690: 7468 6520 7379 6d62 6f6c 6963 206c 696e  the symbolic lin
-000136a0: 6b20 706f 696e 7473 2e0a 2020 2020 2020  k points..      
-000136b0: 2020 3a72 6169 7365 733a 2053 334e 616d    :raises: S3Nam
-000136c0: 6554 6f6f 4c6f 6e67 4572 726f 722c 2053  eTooLongError, S
-000136d0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-000136e0: 7272 6f72 2c20 5333 4973 4144 6972 6563  rror, S3IsADirec
-000136f0: 746f 7279 4572 726f 722c 2053 334e 6f74  toryError, S3Not
-00013700: 414c 696e 6b45 7272 6f72 0a20 2020 2020  ALinkError.     
-00013710: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-00013720: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-00013730: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-00013740: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00013750: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-00013760: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-00013770: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
-00013780: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
-00013790: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000137a0: 2020 2027 456d 7074 7920 6275 636b 6574     'Empty bucket
-000137b0: 206e 616d 653a 2025 7227 2025 2073 656c   name: %r' % sel
-000137c0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-000137d0: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
-000137e0: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
-000137f0: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
-00013800: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013810: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
-00013820: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00013830: 2020 2020 2020 2749 7320 6120 6469 7265        'Is a dire
-00013840: 6374 6f72 793a 2025 7227 2025 2073 656c  ctory: %r' % sel
-00013850: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00013860: 6f63 6f6c 290a 2020 2020 2020 2020 6d65  ocol).        me
-00013870: 7461 6461 7461 203d 2073 656c 662e 5f73  tadata = self._s
-00013880: 335f 6765 745f 6d65 7461 6461 7461 2829  3_get_metadata()
-00013890: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-000138a0: 2027 7379 6d6c 696e 6b5f 746f 2720 696e   'symlink_to' in
-000138b0: 206d 6574 6164 6174 613a 0a20 2020 2020   metadata:.     
-000138c0: 2020 2020 2020 2072 6169 7365 2053 334e         raise S3N
-000138d0: 6f74 414c 696e 6b45 7272 6f72 2827 4e6f  otALinkError('No
-000138e0: 7420 6120 6c69 6e6b 3a20 2572 2720 2520  t a link: %r' % 
-000138f0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-00013900: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
-00013910: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00013920: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
-00013930: 726f 6d5f 7061 7468 286d 6574 6164 6174  rom_path(metadat
-00013940: 615b 2773 796d 6c69 6e6b 5f74 6f27 5d29  a['symlink_to'])
-00013950: 0a0a 2020 2020 6465 6620 6973 5f73 796d  ..    def is_sym
-00013960: 6c69 6e6b 2873 656c 6629 202d 3e20 626f  link(self) -> bo
-00013970: 6f6c 3a0a 2020 2020 2020 2020 2727 270a  ol:.        '''.
-00013980: 2020 2020 2020 2020 5465 7374 2077 6865          Test whe
-00013990: 7468 6572 2061 2070 6174 6820 6973 206c  ther a path is l
-000139a0: 696e 6b0a 0a20 2020 2020 2020 203a 7265  ink..        :re
-000139b0: 7475 726e 733a 2054 7275 6520 6966 2061  turns: True if a
-000139c0: 2070 6174 6820 6973 206c 696e 6b2c 2065   path is link, e
-000139d0: 6c73 6520 4661 6c73 650a 2020 2020 2020  lse False.      
-000139e0: 2020 3a72 6169 7365 733a 2053 334e 6f74    :raises: S3Not
-000139f0: 414c 696e 6b45 7272 6f72 0a20 2020 2020  ALinkError.     
-00013a00: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-00013a10: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-00013a20: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
-00013a30: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00013a40: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-00013a50: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
-00013a60: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-00013a70: 7365 0a20 2020 2020 2020 2069 6620 6e6f  se.        if no
-00013a80: 7420 6b65 7920 6f72 206b 6579 2e65 6e64  t key or key.end
-00013a90: 7377 6974 6828 272f 2729 3a0a 2020 2020  swith('/'):.    
-00013aa0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00013ab0: 616c 7365 0a20 2020 2020 2020 206d 6574  alse.        met
-00013ac0: 6164 6174 6120 3d20 7365 6c66 2e5f 7333  adata = self._s3
-00013ad0: 5f67 6574 5f6d 6574 6164 6174 6128 290a  _get_metadata().
-00013ae0: 2020 2020 2020 2020 7265 7475 726e 2027          return '
-00013af0: 7379 6d6c 696e 6b5f 746f 2720 696e 206d  symlink_to' in m
-00013b00: 6574 6164 6174 610a 0a20 2020 2064 6566  etadata..    def
-00013b10: 2073 6176 6528 7365 6c66 2c20 6669 6c65   save(self, file
-00013b20: 5f6f 626a 6563 743a 2042 696e 6172 7949  _object: BinaryI
-00013b30: 4f29 3a0a 2020 2020 2020 2020 2727 2757  O):.        '''W
-00013b40: 7269 7465 2074 6865 206f 7065 6e65 6420  rite the opened 
-00013b50: 6269 6e61 7279 2073 7472 6561 6d20 746f  binary stream to
-00013b60: 2073 7065 6369 6669 6564 2070 6174 682c   specified path,
-00013b70: 2062 7574 2074 6865 2073 7472 6561 6d20   but the stream 
-00013b80: 776f 6e27 7420 6265 2063 6c6f 7365 640a  won't be closed.
-00013b90: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00013ba0: 6669 6c65 5f6f 626a 6563 743a 2053 7472  file_object: Str
-00013bb0: 6561 6d20 746f 2062 6520 7265 6164 0a20  eam to be read. 
-00013bc0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00013bd0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-00013be0: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-00013bf0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00013c00: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-00013c10: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
-00013c20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00013c30: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-00013c40: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00013c50: 2020 2020 2020 2027 456d 7074 7920 6275         'Empty bu
-00013c60: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00013c70: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-00013c80: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-00013c90: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
-00013ca0: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
-00013cb0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00013cc0: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
-00013cd0: 6f72 7945 7272 6f72 280a 2020 2020 2020  oryError(.      
-00013ce0: 2020 2020 2020 2020 2020 2749 7320 6120            'Is a 
-00013cf0: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
-00013d00: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-00013d10: 7072 6f74 6f63 6f6c 290a 0a20 2020 2020  protocol)..     
-00013d20: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
-00013d30: 5f65 7272 6f72 2873 656c 662e 7061 7468  _error(self.path
-00013d40: 5f77 6974 685f 7072 6f74 6f63 6f6c 293a  _with_protocol):
-00013d50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00013d60: 662e 5f63 6c69 656e 742e 7570 6c6f 6164  f._client.upload
-00013d70: 5f66 696c 656f 626a 2866 696c 655f 6f62  _fileobj(file_ob
-00013d80: 6a65 6374 2c20 4275 636b 6574 3d62 7563  ject, Bucket=buc
-00013d90: 6b65 742c 204b 6579 3d6b 6579 290a 0a20  ket, Key=key).. 
-00013da0: 2020 2064 6566 206f 7065 6e28 0a20 2020     def open(.   
-00013db0: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-00013dc0: 2020 2020 2020 2020 2020 206d 6f64 653a             mode:
-00013dd0: 2073 7472 203d 2027 7227 2c0a 2020 2020   str = 'r',.    
-00013de0: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00013df0: 2020 2020 2020 2073 335f 6f70 656e 5f66         s3_open_f
-00013e00: 756e 633a 2043 616c 6c61 626c 655b 5b73  unc: Callable[[s
-00013e10: 7472 2c20 7374 725d 2c20 4269 6e61 7279  tr, str], Binary
-00013e20: 494f 5d20 3d20 7333 5f6f 7065 6e2c 0a20  IO] = s3_open,. 
-00013e30: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-00013e40: 7267 7329 202d 3e20 494f 5b41 6e79 5374  rgs) -> IO[AnySt
-00013e50: 725d 3a20 2023 2070 7974 7970 653a 2064  r]:  # pytype: d
-00013e60: 6973 6162 6c65 3d73 6967 6e61 7475 7265  isable=signature
-00013e70: 2d6d 6973 6d61 7463 680a 2020 2020 2020  -mismatch.      
-00013e80: 2020 7265 7475 726e 2073 335f 6f70 656e    return s3_open
-00013e90: 5f66 756e 6328 0a20 2020 2020 2020 2020  _func(.         
-00013ea0: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
-00013eb0: 685f 7072 6f74 6f63 6f6c 2c20 6d6f 6465  h_protocol, mode
-00013ec0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00013ed0: 6e65 6365 7373 6172 795f 7061 7261 6d73  necessary_params
-00013ee0: 2873 335f 6f70 656e 5f66 756e 632c 202a  (s3_open_func, *
-00013ef0: 2a6b 7761 7267 7329 290a 0a20 2020 2064  *kwargs))..    d
-00013f00: 6566 2061 6273 6f6c 7574 6528 7365 6c66  ef absolute(self
-00013f10: 2920 2d3e 2027 5333 5061 7468 273a 0a20  ) -> 'S3Path':. 
-00013f20: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00013f30: 2020 204d 616b 6520 7468 6520 7061 7468     Make the path
-00013f40: 2061 6273 6f6c 7574 652c 2077 6974 686f   absolute, witho
-00013f50: 7574 206e 6f72 6d61 6c69 7a61 7469 6f6e  ut normalization
-00013f60: 206f 7220 7265 736f 6c76 696e 6720 7379   or resolving sy
-00013f70: 6d6c 696e 6b73 2e20 5265 7475 726e 7320  mlinks. Returns 
-00013f80: 6120 6e65 7720 7061 7468 206f 626a 6563  a new path objec
-00013f90: 740a 2020 2020 2020 2020 2727 270a 2020  t.        '''.  
-00013fa0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00013fb0: 660a 0a20 2020 2064 6566 2063 7764 2873  f..    def cwd(s
-00013fc0: 656c 6629 202d 3e20 2753 3350 6174 6827  elf) -> 'S3Path'
-00013fd0: 3a0a 2020 2020 2020 2020 2727 2752 6574  :.        '''Ret
-00013fe0: 7572 6e20 6375 7272 656e 7420 776f 726b  urn current work
-00013ff0: 696e 6720 6469 7265 6374 6f72 790a 0a20  ing directory.. 
-00014000: 2020 2020 2020 2072 6574 7572 6e73 3a20         returns: 
-00014010: 4375 7272 656e 7420 776f 726b 696e 6720  Current working 
-00014020: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
-00014030: 2020 2727 270a 2020 2020 2020 2020 7265    '''.        re
-00014040: 7475 726e 2073 656c 662e 6672 6f6d 5f70  turn self.from_p
-00014050: 6174 6828 7365 6c66 2e70 6174 685f 7769  ath(self.path_wi
-00014060: 7468 5f70 726f 746f 636f 6c29 0a0a 0a63  th_protocol)...c
-00014070: 6c61 7373 204d 756c 7469 5061 7274 5772  lass MultiPartWr
-00014080: 6974 6572 3a0a 0a20 2020 2064 6566 205f  iter:..    def _
-00014090: 5f69 6e69 745f 5f28 7365 6c66 2c20 636c  _init__(self, cl
-000140a0: 6965 6e74 2c20 7061 7468 3a20 5061 7468  ient, path: Path
-000140b0: 4c69 6b65 2920 2d3e 204e 6f6e 653a 0a20  Like) -> None:. 
-000140c0: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
-000140d0: 656e 7420 3d20 636c 6965 6e74 0a20 2020  ent = client.   
-000140e0: 2020 2020 2073 656c 662e 5f6d 756c 7469       self._multi
-000140f0: 7061 7274 5f75 706c 6f61 645f 696e 666f  part_upload_info
-00014100: 203d 205b 5d0a 0a20 2020 2020 2020 2062   = []..        b
-00014110: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-00014120: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
-00014130: 2020 2020 2020 2020 7365 6c66 2e5f 6275          self._bu
-00014140: 636b 6574 203d 2062 7563 6b65 740a 2020  cket = bucket.  
-00014150: 2020 2020 2020 7365 6c66 2e5f 6b65 7920        self._key 
-00014160: 3d20 6b65 790a 2020 2020 2020 2020 7365  = key.        se
-00014170: 6c66 2e5f 7570 6c6f 6164 5f69 6420 3d20  lf._upload_id = 
-00014180: 7365 6c66 2e5f 636c 6965 6e74 2e63 7265  self._client.cre
-00014190: 6174 655f 6d75 6c74 6970 6172 745f 7570  ate_multipart_up
-000141a0: 6c6f 6164 280a 2020 2020 2020 2020 2020  load(.          
-000141b0: 2020 4275 636b 6574 3d73 656c 662e 5f62    Bucket=self._b
-000141c0: 7563 6b65 742c 204b 6579 3d73 656c 662e  ucket, Key=self.
-000141d0: 5f6b 6579 295b 2755 706c 6f61 6449 6427  _key)['UploadId'
-000141e0: 5d0a 0a20 2020 2064 6566 2075 706c 6f61  ]..    def uploa
-000141f0: 645f 7061 7274 2873 656c 662c 2070 6172  d_part(self, par
-00014200: 745f 6e75 6d3a 2069 6e74 2c20 6669 6c65  t_num: int, file
-00014210: 5f6f 626a 3a20 696f 2e42 7974 6573 494f  _obj: io.BytesIO
-00014220: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00014230: 2020 2072 6573 706f 6e73 6520 3d20 7365     response = se
-00014240: 6c66 2e5f 636c 6965 6e74 2e75 706c 6f61  lf._client.uploa
-00014250: 645f 7061 7274 280a 2020 2020 2020 2020  d_part(.        
-00014260: 2020 2020 426f 6479 3d66 696c 655f 6f62      Body=file_ob
-00014270: 6a2c 0a20 2020 2020 2020 2020 2020 2055  j,.            U
-00014280: 706c 6f61 6449 643d 7365 6c66 2e5f 7570  ploadId=self._up
-00014290: 6c6f 6164 5f69 642c 0a20 2020 2020 2020  load_id,.       
-000142a0: 2020 2020 2050 6172 744e 756d 6265 723d       PartNumber=
-000142b0: 7061 7274 5f6e 756d 2c0a 2020 2020 2020  part_num,.      
-000142c0: 2020 2020 2020 4275 636b 6574 3d73 656c        Bucket=sel
-000142d0: 662e 5f62 7563 6b65 742c 0a20 2020 2020  f._bucket,.     
-000142e0: 2020 2020 2020 204b 6579 3d73 656c 662e         Key=self.
-000142f0: 5f6b 6579 2c0a 2020 2020 2020 2020 290a  _key,.        ).
-00014300: 2020 2020 2020 2020 7365 6c66 2e5f 6d75          self._mu
-00014310: 6c74 6970 6172 745f 7570 6c6f 6164 5f69  ltipart_upload_i
-00014320: 6e66 6f2e 6170 7065 6e64 280a 2020 2020  nfo.append(.    
-00014330: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00014340: 2020 2020 2020 2020 2020 2750 6172 744e            'PartN
-00014350: 756d 6265 7227 3a20 7061 7274 5f6e 756d  umber': part_num
-00014360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014370: 2020 2745 5461 6727 3a20 7265 7370 6f6e    'ETag': respon
-00014380: 7365 5b27 4554 6167 275d 0a20 2020 2020  se['ETag'].     
-00014390: 2020 2020 2020 207d 290a 0a20 2020 2064         })..    d
-000143a0: 6566 2075 706c 6f61 645f 7061 7274 5f62  ef upload_part_b
-000143b0: 795f 7061 7468 7328 0a20 2020 2020 2020  y_paths(.       
-000143c0: 2020 2020 2073 656c 662c 2070 6172 745f       self, part_
-000143d0: 6e75 6d3a 2069 6e74 2c20 7061 7468 733a  num: int, paths:
-000143e0: 204c 6973 745b 5475 706c 655b 5061 7468   List[Tuple[Path
-000143f0: 4c69 6b65 2c20 7374 725d 5d29 202d 3e20  Like, str]]) -> 
-00014400: 4e6f 6e65 3a0a 2020 2020 2020 2020 6669  None:.        fi
-00014410: 6c65 5f6f 626a 203d 2069 6f2e 4279 7465  le_obj = io.Byte
-00014420: 7349 4f28 290a 2020 2020 2020 2020 666f  sIO().        fo
-00014430: 7220 7061 7468 2c20 6279 7465 735f 7261  r path, bytes_ra
-00014440: 6e67 6520 696e 2070 6174 6873 3a0a 2020  nge in paths:.  
-00014450: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
-00014460: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-00014470: 5f75 726c 2870 6174 6829 0a20 2020 2020  _url(path).     
-00014480: 2020 2020 2020 2069 6620 6279 7465 735f         if bytes_
-00014490: 7261 6e67 653a 0a20 2020 2020 2020 2020  range:.         
-000144a0: 2020 2020 2020 2066 696c 655f 6f62 6a2e         file_obj.
-000144b0: 7772 6974 6528 0a20 2020 2020 2020 2020  write(.         
-000144c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000144d0: 5f63 6c69 656e 742e 6765 745f 6f62 6a65  _client.get_obje
-000144e0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-000144f0: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
-00014500: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-00014510: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00014520: 2020 2020 2020 2020 2020 2020 5261 6e67              Rang
-00014530: 653d 6279 7465 735f 7261 6e67 6529 5b27  e=bytes_range)['
-00014540: 426f 6479 275d 2e72 6561 6428 2929 0a20  Body'].read()). 
-00014550: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00014560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014570: 2066 696c 655f 6f62 6a2e 7772 6974 6528   file_obj.write(
-00014580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014590: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
-000145a0: 742e 6765 745f 6f62 6a65 6374 2842 7563  t.get_object(Buc
-000145b0: 6b65 743d 6275 636b 6574 2c0a 2020 2020  ket=bucket,.    
-000145c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000145e0: 2020 2020 2020 2020 4b65 793d 6b65 7929          Key=key)
-000145f0: 5b27 426f 6479 275d 2e72 6561 6428 2929  ['Body'].read())
-00014600: 0a20 2020 2020 2020 2066 696c 655f 6f62  .        file_ob
-00014610: 6a2e 7365 656b 2830 2c20 6f73 2e53 4545  j.seek(0, os.SEE
-00014620: 4b5f 5345 5429 0a20 2020 2020 2020 2073  K_SET).        s
-00014630: 656c 662e 7570 6c6f 6164 5f70 6172 7428  elf.upload_part(
-00014640: 7061 7274 5f6e 756d 2c20 6669 6c65 5f6f  part_num, file_o
-00014650: 626a 290a 0a20 2020 2064 6566 2075 706c  bj)..    def upl
-00014660: 6f61 645f 7061 7274 5f63 6f70 7928 0a20  oad_part_copy(. 
-00014670: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00014680: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-00014690: 745f 6e75 6d3a 2069 6e74 2c0a 2020 2020  t_num: int,.    
-000146a0: 2020 2020 2020 2020 7061 7468 3a20 5061          path: Pa
-000146b0: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
-000146c0: 2020 2020 636f 7079 5f73 6f75 7263 655f      copy_source_
-000146d0: 7261 6e67 653a 204f 7074 696f 6e61 6c5b  range: Optional[
-000146e0: 7374 725d 203d 204e 6f6e 6529 202d 3e20  str] = None) -> 
-000146f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6275  None:.        bu
-00014700: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-00014710: 655f 7333 5f75 726c 2870 6174 6829 0a20  e_s3_url(path). 
-00014720: 2020 2020 2020 2070 6172 616d 7320 3d20         params = 
-00014730: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
-00014740: 2020 5570 6c6f 6164 4964 3d73 656c 662e    UploadId=self.
-00014750: 5f75 706c 6f61 645f 6964 2c0a 2020 2020  _upload_id,.    
-00014760: 2020 2020 2020 2020 5061 7274 4e75 6d62          PartNumb
-00014770: 6572 3d70 6172 745f 6e75 6d2c 0a20 2020  er=part_num,.   
-00014780: 2020 2020 2020 2020 2043 6f70 7953 6f75           CopySou
-00014790: 7263 653d 7b0a 2020 2020 2020 2020 2020  rce={.          
-000147a0: 2020 2020 2020 2742 7563 6b65 7427 3a20        'Bucket': 
-000147b0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-000147c0: 2020 2020 2020 2020 274b 6579 273a 206b          'Key': k
-000147d0: 6579 0a20 2020 2020 2020 2020 2020 207d  ey.            }
-000147e0: 2c0a 2020 2020 2020 2020 2020 2020 4275  ,.            Bu
-000147f0: 636b 6574 3d73 656c 662e 5f62 7563 6b65  cket=self._bucke
-00014800: 742c 0a20 2020 2020 2020 2020 2020 204b  t,.            K
-00014810: 6579 3d73 656c 662e 5f6b 6579 2c0a 2020  ey=self._key,.  
-00014820: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014830: 6966 2063 6f70 795f 736f 7572 6365 5f72  if copy_source_r
-00014840: 616e 6765 3a0a 2020 2020 2020 2020 2020  ange:.          
-00014850: 2020 7061 7261 6d73 5b27 436f 7079 536f    params['CopySo
-00014860: 7572 6365 5261 6e67 6527 5d20 3d20 636f  urceRange'] = co
-00014870: 7079 5f73 6f75 7263 655f 7261 6e67 650a  py_source_range.
-00014880: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00014890: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
-000148a0: 7570 6c6f 6164 5f70 6172 745f 636f 7079  upload_part_copy
-000148b0: 282a 2a70 6172 616d 7329 0a20 2020 2020  (**params).     
-000148c0: 2020 2073 656c 662e 5f6d 756c 7469 7061     self._multipa
-000148d0: 7274 5f75 706c 6f61 645f 696e 666f 2e61  rt_upload_info.a
-000148e0: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-000148f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00014900: 2020 2020 2027 5061 7274 4e75 6d62 6572       'PartNumber
-00014910: 273a 2070 6172 745f 6e75 6d2c 0a20 2020  ': part_num,.   
-00014920: 2020 2020 2020 2020 2020 2020 2027 4554               'ET
-00014930: 6167 273a 2072 6573 706f 6e73 655b 2743  ag': response['C
-00014940: 6f70 7950 6172 7452 6573 756c 7427 5d5b  opyPartResult'][
-00014950: 2745 5461 6727 5d0a 2020 2020 2020 2020  'ETag'].        
-00014960: 2020 2020 7d29 0a0a 2020 2020 6465 6620      })..    def 
-00014970: 636c 6f73 6528 7365 6c66 293a 0a20 2020  close(self):.   
-00014980: 2020 2020 2073 656c 662e 5f6d 756c 7469       self._multi
-00014990: 7061 7274 5f75 706c 6f61 645f 696e 666f  part_upload_info
-000149a0: 2e73 6f72 7428 6b65 793d 6c61 6d62 6461  .sort(key=lambda
-000149b0: 2074 3a20 745b 2750 6172 744e 756d 6265   t: t['PartNumbe
-000149c0: 7227 5d29 0a20 2020 2020 2020 2073 656c  r']).        sel
-000149d0: 662e 5f63 6c69 656e 742e 636f 6d70 6c65  f._client.comple
-000149e0: 7465 5f6d 756c 7469 7061 7274 5f75 706c  te_multipart_upl
-000149f0: 6f61 6428 0a20 2020 2020 2020 2020 2020  oad(.           
-00014a00: 2055 706c 6f61 6449 643d 7365 6c66 2e5f   UploadId=self._
-00014a10: 7570 6c6f 6164 5f69 642c 0a20 2020 2020  upload_id,.     
-00014a20: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
-00014a30: 6c66 2e5f 6275 636b 6574 2c0a 2020 2020  lf._bucket,.    
-00014a40: 2020 2020 2020 2020 4b65 793d 7365 6c66          Key=self
-00014a50: 2e5f 6b65 792c 0a20 2020 2020 2020 2020  ._key,.         
-00014a60: 2020 204d 756c 7469 7061 7274 5570 6c6f     MultipartUplo
-00014a70: 6164 3d7b 2750 6172 7473 273a 2073 656c  ad={'Parts': sel
-00014a80: 662e 5f6d 756c 7469 7061 7274 5f75 706c  f._multipart_upl
-00014a90: 6f61 645f 696e 666f 7d29 0a0a 2020 2020  oad_info})..    
-00014aa0: 6465 6620 5f5f 656e 7465 725f 5f28 7365  def __enter__(se
-00014ab0: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
-00014ac0: 7572 6e20 7365 6c66 0a0a 2020 2020 6465  urn self..    de
-00014ad0: 6620 5f5f 6578 6974 5f5f 2873 656c 662c  f __exit__(self,
-00014ae0: 2065 7863 5f74 7970 652c 2065 7863 5f76   exc_type, exc_v
-00014af0: 616c 2c20 6578 635f 7462 293a 0a20 2020  al, exc_tb):.   
-00014b00: 2020 2020 2073 656c 662e 636c 6f73 6528       self.close(
-00014b10: 290a                                     ).
+00010620: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00010630: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
+00010640: 2020 2020 2020 2020 2066 6f72 2063 6f6d           for com
+00010650: 6d6f 6e5f 7072 6566 6978 2069 6e20 7265  mon_prefix in re
+00010660: 7370 2e67 6574 2827 436f 6d6d 6f6e 5072  sp.get('CommonPr
+00010670: 6566 6978 6573 272c 205b 5d29 3a0a 2020  efixes', []):.  
+00010680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010690: 2020 2020 2020 7969 656c 6420 4669 6c65        yield File
+000106a0: 456e 7472 7928 0a20 2020 2020 2020 2020  Entry(.         
+000106b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106c0: 2020 2063 6f6d 6d6f 6e5f 7072 6566 6978     common_prefix
+000106d0: 5b27 5072 6566 6978 275d 5b6c 656e 2870  ['Prefix'][len(p
+000106e0: 7265 6669 7829 3a2d 315d 2c0a 2020 2020  refix):-1],.    
+000106f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010700: 2020 2020 2020 2020 6765 6e65 7261 7465          generate
+00010710: 5f73 335f 7061 7468 280a 2020 2020 2020  _s3_path(.      
+00010720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010730: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00010740: 7072 6f74 6f63 6f6c 5f77 6974 685f 7072  protocol_with_pr
+00010750: 6f66 696c 652c 2062 7563 6b65 742c 0a20  ofile, bucket,. 
+00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010770: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00010780: 6f6d 6d6f 6e5f 7072 6566 6978 5b27 5072  ommon_prefix['Pr
+00010790: 6566 6978 275d 292c 0a20 2020 2020 2020  efix']),.       
+000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107b0: 2020 2020 2053 7461 7452 6573 756c 7428       StatResult(
+000107c0: 6973 6469 723d 5472 7565 2c20 6578 7472  isdir=True, extr
+000107d0: 613d 636f 6d6d 6f6e 5f70 7265 6669 7829  a=common_prefix)
+000107e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000107f0: 2020 2020 2020 666f 7220 636f 6e74 656e        for conten
+00010800: 7420 696e 2072 6573 702e 6765 7428 2743  t in resp.get('C
+00010810: 6f6e 7465 6e74 7327 2c20 5b5d 293a 0a20  ontents', []):. 
+00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010830: 2020 2020 2020 2073 7263 5f75 726c 203d         src_url =
+00010840: 2067 656e 6572 6174 655f 7333 5f70 6174   generate_s3_pat
+00010850: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
+00010860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010870: 656c 662e 5f70 726f 746f 636f 6c5f 7769  elf._protocol_wi
+00010880: 7468 5f70 726f 6669 6c65 2c20 6275 636b  th_profile, buck
+00010890: 6574 2c20 636f 6e74 656e 745b 274b 6579  et, content['Key
+000108a0: 275d 290a 0a20 2020 2020 2020 2020 2020  '])..           
+000108b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000108c0: 666f 6c6c 6f77 6c69 6e6b 7320 616e 6420  followlinks and 
+000108d0: 5333 5061 7468 2873 7263 5f75 726c 292e  S3Path(src_url).
+000108e0: 6973 5f73 796d 6c69 6e6b 2829 3a0a 2020  is_symlink():.  
+000108f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010900: 2020 2020 2020 2020 2020 636f 6e74 656e            conten
+00010910: 745b 2769 736c 6e6b 275d 203d 2054 7275  t['islnk'] = Tru
+00010920: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+00010930: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+00010940: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
+00010950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010960: 2020 2020 2020 2020 636f 6e74 656e 745b          content[
+00010970: 274b 6579 275d 5b6c 656e 2870 7265 6669  'Key'][len(prefi
+00010980: 7829 3a5d 2c20 7372 635f 7572 6c2c 0a20  x):], src_url,. 
+00010990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109a0: 2020 2020 2020 2020 2020 205f 6d61 6b65             _make
+000109b0: 5f73 7461 7428 636f 6e74 656e 7429 290a  _stat(content)).
+000109c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000109d0: 436f 6e74 6578 7449 7465 7261 746f 7228  ContextIterator(
+000109e0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+000109f0: 2829 290a 0a20 2020 2064 6566 205f 6765  ())..    def _ge
+00010a00: 7464 6972 7374 6174 2873 656c 6629 202d  tdirstat(self) -
+00010a10: 3e20 5374 6174 5265 7375 6c74 3a0a 2020  > StatResult:.  
+00010a20: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00010a30: 2020 5265 7475 726e 2053 7461 7452 6573    Return StatRes
+00010a40: 756c 7420 6f66 2067 6976 656e 2073 335f  ult of given s3_
+00010a50: 7572 6c20 6469 7265 6374 6f72 792c 2069  url directory, i
+00010a60: 6e63 6c75 6469 6e67 3a20 0a0a 2020 2020  ncluding: ..    
+00010a70: 2020 2020 312e 2044 6972 6563 746f 7279      1. Directory
+00010a80: 2073 697a 653a 2074 6865 2073 756d 206f   size: the sum o
+00010a90: 6620 616c 6c20 6669 6c65 2073 697a 6520  f all file size 
+00010aa0: 696e 2069 742c 2069 6e63 6c75 6469 6e67  in it, including
+00010ab0: 2066 696c 6520 696e 2073 7562 6469 7265   file in subdire
+00010ac0: 6374 6f72 6965 7320 2869 6620 6578 6973  ctories (if exis
+00010ad0: 7429 2e0a 2020 2020 2020 2020 5468 6520  t)..        The 
+00010ae0: 7265 7375 6c74 2065 7863 6c75 6465 7320  result excludes 
+00010af0: 7468 6520 7369 7a65 206f 6620 6469 7265  the size of dire
+00010b00: 6374 6f72 7920 6974 7365 6c66 2e20 496e  ctory itself. In
+00010b10: 206f 7468 6572 2077 6f72 6473 2c20 7265   other words, re
+00010b20: 7475 726e 2030 2042 7974 6520 6f6e 2061  turn 0 Byte on a
+00010b30: 6e20 656d 7074 7920 6469 7265 6374 6f72  n empty director
+00010b40: 7920 7061 7468 0a20 2020 2020 2020 2032  y path.        2
+00010b50: 2e20 4c61 7374 2d6d 6f64 6966 6965 6420  . Last-modified 
+00010b60: 7469 6d65 206f 6620 6469 7265 6374 6f72  time of director
+00010b70: 793a 2072 6574 7572 6e20 7468 6520 6c61  y: return the la
+00010b80: 7465 7374 206d 6f64 6966 6965 6420 7469  test modified ti
+00010b90: 6d65 206f 6620 616c 6c20 6669 6c65 2069  me of all file i
+00010ba0: 6e20 6974 2e20 5468 6520 6d74 696d 6520  n it. The mtime 
+00010bb0: 6f66 2065 6d70 7479 2064 6972 6563 746f  of empty directo
+00010bc0: 7279 2069 7320 3139 3730 2d30 312d 3031  ry is 1970-01-01
+00010bd0: 2030 303a 3030 3a30 300a 0a20 2020 2020   00:00:00..     
+00010be0: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
+00010bf0: 696e 7420 696e 6469 6361 7465 7320 7369  int indicates si
+00010c00: 7a65 2069 6e20 4279 7465 730a 2020 2020  ze in Bytes.    
+00010c10: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+00010c20: 6966 206e 6f74 2073 656c 662e 6973 5f64  if not self.is_d
+00010c30: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
+00010c40: 2020 7261 6973 6520 5333 4669 6c65 4e6f    raise S3FileNo
+00010c50: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+00010c60: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
+00010c70: 2073 7563 6820 6669 6c65 206f 7220 6469   such file or di
+00010c80: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
+00010c90: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00010ca0: 6f74 6f63 6f6c 290a 0a20 2020 2020 2020  otocol)..       
+00010cb0: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
+00010cc0: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
+00010cd0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00010ce0: 636f 6c29 0a20 2020 2020 2020 2070 7265  col).        pre
+00010cf0: 6669 7820 3d20 5f62 6563 6f6d 655f 7072  fix = _become_pr
+00010d00: 6566 6978 286b 6579 290a 2020 2020 2020  efix(key).      
+00010d10: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
+00010d20: 5f63 6c69 656e 740a 2020 2020 2020 2020  _client.        
+00010d30: 7369 7a65 203d 2030 0a20 2020 2020 2020  size = 0.       
+00010d40: 206d 7469 6d65 203d 2030 2e30 0a20 2020   mtime = 0.0.   
+00010d50: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
+00010d60: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
+00010d70: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+00010d80: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+00010d90: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
+00010da0: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
+00010db0: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
+00010dc0: 742c 2070 7265 6669 7829 3a0a 2020 2020  t, prefix):.    
+00010dd0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00010de0: 636f 6e74 656e 7420 696e 2072 6573 702e  content in resp.
+00010df0: 6765 7428 2743 6f6e 7465 6e74 7327 2c20  get('Contents', 
+00010e00: 5b5d 293a 0a20 2020 2020 2020 2020 2020  []):.           
+00010e10: 2020 2020 2020 2020 2073 697a 6520 2b3d           size +=
+00010e20: 2063 6f6e 7465 6e74 5b27 5369 7a65 275d   content['Size']
+00010e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e40: 2020 2020 206c 6173 745f 6d6f 6469 6669       last_modifi
+00010e50: 6564 203d 2063 6f6e 7465 6e74 5b27 4c61  ed = content['La
+00010e60: 7374 4d6f 6469 6669 6564 275d 2e74 696d  stModified'].tim
+00010e70: 6573 7461 6d70 2829 0a20 2020 2020 2020  estamp().       
+00010e80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00010e90: 6d74 696d 6520 3c20 6c61 7374 5f6d 6f64  mtime < last_mod
+00010ea0: 6966 6965 643a 0a20 2020 2020 2020 2020  ified:.         
+00010eb0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00010ec0: 7469 6d65 203d 206c 6173 745f 6d6f 6469  time = last_modi
+00010ed0: 6669 6564 0a0a 2020 2020 2020 2020 7265  fied..        re
+00010ee0: 7475 726e 2053 7461 7452 6573 756c 7428  turn StatResult(
+00010ef0: 7369 7a65 3d73 697a 652c 206d 7469 6d65  size=size, mtime
+00010f00: 3d6d 7469 6d65 2c20 6973 6469 723d 5472  =mtime, isdir=Tr
+00010f10: 7565 290a 0a20 2020 2064 6566 2073 7461  ue)..    def sta
+00010f20: 7428 7365 6c66 2c20 666f 6c6c 6f77 5f73  t(self, follow_s
+00010f30: 796d 6c69 6e6b 733d 5472 7565 2920 2d3e  ymlinks=True) ->
+00010f40: 2053 7461 7452 6573 756c 743a 0a20 2020   StatResult:.   
+00010f50: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+00010f60: 2047 6574 2053 7461 7452 6573 756c 7420   Get StatResult 
+00010f70: 6f66 2073 335f 7572 6c20 6669 6c65 2c20  of s3_url file, 
+00010f80: 696e 636c 7564 696e 6720 6669 6c65 2073  including file s
+00010f90: 697a 6520 616e 6420 6d74 696d 652c 2072  ize and mtime, r
+00010fa0: 6566 6572 7269 6e67 2074 6f20 7333 5f67  eferring to s3_g
+00010fb0: 6574 7369 7a65 2061 6e64 2073 335f 6765  etsize and s3_ge
+00010fc0: 746d 7469 6d65 0a0a 2020 2020 2020 2020  tmtime..        
+00010fd0: 4966 2073 335f 7572 6c20 6973 206e 6f74  If s3_url is not
+00010fe0: 2061 6e20 6578 6973 7465 6e74 2070 6174   an existent pat
+00010ff0: 682c 2077 6869 6368 206d 6561 6e73 2073  h, which means s
+00011000: 335f 6578 6973 7428 7333 5f75 726c 2920  3_exist(s3_url) 
+00011010: 7265 7475 726e 7320 4661 6c73 652c 2074  returns False, t
+00011020: 6865 6e20 7261 6973 6520 5333 4669 6c65  hen raise S3File
+00011030: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+00011040: 2020 2020 2020 4966 2061 7474 656d 7074        If attempt
+00011050: 2074 6f20 6765 7420 5374 6174 5265 7375   to get StatResu
+00011060: 6c74 206f 6620 636f 6d70 6c65 7465 2073  lt of complete s
+00011070: 332c 2073 7563 6820 6173 2073 335f 6469  3, such as s3_di
+00011080: 725f 7572 6c20 3d3d 2027 7333 3a2f 2f27  r_url == 's3://'
+00011090: 2c20 7261 6973 6520 5333 4275 636b 6574  , raise S3Bucket
+000110a0: 4e6f 7446 6f75 6e64 4572 726f 720a 0a20  NotFoundError.. 
+000110b0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+000110c0: 2053 7461 7452 6573 756c 740a 2020 2020   StatResult.    
+000110d0: 2020 2020 3a72 6169 7365 733a 2053 3346      :raises: S3F
+000110e0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+000110f0: 2c20 5333 4275 636b 6574 4e6f 7446 6f75  , S3BucketNotFou
+00011100: 6e64 4572 726f 720a 2020 2020 2020 2020  ndError.        
+00011110: 2727 270a 2020 2020 2020 2020 6973 6c6e  '''.        isln
+00011120: 6b20 3d20 4661 6c73 650a 2020 2020 2020  k = False.      
+00011130: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+00011140: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
+00011150: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00011160: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+00011170: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+00011180: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+00011190: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+000111a0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+000111b0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
+000111c0: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+000111d0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+000111e0: 726f 746f 636f 6c29 0a0a 2020 2020 2020  rotocol)..      
+000111f0: 2020 6966 206e 6f74 2073 656c 662e 6973    if not self.is
+00011200: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
+00011210: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00011220: 2e5f 6765 7464 6972 7374 6174 2829 0a0a  ._getdirstat()..
+00011230: 2020 2020 2020 2020 636c 6965 6e74 203d          client =
+00011240: 2073 656c 662e 5f63 6c69 656e 740a 2020   self._client.  
+00011250: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+00011260: 5f73 335f 6572 726f 7228 7365 6c66 2e70  _s3_error(self.p
+00011270: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00011280: 6c29 3a0a 2020 2020 2020 2020 2020 2020  l):.            
+00011290: 636f 6e74 656e 7420 3d20 636c 6965 6e74  content = client
+000112a0: 2e68 6561 645f 6f62 6a65 6374 2842 7563  .head_object(Buc
+000112b0: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
+000112c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+000112d0: 2069 6620 274d 6574 6164 6174 6127 2069   if 'Metadata' i
+000112e0: 6e20 636f 6e74 656e 743a 0a20 2020 2020  n content:.     
+000112f0: 2020 2020 2020 2020 2020 206d 6574 6164             metad
+00011300: 6174 6120 3d20 6469 6374 280a 2020 2020  ata = dict(.    
+00011310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011320: 286b 6579 2e6c 6f77 6572 2829 2c20 7661  (key.lower(), va
+00011330: 6c75 6529 0a20 2020 2020 2020 2020 2020  lue).           
+00011340: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00011350: 2c20 7661 6c75 6520 696e 2063 6f6e 7465  , value in conte
+00011360: 6e74 5b27 4d65 7461 6461 7461 275d 2e69  nt['Metadata'].i
+00011370: 7465 6d73 2829 290a 2020 2020 2020 2020  tems()).        
+00011380: 2020 2020 2020 2020 6966 206d 6574 6164          if metad
+00011390: 6174 6120 616e 6420 2773 796d 6c69 6e6b  ata and 'symlink
+000113a0: 5f74 6f27 2069 6e20 6d65 7461 6461 7461  _to' in metadata
+000113b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000113c0: 2020 2020 2020 6973 6c6e 6b20 3d20 5472        islnk = Tr
+000113d0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+000113e0: 2020 2020 2020 2069 6620 6973 6c6e 6b20         if islnk 
+000113f0: 616e 6420 666f 6c6c 6f77 5f73 796d 6c69  and follow_symli
+00011400: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
+00011410: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
+00011420: 7572 6c20 3d20 6d65 7461 6461 7461 5b27  url = metadata['
+00011430: 7379 6d6c 696e 6b5f 746f 275d 0a20 2020  symlink_to'].   
+00011440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011450: 2020 2020 2062 7563 6b65 742c 206b 6579       bucket, key
+00011460: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+00011470: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
+00011480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011490: 636f 6e74 656e 7420 3d20 636c 6965 6e74  content = client
+000114a0: 2e68 6561 645f 6f62 6a65 6374 2842 7563  .head_object(Buc
+000114b0: 6b65 743d 6275 636b 6574 2c20 4b65 793d  ket=bucket, Key=
+000114c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+000114d0: 2073 7461 745f 7265 636f 7264 203d 2053   stat_record = S
+000114e0: 7461 7452 6573 756c 7428 0a20 2020 2020  tatResult(.     
+000114f0: 2020 2020 2020 2020 2020 2069 736c 6e6b             islnk
+00011500: 3d69 736c 6e6b 2c0a 2020 2020 2020 2020  =islnk,.        
+00011510: 2020 2020 2020 2020 7369 7a65 3d63 6f6e          size=con
+00011520: 7465 6e74 5b27 436f 6e74 656e 744c 656e  tent['ContentLen
+00011530: 6774 6827 5d2c 0a20 2020 2020 2020 2020  gth'],.         
+00011540: 2020 2020 2020 206d 7469 6d65 3d63 6f6e         mtime=con
+00011550: 7465 6e74 5b27 4c61 7374 4d6f 6469 6669  tent['LastModifi
+00011560: 6564 275d 2e74 696d 6573 7461 6d70 2829  ed'].timestamp()
+00011570: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011580: 2020 6578 7472 613d 636f 6e74 656e 7429    extra=content)
+00011590: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000115a0: 7374 6174 5f72 6563 6f72 640a 0a20 2020  stat_record..   
+000115b0: 2064 6566 206c 7374 6174 2873 656c 6629   def lstat(self)
+000115c0: 202d 3e20 5374 6174 5265 7375 6c74 3a0a   -> StatResult:.
+000115d0: 2020 2020 2020 2020 2727 274c 696b 6520          '''Like 
+000115e0: 5061 7468 2e73 7461 7428 2920 6275 742c  Path.stat() but,
+000115f0: 2069 6620 7468 6520 7061 7468 2070 6f69   if the path poi
+00011600: 6e74 7320 746f 2061 2073 796d 626f 6c69  nts to a symboli
+00011610: 6320 6c69 6e6b 2c20 7265 7475 726e 2074  c link, return t
+00011620: 6865 2073 796d 626f 6c69 6320 6c69 6e6b  he symbolic link
+00011630: e280 9973 2069 6e66 6f72 6d61 7469 6f6e  ...s information
+00011640: 2072 6174 6865 7220 7468 616e 2069 7473   rather than its
+00011650: 2074 6172 6765 74e2 8099 732e 2727 270a   target...s.'''.
+00011660: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00011670: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
+00011680: 7379 6d6c 696e 6b73 3d46 616c 7365 290a  symlinks=False).
+00011690: 0a20 2020 2064 6566 2075 6e6c 696e 6b28  .    def unlink(
+000116a0: 7365 6c66 2c20 6d69 7373 696e 675f 6f6b  self, missing_ok
+000116b0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
+000116c0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+000116d0: 2027 2727 0a20 2020 2020 2020 2052 656d   '''.        Rem
+000116e0: 6f76 6520 7468 6520 6669 6c65 206f 6e20  ove the file on 
+000116f0: 7333 0a0a 2020 2020 2020 2020 3a70 6172  s3..        :par
+00011700: 616d 206d 6973 7369 6e67 5f6f 6b3a 2069  am missing_ok: i
+00011710: 6620 4661 6c73 6520 616e 6420 7461 7267  f False and targ
+00011720: 6574 2066 696c 6520 6e6f 7420 6578 6973  et file not exis
+00011730: 7473 2c20 7261 6973 6520 5333 4669 6c65  ts, raise S3File
+00011740: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+00011750: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
+00011760: 3350 6572 6d69 7373 696f 6e45 7272 6f72  3PermissionError
+00011770: 2c20 5333 4669 6c65 4e6f 7446 6f75 6e64  , S3FileNotFound
+00011780: 4572 726f 722c 2053 3349 7341 4469 7265  Error, S3IsADire
+00011790: 6374 6f72 7945 7272 6f72 0a20 2020 2020  ctoryError.     
+000117a0: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
+000117b0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+000117c0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+000117d0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+000117e0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+000117f0: 7420 6275 636b 6574 206f 7220 6e6f 7420  t bucket or not 
+00011800: 6b65 7920 6f72 206b 6579 2e65 6e64 7377  key or key.endsw
+00011810: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+00011820: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
+00011830: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
+00011840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011850: 2027 4973 2061 2064 6972 6563 746f 7279   'Is a directory
+00011860: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+00011870: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00011880: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00011890: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
+000118a0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+000118b0: 6973 7369 6e67 5f6f 6b3a 0a20 2020 2020  issing_ok:.     
+000118c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000118d0: 6e0a 2020 2020 2020 2020 2020 2020 7261  n.            ra
+000118e0: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
+000118f0: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
+00011900: 2020 2020 2020 2020 2027 4e6f 2073 7563           'No suc
+00011910: 6820 6669 6c65 3a20 2572 2720 2520 7365  h file: %r' % se
+00011920: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+00011930: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
+00011940: 7769 7468 2072 6169 7365 5f73 335f 6572  with raise_s3_er
+00011950: 726f 7228 7365 6c66 2e70 6174 685f 7769  ror(self.path_wi
+00011960: 7468 5f70 726f 746f 636f 6c29 3a0a 2020  th_protocol):.  
+00011970: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00011980: 636c 6965 6e74 2e64 656c 6574 655f 6f62  client.delete_ob
+00011990: 6a65 6374 2842 7563 6b65 743d 6275 636b  ject(Bucket=buck
+000119a0: 6574 2c20 4b65 793d 6b65 7929 0a0a 2020  et, Key=key)..  
+000119b0: 2020 6465 6620 7761 6c6b 2873 656c 662c    def walk(self,
+000119c0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
+000119d0: 6f6c 203d 2046 616c 7365 0a20 2020 2020  ol = False.     
+000119e0: 2020 2020 2020 2029 202d 3e20 4974 6572         ) -> Iter
+000119f0: 6174 6f72 5b54 7570 6c65 5b73 7472 2c20  ator[Tuple[str, 
+00011a00: 4c69 7374 5b73 7472 5d2c 204c 6973 745b  List[str], List[
+00011a10: 7374 725d 5d5d 3a0a 2020 2020 2020 2020  str]]]:.        
+00011a20: 2727 270a 2020 2020 2020 2020 4974 6572  '''.        Iter
+00011a30: 6174 6976 656c 7920 7472 6176 6572 7365  atively traverse
+00011a40: 2074 6865 2067 6976 656e 2073 3320 6469   the given s3 di
+00011a50: 7265 6374 6f72 792c 2069 6e20 746f 702d  rectory, in top-
+00011a60: 626f 7474 6f6d 206f 7264 6572 2e20 496e  bottom order. In
+00011a70: 206f 7468 6572 2077 6f72 6473 2c20 6669   other words, fi
+00011a80: 7273 746c 7920 7472 6176 6572 7365 2070  rstly traverse p
+00011a90: 6172 656e 7420 6469 7265 6374 6f72 792c  arent directory,
+00011aa0: 2069 6620 7375 6264 6972 6563 746f 7269   if subdirectori
+00011ab0: 6573 2065 7869 7374 2c20 7472 6176 6572  es exist, traver
+00011ac0: 7365 2074 6865 2073 7562 6469 7265 6374  se the subdirect
+00011ad0: 6f72 6965 7320 696e 2061 6c70 6861 6265  ories in alphabe
+00011ae0: 7469 6361 6c20 6f72 6465 722e 0a20 2020  tical order..   
+00011af0: 2020 2020 2045 7665 7279 2069 7465 7261       Every itera
+00011b00: 7469 6f6e 206f 6e20 6765 6e65 7261 746f  tion on generato
+00011b10: 7220 7969 656c 6473 2061 2033 2d74 7570  r yields a 3-tup
+00011b20: 6c65 3a20 2872 6f6f 742c 2064 6972 732c  le: (root, dirs,
+00011b30: 2066 696c 6573 290a 0a20 2020 2020 2020   files)..       
+00011b40: 202d 2072 6f6f 743a 2043 7572 7265 6e74   - root: Current
+00011b50: 2073 3320 7061 7468 3b0a 2020 2020 2020   s3 path;.      
+00011b60: 2020 2d20 6469 7273 3a20 4e61 6d65 206c    - dirs: Name l
+00011b70: 6973 7420 6f66 2073 7562 6469 7265 6374  ist of subdirect
+00011b80: 6f72 6965 7320 696e 2063 7572 7265 6e74  ories in current
+00011b90: 2064 6972 6563 746f 7279 2e20 5468 6520   directory. The 
+00011ba0: 6c69 7374 2069 7320 736f 7274 6564 2062  list is sorted b
+00011bb0: 7920 6e61 6d65 2069 6e20 6173 6365 6e64  y name in ascend
+00011bc0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
+00011bd0: 206f 7264 6572 3b0a 2020 2020 2020 2020   order;.        
+00011be0: 2d20 6669 6c65 733a 204e 616d 6520 6c69  - files: Name li
+00011bf0: 7374 206f 6620 6669 6c65 7320 696e 2063  st of files in c
+00011c00: 7572 7265 6e74 2064 6972 6563 746f 7279  urrent directory
+00011c10: 2e20 5468 6520 6c69 7374 2069 7320 736f  . The list is so
+00011c20: 7274 6564 2062 7920 6e61 6d65 2069 6e20  rted by name in 
+00011c30: 6173 6365 6e64 696e 6720 616c 7068 6162  ascending alphab
+00011c40: 6574 6963 616c 206f 7264 6572 3b0a 0a20  etical order;.. 
+00011c50: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
+00011c60: 2069 7320 6120 6669 6c65 2070 6174 682c   is a file path,
+00011c70: 2072 6574 7572 6e20 616e 2065 6d70 7479   return an empty
+00011c80: 2067 656e 6572 6174 6f72 0a20 2020 2020   generator.     
+00011c90: 2020 2049 6620 7333 5f75 726c 2069 7320     If s3_url is 
+00011ca0: 6120 6e6f 6e2d 6578 6973 7465 6e74 2070  a non-existent p
+00011cb0: 6174 682c 2072 6574 7572 6e20 616e 2065  ath, return an e
+00011cc0: 6d70 7479 2067 656e 6572 6174 6f72 0a20  mpty generator. 
+00011cd0: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
+00011ce0: 2069 7320 6120 6275 636b 6574 2070 6174   is a bucket pat
+00011cf0: 682c 2062 7563 6b65 7420 7769 6c6c 2062  h, bucket will b
+00011d00: 6520 7468 6520 746f 7020 6469 7265 6374  e the top direct
+00011d10: 6f72 792c 2061 6e64 2077 696c 6c20 6265  ory, and will be
+00011d20: 2072 6574 7572 6e65 6420 6174 2066 6972   returned at fir
+00011d30: 7374 2069 7465 7261 7469 6f6e 206f 6620  st iteration of 
+00011d40: 6765 6e65 7261 746f 720a 2020 2020 2020  generator.      
+00011d50: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
+00011d60: 6e20 656d 7074 7920 6275 636b 6574 2c20  n empty bucket, 
+00011d70: 6f6e 6c79 2079 6965 6c64 206f 6e65 2033  only yield one 3
+00011d80: 2d74 7570 6c65 2028 6e6f 7465 733a 2073  -tuple (notes: s
+00011d90: 3320 646f 6573 6e27 7420 6861 7665 2065  3 doesn't have e
+00011da0: 6d70 7479 2064 6972 6563 746f 7279 290a  mpty directory).
+00011db0: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
+00011dc0: 6c20 646f 6573 6e27 7420 636f 6e74 6169  l doesn't contai
+00011dd0: 6e20 616e 7920 6275 636b 6574 2c20 7768  n any bucket, wh
+00011de0: 6963 6820 6973 2073 335f 7572 6c20 3d3d  ich is s3_url ==
+00011df0: 2027 7333 3a2f 2f27 2c20 7261 6973 6520   's3://', raise 
+00011e00: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+00011e10: 2e20 7761 6c6b 2829 206f 6e20 636f 6d70  . walk() on comp
+00011e20: 6c65 7465 2073 3320 6973 206e 6f74 2073  lete s3 is not s
+00011e30: 7570 706f 7274 6564 2069 6e20 6d65 6766  upported in megf
+00011e40: 696c 650a 0a20 2020 2020 2020 203a 7061  ile..        :pa
+00011e50: 7261 6d20 666f 6c6c 6f77 6c69 6e6b 733a  ram followlinks:
+00011e60: 2077 6865 7468 6572 2066 6f6c 6c6f 776c   whether followl
+00011e70: 696e 6b73 2069 7320 5472 7565 206f 7220  inks is True or 
+00011e80: 4661 6c73 652c 2072 6573 756c 7420 6973  False, result is
+00011e90: 2074 6865 2073 616d 652e 2042 6563 6175   the same. Becau
+00011ea0: 7365 2073 3320 7379 6d6c 696e 6b20 6e6f  se s3 symlink no
+00011eb0: 7420 7375 7070 6f72 7420 6469 722e 0a20  t support dir.. 
+00011ec0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+00011ed0: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+00011ee0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00011ef0: 733a 2041 2033 2d74 7570 6c65 2067 656e  s: A 3-tuple gen
+00011f00: 6572 6174 6f72 0a20 2020 2020 2020 2027  erator.        '
+00011f10: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+00011f20: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00011f30: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+00011f40: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00011f50: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+00011f60: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+00011f70: 2020 7261 6973 6520 556e 7375 7070 6f72    raise Unsuppor
+00011f80: 7465 6445 7272 6f72 2827 5761 6c6b 2077  tedError('Walk w
+00011f90: 686f 6c65 2073 3327 2c20 7365 6c66 2e70  hole s3', self.p
+00011fa0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00011fb0: 6c29 0a0a 2020 2020 2020 2020 6966 206e  l)..        if n
+00011fc0: 6f74 2073 656c 662e 6973 5f64 6972 2829  ot self.is_dir()
+00011fd0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00011fe0: 7475 726e 0a0a 2020 2020 2020 2020 7374  turn..        st
+00011ff0: 6163 6b20 3d20 5b6b 6579 5d0a 2020 2020  ack = [key].    
+00012000: 2020 2020 636c 6965 6e74 203d 2073 656c      client = sel
+00012010: 662e 5f63 6c69 656e 740a 2020 2020 2020  f._client.      
+00012020: 2020 7768 696c 6520 6c65 6e28 7374 6163    while len(stac
+00012030: 6b29 203e 2030 3a0a 2020 2020 2020 2020  k) > 0:.        
+00012040: 2020 2020 6375 7272 656e 7420 3d20 5f62      current = _b
+00012050: 6563 6f6d 655f 7072 6566 6978 2873 7461  ecome_prefix(sta
+00012060: 636b 2e70 6f70 2829 290a 2020 2020 2020  ck.pop()).      
+00012070: 2020 2020 2020 6469 7273 2c20 6669 6c65        dirs, file
+00012080: 7320 3d20 5b5d 2c20 5b5d 0a20 2020 2020  s = [], [].     
+00012090: 2020 2020 2020 2066 6f72 2072 6573 7020         for resp 
+000120a0: 696e 205f 6c69 7374 5f6f 626a 6563 7473  in _list_objects
+000120b0: 5f72 6563 7572 7369 7665 2863 6c69 656e  _recursive(clien
+000120c0: 742c 2062 7563 6b65 742c 2063 7572 7265  t, bucket, curre
+000120d0: 6e74 2c20 272f 2729 3a0a 2020 2020 2020  nt, '/'):.      
+000120e0: 2020 2020 2020 2020 2020 666f 7220 636f            for co
+000120f0: 6d6d 6f6e 5f70 7265 6669 7820 696e 2072  mmon_prefix in r
+00012100: 6573 702e 6765 7428 2743 6f6d 6d6f 6e50  esp.get('CommonP
+00012110: 7265 6669 7865 7327 2c20 5b5d 293a 0a20  refixes', []):. 
+00012120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012130: 2020 2064 6972 732e 6170 7065 6e64 2863     dirs.append(c
+00012140: 6f6d 6d6f 6e5f 7072 6566 6978 5b27 5072  ommon_prefix['Pr
+00012150: 6566 6978 275d 5b3a 2d31 5d29 0a20 2020  efix'][:-1]).   
+00012160: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00012170: 2063 6f6e 7465 6e74 2069 6e20 7265 7370   content in resp
+00012180: 2e67 6574 2827 436f 6e74 656e 7473 272c  .get('Contents',
+00012190: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
+000121a0: 2020 2020 2020 2020 2020 6669 6c65 732e            files.
+000121b0: 6170 7065 6e64 2863 6f6e 7465 6e74 5b27  append(content['
+000121c0: 4b65 7927 5d29 0a0a 2020 2020 2020 2020  Key'])..        
+000121d0: 2020 2020 6469 7273 203d 2073 6f72 7465      dirs = sorte
+000121e0: 6428 6469 7273 290a 2020 2020 2020 2020  d(dirs).        
+000121f0: 2020 2020 7374 6163 6b2e 6578 7465 6e64      stack.extend
+00012200: 2872 6576 6572 7365 6428 6469 7273 2929  (reversed(dirs))
+00012210: 0a0a 2020 2020 2020 2020 2020 2020 726f  ..            ro
+00012220: 6f74 203d 2073 335f 7061 7468 5f6a 6f69  ot = s3_path_joi
+00012230: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00012240: 2020 2066 277b 7365 6c66 2e5f 7072 6f74     f'{self._prot
+00012250: 6f63 6f6c 5f77 6974 685f 7072 6f66 696c  ocol_with_profil
+00012260: 657d 3a2f 2f27 2c20 6275 636b 6574 2c20  e}://', bucket, 
+00012270: 6375 7272 656e 7429 5b3a 2d31 5d0a 2020  current)[:-1].  
+00012280: 2020 2020 2020 2020 2020 6469 7273 203d            dirs =
+00012290: 205b 7061 7468 5b6c 656e 2863 7572 7265   [path[len(curre
+000122a0: 6e74 293a 5d20 666f 7220 7061 7468 2069  nt):] for path i
+000122b0: 6e20 6469 7273 5d0a 2020 2020 2020 2020  n dirs].        
+000122c0: 2020 2020 6669 6c65 7320 3d20 736f 7274      files = sort
+000122d0: 6564 2870 6174 685b 6c65 6e28 6375 7272  ed(path[len(curr
+000122e0: 656e 7429 3a5d 2066 6f72 2070 6174 6820  ent):] for path 
+000122f0: 696e 2066 696c 6573 290a 2020 2020 2020  in files).      
+00012300: 2020 2020 2020 7969 656c 6420 726f 6f74        yield root
+00012310: 2c20 6469 7273 2c20 6669 6c65 730a 0a20  , dirs, files.. 
+00012320: 2020 2064 6566 206d 6435 2873 656c 662c     def md5(self,
+00012330: 2072 6563 616c 6375 6c61 7465 3a20 626f   recalculate: bo
+00012340: 6f6c 203d 2046 616c 7365 2c20 666f 6c6c  ol = False, foll
+00012350: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+00012360: 4661 6c73 6529 202d 3e20 7374 723a 0a20  False) -> str:. 
+00012370: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00012380: 2020 2047 6574 206d 6435 206d 6574 6120     Get md5 meta 
+00012390: 696e 666f 2069 6e20 6669 6c65 7320 7468  info in files th
+000123a0: 6174 2075 706c 6f61 6465 642f 636f 7069  at uploaded/copi
+000123b0: 6564 2076 6961 206d 6567 6669 6c65 0a0a  ed via megfile..
+000123c0: 2020 2020 2020 2020 4966 206d 6574 6120          If meta 
+000123d0: 696e 666f 2069 7320 6c6f 7374 206f 7220  info is lost or 
+000123e0: 6e6f 6e2d 6578 6973 7465 6e74 2c20 7265  non-existent, re
+000123f0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+00012400: 2020 203a 7061 7261 6d20 7265 6361 6c63     :param recalc
+00012410: 756c 6174 653a 2063 616c 6375 6c61 7465  ulate: calculate
+00012420: 206d 6435 2069 6e20 7265 616c 2d74 696d   md5 in real-tim
+00012430: 6520 6f72 2072 6574 7572 6e20 7333 2065  e or return s3 e
+00012440: 7461 670a 2020 2020 2020 2020 3a70 6172  tag.        :par
+00012450: 616d 2066 6f6c 6c6f 776c 696e 6b73 3a20  am followlinks: 
+00012460: 4966 2069 7320 5472 7565 2c20 6361 6c63  If is True, calc
+00012470: 756c 6174 6520 6d64 3520 666f 7220 7265  ulate md5 for re
+00012480: 616c 2066 696c 650a 2020 2020 2020 2020  al file.        
+00012490: 3a72 6574 7572 6e73 3a20 6d64 3520 6d65  :returns: md5 me
+000124a0: 7461 2069 6e66 6f0a 2020 2020 2020 2020  ta info.        
+000124b0: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
+000124c0: 6574 2c20 5f20 3d20 7061 7273 655f 7333  et, _ = parse_s3
+000124d0: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+000124e0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+000124f0: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+00012500: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
+00012510: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
+00012520: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
+00012530: 2020 2020 2020 2020 2020 2020 2020 2745                'E
+00012540: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+00012550: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
+00012560: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+00012570: 0a20 2020 2020 2020 2073 7461 7420 3d20  .        stat = 
+00012580: 7365 6c66 2e73 7461 7428 666f 6c6c 6f77  self.stat(follow
+00012590: 5f73 796d 6c69 6e6b 733d 666f 6c6c 6f77  _symlinks=follow
+000125a0: 6c69 6e6b 7329 0a20 2020 2020 2020 2069  links).        i
+000125b0: 6620 7374 6174 2e69 7364 6972 3a0a 2020  f stat.isdir:.  
+000125c0: 2020 2020 2020 2020 2020 6861 7368 5f6d            hash_m
+000125d0: 6435 203d 2068 6173 686c 6962 2e6d 6435  d5 = hashlib.md5
+000125e0: 2829 2020 2320 6e6f 7365 630a 2020 2020  ()  # nosec.    
+000125f0: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
+00012600: 5f6e 616d 6520 696e 2073 656c 662e 6c69  _name in self.li
+00012610: 7374 6469 7228 293a 0a20 2020 2020 2020  stdir():.       
+00012620: 2020 2020 2020 2020 2063 6875 6e6b 203d           chunk =
+00012630: 2053 3350 6174 6828 0a20 2020 2020 2020   S3Path(.       
+00012640: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
+00012650: 7061 7468 5f6a 6f69 6e28 0a20 2020 2020  path_join(.     
+00012660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012670: 2020 2073 656c 662e 7061 7468 5f77 6974     self.path_wit
+00012680: 685f 7072 6f74 6f63 6f6c 2c0a 2020 2020  h_protocol,.    
+00012690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126a0: 2020 2020 6669 6c65 5f6e 616d 6529 292e      file_name)).
+000126b0: 6d64 3528 7265 6361 6c63 756c 6174 653d  md5(recalculate=
+000126c0: 7265 6361 6c63 756c 6174 6529 2e65 6e63  recalculate).enc
+000126d0: 6f64 6528 290a 2020 2020 2020 2020 2020  ode().          
+000126e0: 2020 2020 2020 6861 7368 5f6d 6435 2e75        hash_md5.u
+000126f0: 7064 6174 6528 6368 756e 6b29 0a20 2020  pdate(chunk).   
+00012700: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00012710: 6861 7368 5f6d 6435 2e68 6578 6469 6765  hash_md5.hexdige
+00012720: 7374 2829 0a20 2020 2020 2020 2069 6620  st().        if 
+00012730: 7265 6361 6c63 756c 6174 653a 0a20 2020  recalculate:.   
+00012740: 2020 2020 2020 2020 2070 6174 685f 696e           path_in
+00012750: 7374 616e 6365 203d 2073 656c 660a 2020  stance = self.  
+00012760: 2020 2020 2020 2020 2020 6966 2066 6f6c            if fol
+00012770: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
+00012780: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00012790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127a0: 2020 2070 6174 685f 696e 7374 616e 6365     path_instance
+000127b0: 203d 2073 656c 662e 7265 6164 6c69 6e6b   = self.readlink
+000127c0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000127d0: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
+000127e0: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
+000127f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00012800: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00012810: 7769 7468 2070 6174 685f 696e 7374 616e  with path_instan
+00012820: 6365 2e6f 7065 6e28 2772 6227 2920 6173  ce.open('rb') as
+00012830: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+00012840: 2020 2020 7265 7475 726e 2063 616c 6375      return calcu
+00012850: 6c61 7465 5f6d 6435 2866 290a 2020 2020  late_md5(f).    
+00012860: 2020 2020 7265 7475 726e 2073 7461 742e      return stat.
+00012870: 6578 7472 612e 6765 7428 2745 5461 6727  extra.get('ETag'
+00012880: 2c20 2727 295b 313a 2d31 5d0a 0a20 2020  , '')[1:-1]..   
+00012890: 2064 6566 2063 6f70 7928 0a20 2020 2020   def copy(.     
+000128a0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000128b0: 2020 2020 2020 2020 2064 7374 5f75 726c           dst_url
+000128c0: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
+000128d0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
+000128e0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+000128f0: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
+00012900: 616c 6c62 6163 6b3a 204f 7074 696f 6e61  allback: Optiona
+00012910: 6c5b 4361 6c6c 6162 6c65 5b5b 696e 745d  l[Callable[[int]
+00012920: 2c20 4e6f 6e65 5d5d 203d 204e 6f6e 6529  , None]] = None)
+00012930: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00012940: 2020 2727 2720 4669 6c65 2063 6f70 7920    ''' File copy 
+00012950: 6f6e 2053 330a 2020 2020 2020 2020 436f  on S3.        Co
+00012960: 7079 2063 6f6e 7465 6e74 206f 6620 6669  py content of fi
+00012970: 6c65 206f 6e20 6073 7263 5f70 6174 6860  le on `src_path`
+00012980: 2074 6f20 6064 7374 5f70 6174 6860 2e0a   to `dst_path`..
+00012990: 2020 2020 2020 2020 4974 2773 2063 616c          It's cal
+000129a0: 6c65 7227 7320 7265 7370 6f6e 7365 6269  ler's responsebi
+000129b0: 6c69 7479 2074 6f20 656e 7375 7265 2074  lity to ensure t
+000129c0: 6865 2073 335f 6973 6669 6c65 2873 7263  he s3_isfile(src
+000129d0: 5f75 726c 2920 3d3d 2054 7275 650a 0a20  _url) == True.. 
+000129e0: 2020 2020 2020 203a 7061 7261 6d20 6473         :param ds
+000129f0: 745f 7061 7468 3a20 5461 7267 6574 2066  t_path: Target f
+00012a00: 696c 6520 7061 7468 0a20 2020 2020 2020  ile path.       
+00012a10: 203a 7061 7261 6d20 6361 6c6c 6261 636b   :param callback
+00012a20: 3a20 4361 6c6c 6564 2070 6572 696f 6469  : Called periodi
+00012a30: 6361 6c6c 7920 6475 7269 6e67 2063 6f70  cally during cop
+00012a40: 792c 2061 6e64 2074 6865 2069 6e70 7574  y, and the input
+00012a50: 2070 6172 616d 6574 6572 2069 7320 7468   parameter is th
+00012a60: 6520 6461 7461 2073 697a 6520 2869 6e20  e data size (in 
+00012a70: 6279 7465 7329 206f 6620 636f 7079 2073  bytes) of copy s
+00012a80: 696e 6365 2074 6865 206c 6173 7420 6361  ince the last ca
+00012a90: 6c6c 0a20 2020 2020 2020 2027 2727 0a20  ll.        '''. 
+00012aa0: 2020 2020 2020 2073 7263 5f75 726c 203d         src_url =
+00012ab0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+00012ac0: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
+00012ad0: 2073 7263 5f62 7563 6b65 742c 2073 7263   src_bucket, src
+00012ae0: 5f6b 6579 203d 2070 6172 7365 5f73 335f  _key = parse_s3_
+00012af0: 7572 6c28 7372 635f 7572 6c29 0a20 2020  url(src_url).   
+00012b00: 2020 2020 2064 7374 5f62 7563 6b65 742c       dst_bucket,
+00012b10: 2064 7374 5f6b 6579 203d 2070 6172 7365   dst_key = parse
+00012b20: 5f73 335f 7572 6c28 6473 745f 7572 6c29  _s3_url(dst_url)
+00012b30: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00012b40: 2073 7263 5f62 7563 6b65 743a 0a20 2020   src_bucket:.   
+00012b50: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+00012b60: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+00012b70: 7272 6f72 2827 456d 7074 7920 6275 636b  rror('Empty buck
+00012b80: 6574 206e 616d 653a 2025 7227 2025 2073  et name: %r' % s
+00012b90: 7263 5f75 726c 290a 2020 2020 2020 2020  rc_url).        
+00012ba0: 6966 2073 656c 662e 6973 5f64 6972 2829  if self.is_dir()
+00012bb0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00012bc0: 6973 6520 5333 4973 4144 6972 6563 746f  ise S3IsADirecto
+00012bd0: 7279 4572 726f 7228 2749 7320 6120 6469  ryError('Is a di
+00012be0: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
+00012bf0: 7263 5f75 726c 290a 0a20 2020 2020 2020  rc_url)..       
+00012c00: 2069 6620 6e6f 7420 6473 745f 6275 636b   if not dst_buck
+00012c10: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00012c20: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+00012c30: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
+00012c40: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+00012c50: 2572 2720 2520 6473 745f 7572 6c29 0a20  %r' % dst_url). 
+00012c60: 2020 2020 2020 2069 6620 6e6f 7420 6473         if not ds
+00012c70: 745f 6b65 7920 6f72 2064 7374 5f6b 6579  t_key or dst_key
+00012c80: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
+00012c90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012ca0: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
+00012cb0: 4572 726f 7228 2749 7320 6120 6469 7265  Error('Is a dire
+00012cc0: 6374 6f72 793a 2025 7227 2025 2064 7374  ctory: %r' % dst
+00012cd0: 5f75 726c 290a 0a20 2020 2020 2020 2069  _url)..        i
+00012ce0: 6620 666f 6c6c 6f77 6c69 6e6b 733a 0a20  f followlinks:. 
+00012cf0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d10: 7333 5f75 726c 203d 2073 656c 662e 7265  s3_url = self.re
+00012d20: 6164 6c69 6e6b 2829 2e70 6174 680a 2020  adlink().path.  
+00012d30: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00012d40: 635f 6275 636b 6574 2c20 7372 635f 6b65  c_bucket, src_ke
+00012d50: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00012d60: 2873 335f 7572 6c29 0a20 2020 2020 2020  (s3_url).       
+00012d70: 2020 2020 2065 7863 6570 7420 5333 4e6f       except S3No
+00012d80: 7441 4c69 6e6b 4572 726f 723a 0a20 2020  tALinkError:.   
+00012d90: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+00012da0: 730a 0a20 2020 2020 2020 2074 7279 3a0a  s..        try:.
+00012db0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012dc0: 2e5f 636c 6965 6e74 2e63 6f70 7928 0a20  ._client.copy(. 
+00012dd0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00012de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012df0: 2020 2020 2027 4275 636b 6574 273a 2073       'Bucket': s
+00012e00: 7263 5f62 7563 6b65 742c 0a20 2020 2020  rc_bucket,.     
+00012e10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00012e20: 4b65 7927 3a20 7372 635f 6b65 792c 0a20  Key': src_key,. 
+00012e30: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00012e40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012e50: 2020 4275 636b 6574 3d64 7374 5f62 7563    Bucket=dst_buc
+00012e60: 6b65 742c 0a20 2020 2020 2020 2020 2020  ket,.           
+00012e70: 2020 2020 204b 6579 3d64 7374 5f6b 6579       Key=dst_key
+00012e80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012e90: 2020 4361 6c6c 6261 636b 3d63 616c 6c62    Callback=callb
+00012ea0: 6163 6b29 0a20 2020 2020 2020 2065 7863  ack).        exc
+00012eb0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+00012ec0: 2065 7272 6f72 3a0a 2020 2020 2020 2020   error:.        
+00012ed0: 2020 2020 6572 726f 7220 3d20 7472 616e      error = tran
+00012ee0: 736c 6174 655f 7333 5f65 7272 6f72 2865  slate_s3_error(e
+00012ef0: 7272 6f72 2c20 6473 745f 7572 6c29 0a20  rror, dst_url). 
+00012f00: 2020 2020 2020 2020 2020 2023 2045 7272             # Err
+00012f10: 6f72 2063 616e 2774 2068 656c 7020 7465  or can't help te
+00012f20: 6c6c 2077 6869 6368 2069 7320 7072 6f62  ll which is prob
+00012f30: 6c65 6d61 7469 630a 2020 2020 2020 2020  lematic.        
+00012f40: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00012f50: 6528 6572 726f 722c 2053 3342 7563 6b65  e(error, S3Bucke
+00012f60: 744e 6f74 466f 756e 6445 7272 6f72 293a  tNotFoundError):
+00012f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012f80: 2069 6620 6e6f 7420 7365 6c66 2e68 6173   if not self.has
+00012f90: 6275 636b 6574 2829 3a0a 2020 2020 2020  bucket():.      
+00012fa0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00012fb0: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
+00012fc0: 6f75 6e64 4572 726f 7228 274e 6f20 7375  oundError('No su
+00012fd0: 6368 2062 7563 6b65 743a 2025 7227 2025  ch bucket: %r' %
+00012fe0: 2073 7263 5f75 726c 290a 2020 2020 2020   src_url).      
+00012ff0: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00013000: 7461 6e63 6528 6572 726f 722c 2053 3346  tance(error, S3F
+00013010: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
+00013020: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00013030: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+00013040: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
+00013050: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00013060: 6973 6520 5333 4669 6c65 4e6f 7446 6f75  ise S3FileNotFou
+00013070: 6e64 4572 726f 7228 274e 6f20 7375 6368  ndError('No such
+00013080: 2066 696c 653a 2025 7227 2025 2073 7263   file: %r' % src
+00013090: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
+000130a0: 2020 7261 6973 6520 6572 726f 720a 0a20    raise error.. 
+000130b0: 2020 2064 6566 2073 796e 6328 7365 6c66     def sync(self
+000130c0: 2c20 6473 745f 7572 6c3a 2050 6174 684c  , dst_url: PathL
+000130d0: 696b 652c 2066 6f6c 6c6f 776c 696e 6b73  ike, followlinks
+000130e0: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
+000130f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00013100: 2027 2727 0a20 2020 2020 2020 2043 6f70   '''.        Cop
+00013110: 7920 6669 6c65 2f64 6972 6563 746f 7279  y file/directory
+00013120: 206f 6e20 7372 635f 7572 6c20 746f 2064   on src_url to d
+00013130: 7374 5f75 726c 0a0a 2020 2020 2020 2020  st_url..        
+00013140: 3a70 6172 616d 2064 7374 5f75 726c 3a20  :param dst_url: 
+00013150: 4769 7665 6e20 6465 7374 696e 6174 696f  Given destinatio
+00013160: 6e20 7061 7468 0a20 2020 2020 2020 2027  n path.        '
+00013170: 2727 0a20 2020 2020 2020 2066 6f72 2073  ''.        for s
+00013180: 7263 5f66 696c 655f 7061 7468 2c20 6473  rc_file_path, ds
+00013190: 745f 6669 6c65 5f70 6174 6820 696e 205f  t_file_path in _
+000131a0: 7333 5f73 6361 6e5f 7061 6972 7328 0a20  s3_scan_pairs(. 
+000131b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000131c0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+000131d0: 6f74 6f63 6f6c 2c20 6473 745f 7572 6c29  otocol, dst_url)
+000131e0: 3a0a 2020 2020 2020 2020 2020 2020 7372  :.            sr
+000131f0: 635f 6669 6c65 5f70 6174 6820 3d20 7365  c_file_path = se
+00013200: 6c66 2e66 726f 6d5f 7061 7468 2873 7263  lf.from_path(src
+00013210: 5f66 696c 655f 7061 7468 290a 2020 2020  _file_path).    
+00013220: 2020 2020 2020 2020 6473 745f 6669 6c65          dst_file
+00013230: 5f70 6174 6820 3d20 7365 6c66 2e66 726f  _path = self.fro
+00013240: 6d5f 7061 7468 2864 7374 5f66 696c 655f  m_path(dst_file_
+00013250: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+00013260: 2020 6966 2064 7374 5f66 696c 655f 7061    if dst_file_pa
+00013270: 7468 2e65 7869 7374 7328 2920 616e 6420  th.exists() and 
+00013280: 6973 5f73 616d 655f 6669 6c65 280a 2020  is_same_file(.  
+00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000132a0: 2020 7372 635f 6669 6c65 5f70 6174 682e    src_file_path.
+000132b0: 7374 6174 2829 2c20 6473 745f 6669 6c65  stat(), dst_file
+000132c0: 5f70 6174 682e 7374 6174 2829 2c20 2763  _path.stat(), 'c
+000132d0: 6f70 7927 293a 0a20 2020 2020 2020 2020  opy'):.         
+000132e0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+000132f0: 2020 2020 2020 2020 2020 2020 7372 635f              src_
+00013300: 6669 6c65 5f70 6174 682e 636f 7079 2864  file_path.copy(d
+00013310: 7374 5f66 696c 655f 7061 7468 2c20 666f  st_file_path, fo
+00013320: 6c6c 6f77 6c69 6e6b 733d 666f 6c6c 6f77  llowlinks=follow
+00013330: 6c69 6e6b 7329 0a0a 2020 2020 6465 6620  links)..    def 
+00013340: 7379 6d6c 696e 6b28 7365 6c66 2c20 6473  symlink(self, ds
+00013350: 745f 7061 7468 3a20 5061 7468 4c69 6b65  t_path: PathLike
+00013360: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00013370: 2020 2027 2727 0a20 2020 2020 2020 2043     '''.        C
+00013380: 7265 6174 6520 6120 7379 6d62 6f6c 6963  reate a symbolic
+00013390: 206c 696e 6b20 706f 696e 7469 6e67 2074   link pointing t
+000133a0: 6f20 7372 635f 7061 7468 206e 616d 6564  o src_path named
+000133b0: 2064 7374 5f70 6174 682e 0a0a 2020 2020   dst_path...    
+000133c0: 2020 2020 3a70 6172 616d 2064 7374 5f70      :param dst_p
+000133d0: 6174 683a 2044 6573 696e 6174 696f 6e20  ath: Desination 
+000133e0: 7061 7468 0a20 2020 2020 2020 203a 7261  path.        :ra
+000133f0: 6973 6573 3a20 5333 4e61 6d65 546f 6f4c  ises: S3NameTooL
+00013400: 6f6e 6745 7272 6f72 2c20 5333 4275 636b  ongError, S3Buck
+00013410: 6574 4e6f 7446 6f75 6e64 4572 726f 722c  etNotFoundError,
+00013420: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
+00013430: 7272 6f72 0a20 2020 2020 2020 2027 2727  rror.        '''
+00013440: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00013450: 7374 7228 7365 6c66 2e5f 7333 5f70 6174  str(self._s3_pat
+00013460: 6829 2e65 6e63 6f64 6528 2929 203e 2031  h).encode()) > 1
+00013470: 3032 343a 0a20 2020 2020 2020 2020 2020  024:.           
+00013480: 2072 6169 7365 2053 334e 616d 6554 6f6f   raise S3NameToo
+00013490: 4c6f 6e67 4572 726f 7228 2746 696c 6520  LongError('File 
+000134a0: 6e61 6d65 2074 6f6f 206c 6f6e 673a 2025  name too long: %
+000134b0: 7227 2025 2064 7374 5f70 6174 6829 0a20  r' % dst_path). 
+000134c0: 2020 2020 2020 2073 7263 5f62 7563 6b65         src_bucke
+000134d0: 742c 2073 7263 5f6b 6579 203d 2070 6172  t, src_key = par
+000134e0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+000134f0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00013500: 6c29 0a20 2020 2020 2020 2064 7374 5f62  l).        dst_b
+00013510: 7563 6b65 742c 2064 7374 5f6b 6579 203d  ucket, dst_key =
+00013520: 2070 6172 7365 5f73 335f 7572 6c28 6473   parse_s3_url(ds
+00013530: 745f 7061 7468 290a 0a20 2020 2020 2020  t_path)..       
+00013540: 2069 6620 6e6f 7420 7372 635f 6275 636b   if not src_buck
+00013550: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00013560: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+00013570: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
+00013580: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+00013590: 2572 2720 2520 7365 6c66 2e70 6174 6829  %r' % self.path)
+000135a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000135b0: 6473 745f 6275 636b 6574 3a0a 2020 2020  dst_bucket:.    
+000135c0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+000135d0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
+000135e0: 726f 7228 2745 6d70 7479 2062 7563 6b65  ror('Empty bucke
+000135f0: 7420 6e61 6d65 3a20 2572 2720 2520 6473  t name: %r' % ds
+00013600: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
+00013610: 6966 206e 6f74 2064 7374 5f6b 6579 206f  if not dst_key o
+00013620: 7220 6473 745f 6b65 792e 656e 6473 7769  r dst_key.endswi
+00013630: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+00013640: 2020 2020 2072 6169 7365 2053 3349 7341       raise S3IsA
+00013650: 4469 7265 6374 6f72 7945 7272 6f72 2827  DirectoryError('
+00013660: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
+00013670: 2572 2720 2520 6473 745f 7061 7468 290a  %r' % dst_path).
+00013680: 0a20 2020 2020 2020 2073 7263 5f70 6174  .        src_pat
+00013690: 6820 3d20 7365 6c66 2e5f 7333 5f70 6174  h = self._s3_pat
+000136a0: 680a 2020 2020 2020 2020 7472 793a 0a20  h.        try:. 
+000136b0: 2020 2020 2020 2020 2020 2073 7263 5f70             src_p
+000136c0: 6174 6820 3d20 7365 6c66 2e72 6561 646c  ath = self.readl
+000136d0: 696e 6b28 292e 5f73 335f 7061 7468 0a20  ink()._s3_path. 
+000136e0: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
+000136f0: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
+00013700: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00013710: 2020 2020 2020 2020 7769 7468 2072 6169          with rai
+00013720: 7365 5f73 335f 6572 726f 7228 6473 745f  se_s3_error(dst_
+00013730: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
+00013740: 2020 2073 656c 662e 5f63 6c69 656e 742e     self._client.
+00013750: 7075 745f 6f62 6a65 6374 280a 2020 2020  put_object(.    
+00013760: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
+00013770: 6574 3d64 7374 5f62 7563 6b65 742c 0a20  et=dst_bucket,. 
+00013780: 2020 2020 2020 2020 2020 2020 2020 204b                 K
+00013790: 6579 3d64 7374 5f6b 6579 2c0a 2020 2020  ey=dst_key,.    
+000137a0: 2020 2020 2020 2020 2020 2020 4d65 7461              Meta
+000137b0: 6461 7461 3d7b 2273 796d 6c69 6e6b 5f74  data={"symlink_t
+000137c0: 6f22 3a20 7372 635f 7061 7468 7d29 0a0a  o": src_path})..
+000137d0: 2020 2020 6465 6620 7265 6164 6c69 6e6b      def readlink
+000137e0: 2873 656c 6629 202d 3e20 2753 3350 6174  (self) -> 'S3Pat
+000137f0: 6827 3a0a 2020 2020 2020 2020 2727 270a  h':.        '''.
+00013800: 2020 2020 2020 2020 5265 7475 726e 2061          Return a
+00013810: 2053 3350 6174 6820 696e 7374 616e 6365   S3Path instance
+00013820: 2072 6570 7265 7365 6e74 696e 6720 7468   representing th
+00013830: 6520 7061 7468 2074 6f20 7768 6963 6820  e path to which 
+00013840: 7468 6520 7379 6d62 6f6c 6963 206c 696e  the symbolic lin
+00013850: 6b20 706f 696e 7473 2e0a 0a20 2020 2020  k points...     
+00013860: 2020 203a 7265 7475 726e 733a 2052 6574     :returns: Ret
+00013870: 7572 6e20 6120 5333 5061 7468 2069 6e73  urn a S3Path ins
+00013880: 7461 6e63 6520 7265 7072 6573 656e 7469  tance representi
+00013890: 6e67 2074 6865 2070 6174 6820 746f 2077  ng the path to w
+000138a0: 6869 6368 2074 6865 2073 796d 626f 6c69  hich the symboli
+000138b0: 6320 6c69 6e6b 2070 6f69 6e74 732e 0a20  c link points.. 
+000138c0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+000138d0: 5333 4e61 6d65 546f 6f4c 6f6e 6745 7272  S3NameTooLongErr
+000138e0: 6f72 2c20 5333 4275 636b 6574 4e6f 7446  or, S3BucketNotF
+000138f0: 6f75 6e64 4572 726f 722c 2053 3349 7341  oundError, S3IsA
+00013900: 4469 7265 6374 6f72 7945 7272 6f72 2c20  DirectoryError, 
+00013910: 5333 4e6f 7441 4c69 6e6b 4572 726f 720a  S3NotALinkError.
+00013920: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00013930: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+00013940: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+00013950: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00013960: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+00013970: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
+00013980: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00013990: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+000139a0: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
+000139b0: 2020 2020 2020 2020 2745 6d70 7479 2062          'Empty b
+000139c0: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
+000139d0: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
+000139e0: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+000139f0: 2020 2069 6620 6e6f 7420 6b65 7920 6f72     if not key or
+00013a00: 206b 6579 2e65 6e64 7377 6974 6828 272f   key.endswith('/
+00013a10: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00013a20: 7261 6973 6520 5333 4973 4144 6972 6563  raise S3IsADirec
+00013a30: 746f 7279 4572 726f 7228 0a20 2020 2020  toryError(.     
+00013a40: 2020 2020 2020 2020 2020 2027 4973 2061             'Is a
+00013a50: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
+00013a60: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
+00013a70: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+00013a80: 2020 206d 6574 6164 6174 6120 3d20 7365     metadata = se
+00013a90: 6c66 2e5f 7333 5f67 6574 5f6d 6574 6164  lf._s3_get_metad
+00013aa0: 6174 6128 290a 0a20 2020 2020 2020 2069  ata()..        i
+00013ab0: 6620 6e6f 7420 2773 796d 6c69 6e6b 5f74  f not 'symlink_t
+00013ac0: 6f27 2069 6e20 6d65 7461 6461 7461 3a0a  o' in metadata:.
+00013ad0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013ae0: 6520 5333 4e6f 7441 4c69 6e6b 4572 726f  e S3NotALinkErro
+00013af0: 7228 274e 6f74 2061 206c 696e 6b3a 2025  r('Not a link: %
+00013b00: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
+00013b10: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+00013b20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00013b30: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00013b40: 656c 662e 6672 6f6d 5f70 6174 6828 6d65  elf.from_path(me
+00013b50: 7461 6461 7461 5b27 7379 6d6c 696e 6b5f  tadata['symlink_
+00013b60: 746f 275d 290a 0a20 2020 2064 6566 2069  to'])..    def i
+00013b70: 735f 7379 6d6c 696e 6b28 7365 6c66 2920  s_symlink(self) 
+00013b80: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00013b90: 2027 2727 0a20 2020 2020 2020 2054 6573   '''.        Tes
+00013ba0: 7420 7768 6574 6865 7220 6120 7061 7468  t whether a path
+00013bb0: 2069 7320 6c69 6e6b 0a0a 2020 2020 2020   is link..      
+00013bc0: 2020 3a72 6574 7572 6e73 3a20 5472 7565    :returns: True
+00013bd0: 2069 6620 6120 7061 7468 2069 7320 6c69   if a path is li
+00013be0: 6e6b 2c20 656c 7365 2046 616c 7365 0a20  nk, else False. 
+00013bf0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+00013c00: 5333 4e6f 7441 4c69 6e6b 4572 726f 720a  S3NotALinkError.
+00013c10: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00013c20: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+00013c30: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+00013c40: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00013c50: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+00013c60: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
+00013c70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013c80: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
+00013c90: 6966 206e 6f74 206b 6579 206f 7220 6b65  if not key or ke
+00013ca0: 792e 656e 6473 7769 7468 2827 2f27 293a  y.endswith('/'):
+00013cb0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00013cc0: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
+00013cd0: 2020 6d65 7461 6461 7461 203d 2073 656c    metadata = sel
+00013ce0: 662e 5f73 335f 6765 745f 6d65 7461 6461  f._s3_get_metada
+00013cf0: 7461 2829 0a20 2020 2020 2020 2072 6574  ta().        ret
+00013d00: 7572 6e20 2773 796d 6c69 6e6b 5f74 6f27  urn 'symlink_to'
+00013d10: 2069 6e20 6d65 7461 6461 7461 0a0a 2020   in metadata..  
+00013d20: 2020 6465 6620 7361 7665 2873 656c 662c    def save(self,
+00013d30: 2066 696c 655f 6f62 6a65 6374 3a20 4269   file_object: Bi
+00013d40: 6e61 7279 494f 293a 0a20 2020 2020 2020  naryIO):.       
+00013d50: 2027 2727 5772 6974 6520 7468 6520 6f70   '''Write the op
+00013d60: 656e 6564 2062 696e 6172 7920 7374 7265  ened binary stre
+00013d70: 616d 2074 6f20 7370 6563 6966 6965 6420  am to specified 
+00013d80: 7061 7468 2c20 6275 7420 7468 6520 7374  path, but the st
+00013d90: 7265 616d 2077 6f6e 2774 2062 6520 636c  ream won't be cl
+00013da0: 6f73 6564 0a0a 2020 2020 2020 2020 3a70  osed..        :p
+00013db0: 6172 616d 2066 696c 655f 6f62 6a65 6374  aram file_object
+00013dc0: 3a20 5374 7265 616d 2074 6f20 6265 2072  : Stream to be r
+00013dd0: 6561 640a 2020 2020 2020 2020 2727 270a  ead.        '''.
+00013de0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+00013df0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+00013e00: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
+00013e10: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00013e20: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+00013e30: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00013e40: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+00013e50: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
+00013e60: 2020 2020 2020 2020 2020 2020 2745 6d70              'Emp
+00013e70: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+00013e80: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+00013e90: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00013ea0: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
+00013eb0: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
+00013ec0: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+00013ed0: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
+00013ee0: 6972 6563 746f 7279 4572 726f 7228 0a20  irectoryError(. 
+00013ef0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00013f00: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
+00013f10: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+00013f20: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
+00013f30: 2020 2020 2020 2020 7769 7468 2072 6169          with rai
+00013f40: 7365 5f73 335f 6572 726f 7228 7365 6c66  se_s3_error(self
+00013f50: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00013f60: 636f 6c29 3a0a 2020 2020 2020 2020 2020  col):.          
+00013f70: 2020 7365 6c66 2e5f 636c 6965 6e74 2e75    self._client.u
+00013f80: 706c 6f61 645f 6669 6c65 6f62 6a28 6669  pload_fileobj(fi
+00013f90: 6c65 5f6f 626a 6563 742c 2042 7563 6b65  le_object, Bucke
+00013fa0: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
+00013fb0: 7929 0a0a 2020 2020 6465 6620 6f70 656e  y)..    def open
+00013fc0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00013fd0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00013fe0: 6d6f 6465 3a20 7374 7220 3d20 2772 272c  mode: str = 'r',
+00013ff0: 0a20 2020 2020 2020 2020 2020 202a 2c0a  .            *,.
+00014000: 2020 2020 2020 2020 2020 2020 7333 5f6f              s3_o
+00014010: 7065 6e5f 6675 6e63 3a20 4361 6c6c 6162  pen_func: Callab
+00014020: 6c65 5b5b 7374 722c 2073 7472 5d2c 2042  le[[str, str], B
+00014030: 696e 6172 7949 4f5d 203d 2073 335f 6f70  inaryIO] = s3_op
+00014040: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
+00014050: 2a2a 6b77 6172 6773 2920 2d3e 2049 4f5b  **kwargs) -> IO[
+00014060: 416e 7953 7472 5d3a 2020 2320 7079 7479  AnyStr]:  # pyty
+00014070: 7065 3a20 6469 7361 626c 653d 7369 676e  pe: disable=sign
+00014080: 6174 7572 652d 6d69 736d 6174 6368 0a20  ature-mismatch. 
+00014090: 2020 2020 2020 2072 6574 7572 6e20 7333         return s3
+000140a0: 5f6f 7065 6e5f 6675 6e63 280a 2020 2020  _open_func(.    
+000140b0: 2020 2020 2020 2020 7365 6c66 2e70 6174          self.pat
+000140c0: 685f 7769 7468 5f70 726f 746f 636f 6c2c  h_with_protocol,
+000140d0: 206d 6f64 652c 0a20 2020 2020 2020 2020   mode,.         
+000140e0: 2020 202a 2a6e 6563 6573 7361 7279 5f70     **necessary_p
+000140f0: 6172 616d 7328 7333 5f6f 7065 6e5f 6675  arams(s3_open_fu
+00014100: 6e63 2c20 2a2a 6b77 6172 6773 2929 0a0a  nc, **kwargs))..
+00014110: 2020 2020 6465 6620 6162 736f 6c75 7465      def absolute
+00014120: 2873 656c 6629 202d 3e20 2753 3350 6174  (self) -> 'S3Pat
+00014130: 6827 3a0a 2020 2020 2020 2020 2727 270a  h':.        '''.
+00014140: 2020 2020 2020 2020 4d61 6b65 2074 6865          Make the
+00014150: 2070 6174 6820 6162 736f 6c75 7465 2c20   path absolute, 
+00014160: 7769 7468 6f75 7420 6e6f 726d 616c 697a  without normaliz
+00014170: 6174 696f 6e20 6f72 2072 6573 6f6c 7669  ation or resolvi
+00014180: 6e67 2073 796d 6c69 6e6b 732e 2052 6574  ng symlinks. Ret
+00014190: 7572 6e73 2061 206e 6577 2070 6174 6820  urns a new path 
+000141a0: 6f62 6a65 6374 0a20 2020 2020 2020 2027  object.        '
+000141b0: 2727 0a20 2020 2020 2020 2072 6574 7572  ''.        retur
+000141c0: 6e20 7365 6c66 0a0a 2020 2020 6465 6620  n self..    def 
+000141d0: 6377 6428 7365 6c66 2920 2d3e 2027 5333  cwd(self) -> 'S3
+000141e0: 5061 7468 273a 0a20 2020 2020 2020 2027  Path':.        '
+000141f0: 2727 5265 7475 726e 2063 7572 7265 6e74  ''Return current
+00014200: 2077 6f72 6b69 6e67 2064 6972 6563 746f   working directo
+00014210: 7279 0a0a 2020 2020 2020 2020 7265 7475  ry..        retu
+00014220: 726e 733a 2043 7572 7265 6e74 2077 6f72  rns: Current wor
+00014230: 6b69 6e67 2064 6972 6563 746f 7279 0a20  king directory. 
+00014240: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00014250: 2020 2072 6574 7572 6e20 7365 6c66 2e66     return self.f
+00014260: 726f 6d5f 7061 7468 2873 656c 662e 7061  rom_path(self.pa
+00014270: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+00014280: 290a 0a0a 636c 6173 7320 4d75 6c74 6950  )...class MultiP
+00014290: 6172 7457 7269 7465 723a 0a0a 2020 2020  artWriter:..    
+000142a0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000142b0: 662c 2063 6c69 656e 742c 2070 6174 683a  f, client, path:
+000142c0: 2050 6174 684c 696b 6529 202d 3e20 4e6f   PathLike) -> No
+000142d0: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+000142e0: 2e5f 636c 6965 6e74 203d 2063 6c69 656e  ._client = clien
+000142f0: 740a 2020 2020 2020 2020 7365 6c66 2e5f  t.        self._
+00014300: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
+00014310: 5f69 6e66 6f20 3d20 5b5d 0a0a 2020 2020  _info = []..    
+00014320: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+00014330: 3d20 7061 7273 655f 7333 5f75 726c 2870  = parse_s3_url(p
+00014340: 6174 6829 0a20 2020 2020 2020 2073 656c  ath).        sel
+00014350: 662e 5f62 7563 6b65 7420 3d20 6275 636b  f._bucket = buck
+00014360: 6574 0a20 2020 2020 2020 2073 656c 662e  et.        self.
+00014370: 5f6b 6579 203d 206b 6579 0a20 2020 2020  _key = key.     
+00014380: 2020 2073 656c 662e 5f75 706c 6f61 645f     self._upload_
+00014390: 6964 203d 2073 656c 662e 5f63 6c69 656e  id = self._clien
+000143a0: 742e 6372 6561 7465 5f6d 756c 7469 7061  t.create_multipa
+000143b0: 7274 5f75 706c 6f61 6428 0a20 2020 2020  rt_upload(.     
+000143c0: 2020 2020 2020 2042 7563 6b65 743d 7365         Bucket=se
+000143d0: 6c66 2e5f 6275 636b 6574 2c20 4b65 793d  lf._bucket, Key=
+000143e0: 7365 6c66 2e5f 6b65 7929 5b27 5570 6c6f  self._key)['Uplo
+000143f0: 6164 4964 275d 0a0a 2020 2020 6465 6620  adId']..    def 
+00014400: 7570 6c6f 6164 5f70 6172 7428 7365 6c66  upload_part(self
+00014410: 2c20 7061 7274 5f6e 756d 3a20 696e 742c  , part_num: int,
+00014420: 2066 696c 655f 6f62 6a3a 2069 6f2e 4279   file_obj: io.By
+00014430: 7465 7349 4f29 202d 3e20 4e6f 6e65 3a0a  tesIO) -> None:.
+00014440: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00014450: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
+00014460: 7570 6c6f 6164 5f70 6172 7428 0a20 2020  upload_part(.   
+00014470: 2020 2020 2020 2020 2042 6f64 793d 6669           Body=fi
+00014480: 6c65 5f6f 626a 2c0a 2020 2020 2020 2020  le_obj,.        
+00014490: 2020 2020 5570 6c6f 6164 4964 3d73 656c      UploadId=sel
+000144a0: 662e 5f75 706c 6f61 645f 6964 2c0a 2020  f._upload_id,.  
+000144b0: 2020 2020 2020 2020 2020 5061 7274 4e75            PartNu
+000144c0: 6d62 6572 3d70 6172 745f 6e75 6d2c 0a20  mber=part_num,. 
+000144d0: 2020 2020 2020 2020 2020 2042 7563 6b65             Bucke
+000144e0: 743d 7365 6c66 2e5f 6275 636b 6574 2c0a  t=self._bucket,.
+000144f0: 2020 2020 2020 2020 2020 2020 4b65 793d              Key=
+00014500: 7365 6c66 2e5f 6b65 792c 0a20 2020 2020  self._key,.     
+00014510: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00014520: 662e 5f6d 756c 7469 7061 7274 5f75 706c  f._multipart_upl
+00014530: 6f61 645f 696e 666f 2e61 7070 656e 6428  oad_info.append(
+00014540: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00014550: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00014560: 5061 7274 4e75 6d62 6572 273a 2070 6172  PartNumber': par
+00014570: 745f 6e75 6d2c 0a20 2020 2020 2020 2020  t_num,.         
+00014580: 2020 2020 2020 2027 4554 6167 273a 2072         'ETag': r
+00014590: 6573 706f 6e73 655b 2745 5461 6727 5d0a  esponse['ETag'].
+000145a0: 2020 2020 2020 2020 2020 2020 7d29 0a0a              })..
+000145b0: 2020 2020 6465 6620 7570 6c6f 6164 5f70      def upload_p
+000145c0: 6172 745f 6279 5f70 6174 6873 280a 2020  art_by_paths(.  
+000145d0: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
+000145e0: 7061 7274 5f6e 756d 3a20 696e 742c 2070  part_num: int, p
+000145f0: 6174 6873 3a20 4c69 7374 5b54 7570 6c65  aths: List[Tuple
+00014600: 5b50 6174 684c 696b 652c 2073 7472 5d5d  [PathLike, str]]
+00014610: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014620: 2020 2066 696c 655f 6f62 6a20 3d20 696f     file_obj = io
+00014630: 2e42 7974 6573 494f 2829 0a20 2020 2020  .BytesIO().     
+00014640: 2020 2066 6f72 2070 6174 682c 2062 7974     for path, byt
+00014650: 6573 5f72 616e 6765 2069 6e20 7061 7468  es_range in path
+00014660: 733a 0a20 2020 2020 2020 2020 2020 2062  s:.            b
+00014670: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00014680: 7365 5f73 335f 7572 6c28 7061 7468 290a  se_s3_url(path).
+00014690: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+000146a0: 7974 6573 5f72 616e 6765 3a0a 2020 2020  ytes_range:.    
+000146b0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+000146c0: 5f6f 626a 2e77 7269 7465 280a 2020 2020  _obj.write(.    
+000146d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146e0: 7365 6c66 2e5f 636c 6965 6e74 2e67 6574  self._client.get
+000146f0: 5f6f 626a 6563 7428 0a20 2020 2020 2020  _object(.       
+00014700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014710: 2042 7563 6b65 743d 6275 636b 6574 2c20   Bucket=bucket, 
+00014720: 4b65 793d 6b65 792c 0a20 2020 2020 2020  Key=key,.       
+00014730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014740: 2052 616e 6765 3d62 7974 6573 5f72 616e   Range=bytes_ran
+00014750: 6765 295b 2742 6f64 7927 5d2e 7265 6164  ge)['Body'].read
+00014760: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00014770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00014780: 2020 2020 2020 6669 6c65 5f6f 626a 2e77        file_obj.w
+00014790: 7269 7465 280a 2020 2020 2020 2020 2020  rite(.          
+000147a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000147b0: 636c 6965 6e74 2e67 6574 5f6f 626a 6563  client.get_objec
+000147c0: 7428 4275 636b 6574 3d62 7563 6b65 742c  t(Bucket=bucket,
+000147d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000147e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147f0: 2020 2020 2020 2020 2020 2020 204b 6579               Key
+00014800: 3d6b 6579 295b 2742 6f64 7927 5d2e 7265  =key)['Body'].re
+00014810: 6164 2829 290a 2020 2020 2020 2020 6669  ad()).        fi
+00014820: 6c65 5f6f 626a 2e73 6565 6b28 302c 206f  le_obj.seek(0, o
+00014830: 732e 5345 454b 5f53 4554 290a 2020 2020  s.SEEK_SET).    
+00014840: 2020 2020 7365 6c66 2e75 706c 6f61 645f      self.upload_
+00014850: 7061 7274 2870 6172 745f 6e75 6d2c 2066  part(part_num, f
+00014860: 696c 655f 6f62 6a29 0a0a 2020 2020 6465  ile_obj)..    de
+00014870: 6620 7570 6c6f 6164 5f70 6172 745f 636f  f upload_part_co
+00014880: 7079 280a 2020 2020 2020 2020 2020 2020  py(.            
+00014890: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+000148a0: 2020 7061 7274 5f6e 756d 3a20 696e 742c    part_num: int,
+000148b0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+000148c0: 683a 2050 6174 684c 696b 652c 0a20 2020  h: PathLike,.   
+000148d0: 2020 2020 2020 2020 2063 6f70 795f 736f           copy_so
+000148e0: 7572 6365 5f72 616e 6765 3a20 4f70 7469  urce_range: Opti
+000148f0: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00014900: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014910: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+00014920: 2070 6172 7365 5f73 335f 7572 6c28 7061   parse_s3_url(pa
+00014930: 7468 290a 2020 2020 2020 2020 7061 7261  th).        para
+00014940: 6d73 203d 2064 6963 7428 0a20 2020 2020  ms = dict(.     
+00014950: 2020 2020 2020 2055 706c 6f61 6449 643d         UploadId=
+00014960: 7365 6c66 2e5f 7570 6c6f 6164 5f69 642c  self._upload_id,
+00014970: 0a20 2020 2020 2020 2020 2020 2050 6172  .            Par
+00014980: 744e 756d 6265 723d 7061 7274 5f6e 756d  tNumber=part_num
+00014990: 2c0a 2020 2020 2020 2020 2020 2020 436f  ,.            Co
+000149a0: 7079 536f 7572 6365 3d7b 0a20 2020 2020  pySource={.     
+000149b0: 2020 2020 2020 2020 2020 2027 4275 636b             'Buck
+000149c0: 6574 273a 2062 7563 6b65 742c 0a20 2020  et': bucket,.   
+000149d0: 2020 2020 2020 2020 2020 2020 2027 4b65               'Ke
+000149e0: 7927 3a20 6b65 790a 2020 2020 2020 2020  y': key.        
+000149f0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00014a00: 2020 2042 7563 6b65 743d 7365 6c66 2e5f     Bucket=self._
+00014a10: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+00014a20: 2020 2020 4b65 793d 7365 6c66 2e5f 6b65      Key=self._ke
+00014a30: 792c 0a20 2020 2020 2020 2029 0a20 2020  y,.        ).   
+00014a40: 2020 2020 2069 6620 636f 7079 5f73 6f75       if copy_sou
+00014a50: 7263 655f 7261 6e67 653a 0a20 2020 2020  rce_range:.     
+00014a60: 2020 2020 2020 2070 6172 616d 735b 2743         params['C
+00014a70: 6f70 7953 6f75 7263 6552 616e 6765 275d  opySourceRange']
+00014a80: 203d 2063 6f70 795f 736f 7572 6365 5f72   = copy_source_r
+00014a90: 616e 6765 0a20 2020 2020 2020 2072 6573  ange.        res
+00014aa0: 706f 6e73 6520 3d20 7365 6c66 2e5f 636c  ponse = self._cl
+00014ab0: 6965 6e74 2e75 706c 6f61 645f 7061 7274  ient.upload_part
+00014ac0: 5f63 6f70 7928 2a2a 7061 7261 6d73 290a  _copy(**params).
+00014ad0: 2020 2020 2020 2020 7365 6c66 2e5f 6d75          self._mu
+00014ae0: 6c74 6970 6172 745f 7570 6c6f 6164 5f69  ltipart_upload_i
+00014af0: 6e66 6f2e 6170 7065 6e64 280a 2020 2020  nfo.append(.    
+00014b00: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00014b10: 2020 2020 2020 2020 2020 2750 6172 744e            'PartN
+00014b20: 756d 6265 7227 3a20 7061 7274 5f6e 756d  umber': part_num
+00014b30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014b40: 2020 2745 5461 6727 3a20 7265 7370 6f6e    'ETag': respon
+00014b50: 7365 5b27 436f 7079 5061 7274 5265 7375  se['CopyPartResu
+00014b60: 6c74 275d 5b27 4554 6167 275d 0a20 2020  lt']['ETag'].   
+00014b70: 2020 2020 2020 2020 207d 290a 0a20 2020           })..   
+00014b80: 2064 6566 2063 6c6f 7365 2873 656c 6629   def close(self)
+00014b90: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
+00014ba0: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
+00014bb0: 5f69 6e66 6f2e 736f 7274 286b 6579 3d6c  _info.sort(key=l
+00014bc0: 616d 6264 6120 743a 2074 5b27 5061 7274  ambda t: t['Part
+00014bd0: 4e75 6d62 6572 275d 290a 2020 2020 2020  Number']).      
+00014be0: 2020 7365 6c66 2e5f 636c 6965 6e74 2e63    self._client.c
+00014bf0: 6f6d 706c 6574 655f 6d75 6c74 6970 6172  omplete_multipar
+00014c00: 745f 7570 6c6f 6164 280a 2020 2020 2020  t_upload(.      
+00014c10: 2020 2020 2020 5570 6c6f 6164 4964 3d73        UploadId=s
+00014c20: 656c 662e 5f75 706c 6f61 645f 6964 2c0a  elf._upload_id,.
+00014c30: 2020 2020 2020 2020 2020 2020 4275 636b              Buck
+00014c40: 6574 3d73 656c 662e 5f62 7563 6b65 742c  et=self._bucket,
+00014c50: 0a20 2020 2020 2020 2020 2020 204b 6579  .            Key
+00014c60: 3d73 656c 662e 5f6b 6579 2c0a 2020 2020  =self._key,.    
+00014c70: 2020 2020 2020 2020 4d75 6c74 6970 6172          Multipar
+00014c80: 7455 706c 6f61 643d 7b27 5061 7274 7327  tUpload={'Parts'
+00014c90: 3a20 7365 6c66 2e5f 6d75 6c74 6970 6172  : self._multipar
+00014ca0: 745f 7570 6c6f 6164 5f69 6e66 6f7d 290a  t_upload_info}).
+00014cb0: 0a20 2020 2064 6566 205f 5f65 6e74 6572  .    def __enter
+00014cc0: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00014cd0: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
+00014ce0: 2020 2064 6566 205f 5f65 7869 745f 5f28     def __exit__(
+00014cf0: 7365 6c66 2c20 6578 635f 7479 7065 2c20  self, exc_type, 
+00014d00: 6578 635f 7661 6c2c 2065 7863 5f74 6229  exc_val, exc_tb)
+00014d10: 3a0a 2020 2020 2020 2020 7365 6c66 2e63  :.        self.c
+00014d20: 6c6f 7365 2829 0a                        lose().
```

## megfile/sftp_path.py

```diff
@@ -363,79 +363,90 @@
         src_url: PathLike,
         dst_url: PathLike,
         callback: Optional[Callable[[int], None]] = None,
         followlinks: bool = False):
     '''
     File download
     '''
-    from megfile.fs_path import FSPath, is_fs
+    from megfile.fs import is_fs
+    from megfile.fs_path import FSPath
+
     if not is_fs(dst_url):
         raise OSError(f'dst_url is not fs path: {dst_url}')
     if not is_sftp(src_url):
         raise OSError(f'src_url is not sftp path: {src_url}')
 
-    src_url = SftpPath(src_url)
-    if followlinks and src_url.is_symlink():
-        src_url = src_url.readlink()
-    if src_url.is_dir():
+    src_path = SftpPath(src_url)
+    if followlinks and src_path.is_symlink():
+        src_path = src_path.readlink()
+    if src_path.is_dir():
         raise IsADirectoryError('Is a directory: %r' % src_url)
     if str(dst_url).endswith('/'):
         raise IsADirectoryError('Is a directory: %r' % dst_url)
 
-    os.makedirs(os.path.dirname(dst_url), exist_ok=True)
+    dst_path = FSPath(dst_url)
+    dst_path.parent.makedirs(exist_ok=True)
 
     sftp_callback = None
     if callback:
 
         def sftp_callback(bytes_transferred: int, _total_bytes: int):
             callback(bytes_transferred)
 
-    src_url._client.get(src_url._real_path, dst_url, callback=sftp_callback)
+    src_path._client.get(
+        src_path._real_path,
+        dst_path.path_without_protocol,
+        callback=sftp_callback)
 
-    src_stat = src_url.stat()
-    dst_path = FSPath(dst_url)
+    src_stat = src_path.stat()
     dst_path.utime(src_stat.st_atime, src_stat.st_mtime)
     dst_path.chmod(src_stat.st_mode)
 
 
 def sftp_upload(
         src_url: PathLike,
         dst_url: PathLike,
         callback: Optional[Callable[[int], None]] = None,
         followlinks: bool = False):
     '''
     File upload
     '''
-    from megfile.fs import fs_stat, is_fs
+    from megfile.fs import is_fs
+    from megfile.fs_path import FSPath
+
     if not is_fs(src_url):
         raise OSError(f'src_url is not fs path: {src_url}')
     if not is_sftp(dst_url):
         raise OSError(f'dst_url is not sftp path: {dst_url}')
 
     if followlinks and os.path.islink(src_url):
         src_url = os.readlink(src_url)
     if os.path.isdir(src_url):
         raise IsADirectoryError('Is a directory: %r' % src_url)
     if str(dst_url).endswith('/'):
         raise IsADirectoryError('Is a directory: %r' % dst_url)
 
-    dst_url = SftpPath(dst_url)
-    dst_url.parent.makedirs(exist_ok=True)
+    src_path = FSPath(src_url)
+    dst_path = SftpPath(dst_url)
+    dst_path.parent.makedirs(exist_ok=True)
 
     sftp_callback = None
     if callback:
 
         def sftp_callback(bytes_transferred: int, _total_bytes: int):
             callback(bytes_transferred)
 
-    dst_url._client.put(src_url, dst_url._real_path, callback=sftp_callback)
+    dst_path._client.put(
+        src_path.path_without_protocol,
+        dst_path._real_path,
+        callback=sftp_callback)
 
-    src_stat = fs_stat(src_url)
-    dst_url.utime(src_stat.st_atime, src_stat.st_mtime)
-    dst_url.chmod(src_stat.st_mode)
+    src_stat = src_path.stat()
+    dst_path.utime(src_stat.st_atime, src_stat.st_mtime)
+    dst_path.chmod(src_stat.st_mode)
 
 
 def sftp_path_join(path: PathLike, *other_paths: PathLike) -> str:
     '''
     Concat 2 or more path to a complete path
 
     :param path: Given path
```

## megfile/version.py

```diff
@@ -1 +1 @@
-VERSION = "2.2.0"
+VERSION = "2.2.0.post1"
```

## megfile/lib/s3_prefetch_reader.py

```diff
@@ -357,16 +357,18 @@
         def fetch_response() -> dict:
             if index is None:
                 return self._client.get_object(
                     Bucket=self._bucket, Key=self._key)
 
             range_str = 'bytes=%d-%d' % (
                 index * self._block_size, (index + 1) * self._block_size - 1)
-            return self._client.get_object(
+            response = self._client.get_object(
                 Bucket=self._bucket, Key=self._key, Range=range_str)
+            response['Body'] = BytesIO(response['Body'].read())
+            return response
 
         fetch_response = patch_method(
             fetch_response,
             max_retries=self._max_retries,
             should_retry=s3_should_retry)
 
         with raise_s3_error(self.name):
@@ -376,15 +378,15 @@
         response = self._fetch_response(index=index)
         etag = response.get('ETag', None)
         if etag is not None and etag != self._content_etag:
             raise S3FileChangedError(
                 'File changed: %r, etag before: %s, after: %s' %
                 (self.name, self._content_info, response))
 
-        return BytesIO(response['Body'].read())
+        return response['Body']
 
     def _submit_future(self, index: int):
         if index < 0 or index >= self._block_stop:
             return
         self._futures.submit(self._executor, index, self._fetch_buffer, index)
 
     def _insert_futures(self, index: int, future: Future):
```

## Comparing `megfile-2.2.0.dist-info/LICENSE` & `megfile-2.2.0.post1.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `megfile-2.2.0.dist-info/LICENSE.pyre` & `megfile-2.2.0.post1.dist-info/LICENSE.pyre`

 * *Files identical despite different names*

## Comparing `megfile-2.2.0.dist-info/METADATA` & `megfile-2.2.0.post1.dist-info/METADATA`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: megfile
-Version: 2.2.0
+Version: 2.2.0.post1
 Summary: Megvii file operation library
 Home-page: https://github.com/megvii-research/megfile
 Author: megvii
 Author-email: megfile@megvii.com
 Classifier: Development Status :: 4 - Beta
 Classifier: Environment :: Console
 Classifier: Intended Audience :: Developers
```

## Comparing `megfile-2.2.0.dist-info/RECORD` & `megfile-2.2.0.post1.dist-info/RECORD`

 * *Files 9% similar despite different names*

```diff
@@ -1,45 +1,45 @@
 megfile/__init__.py,sha256=Qsi3XNP_0XYoSol-1AGutZqo0rfBnzaiZ-HVXll4fB0,5721
-megfile/cli.py,sha256=zB6a1QjvIXqmd4nQR9YSTy3RH61pTX14E63uICjIRG8,12797
-megfile/errors.py,sha256=H5wCiVBvOtQo5cu3JLhAUCpQJsCkPNm1KNw9o8y4Las,11349
+megfile/cli.py,sha256=E3NoSZ8D-k3OCRXPDysFkjeHRunZXw4QvqjP5QNsgUg,12806
+megfile/errors.py,sha256=y0PJ4lzkm-uqgVD1EqakmN0IHBMt1CCzDbdbq84sVb4,11491
 megfile/fs.py,sha256=sjkm_LsvNCw8hj9Ee-1HSNzvg7bRHTPem8KTDDBQlCw,11621
 megfile/fs_path.py,sha256=Lz-u8XL2RMViHl_39yapAwX5XSE_ZpQsuhAvVve6rk8,38532
 megfile/http.py,sha256=Juz95GscschvmElieLIWqO2A4BrqJnrtTWTa9uzNN_4,2477
 megfile/http_path.py,sha256=XtpbYHdtHZysjkz6Xdr4fe8E6hlsV4iLNoIZaBk-_P4,5360
 megfile/interfaces.py,sha256=h3tWE8hVt5S-HopaMAX6lunPJ97vzhv6jH_2HubcDNc,6219
 megfile/pathlike.py,sha256=52e6POtMfUCC3Hb9XNwBLXM3Gkz3aGP8H8AagGKlDSg,29307
 megfile/s3.py,sha256=6d9bBVkVdXIvmJLfpOgJkK4nVAsLR3lirrB6x1-P2y8,12437
-megfile/s3_path.py,sha256=2AY_Rcn0ZR2TpPSqWxBcbUuQ3JuS7XerZ-wBK4wXyMo,84754
+megfile/s3_path.py,sha256=-odQ7rg38khf1Bc8webKBZewIfKIV5I1a-qsdshLLzA,85287
 megfile/sftp.py,sha256=qzfgI-MGzNsr7adUQaiVKS7zRHGuK-Hs6o45wNIAcww,11943
-megfile/sftp_path.py,sha256=h_NeZtkKJ44hBIuhvBbLUlADm02uEkRT2T4PBU44uP4,47103
+megfile/sftp_path.py,sha256=lbestqN_FXwIJbqFeHXLkq306B2zqVILFda4peKOQwY,47288
 megfile/smart.py,sha256=xjRRujYAPzXlrYxV7ZCAPXl0biUNn4730ATKc_tzIzE,32694
 megfile/smart_path.py,sha256=Rwb1McXsshi9-F6miTRqE6j8FO2j1edjmSxZF32YZ6E,6708
 megfile/stdio.py,sha256=qmi1c7VTll6Y6ya9MCd-dSKffocX2GafA-YUncZRU1Y,559
 megfile/stdio_path.py,sha256=ULMzGOj7SBMn3c7fYVSDepT_1nEUiVetc-xRt2pR5o4,2682
-megfile/version.py,sha256=SX94SfG1HNW6IdIYW_iqO17A0qZmHZUfyXnyAzilMUs,19
+megfile/version.py,sha256=wEKo6RBa-JfaOX7tcmNU28H0l1ZzziU5CEqvjD8Y1AU,25
 megfile/lib/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 megfile/lib/combine_reader.py,sha256=XFSqEY5A5X5Uf7eQ6AXAzrvNteESSXvKNVPktGjo3KY,4546
 megfile/lib/compare.py,sha256=yG2fZve_gMg32rQVCdwixBdqgYRsjn-24TqhALQaOrA,2233
 megfile/lib/compat.py,sha256=rYjfzQ3svuY7pB37W1JGyWH1kxd9aT4RtIe90npPtXI,3033
 megfile/lib/fnmatch.py,sha256=HgdlnEWBsdFUOZqnW_v1kj1jeH_9lMcCqW85pyMu4vM,4054
 megfile/lib/glob.py,sha256=7i9dIput9rI9JIPyTZX-JDmFS7IP_THlX1k-35foAfw,9732
 megfile/lib/joinpath.py,sha256=D4Px6-lnDDpYs1LMUHkTIGqMPJQ0oCBGfTzREs373iU,929
 megfile/lib/lazy_handler.py,sha256=f1rip2_T57vVo0WRNXve2bAa4LArvVheMfQg1S0vFzg,1915
 megfile/lib/s3_buffered_writer.py,sha256=AGjCNQ1X16kjFbEJouavkO6ykmlAtfVKBPAD-yYwAT0,6934
 megfile/lib/s3_cached_handler.py,sha256=e4KamTLMIPKa96yp7HGF05wDl2Yfoizz9pBrz-uAQ5w,1322
 megfile/lib/s3_limited_seekable_writer.py,sha256=NSBh5cZCCtwZM0DTwfPkpOA_h0NXd9-6qjasOby5zxc,6037
 megfile/lib/s3_memory_handler.py,sha256=jLBA5HVuI-UBPYMYN-B8iX_VGr8bC9brAqY-KbEGrtw,3725
 megfile/lib/s3_pipe_handler.py,sha256=38x8oPrxlXVWqMgDOqScPj0Pt2w2cQFSNoTK27EtBSw,3384
-megfile/lib/s3_prefetch_reader.py,sha256=9YBnxKeOZ5RPbUw9vZ_PpYZzevfhw-GLkw08HIy4KVk,15033
+megfile/lib/s3_prefetch_reader.py,sha256=uffgYsNy7sfiZdoZdY67LYiQiPagtohl4BeQ6jSTwEM,15113
 megfile/lib/s3_share_cache_reader.py,sha256=QyZvzVpTswgiXv-E8QhV_jFdQjCBxVcgbgybXo6d1cM,3771
 megfile/lib/shadow_handler.py,sha256=IbFyTw107t-yWH0cGrDjAJX-CS3xeEr77_PTGsnSgk4,2683
 megfile/lib/stdio_handler.py,sha256=QDWtcZxz-hzi-rqQUiSlR3NrihX1fjK_Rj9T2mdTFEg,2044
 megfile/lib/url.py,sha256=VbQLjo0s4AaV0iSk66BcjI68aUTcN9zBZ5x6-cM4Qvs,103
 megfile/utils/__init__.py,sha256=DEVSwUQ1-1rkHBIuXBxgEYiepq8W25JIWYQrC1gcFrc,9005
 megfile/utils/mutex.py,sha256=-2KH3bNovKRd9zvsXq9n3bWM7rQdoG9hO7tUPxVG_Po,2538
-megfile-2.2.0.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
-megfile-2.2.0.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
-megfile-2.2.0.dist-info/METADATA,sha256=5hJWi8RWnKtRNaoubN8ZWAtJ-x62XVGsDUEjN9XVI-4,10595
-megfile-2.2.0.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-megfile-2.2.0.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
-megfile-2.2.0.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
-megfile-2.2.0.dist-info/RECORD,,
+megfile-2.2.0.post1.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
+megfile-2.2.0.post1.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
+megfile-2.2.0.post1.dist-info/METADATA,sha256=WUowRbsO-dMPhEJYA1YQY0DNYRGc2jw6kdYRYQLnoBQ,10601
+megfile-2.2.0.post1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+megfile-2.2.0.post1.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
+megfile-2.2.0.post1.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
+megfile-2.2.0.post1.dist-info/RECORD,,
```

