# Comparing `tmp/skypilot-nightly-1.0.0.dev20230801.tar.gz` & `tmp/skypilot-nightly-1.0.0.dev20230802.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot-nightly-1.0.0.dev20230801.tar", last modified: Tue Aug  1 10:40:52 2023, max compression
+gzip compressed data, was "skypilot-nightly-1.0.0.dev20230802.tar", last modified: Wed Aug  2 10:40:55 2023, max compression
```

## Comparing `skypilot-nightly-1.0.0.dev20230801.tar` & `skypilot-nightly-1.0.0.dev20230802.tar`

### file list

```diff
@@ -1,228 +1,228 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/
--rw-r--r--   0 runner    (1001) docker     (123)    12170 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/LICENSE
--rw-r--r--   0 runner    (1001) docker     (123)      647 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (123)     9467 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     8684 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/README.md
--rw-r--r--   0 runner    (1001) docker     (123)      519 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (123)     8582 2023-08-01 10:40:44.000000 skypilot-nightly-1.0.0.dev20230801/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.565156 skypilot-nightly-1.0.0.dev20230801/sky/
--rw-r--r--   0 runner    (1001) docker     (123)     2105 2023-08-01 10:40:44.000000 skypilot-nightly-1.0.0.dev20230801/sky/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.565156 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2607 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/aws.py
--rw-r--r--   0 runner    (1001) docker     (123)      989 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/azure.py
--rw-r--r--   0 runner    (1001) docker     (123)     7726 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/cloudflare.py
--rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/docker.py
--rw-r--r--   0 runner    (1001) docker     (123)     2193 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/gcp.py
--rw-r--r--   0 runner    (1001) docker     (123)     3052 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/ibm.py
--rw-r--r--   0 runner    (1001) docker     (123)     2054 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/adaptors/oci.py
--rw-r--r--   0 runner    (1001) docker     (123)    15692 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/authentication.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.565156 skypilot-nightly-1.0.0.dev20230801/sky/backends/
--rw-r--r--   0 runner    (1001) docker     (123)      414 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5693 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/backend.py
--rw-r--r--   0 runner    (1001) docker     (123)   114556 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/backend_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)   202355 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 runner    (1001) docker     (123)     8321 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/docker_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    16448 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.565156 skypilot-nightly-1.0.0.dev20230801/sky/backends/monkey_patches/
--rw-r--r--   0 runner    (1001) docker     (123)     3410 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 runner    (1001) docker     (123)    24422 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/onprem_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     5903 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/backends/wheel_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.565156 skypilot-nightly-1.0.0.dev20230801/sky/benchmark/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/benchmark/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     8723 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/benchmark/benchmark_state.py
--rw-r--r--   0 runner    (1001) docker     (123)    24638 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3814 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/check.py
--rw-r--r--   0 runner    (1001) docker     (123)   169547 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/cli.py
--rw-r--r--   0 runner    (1001) docker     (123)     8822 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/cloud_stores.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.569156 skypilot-nightly-1.0.0.dev20230801/sky/clouds/
--rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    39211 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/aws.py
--rw-r--r--   0 runner    (1001) docker     (123)    25762 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/azure.py
--rw-r--r--   0 runner    (1001) docker     (123)    26795 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/cloud.py
--rw-r--r--   0 runner    (1001) docker     (123)    46013 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/gcp.py
--rw-r--r--   0 runner    (1001) docker     (123)    20117 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/ibm.py
--rw-r--r--   0 runner    (1001) docker     (123)    12001 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (123)     7875 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/local.py
--rw-r--r--   0 runner    (1001) docker     (123)    24269 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/oci.py
--rw-r--r--   0 runner    (1001) docker     (123)    14878 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/scp.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.569156 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/
--rw-r--r--   0 runner    (1001) docker     (123)    12366 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    11756 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     7050 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)    23189 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/common.py
--rw-r--r--   0 runner    (1001) docker     (123)     1500 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/config.py
--rw-r--r--   0 runner    (1001) docker     (123)      282 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/constants.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    20092 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 runner    (1001) docker     (123)     8679 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 runner    (1001) docker     (123)    18557 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 runner    (1001) docker     (123)     4198 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 runner    (1001) docker     (123)    21163 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     4656 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     5414 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     7582 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/oci_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)     5484 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/scp_catalog.py
--rw-r--r--   0 runner    (1001) docker     (123)    40110 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/core.py
--rw-r--r--   0 runner    (1001) docker     (123)     2502 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/dag.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/data/
--rw-r--r--   0 runner    (1001) docker     (123)      128 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     7384 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/data/data_transfer.py
--rw-r--r--   0 runner    (1001) docker     (123)     9596 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/data/data_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3251 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/data/mounting_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    90575 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/data/storage.py
--rw-r--r--   0 runner    (1001) docker     (123)     6807 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/data/storage_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     6111 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/exceptions.py
--rw-r--r--   0 runner    (1001) docker     (123)    41456 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/execution.py
--rw-r--r--   0 runner    (1001) docker     (123)    26274 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (123)    43765 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/optimizer.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/provision/
--rw-r--r--   0 runner    (1001) docker     (123)     1891 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/provision/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/provision/aws/
--rw-r--r--   0 runner    (1001) docker     (123)      171 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/provision/aws/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5433 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/provision/aws/instance.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/provision/gcp/
--rw-r--r--   0 runner    (1001) docker     (123)      112 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/provision/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5661 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/provision/gcp/instance.py
--rw-r--r--   0 runner    (1001) docker     (123)     8872 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/provision/gcp/instance_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    42860 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/resources.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/setup_files/
--rw-r--r--   0 runner    (1001) docker     (123)      647 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/setup_files/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (123)     8582 2023-08-01 10:40:44.000000 skypilot-nightly-1.0.0.dev20230801/sky/setup_files/setup.py
--rw-r--r--   0 runner    (1001) docker     (123)     3216 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/sky_logging.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/skylet/
--rw-r--r--   0 runner    (1001) docker     (123)    12568 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/LICENSE
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1203 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/attempt_skylet.py
--rw-r--r--   0 runner    (1001) docker     (123)     4378 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/autostop_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)     1887 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/configs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3101 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    10619 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/events.py
--rw-r--r--   0 runner    (1001) docker     (123)    32722 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/job_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)    19585 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/log_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.557155 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/
--rw-r--r--   0 runner    (1001) docker     (123)      110 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.573155 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/cloudwatch/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/cloudwatch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    32698 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)    52192 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    29406 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)     5917 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/
--rw-r--r--   0 runner    (1001) docker     (123)       97 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4344 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 runner    (1001) docker     (123)    10633 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 runner    (1001) docker     (123)     5020 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    17469 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/
--rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    34963 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/config.py
--rw-r--r--   0 runner    (1001) docker     (123)     4118 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    26192 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/node.py
--rw-r--r--   0 runner    (1001) docker     (123)    14292 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/
--rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    38280 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)     1290 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    34628 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 runner    (1001) docker     (123)      112 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     9766 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/lambda_cloud/lambda_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    13650 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/
--rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4234 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    20136 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)    17048 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/query_helper.py
--rw-r--r--   0 runner    (1001) docker     (123)      508 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/
--rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     4683 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/config.py
--rw-r--r--   0 runner    (1001) docker     (123)    22219 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/node_provider.py
--rw-r--r--   0 runner    (1001) docker     (123)    15481 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/scp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.577156 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/
--rw-r--r--   0 runner    (1001) docker     (123)     2904 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      294 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      391 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      224 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      345 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/job_head.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      528 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      658 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      289 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      565 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 runner    (1001) docker     (123)      788 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/skylet.py
--rw-r--r--   0 runner    (1001) docker     (123)     2649 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 runner    (1001) docker     (123)     5654 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/skypilot_config.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.581156 skypilot-nightly-1.0.0.dev20230801/sky/spot/
--rw-r--r--   0 runner    (1001) docker     (123)     1356 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      881 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    25102 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/controller.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.581156 skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/
--rw-r--r--   0 runner    (1001) docker     (123)     2294 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/dashboard.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.581156 skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/static/
--rw-r--r--   0 runner    (1001) docker     (123)    15086 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/static/favicon.ico
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.581156 skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/templates/
--rw-r--r--   0 runner    (1001) docker     (123)     6247 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/templates/index.html
--rw-r--r--   0 runner    (1001) docker     (123)    21311 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/recovery_strategy.py
--rw-r--r--   0 runner    (1001) docker     (123)    22484 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/spot_state.py
--rw-r--r--   0 runner    (1001) docker     (123)    34333 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/spot/spot_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     1457 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/status_lib.py
--rw-r--r--   0 runner    (1001) docker     (123)    38424 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/task.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.581156 skypilot-nightly-1.0.0.dev20230801/sky/templates/
--rw-r--r--   0 runner    (1001) docker     (123)    10893 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     8870 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)    11896 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)      505 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/gcp-tpu-create.sh.j2
--rw-r--r--   0 runner    (1001) docker     (123)      328 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/gcp-tpu-delete.sh.j2
--rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     6309 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/local-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     7593 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/oci-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     6178 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/scp-ray.yml.j2
--rw-r--r--   0 runner    (1001) docker     (123)     2185 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/templates/spot-controller.yaml.j2
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.581156 skypilot-nightly-1.0.0.dev20230801/sky/usage/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/usage/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)      633 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/usage/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)    17294 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/usage/usage_lib.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/sky/utils/
--rw-r--r--   0 runner    (1001) docker     (123)       25 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     2806 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/sky/utils/cli_utils/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    15219 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    14688 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/command_runner.py
--rw-r--r--   0 runner    (1001) docker     (123)    12077 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/common_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     2941 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/dag_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     2777 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/db_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/env_options.py
--rw-r--r--   0 runner    (1001) docker     (123)     4962 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/log_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     6927 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/schemas.py
--rw-r--r--   0 runner    (1001) docker     (123)     5774 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/subprocess_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     3965 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/timeline.py
--rw-r--r--   0 runner    (1001) docker     (123)     2737 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/tpu_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)     1125 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/ux_utils.py
--rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/sky/utils/validator.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     9467 2023-08-01 10:40:52.000000 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     5790 2023-08-01 10:40:52.000000 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-08-01 10:40:52.000000 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       36 2023-08-01 10:40:52.000000 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (123)     1448 2023-08-01 10:40:52.000000 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        4 2023-08-01 10:40:52.000000 skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-01 10:40:52.585156 skypilot-nightly-1.0.0.dev20230801/tests/
--rw-r--r--   0 runner    (1001) docker     (123)     4730 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_cli.py
--rw-r--r--   0 runner    (1001) docker     (123)     5061 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_config.py
--rw-r--r--   0 runner    (1001) docker     (123)      260 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_global_user_state.py
--rw-r--r--   0 runner    (1001) docker     (123)     5943 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_jobs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3620 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_list_accelerators.py
--rw-r--r--   0 runner    (1001) docker     (123)    14008 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_onprem.py
--rw-r--r--   0 runner    (1001) docker     (123)    22937 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_optimizer_dryruns.py
--rw-r--r--   0 runner    (1001) docker     (123)     4663 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_optimizer_random_dag.py
--rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_pycryptodome_version.py
--rw-r--r--   0 runner    (1001) docker     (123)   135092 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_smoke.py
--rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_spot.py
--rw-r--r--   0 runner    (1001) docker     (123)     4048 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_storage.py
--rw-r--r--   0 runner    (1001) docker     (123)     1070 2023-08-01 10:40:40.000000 skypilot-nightly-1.0.0.dev20230801/tests/test_wheels.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/
+-rw-r--r--   0 runner    (1001) docker     (123)    12170 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (123)      647 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (123)     9467 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     8684 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)      519 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (123)     8611 2023-08-02 10:40:46.000000 skypilot-nightly-1.0.0.dev20230802/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.760892 skypilot-nightly-1.0.0.dev20230802/sky/
+-rw-r--r--   0 runner    (1001) docker     (123)     2105 2023-08-02 10:40:46.000000 skypilot-nightly-1.0.0.dev20230802/sky/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.760892 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2607 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/aws.py
+-rw-r--r--   0 runner    (1001) docker     (123)      989 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/azure.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7726 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/cloudflare.py
+-rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/docker.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2193 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5442 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2054 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/adaptors/oci.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15692 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/authentication.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/backends/
+-rw-r--r--   0 runner    (1001) docker     (123)      414 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5693 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/backend.py
+-rw-r--r--   0 runner    (1001) docker     (123)   114861 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/backend_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   202769 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8321 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/docker_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    16448 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/backends/monkey_patches/
+-rw-r--r--   0 runner    (1001) docker     (123)     3410 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24422 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/onprem_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5903 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/backends/wheel_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8723 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24638 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3814 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/check.py
+-rw-r--r--   0 runner    (1001) docker     (123)   169547 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/cli.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11758 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/cloud_stores.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.764892 skypilot-nightly-1.0.0.dev20230802/sky/clouds/
+-rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    39211 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/aws.py
+-rw-r--r--   0 runner    (1001) docker     (123)    25872 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/azure.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26825 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/cloud.py
+-rw-r--r--   0 runner    (1001) docker     (123)    46013 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/gcp.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20574 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/ibm.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12103 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7989 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/local.py
+-rw-r--r--   0 runner    (1001) docker     (123)    24397 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/oci.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14994 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/scp.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/
+-rw-r--r--   0 runner    (1001) docker     (123)    12366 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    11756 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7050 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)    23189 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1500 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)      282 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/constants.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20092 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 runner    (1001) docker     (123)     8679 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 runner    (1001) docker     (123)    18557 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4198 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21163 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4656 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5414 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7582 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5484 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 runner    (1001) docker     (123)    40110 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2502 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/dag.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/data/
+-rw-r--r--   0 runner    (1001) docker     (123)      128 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7384 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/data_transfer.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21399 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/data_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3251 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/mounting_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)   110767 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6807 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/data/storage_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6111 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/exceptions.py
+-rw-r--r--   0 runner    (1001) docker     (123)    41456 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/execution.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26274 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)    43765 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/optimizer.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/provision/
+-rw-r--r--   0 runner    (1001) docker     (123)     2111 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.768892 skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/
+-rw-r--r--   0 runner    (1001) docker     (123)      186 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6744 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/instance.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/
+-rw-r--r--   0 runner    (1001) docker     (123)      127 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6361 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9598 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    46508 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/resources.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/setup_files/
+-rw-r--r--   0 runner    (1001) docker     (123)      647 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (123)     8611 2023-08-02 10:40:46.000000 skypilot-nightly-1.0.0.dev20230802/sky/setup_files/setup.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3216 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/sky_logging.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/
+-rw-r--r--   0 runner    (1001) docker     (123)    12568 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1203 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4378 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/autostop_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1887 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/configs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3101 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10619 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/events.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32722 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/job_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19585 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/log_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.756892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/
+-rw-r--r--   0 runner    (1001) docker     (123)      110 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    32698 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)    53219 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    29406 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5917 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.772892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/
+-rw-r--r--   0 runner    (1001) docker     (123)       97 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4344 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 runner    (1001) docker     (123)    10633 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 runner    (1001) docker     (123)     5020 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17469 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/
+-rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    37475 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4118 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26192 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14292 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/
+-rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    38280 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1292 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    34628 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 runner    (1001) docker     (123)      112 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9766 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/lambda_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    13650 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/
+-rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4234 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    20136 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17048 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 runner    (1001) docker     (123)      508 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.776892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/
+-rw-r--r--   0 runner    (1001) docker     (123)       91 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4683 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22219 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/node_provider.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15481 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/scp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/
+-rw-r--r--   0 runner    (1001) docker     (123)     2904 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      294 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      391 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      224 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      345 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/job_head.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      528 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      658 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      289 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      565 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 runner    (1001) docker     (123)      788 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/skylet.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2649 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5654 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/skypilot_config.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/
+-rw-r--r--   0 runner    (1001) docker     (123)     1356 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      881 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    26791 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/controller.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/
+-rw-r--r--   0 runner    (1001) docker     (123)     2294 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/static/
+-rw-r--r--   0 runner    (1001) docker     (123)    15086 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.780892 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)     6247 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 runner    (1001) docker     (123)    21311 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/recovery_strategy.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22484 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)    34333 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1457 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/status_lib.py
+-rw-r--r--   0 runner    (1001) docker     (123)    39296 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/task.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/templates/
+-rw-r--r--   0 runner    (1001) docker     (123)    10985 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     8870 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)    11988 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      505 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-tpu-create.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (123)      328 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-tpu-delete.sh.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     6309 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     1176 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     7593 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     6178 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 runner    (1001) docker     (123)     2185 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/templates/spot-controller.yaml.j2
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/usage/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/usage/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)      633 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/usage/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17294 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/usage/usage_lib.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/utils/
+-rw-r--r--   0 runner    (1001) docker     (123)       25 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2806 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15219 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14688 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/command_runner.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12344 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/common_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2941 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/dag_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2777 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/db_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)      852 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/env_options.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4962 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/log_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7208 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/schemas.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5774 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/subprocess_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3965 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/timeline.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2737 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/tpu_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1125 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/ux_utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)      701 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/sky/utils/validator.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.784892 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     9467 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     5790 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       36 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     1472 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        4 2023-08-02 10:40:55.000000 skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-08-02 10:40:55.788892 skypilot-nightly-1.0.0.dev20230802/tests/
+-rw-r--r--   0 runner    (1001) docker     (123)     4730 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_cli.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5061 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_config.py
+-rw-r--r--   0 runner    (1001) docker     (123)      260 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_global_user_state.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5943 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_jobs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3620 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_list_accelerators.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14008 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_onprem.py
+-rw-r--r--   0 runner    (1001) docker     (123)    22937 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4663 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 runner    (1001) docker     (123)       94 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_pycryptodome_version.py
+-rw-r--r--   0 runner    (1001) docker     (123)   140883 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_smoke.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7215 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_spot.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4048 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_storage.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1070 2023-08-02 10:40:43.000000 skypilot-nightly-1.0.0.dev20230802/tests/test_wheels.py
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/LICENSE` & `skypilot-nightly-1.0.0.dev20230802/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20230802/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/PKG-INFO` & `skypilot-nightly-1.0.0.dev20230802/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20230801
+Version: 1.0.0.dev20230802
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230801
+Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230802
 Summary: SkyPilot: An intercloud broker for the clouds Author: SkyPilot Team
 License: Apache 2.0 Project-URL: Homepage, https://github.com/skypilot-org/
 skypilot Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
 Classifier: Programming Language :: Python :: 3.7 Classifier: Programming
 Language :: Python :: 3.8 Classifier: Programming Language :: Python :: 3.9
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/README.md` & `skypilot-nightly-1.0.0.dev20230802/README.md`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/pyproject.toml` & `skypilot-nightly-1.0.0.dev20230802/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/setup.py` & `skypilot-nightly-1.0.0.dev20230802/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -145,15 +145,17 @@
     # We need azure-identity>=1.13.0 to enable the customization of the
     # timeout of AzureCliCredential.
     'azure': [
         'azure-cli>=2.31.0', 'azure-core', 'azure-identity>=1.13.0',
         'azure-mgmt-network'
     ],
     'gcp': ['google-api-python-client', 'google-cloud-storage'],
-    'ibm': ['ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services'],
+    'ibm': [
+        'ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services', 'ibm-cos-sdk'
+    ],
     'docker': ['docker'],
     'lambda': [],
     'cloudflare': aws_dependencies,
     'scp': [],
     'oci': ['oci'],
 }
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/__init__.py` & `skypilot-nightly-1.0.0.dev20230802/sky/__init__.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 """The SkyPilot package."""
 import os
 
 # Replaced with the current commit when building the wheels.
-__commit__ = 'c2721459ba797922fc1dbdecbcdfa2fa198b6ca4'
-__version__ = '1.0.0-dev20230801'
+__commit__ = '4d51a89d6c08c7ddf972bdfd51a9f18485842caa'
+__version__ = '1.0.0-dev20230802'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 # Keep this order to avoid cyclic imports
 from sky import backends
 from sky import benchmark
 from sky import clouds
 from sky.clouds.service_catalog import list_accelerators
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/adaptors/aws.py` & `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/adaptors/azure.py` & `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/adaptors/cloudflare.py` & `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/adaptors/docker.py` & `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/docker.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/adaptors/gcp.py` & `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/adaptors/oci.py` & `skypilot-nightly-1.0.0.dev20230802/sky/adaptors/oci.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/authentication.py` & `skypilot-nightly-1.0.0.dev20230802/sky/authentication.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/backend.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/backend_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/backend_utils.py`

 * *Files 0% similar despite different names*

```diff
@@ -795,14 +795,15 @@
 
 
 # TODO: too many things happening here - leaky abstraction. Refactor.
 @timeline.event
 def write_cluster_config(
         to_provision: 'resources.Resources',
         num_nodes: int,
+        ports: Optional[List[Union[int, str]]],
         cluster_config_template: str,
         cluster_name: str,
         local_wheel_path: pathlib.Path,
         wheel_hash: str,
         region: Optional[clouds.Region] = None,
         zones: Optional[List[clouds.Zone]] = None,
         dryrun: bool = False,
@@ -893,40 +894,45 @@
 
     # Dump the Ray ports to a file for Ray job submission
     dump_port_command = (
         f'python -c \'import json, os; json.dump({constants.SKY_REMOTE_RAY_PORT_DICT_STR}, '
         f'open(os.path.expanduser("{constants.SKY_REMOTE_RAY_PORT_FILE}"), "w"))\''
     )
 
+    # Only using new security group names for clusters with ports specified.
+    default_aws_sg_name = f'sky-sg-{common_utils.user_and_hostname_hash()}'
+    if ports is not None:
+        default_aws_sg_name += f'-{common_utils.truncate_and_hash_cluster_name(cluster_name)}'
+
     # Use a tmp file path to avoid incomplete YAML file being re-used in the
     # future.
     tmp_yaml_path = yaml_path + '.tmp'
     fill_template(
         cluster_config_template,
         dict(
             resources_vars,
             **{
                 'cluster_name': cluster_name,
                 'num_nodes': num_nodes,
+                'ports': ports,
                 'disk_size': to_provision.disk_size,
                 # If the current code is run by controller, propagate the real
                 # calling user which should've been passed in as the
                 # SKYPILOT_USER env var (see spot-controller.yaml.j2).
                 'user': get_cleaned_username(os.environ.get(
                     'SKYPILOT_USER', '')),
 
                 # AWS only:
                 # Temporary measure, as deleting per-cluster SGs is too slow.
                 # See https://github.com/skypilot-org/skypilot/pull/742.
                 # Generate the name of the security group we're looking for.
                 # (username, last 4 chars of hash of hostname): for uniquefying
                 # users on shared-account scenarios.
                 'security_group': skypilot_config.get_nested(
-                    ('aws', 'security_group_name'),
-                    f'sky-sg-{common_utils.user_and_hostname_hash()}'),
+                    ('aws', 'security_group_name'), default_aws_sg_name),
                 'vpc_name': skypilot_config.get_nested(('aws', 'vpc_name'),
                                                        None),
                 'use_internal_ips': skypilot_config.get_nested(
                     ('aws', 'use_internal_ips'), False),
                 # Not exactly AWS only, but we only test it's supported on AWS
                 # for now:
                 'ssh_proxy_command': ssh_proxy_command,
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/cloud_vm_ray_backend.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/cloud_vm_ray_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -1451,14 +1451,15 @@
             else:
                 zone_str = ','.join(z.name for z in zones)
                 zone_str = f' ({zone_str})'
             try:
                 config_dict = backend_utils.write_cluster_config(
                     to_provision,
                     num_nodes,
+                    to_provision.ports,
                     _get_cluster_config_template(to_provision.cloud),
                     cluster_name,
                     self._local_wheel_path,
                     self._wheel_hash,
                     region=region,
                     zones=zones,
                     dryrun=dryrun,
@@ -3476,15 +3477,15 @@
                     ':', 1)[-1]
                 vpc_found = True
             except Exception:
                 logger.critical('failed to locate vpc for ibm cloud')
                 returncode = -1
 
             if vpc_found:
-                # # pylint: disable=line-too-long E1136
+                # pylint: disable=line-too-long E1136
                 # Delete VPC and it's associated resources
                 vpc_provider = IBMVPCProvider(
                     config_provider['resource_group_id'], region, cluster_name)
                 vpc_provider.delete_vpc(vpc_id, region)
                 # successfully removed cluster as no exception was raised
                 returncode = 0
 
@@ -3643,14 +3644,21 @@
                 cluster_cloud.delete_image(image_id,
                                            handle.launched_resources.region)
             except exceptions.CommandError as e:
                 logger.warning(
                     f'Failed to delete cloned image {image_id}. Please '
                     'remove it manually to avoid image leakage. Details: '
                     f'{common_utils.format_exception(e, use_bracket=True)}')
+        if terminate:
+            cloud = handle.launched_resources.cloud
+            config = common_utils.read_yaml(handle.cluster_yaml)
+            if isinstance(cloud, (clouds.AWS, clouds.GCP)):
+                # Clean up AWS SGs
+                provision_lib.cleanup_ports(repr(cloud), handle.cluster_name,
+                                            config['provider'])
 
         # The cluster file must exist because the cluster_yaml will only
         # be removed after the cluster entry in the database is removed.
         config = common_utils.read_yaml(handle.cluster_yaml)
         auth_config = config['auth']
         backend_utils.SSHConfigHelper.remove_cluster(handle.cluster_name,
                                                      handle.head_ip,
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/docker_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/local_docker_backend.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/onprem_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/onprem_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/backends/wheel_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/benchmark/benchmark_state.py` & `skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/benchmark/benchmark_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/benchmark/benchmark_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/check.py` & `skypilot-nightly-1.0.0.dev20230802/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/cli.py` & `skypilot-nightly-1.0.0.dev20230802/sky/cli.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/__init__.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/aws.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/azure.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/azure.py`

 * *Files 0% similar despite different names*

```diff
@@ -60,14 +60,15 @@
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return {
             clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER: f'Migrating disk is not supported in {cls._REPR}.',
             # TODO(zhwu): our azure subscription offer ID does not support spot.
             # Need to support it.
             clouds.CloudImplementationFeatures.SPOT_INSTANCE: f'Spot instances are not supported in {cls._REPR}.',
+            clouds.CloudImplementationFeatures.OPEN_PORTS: f'Opening ports is not supported in {cls._REPR}.',
         }
 
     @classmethod
     def _max_cluster_name_length(cls) -> int:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
     def instance_type_to_hourly_cost(self,
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/cloud.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/cloud.py`

 * *Files 0% similar despite different names*

```diff
@@ -26,14 +26,15 @@
     """
     STOP = 'stop'
     AUTOSTOP = 'autostop'
     MULTI_NODE = 'multi-node'
     CLONE_DISK_FROM_CLUSTER = 'clone_disk_from_cluster'
     SPOT_INSTANCE = 'spot_instance'
     CUSTOM_DISK_TIER = 'custom_disk_tier'
+    OPEN_PORTS = 'open_ports'
 
 
 class Region(collections.namedtuple('Region', ['name'])):
     """A region."""
     name: str
     zones: Optional[List['Zone']] = None
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/gcp.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/ibm.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/ibm.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 """IBM Web Services."""
+import colorama
 import os
-import yaml
 import json
 import typing
 from typing import Any, Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
 from sky import sky_logging
 from sky import status_lib
@@ -36,14 +36,16 @@
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return {
             clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
                 (f'Migrating disk is not supported in {cls._REPR}.'),
             clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER:
                 (f'Custom disk tier is not supported in {cls._REPR}.'),
+            clouds.CloudImplementationFeatures.OPEN_PORTS:
+                (f'Opening ports is not supported in {cls._REPR}.'),
         }
 
     @classmethod
     def _max_cluster_name_length(cls) -> Optional[int]:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
     @classmethod
@@ -370,30 +372,40 @@
                     'metadata:"minimum_provisioned_size". '
                     'Image may be in status: Failed/Pending') from None
         return image_size
 
     @classmethod
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
         """Checks if the user has access credentials to this cloud."""
-        # IBM-TODO - create a configuration script.
+
         required_fields = ['iam_api_key', 'resource_group_id']
+        ibm_cos_fields = ['access_key_id', 'secret_access_key']
         help_str = ('    Store your API key and Resource Group id '
                     f'in {CREDENTIAL_FILE} in the following format:\n'
                     '      iam_api_key: <IAM_API_KEY>\n'
                     '      resource_group_id: <RESOURCE_GROUP_ID>')
+        base_config = ibm.read_credential_file()
 
-        base_config = _read_credential_file()
         if not base_config:
             return (False, 'Missing credential file at '
                     f'{os.path.expanduser(CREDENTIAL_FILE)}.\n' + help_str)
-
-        for field in required_fields:
-            if field not in base_config:
-                return (False, f'Missing field "{field}" in '
-                        f'{os.path.expanduser(CREDENTIAL_FILE)}.\n' + help_str)
+        # TODO(IBM) update when issue #1943 is resolved.
+        if set(ibm_cos_fields) - set(base_config):
+            logger.debug(f'{colorama.Fore.RED}IBM Storage is missing the '
+                         'following fields in '
+                         f'{os.path.expanduser(CREDENTIAL_FILE)} to function: '
+                         f"""{", ".join(list(
+                            set(ibm_cos_fields) - set(base_config)))}"""
+                         f'{colorama.Style.RESET_ALL}')
+
+        if set(required_fields) - set(base_config):
+            return (
+                False, f'Missing field(s): '
+                f'{", ".join(list(set(required_fields) - set(base_config)))} '
+                f'in {os.path.expanduser(CREDENTIAL_FILE)}.\n{help_str}')
 
         # verifies ability of user to create a client,
         # e.g. bad API KEY.
         try:
             ibm.client()
             return True, None
         # pylint: disable=W0703
@@ -464,24 +476,15 @@
         vpc_id = vpcs_filtered_by_tags_and_region[0]['crn'].rsplit(':', 1)[-1]
         instances = client.list_instances(
             vpc_id=vpc_id).get_result()['instances']
 
         return [status_map[instance['status']] for instance in instances]
 
 
-def _read_credential_file():
-    try:
-        with open(os.path.expanduser(CREDENTIAL_FILE), 'r',
-                  encoding='utf-8') as f:
-            return yaml.safe_load(f)
-    except FileNotFoundError:
-        return False
-
-
 def get_cred_file_field(field, default_val=None) -> str:
     """returns a the value of a field from the user's
      credentials file if exists, else default_val"""
-    base_config = _read_credential_file()
+    base_config = ibm.read_credential_file()
     if not base_config:
         raise FileNotFoundError('Missing '
                                 f'credential file at {CREDENTIAL_FILE}')
     return base_config.get(field, default_val)
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/lambda_cloud.py`

 * *Files 2% similar despite different names*

```diff
@@ -35,14 +35,15 @@
     # STOP/AUTOSTOP: The Lambda cloud provider does not support stopping VMs.
     _CLOUD_UNSUPPORTED_FEATURES = {
         clouds.CloudImplementationFeatures.STOP: 'Lambda cloud does not support stopping VMs.',
         clouds.CloudImplementationFeatures.AUTOSTOP: 'Lambda cloud does not support stopping VMs.',
         clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER: f'Migrating disk is not supported in {_REPR}.',
         clouds.CloudImplementationFeatures.SPOT_INSTANCE: f'Spot instances are not supported in {_REPR}.',
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER: f'Custom disk tiers are not supported in {_REPR}.',
+        clouds.CloudImplementationFeatures.OPEN_PORTS: f'Opening ports is not supported in {_REPR}.',
     }
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return cls._CLOUD_UNSUPPORTED_FEATURES
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/local.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/local.py`

 * *Files 2% similar despite different names*

```diff
@@ -30,14 +30,16 @@
     _CLOUD_UNSUPPORTED_FEATURES = {
         clouds.CloudImplementationFeatures.STOP:
             ('Local cloud does not support stopping instances.'),
         clouds.CloudImplementationFeatures.AUTOSTOP:
             ('Local cloud does not support stopping instances.'),
         clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
             ('Migrating disk is not supported for Local.'),
+        clouds.CloudImplementationFeatures.OPEN_PORTS:
+            ('Opening ports is not supported for Local.'),
     }
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return cls._CLOUD_UNSUPPORTED_FEATURES
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/oci.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/oci.py`

 * *Files 1% similar despite different names*

```diff
@@ -44,14 +44,16 @@
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return {
             clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
                 (f'Migrating disk is not supported in {cls._REPR}.'),
+            clouds.CloudImplementationFeatures.OPEN_PORTS:
+                (f'Opening ports is not supported in {cls._REPR}.'),
         }
 
     @classmethod
     def _max_cluster_name_length(cls) -> Optional[int]:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
     @classmethod
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/scp.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/scp.py`

 * *Files 2% similar despite different names*

```diff
@@ -45,14 +45,16 @@
         clouds.CloudImplementationFeatures.MULTI_NODE: _MULTI_NODE,
         clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
             (f'Migrating disk is not supported in {_REPR}.'),
         clouds.CloudImplementationFeatures.SPOT_INSTANCE:
             (f'Spot instances are not supported in {_REPR}.'),
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER:
             (f'Custom disk tiers are not supported in {_REPR}.'),
+        clouds.CloudImplementationFeatures.OPEN_PORTS:
+            (f'Opening ports is not supported in {_REPR}.'),
     }
 
     _INDENT_PREFIX = '    '
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/__init__.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/aws_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/aws_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/azure_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/azure_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/common.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/common.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/oci_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/oci_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/clouds/service_catalog/scp_catalog.py` & `skypilot-nightly-1.0.0.dev20230802/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/core.py` & `skypilot-nightly-1.0.0.dev20230802/sky/core.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/dag.py` & `skypilot-nightly-1.0.0.dev20230802/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/data/data_transfer.py` & `skypilot-nightly-1.0.0.dev20230802/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/data/mounting_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/data/storage.py` & `skypilot-nightly-1.0.0.dev20230802/sky/data/storage.py`

 * *Files 10% similar despite different names*

```diff
@@ -11,19 +11,21 @@
 import colorama
 
 from sky import check
 from sky import clouds
 from sky.adaptors import aws
 from sky.adaptors import gcp
 from sky.adaptors import cloudflare
+from sky.adaptors import ibm
 from sky.backends import backend_utils
 from sky.utils import schemas
 from sky.data import data_transfer
 from sky.data import data_utils
 from sky.data import mounting_utils
+from sky.data.data_utils import Rclone
 from sky.data import storage_utils
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import status_lib
 from sky.utils import log_utils
 from sky.utils import ux_utils
@@ -40,15 +42,17 @@
 SourceType = Union[Path, List[Path]]
 
 # Clouds with object storage implemented in this module. Azure Blob
 # Storage isn't supported yet (even though Azure is).
 # TODO(Doyoung): need to add clouds.CLOUDFLARE() to support
 # R2 to be an option as preferred store type
 STORE_ENABLED_CLOUDS: List[str] = [
-    str(clouds.AWS()), str(clouds.GCP()), cloudflare.NAME
+    str(clouds.AWS()),
+    str(clouds.GCP()),
+    str(clouds.IBM()), cloudflare.NAME
 ]
 
 # Maximum number of concurrent rsync upload processes
 _MAX_CONCURRENT_UPLOADS = 32
 
 _BUCKET_FAIL_TO_CONNECT_MESSAGE = (
     'Failed to access existing bucket {name!r}. '
@@ -78,34 +82,39 @@
 
 class StoreType(enum.Enum):
     """Enum for the different types of stores."""
     S3 = 'S3'
     GCS = 'GCS'
     AZURE = 'AZURE'
     R2 = 'R2'
+    IBM = 'IBM'
 
     @classmethod
     def from_cloud(cls, cloud: clouds.Cloud) -> 'StoreType':
         if isinstance(cloud, clouds.AWS):
             return StoreType.S3
         elif isinstance(cloud, clouds.GCP):
             return StoreType.GCS
         elif isinstance(cloud, clouds.Azure):
             return StoreType.AZURE
+        elif isinstance(cloud, clouds.IBM):
+            return StoreType.IBM
 
         raise ValueError(f'Unsupported cloud for StoreType: {cloud}')
 
     @classmethod
     def from_store(cls, store: 'AbstractStore') -> 'StoreType':
         if isinstance(store, S3Store):
             return StoreType.S3
         elif isinstance(store, GcsStore):
             return StoreType.GCS
         elif isinstance(store, R2Store):
             return StoreType.R2
+        elif isinstance(store, IBMCosStore):
+            return StoreType.IBM
         else:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(f'Unknown store type: {store}')
 
 
 class StorageMode(enum.Enum):
     MOUNT = 'MOUNT'
@@ -113,14 +122,16 @@
 
 
 def get_storetype_from_cloud(cloud: clouds.Cloud) -> StoreType:
     if isinstance(cloud, clouds.AWS):
         return StoreType.S3
     elif isinstance(cloud, clouds.GCP):
         return StoreType.GCS
+    elif isinstance(cloud, clouds.IBM):
+        return StoreType.IBM
     elif isinstance(cloud, clouds.Azure):
         with ux_utils.print_exception_no_traceback():
             raise ValueError('Azure Blob Storage is not supported yet.')
     elif isinstance(cloud, clouds.Lambda):
         with ux_utils.print_exception_no_traceback():
             raise ValueError('Lambda Cloud does not provide cloud storage.')
     elif isinstance(cloud, clouds.SCP):
@@ -135,14 +146,16 @@
     if storetype == StoreType.S3:
         return 's3://'
     elif storetype == StoreType.GCS:
         return 'gs://'
     # R2 storages use 's3://' as a prefix for various aws cli commands
     elif storetype == StoreType.R2:
         return 's3://'
+    elif storetype == StoreType.IBM:
+        return 'cos://'
     elif storetype == StoreType.AZURE:
         with ux_utils.print_exception_no_traceback():
             raise ValueError('Azure Blob Storage is not supported yet.')
     else:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'Unknown store type: {storetype}')
 
@@ -459,14 +472,19 @@
                         source=self.source,
                         sync_on_reconstruction=self.sync_on_reconstruction)
                 elif s_type == StoreType.R2:
                     store = R2Store.from_metadata(
                         s_metadata,
                         source=self.source,
                         sync_on_reconstruction=self.sync_on_reconstruction)
+                elif s_type == StoreType.IBM:
+                    store = IBMCosStore.from_metadata(
+                        s_metadata,
+                        source=self.source,
+                        sync_on_reconstruction=self.sync_on_reconstruction)
                 else:
                     with ux_utils.print_exception_no_traceback():
                         raise ValueError(f'Unknown store type: {s_type}')
 
                 self._add_store(store, is_reconstructed=True)
 
             # TODO(romilb): This logic should likely be in add_store to move
@@ -497,14 +515,16 @@
                 if isinstance(self.source, str):
                     if self.source.startswith('s3://'):
                         self.add_store(StoreType.S3)
                     elif self.source.startswith('gs://'):
                         self.add_store(StoreType.GCS)
                     elif self.source.startswith('r2://'):
                         self.add_store(StoreType.R2)
+                    elif self.source.startswith('cos://'):
+                        self.add_store(StoreType.IBM)
 
     @staticmethod
     def _validate_source(
             source: SourceType, mode: StorageMode,
             sync_on_reconstruction: bool) -> Tuple[SourceType, bool]:
         """Validates the source path.
 
@@ -577,32 +597,38 @@
                             'that the file will be uploaded to the root of the '
                             'bucket and will appear at <destination_path>/'
                             f'{os.path.basename(source)}. Alternatively, you '
                             'can directly upload the file to the VM without '
                             'using a bucket by writing <destination_path>: '
                             f'{source} in the file_mounts section of your YAML')
                 is_local_source = True
-            elif split_path.scheme in ['s3', 'gs', 'r2']:
+            elif split_path.scheme in ['s3', 'gs', 'r2', 'cos']:
                 is_local_source = False
                 # Storage mounting does not support mounting specific files from
                 # cloud store - ensure path points to only a directory
                 if mode == StorageMode.MOUNT:
-                    if split_path.path.strip('/') != '':
+                    if ((not split_path.scheme == 'cos' and
+                         split_path.path.strip('/') != '') or
+                        (split_path.scheme == 'cos' and
+                         not re.match(r'^/[-\w]+(/\s*)?$', split_path.path))):
+                        # regex allows split_path.path to include /bucket
+                        # or /bucket/optional_whitespaces while considering
+                        # cos URI's regions (cos://region/bucket_name)
                         with ux_utils.print_exception_no_traceback():
                             raise exceptions.StorageModeError(
                                 'MOUNT mode does not support'
                                 ' mounting specific files from cloud'
                                 ' storage. Please use COPY mode or'
                                 ' specify only the bucket name as'
                                 ' the source.')
             else:
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.StorageSourceError(
                         f'Supported paths: local, s3://, gs://, '
-                        f'r2://. Got: {source}')
+                        f'r2://, cos://. Got: {source}')
         return source, is_local_source
 
     def _validate_storage_spec(self, name: Optional[str]) -> None:
         """
         Validates the storage spec and updates local fields if necessary.
         """
 
@@ -611,15 +637,15 @@
 
             Checks if the name starts the s3, gcs or r2 prefix and raise error
             if it does. Store specific validation checks (e.g., S3 specific
             rules) happen in the corresponding store class.
             """
             prefix = name.split('://')[0]
             prefix = prefix.lower()
-            if prefix in ['s3', 'gs', 'r2']:
+            if prefix in ['s3', 'gs', 'r2', 'cos']:
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.StorageNameError(
                         'Prefix detected: `name` cannot start with '
                         f'{prefix}://. If you are trying to use an existing '
                         'bucket created outside of SkyPilot, please specify it '
                         'using the `source` field (e.g. '
                         '`source: s3://mybucket/`). If you are trying to '
@@ -659,15 +685,19 @@
                     with ux_utils.print_exception_no_traceback():
                         raise exceptions.StorageNameError(
                             'Storage name must be specified if the source is '
                             'local.')
                 else:
                     assert isinstance(source, str)
                     # Set name to source bucket name and continue
-                    name = urllib.parse.urlsplit(source).netloc
+                    if source.startswith('cos://'):
+                        # cos url requires custom parsing
+                        name = data_utils.split_cos_path(source)[0]
+                    else:
+                        name = urllib.parse.urlsplit(source).netloc
                     assert name is not None, source
                     self.name = name
                     return
             else:
                 if is_local_source:
                     # If name is specified and source is local, upload to bucket
                     assert name is not None, source
@@ -688,15 +718,15 @@
     def add_store(self, store_type: Union[str, StoreType]) -> AbstractStore:
         """Initializes and adds a new store to the storage.
 
         Invoked by the optimizer after it has selected a store to
         add it to Storage.
 
         Args:
-          store_type: StoreType; Type of the storage [S3, GCS, AZURE, R2]
+          store_type: StoreType; Type of the storage [S3, GCS, AZURE, R2, IBM]
         """
         if isinstance(store_type, str):
             store_type = StoreType(store_type)
 
         if store_type in self.stores:
             logger.info(f'Storage type {store_type} already exists.')
             return self.stores[store_type]
@@ -704,14 +734,16 @@
         store_cls: Type[AbstractStore]
         if store_type == StoreType.S3:
             store_cls = S3Store
         elif store_type == StoreType.GCS:
             store_cls = GcsStore
         elif store_type == StoreType.R2:
             store_cls = R2Store
+        elif store_type == StoreType.IBM:
+            store_cls = IBMCosStore
         else:
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.StorageSpecError(
                     f'{store_type} not supported as a Store.')
 
         # Initialize store object and get/create bucket
         try:
@@ -926,14 +958,21 @@
             elif self.source.startswith('r2://'):
                 assert self.name == data_utils.split_r2_path(self.source)[0], (
                     'R2 Bucket is specified as path, the name should be '
                     'the same as R2 bucket.')
                 assert data_utils.verify_r2_bucket(self.name), (
                     f'Source specified as {self.source}, a R2 bucket. ',
                     'R2 Bucket should exist.')
+            elif self.source.startswith('cos://'):
+                assert self.name == data_utils.split_cos_path(self.source)[0], (
+                    'COS Bucket is specified as path, the name should be '
+                    'the same as COS bucket.')
+                assert data_utils.verify_ibm_cos_bucket(self.name), (
+                    f'Source specified as {self.source}, a COS bucket. ',
+                    'COS Bucket should exist.')
         # Validate name
         self.name = self.validate_name(self.name)
 
         # Check if the storage is enabled
         if not _is_storage_cloud_enabled(str(clouds.AWS())):
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.ResourcesUnavailableError(
@@ -1316,14 +1355,23 @@
                     assert self.name == data_utils.split_r2_path(
                         self.source
                     )[0], ('R2 Bucket is specified as path, the name should be '
                            'the same as R2 bucket.')
                     assert data_utils.verify_r2_bucket(self.name), (
                         f'Source specified as {self.source}, a R2 bucket. ',
                         'R2 Bucket should exist.')
+                elif self.source.startswith('cos://'):
+                    assert self.name == data_utils.split_cos_path(
+                        self.source
+                    )[0], (
+                        'COS Bucket is specified as path, the name should be '
+                        'the same as COS bucket.')
+                    assert data_utils.verify_ibm_cos_bucket(self.name), (
+                        f'Source specified as {self.source}, a COS bucket. ',
+                        'COS Bucket should exist.')
         # Validate name
         self.name = self.validate_name(self.name)
         # Check if the storage is enabled
         if not _is_storage_cloud_enabled(str(clouds.GCP())):
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.ResourcesUnavailableError(
                     'Storage \'store: gcs\' specified, but '
@@ -1740,14 +1788,21 @@
                 assert data_utils.verify_gcs_bucket(self.name), (
                     f'Source specified as {self.source}, a GCS bucket. ',
                     'GCS Bucket should exist.')
             elif self.source.startswith('r2://'):
                 assert self.name == data_utils.split_r2_path(self.source)[0], (
                     'R2 Bucket is specified as path, the name should be '
                     'the same as R2 bucket.')
+            elif self.source.startswith('cos://'):
+                assert self.name == data_utils.split_cos_path(self.source)[0], (
+                    'IBM COS Bucket is specified as path, the name should be '
+                    'the same as COS bucket.')
+                assert data_utils.verify_ibm_cos_bucket(self.name), (
+                    f'Source specified as {self.source}, a COS bucket. ',
+                    'COS Bucket should exist.')
         # Validate name
         self.name = S3Store.validate_name(self.name)
         # Check if the storage is enabled
         if not _is_storage_cloud_enabled(cloudflare.NAME):
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.ResourcesUnavailableError(
                     'Storage \'store: r2\' specified, but ' \
@@ -2053,7 +2108,393 @@
                     raise exceptions.StorageBucketDeleteError(
                         f'Failed to delete R2 bucket {bucket_name}.')
 
         # Wait until bucket deletion propagates on AWS servers
         while data_utils.verify_r2_bucket(bucket_name):
             time.sleep(0.1)
         return True
+
+
+class IBMCosStore(AbstractStore):
+    """IBMCosStore inherits from Storage Object and represents the backend
+    for COS buckets.
+    """
+    _ACCESS_DENIED_MESSAGE = 'Access Denied'
+
+    def __init__(self,
+                 name: str,
+                 source: str,
+                 region: Optional[str] = 'us-east',
+                 is_sky_managed: Optional[bool] = None,
+                 sync_on_reconstruction: bool = True):
+        self.client: 'storage.Client'
+        self.bucket: 'StorageHandle'
+        super().__init__(name, source, region, is_sky_managed,
+                         sync_on_reconstruction)
+        self.bucket_rclone_profile = \
+          Rclone.generate_rclone_bucket_profile_name(
+            self.name, Rclone.RcloneClouds.IBM)
+
+    def _validate(self):
+        if self.source is not None and isinstance(self.source, str):
+            if self.source.startswith('s3://'):
+                assert self.name == data_utils.split_s3_path(self.source)[0], (
+                    'S3 Bucket is specified as path, the name should be the'
+                    ' same as S3 bucket.')
+                assert data_utils.verify_s3_bucket(self.name), (
+                    f'Source specified as {self.source}, a S3 bucket. ',
+                    'S3 Bucket should exist.')
+            elif self.source.startswith('gs://'):
+                assert self.name == data_utils.split_gcs_path(self.source)[0], (
+                    'GCS Bucket is specified as path, the name should be '
+                    'the same as GCS bucket.')
+                assert data_utils.verify_gcs_bucket(self.name), (
+                    f'Source specified as {self.source}, a GCS bucket. ',
+                    'GCS Bucket should exist.')
+            elif self.source.startswith('r2://'):
+                assert self.name == data_utils.split_r2_path(self.source)[0], (
+                    'R2 Bucket is specified as path, the name should be '
+                    'the same as R2 bucket.')
+                assert data_utils.verify_r2_bucket(self.name), (
+                    f'Source specified as {self.source}, a R2 bucket. ',
+                    'R2 Bucket should exist.')
+            elif self.source.startswith('cos://'):
+                assert self.name == data_utils.split_cos_path(self.source)[0], (
+                    'COS Bucket is specified as path, the name should be '
+                    'the same as COS bucket.')
+        # Validate name
+        self.name = IBMCosStore.validate_name(self.name)
+
+    @classmethod
+    def validate_name(cls, name) -> str:
+        """Validates the name of a COS bucket.
+
+        Rules source: https://ibm.github.io/ibm-cos-sdk-java/com/ibm/cloud/objectstorage/services/s3/model/Bucket.html  # pylint: disable=line-too-long
+        """
+
+        def _raise_no_traceback_name_error(err_str):
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.StorageNameError(err_str)
+
+        if name is not None and isinstance(name, str):
+            if not 3 <= len(name) <= 63:
+                _raise_no_traceback_name_error(
+                    f'Invalid store name: {name} must be between 3 (min) '
+                    'and 63 (max) characters long.')
+
+            # Check for valid characters and start/end with a letter or number
+            pattern = r'^[a-z0-9][-a-z0-9.]*[a-z0-9]$'
+            if not re.match(pattern, name):
+                _raise_no_traceback_name_error(
+                    f'Invalid store name: {name} can consist only of '
+                    'lowercase letters, numbers, dots (.), and dashes (-). '
+                    'It must begin and end with a letter or number.')
+
+            # Check for two adjacent periods or dashes
+            if any(substring in name for substring in ['..', '--']):
+                _raise_no_traceback_name_error(
+                    f'Invalid store name: {name} must not contain '
+                    'two adjacent periods/dashes')
+
+            # Check for IP address format
+            ip_pattern = r'^(?:\d{1,3}\.){3}\d{1,3}$'
+            if re.match(ip_pattern, name):
+                _raise_no_traceback_name_error(
+                    f'Invalid store name: {name} must not be formatted as '
+                    'an IP address (for example, 192.168.5.4).')
+
+            if any(substring in name for substring in ['.-', '-.']):
+                _raise_no_traceback_name_error(
+                    f'Invalid store name: {name} must '
+                    'not allow substrings: ".-", "-." .')
+        else:
+            _raise_no_traceback_name_error('Store name must be specified.')
+        return name
+
+    def initialize(self):
+        """Initializes the cos store object on the cloud.
+
+        Initialization involves fetching bucket if exists, or creating it if
+        it does not.
+
+        Raises:
+          StorageBucketCreateError: If bucket creation fails
+          StorageBucketGetError: If fetching existing bucket fails
+          StorageInitError: If general initialization fails.
+        """
+        self.client = ibm.get_cos_client(self.region)
+        self.s3_resource = ibm.get_cos_resource(self.region)
+        self.bucket, is_new_bucket = self._get_bucket()
+        if self.is_sky_managed is None:
+            # If is_sky_managed is not specified, then this is a new storage
+            # object (i.e., did not exist in global_user_state) and we should
+            # set the is_sky_managed property.
+            # If is_sky_managed is specified, then we take no action.
+            self.is_sky_managed = is_new_bucket
+
+    def upload(self):
+        """Uploads files from local machine to bucket.
+
+        Upload must be called by the Storage handler - it is not called on
+        Store initialization.
+
+        Raises:
+            StorageUploadError: if upload fails.
+        """
+        try:
+            if isinstance(self.source, list):
+                self.batch_ibm_rsync(self.source, create_dirs=True)
+            elif self.source is not None:
+                if self.source.startswith('cos://'):
+                    # cos bucket used as a dest, can't be used as source.
+                    pass
+                elif self.source.startswith('s3://'):
+                    raise Exception('IBM COS currently not supporting'
+                                    'data transfers between COS and S3')
+                elif self.source.startswith('gs://'):
+                    raise Exception('IBM COS currently not supporting'
+                                    'data transfers between COS and GS')
+                elif self.source.startswith('r2://'):
+                    raise Exception('IBM COS currently not supporting'
+                                    'data transfers between COS and r2')
+                else:
+                    self.batch_ibm_rsync([self.source])
+
+        except Exception as e:
+            raise exceptions.StorageUploadError(
+                f'Upload failed for store {self.name}') from e
+
+    def delete(self) -> None:
+        self._delete_cos_bucket()
+        logger.info(f'{colorama.Fore.GREEN}Deleted COS bucket {self.name}.'
+                    f'{colorama.Style.RESET_ALL}')
+
+    def get_handle(self) -> StorageHandle:
+        return self.s3_resource.Bucket(self.name)
+
+    def batch_ibm_rsync(self,
+                        source_path_list: List[Path],
+                        create_dirs: bool = False) -> None:
+        """Invokes rclone copy to batch upload a list of local paths to cos
+
+        Since rclone does not support batch operations, we construct
+        multiple commands to be run in parallel.
+
+        Args:
+            source_path_list: List of paths to local files or directories
+            create_dirs: If the local_path is a directory and this is set to
+                False, the contents of the directory are directly uploaded to
+                root of the bucket. If the local_path is a directory and this is
+                set to True, the directory is created in the bucket root and
+                contents are uploaded to it.
+        """
+
+        def get_dir_sync_command(src_dir_path, dest_dir_name) -> str:
+            """returns an rclone command that copies a complete folder
+              from 'src_dir_path' to bucket/'dest_dir_name'.
+
+            `rclone copy` copies files from source path to target.
+            files with identical names at won't be copied over, unless
+            their modification date is more recent.
+            works similarly to `aws sync` (without --delete).
+
+            Args:
+                src_dir_path (str): local source path from which to copy files.
+                dest_dir_name (str): remote target path files are copied to.
+
+            Returns:
+                str: bash command using rclone to sync files. Executed remotely.
+            """
+
+            # .git directory is excluded from the sync
+            # wrapping src_dir_path with "" to support path with spaces
+            sync_command = (
+                'rclone copy --exclude ".git/*" '
+                f'"{src_dir_path}" '
+                f'{self.bucket_rclone_profile}:{self.name}/{dest_dir_name}')
+            return sync_command
+
+        def get_file_sync_command(base_dir_path, file_names) -> str:
+            """returns an rclone command that copies files: 'file_names'
+               from base directory: `base_dir_path` to bucket.
+
+            `rclone copy` copies files from source path to target.
+            files with identical names at won't be copied over, unless
+            their modification date is more recent.
+            works similarly to `aws sync` (without --delete).
+
+            Args:
+                base_dir_path (str): local path from which to copy files.
+                file_names (List): specific file names to copy.
+
+            Returns:
+                str: bash command using rclone to sync files
+            """
+
+            # wrapping file_name with "" to support spaces
+            includes = ' '.join(
+                [f'--include "{file_name}"' for file_name in file_names])
+            sync_command = ('rclone copy '
+                            f'{includes} "{base_dir_path}" '
+                            f'{self.bucket_rclone_profile}:{self.name}')
+            return sync_command
+
+        # Generate message for upload
+        if len(source_path_list) > 1:
+            source_message = f'{len(source_path_list)} paths'
+        else:
+            source_message = source_path_list[0]
+
+        with log_utils.safe_rich_status(
+                f'[bold cyan]Syncing '
+                f'[green]{source_message}[/] to '
+                f'[green]cos://{self.region}/{self.name}/[/]'):
+            data_utils.parallel_upload(
+                source_path_list,
+                get_file_sync_command,
+                get_dir_sync_command,
+                self.name,
+                self._ACCESS_DENIED_MESSAGE,
+                create_dirs=create_dirs,
+                max_concurrent_uploads=_MAX_CONCURRENT_UPLOADS)
+
+    def _get_bucket(self) -> Tuple[StorageHandle, bool]:
+        """
+        returns IBM COS bucket object if exists, otherwise creates it.
+
+        Returns:
+          StorageHandle(str): bucket name
+          bool: indicates whether a new bucket was created.
+        """
+
+        bucket_profile_name = Rclone.RcloneClouds.IBM.value + self.name
+        try:
+            bucket_region = data_utils.get_ibm_cos_bucket_region(self.name)
+        except exceptions.StorageBucketGetError as e:
+            with ux_utils.print_exception_no_traceback():
+                command = f'rclone lsd {bucket_profile_name}: '
+                raise exceptions.StorageBucketGetError(
+                    _BUCKET_FAIL_TO_CONNECT_MESSAGE.format(name=self.name) +
+                    f' To debug, consider running `{command}`.') from e
+
+        try:
+            uri_region = data_utils.split_cos_path(
+                self.source)[2]  # type: ignore
+        except ValueError:
+            # source isn't a cos uri
+            uri_region = ''
+
+        # bucket's region doesn't match specified region in URI
+        if bucket_region and uri_region and uri_region != bucket_region\
+              and self.sync_on_reconstruction:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.StorageBucketGetError(
+                    f'Bucket {self.name} exists in '
+                    f'region {bucket_region}, '
+                    f'but URI specified region {uri_region}.')
+
+        if not bucket_region and uri_region:
+            # bucket doesn't exist but source is a bucket URI
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.StorageBucketGetError(
+                    'Attempted to connect to a non-existent bucket: '
+                    f'{self.name} by providing URI. Consider using '
+                    '`rclone lsd <remote>` on relevant remotes returned '
+                    'via `rclone listremotes` to debug.')
+
+        Rclone.store_rclone_config(
+            self.name,
+            Rclone.RcloneClouds.IBM,
+            self.region,  # type: ignore
+        )
+        if not bucket_region and self.sync_on_reconstruction:
+            # bucket doesn't exist
+            return self._create_cos_bucket(self.name, self.region), True
+        else:
+            # bucket exists
+            return self.s3_resource.Bucket(self.name), False
+
+    def _download_file(self, remote_path: str, local_path: str) -> None:
+        """Downloads file from remote to local on s3 bucket
+        using the boto3 API
+
+        Args:
+          remote_path: str; Remote path on S3 bucket
+          local_path: str; Local path on user's device
+        """
+        self.client.download_file(self.name, local_path, remote_path)
+
+    def mount_command(self, mount_path: str) -> str:
+        """Returns the command to mount the bucket to the mount_path.
+
+        Uses rclone to mount the bucket.
+        Source: https://github.com/rclone/rclone
+
+        Args:
+          mount_path: str; Path to mount the bucket to.
+        """
+        rclone_config_data = Rclone.get_rclone_config(
+            self.bucket.name,
+            Rclone.RcloneClouds.IBM,
+            self.region,  # type: ignore
+        )
+        # pylint: disable=line-too-long
+        # creates a fusermount soft link on older (<22) Ubuntu systems for rclone's mount utility.
+        create_fuser3_soft_link = '[ ! -f /bin/fusermount3 ] && sudo ln -s /bin/fusermount /bin/fusermount3 || true'
+        # stores bucket profile in rclone config file at the cluster's nodes.
+        configure_rclone_profile = (
+            f'{create_fuser3_soft_link}; mkdir -p ~/.config/rclone/ && echo "{rclone_config_data}">> {Rclone.RCLONE_CONFIG_PATH}'
+        )
+        # install rclone if not installed.
+        install_cmd = 'rclone version >/dev/null 2>&1 || (curl https://rclone.org/install.sh | sudo bash)'
+        # --daemon will keep the mounting process running in the background.
+        mount_cmd = f'{configure_rclone_profile} && rclone mount {self.bucket_rclone_profile}:{self.bucket.name} {mount_path} --daemon'
+        return mounting_utils.get_mounting_command(mount_path, install_cmd,
+                                                   mount_cmd)
+
+    def _create_cos_bucket(self,
+                           bucket_name: str,
+                           region='us-east') -> StorageHandle:
+        """Creates IBM COS bucket with specific name in specific region
+
+        Args:
+          bucket_name: str; Name of bucket
+          region: str; Region name, e.g. us-east, us-south
+        Raises:
+          StorageBucketCreateError: If bucket creation fails.
+        """
+        try:
+            self.client.create_bucket(
+                Bucket=bucket_name,
+                CreateBucketConfiguration={
+                    'LocationConstraint': f'{region}-smart'
+                })
+            logger.info(f'Created IBM COS bucket {bucket_name} in {region} '
+                        f'with storage class smart tier')
+            self.bucket = self.s3_resource.Bucket(bucket_name)
+
+        except ibm.ibm_botocore.exceptions.ClientError as e:  # type: ignore[union-attr]  # pylint: disable=line-too-long
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.StorageBucketCreateError(
+                    f'Failed to create bucket: '
+                    f'{bucket_name}') from e
+
+        s3_bucket_exists_waiter = self.client.get_waiter('bucket_exists')
+        s3_bucket_exists_waiter.wait(Bucket=bucket_name)
+
+        return self.bucket
+
+    def _delete_cos_bucket(self):
+        bucket = self.s3_resource.Bucket(self.name)
+        try:
+            bucket_versioning = self.s3_resource.BucketVersioning(self.name)
+            if bucket_versioning.status == 'Enabled':
+                res = list(bucket.object_versions.delete())
+            else:
+                res = list(bucket.objects.delete())
+            logger.debug(f'Deleted bucket\'s content:\n{res}')
+            bucket.delete()
+            bucket.wait_until_not_exists()
+        except ibm.ibm_botocore.exceptions.ClientError as e:
+            if e.__class__.__name__ == 'NoSuchBucket':
+                logger.debug('bucket already removed')
+        Rclone.delete_rclone_bucket_profile(self.name, Rclone.RcloneClouds.IBM)
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/data/storage_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/exceptions.py` & `skypilot-nightly-1.0.0.dev20230802/sky/exceptions.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/execution.py` & `skypilot-nightly-1.0.0.dev20230802/sky/execution.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/global_user_state.py` & `skypilot-nightly-1.0.0.dev20230802/sky/global_user_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/optimizer.py` & `skypilot-nightly-1.0.0.dev20230802/sky/optimizer.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/provision/__init__.py` & `skypilot-nightly-1.0.0.dev20230802/sky/provision/__init__.py`

 * *Files 10% similar despite different names*

```diff
@@ -71,7 +71,17 @@
     provider_name: str,
     cluster_name: str,
     provider_config: Optional[Dict[str, Any]] = None,
     worker_only: bool = False,
 ) -> None:
     """Terminate running or stopped instances."""
     raise NotImplementedError
+
+
+@_route_to_cloud_impl
+def cleanup_ports(
+    provider_name: str,
+    cluster_name: str,
+    provider_config: Optional[Dict[str, Any]] = None,
+) -> None:
+    """Delete any opened ports."""
+    raise NotImplementedError
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/provision/aws/instance.py` & `skypilot-nightly-1.0.0.dev20230802/sky/provision/aws/instance.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 """AWS instance provisioning."""
 from typing import Dict, List, Any, Optional
 
 from botocore import config
 
 from sky.adaptors import aws
+from sky.utils import common_utils
 from sky import status_lib
 
 BOTO_MAX_RETRIES = 12
 # Tag uniquely identifying all nodes of a cluster
 TAG_RAY_CLUSTER_NAME = 'ray-cluster-name'
 TAG_RAY_NODE_KIND = 'ray-node-type'
 
@@ -130,13 +131,44 @@
         filters.append({
             'Name': f'tag:{TAG_RAY_NODE_KIND}',
             'Values': ['worker'],
         })
     # https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.Instance
     instances = _filter_instances(ec2, filters, None, None)
     instances.terminate()
+    if 'ports' not in provider_config:
+        return
+    # If ports are specified, we need to delete the newly created Security
+    # Group. Here we wait for all instances to be terminated, since the
+    # Security Group dependent on them.
+    for instance in instances:
+        instance.wait_until_terminated()
     # TODO(suquark): Currently, the implementation of GCP and Azure will
     #  wait util the cluster is fully terminated, while other clouds just
     #  trigger the termination process (via http call) and then return.
     #  It's not clear that which behavior should be expected. We will not
     #  wait for the termination for now, since this is the default behavior
     #  of most cloud implementations (including AWS).
+
+
+def cleanup_ports(
+    cluster_name: str,
+    provider_config: Optional[Dict[str, Any]] = None,
+) -> None:
+    """See sky/provision/__init__.py"""
+    assert provider_config is not None, (cluster_name, provider_config)
+    if 'ports' not in provider_config:
+        return
+    region = provider_config['region']
+    ec2 = aws.resource(
+        'ec2',
+        region_name=region,
+        config=config.Config(retries={'max_attempts': BOTO_MAX_RETRIES}))
+    # TODO(tian): Add a function to generate SG name for AWS, then replace here
+    # and backend_utils::write_cluster_config
+    sg_name = (f'sky-sg-{common_utils.user_and_hostname_hash()}'
+               f'-{common_utils.truncate_and_hash_cluster_name(cluster_name)}')
+    sgs = ec2.security_groups.filter(GroupNames=[sg_name])
+    if len(list(sgs)) != 1:
+        raise ValueError(f'Expected security group {sg_name} not found. '
+                         'Cannot cleanup ports.')
+    list(sgs)[0].delete()
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/provision/gcp/instance.py` & `skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """GCP instance provisioning."""
 import collections
 import time
 from typing import Any, Callable, Dict, Iterable, List, Optional, Type
 
 from sky import sky_logging
 from sky.provision.gcp import instance_utils
+from sky.utils import common_utils
 
 logger = sky_logging.init_logger(__name__)
 
 MAX_POLLS = 12
 # Stopping instances can take several minutes, so we increase the timeout
 MAX_POLLS_STOP = MAX_POLLS * 8
 POLL_INTERVAL = 5
@@ -147,7 +148,25 @@
     for handler, instances in handler_to_instances.items():
         for instance in instances:
             operations[handler].append(
                 handler.terminate(project_id, zone, instance))
     _wait_for_operations(operations, project_id, zone)
     # We don't wait for the instances to be terminated, as it can take a long
     # time (same as what we did in ray's node_provider).
+
+
+def cleanup_ports(
+    cluster_name: str,
+    provider_config: Optional[Dict[str, Any]] = None,
+) -> None:
+    """See sky/provision/__init__.py"""
+    assert provider_config is not None, cluster_name
+    if 'ports' not in provider_config:
+        # No new ports were opened, so there is nothing to clean up.
+        return
+    project_id = provider_config['project_id']
+    cluster_name_hash = common_utils.truncate_and_hash_cluster_name(
+        cluster_name)
+    for port in provider_config['ports']:
+        rule_name = f'user-ports-{cluster_name_hash}-{port}'
+        instance_utils.GCPComputeInstance.delete_firewall_rule(
+            project_id, rule_name)
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/provision/gcp/instance_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/provision/gcp/instance_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -67,14 +67,22 @@
         label_filters: Optional[Dict[str, str]],
         status_filters: Optional[List[str]],
         included_instances: Optional[List[str]] = None,
         excluded_instances: Optional[List[str]] = None,
     ) -> List[str]:
         raise NotImplementedError
 
+    @classmethod
+    def delete_firewall_rule(
+        cls,
+        project_id: str,
+        firewall_rule_name: str,
+    ) -> None:
+        raise NotImplementedError
+
 
 class GCPComputeInstance(GCPInstance):
     """Instance handler for GCP compute instances."""
     NEED_TO_STOP_STATES = [
         'PROVISIONING',
         'STAGING',
         'RUNNING',
@@ -178,14 +186,31 @@
 
         if result['status'] == 'DONE':
             logger.debug('wait_for_compute_zone_operation: '
                          f'Operation {operation["name"]} finished.')
             return True
         return False
 
+    @classmethod
+    def delete_firewall_rule(
+        cls,
+        project_id: str,
+        firewall_rule_name: str,
+    ) -> None:
+        rule = cls.load_resource().firewalls().list(
+            project=project_id, filter=f'name={firewall_rule_name}')
+        if not rule:
+            logger.warning(f'Firewall rule {firewall_rule_name} not found. '
+                           'Skip cleanup.')
+            return
+        cls.load_resource().firewalls().delete(
+            project=project_id,
+            firewall=firewall_rule_name,
+        ).execute()
+
 
 class GCPTPUVMInstance(GCPInstance):
     """Instance handler for GCP TPU node."""
     NEED_TO_STOP_STATES = [
         'CREATING',
         'STARTING',
         'READY',
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/resources.py` & `skypilot-nightly-1.0.0.dev20230802/sky/resources.py`

 * *Files 2% similar despite different names*

```diff
@@ -29,15 +29,15 @@
     * as a "filter" to get concrete launchable instances
     * for calculating billing
     * for provisioning on a cloud
 
     """
     # If any fields changed, increment the version. For backward compatibility,
     # modify the __setstate__ method to handle the old version.
-    _VERSION = 10
+    _VERSION = 11
 
     def __init__(
         self,
         cloud: Optional[clouds.Cloud] = None,
         instance_type: Optional[str] = None,
         cpus: Union[None, int, float, str] = None,
         memory: Union[None, int, float, str] = None,
@@ -46,14 +46,15 @@
         use_spot: Optional[bool] = None,
         spot_recovery: Optional[str] = None,
         region: Optional[str] = None,
         zone: Optional[str] = None,
         image_id: Union[Dict[str, str], str, None] = None,
         disk_size: Optional[int] = None,
         disk_tier: Optional[Literal['high', 'medium', 'low']] = None,
+        ports: Optional[List[Union[int, str]]] = None,
         # Internal use only.
         _is_image_managed: Optional[bool] = None,
     ):
         """Initialize a Resources object.
 
         All fields are optional.  ``Resources.is_launchable`` decides whether
         the Resources is fully specified to launch an instance.
@@ -110,14 +111,15 @@
                 'us-west1': 'ami-1234567890abcdef0',
                 'us-east1': 'ami-1234567890abcdef0'
               }
 
           disk_size: the size of the OS disk in GiB.
           disk_tier: the disk performance tier to use. If None, defaults to
             ``'medium'``.
+          ports: the ports to open on the instance.
         """
         self._version = self._VERSION
         self._cloud = cloud
         self._region: Optional[str] = None
         self._zone: Optional[str] = None
         self._set_region_zone(region, zone)
 
@@ -150,25 +152,27 @@
             else:
                 self._image_id = {
                     k.strip(): v.strip() for k, v in image_id.items()
                 }
         self._is_image_managed = _is_image_managed
 
         self._disk_tier = disk_tier
+        self._ports = ports
 
         self._set_cpus(cpus)
         self._set_memory(memory)
         self._set_accelerators(accelerators, accelerator_args)
 
         self._try_validate_local()
         self._try_validate_instance_type()
         self._try_validate_cpus_mem()
         self._try_validate_spot()
         self._try_validate_image_id()
         self._try_validate_disk_tier()
+        self._try_validate_ports()
 
     def __repr__(self) -> str:
         """Returns a string representation for display.
 
         Examples:
 
             >>> sky.Resources(accelerators='V100')
@@ -223,26 +227,30 @@
         if self.disk_tier is not None:
             disk_tier = f', disk_tier={self.disk_tier}'
 
         disk_size = ''
         if self.disk_size != _DEFAULT_DISK_SIZE_GB:
             disk_size = f', disk_size={self.disk_size}'
 
+        ports = ''
+        if self.ports is not None:
+            ports = f', ports={self.ports}'
+
         if self._instance_type is not None:
             instance_type = f'{self._instance_type}'
         else:
             instance_type = ''
 
         # Do not show region/zone here as `sky status -a` would show them as
         # separate columns. Also, Resources repr will be printed during
         # failover, and the region may be dynamically determined.
         hardware_str = (
             f'{instance_type}{use_spot}'
             f'{cpus}{memory}{accelerators}{accelerator_args}{image_id}'
-            f'{disk_tier}{disk_size}')
+            f'{disk_tier}{disk_size}{ports}')
         # It may have leading ',' (for example, instance_type not set) or empty
         # spaces.  Remove them.
         while hardware_str and hardware_str[0] in (',', ' '):
             hardware_str = hardware_str[1:]
 
         cloud_str = '<Cloud>'
         if self.cloud is not None:
@@ -333,14 +341,18 @@
         return self._image_id
 
     @property
     def disk_tier(self) -> str:
         return self._disk_tier
 
     @property
+    def ports(self) -> Optional[List[Union[int, str]]]:
+        return self._ports
+
+    @property
     def is_image_managed(self) -> Optional[bool]:
         return self._is_image_managed
 
     def _set_cpus(
         self,
         cpus: Union[None, int, float, str],
     ) -> None:
@@ -727,14 +739,60 @@
                     'Please use one of "high", "medium", or "low".')
         if self.instance_type is None:
             return
         if self.cloud is not None:
             self.cloud.check_disk_tier_enabled(self.instance_type,
                                                self.disk_tier)
 
+    def _try_validate_ports(self) -> None:
+        if self.ports is None:
+            return
+        if skypilot_config.get_nested(('aws', 'security_group_name'),
+                                      None) is not None:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Cannot specify ports when AWS security group name is '
+                    'specified.')
+        if self.cloud is not None:
+            self.cloud.check_features_are_supported(
+                {clouds.CloudImplementationFeatures.OPEN_PORTS})
+        for port in self.ports:
+            if isinstance(port, int):
+                if port < 1 or port > 65535:
+                    with ux_utils.print_exception_no_traceback():
+                        raise ValueError(
+                            f'Invalid port {port}. Please use a port number '
+                            'between 1 and 65535.')
+            elif isinstance(port, str):
+                port_range = port.split('-')
+                if len(port_range) != 2:
+                    with ux_utils.print_exception_no_traceback():
+                        raise ValueError(
+                            f'Invalid port {port}. Please use a port range '
+                            'such as 10022-10040.')
+                try:
+                    from_port = int(port_range[0])
+                    to_port = int(port_range[1])
+                except ValueError as e:
+                    with ux_utils.print_exception_no_traceback():
+                        raise ValueError(
+                            f'Invalid port {port}. Please use a integer inside'
+                            ' the range.') from e
+                if (from_port < 1 or from_port > 65535 or to_port < 1 or
+                        to_port > 65535):
+                    with ux_utils.print_exception_no_traceback():
+                        raise ValueError(
+                            f'Invalid port {port}. Please use port '
+                            'numbers between 1 and 65535.')
+            else:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        f'Invalid port {port}. Please use an integer or '
+                        'a range such as 10022-10040.')
+
     def get_cost(self, seconds: float) -> float:
         """Returns cost in USD for the runtime in seconds."""
         hours = seconds / 3600
         # Instance.
         hourly_cost = self.cloud.instance_type_to_hourly_cost(
             self._instance_type, self.use_spot, self._region, self._zone)
         # Accelerators (if any).
@@ -812,14 +870,31 @@
             if other.disk_tier is None:
                 return False
             if self.disk_tier != other.disk_tier:
                 types = ['low', 'medium', 'high']
                 return types.index(self.disk_tier) < types.index(
                     other.disk_tier)
 
+        if self.ports is not None:
+            if other.ports is None:
+                return False
+
+            def parse_ports(ports):
+                port_set = set()
+                for p in ports:
+                    if isinstance(p, int):
+                        port_set.add(p)
+                    else:
+                        from_port, to_port = p.split('-')
+                        port_set.update(range(int(from_port), int(to_port) + 1))
+                return port_set
+
+            if not parse_ports(self.ports) <= parse_ports(other.ports):
+                return False
+
         # self <= other
         return True
 
     def should_be_blocked_by(self, blocked: 'Resources') -> bool:
         """Whether this Resources matches the blocked Resources.
 
         If a field in `blocked` is None, it should be considered as a wildcard
@@ -850,14 +925,15 @@
             self.memory is None,
             self.accelerators is None,
             self.accelerator_args is None,
             not self._use_spot_specified,
             self.disk_size == _DEFAULT_DISK_SIZE_GB,
             self.disk_tier is None,
             self._image_id is None,
+            self.ports is None,
         ])
 
     def copy(self, **override) -> 'Resources':
         """Returns a copy of the given Resources."""
         use_spot = self.use_spot if self._use_spot_specified else None
         resources = Resources(
             cloud=override.pop('cloud', self.cloud),
@@ -870,14 +946,15 @@
             use_spot=override.pop('use_spot', use_spot),
             spot_recovery=override.pop('spot_recovery', self.spot_recovery),
             disk_size=override.pop('disk_size', self.disk_size),
             region=override.pop('region', self.region),
             zone=override.pop('zone', self.zone),
             image_id=override.pop('image_id', self.image_id),
             disk_tier=override.pop('disk_tier', self.disk_tier),
+            ports=override.pop('ports', self.ports),
             _is_image_managed=override.pop('_is_image_managed',
                                            self._is_image_managed),
         )
         assert len(override) == 0
         return resources
 
     def valid_on_region_zones(self, region: str, zones: List[str]) -> bool:
@@ -895,14 +972,16 @@
             self) -> Set[clouds.CloudImplementationFeatures]:
         """Returns the set of cloud features required by this Resources."""
         features = set()
         if self.use_spot:
             features.add(clouds.CloudImplementationFeatures.SPOT_INSTANCE)
         if self.disk_tier is not None:
             features.add(clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER)
+        if self.ports is not None:
+            features.add(clouds.CloudImplementationFeatures.OPEN_PORTS)
         return features
 
     @classmethod
     def from_yaml_config(cls, config: Optional[Dict[str, str]]) -> 'Resources':
         if config is None:
             return Resources()
 
@@ -934,14 +1013,16 @@
             resources_fields['region'] = config.pop('region')
         if config.get('zone') is not None:
             resources_fields['zone'] = config.pop('zone')
         if config.get('image_id') is not None:
             resources_fields['image_id'] = config.pop('image_id')
         if config.get('disk_tier') is not None:
             resources_fields['disk_tier'] = config.pop('disk_tier')
+        if config.get('ports') is not None:
+            resources_fields['ports'] = config.pop('ports')
         if config.get('_is_image_managed') is not None:
             resources_fields['_is_image_managed'] = config.pop(
                 '_is_image_managed')
 
         assert not config, f'Invalid resource args: {config.keys()}'
         return Resources(**resources_fields)
 
@@ -964,14 +1045,15 @@
             add_if_not_none('use_spot', self.use_spot)
         config['spot_recovery'] = self.spot_recovery
         config['disk_size'] = self.disk_size
         add_if_not_none('region', self.region)
         add_if_not_none('zone', self.zone)
         add_if_not_none('image_id', self.image_id)
         add_if_not_none('disk_tier', self.disk_tier)
+        add_if_not_none('ports', self.ports)
         if self._is_image_managed is not None:
             config['_is_image_managed'] = self._is_image_managed
         return config
 
     def __setstate__(self, state):
         """Set state from pickled state, for backward compatibility."""
         self._version = self._VERSION
@@ -1031,8 +1113,11 @@
 
         if version < 9:
             self._disk_tier = None
 
         if version < 10:
             self._is_image_managed = None
 
+        if version < 11:
+            self._ports = None
+
         self.__dict__.update(state)
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/setup_files/MANIFEST.in` & `skypilot-nightly-1.0.0.dev20230802/sky/setup_files/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/setup_files/setup.py` & `skypilot-nightly-1.0.0.dev20230802/sky/setup_files/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -145,15 +145,17 @@
     # We need azure-identity>=1.13.0 to enable the customization of the
     # timeout of AzureCliCredential.
     'azure': [
         'azure-cli>=2.31.0', 'azure-core', 'azure-identity>=1.13.0',
         'azure-mgmt-network'
     ],
     'gcp': ['google-api-python-client', 'google-cloud-storage'],
-    'ibm': ['ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services'],
+    'ibm': [
+        'ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services', 'ibm-cos-sdk'
+    ],
     'docker': ['docker'],
     'lambda': [],
     'cloudflare': aws_dependencies,
     'scp': [],
     'oci': ['oci'],
 }
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/sky_logging.py` & `skypilot-nightly-1.0.0.dev20230802/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/LICENSE` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/attempt_skylet.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/attempt_skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/autostop_lib.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/configs.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/constants.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/events.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/events.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/job_lib.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/job_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/log_lib.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/log_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/config.py`

 * *Files 1% similar despite different names*

```diff
@@ -858,16 +858,21 @@
                 )
             else:
                 node_config["ImageId"] = default_ami
                 ami_src_info[key] = "dlami"
 
 
 def _upsert_security_groups(config, node_types):
+    start_time = time.time()
+    logger.info("Creating or updating security groups...")
     security_groups = _get_or_create_vpc_security_groups(config, node_types)
     _upsert_security_group_rules(config, security_groups)
+    end_time = time.time()
+    elapsed = end_time - start_time
+    logger.info(f"Security groups created or updated in {elapsed:.5f} seconds.")
 
     return security_groups
 
 
 def _get_or_create_vpc_security_groups(conf, node_types):
     # Figure out which VPC each node_type is in...
     ec2 = _resource("ec2", conf)
@@ -949,14 +954,15 @@
     filtered_groups = [
         sg for sg in existing_groups if sg.group_name in unique_group_names
     ]
     return filtered_groups
 
 
 def _create_security_group(config, vpc_id, group_name):
+    logger.info(f"Creating security group '{group_name}'...")
     client = _client("ec2", config)
     client.create_security_group(
         Description="Auto-created security group for Ray workers",
         GroupName=group_name,
         VpcId=vpc_id,
     )
     security_group = _get_security_group(config, vpc_id, group_name)
@@ -991,31 +997,57 @@
             _update_inbound_rules(sg, sgids, conf)
 
 
 def _update_inbound_rules(target_security_group, sgids, config):
     extended_rules = (
         config["provider"].get("security_group", {}).get("IpPermissions", [])
     )
-    ip_permissions = _create_default_inbound_rules(sgids, extended_rules)
+    user_specified_rules = _retrieve_user_specified_rules(
+        config["provider"].get("ports", [])
+    )
+    ip_permissions = _create_default_inbound_rules(
+        sgids, user_specified_rules, extended_rules
+    )
     target_security_group.authorize_ingress(IpPermissions=ip_permissions)
 
 
-def _create_default_inbound_rules(sgids, extended_rules=None):
+def _create_default_inbound_rules(sgids, user_specified_rules, extended_rules=None):
     if extended_rules is None:
         extended_rules = []
     intracluster_rules = _create_default_intracluster_inbound_rules(sgids)
     ssh_rules = _create_default_ssh_inbound_rules()
     merged_rules = itertools.chain(
+        user_specified_rules,
         intracluster_rules,
         ssh_rules,
         extended_rules,
     )
     return list(merged_rules)
 
 
+def _retrieve_user_specified_rules(ports):
+    rules = []
+    for port in ports:
+        if isinstance(port, int):
+            from_port = to_port = port
+        else:
+            from_port, to_port = port.split("-")
+            from_port = int(from_port)
+            to_port = int(to_port)
+        rules.append(
+            {
+                "FromPort": from_port,
+                "ToPort": to_port,
+                "IpProtocol": "tcp",
+                "IpRanges": [{"CidrIp": "0.0.0.0/0"}],
+            }
+        )
+    return rules
+
+
 def _create_default_intracluster_inbound_rules(intracluster_sgids):
     return [
         {
             "FromPort": -1,
             "ToPort": -1,
             "IpProtocol": "-1",
             "UserIdGroupPairs": [
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/aws/utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/azure-config-template.json` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/azure/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/config.py`

 * *Files 2% similar despite different names*

```diff
@@ -23,14 +23,15 @@
     SKYPILOT_VPC_NAME,
     VPC_TEMPLATE,
     FIREWALL_RULES_TEMPLATE,
     FIREWALL_RULES_REQUIRED,
     VM_MINIMAL_PERMISSIONS,
     TPU_MINIMAL_PERMISSIONS,
 )
+from sky.utils import common_utils
 from ray.autoscaler._private.util import check_legacy_fields
 
 logger = logging.getLogger(__name__)
 
 VERSION = "v1"
 TPU_VERSION = "v2alpha"  # change once v2 is stable
 
@@ -668,14 +669,24 @@
                     ("INGRESS", "10.128.0.0/9"): {"tcp": {80, 443}, "udp": {53}},
                     ("INGRESS", "0.0.0.0/0"): {"tcp": {22}},
                 }
         """
         source2rules: Dict[Tuple[str, str], Dict[str, Set[int]]] = {}
         source2allowed_list: Dict[Tuple[str, str], List[Dict[str, str]]] = {}
         for rule in rules:
+            # Rules applied to specific VM (targetTags) may not work for the
+            # current VM, so should be skipped.
+            # Filter by targetTags == ['cluster_name']
+            # See https://developers.google.com/resources/api-libraries/documentation/compute/alpha/python/latest/compute_alpha.networks.html#getEffectiveFirewalls # pylint: disable=line-too-long
+            tags = rule.get("targetTags", None)
+            if tags is not None:
+                if len(tags) != 1:
+                    continue
+                if tags[0] != config["cluster_name"]:
+                    continue
             direction = rule.get("direction", "")
             sources = rule.get("sourceRanges", [])
             allowed = rule.get("allowed", [])
             for source in sources:
                 key = (direction, source)
                 source2allowed_list[key] = source2allowed_list.get(key, []) + allowed
         for direction_source, allowed_list in source2allowed_list.items():
@@ -718,14 +729,34 @@
         for protocol, ports_req in allowed_req.items():
             ports_eff = allowed_eff.get(protocol, set())
             if not ports_req.issubset(ports_eff):
                 return False
     return True
 
 
+def _create_rules(config, compute, rules, VPC_NAME, PROJ_ID):
+    opertaions = []
+    for rule in rules:
+        # Query firewall rule by its name (unique in a project).
+        # If the rule already exists, delete it first.
+        rule_name = rule["name"].format(VPC_NAME=VPC_NAME)
+        rule_list = _list_firewall_rules(config, compute, filter=f"(name={rule_name})")
+        if len(rule_list) > 0:
+            _delete_firewall_rule(config, compute, rule_name)
+
+        body = rule.copy()
+        body["name"] = body["name"].format(VPC_NAME=VPC_NAME)
+        body["network"] = body["network"].format(PROJ_ID=PROJ_ID, VPC_NAME=VPC_NAME)
+        body["selfLink"] = body["selfLink"].format(PROJ_ID=PROJ_ID, VPC_NAME=VPC_NAME)
+        op = _create_firewall_rule_submit(config, compute, body)
+        opertaions.append(op)
+    for op in opertaions:
+        wait_for_compute_global_operation(config["provider"]["project_id"], op, compute)
+
+
 def get_usable_vpc(config):
     """Return a usable VPC.
 
     If not found, create a new one with sufficient firewall rules.
     """
     _, _, compute, _ = construct_clients_from_provider_config(config["provider"])
 
@@ -747,52 +778,64 @@
 
     usable_vpc_name = None
     for vpc in vpcnets_all:
         if _check_firewall_rules(vpc["name"], config, compute):
             usable_vpc_name = vpc["name"]
             break
 
+    proj_id = config["provider"]["project_id"]
     if usable_vpc_name is None:
         logger.info(f"Creating a default VPC network, {SKYPILOT_VPC_NAME}...")
 
-        proj_id = config["provider"]["project_id"]
         # Create a SkyPilot VPC network if it doesn't exist
         vpc_list = _list_vpcnets(config, compute, filter=f"name={SKYPILOT_VPC_NAME}")
         if len(vpc_list) == 0:
             body = VPC_TEMPLATE.copy()
             body["name"] = body["name"].format(VPC_NAME=SKYPILOT_VPC_NAME)
             body["selfLink"] = body["selfLink"].format(
                 PROJ_ID=proj_id, VPC_NAME=SKYPILOT_VPC_NAME
             )
             _create_vpcnet(config, compute, body)
 
-        # Create firewall rules
-        for rule in FIREWALL_RULES_TEMPLATE:
-            # Query firewall rule by its name (unique in a project).
-            # If the rule already exists, delete it first.
-            rule_name = rule["name"].format(VPC_NAME=SKYPILOT_VPC_NAME)
-            rule_list = _list_firewall_rules(
-                config, compute, filter=f"(name={rule_name})"
-            )
-            if len(rule_list) > 0:
-                _delete_firewall_rule(config, compute, rule_name)
-
-            body = rule.copy()
-            body["name"] = body["name"].format(VPC_NAME=SKYPILOT_VPC_NAME)
-            body["network"] = body["network"].format(
-                PROJ_ID=proj_id, VPC_NAME=SKYPILOT_VPC_NAME
-            )
-            body["selfLink"] = body["selfLink"].format(
-                PROJ_ID=proj_id, VPC_NAME=SKYPILOT_VPC_NAME
-            )
-            _create_firewall_rule(config, compute, body)
+        _create_rules(
+            config, compute, FIREWALL_RULES_TEMPLATE, SKYPILOT_VPC_NAME, proj_id
+        )
 
         usable_vpc_name = SKYPILOT_VPC_NAME
         logger.info(f"A VPC network {SKYPILOT_VPC_NAME} created.")
 
+    # Configure user specified rules
+    ports = config["provider"].get("ports", [])
+    user_rules = []
+    for port in ports:
+        cluster_name_hash = common_utils.truncate_and_hash_cluster_name(
+            config["cluster_name"]
+        )
+        name = f"user-ports-{cluster_name_hash}-{port}"
+        user_rules.append(
+            {
+                "name": name,
+                "description": f"Allow user-specified port {port} for cluster {config['cluster_name']}",
+                "network": "projects/{PROJ_ID}/global/networks/{VPC_NAME}",
+                "selfLink": "projects/{PROJ_ID}/global/firewalls/" + name,
+                "direction": "INGRESS",
+                "priority": 65534,
+                "allowed": [
+                    {
+                        "IPProtocol": "tcp",
+                        "ports": [str(port)],
+                    },
+                ],
+                "sourceRanges": ["0.0.0.0/0"],
+                "targetTags": [config["cluster_name"]],
+            }
+        )
+
+    _create_rules(config, compute, user_rules, usable_vpc_name, proj_id)
+
     return usable_vpc_name
 
 
 def _configure_subnet(config, compute):
     """Pick a reasonable subnet if not specified by the config."""
     config = copy.deepcopy(config)
 
@@ -834,27 +877,38 @@
         if "networkInterfaces" not in node_config:
             node_config["networkInterfaces"] = copy.deepcopy(default_interfaces)
         # TPU
         if "networkConfig" not in node_config:
             node_config["networkConfig"] = copy.deepcopy(default_interfaces)[0]
             node_config["networkConfig"].pop("accessConfigs")
 
+        if get_node_type(node_config) == GCPNodeType.COMPUTE:
+            if "tags" not in node_config:
+                node_config["tags"] = {"items": []}
+            # Add cluster name to the tags so that firewall rules will apply to
+            # the created VM.
+            node_config["tags"]["items"].append(config["cluster_name"])
+        else:
+            assert get_node_type(node_config) == GCPNodeType.GCPTPU, node_config
+            # TPU VM has a different api for tags. See
+            # https://cloud.google.com/tpu/docs/reference/rest/v2alpha1/projects.locations.nodes  # pylint: disable=line-too-long
+            if "tags" not in node_config:
+                node_config["tags"] = []
+            node_config["tags"].append(config["cluster_name"])
+
     return config
 
 
-def _create_firewall_rule(config, compute, body):
+def _create_firewall_rule_submit(config, compute, body):
     operation = (
         compute.firewalls()
         .insert(project=config["provider"]["project_id"], body=body)
         .execute()
     )
-    response = wait_for_compute_global_operation(
-        config["provider"]["project_id"], operation, compute
-    )
-    return response
+    return operation
 
 
 def _delete_firewall_rule(config, compute, name):
     operation = (
         compute.firewalls()
         .delete(project=config["provider"]["project_id"], firewall=name)
         .execute()
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/constants.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/node.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/gcp/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/gcp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/utils.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 """holds common utility function/constants to be used by the providers."""
 
 import logging
-import os
+from pathlib import Path
 import time
 
 RAY_RECYCLABLE = "ray-recyclable"
 
 
 def get_logger(caller_name):
     """
@@ -13,16 +13,15 @@
     logs of level DEBUG and higher will be directed to file under LOGS_FOLDER.
     logs of level INFO and higher will be directed to console output.
     """
     logger = logging.getLogger(caller_name)
     LOGS_FOLDER = "/tmp/connector_logs/"  # this node_provider's logs location.
     logger.setLevel(logging.DEBUG)
 
-    if not os.path.exists(LOGS_FOLDER):
-        os.mkdir(LOGS_FOLDER)
+    Path(LOGS_FOLDER).mkdir(parents=True, exist_ok=True)
     logs_path = LOGS_FOLDER + caller_name + time.strftime("%Y-%m-%d--%H-%M-%S")
     # pylint: disable=line-too-long
     file_formatter = logging.Formatter(
         "%(asctime)s %(levelname)-8s %(message)s", datefmt="%Y-%m-%d %H:%M:%S"
     )
 
     file_handler = logging.FileHandler(logs_path)
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/lambda_cloud/lambda_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/oci/query_helper.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/oci/query_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/node_provider.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/providers/scp/scp_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/providers/scp/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/__init__.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/ray_patches/worker.py.patch` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/skylet.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/skylet.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skylet/subprocess_daemon.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/skypilot_config.py` & `skypilot-nightly-1.0.0.dev20230802/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/__init__.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/constants.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/controller.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/controller.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 """Controller: handles the life cycle of a managed spot cluster (job)."""
 import argparse
 import multiprocessing
+import os
 import pathlib
 import time
 import traceback
 import typing
 from typing import Tuple
 
 import filelock
@@ -70,16 +71,61 @@
             task_envs = task.envs or {}
             task_envs[constants.TASK_ID_ENV_VAR_DEPRECATED] = job_id_env_vars[i]
             task_envs[constants.TASK_ID_ENV_VAR] = job_id_env_vars[i]
             task_envs[constants.TASK_ID_LIST_ENV_VAR] = '\n'.join(
                 job_id_env_vars)
             task.update_envs(task_envs)
 
+    def _download_log_and_stream(
+            self,
+            handle: cloud_vm_ray_backend.CloudVmRayResourceHandle) -> None:
+        """Downloads and streams the logs of the latest job of a spot cluster.
+
+        We do not stream the logs from the spot cluster directly, as the
+        donwload and stream should be faster, and more robust against
+        preemptions or ssh disconnection during the streaming.
+        """
+        spot_job_logs_dir = os.path.join(constants.SKY_LOGS_DIRECTORY,
+                                         'spot_jobs')
+        os.makedirs(spot_job_logs_dir, exist_ok=True)
+        try:
+            log_dirs = self._backend.sync_down_logs(
+                handle,
+                # Download the log of the latest job.
+                # The job_id for the spot job running on the spot cluster is not
+                # necessarily 1, as it is possible that the worker node in a
+                # multi-node cluster is preempted, and we recover the spot job
+                # on the existing cluster, which leads to a larger job_id. Those
+                # job_ids all represent the same logical spot job.
+                job_ids=None,
+                local_dir=spot_job_logs_dir)
+        except exceptions.CommandError as e:
+            logger.info(f'Failed to download the logs: '
+                        f'{common_utils.format_exception(e)}')
+        else:
+            if not log_dirs:
+                logger.error('Failed to find the logs for the user program in '
+                             'the spot cluster.')
+            else:
+                log_dir = list(log_dirs.values())[0]
+                log_file = os.path.join(log_dir, 'run.log')
+
+                # Print the logs to the console.
+                try:
+                    with open(log_file) as f:
+                        print(f.read())
+                except FileNotFoundError:
+                    logger.error('Failed to find the logs for the user '
+                                 f'program at {log_file}.')
+                else:
+                    logger.info(f'\n== End of logs (ID: {self._job_id}) ==')
+
     def _run_one_task(self, task_id: int, task: 'sky.Task') -> bool:
         """Busy loop monitoring spot cluster status and handling recovery.
+
         When the task is successfully completed, this function returns True,
         and will terminate the spot cluster before returning.
 
         If the user program fails, i.e. the task is set to FAILED or
         FAILED_SETUP, this function will return False.
         In other cases, the function will raise exceptions.
         All the failure cases will rely on the caller to clean up the spot
@@ -233,21 +279,16 @@
                     # The user code has probably crashed, fail immediately.
                     end_time = spot_utils.get_job_timestamp(self._backend,
                                                             cluster_name,
                                                             get_end_time=True)
                     logger.info(
                         'The user job failed. Please check the logs below.\n'
                         f'== Logs of the user job (ID: {self._job_id}) ==\n')
-                    # TODO(zhwu): Download the logs, and stream them from the
-                    # local disk, instead of streaming them from the spot
-                    # cluster, to make it faster and more reliable.
-                    returncode = self._backend.tail_logs(
-                        handle, None, spot_job_id=self._job_id)
-                    logger.info(f'\n== End of logs (ID: {self._job_id}, '
-                                f'tail_logs returncode: {returncode}) ==')
+
+                    self._download_log_and_stream(handle)
                     spot_status_to_set = spot_state.SpotStatus.FAILED
                     if job_status == job_lib.JobStatus.FAILED_SETUP:
                         spot_status_to_set = spot_state.SpotStatus.FAILED_SETUP
                     failure_reason = (
                         'To see the details, run: '
                         f'sky spot logs --controller {self._job_id}')
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/dashboard.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/dashboard.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/static/favicon.ico` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/dashboard/templates/index.html` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/dashboard/templates/index.html`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/recovery_strategy.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/recovery_strategy.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/spot_state.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/spot/spot_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/spot/spot_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/status_lib.py` & `skypilot-nightly-1.0.0.dev20230802/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/task.py` & `skypilot-nightly-1.0.0.dev20230802/sky/task.py`

 * *Files 2% similar despite different names*

```diff
@@ -480,14 +480,16 @@
     def get_inputs_cloud(self):
         """EXPERIMENTAL: Returns the cloud my inputs live in."""
         assert isinstance(self.inputs, str), self.inputs
         if self.inputs.startswith('s3:'):
             return clouds.AWS()
         elif self.inputs.startswith('gs:'):
             return clouds.GCP()
+        elif self.inputs.startswith('cos:'):
+            return clouds.IBM()
         else:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(f'cloud path not supported: {self.inputs}')
 
     def set_outputs(self, outputs, estimated_size_gigabytes) -> 'Task':
         self.outputs = outputs
         self.estimated_outputs_size_gigabytes = estimated_size_gigabytes
@@ -816,14 +818,27 @@
                             list) and storage.source.startswith('r2://'):
                         blob_path = storage.source
                     else:
                         blob_path = 'r2://' + storage.name
                     self.update_file_mounts({
                         mnt_path: blob_path,
                     })
+                elif store_type is storage_lib.StoreType.IBM:
+                    if isinstance(storage.source,
+                                  str) and storage.source.startswith('cos://'):
+                        # source is a cos bucket's uri
+                        blob_path = storage.source
+                    else:
+                        # source is a bucket name.
+                        assert storage.name is not None, storage
+                        # extract region from rclone.conf
+                        cos_region = data_utils.Rclone.get_region_from_rclone(
+                            storage.name, data_utils.Rclone.RcloneClouds.IBM)
+                        blob_path = f'cos://{cos_region}/{storage.name}'
+                    self.update_file_mounts({mnt_path: blob_path})
                 elif store_type is storage_lib.StoreType.AZURE:
                     # TODO when Azure Blob is done: sync ~/.azure
                     raise NotImplementedError('Azure Blob not mountable yet')
                 else:
                     with ux_utils.print_exception_no_traceback():
                         raise ValueError(f'Storage Type {store_type} '
                                          'does not exist!')
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/aws-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/aws-ray.yml.j2`

 * *Files 3% similar despite different names*

```diff
@@ -17,14 +17,20 @@
     # AWS config file must include security group name
     GroupName: {{security_group}}
 {% if vpc_name is not none %}
   # NOTE: This is a new field added by SkyPilot and parsed by our own
   # AWSNodeProvider.
   vpc_name: {{vpc_name}}
 {% endif %}
+{%- if ports %}
+  ports:
+{%- for port in ports %}
+    - {{port}}
+{%- endfor %}
+{%- endif %}
   use_internal_ips: {{use_internal_ips}}
   # Disable launch config check for worker nodes as it can cause resource
   # leakage.
   # Reference: https://github.com/ray-project/ray/blob/cd1ba65e239360c8a7b130f991ed414eccc063ce/python/ray/autoscaler/_private/autoscaler.py#L1115
   # The upper-level SkyPilot code has make sure there will not be resource
   # leakage.
   disable_launch_config_check: true
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/azure-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/gcp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/gcp-ray.yml.j2`

 * *Files 6% similar despite different names*

```diff
@@ -13,14 +13,20 @@
   region: {{region}}
   availability_zone: {{zones}}
   # Keep (otherwise cannot reuse when re-provisioning).
   # teardown(terminate=True) will override this.
   cache_stopped_nodes: True
   # The GCP project ID.
   project_id: {{gcp_project_id}}
+{%- if ports %}
+  ports:
+{%- for port in ports %}
+    - {{port}}
+{%- endfor %}
+{%- endif %}
 {%- if tpu_vm %}
   _has_tpus: True
 {%- endif %}
   # Disable launch config check for worker nodes as it can cause resource
   # leakage.
   # Reference: https://github.com/ray-project/ray/blob/cd1ba65e239360c8a7b130f991ed414eccc063ce/python/ray/autoscaler/_private/autoscaler.py#L1115
   # The upper-level SkyPilot code has make sure there will not be resource
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/ibm-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/lambda-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/local-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/oci-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/oci-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/scp-ray.yml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/scp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/templates/spot-controller.yaml.j2` & `skypilot-nightly-1.0.0.dev20230802/sky/templates/spot-controller.yaml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/usage/constants.py` & `skypilot-nightly-1.0.0.dev20230802/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/usage/usage_lib.py` & `skypilot-nightly-1.0.0.dev20230802/sky/usage/usage_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/accelerator_registry.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/cli_utils/status_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/command_runner.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/common_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/common_utils.py`

 * *Files 3% similar despite different names*

```diff
@@ -19,14 +19,16 @@
 import colorama
 
 from sky import sky_logging
 
 _USER_HASH_FILE = os.path.expanduser('~/.sky/user_hash')
 USER_HASH_LENGTH = 8
 
+CLUSTER_NAME_HASH_LENGTH = 4
+
 _COLOR_PATTERN = re.compile(r'\x1b[^m]*m')
 
 _PAYLOAD_PATTERN = re.compile(r'<sky-payload>(.*)</sky-payload>')
 _PAYLOAD_STR = '<sky-payload>{}</sky-payload>'
 
 logger = sky_logging.init_logger(__name__)
 
@@ -82,14 +84,21 @@
         user_hash = uuid.uuid4().hex[:USER_HASH_LENGTH]
     os.makedirs(os.path.dirname(_USER_HASH_FILE), exist_ok=True)
     with open(_USER_HASH_FILE, 'w') as f:
         f.write(user_hash)
     return user_hash
 
 
+def truncate_and_hash_cluster_name(cluster_name: str) -> str:
+    if len(cluster_name) < 15:
+        return cluster_name
+    return cluster_name[:10] + hashlib.md5(
+        cluster_name.encode()).hexdigest()[:CLUSTER_NAME_HASH_LENGTH]
+
+
 def get_global_job_id(job_timestamp: str,
                       cluster_name: Optional[str],
                       job_id: str,
                       task_id: Optional[int] = None) -> str:
     """Returns a unique job run id for each job run.
 
     A job run is defined as the lifetime of a job that has been launched.
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/dag_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/dag_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/db_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/env_options.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/log_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/schemas.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/schemas.py`

 * *Files 2% similar despite different names*

```diff
@@ -62,14 +62,24 @@
             },
             'disk_size': {
                 'type': 'integer',
             },
             'disk_tier': {
                 'type': 'string',
             },
+            'ports': {
+                'type': 'array',
+                'items': {
+                    'anyOf': [{
+                        'type': 'string',
+                    }, {
+                        'type': 'integer',
+                    }]
+                }
+            },
             'accelerator_args': {
                 'type': 'object',
                 'required': [],
                 'additionalProperties': False,
                 'properties': {
                     'runtime_version': {
                         'type': 'string',
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/subprocess_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/subprocess_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/timeline.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/tpu_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/tpu_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/ux_utils.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/sky/utils/validator.py` & `skypilot-nightly-1.0.0.dev20230802/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/PKG-INFO` & `skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot-nightly
-Version: 1.0.0.dev20230801
+Version: 1.0.0.dev20230802
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230801
+Metadata-Version: 2.1 Name: skypilot-nightly Version: 1.0.0.dev20230802
 Summary: SkyPilot: An intercloud broker for the clouds Author: SkyPilot Team
 License: Apache 2.0 Project-URL: Homepage, https://github.com/skypilot-org/
 skypilot Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
 Classifier: Programming Language :: Python :: 3.7 Classifier: Programming
 Language :: Python :: 3.8 Classifier: Programming Language :: Python :: 3.9
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/SOURCES.txt` & `skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/skypilot_nightly.egg-info/requires.txt` & `skypilot-nightly-1.0.0.dev20230802/skypilot_nightly.egg-info/requires.txt`

 * *Files 8% similar despite different names*

```diff
@@ -52,14 +52,15 @@
 azure-identity>=1.13.0
 azure-mgmt-network
 google-api-python-client
 google-cloud-storage
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
+ibm-cos-sdk
 docker
 oci
 
 [aws]
 urllib3<2
 awscli>=1.27.10
 botocore>=1.29.10
@@ -86,14 +87,15 @@
 google-api-python-client
 google-cloud-storage
 
 [ibm]
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
+ibm-cos-sdk
 
 [lambda]
 
 [oci]
 oci
 
 [scp]
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_cli.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_cli.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_config.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_jobs.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_list_accelerators.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_list_accelerators.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_onprem.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_onprem.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_optimizer_dryruns.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_dryruns.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_optimizer_random_dag.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_smoke.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_smoke.py`

 * *Files 2% similar despite different names*

```diff
@@ -55,8390 +55,8752 @@
 00000360: 7274 2077 6172 6e69 6e67 730a 0a69 6d70  rt warnings..imp
 00000370: 6f72 7420 636f 6c6f 7261 6d61 0a69 6d70  ort colorama.imp
 00000380: 6f72 7420 6a69 6e6a 6132 0a69 6d70 6f72  ort jinja2.impor
 00000390: 7420 7079 7465 7374 0a0a 696d 706f 7274  t pytest..import
 000003a0: 2073 6b79 0a66 726f 6d20 736b 7920 696d   sky.from sky im
 000003b0: 706f 7274 2067 6c6f 6261 6c5f 7573 6572  port global_user
 000003c0: 5f73 7461 7465 0a66 726f 6d20 736b 792e  _state.from sky.
-000003d0: 6461 7461 2069 6d70 6f72 7420 6461 7461  data import data
-000003e0: 5f75 7469 6c73 0a66 726f 6d20 736b 792e  _utils.from sky.
-000003f0: 6461 7461 2069 6d70 6f72 7420 7374 6f72  data import stor
-00000400: 6167 6520 6173 2073 746f 7261 6765 5f6c  age as storage_l
-00000410: 6962 0a66 726f 6d20 736b 792e 6164 6170  ib.from sky.adap
-00000420: 746f 7273 2069 6d70 6f72 7420 636c 6f75  tors import clou
-00000430: 6466 6c61 7265 0a66 726f 6d20 736b 792e  dflare.from sky.
-00000440: 736b 796c 6574 2069 6d70 6f72 7420 6576  skylet import ev
-00000450: 656e 7473 0a66 726f 6d20 736b 792e 7574  ents.from sky.ut
-00000460: 696c 7320 696d 706f 7274 2063 6f6d 6d6f  ils import commo
-00000470: 6e5f 7574 696c 730a 6672 6f6d 2073 6b79  n_utils.from sky
-00000480: 2e75 7469 6c73 2069 6d70 6f72 7420 7375  .utils import su
-00000490: 6270 726f 6365 7373 5f75 7469 6c73 0a66  bprocess_utils.f
-000004a0: 726f 6d20 736b 792e 636c 6f75 6473 2069  rom sky.clouds i
-000004b0: 6d70 6f72 7420 4157 532c 2047 4350 2c20  mport AWS, GCP, 
-000004c0: 417a 7572 650a 0a23 2046 6f72 2075 6e69  Azure..# For uni
-000004d0: 7175 6566 7969 6e67 2075 7365 7273 206f  quefying users o
-000004e0: 6e20 7368 6172 6564 2d61 6363 6f75 6e74  n shared-account
-000004f0: 2063 6c6f 7564 2070 726f 7669 6465 7273   cloud providers
-00000500: 2e20 5573 6564 2061 7320 7061 7274 206f  . Used as part o
-00000510: 6620 7468 650a 2320 636c 7573 7465 7220  f the.# cluster 
-00000520: 6e61 6d65 732e 0a5f 736d 6f6b 655f 7465  names.._smoke_te
-00000530: 7374 5f68 6173 6820 3d20 6861 7368 6c69  st_hash = hashli
-00000540: 622e 6d64 3528 0a20 2020 2063 6f6d 6d6f  b.md5(.    commo
-00000550: 6e5f 7574 696c 732e 7573 6572 5f61 6e64  n_utils.user_and
-00000560: 5f68 6f73 746e 616d 655f 6861 7368 2829  _hostname_hash()
-00000570: 2e65 6e63 6f64 6528 2929 2e68 6578 6469  .encode()).hexdi
-00000580: 6765 7374 2829 5b3a 345d 0a0a 2320 546f  gest()[:4]..# To
-00000590: 2061 766f 6964 2074 6865 2073 6563 6f6e   avoid the secon
-000005a0: 6420 736d 6f6b 6520 7465 7374 2072 6575  d smoke test reu
-000005b0: 7369 6e67 2074 6865 2063 6c75 7374 6572  sing the cluster
-000005c0: 206c 6175 6e63 6865 6420 696e 2074 6865   launched in the
-000005d0: 2066 6972 7374 0a23 2073 6d6f 6b65 2074   first.# smoke t
-000005e0: 6573 742e 2041 6c73 6f20 7265 7175 6972  est. Also requir
-000005f0: 6564 2066 6f72 2074 6573 745f 7370 6f74  ed for test_spot
-00000600: 5f72 6563 6f76 6572 7920 746f 206d 616b  _recovery to mak
-00000610: 6520 7375 7265 2074 6865 206d 616e 7561  e sure the manua
-00000620: 6c0a 2320 7465 726d 696e 6174 696f 6e20  l.# termination 
-00000630: 7769 7468 2061 7773 2065 6332 2064 6f65  with aws ec2 doe
-00000640: 7320 6e6f 7420 6163 6369 6465 6e74 616c  s not accidental
-00000650: 6c79 2074 6572 6d69 6e61 7465 206f 7468  ly terminate oth
-00000660: 6572 2073 706f 7420 636c 7573 7465 7273  er spot clusters
-00000670: 0a23 2066 726f 6d20 7468 6520 6469 6666  .# from the diff
-00000680: 6572 656e 7420 7370 6f74 206c 6175 6e63  erent spot launc
-00000690: 6820 7769 7468 2074 6865 2073 616d 6520  h with the same 
-000006a0: 636c 7573 7465 7220 6e61 6d65 2062 7574  cluster name but
-000006b0: 2061 2064 6966 6665 7265 6e74 206a 6f62   a different job
-000006c0: 0a23 2069 642e 0a74 6573 745f 6964 203d  .# id..test_id =
-000006d0: 2073 7472 2875 7569 642e 7575 6964 3428   str(uuid.uuid4(
-000006e0: 2929 5b2d 323a 5d0a 0a4c 414d 4244 415f  ))[-2:]..LAMBDA_
-000006f0: 5459 5045 203d 2027 2d2d 636c 6f75 6420  TYPE = '--cloud 
-00000700: 6c61 6d62 6461 202d 2d67 7075 7320 4131  lambda --gpus A1
-00000710: 3027 0a0a 5343 505f 5459 5045 203d 2027  0'..SCP_TYPE = '
-00000720: 2d2d 636c 6f75 6420 7363 7027 0a53 4350  --cloud scp'.SCP
-00000730: 5f47 5055 5f56 3130 3020 3d20 272d 2d67  _GPU_V100 = '--g
-00000740: 7075 7320 5631 3030 2d33 3247 4227 0a0a  pus V100-32GB'..
-00000750: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
-00000760: 6d6d 616e 6473 203d 205b 0a20 2020 2027  mmands = [.    '
-00000770: 746f 7563 6820 7e2f 746d 7066 696c 6527  touch ~/tmpfile'
-00000780: 2c20 276d 6b64 6972 202d 7020 7e2f 746d  , 'mkdir -p ~/tm
-00000790: 702d 776f 726b 6469 7227 2c0a 2020 2020  p-workdir',.    
-000007a0: 2774 6f75 6368 207e 2f74 6d70 2d77 6f72  'touch ~/tmp-wor
-000007b0: 6b64 6972 2f74 6d70 5c20 6669 6c65 272c  kdir/tmp\ file',
-000007c0: 2027 746f 7563 6820 7e2f 746d 702d 776f   'touch ~/tmp-wo
-000007d0: 726b 6469 722f 746d 705c 2066 696c 6532  rkdir/tmp\ file2
-000007e0: 272c 0a20 2020 2027 746f 7563 6820 7e2f  ',.    'touch ~/
-000007f0: 746d 702d 776f 726b 6469 722f 666f 6f27  tmp-workdir/foo'
-00000800: 2c0a 2020 2020 276c 6e20 2d66 202d 7320  ,.    'ln -f -s 
-00000810: 7e2f 746d 702d 776f 726b 6469 722f 207e  ~/tmp-workdir/ ~
-00000820: 2f74 6d70 2d77 6f72 6b64 6972 2f63 6972  /tmp-workdir/cir
-00000830: 636c 652d 6c69 6e6b 272c 0a20 2020 2027  cle-link',.    '
-00000840: 746f 7563 6820 7e2f 2e73 7368 2f69 645f  touch ~/.ssh/id_
-00000850: 7273 612e 7075 6227 0a5d 0a0a 2320 5761  rsa.pub'.]..# Wa
-00000860: 6974 2075 6e74 696c 2074 6865 2073 706f  it until the spo
-00000870: 7420 636f 6e74 726f 6c6c 6572 2069 7320  t controller is 
-00000880: 6e6f 7420 696e 2049 4e49 5420 7374 6174  not in INIT stat
-00000890: 652e 0a23 2054 6869 7320 6973 2061 2077  e..# This is a w
-000008a0: 6f72 6b61 726f 756e 6420 666f 7220 7468  orkaround for th
-000008b0: 6520 6973 7375 6520 7468 6174 2077 6865  e issue that whe
-000008c0: 6e20 6d75 6c74 6970 6c65 2073 706f 7420  n multiple spot 
-000008d0: 7465 7374 730a 2320 6172 6520 7275 6e6e  tests.# are runn
-000008e0: 696e 6720 696e 2070 6172 616c 6c65 6c2c  ing in parallel,
-000008f0: 2074 6865 2073 706f 7420 636f 6e74 726f   the spot contro
-00000900: 6c6c 6572 206d 6179 2062 6520 696e 2049  ller may be in I
-00000910: 4e49 5420 616e 640a 2320 7468 6520 7370  NIT and.# the sp
-00000920: 6f74 2071 7565 7565 2f63 616e 6365 6c20  ot queue/cancel 
-00000930: 636f 6d6d 616e 6420 7769 6c6c 2072 6574  command will ret
-00000940: 7572 6e20 7374 616c 6564 2074 6162 6c65  urn staled table
-00000950: 2e0a 5f53 504f 545f 5155 4555 455f 5741  .._SPOT_QUEUE_WA
-00000960: 4954 203d 2028 2773 3d24 2873 6b79 2073  IT = ('s=$(sky s
-00000970: 706f 7420 7175 6575 6529 3b20 270a 2020  pot queue); '.  
-00000980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000990: 2020 2775 6e74 696c 205b 2060 6563 686f    'until [ `echo
-000009a0: 2022 2473 2220 270a 2020 2020 2020 2020   "$s" '.        
-000009b0: 2020 2020 2020 2020 2020 2020 277c 2067              '| g
-000009c0: 7265 7020 226a 6f62 7320 7769 6c6c 206e  rep "jobs will n
-000009d0: 6f74 2062 6520 7368 6f77 6e20 756e 7469  ot be shown unti
-000009e0: 6c20 6974 2062 6563 6f6d 6573 2055 502e  l it becomes UP.
-000009f0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
-00000a00: 2020 2020 2020 2020 277c 2077 6320 2d6c          '| wc -l
-00000a10: 6020 2d65 7120 3020 5d3b 2027 0a20 2020  ` -eq 0 ]; '.   
-00000a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000a30: 2027 646f 2065 6368 6f20 2257 6169 7469   'do echo "Waiti
-00000a40: 6e67 2066 6f72 2073 706f 7420 7175 6575  ng for spot queu
-00000a50: 6520 746f 2062 6520 7265 6164 792e 2e2e  e to be ready...
-00000a60: 223b 2027 0a20 2020 2020 2020 2020 2020  "; '.           
-00000a70: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00000a80: 353b 2073 3d24 2873 6b79 2073 706f 7420  5; s=$(sky spot 
-00000a90: 7175 6575 6529 3b20 646f 6e65 3b20 6563  queue); done; ec
-00000aa0: 686f 2022 2473 223b 2027 0a20 2020 2020  ho "$s"; '.     
-00000ab0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00000ac0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-00000ad0: 2022 2473 2227 290a 5f53 504f 545f 4341   "$s"')._SPOT_CA
-00000ae0: 4e43 454c 5f57 4149 5420 3d20 280a 2020  NCEL_WAIT = (.  
-00000af0: 2020 2773 3d24 2873 6b79 2073 706f 7420    's=$(sky spot 
-00000b00: 6361 6e63 656c 202d 7920 2d6e 207b 6a6f  cancel -y -n {jo
-00000b10: 625f 6e61 6d65 7d29 3b20 756e 7469 6c20  b_name}); until 
-00000b20: 5b20 6065 6368 6f20 2224 7322 2027 0a20  [ `echo "$s" '. 
-00000b30: 2020 2027 7c20 6772 6570 2022 506c 6561     '| grep "Plea
-00000b40: 7365 2077 6169 7420 666f 7220 7468 6520  se wait for the 
-00000b50: 636f 6e74 726f 6c6c 6572 2074 6f20 6265  controller to be
-00000b60: 2072 6561 6479 2e22 2027 0a20 2020 2027   ready." '.    '
-00000b70: 7c20 7763 202d 6c60 202d 6571 2030 205d  | wc -l` -eq 0 ]
-00000b80: 3b20 646f 2065 6368 6f20 2257 6169 7469  ; do echo "Waiti
-00000b90: 6e67 2066 6f72 2074 6865 2073 706f 7420  ng for the spot 
-00000ba0: 636f 6e74 726f 6c6c 6572 2027 0a20 2020  controller '.   
-00000bb0: 2027 746f 2062 6520 7265 6164 7922 3b20   'to be ready"; 
-00000bc0: 736c 6565 7020 353b 2073 3d24 2873 6b79  sleep 5; s=$(sky
-00000bd0: 2073 706f 7420 6361 6e63 656c 202d 7920   spot cancel -y 
-00000be0: 2d6e 207b 6a6f 625f 6e61 6d65 7d29 3b20  -n {job_name}); 
-00000bf0: 270a 2020 2020 2764 6f6e 653b 2065 6368  '.    'done; ech
-00000c00: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-00000c10: 686f 3b20 6563 686f 2022 2473 2227 290a  ho; echo "$s"').
-00000c20: 2320 544f 444f 287a 6877 7529 3a20 6d61  # TODO(zhwu): ma
-00000c30: 6b65 2074 6865 2073 706f 7420 636f 6e74  ke the spot cont
-00000c40: 726f 6c6c 6572 206f 6e20 4743 502e 0a0a  roller on GCP...
-00000c50: 0a63 6c61 7373 2054 6573 7428 4e61 6d65  .class Test(Name
-00000c60: 6454 7570 6c65 293a 0a20 2020 206e 616d  dTuple):.    nam
-00000c70: 653a 2073 7472 0a20 2020 2023 2045 6163  e: str.    # Eac
-00000c80: 6820 636f 6d6d 616e 6420 6973 2065 7865  h command is exe
-00000c90: 6375 7465 6420 7365 7269 616c 6c79 2e20  cuted serially. 
-00000ca0: 2049 6620 616e 7920 6661 696c 6564 2c20   If any failed, 
-00000cb0: 7468 6520 7265 6d61 696e 696e 6720 636f  the remaining co
-00000cc0: 6d6d 616e 6473 0a20 2020 2023 2061 7265  mmands.    # are
-00000cd0: 206e 6f74 2072 756e 2061 6e64 2074 6865   not run and the
-00000ce0: 2074 6573 7420 6973 2074 7265 6174 6564   test is treated
-00000cf0: 2061 7320 6661 696c 6564 2e0a 2020 2020   as failed..    
-00000d00: 636f 6d6d 616e 6473 3a20 4c69 7374 5b73  commands: List[s
-00000d10: 7472 5d0a 2020 2020 7465 6172 646f 776e  tr].    teardown
-00000d20: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00000d30: 3d20 4e6f 6e65 0a20 2020 2023 2054 696d  = None.    # Tim
-00000d40: 656f 7574 2066 6f72 2065 6163 6820 636f  eout for each co
-00000d50: 6d6d 616e 6420 696e 2073 6563 6f6e 6473  mmand in seconds
-00000d60: 2e0a 2020 2020 7469 6d65 6f75 743a 2069  ..    timeout: i
-00000d70: 6e74 203d 2031 3520 2a20 3630 0a0a 2020  nt = 15 * 60..  
-00000d80: 2020 6465 6620 6563 686f 2873 656c 662c    def echo(self,
-00000d90: 206d 6573 7361 6765 3a20 7374 7229 3a0a   message: str):.
-00000da0: 2020 2020 2020 2020 2320 7079 7465 7374          # pytest
-00000db0: 2773 2078 6469 7374 2070 6c75 6769 6e20  's xdist plugin 
-00000dc0: 6361 7074 7572 6573 2073 7464 6f75 743b  captures stdout;
-00000dd0: 2070 7269 6e74 2074 6f20 7374 6465 7272   print to stderr
-00000de0: 2073 6f20 7468 6174 2074 6865 0a20 2020   so that the.   
-00000df0: 2020 2020 2023 206c 6f67 7320 6172 6520       # logs are 
-00000e00: 7374 7265 616d 696e 6720 7768 696c 6520  streaming while 
-00000e10: 7468 6520 7465 7374 7320 6172 6520 7275  the tests are ru
-00000e20: 6e6e 696e 672e 0a20 2020 2020 2020 2070  nning..        p
-00000e30: 7265 6669 7820 3d20 6627 5b7b 7365 6c66  refix = f'[{self
-00000e40: 2e6e 616d 657d 5d27 0a20 2020 2020 2020  .name}]'.       
-00000e50: 206d 6573 7361 6765 203d 2066 277b 7072   message = f'{pr
-00000e60: 6566 6978 7d20 7b6d 6573 7361 6765 7d27  efix} {message}'
-00000e70: 0a20 2020 2020 2020 206d 6573 7361 6765  .        message
-00000e80: 203d 206d 6573 7361 6765 2e72 6570 6c61   = message.repla
-00000e90: 6365 2827 5c6e 272c 2066 275c 6e7b 7072  ce('\n', f'\n{pr
-00000ea0: 6566 6978 7d20 2729 0a20 2020 2020 2020  efix} ').       
-00000eb0: 2070 7269 6e74 286d 6573 7361 6765 2c20   print(message, 
-00000ec0: 6669 6c65 3d73 7973 2e73 7464 6572 722c  file=sys.stderr,
-00000ed0: 2066 6c75 7368 3d54 7275 6529 0a0a 0a64   flush=True)...d
-00000ee0: 6566 205f 6765 745f 636c 7573 7465 725f  ef _get_cluster_
-00000ef0: 6e61 6d65 2829 202d 3e20 7374 723a 0a20  name() -> str:. 
-00000f00: 2020 2022 2222 5265 7475 726e 7320 6120     """Returns a 
-00000f10: 7573 6572 2d75 6e69 7175 6520 636c 7573  user-unique clus
-00000f20: 7465 7220 6e61 6d65 2066 6f72 2065 6163  ter name for eac
-00000f30: 6820 7465 7374 5f3c 6e61 6d65 3e28 292e  h test_<name>().
-00000f40: 0a0a 2020 2020 4d75 7374 2062 6520 6361  ..    Must be ca
-00000f50: 6c6c 6564 2066 726f 6d20 6561 6368 2074  lled from each t
-00000f60: 6573 745f 3c6e 616d 653e 2829 2e0a 2020  est_<name>()..  
-00000f70: 2020 2222 220a 2020 2020 6361 6c6c 6572    """.    caller
-00000f80: 5f66 756e 635f 6e61 6d65 203d 2069 6e73  _func_name = ins
-00000f90: 7065 6374 2e73 7461 636b 2829 5b31 5d5b  pect.stack()[1][
-00000fa0: 335d 0a20 2020 2074 6573 745f 6e61 6d65  3].    test_name
-00000fb0: 203d 2063 616c 6c65 725f 6675 6e63 5f6e   = caller_func_n
-00000fc0: 616d 652e 7265 706c 6163 6528 275f 272c  ame.replace('_',
-00000fd0: 2027 2d27 292e 7265 706c 6163 6528 2774   '-').replace('t
-00000fe0: 6573 742d 272c 2027 742d 2729 0a20 2020  est-', 't-').   
-00000ff0: 2069 6620 6c65 6e28 7465 7374 5f6e 616d   if len(test_nam
-00001000: 6529 203e 2031 363a 0a20 2020 2020 2020  e) > 16:.       
-00001010: 2074 6573 745f 6e61 6d65 203d 2074 6573   test_name = tes
-00001020: 745f 6e61 6d65 5b3a 3136 5d20 2b20 6861  t_name[:16] + ha
-00001030: 7368 6c69 622e 6d64 3528 0a20 2020 2020  shlib.md5(.     
-00001040: 2020 2020 2020 2074 6573 745f 6e61 6d65         test_name
-00001050: 2e65 6e63 6f64 6528 2929 2e68 6578 6469  .encode()).hexdi
-00001060: 6765 7374 2829 5b3a 335d 0a20 2020 2072  gest()[:3].    r
-00001070: 6574 7572 6e20 6627 7b74 6573 745f 6e61  eturn f'{test_na
-00001080: 6d65 7d2d 7b5f 736d 6f6b 655f 7465 7374  me}-{_smoke_test
-00001090: 5f68 6173 687d 2d7b 7465 7374 5f69 647d  _hash}-{test_id}
-000010a0: 270a 0a0a 6465 6620 7275 6e5f 6f6e 655f  '...def run_one_
-000010b0: 7465 7374 2874 6573 743a 2054 6573 7429  test(test: Test)
-000010c0: 202d 3e20 5475 706c 655b 696e 742c 2073   -> Tuple[int, s
-000010d0: 7472 2c20 7374 725d 3a0a 2020 2020 2320  tr, str]:.    # 
-000010e0: 4661 696c 2066 6173 7420 6966 2060 736b  Fail fast if `sk
-000010f0: 7960 2043 4c49 2073 6f6d 6568 6f77 2065  y` CLI somehow e
-00001100: 7272 6f72 7320 6f75 742e 0a20 2020 2073  rrors out..    s
-00001110: 7562 7072 6f63 6573 732e 7275 6e28 5b27  ubprocess.run(['
-00001120: 736b 7927 2c20 2773 7461 7475 7327 5d2c  sky', 'status'],
-00001130: 2073 7464 6f75 743d 7375 6270 726f 6365   stdout=subproce
-00001140: 7373 2e44 4556 4e55 4c4c 2c20 6368 6563  ss.DEVNULL, chec
-00001150: 6b3d 5472 7565 290a 2020 2020 6c6f 675f  k=True).    log_
-00001160: 6669 6c65 203d 2074 656d 7066 696c 652e  file = tempfile.
-00001170: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
-00001180: 6c65 2827 6127 2c0a 2020 2020 2020 2020  le('a',.        
-00001190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011b0: 2020 2070 7265 6669 783d 6627 7b74 6573     prefix=f'{tes
-000011c0: 742e 6e61 6d65 7d2d 272c 0a20 2020 2020  t.name}-',.     
+000003d0: 6164 6170 746f 7273 2069 6d70 6f72 7420  adaptors import 
+000003e0: 6962 6d0a 6672 6f6d 2073 6b79 2e61 6461  ibm.from sky.ada
+000003f0: 7074 6f72 7320 696d 706f 7274 2063 6c6f  ptors import clo
+00000400: 7564 666c 6172 650a 6672 6f6d 2073 6b79  udflare.from sky
+00000410: 2e63 6c6f 7564 7320 696d 706f 7274 2041  .clouds import A
+00000420: 5753 2c20 4743 502c 2041 7a75 7265 0a66  WS, GCP, Azure.f
+00000430: 726f 6d20 736b 792e 6461 7461 2069 6d70  rom sky.data imp
+00000440: 6f72 7420 6461 7461 5f75 7469 6c73 0a66  ort data_utils.f
+00000450: 726f 6d20 736b 792e 6461 7461 2069 6d70  rom sky.data imp
+00000460: 6f72 7420 7374 6f72 6167 6520 6173 2073  ort storage as s
+00000470: 746f 7261 6765 5f6c 6962 0a66 726f 6d20  torage_lib.from 
+00000480: 736b 792e 6461 7461 2e64 6174 615f 7574  sky.data.data_ut
+00000490: 696c 7320 696d 706f 7274 2052 636c 6f6e  ils import Rclon
+000004a0: 650a 6672 6f6d 2073 6b79 2e73 6b79 6c65  e.from sky.skyle
+000004b0: 7420 696d 706f 7274 2065 7665 6e74 730a  t import events.
+000004c0: 6672 6f6d 2073 6b79 2e75 7469 6c73 2069  from sky.utils i
+000004d0: 6d70 6f72 7420 636f 6d6d 6f6e 5f75 7469  mport common_uti
+000004e0: 6c73 0a66 726f 6d20 736b 792e 7574 696c  ls.from sky.util
+000004f0: 7320 696d 706f 7274 2073 7562 7072 6f63  s import subproc
+00000500: 6573 735f 7574 696c 730a 0a23 2046 6f72  ess_utils..# For
+00000510: 2075 6e69 7175 6566 7969 6e67 2075 7365   uniquefying use
+00000520: 7273 206f 6e20 7368 6172 6564 2d61 6363  rs on shared-acc
+00000530: 6f75 6e74 2063 6c6f 7564 2070 726f 7669  ount cloud provi
+00000540: 6465 7273 2e20 5573 6564 2061 7320 7061  ders. Used as pa
+00000550: 7274 206f 6620 7468 650a 2320 636c 7573  rt of the.# clus
+00000560: 7465 7220 6e61 6d65 732e 0a5f 736d 6f6b  ter names.._smok
+00000570: 655f 7465 7374 5f68 6173 6820 3d20 6861  e_test_hash = ha
+00000580: 7368 6c69 622e 6d64 3528 0a20 2020 2063  shlib.md5(.    c
+00000590: 6f6d 6d6f 6e5f 7574 696c 732e 7573 6572  ommon_utils.user
+000005a0: 5f61 6e64 5f68 6f73 746e 616d 655f 6861  _and_hostname_ha
+000005b0: 7368 2829 2e65 6e63 6f64 6528 2929 2e68  sh().encode()).h
+000005c0: 6578 6469 6765 7374 2829 5b3a 345d 0a0a  exdigest()[:4]..
+000005d0: 2320 546f 2061 766f 6964 2074 6865 2073  # To avoid the s
+000005e0: 6563 6f6e 6420 736d 6f6b 6520 7465 7374  econd smoke test
+000005f0: 2072 6575 7369 6e67 2074 6865 2063 6c75   reusing the clu
+00000600: 7374 6572 206c 6175 6e63 6865 6420 696e  ster launched in
+00000610: 2074 6865 2066 6972 7374 0a23 2073 6d6f   the first.# smo
+00000620: 6b65 2074 6573 742e 2041 6c73 6f20 7265  ke test. Also re
+00000630: 7175 6972 6564 2066 6f72 2074 6573 745f  quired for test_
+00000640: 7370 6f74 5f72 6563 6f76 6572 7920 746f  spot_recovery to
+00000650: 206d 616b 6520 7375 7265 2074 6865 206d   make sure the m
+00000660: 616e 7561 6c0a 2320 7465 726d 696e 6174  anual.# terminat
+00000670: 696f 6e20 7769 7468 2061 7773 2065 6332  ion with aws ec2
+00000680: 2064 6f65 7320 6e6f 7420 6163 6369 6465   does not accide
+00000690: 6e74 616c 6c79 2074 6572 6d69 6e61 7465  ntally terminate
+000006a0: 206f 7468 6572 2073 706f 7420 636c 7573   other spot clus
+000006b0: 7465 7273 0a23 2066 726f 6d20 7468 6520  ters.# from the 
+000006c0: 6469 6666 6572 656e 7420 7370 6f74 206c  different spot l
+000006d0: 6175 6e63 6820 7769 7468 2074 6865 2073  aunch with the s
+000006e0: 616d 6520 636c 7573 7465 7220 6e61 6d65  ame cluster name
+000006f0: 2062 7574 2061 2064 6966 6665 7265 6e74   but a different
+00000700: 206a 6f62 0a23 2069 642e 0a74 6573 745f   job.# id..test_
+00000710: 6964 203d 2073 7472 2875 7569 642e 7575  id = str(uuid.uu
+00000720: 6964 3428 2929 5b2d 323a 5d0a 0a4c 414d  id4())[-2:]..LAM
+00000730: 4244 415f 5459 5045 203d 2027 2d2d 636c  BDA_TYPE = '--cl
+00000740: 6f75 6420 6c61 6d62 6461 202d 2d67 7075  oud lambda --gpu
+00000750: 7320 4131 3027 0a0a 5343 505f 5459 5045  s A10'..SCP_TYPE
+00000760: 203d 2027 2d2d 636c 6f75 6420 7363 7027   = '--cloud scp'
+00000770: 0a53 4350 5f47 5055 5f56 3130 3020 3d20  .SCP_GPU_V100 = 
+00000780: 272d 2d67 7075 7320 5631 3030 2d33 3247  '--gpus V100-32G
+00000790: 4227 0a0a 7374 6f72 6167 655f 7365 7475  B'..storage_setu
+000007a0: 705f 636f 6d6d 616e 6473 203d 205b 0a20  p_commands = [. 
+000007b0: 2020 2027 746f 7563 6820 7e2f 746d 7066     'touch ~/tmpf
+000007c0: 696c 6527 2c20 276d 6b64 6972 202d 7020  ile', 'mkdir -p 
+000007d0: 7e2f 746d 702d 776f 726b 6469 7227 2c0a  ~/tmp-workdir',.
+000007e0: 2020 2020 2774 6f75 6368 207e 2f74 6d70      'touch ~/tmp
+000007f0: 2d77 6f72 6b64 6972 2f74 6d70 5c20 6669  -workdir/tmp\ fi
+00000800: 6c65 272c 2027 746f 7563 6820 7e2f 746d  le', 'touch ~/tm
+00000810: 702d 776f 726b 6469 722f 746d 705c 2066  p-workdir/tmp\ f
+00000820: 696c 6532 272c 0a20 2020 2027 746f 7563  ile2',.    'touc
+00000830: 6820 7e2f 746d 702d 776f 726b 6469 722f  h ~/tmp-workdir/
+00000840: 666f 6f27 2c0a 2020 2020 276c 6e20 2d66  foo',.    'ln -f
+00000850: 202d 7320 7e2f 746d 702d 776f 726b 6469   -s ~/tmp-workdi
+00000860: 722f 207e 2f74 6d70 2d77 6f72 6b64 6972  r/ ~/tmp-workdir
+00000870: 2f63 6972 636c 652d 6c69 6e6b 272c 0a20  /circle-link',. 
+00000880: 2020 2027 746f 7563 6820 7e2f 2e73 7368     'touch ~/.ssh
+00000890: 2f69 645f 7273 612e 7075 6227 0a5d 0a0a  /id_rsa.pub'.]..
+000008a0: 2320 5761 6974 2075 6e74 696c 2074 6865  # Wait until the
+000008b0: 2073 706f 7420 636f 6e74 726f 6c6c 6572   spot controller
+000008c0: 2069 7320 6e6f 7420 696e 2049 4e49 5420   is not in INIT 
+000008d0: 7374 6174 652e 0a23 2054 6869 7320 6973  state..# This is
+000008e0: 2061 2077 6f72 6b61 726f 756e 6420 666f   a workaround fo
+000008f0: 7220 7468 6520 6973 7375 6520 7468 6174  r the issue that
+00000900: 2077 6865 6e20 6d75 6c74 6970 6c65 2073   when multiple s
+00000910: 706f 7420 7465 7374 730a 2320 6172 6520  pot tests.# are 
+00000920: 7275 6e6e 696e 6720 696e 2070 6172 616c  running in paral
+00000930: 6c65 6c2c 2074 6865 2073 706f 7420 636f  lel, the spot co
+00000940: 6e74 726f 6c6c 6572 206d 6179 2062 6520  ntroller may be 
+00000950: 696e 2049 4e49 5420 616e 640a 2320 7468  in INIT and.# th
+00000960: 6520 7370 6f74 2071 7565 7565 2f63 616e  e spot queue/can
+00000970: 6365 6c20 636f 6d6d 616e 6420 7769 6c6c  cel command will
+00000980: 2072 6574 7572 6e20 7374 616c 6564 2074   return staled t
+00000990: 6162 6c65 2e0a 5f53 504f 545f 5155 4555  able.._SPOT_QUEU
+000009a0: 455f 5741 4954 203d 2028 2773 3d24 2873  E_WAIT = ('s=$(s
+000009b0: 6b79 2073 706f 7420 7175 6575 6529 3b20  ky spot queue); 
+000009c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000009d0: 2020 2020 2020 2775 6e74 696c 205b 2060        'until [ `
+000009e0: 6563 686f 2022 2473 2220 270a 2020 2020  echo "$s" '.    
+000009f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a00: 277c 2067 7265 7020 226a 6f62 7320 7769  '| grep "jobs wi
+00000a10: 6c6c 206e 6f74 2062 6520 7368 6f77 6e20  ll not be shown 
+00000a20: 756e 7469 6c20 6974 2062 6563 6f6d 6573  until it becomes
+00000a30: 2055 502e 2220 270a 2020 2020 2020 2020   UP." '.        
+00000a40: 2020 2020 2020 2020 2020 2020 277c 2077              '| w
+00000a50: 6320 2d6c 6020 2d65 7120 3020 5d3b 2027  c -l` -eq 0 ]; '
+00000a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000a70: 2020 2020 2027 646f 2065 6368 6f20 2257       'do echo "W
+00000a80: 6169 7469 6e67 2066 6f72 2073 706f 7420  aiting for spot 
+00000a90: 7175 6575 6520 746f 2062 6520 7265 6164  queue to be read
+00000aa0: 792e 2e2e 223b 2027 0a20 2020 2020 2020  y..."; '.       
+00000ab0: 2020 2020 2020 2020 2020 2020 2027 736c               'sl
+00000ac0: 6565 7020 353b 2073 3d24 2873 6b79 2073  eep 5; s=$(sky s
+00000ad0: 706f 7420 7175 6575 6529 3b20 646f 6e65  pot queue); done
+00000ae0: 3b20 6563 686f 2022 2473 223b 2027 0a20  ; echo "$s"; '. 
+00000af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000b00: 2020 2027 6563 686f 3b20 6563 686f 3b20     'echo; echo; 
+00000b10: 6563 686f 2022 2473 2227 290a 5f53 504f  echo "$s"')._SPO
+00000b20: 545f 4341 4e43 454c 5f57 4149 5420 3d20  T_CANCEL_WAIT = 
+00000b30: 280a 2020 2020 2773 3d24 2873 6b79 2073  (.    's=$(sky s
+00000b40: 706f 7420 6361 6e63 656c 202d 7920 2d6e  pot cancel -y -n
+00000b50: 207b 6a6f 625f 6e61 6d65 7d29 3b20 756e   {job_name}); un
+00000b60: 7469 6c20 5b20 6065 6368 6f20 2224 7322  til [ `echo "$s"
+00000b70: 2027 0a20 2020 2027 7c20 6772 6570 2022   '.    '| grep "
+00000b80: 506c 6561 7365 2077 6169 7420 666f 7220  Please wait for 
+00000b90: 7468 6520 636f 6e74 726f 6c6c 6572 2074  the controller t
+00000ba0: 6f20 6265 2072 6561 6479 2e22 2027 0a20  o be ready." '. 
+00000bb0: 2020 2027 7c20 7763 202d 6c60 202d 6571     '| wc -l` -eq
+00000bc0: 2030 205d 3b20 646f 2065 6368 6f20 2257   0 ]; do echo "W
+00000bd0: 6169 7469 6e67 2066 6f72 2074 6865 2073  aiting for the s
+00000be0: 706f 7420 636f 6e74 726f 6c6c 6572 2027  pot controller '
+00000bf0: 0a20 2020 2027 746f 2062 6520 7265 6164  .    'to be read
+00000c00: 7922 3b20 736c 6565 7020 353b 2073 3d24  y"; sleep 5; s=$
+00000c10: 2873 6b79 2073 706f 7420 6361 6e63 656c  (sky spot cancel
+00000c20: 202d 7920 2d6e 207b 6a6f 625f 6e61 6d65   -y -n {job_name
+00000c30: 7d29 3b20 270a 2020 2020 2764 6f6e 653b  }); '.    'done;
+00000c40: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+00000c50: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+00000c60: 2227 290a 2320 544f 444f 287a 6877 7529  "').# TODO(zhwu)
+00000c70: 3a20 6d61 6b65 2074 6865 2073 706f 7420  : make the spot 
+00000c80: 636f 6e74 726f 6c6c 6572 206f 6e20 4743  controller on GC
+00000c90: 502e 0a0a 0a63 6c61 7373 2054 6573 7428  P....class Test(
+00000ca0: 4e61 6d65 6454 7570 6c65 293a 0a20 2020  NamedTuple):.   
+00000cb0: 206e 616d 653a 2073 7472 0a20 2020 2023   name: str.    #
+00000cc0: 2045 6163 6820 636f 6d6d 616e 6420 6973   Each command is
+00000cd0: 2065 7865 6375 7465 6420 7365 7269 616c   executed serial
+00000ce0: 6c79 2e20 2049 6620 616e 7920 6661 696c  ly.  If any fail
+00000cf0: 6564 2c20 7468 6520 7265 6d61 696e 696e  ed, the remainin
+00000d00: 6720 636f 6d6d 616e 6473 0a20 2020 2023  g commands.    #
+00000d10: 2061 7265 206e 6f74 2072 756e 2061 6e64   are not run and
+00000d20: 2074 6865 2074 6573 7420 6973 2074 7265   the test is tre
+00000d30: 6174 6564 2061 7320 6661 696c 6564 2e0a  ated as failed..
+00000d40: 2020 2020 636f 6d6d 616e 6473 3a20 4c69      commands: Li
+00000d50: 7374 5b73 7472 5d0a 2020 2020 7465 6172  st[str].    tear
+00000d60: 646f 776e 3a20 4f70 7469 6f6e 616c 5b73  down: Optional[s
+00000d70: 7472 5d20 3d20 4e6f 6e65 0a20 2020 2023  tr] = None.    #
+00000d80: 2054 696d 656f 7574 2066 6f72 2065 6163   Timeout for eac
+00000d90: 6820 636f 6d6d 616e 6420 696e 2073 6563  h command in sec
+00000da0: 6f6e 6473 2e0a 2020 2020 7469 6d65 6f75  onds..    timeou
+00000db0: 743a 2069 6e74 203d 2031 3520 2a20 3630  t: int = 15 * 60
+00000dc0: 0a0a 2020 2020 6465 6620 6563 686f 2873  ..    def echo(s
+00000dd0: 656c 662c 206d 6573 7361 6765 3a20 7374  elf, message: st
+00000de0: 7229 3a0a 2020 2020 2020 2020 2320 7079  r):.        # py
+00000df0: 7465 7374 2773 2078 6469 7374 2070 6c75  test's xdist plu
+00000e00: 6769 6e20 6361 7074 7572 6573 2073 7464  gin captures std
+00000e10: 6f75 743b 2070 7269 6e74 2074 6f20 7374  out; print to st
+00000e20: 6465 7272 2073 6f20 7468 6174 2074 6865  derr so that the
+00000e30: 0a20 2020 2020 2020 2023 206c 6f67 7320  .        # logs 
+00000e40: 6172 6520 7374 7265 616d 696e 6720 7768  are streaming wh
+00000e50: 696c 6520 7468 6520 7465 7374 7320 6172  ile the tests ar
+00000e60: 6520 7275 6e6e 696e 672e 0a20 2020 2020  e running..     
+00000e70: 2020 2070 7265 6669 7820 3d20 6627 5b7b     prefix = f'[{
+00000e80: 7365 6c66 2e6e 616d 657d 5d27 0a20 2020  self.name}]'.   
+00000e90: 2020 2020 206d 6573 7361 6765 203d 2066       message = f
+00000ea0: 277b 7072 6566 6978 7d20 7b6d 6573 7361  '{prefix} {messa
+00000eb0: 6765 7d27 0a20 2020 2020 2020 206d 6573  ge}'.        mes
+00000ec0: 7361 6765 203d 206d 6573 7361 6765 2e72  sage = message.r
+00000ed0: 6570 6c61 6365 2827 5c6e 272c 2066 275c  eplace('\n', f'\
+00000ee0: 6e7b 7072 6566 6978 7d20 2729 0a20 2020  n{prefix} ').   
+00000ef0: 2020 2020 2070 7269 6e74 286d 6573 7361       print(messa
+00000f00: 6765 2c20 6669 6c65 3d73 7973 2e73 7464  ge, file=sys.std
+00000f10: 6572 722c 2066 6c75 7368 3d54 7275 6529  err, flush=True)
+00000f20: 0a0a 0a64 6566 205f 6765 745f 636c 7573  ...def _get_clus
+00000f30: 7465 725f 6e61 6d65 2829 202d 3e20 7374  ter_name() -> st
+00000f40: 723a 0a20 2020 2022 2222 5265 7475 726e  r:.    """Return
+00000f50: 7320 6120 7573 6572 2d75 6e69 7175 6520  s a user-unique 
+00000f60: 636c 7573 7465 7220 6e61 6d65 2066 6f72  cluster name for
+00000f70: 2065 6163 6820 7465 7374 5f3c 6e61 6d65   each test_<name
+00000f80: 3e28 292e 0a0a 2020 2020 4d75 7374 2062  >()...    Must b
+00000f90: 6520 6361 6c6c 6564 2066 726f 6d20 6561  e called from ea
+00000fa0: 6368 2074 6573 745f 3c6e 616d 653e 2829  ch test_<name>()
+00000fb0: 2e0a 2020 2020 2222 220a 2020 2020 6361  ..    """.    ca
+00000fc0: 6c6c 6572 5f66 756e 635f 6e61 6d65 203d  ller_func_name =
+00000fd0: 2069 6e73 7065 6374 2e73 7461 636b 2829   inspect.stack()
+00000fe0: 5b31 5d5b 335d 0a20 2020 2074 6573 745f  [1][3].    test_
+00000ff0: 6e61 6d65 203d 2063 616c 6c65 725f 6675  name = caller_fu
+00001000: 6e63 5f6e 616d 652e 7265 706c 6163 6528  nc_name.replace(
+00001010: 275f 272c 2027 2d27 292e 7265 706c 6163  '_', '-').replac
+00001020: 6528 2774 6573 742d 272c 2027 742d 2729  e('test-', 't-')
+00001030: 0a20 2020 2069 6620 6c65 6e28 7465 7374  .    if len(test
+00001040: 5f6e 616d 6529 203e 2031 363a 0a20 2020  _name) > 16:.   
+00001050: 2020 2020 2074 6573 745f 6e61 6d65 203d       test_name =
+00001060: 2074 6573 745f 6e61 6d65 5b3a 3136 5d20   test_name[:16] 
+00001070: 2b20 6861 7368 6c69 622e 6d64 3528 0a20  + hashlib.md5(. 
+00001080: 2020 2020 2020 2020 2020 2074 6573 745f             test_
+00001090: 6e61 6d65 2e65 6e63 6f64 6528 2929 2e68  name.encode()).h
+000010a0: 6578 6469 6765 7374 2829 5b3a 335d 0a20  exdigest()[:3]. 
+000010b0: 2020 2072 6574 7572 6e20 6627 7b74 6573     return f'{tes
+000010c0: 745f 6e61 6d65 7d2d 7b5f 736d 6f6b 655f  t_name}-{_smoke_
+000010d0: 7465 7374 5f68 6173 687d 2d7b 7465 7374  test_hash}-{test
+000010e0: 5f69 647d 270a 0a0a 6465 6620 7275 6e5f  _id}'...def run_
+000010f0: 6f6e 655f 7465 7374 2874 6573 743a 2054  one_test(test: T
+00001100: 6573 7429 202d 3e20 5475 706c 655b 696e  est) -> Tuple[in
+00001110: 742c 2073 7472 2c20 7374 725d 3a0a 2020  t, str, str]:.  
+00001120: 2020 2320 4661 696c 2066 6173 7420 6966    # Fail fast if
+00001130: 2060 736b 7960 2043 4c49 2073 6f6d 6568   `sky` CLI someh
+00001140: 6f77 2065 7272 6f72 7320 6f75 742e 0a20  ow errors out.. 
+00001150: 2020 2073 7562 7072 6f63 6573 732e 7275     subprocess.ru
+00001160: 6e28 5b27 736b 7927 2c20 2773 7461 7475  n(['sky', 'statu
+00001170: 7327 5d2c 2073 7464 6f75 743d 7375 6270  s'], stdout=subp
+00001180: 726f 6365 7373 2e44 4556 4e55 4c4c 2c20  rocess.DEVNULL, 
+00001190: 6368 6563 6b3d 5472 7565 290a 2020 2020  check=True).    
+000011a0: 6c6f 675f 6669 6c65 203d 2074 656d 7066  log_file = tempf
+000011b0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+000011c0: 7279 4669 6c65 2827 6127 2c0a 2020 2020  ryFile('a',.    
 000011d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011f0: 2020 2020 2020 7375 6666 6978 3d27 2e6c        suffix='.l
-00001200: 6f67 272c 0a20 2020 2020 2020 2020 2020  og',.           
+000011f0: 2020 2020 2020 2070 7265 6669 783d 6627         prefix=f'
+00001200: 7b74 6573 742e 6e61 6d65 7d2d 272c 0a20  {test.name}-',. 
 00001210: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001230: 6465 6c65 7465 3d46 616c 7365 290a 2020  delete=False).  
-00001240: 2020 7465 7374 2e65 6368 6f28 6627 5465    test.echo(f'Te
-00001250: 7374 2073 7461 7274 6564 2e20 4c6f 673a  st started. Log:
-00001260: 206c 6573 7320 7b6c 6f67 5f66 696c 652e   less {log_file.
-00001270: 6e61 6d65 7d27 290a 2020 2020 666f 7220  name}').    for 
-00001280: 636f 6d6d 616e 6420 696e 2074 6573 742e  command in test.
-00001290: 636f 6d6d 616e 6473 3a0a 2020 2020 2020  commands:.      
-000012a0: 2020 6c6f 675f 6669 6c65 2e77 7269 7465    log_file.write
-000012b0: 2866 272b 207b 636f 6d6d 616e 647d 5c6e  (f'+ {command}\n
-000012c0: 2729 0a20 2020 2020 2020 206c 6f67 5f66  ').        log_f
-000012d0: 696c 652e 666c 7573 6828 290a 2020 2020  ile.flush().    
-000012e0: 2020 2020 7072 6f63 203d 2073 7562 7072      proc = subpr
-000012f0: 6f63 6573 732e 506f 7065 6e28 0a20 2020  ocess.Popen(.   
-00001300: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-00001310: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00001320: 646f 7574 3d6c 6f67 5f66 696c 652c 0a20  dout=log_file,. 
-00001330: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-00001340: 723d 7375 6270 726f 6365 7373 2e53 5444  r=subprocess.STD
-00001350: 4f55 542c 0a20 2020 2020 2020 2020 2020  OUT,.           
-00001360: 2073 6865 6c6c 3d54 7275 652c 0a20 2020   shell=True,.   
-00001370: 2020 2020 2020 2020 2065 7865 6375 7461           executa
-00001380: 626c 653d 272f 6269 6e2f 6261 7368 272c  ble='/bin/bash',
-00001390: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000013a0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000013b0: 2020 2020 7072 6f63 2e77 6169 7428 7469      proc.wait(ti
-000013c0: 6d65 6f75 743d 7465 7374 2e74 696d 656f  meout=test.timeo
-000013d0: 7574 290a 2020 2020 2020 2020 6578 6365  ut).        exce
-000013e0: 7074 2073 7562 7072 6f63 6573 732e 5469  pt subprocess.Ti
-000013f0: 6d65 6f75 7445 7870 6972 6564 2061 7320  meoutExpired as 
-00001400: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-00001410: 6f67 5f66 696c 652e 666c 7573 6828 290a  og_file.flush().
-00001420: 2020 2020 2020 2020 2020 2020 7465 7374              test
-00001430: 2e65 6368 6f28 6627 5469 6d65 6f75 7420  .echo(f'Timeout 
-00001440: 6166 7465 7220 7b74 6573 742e 7469 6d65  after {test.time
-00001450: 6f75 747d 2073 6563 6f6e 6473 2e27 290a  out} seconds.').
-00001460: 2020 2020 2020 2020 2020 2020 7465 7374              test
-00001470: 2e65 6368 6f28 7374 7228 6529 290a 2020  .echo(str(e)).  
-00001480: 2020 2020 2020 2020 2020 6c6f 675f 6669            log_fi
-00001490: 6c65 2e77 7269 7465 2866 2754 696d 656f  le.write(f'Timeo
-000014a0: 7574 2061 6674 6572 207b 7465 7374 2e74  ut after {test.t
-000014b0: 696d 656f 7574 7d20 7365 636f 6e64 732e  imeout} seconds.
-000014c0: 5c6e 2729 0a20 2020 2020 2020 2020 2020  \n').           
-000014d0: 206c 6f67 5f66 696c 652e 666c 7573 6828   log_file.flush(
-000014e0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-000014f0: 4b69 6c6c 2074 6865 2063 7572 7265 6e74  Kill the current
-00001500: 2070 726f 6365 7373 2e0a 2020 2020 2020   process..      
-00001510: 2020 2020 2020 7072 6f63 2e74 6572 6d69        proc.termi
-00001520: 6e61 7465 2829 0a20 2020 2020 2020 2020  nate().         
-00001530: 2020 2070 726f 632e 7265 7475 726e 636f     proc.returnco
-00001540: 6465 203d 2031 2020 2320 4e6f 6e65 2069  de = 1  # None i
-00001550: 6620 7765 2064 6f6e 2774 2073 6574 2069  f we don't set i
-00001560: 742e 0a20 2020 2020 2020 2020 2020 2062  t..            b
-00001570: 7265 616b 0a0a 2020 2020 2020 2020 6966  reak..        if
-00001580: 2070 726f 632e 7265 7475 726e 636f 6465   proc.returncode
-00001590: 3a0a 2020 2020 2020 2020 2020 2020 6272  :.            br
-000015a0: 6561 6b0a 0a20 2020 2073 7479 6c65 203d  eak..    style =
-000015b0: 2063 6f6c 6f72 616d 612e 5374 796c 650a   colorama.Style.
-000015c0: 2020 2020 666f 7265 203d 2063 6f6c 6f72      fore = color
-000015d0: 616d 612e 466f 7265 0a20 2020 206f 7574  ama.Fore.    out
-000015e0: 636f 6d65 203d 2028 6627 7b66 6f72 652e  come = (f'{fore.
-000015f0: 5245 447d 4661 696c 6564 7b73 7479 6c65  RED}Failed{style
-00001600: 2e52 4553 4554 5f41 4c4c 7d27 0a20 2020  .RESET_ALL}'.   
-00001610: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00001620: 726f 632e 7265 7475 726e 636f 6465 2065  roc.returncode e
-00001630: 6c73 6520 6627 7b66 6f72 652e 4752 4545  lse f'{fore.GREE
-00001640: 4e7d 5061 7373 6564 7b73 7479 6c65 2e52  N}Passed{style.R
-00001650: 4553 4554 5f41 4c4c 7d27 290a 2020 2020  ESET_ALL}').    
-00001660: 7265 6173 6f6e 203d 2066 275c 6e52 6561  reason = f'\nRea
-00001670: 736f 6e3a 207b 636f 6d6d 616e 647d 2720  son: {command}' 
-00001680: 6966 2070 726f 632e 7265 7475 726e 636f  if proc.returnco
-00001690: 6465 2065 6c73 6520 2727 0a20 2020 206d  de else ''.    m
-000016a0: 7367 203d 2028 6627 7b6f 7574 636f 6d65  sg = (f'{outcome
-000016b0: 7d2e 270a 2020 2020 2020 2020 2020 2066  }.'.           f
-000016c0: 277b 7265 6173 6f6e 7d27 0a20 2020 2020  '{reason}'.     
-000016d0: 2020 2020 2020 6627 5c6e 4c6f 673a 206c        f'\nLog: l
-000016e0: 6573 7320 7b6c 6f67 5f66 696c 652e 6e61  ess {log_file.na
-000016f0: 6d65 7d5c 6e27 290a 2020 2020 7465 7374  me}\n').    test
-00001700: 2e65 6368 6f28 6d73 6729 0a20 2020 206c  .echo(msg).    l
-00001710: 6f67 5f66 696c 652e 7772 6974 6528 6d73  og_file.write(ms
-00001720: 6729 0a20 2020 2069 6620 2870 726f 632e  g).    if (proc.
-00001730: 7265 7475 726e 636f 6465 203d 3d20 3020  returncode == 0 
-00001740: 6f72 0a20 2020 2020 2020 2020 2020 2070  or.            p
-00001750: 7974 6573 742e 7465 726d 696e 6174 655f  ytest.terminate_
-00001760: 6f6e 5f66 6169 6c75 7265 2920 616e 6420  on_failure) and 
-00001770: 7465 7374 2e74 6561 7264 6f77 6e20 6973  test.teardown is
-00001780: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00001790: 2020 2073 7562 7072 6f63 6573 735f 7574     subprocess_ut
-000017a0: 696c 732e 7275 6e28 0a20 2020 2020 2020  ils.run(.       
-000017b0: 2020 2020 2074 6573 742e 7465 6172 646f       test.teardo
-000017c0: 776e 2c0a 2020 2020 2020 2020 2020 2020  wn,.            
-000017d0: 7374 646f 7574 3d6c 6f67 5f66 696c 652c  stdout=log_file,
-000017e0: 0a20 2020 2020 2020 2020 2020 2073 7464  .            std
-000017f0: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
-00001800: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
-00001810: 2020 2074 696d 656f 7574 3d31 3020 2a20     timeout=10 * 
-00001820: 3630 2c20 2023 2031 3020 6d69 6e73 0a20  60,  # 10 mins. 
-00001830: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-00001840: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
-00001850: 0a0a 2020 2020 6966 2070 726f 632e 7265  ..    if proc.re
-00001860: 7475 726e 636f 6465 3a0a 2020 2020 2020  turncode:.      
-00001870: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00001880: 6e28 6627 7465 7374 2066 6169 6c65 643a  n(f'test failed:
-00001890: 206c 6573 7320 7b6c 6f67 5f66 696c 652e   less {log_file.
-000018a0: 6e61 6d65 7d27 290a 0a0a 6465 6620 6765  name}')...def ge
-000018b0: 745f 6177 735f 7265 6769 6f6e 5f66 6f72  t_aws_region_for
-000018c0: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
-000018d0: 2920 2d3e 204f 7074 696f 6e61 6c5b 7374  ) -> Optional[st
-000018e0: 725d 3a0a 2020 2020 6361 6e64 6964 6174  r]:.    candidat
-000018f0: 655f 7265 6769 6f6e 7320 3d20 4157 532e  e_regions = AWS.
-00001900: 7265 6769 6f6e 735f 7769 7468 5f6f 6666  regions_with_off
-00001910: 6572 696e 6728 696e 7374 616e 6365 5f74  ering(instance_t
-00001920: 7970 653d 2770 332e 3136 786c 6172 6765  ype='p3.16xlarge
-00001930: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00001940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001960: 2020 2020 2061 6363 656c 6572 6174 6f72       accelerator
-00001970: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00001230: 2020 2020 2020 2020 2020 7375 6666 6978            suffix
+00001240: 3d27 2e6c 6f67 272c 0a20 2020 2020 2020  ='.log',.       
+00001250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001270: 2020 2020 6465 6c65 7465 3d46 616c 7365      delete=False
+00001280: 290a 2020 2020 7465 7374 2e65 6368 6f28  ).    test.echo(
+00001290: 6627 5465 7374 2073 7461 7274 6564 2e20  f'Test started. 
+000012a0: 4c6f 673a 206c 6573 7320 7b6c 6f67 5f66  Log: less {log_f
+000012b0: 696c 652e 6e61 6d65 7d27 290a 2020 2020  ile.name}').    
+000012c0: 666f 7220 636f 6d6d 616e 6420 696e 2074  for command in t
+000012d0: 6573 742e 636f 6d6d 616e 6473 3a0a 2020  est.commands:.  
+000012e0: 2020 2020 2020 6c6f 675f 6669 6c65 2e77        log_file.w
+000012f0: 7269 7465 2866 272b 207b 636f 6d6d 616e  rite(f'+ {comman
+00001300: 647d 5c6e 2729 0a20 2020 2020 2020 206c  d}\n').        l
+00001310: 6f67 5f66 696c 652e 666c 7573 6828 290a  og_file.flush().
+00001320: 2020 2020 2020 2020 7072 6f63 203d 2073          proc = s
+00001330: 7562 7072 6f63 6573 732e 506f 7065 6e28  ubprocess.Popen(
+00001340: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+00001350: 6d61 6e64 2c0a 2020 2020 2020 2020 2020  mand,.          
+00001360: 2020 7374 646f 7574 3d6c 6f67 5f66 696c    stdout=log_fil
+00001370: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+00001380: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
+00001390: 2e53 5444 4f55 542c 0a20 2020 2020 2020  .STDOUT,.       
+000013a0: 2020 2020 2073 6865 6c6c 3d54 7275 652c       shell=True,
+000013b0: 0a20 2020 2020 2020 2020 2020 2065 7865  .            exe
+000013c0: 6375 7461 626c 653d 272f 6269 6e2f 6261  cutable='/bin/ba
+000013d0: 7368 272c 0a20 2020 2020 2020 2029 0a20  sh',.        ). 
+000013e0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000013f0: 2020 2020 2020 2020 7072 6f63 2e77 6169          proc.wai
+00001400: 7428 7469 6d65 6f75 743d 7465 7374 2e74  t(timeout=test.t
+00001410: 696d 656f 7574 290a 2020 2020 2020 2020  imeout).        
+00001420: 6578 6365 7074 2073 7562 7072 6f63 6573  except subproces
+00001430: 732e 5469 6d65 6f75 7445 7870 6972 6564  s.TimeoutExpired
+00001440: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00001450: 2020 206c 6f67 5f66 696c 652e 666c 7573     log_file.flus
+00001460: 6828 290a 2020 2020 2020 2020 2020 2020  h().            
+00001470: 7465 7374 2e65 6368 6f28 6627 5469 6d65  test.echo(f'Time
+00001480: 6f75 7420 6166 7465 7220 7b74 6573 742e  out after {test.
+00001490: 7469 6d65 6f75 747d 2073 6563 6f6e 6473  timeout} seconds
+000014a0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+000014b0: 7465 7374 2e65 6368 6f28 7374 7228 6529  test.echo(str(e)
+000014c0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+000014d0: 675f 6669 6c65 2e77 7269 7465 2866 2754  g_file.write(f'T
+000014e0: 696d 656f 7574 2061 6674 6572 207b 7465  imeout after {te
+000014f0: 7374 2e74 696d 656f 7574 7d20 7365 636f  st.timeout} seco
+00001500: 6e64 732e 5c6e 2729 0a20 2020 2020 2020  nds.\n').       
+00001510: 2020 2020 206c 6f67 5f66 696c 652e 666c       log_file.fl
+00001520: 7573 6828 290a 2020 2020 2020 2020 2020  ush().          
+00001530: 2020 2320 4b69 6c6c 2074 6865 2063 7572    # Kill the cur
+00001540: 7265 6e74 2070 726f 6365 7373 2e0a 2020  rent process..  
+00001550: 2020 2020 2020 2020 2020 7072 6f63 2e74            proc.t
+00001560: 6572 6d69 6e61 7465 2829 0a20 2020 2020  erminate().     
+00001570: 2020 2020 2020 2070 726f 632e 7265 7475         proc.retu
+00001580: 726e 636f 6465 203d 2031 2020 2320 4e6f  rncode = 1  # No
+00001590: 6e65 2069 6620 7765 2064 6f6e 2774 2073  ne if we don't s
+000015a0: 6574 2069 742e 0a20 2020 2020 2020 2020  et it..         
+000015b0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+000015c0: 2020 6966 2070 726f 632e 7265 7475 726e    if proc.return
+000015d0: 636f 6465 3a0a 2020 2020 2020 2020 2020  code:.          
+000015e0: 2020 6272 6561 6b0a 0a20 2020 2073 7479    break..    sty
+000015f0: 6c65 203d 2063 6f6c 6f72 616d 612e 5374  le = colorama.St
+00001600: 796c 650a 2020 2020 666f 7265 203d 2063  yle.    fore = c
+00001610: 6f6c 6f72 616d 612e 466f 7265 0a20 2020  olorama.Fore.   
+00001620: 206f 7574 636f 6d65 203d 2028 6627 7b66   outcome = (f'{f
+00001630: 6f72 652e 5245 447d 4661 696c 6564 7b73  ore.RED}Failed{s
+00001640: 7479 6c65 2e52 4553 4554 5f41 4c4c 7d27  tyle.RESET_ALL}'
+00001650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001660: 6966 2070 726f 632e 7265 7475 726e 636f  if proc.returnco
+00001670: 6465 2065 6c73 6520 6627 7b66 6f72 652e  de else f'{fore.
+00001680: 4752 4545 4e7d 5061 7373 6564 7b73 7479  GREEN}Passed{sty
+00001690: 6c65 2e52 4553 4554 5f41 4c4c 7d27 290a  le.RESET_ALL}').
+000016a0: 2020 2020 7265 6173 6f6e 203d 2066 275c      reason = f'\
+000016b0: 6e52 6561 736f 6e3a 207b 636f 6d6d 616e  nReason: {comman
+000016c0: 647d 2720 6966 2070 726f 632e 7265 7475  d}' if proc.retu
+000016d0: 726e 636f 6465 2065 6c73 6520 2727 0a20  rncode else ''. 
+000016e0: 2020 206d 7367 203d 2028 6627 7b6f 7574     msg = (f'{out
+000016f0: 636f 6d65 7d2e 270a 2020 2020 2020 2020  come}.'.        
+00001700: 2020 2066 277b 7265 6173 6f6e 7d27 0a20     f'{reason}'. 
+00001710: 2020 2020 2020 2020 2020 6627 5c6e 4c6f            f'\nLo
+00001720: 673a 206c 6573 7320 7b6c 6f67 5f66 696c  g: less {log_fil
+00001730: 652e 6e61 6d65 7d5c 6e27 290a 2020 2020  e.name}\n').    
+00001740: 7465 7374 2e65 6368 6f28 6d73 6729 0a20  test.echo(msg). 
+00001750: 2020 206c 6f67 5f66 696c 652e 7772 6974     log_file.writ
+00001760: 6528 6d73 6729 0a20 2020 2069 6620 2870  e(msg).    if (p
+00001770: 726f 632e 7265 7475 726e 636f 6465 203d  roc.returncode =
+00001780: 3d20 3020 6f72 0a20 2020 2020 2020 2020  = 0 or.         
+00001790: 2020 2070 7974 6573 742e 7465 726d 696e     pytest.termin
+000017a0: 6174 655f 6f6e 5f66 6169 6c75 7265 2920  ate_on_failure) 
+000017b0: 616e 6420 7465 7374 2e74 6561 7264 6f77  and test.teardow
+000017c0: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
+000017d0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+000017e0: 735f 7574 696c 732e 7275 6e28 0a20 2020  s_utils.run(.   
+000017f0: 2020 2020 2020 2020 2074 6573 742e 7465           test.te
+00001800: 6172 646f 776e 2c0a 2020 2020 2020 2020  ardown,.        
+00001810: 2020 2020 7374 646f 7574 3d6c 6f67 5f66      stdout=log_f
+00001820: 696c 652c 0a20 2020 2020 2020 2020 2020  ile,.           
+00001830: 2073 7464 6572 723d 7375 6270 726f 6365   stderr=subproce
+00001840: 7373 2e53 5444 4f55 542c 0a20 2020 2020  ss.STDOUT,.     
+00001850: 2020 2020 2020 2074 696d 656f 7574 3d31         timeout=1
+00001860: 3020 2a20 3630 2c20 2023 2031 3020 6d69  0 * 60,  # 10 mi
+00001870: 6e73 0a20 2020 2020 2020 2020 2020 2073  ns.            s
+00001880: 6865 6c6c 3d54 7275 652c 0a20 2020 2020  hell=True,.     
+00001890: 2020 2029 0a0a 2020 2020 6966 2070 726f     )..    if pro
+000018a0: 632e 7265 7475 726e 636f 6465 3a0a 2020  c.returncode:.  
+000018b0: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+000018c0: 7074 696f 6e28 6627 7465 7374 2066 6169  ption(f'test fai
+000018d0: 6c65 643a 206c 6573 7320 7b6c 6f67 5f66  led: less {log_f
+000018e0: 696c 652e 6e61 6d65 7d27 290a 0a0a 6465  ile.name}')...de
+000018f0: 6620 6765 745f 6177 735f 7265 6769 6f6e  f get_aws_region
+00001900: 5f66 6f72 5f71 756f 7461 5f66 6169 6c6f  _for_quota_failo
+00001910: 7665 7228 2920 2d3e 204f 7074 696f 6e61  ver() -> Optiona
+00001920: 6c5b 7374 725d 3a0a 2020 2020 6361 6e64  l[str]:.    cand
+00001930: 6964 6174 655f 7265 6769 6f6e 7320 3d20  idate_regions = 
+00001940: 4157 532e 7265 6769 6f6e 735f 7769 7468  AWS.regions_with
+00001950: 5f6f 6666 6572 696e 6728 696e 7374 616e  _offering(instan
+00001960: 6365 5f74 7970 653d 2770 332e 3136 786c  ce_type='p3.16xl
+00001970: 6172 6765 272c 0a20 2020 2020 2020 2020  arge',.         
 00001980: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000019a0: 2020 2020 2020 2020 2020 7573 655f 7370            use_sp
-000019b0: 6f74 3d54 7275 652c 0a20 2020 2020 2020  ot=True,.       
+000019a0: 2020 2020 2020 2020 2061 6363 656c 6572           acceler
+000019b0: 6174 6f72 733d 4e6f 6e65 2c0a 2020 2020  ators=None,.    
 000019c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000019d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000019e0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
-000019f0: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
+000019e0: 2020 2020 2020 2020 2020 2020 2020 7573                us
+000019f0: 655f 7370 6f74 3d54 7275 652c 0a20 2020  e_spot=True,.   
 00001a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001a20: 2020 2020 2020 2020 2020 7a6f 6e65 3d4e            zone=N
-00001a30: 6f6e 6529 0a0a 2020 2020 666f 7220 7265  one)..    for re
-00001a40: 6769 6f6e 2069 6e20 6361 6e64 6964 6174  gion in candidat
-00001a50: 655f 7265 6769 6f6e 733a 0a20 2020 2020  e_regions:.     
-00001a60: 2020 2072 6573 6f75 7263 6573 203d 2073     resources = s
-00001a70: 6b79 2e52 6573 6f75 7263 6573 2863 6c6f  ky.Resources(clo
-00001a80: 7564 3d73 6b79 2e41 5753 2829 2c0a 2020  ud=sky.AWS(),.  
-00001a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ab0: 696e 7374 616e 6365 5f74 7970 653d 2770  instance_type='p
-00001ac0: 332e 3136 786c 6172 6765 272c 0a20 2020  3.16xlarge',.   
-00001ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ae0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00001af0: 6567 696f 6e3d 7265 6769 6f6e 2e6e 616d  egion=region.nam
-00001b00: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00001b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b20: 2020 2020 2075 7365 5f73 706f 743d 5472       use_spot=Tr
-00001b30: 7565 290a 2020 2020 2020 2020 6966 206e  ue).        if n
-00001b40: 6f74 2041 5753 2e63 6865 636b 5f71 756f  ot AWS.check_quo
-00001b50: 7461 5f61 7661 696c 6162 6c65 2872 6573  ta_available(res
-00001b60: 6f75 7263 6573 293a 0a20 2020 2020 2020  ources):.       
-00001b70: 2020 2020 2072 6574 7572 6e20 7265 6769       return regi
-00001b80: 6f6e 2e6e 616d 650a 0a20 2020 2072 6574  on.name..    ret
-00001b90: 7572 6e20 4e6f 6e65 0a0a 0a64 6566 2067  urn None...def g
-00001ba0: 6574 5f67 6370 5f72 6567 696f 6e5f 666f  et_gcp_region_fo
-00001bb0: 725f 7175 6f74 615f 6661 696c 6f76 6572  r_quota_failover
-00001bc0: 2829 202d 3e20 4f70 7469 6f6e 616c 5b73  () -> Optional[s
-00001bd0: 7472 5d3a 0a0a 2020 2020 6361 6e64 6964  tr]:..    candid
-00001be0: 6174 655f 7265 6769 6f6e 7320 3d20 4743  ate_regions = GC
-00001bf0: 502e 7265 6769 6f6e 735f 7769 7468 5f6f  P.regions_with_o
-00001c00: 6666 6572 696e 6728 696e 7374 616e 6365  ffering(instance
-00001c10: 5f74 7970 653d 4e6f 6e65 2c0a 2020 2020  _type=None,.    
-00001c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c40: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-00001c50: 6365 6c65 7261 746f 7273 3d7b 2741 3130  celerators={'A10
-00001c60: 302d 3830 4742 273a 2031 7d2c 0a20 2020  0-80GB': 1},.   
+00001a20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001a30: 6567 696f 6e3d 4e6f 6e65 2c0a 2020 2020  egion=None,.    
+00001a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a60: 2020 2020 2020 2020 2020 2020 2020 7a6f                zo
+00001a70: 6e65 3d4e 6f6e 6529 0a0a 2020 2020 666f  ne=None)..    fo
+00001a80: 7220 7265 6769 6f6e 2069 6e20 6361 6e64  r region in cand
+00001a90: 6964 6174 655f 7265 6769 6f6e 733a 0a20  idate_regions:. 
+00001aa0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+00001ab0: 203d 2073 6b79 2e52 6573 6f75 7263 6573   = sky.Resources
+00001ac0: 2863 6c6f 7564 3d73 6b79 2e41 5753 2829  (cloud=sky.AWS()
+00001ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001af0: 2020 2020 696e 7374 616e 6365 5f74 7970      instance_typ
+00001b00: 653d 2770 332e 3136 786c 6172 6765 272c  e='p3.16xlarge',
+00001b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b30: 2020 2072 6567 696f 6e3d 7265 6769 6f6e     region=region
+00001b40: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+00001b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b60: 2020 2020 2020 2020 2075 7365 5f73 706f           use_spo
+00001b70: 743d 5472 7565 290a 2020 2020 2020 2020  t=True).        
+00001b80: 6966 206e 6f74 2041 5753 2e63 6865 636b  if not AWS.check
+00001b90: 5f71 756f 7461 5f61 7661 696c 6162 6c65  _quota_available
+00001ba0: 2872 6573 6f75 7263 6573 293a 0a20 2020  (resources):.   
+00001bb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00001bc0: 7265 6769 6f6e 2e6e 616d 650a 0a20 2020  region.name..   
+00001bd0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 0a64   return None...d
+00001be0: 6566 2067 6574 5f67 6370 5f72 6567 696f  ef get_gcp_regio
+00001bf0: 6e5f 666f 725f 7175 6f74 615f 6661 696c  n_for_quota_fail
+00001c00: 6f76 6572 2829 202d 3e20 4f70 7469 6f6e  over() -> Option
+00001c10: 616c 5b73 7472 5d3a 0a0a 2020 2020 6361  al[str]:..    ca
+00001c20: 6e64 6964 6174 655f 7265 6769 6f6e 7320  ndidate_regions 
+00001c30: 3d20 4743 502e 7265 6769 6f6e 735f 7769  = GCP.regions_wi
+00001c40: 7468 5f6f 6666 6572 696e 6728 696e 7374  th_offering(inst
+00001c50: 616e 6365 5f74 7970 653d 4e6f 6e65 2c0a  ance_type=None,.
+00001c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c90: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00001ca0: 7365 5f73 706f 743d 5472 7565 2c0a 2020  se_spot=True,.  
-00001cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001c90: 2020 6163 6365 6c65 7261 746f 7273 3d7b    accelerators={
+00001ca0: 2741 3130 302d 3830 4742 273a 2031 7d2c  'A100-80GB': 1},
+00001cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00001cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ce0: 7265 6769 6f6e 3d4e 6f6e 652c 0a20 2020  region=None,.   
-00001cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ce0: 2020 2075 7365 5f73 706f 743d 5472 7565     use_spot=True
+00001cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00001d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d10: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00001d20: 6f6e 653d 4e6f 6e65 290a 0a20 2020 2066  one=None)..    f
-00001d30: 6f72 2072 6567 696f 6e20 696e 2063 616e  or region in can
-00001d40: 6469 6461 7465 5f72 6567 696f 6e73 3a0a  didate_regions:.
-00001d50: 2020 2020 2020 2020 6966 206e 6f74 2047          if not G
-00001d60: 4350 2e63 6865 636b 5f71 756f 7461 5f61  CP.check_quota_a
-00001d70: 7661 696c 6162 6c65 280a 2020 2020 2020  vailable(.      
-00001d80: 2020 2020 2020 2020 2020 736b 792e 5265            sky.Re
-00001d90: 736f 7572 6365 7328 636c 6f75 643d 736b  sources(cloud=sk
-00001da0: 792e 4743 5028 292c 0a20 2020 2020 2020  y.GCP(),.       
-00001db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001dc0: 2020 2020 2020 2072 6567 696f 6e3d 7265         region=re
-00001dd0: 6769 6f6e 2e6e 616d 652c 0a20 2020 2020  gion.name,.     
-00001de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001df0: 2020 2020 2020 2020 2061 6363 656c 6572           acceler
-00001e00: 6174 6f72 733d 7b27 4131 3030 2d38 3047  ators={'A100-80G
-00001e10: 4227 3a20 317d 2c0a 2020 2020 2020 2020  B': 1},.        
+00001d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d20: 2020 2020 7265 6769 6f6e 3d4e 6f6e 652c      region=None,
+00001d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d60: 2020 207a 6f6e 653d 4e6f 6e65 290a 0a20     zone=None).. 
+00001d70: 2020 2066 6f72 2072 6567 696f 6e20 696e     for region in
+00001d80: 2063 616e 6469 6461 7465 5f72 6567 696f   candidate_regio
+00001d90: 6e73 3a0a 2020 2020 2020 2020 6966 206e  ns:.        if n
+00001da0: 6f74 2047 4350 2e63 6865 636b 5f71 756f  ot GCP.check_quo
+00001db0: 7461 5f61 7661 696c 6162 6c65 280a 2020  ta_available(.  
+00001dc0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
+00001dd0: 792e 5265 736f 7572 6365 7328 636c 6f75  y.Resources(clou
+00001de0: 643d 736b 792e 4743 5028 292c 0a20 2020  d=sky.GCP(),.   
+00001df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e00: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+00001e10: 6e3d 7265 6769 6f6e 2e6e 616d 652c 0a20  n=region.name,. 
 00001e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e30: 2020 2020 2020 7573 655f 7370 6f74 3d54        use_spot=T
-00001e40: 7275 6529 293a 0a20 2020 2020 2020 2020  rue)):.         
-00001e50: 2020 2072 6574 7572 6e20 7265 6769 6f6e     return region
-00001e60: 2e6e 616d 650a 0a20 2020 2072 6574 7572  .name..    retur
-00001e70: 6e20 4e6f 6e65 0a0a 0a23 202d 2d2d 2d2d  n None...# -----
-00001e80: 2d2d 2d2d 2d20 4472 7920 7275 6e3a 2032  ----- Dry run: 2
-00001e90: 2054 6173 6b73 2069 6e20 6120 6368 6169   Tasks in a chai
-00001ea0: 6e2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465  n. ----------.de
-00001eb0: 6620 7465 7374 5f65 7861 6d70 6c65 5f61  f test_example_a
-00001ec0: 7070 2829 3a0a 2020 2020 7465 7374 203d  pp():.    test =
-00001ed0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00001ee0: 6578 616d 706c 655f 6170 7027 2c0a 2020  example_app',.  
-00001ef0: 2020 2020 2020 5b27 7079 7468 6f6e 2065        ['python e
-00001f00: 7861 6d70 6c65 732f 6578 616d 706c 655f  xamples/example_
-00001f10: 6170 702e 7079 275d 2c0a 2020 2020 290a  app.py'],.    ).
-00001f20: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00001f30: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00001f40: 2d2d 2d2d 2d20 4120 6d69 6e69 6d61 6c20  ----- A minimal 
-00001f50: 7461 736b 202d 2d2d 2d2d 2d2d 2d2d 2d0a  task ----------.
-00001f60: 6465 6620 7465 7374 5f6d 696e 696d 616c  def test_minimal
-00001f70: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00001f80: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00001f90: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00001fa0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00001fb0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
-00001fc0: 696e 696d 616c 272c 0a20 2020 2020 2020  inimal',.       
-00001fd0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00001fe0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00001ff0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00002000: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00002010: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00002020: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00002030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002040: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00002050: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00002060: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00002070: 6773 207b 6e61 6d65 7d20 2d2d 7374 6174  gs {name} --stat
-00002080: 7573 207c 2067 7265 7020 224a 6f62 2031  us | grep "Job 1
-00002090: 3a20 5355 4343 4545 4445 4422 272c 2020  : SUCCEEDED"',  
-000020a0: 2320 4571 7569 7661 6c65 6e74 2e0a 2020  # Equivalent..  
-000020b0: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
-000020c0: 6b20 7468 6520 6c6f 6773 2064 6f77 6e6c  k the logs downl
-000020d0: 6f61 6469 6e67 0a20 2020 2020 2020 2020  oading.         
-000020e0: 2020 2066 276c 6f67 5f70 6174 683d 2428     f'log_path=$(
-000020f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00002100: 3120 2d2d 7379 6e63 2d64 6f77 6e20 7c20  1 --sync-down | 
-00002110: 6772 6570 2022 4a6f 6220 3120 6c6f 6773  grep "Job 1 logs
-00002120: 3a22 207c 2073 6564 202d 4520 2273 2f5e  :" | sed -E "s/^
-00002130: 2e2a 4a6f 6220 3120 6c6f 6773 3a20 282e  .*Job 1 logs: (.
-00002140: 2a29 5c5c 7831 625c 5c5b 306d 2f5c 5c31  *)\\x1b\\[0m/\\1
-00002150: 2f67 2229 2026 2620 6563 686f 2024 6c6f  /g") && echo $lo
-00002160: 675f 7061 7468 2026 2620 7465 7374 202d  g_path && test -
-00002170: 6620 246c 6f67 5f70 6174 682f 7275 6e2e  f $log_path/run.
-00002180: 6c6f 6727 2c0a 2020 2020 2020 2020 2020  log',.          
-00002190: 2020 2320 456e 7375 7265 2074 6865 2072    # Ensure the r
-000021a0: 6179 6c65 7420 7072 6f63 6573 7320 6861  aylet process ha
-000021b0: 7320 7468 6520 636f 7272 6563 7420 6669  s the correct fi
-000021c0: 6c65 2064 6573 6372 6970 746f 7220 6c69  le descriptor li
-000021d0: 6d69 742e 0a20 2020 2020 2020 2020 2020  mit..           
-000021e0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000021f0: 657d 2022 7072 6c69 6d69 7420 2d6e 202d  e} "prlimit -n -
-00002200: 2d70 6964 3d5c 2428 7067 7265 7020 2d66  -pid=\$(pgrep -f
-00002210: 205c 2772 6179 6c65 742f 7261 796c 6574   \'raylet/raylet
-00002220: 202d 2d72 6179 6c65 745f 736f 636b 6574   --raylet_socket
-00002230: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
-00002240: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
-00002250: 3835 3736 5c27 225c 2722 272c 0a20 2020  8576\'"\'"',.   
-00002260: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00002270: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00002280: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00002290: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-000022a0: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-000022b0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000022c0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000022d0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000022e0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-000022f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7420  ---------- Test 
-00002300: 7265 6769 6f6e 202d 2d2d 2d2d 2d2d 2d2d  region ---------
-00002310: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
-00002320: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-00002330: 7265 6769 6f6e 2829 3a0a 2020 2020 6e61  region():.    na
-00002340: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00002350: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00002360: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00002370: 2020 2761 7773 5f72 6567 696f 6e27 2c0a    'aws_region',.
-00002380: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00002390: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000023a0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000023b0: 2d2d 7265 6769 6f6e 2075 732d 7765 7374  --region us-west
-000023c0: 2d32 2065 7861 6d70 6c65 732f 6d69 6e69  -2 examples/mini
-000023d0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-000023e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000023f0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-00002400: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00002410: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002420: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00002430: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-00002440: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00002450: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00002460: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00002470: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
-00002480: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
-00002490: 7765 7374 2d32 272c 2020 2320 456e 7375  west-2',  # Ensu
-000024a0: 7265 2074 6865 2072 6567 696f 6e20 6973  re the region is
-000024b0: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
-000024c0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000024d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000024e0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000024f0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00002500: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00002510: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-00002520: 5f72 6567 696f 6e28 293a 0a20 2020 206e  _region():.    n
-00002530: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00002540: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00002550: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00002560: 2020 2027 6763 705f 7265 6769 6f6e 272c     'gcp_region',
-00002570: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00002580: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00002590: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-000025a0: 202d 2d72 6567 696f 6e20 7573 2d63 656e   --region us-cen
-000025b0: 7472 616c 3120 2d2d 636c 6f75 6420 6763  tral1 --cloud gc
-000025c0: 7020 7465 7374 732f 7465 7374 5f79 616d  p tests/test_yam
-000025d0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-000025e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000025f0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00002600: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00002610: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00002620: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00002630: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00002640: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00002650: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00002660: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00002670: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00002680: 202d 2d61 6c6c 207c 2067 7265 7020 7b6e   --all | grep {n
-00002690: 616d 657d 207c 2067 7265 7020 7573 2d63  ame} | grep us-c
-000026a0: 656e 7472 616c 3127 2c20 2023 2045 6e73  entral1',  # Ens
-000026b0: 7572 6520 7468 6520 7265 6769 6f6e 2069  ure the region i
-000026c0: 7320 636f 7272 6563 742e 0a20 2020 2020  s correct..     
-000026d0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-000026e0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-000026f0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00002700: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00002710: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00002720: 2e69 626d 0a64 6566 2074 6573 745f 6962  .ibm.def test_ib
-00002730: 6d5f 7265 6769 6f6e 2829 3a0a 2020 2020  m_region():.    
-00002740: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00002750: 7465 725f 6e61 6d65 2829 0a20 2020 2072  ter_name().    r
-00002760: 6567 696f 6e20 3d20 2765 752d 6465 270a  egion = 'eu-de'.
-00002770: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00002780: 0a20 2020 2020 2020 2027 7265 6769 6f6e  .        'region
-00002790: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000027a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000027b0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000027c0: 657d 202d 2d63 6c6f 7564 2069 626d 202d  e} --cloud ibm -
-000027d0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-000027e0: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-000027f0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00002800: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00002810: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
-00002820: 626d 2065 7861 6d70 6c65 732f 6d69 6e69  bm examples/mini
-00002830: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00002840: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00002850: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00002860: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00002870: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00002880: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00002890: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-000028a0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-000028b0: 7c20 6772 6570 207b 7265 6769 6f6e 7d27  | grep {region}'
-000028c0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000028d0: 7265 6769 6f6e 2069 7320 636f 7272 6563  region is correc
-000028e0: 742e 0a20 2020 2020 2020 205d 2c0a 2020  t..        ],.  
-000028f0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00002900: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00002910: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00002920: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00002930: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
-00002940: 6566 2074 6573 745f 617a 7572 655f 7265  ef test_azure_re
-00002950: 6769 6f6e 2829 3a0a 2020 2020 6e61 6d65  gion():.    name
-00002960: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00002970: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00002980: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00002990: 2761 7a75 7265 5f72 6567 696f 6e27 2c0a  'azure_region',.
-000029a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000029b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000029c0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000029d0: 2d2d 7265 6769 6f6e 2065 6173 7475 7332  --region eastus2
-000029e0: 202d 2d63 6c6f 7564 2061 7a75 7265 2074   --cloud azure t
-000029f0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00002a00: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00002a10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00002a20: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
-00002a30: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00002a40: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00002a50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00002a60: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00002a70: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00002a80: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00002a90: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00002aa0: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00002ab0: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
-00002ac0: 7d20 7c20 6772 6570 2065 6173 7475 7332  } | grep eastus2
-00002ad0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00002ae0: 2072 6567 696f 6e20 6973 2063 6f72 7265   region is corre
-00002af0: 6374 2e0a 2020 2020 2020 2020 5d2c 0a20  ct..        ],. 
-00002b00: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00002b10: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00002b20: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00002b30: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00002b40: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 207a  --------- Test z
-00002b50: 6f6e 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  one ----------.@
-00002b60: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00002b70: 6465 6620 7465 7374 5f61 7773 5f7a 6f6e  def test_aws_zon
-00002b80: 6528 293a 0a20 2020 206e 616d 6520 3d20  e():.    name = 
-00002b90: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00002ba0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00002bb0: 6573 7428 0a20 2020 2020 2020 2027 6177  est(.        'aw
-00002bc0: 735f 7a6f 6e65 272c 0a20 2020 2020 2020  s_zone',.       
-00002bd0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00002be0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00002bf0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-00002c00: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 202d  s/minimal.yaml -
-00002c10: 2d7a 6f6e 6520 7573 2d77 6573 742d 3262  -zone us-west-2b
-00002c20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00002c30: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00002c40: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00002c50: 6c2e 7961 6d6c 202d 2d7a 6f6e 6520 7573  l.yaml --zone us
-00002c60: 2d77 6573 742d 3262 272c 0a20 2020 2020  -west-2b',.     
-00002c70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00002c80: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00002c90: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00002ca0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00002cb0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00002cc0: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-00002cd0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-00002ce0: 7c20 6772 6570 2075 732d 7765 7374 2d32  | grep us-west-2
-00002cf0: 6227 2c20 2023 2045 6e73 7572 6520 7468  b',  # Ensure th
-00002d00: 6520 7a6f 6e65 2069 7320 636f 7272 6563  e zone is correc
-00002d10: 742e 0a20 2020 2020 2020 205d 2c0a 2020  t..        ],.  
-00002d20: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00002d30: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00002d40: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00002d50: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00002d60: 6573 742e 6d61 726b 2e69 626d 0a64 6566  est.mark.ibm.def
-00002d70: 2074 6573 745f 6962 6d5f 7a6f 6e65 2829   test_ibm_zone()
-00002d80: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00002d90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00002da0: 0a20 2020 207a 6f6e 6520 3d20 2765 752d  .    zone = 'eu-
-00002db0: 6465 2d32 270a 2020 2020 7465 7374 203d  de-2'.    test =
-00002dc0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00002dd0: 7a6f 6e65 272c 0a20 2020 2020 2020 205b  zone',.        [
-00002de0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002df0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00002e00: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
-00002e10: 626d 2065 7861 6d70 6c65 732f 6d69 6e69  bm examples/mini
-00002e20: 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e 6520  mal.yaml --zone 
-00002e30: 7b7a 6f6e 657d 272c 0a20 2020 2020 2020  {zone}',.       
-00002e40: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00002e50: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
-00002e60: 626d 2065 7861 6d70 6c65 732f 6d69 6e69  bm examples/mini
-00002e70: 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e 6520  mal.yaml --zone 
-00002e80: 7b7a 6f6e 657d 272c 0a20 2020 2020 2020  {zone}',.       
-00002e90: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00002ea0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00002eb0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00002ec0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00002ed0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002ee0: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
-00002ef0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00002f00: 6772 6570 207b 7a6f 6e65 7d27 2c20 2023  grep {zone}',  #
-00002f10: 2045 6e73 7572 6520 7468 6520 7a6f 6e65   Ensure the zone
-00002f20: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
-00002f30: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00002f40: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00002f50: 616d 657d 207b 6e61 6d65 7d2d 3220 7b6e  ame} {name}-2 {n
-00002f60: 616d 657d 2d33 272c 0a20 2020 2029 0a20  ame}-3',.    ). 
-00002f70: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00002f80: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00002f90: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
-00002fa0: 745f 6763 705f 7a6f 6e65 2829 3a0a 2020  t_gcp_zone():.  
-00002fb0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00002fc0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00002fd0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00002fe0: 2020 2020 2020 2767 6370 5f7a 6f6e 6527        'gcp_zone'
-00002ff0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00003000: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00003010: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00003020: 7d20 2d2d 7a6f 6e65 2075 732d 6365 6e74  } --zone us-cent
-00003030: 7261 6c31 2d61 202d 2d63 6c6f 7564 2067  ral1-a --cloud g
-00003040: 6370 2074 6573 7473 2f74 6573 745f 7961  cp tests/test_ya
-00003050: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00003060: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003070: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00003080: 202d 2d7a 6f6e 6520 7573 2d63 656e 7472   --zone us-centr
-00003090: 616c 312d 6120 2d2d 636c 6f75 6420 6763  al1-a --cloud gc
-000030a0: 7020 7465 7374 732f 7465 7374 5f79 616d  p tests/test_yam
-000030b0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-000030c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000030d0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000030e0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-000030f0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00003100: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00003110: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00003120: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
-00003130: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
-00003140: 2d63 656e 7472 616c 312d 6127 2c20 2023  -central1-a',  #
-00003150: 2045 6e73 7572 6520 7468 6520 7a6f 6e65   Ensure the zone
-00003160: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
-00003170: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00003180: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00003190: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-000031a0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000031b0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-000031c0: 2d2d 2054 6573 7420 7468 6520 696d 6167  -- Test the imag
-000031d0: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  e ----------.@py
-000031e0: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-000031f0: 6620 7465 7374 5f61 7773 5f69 6d61 6765  f test_aws_image
-00003200: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
-00003210: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00003220: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00003230: 6573 7428 0a20 2020 2020 2020 2027 6177  est(.        'aw
-00003240: 735f 696d 6167 6573 272c 0a20 2020 2020  s_images',.     
-00003250: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00003260: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00003270: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
-00003280: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-00003290: 7075 2d75 6275 6e74 752d 3138 3034 2065  pu-ubuntu-1804 e
-000032a0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-000032b0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000032c0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000032d0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-000032e0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000032f0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00003300: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003310: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00003320: 7d20 2d2d 696d 6167 652d 6964 2073 6b79  } --image-id sky
-00003330: 7069 6c6f 743a 6770 752d 7562 756e 7475  pilot:gpu-ubuntu
-00003340: 2d32 3030 3420 6578 616d 706c 6573 2f6d  -2004 examples/m
-00003350: 696e 696d 616c 2e79 616d 6c20 2626 2065  inimal.yaml && e
-00003360: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
-00003370: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003380: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00003390: 6e61 6d65 7d20 6578 616d 706c 6573 2f6d  name} examples/m
-000033a0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-000033b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000033c0: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-000033d0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-000033e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000033f0: 7b6e 616d 657d 202d 2d73 7461 7475 7320  {name} --status 
-00003400: 7c20 6772 6570 2022 4a6f 6220 323a 2053  | grep "Job 2: S
-00003410: 5543 4345 4544 4544 2227 2c20 2023 2045  UCCEEDED"',  # E
-00003420: 7175 6976 616c 656e 742e 0a20 2020 2020  quivalent..     
-00003430: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00003440: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00003450: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00003460: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00003470: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00003480: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00003490: 705f 696d 6167 6573 2829 3a0a 2020 2020  p_images():.    
-000034a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000034b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-000034c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000034d0: 2020 2020 2767 6370 5f69 6d61 6765 7327      'gcp_images'
-000034e0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000034f0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00003500: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00003510: 7d20 2d2d 696d 6167 652d 6964 2073 6b79  } --image-id sky
-00003520: 7069 6c6f 743a 6770 752d 6465 6269 616e  pilot:gpu-debian
-00003530: 2d31 3020 2d2d 636c 6f75 6420 6763 7020  -10 --cloud gcp 
-00003540: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00003550: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00003560: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003570: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00003580: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00003590: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-000035a0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-000035b0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000035c0: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
-000035d0: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
-000035e0: 7075 2d64 6562 6961 6e2d 3130 202d 2d63  pu-debian-10 --c
-000035f0: 6c6f 7564 2067 6370 2074 6573 7473 2f74  loud gcp tests/t
-00003600: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
-00003610: 6c2e 7961 6d6c 2026 2620 6578 6974 2031  l.yaml && exit 1
-00003620: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
-00003630: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00003640: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00003650: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00003660: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00003670: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003680: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00003690: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-000036a0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000036b0: 6773 207b 6e61 6d65 7d20 2d2d 7374 6174  gs {name} --stat
-000036c0: 7573 207c 2067 7265 7020 224a 6f62 2032  us | grep "Job 2
-000036d0: 3a20 5355 4343 4545 4445 4422 272c 2020  : SUCCEEDED"',  
-000036e0: 2320 4571 7569 7661 6c65 6e74 2e0a 2020  # Equivalent..  
-000036f0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00003700: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00003710: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00003720: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00003730: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00003740: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-00003750: 5f61 7773 5f69 6d61 6765 5f69 645f 6469  _aws_image_id_di
-00003760: 6374 2829 3a0a 2020 2020 6e61 6d65 203d  ct():.    name =
-00003770: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00003780: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00003790: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-000037a0: 7773 5f69 6d61 6765 5f69 645f 6469 6374  ws_image_id_dict
-000037b0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000037c0: 2020 2020 2020 2020 2023 2055 7365 2069           # Use i
-000037d0: 6d61 6765 2069 6420 6469 6374 2e0a 2020  mage id dict..  
-000037e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000037f0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00003800: 6d65 7d20 6578 616d 706c 6573 2f70 6572  me} examples/per
-00003810: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00003820: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00003830: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00003840: 6d65 7d20 6578 616d 706c 6573 2f70 6572  me} examples/per
-00003850: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
-00003860: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00003870: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00003880: 6d65 7d20 226c 7320 7e22 272c 0a20 2020  me} "ls ~"',.   
-00003890: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000038a0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-000038b0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000038c0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000038d0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-000038e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000038f0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00003900: 2033 202d 2d73 7461 7475 7327 2c0a 2020   3 --status',.  
-00003910: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00003920: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00003930: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00003940: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00003950: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00003960: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-00003970: 5f67 6370 5f69 6d61 6765 5f69 645f 6469  _gcp_image_id_di
-00003980: 6374 2829 3a0a 2020 2020 6e61 6d65 203d  ct():.    name =
-00003990: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000039a0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000039b0: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
-000039c0: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
-000039d0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000039e0: 2020 2020 2020 2020 2023 2055 7365 2069           # Use i
-000039f0: 6d61 6765 2069 6420 6469 6374 2e0a 2020  mage id dict..  
-00003a00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003a10: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00003a20: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
-00003a30: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-00003a40: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-00003a50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003a60: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00003a70: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00003a80: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
-00003a90: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
-00003aa0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003ab0: 6578 6563 207b 6e61 6d65 7d20 226c 7320  exec {name} "ls 
-00003ac0: 7e22 272c 0a20 2020 2020 2020 2020 2020  ~"',.           
-00003ad0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00003ae0: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00003af0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003b00: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00003b10: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00003b20: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00003b30: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-00003b40: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-00003b50: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00003b60: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00003b70: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00003b80: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00003b90: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00003ba0: 6465 6620 7465 7374 5f61 7773 5f69 6d61  def test_aws_ima
-00003bb0: 6765 5f69 645f 6469 6374 5f72 6567 696f  ge_id_dict_regio
-00003bc0: 6e28 293a 0a20 2020 206e 616d 6520 3d20  n():.    name = 
-00003bd0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00003be0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00003bf0: 6573 7428 0a20 2020 2020 2020 2027 6177  est(.        'aw
-00003c00: 735f 696d 6167 655f 6964 5f64 6963 745f  s_image_id_dict_
-00003c10: 7265 6769 6f6e 272c 0a20 2020 2020 2020  region',.       
-00003c20: 205b 0a20 2020 2020 2020 2020 2020 2023   [.            #
-00003c30: 2055 7365 2072 6567 696f 6e20 746f 2066   Use region to f
-00003c40: 696c 7465 7220 696d 6167 655f 6964 2064  ilter image_id d
-00003c50: 6963 742e 0a20 2020 2020 2020 2020 2020  ict..           
-00003c60: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00003c70: 202d 6320 7b6e 616d 657d 202d 2d72 6567   -c {name} --reg
-00003c80: 696f 6e20 7573 2d65 6173 742d 3120 6578  ion us-east-1 ex
-00003c90: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
-00003ca0: 6e5f 696d 6167 6573 2e79 616d 6c20 2626  n_images.yaml &&
-00003cb0: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-00003cc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003cd0: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
-00003ce0: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
-00003cf0: 2031 207c 7c20 7472 7565 272c 2020 2320   1 || true',  # 
-00003d00: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-00003d10: 6572 2069 7320 6e6f 7420 6372 6561 7465  er is not create
-00003d20: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00003d30: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00003d40: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
-00003d50: 6e20 7573 2d77 6573 742d 3220 6578 616d  n us-west-2 exam
-00003d60: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
-00003d70: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
-00003d80: 2020 2020 2020 2020 2020 2320 5368 6f75            # Shou
-00003d90: 6c64 2073 7563 6365 7373 2062 6563 6175  ld success becau
-00003da0: 7365 2074 6865 2069 6d61 6765 2069 6420  se the image id 
-00003db0: 6d61 7463 6820 666f 7220 7468 6520 7265  match for the re
-00003dc0: 6769 6f6e 2e0a 2020 2020 2020 2020 2020  gion..          
-00003dd0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00003de0: 6320 7b6e 616d 657d 202d 2d69 6d61 6765  c {name} --image
-00003df0: 2d69 6420 736b 7970 696c 6f74 3a67 7075  -id skypilot:gpu
-00003e00: 2d75 6275 6e74 752d 3138 3034 2065 7861  -ubuntu-1804 exa
-00003e10: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
-00003e20: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00003e30: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00003e40: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
-00003e50: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
-00003e60: 752d 3138 3034 2065 7861 6d70 6c65 732f  u-1804 examples/
-00003e70: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00003e80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003e90: 2065 7865 6320 7b6e 616d 657d 202d 2d69   exec {name} --i
-00003ea0: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00003eb0: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
-00003ec0: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00003ed0: 6c2e 7961 6d6c 2026 2620 6578 6974 2031  l.yaml && exit 1
-00003ee0: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
-00003ef0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00003f00: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00003f10: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00003f20: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00003f30: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-00003f40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003f50: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
-00003f60: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00003f70: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00003f80: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
-00003f90: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00003fa0: 7573 2d77 6573 742d 3227 2c20 2023 2045  us-west-2',  # E
-00003fb0: 6e73 7572 6520 7468 6520 7265 6769 6f6e  nsure the region
-00003fc0: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
-00003fd0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-00003fe0: 6520 6578 6563 2077 6f72 6b73 2e0a 2020  e exec works..  
-00003ff0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004000: 6578 6563 207b 6e61 6d65 7d20 2d2d 7265  exec {name} --re
-00004010: 6769 6f6e 2075 732d 7765 7374 2d32 2065  gion us-west-2 e
-00004020: 7861 6d70 6c65 732f 7065 725f 7265 6769  xamples/per_regi
-00004030: 6f6e 5f69 6d61 6765 732e 7961 6d6c 272c  on_images.yaml',
-00004040: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004050: 6b79 2065 7865 6320 7b6e 616d 657d 2065  ky exec {name} e
-00004060: 7861 6d70 6c65 732f 7065 725f 7265 6769  xamples/per_regi
-00004070: 6f6e 5f69 6d61 6765 732e 7961 6d6c 272c  on_images.yaml',
-00004080: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004090: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-000040a0: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
-000040b0: 696f 6e20 7573 2d77 6573 742d 3220 226c  ion us-west-2 "l
-000040c0: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
-000040d0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000040e0: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
-000040f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004100: 6c6f 6773 207b 6e61 6d65 7d20 3420 2d2d  logs {name} 4 --
-00004110: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00004120: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00004130: 7b6e 616d 657d 2035 202d 2d73 7461 7475  {name} 5 --statu
-00004140: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00004150: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004160: 7d20 3620 2d2d 7374 6174 7573 272c 0a20  } 6 --status',. 
-00004170: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004180: 206c 6f67 7320 7b6e 616d 657d 2037 202d   logs {name} 7 -
-00004190: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000041a0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000041b0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000041c0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-000041d0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000041e0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000041f0: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-00004200: 5f69 6d61 6765 5f69 645f 6469 6374 5f72  _image_id_dict_r
-00004210: 6567 696f 6e28 293a 0a20 2020 206e 616d  egion():.    nam
-00004220: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00004230: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00004240: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00004250: 2027 6763 705f 696d 6167 655f 6964 5f64   'gcp_image_id_d
-00004260: 6963 745f 7265 6769 6f6e 272c 0a20 2020  ict_region',.   
-00004270: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00004280: 2020 2023 2055 7365 2072 6567 696f 6e20     # Use region 
-00004290: 746f 2066 696c 7465 7220 696d 6167 655f  to filter image_
-000042a0: 6964 2064 6963 742e 0a20 2020 2020 2020  id dict..       
-000042b0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-000042c0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-000042d0: 2d72 6567 696f 6e20 7573 2d65 6173 7431  -region us-east1
-000042e0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-000042f0: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
-00004300: 5f69 6d61 6765 732e 7961 6d6c 2026 2620  _images.yaml && 
-00004310: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
-00004320: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004330: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
-00004340: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
-00004350: 3120 7c7c 2074 7275 6527 2c20 2023 2045  1 || true',  # E
-00004360: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-00004370: 7220 6973 206e 6f74 2063 7265 6174 6564  r is not created
-00004380: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00004390: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000043a0: 207b 6e61 6d65 7d20 2d2d 7265 6769 6f6e   {name} --region
-000043b0: 2075 732d 7765 7374 3320 7465 7374 732f   us-west3 tests/
-000043c0: 7465 7374 5f79 616d 6c73 2f67 6370 5f70  test_yamls/gcp_p
-000043d0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-000043e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-000043f0: 2020 2020 2320 5368 6f75 6c64 2073 7563      # Should suc
-00004400: 6365 7373 2062 6563 6175 7365 2074 6865  cess because the
-00004410: 2069 6d61 6765 2069 6420 6d61 7463 6820   image id match 
-00004420: 666f 7220 7468 6520 7265 6769 6f6e 2e0a  for the region..
-00004430: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004440: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-00004450: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-00004460: 2d69 6d61 6765 2d69 6420 7072 6f6a 6563  -image-id projec
-00004470: 7473 2f75 6275 6e74 752d 6f73 2d63 6c6f  ts/ubuntu-os-clo
-00004480: 7564 2f67 6c6f 6261 6c2f 696d 6167 6573  ud/global/images
-00004490: 2f75 6275 6e74 752d 3138 3034 2d62 696f  /ubuntu-1804-bio
-000044a0: 6e69 632d 7632 3032 3330 3131 3220 7465  nic-v20230112 te
-000044b0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-000044c0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-000044d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000044e0: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
-000044f0: 6f75 6420 6763 7020 2d2d 696d 6167 652d  oud gcp --image-
-00004500: 6964 2070 726f 6a65 6374 732f 7562 756e  id projects/ubun
-00004510: 7475 2d6f 732d 636c 6f75 642f 676c 6f62  tu-os-cloud/glob
-00004520: 616c 2f69 6d61 6765 732f 7562 756e 7475  al/images/ubuntu
-00004530: 2d31 3830 342d 6269 6f6e 6963 2d76 3230  -1804-bionic-v20
-00004540: 3233 3031 3132 2074 6573 7473 2f74 6573  230112 tests/tes
-00004550: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-00004560: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00004570: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00004580: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00004590: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
-000045a0: 696c 6f74 3a63 7075 2d64 6562 6961 6e2d  ilot:cpu-debian-
-000045b0: 3130 2074 6573 7473 2f74 6573 745f 7961  10 tests/test_ya
-000045c0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-000045d0: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
-000045e0: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
-000045f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004600: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00004610: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004620: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00004630: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00004640: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00004650: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-00004660: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00004670: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
-00004680: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
-00004690: 657d 207c 2067 7265 7020 7573 2d77 6573  e} | grep us-wes
-000046a0: 7433 272c 2020 2320 456e 7375 7265 2074  t3',  # Ensure t
-000046b0: 6865 2072 6567 696f 6e20 6973 2063 6f72  he region is cor
-000046c0: 7265 6374 2e0a 2020 2020 2020 2020 2020  rect..          
-000046d0: 2020 2320 456e 7375 7265 2065 7865 6320    # Ensure exec 
-000046e0: 776f 726b 732e 0a20 2020 2020 2020 2020  works..         
-000046f0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00004700: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
-00004710: 2d77 6573 7433 2074 6573 7473 2f74 6573  -west3 tests/tes
-00004720: 745f 7961 6d6c 732f 6763 705f 7065 725f  t_yamls/gcp_per_
-00004730: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
-00004740: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00004750: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00004760: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-00004770: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
-00004780: 6f6e 5f69 6d61 6765 732e 7961 6d6c 272c  on_images.yaml',
-00004790: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000047a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-000047b0: 2d63 6c6f 7564 2067 6370 202d 2d72 6567  -cloud gcp --reg
-000047c0: 696f 6e20 7573 2d77 6573 7433 2022 6c73  ion us-west3 "ls
-000047d0: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
-000047e0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-000047f0: 6d65 7d20 226c 7320 7e22 272c 0a20 2020  me} "ls ~"',.   
-00004800: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00004810: 6f67 7320 7b6e 616d 657d 2034 202d 2d73  ogs {name} 4 --s
-00004820: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00004830: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00004840: 6e61 6d65 7d20 3520 2d2d 7374 6174 7573  name} 5 --status
-00004850: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004860: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00004870: 2036 202d 2d73 7461 7475 7327 2c0a 2020   6 --status',.  
-00004880: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004890: 6c6f 6773 207b 6e61 6d65 7d20 3720 2d2d  logs {name} 7 --
-000048a0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-000048b0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-000048c0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-000048d0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-000048e0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000048f0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-00004900: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-00004910: 696d 6167 655f 6964 5f64 6963 745f 7a6f  image_id_dict_zo
-00004920: 6e65 2829 3a0a 2020 2020 6e61 6d65 203d  ne():.    name =
-00004930: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00004940: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00004950: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00004960: 7773 5f69 6d61 6765 5f69 645f 6469 6374  ws_image_id_dict
-00004970: 5f7a 6f6e 6527 2c0a 2020 2020 2020 2020  _zone',.        
-00004980: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-00004990: 5573 6520 7a6f 6e65 2074 6f20 6669 6c74  Use zone to filt
-000049a0: 6572 2069 6d61 6765 5f69 6420 6469 6374  er image_id dict
-000049b0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000049c0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000049d0: 207b 6e61 6d65 7d20 2d2d 7a6f 6e65 2075   {name} --zone u
-000049e0: 732d 6561 7374 2d31 6220 6578 616d 706c  s-east-1b exampl
-000049f0: 6573 2f70 6572 5f72 6567 696f 6e5f 696d  es/per_region_im
-00004a00: 6167 6573 2e79 616d 6c20 2626 2065 7869  ages.yaml && exi
-00004a10: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
-00004a20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004a30: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
-00004a40: 616d 657d 2026 2620 6578 6974 2031 207c  ame} && exit 1 |
-00004a50: 7c20 7472 7565 272c 2020 2320 456e 7375  | true',  # Ensu
-00004a60: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
-00004a70: 7320 6e6f 7420 6372 6561 7465 642e 0a20  s not created.. 
-00004a80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004a90: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00004aa0: 616d 657d 202d 2d7a 6f6e 6520 7573 2d77  ame} --zone us-w
-00004ab0: 6573 742d 3261 2065 7861 6d70 6c65 732f  est-2a examples/
-00004ac0: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-00004ad0: 732e 7961 6d6c 272c 0a20 2020 2020 2020  s.yaml',.       
-00004ae0: 2020 2020 2023 2053 686f 756c 6420 7375       # Should su
-00004af0: 6363 6573 7320 6265 6361 7573 6520 7468  ccess because th
-00004b00: 6520 696d 6167 6520 6964 206d 6174 6368  e image id match
-00004b10: 2066 6f72 2074 6865 207a 6f6e 652e 0a20   for the zone.. 
-00004b20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004b30: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00004b40: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
-00004b50: 736b 7970 696c 6f74 3a67 7075 2d75 6275  skypilot:gpu-ubu
-00004b60: 6e74 752d 3138 3034 2065 7861 6d70 6c65  ntu-1804 example
-00004b70: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00004b80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004b90: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00004ba0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00004bb0: 6f74 3a67 7075 2d75 6275 6e74 752d 3138  ot:gpu-ubuntu-18
-00004bc0: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
-00004bd0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00004be0: 2020 2020 2020 2023 2046 6169 6c20 6475         # Fail du
-00004bf0: 6520 746f 2069 6d61 6765 2069 6420 6d69  e to image id mi
-00004c00: 736d 6174 6368 2e0a 2020 2020 2020 2020  smatch..        
-00004c10: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004c20: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
-00004c30: 2073 6b79 7069 6c6f 743a 6770 752d 7562   skypilot:gpu-ub
-00004c40: 756e 7475 2d32 3030 3420 6578 616d 706c  untu-2004 exampl
-00004c50: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
-00004c60: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00004c70: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00004c80: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004c90: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
-00004ca0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004cb0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-00004cc0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00004cd0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00004ce0: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
-00004cf0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00004d00: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00004d10: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
-00004d20: 7d20 7c20 6772 6570 2075 732d 7765 7374  } | grep us-west
-00004d30: 2d32 6127 2c20 2023 2045 6e73 7572 6520  -2a',  # Ensure 
-00004d40: 7468 6520 7a6f 6e65 2069 7320 636f 7272  the zone is corr
-00004d50: 6563 742e 0a20 2020 2020 2020 2020 2020  ect..           
-00004d60: 2023 2045 6e73 7572 6520 6578 6563 2077   # Ensure exec w
-00004d70: 6f72 6b73 2e0a 2020 2020 2020 2020 2020  orks..          
-00004d80: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00004d90: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 7765  me} --zone us-we
-00004da0: 7374 2d32 6120 6578 616d 706c 6573 2f70  st-2a examples/p
-00004db0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-00004dc0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00004dd0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004de0: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
-00004df0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-00004e00: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00004e10: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004e20: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
-00004e30: 7320 2d2d 7265 6769 6f6e 2075 732d 7765  s --region us-we
-00004e40: 7374 2d32 2022 6c73 207e 2227 2c0a 2020  st-2 "ls ~"',.  
-00004e50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00004e60: 6578 6563 207b 6e61 6d65 7d20 226c 7320  exec {name} "ls 
-00004e70: 7e22 272c 0a20 2020 2020 2020 2020 2020  ~"',.           
-00004e80: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004e90: 657d 2034 202d 2d73 7461 7475 7327 2c0a  e} 4 --status',.
-00004ea0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004eb0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3520  y logs {name} 5 
-00004ec0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00004ed0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00004ee0: 7320 7b6e 616d 657d 2036 202d 2d73 7461  s {name} 6 --sta
-00004ef0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00004f00: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00004f10: 6d65 7d20 3720 2d2d 7374 6174 7573 272c  me} 7 --status',
-00004f20: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00004f30: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00004f40: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00004f50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00004f60: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00004f70: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00004f80: 6573 745f 6763 705f 696d 6167 655f 6964  est_gcp_image_id
-00004f90: 5f64 6963 745f 7a6f 6e65 2829 3a0a 2020  _dict_zone():.  
-00004fa0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00004fb0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00004fc0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00004fd0: 2020 2020 2020 2767 6370 5f69 6d61 6765        'gcp_image
-00004fe0: 5f69 645f 6469 6374 5f7a 6f6e 6527 2c0a  _id_dict_zone',.
-00004ff0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00005000: 2020 2020 2020 2320 5573 6520 7a6f 6e65        # Use zone
-00005010: 2074 6f20 6669 6c74 6572 2069 6d61 6765   to filter image
-00005020: 5f69 6420 6469 6374 2e0a 2020 2020 2020  _id dict..      
-00005030: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00005040: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00005050: 2d2d 7a6f 6e65 2075 732d 6561 7374 312d  --zone us-east1-
-00005060: 6120 7465 7374 732f 7465 7374 5f79 616d  a tests/test_yam
-00005070: 6c73 2f67 6370 5f70 6572 5f72 6567 696f  ls/gcp_per_regio
-00005080: 6e5f 696d 6167 6573 2e79 616d 6c20 2626  n_images.yaml &&
-00005090: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-000050a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000050b0: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
-000050c0: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
-000050d0: 2031 207c 7c20 7472 7565 272c 2020 2320   1 || true',  # 
-000050e0: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-000050f0: 6572 2069 7320 6e6f 7420 6372 6561 7465  er is not create
-00005100: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00005110: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00005120: 6320 7b6e 616d 657d 202d 2d7a 6f6e 6520  c {name} --zone 
-00005130: 7573 2d63 656e 7472 616c 312d 6120 7465  us-central1-a te
-00005140: 7374 732f 7465 7374 5f79 616d 6c73 2f67  sts/test_yamls/g
-00005150: 6370 5f70 6572 5f72 6567 696f 6e5f 696d  cp_per_region_im
-00005160: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
-00005170: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
-00005180: 2073 7563 6365 7373 2062 6563 6175 7365   success because
-00005190: 2074 6865 2069 6d61 6765 2069 6420 6d61   the image id ma
-000051a0: 7463 6820 666f 7220 7468 6520 7a6f 6e65  tch for the zone
-000051b0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000051c0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000051d0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000051e0: 6763 7020 2d2d 696d 6167 652d 6964 2073  gcp --image-id s
-000051f0: 6b79 7069 6c6f 743a 6370 752d 6465 6269  kypilot:cpu-debi
-00005200: 616e 2d31 3020 7465 7374 732f 7465 7374  an-10 tests/test
-00005210: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00005220: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00005230: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00005240: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
-00005250: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
-00005260: 6c6f 743a 6370 752d 6465 6269 616e 2d31  lot:cpu-debian-1
-00005270: 3020 7465 7374 732f 7465 7374 5f79 616d  0 tests/test_yam
-00005280: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00005290: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000052a0: 4661 696c 2064 7565 2074 6f20 696d 6167  Fail due to imag
-000052b0: 6520 6964 206d 6973 6d61 7463 682e 0a20  e id mismatch.. 
-000052c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000052d0: 2065 7865 6320 7b6e 616d 657d 202d 2d63   exec {name} --c
-000052e0: 6c6f 7564 2067 6370 202d 2d69 6d61 6765  loud gcp --image
-000052f0: 2d69 6420 736b 7970 696c 6f74 3a67 7075  -id skypilot:gpu
-00005300: 2d64 6562 6961 6e2d 3130 2074 6573 7473  -debian-10 tests
-00005310: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00005320: 6d61 6c2e 7961 6d6c 2026 2620 6578 6974  mal.yaml && exit
-00005330: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
-00005340: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00005350: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00005360: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00005370: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005380: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-00005390: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000053a0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000053b0: 2033 202d 2d73 7461 7475 7327 2c0a 2020   3 --status',.  
-000053c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000053d0: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-000053e0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-000053f0: 7020 7573 2d63 656e 7472 616c 3127 2c20  p us-central1', 
-00005400: 2023 2045 6e73 7572 6520 7468 6520 7a6f   # Ensure the zo
-00005410: 6e65 2069 7320 636f 7272 6563 742e 0a20  ne is correct.. 
-00005420: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-00005430: 7572 6520 6578 6563 2077 6f72 6b73 2e0a  ure exec works..
-00005440: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005450: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00005460: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
-00005470: 2075 732d 6365 6e74 7261 6c31 2d61 2074   us-central1-a t
-00005480: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-00005490: 6763 705f 7065 725f 7265 6769 6f6e 5f69  gcp_per_region_i
-000054a0: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-000054b0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-000054c0: 7865 6320 7b6e 616d 657d 2074 6573 7473  xec {name} tests
-000054d0: 2f74 6573 745f 7961 6d6c 732f 6763 705f  /test_yamls/gcp_
-000054e0: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-000054f0: 732e 7961 6d6c 272c 0a20 2020 2020 2020  s.yaml',.       
-00005500: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00005510: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00005520: 6370 202d 2d72 6567 696f 6e20 7573 2d63  cp --region us-c
-00005530: 656e 7472 616c 3120 226c 7320 7e22 272c  entral1 "ls ~"',
-00005540: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005550: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00005560: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
-00005570: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005580: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
-00005590: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000055a0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000055b0: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
-000055c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000055d0: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
-000055e0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-000055f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00005600: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
-00005610: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-00005620: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00005630: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00005640: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00005650: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00005660: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-00005670: 6620 7465 7374 5f63 6c6f 6e65 5f64 6973  f test_clone_dis
-00005680: 6b5f 6177 7328 293a 0a20 2020 206e 616d  k_aws():.    nam
-00005690: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000056a0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000056b0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000056c0: 2027 636c 6f6e 655f 6469 736b 5f61 7773   'clone_disk_aws
-000056d0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000056e0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000056f0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00005700: 657d 202d 2d63 6c6f 7564 2061 7773 202d  e} --cloud aws -
-00005710: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
-00005720: 3220 2d2d 7265 7472 792d 756e 7469 6c2d  2 --retry-until-
-00005730: 7570 2022 6563 686f 2068 656c 6c6f 203e  up "echo hello >
-00005740: 207e 2f75 7365 725f 6669 6c65 2e74 7874   ~/user_file.txt
-00005750: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00005760: 6627 736b 7920 6c61 756e 6368 202d 2d63  f'sky launch --c
-00005770: 6c6f 6e65 2d64 6973 6b2d 6672 6f6d 207b  lone-disk-from {
-00005780: 6e61 6d65 7d20 2d79 202d 6320 7b6e 616d  name} -y -c {nam
-00005790: 657d 2d63 6c6f 6e65 2026 2620 6578 6974  e}-clone && exit
-000057a0: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
-000057b0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000057c0: 746f 7020 7b6e 616d 657d 202d 7927 2c0a  top {name} -y',.
-000057d0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-000057e0: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-000057f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00005800: 202d 2d63 6c6f 6e65 2d64 6973 6b2d 6672   --clone-disk-fr
-00005810: 6f6d 207b 6e61 6d65 7d20 2d79 202d 6320  om {name} -y -c 
-00005820: 7b6e 616d 657d 2d63 6c6f 6e65 202d 2d63  {name}-clone --c
-00005830: 6c6f 7564 2061 7773 202d 6420 2d2d 7265  loud aws -d --re
-00005840: 6769 6f6e 2075 732d 7765 7374 2d32 2022  gion us-west-2 "
-00005850: 6361 7420 7e2f 7573 6572 5f66 696c 652e  cat ~/user_file.
-00005860: 7478 7420 7c20 6772 6570 2068 656c 6c6f  txt | grep hello
-00005870: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00005880: 6627 736b 7920 6c61 756e 6368 202d 2d63  f'sky launch --c
-00005890: 6c6f 6e65 2d64 6973 6b2d 6672 6f6d 207b  lone-disk-from {
-000058a0: 6e61 6d65 7d20 2d79 202d 6320 7b6e 616d  name} -y -c {nam
-000058b0: 657d 2d63 6c6f 6e65 2d32 202d 2d63 6c6f  e}-clone-2 --clo
-000058c0: 7564 2061 7773 202d 6420 2d2d 7265 6769  ud aws -d --regi
-000058d0: 6f6e 2075 732d 6561 7374 2d32 2022 6361  on us-east-2 "ca
-000058e0: 7420 7e2f 7573 6572 5f66 696c 652e 7478  t ~/user_file.tx
-000058f0: 7420 7c20 6772 6570 2068 656c 6c6f 2227  t | grep hello"'
-00005900: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00005910: 736b 7920 6c6f 6773 207b 6e61 6d65 7d2d  sky logs {name}-
-00005920: 636c 6f6e 6520 3120 2d2d 7374 6174 7573  clone 1 --status
-00005930: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005940: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00005950: 2d63 6c6f 6e65 2d32 2031 202d 2d73 7461  -clone-2 1 --sta
-00005960: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-00005970: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00005980: 6f77 6e20 2d79 207b 6e61 6d65 7d20 7b6e  own -y {name} {n
-00005990: 616d 657d 2d63 6c6f 6e65 207b 6e61 6d65  ame}-clone {name
-000059a0: 7d2d 636c 6f6e 652d 3227 2c0a 2020 2020  }-clone-2',.    
-000059b0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
-000059c0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-000059d0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-000059e0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-000059f0: 2e67 6370 0a64 6566 2074 6573 745f 636c  .gcp.def test_cl
-00005a00: 6f6e 655f 6469 736b 5f67 6370 2829 3a0a  one_disk_gcp():.
-00005a10: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00005a20: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00005a30: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00005a40: 2020 2020 2020 2020 2763 6c6f 6e65 5f64          'clone_d
-00005a50: 6973 6b5f 6763 7027 2c0a 2020 2020 2020  isk_gcp',.      
-00005a60: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00005a70: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00005a80: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00005a90: 6420 6763 7020 2d2d 7a6f 6e65 2075 732d  d gcp --zone us-
-00005aa0: 6561 7374 312d 6220 2d2d 7265 7472 792d  east1-b --retry-
-00005ab0: 756e 7469 6c2d 7570 2022 6563 686f 2068  until-up "echo h
-00005ac0: 656c 6c6f 203e 207e 2f75 7365 725f 6669  ello > ~/user_fi
-00005ad0: 6c65 2e74 7874 2227 2c0a 2020 2020 2020  le.txt"',.      
-00005ae0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00005af0: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
-00005b00: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
-00005b10: 6320 7b6e 616d 657d 2d63 6c6f 6e65 2026  c {name}-clone &
-00005b20: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
-00005b30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005b40: 2773 6b79 2073 746f 7020 7b6e 616d 657d  'sky stop {name}
-00005b50: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
-00005b60: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00005b70: 2d63 6c6f 6e65 2d64 6973 6b2d 6672 6f6d  -clone-disk-from
-00005b80: 207b 6e61 6d65 7d20 2d79 202d 6320 7b6e   {name} -y -c {n
-00005b90: 616d 657d 2d63 6c6f 6e65 202d 2d63 6c6f  ame}-clone --clo
-00005ba0: 7564 2067 6370 202d 2d7a 6f6e 6520 7573  ud gcp --zone us
-00005bb0: 2d63 656e 7472 616c 312d 6120 2263 6174  -central1-a "cat
-00005bc0: 207e 2f75 7365 725f 6669 6c65 2e74 7874   ~/user_file.txt
-00005bd0: 207c 2067 7265 7020 6865 6c6c 6f22 272c   | grep hello"',
-00005be0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005bf0: 6b79 206c 6175 6e63 6820 2d2d 636c 6f6e  ky launch --clon
-00005c00: 652d 6469 736b 2d66 726f 6d20 7b6e 616d  e-disk-from {nam
-00005c10: 657d 202d 7920 2d63 207b 6e61 6d65 7d2d  e} -y -c {name}-
-00005c20: 636c 6f6e 652d 3220 2d2d 636c 6f75 6420  clone-2 --cloud 
-00005c30: 6763 7020 2d2d 7a6f 6e65 2075 732d 6561  gcp --zone us-ea
-00005c40: 7374 312d 6220 2263 6174 207e 2f75 7365  st1-b "cat ~/use
-00005c50: 725f 6669 6c65 2e74 7874 207c 2067 7265  r_file.txt | gre
-00005c60: 7020 6865 6c6c 6f22 272c 0a20 2020 2020  p hello"',.     
-00005c70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00005c80: 7320 7b6e 616d 657d 2d63 6c6f 6e65 2031  s {name}-clone 1
-00005c90: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00005ca0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00005cb0: 6773 207b 6e61 6d65 7d2d 636c 6f6e 652d  gs {name}-clone-
-00005cc0: 3220 3120 2d2d 7374 6174 7573 272c 0a20  2 1 --status',. 
-00005cd0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00005ce0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00005cf0: 7b6e 616d 657d 207b 6e61 6d65 7d2d 636c  {name} {name}-cl
-00005d00: 6f6e 6520 7b6e 616d 657d 2d63 6c6f 6e65  one {name}-clone
-00005d10: 2d32 272c 0a20 2020 2029 0a20 2020 2072  -2',.    ).    r
-00005d20: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00005d30: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00005d40: 2e61 7773 0a64 6566 2074 6573 745f 696d  .aws.def test_im
-00005d50: 6167 655f 6e6f 5f63 6f6e 6461 2829 3a0a  age_no_conda():.
-00005d60: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00005d70: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00005d80: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00005d90: 2020 2020 2020 2020 2769 6d61 6765 5f6e          'image_n
-00005da0: 6f5f 636f 6e64 6127 2c0a 2020 2020 2020  o_conda',.      
-00005db0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00005dc0: 2320 5573 6520 696d 6167 6520 6964 2064  # Use image id d
-00005dd0: 6963 742e 0a20 2020 2020 2020 2020 2020  ict..           
-00005de0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00005df0: 202d 6320 7b6e 616d 657d 202d 2d72 6567   -c {name} --reg
-00005e00: 696f 6e20 7573 2d65 6173 742d 3220 6578  ion us-east-2 ex
-00005e10: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
-00005e20: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
-00005e30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005e40: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00005e50: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00005e60: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
-00005e70: 7020 7b6e 616d 657d 202d 7927 2c0a 2020  p {name} -y',.  
-00005e80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005e90: 7374 6172 7420 7b6e 616d 657d 202d 7927  start {name} -y'
-00005ea0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00005eb0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00005ec0: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
-00005ed0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-00005ee0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00005ef0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00005f00: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-00005f10: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00005f20: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00005f30: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00005f40: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00005f50: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00005f60: 2d2d 2d2d 2054 6573 7420 7374 616c 6520  ---- Test stale 
-00005f70: 6a6f 6220 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  job ------------
-00005f80: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00005f90: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-00005fa0: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-00005fb0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00005fc0: 746f 7070 696e 6720 696e 7374 616e 6365  topping instance
-00005fd0: 730a 6465 6620 7465 7374 5f73 7461 6c65  s.def test_stale
-00005fe0: 5f6a 6f62 2867 656e 6572 6963 5f63 6c6f  _job(generic_clo
-00005ff0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00006000: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00006010: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00006020: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00006030: 2020 2773 7461 6c65 5f6a 6f62 272c 0a20    'stale_job',. 
-00006040: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00006050: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00006060: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00006070: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00006080: 636c 6f75 647d 2022 6563 686f 2068 6922  cloud} "echo hi"
-00006090: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000060a0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000060b0: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
-000060c0: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
-000060d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000060e0: 7920 7374 6f70 207b 6e61 6d65 7d20 2d79  y stop {name} -y
-000060f0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00006100: 736c 6565 7020 3130 3027 2c20 2023 2045  sleep 100',  # E
-00006110: 6e73 7572 6520 7468 6973 2069 7320 6c61  nsure this is la
-00006120: 7267 6520 656e 6f75 6768 2c20 656c 7365  rge enough, else
-00006130: 2047 4350 206c 6561 6b73 2e0a 2020 2020   GCP leaks..    
-00006140: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00006150: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
-00006160: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006170: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00006180: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00006190: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-000061a0: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-000061b0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-000061c0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-000061d0: 207c 2067 7265 7020 4641 494c 4544 272c   | grep FAILED',
-000061e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000061f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00006200: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00006210: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00006220: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00006230: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
-00006240: 6573 745f 6177 735f 7374 616c 655f 6a6f  est_aws_stale_jo
-00006250: 625f 6d61 6e75 616c 5f72 6573 7461 7274  b_manual_restart
-00006260: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00006270: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00006280: 2829 0a20 2020 2072 6567 696f 6e20 3d20  ().    region = 
-00006290: 2775 732d 7765 7374 2d32 270a 2020 2020  'us-west-2'.    
-000062a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000062b0: 2020 2020 2027 6177 735f 7374 616c 655f       'aws_stale_
-000062c0: 6a6f 625f 6d61 6e75 616c 5f72 6573 7461  job_manual_resta
-000062d0: 7274 272c 0a20 2020 2020 2020 205b 0a20  rt',.        [. 
-000062e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000062f0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00006300: 616d 657d 202d 2d63 6c6f 7564 2061 7773  ame} --cloud aws
-00006310: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00006320: 6e7d 2022 6563 686f 2068 6922 272c 0a20  n} "echo hi"',. 
-00006330: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006340: 2065 7865 6320 7b6e 616d 657d 202d 6420   exec {name} -d 
-00006350: 2265 6368 6f20 7374 6172 743b 2073 6c65  "echo start; sle
-00006360: 6570 2031 3030 3030 2227 2c0a 2020 2020  ep 10000"',.    
-00006370: 2020 2020 2020 2020 2320 5374 6f70 2074          # Stop t
-00006380: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
-00006390: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-000063a0: 2066 2769 643d 6061 7773 2065 6332 2064   f'id=`aws ec2 d
-000063b0: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
-000063c0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-000063d0: 6f6e 7d20 2d2d 6669 6c74 6572 7320 270a  on} --filters '.
-000063e0: 2020 2020 2020 2020 2020 2020 6627 4e61              f'Na
-000063f0: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
-00006400: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
-00006410: 6e61 6d65 7d20 270a 2020 2020 2020 2020  name} '.        
-00006420: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-00006430: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00006440: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-00006450: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-00006460: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-00006470: 603b 2027 0a20 2020 2020 2020 2020 2020  `; '.           
-00006480: 2066 2761 7773 2065 6332 2073 746f 702d   f'aws ec2 stop-
-00006490: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-000064a0: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-000064b0: 2020 2020 2020 2020 2020 272d 2d69 6e73            '--ins
-000064c0: 7461 6e63 652d 6964 7320 2469 6427 2c0a  tance-ids $id',.
-000064d0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-000064e0: 6570 2034 3027 2c0a 2020 2020 2020 2020  ep 40',.        
-000064f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00006500: 202d 6320 7b6e 616d 657d 202d 7920 2265   -c {name} -y "e
-00006510: 6368 6f20 6869 2227 2c0a 2020 2020 2020  cho hi"',.      
-00006520: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00006530: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-00006540: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00006550: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00006560: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00006570: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00006580: 7375 7265 2074 6865 2073 6b79 6c65 7420  sure the skylet 
-00006590: 7570 6461 7465 6420 7468 6520 7374 616c  updated the stal
-000065a0: 6520 6a6f 6220 7374 6174 7573 2e0a 2020  e job status..  
-000065b0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
-000065c0: 7020 7b65 7665 6e74 732e 4a6f 6253 6368  p {events.JobSch
-000065d0: 6564 756c 6572 4576 656e 742e 4556 454e  edulerEvent.EVEN
-000065e0: 545f 494e 5445 5256 414c 5f53 4543 4f4e  T_INTERVAL_SECON
-000065f0: 4453 7d27 2c0a 2020 2020 2020 2020 2020  DS}',.          
-00006600: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-00006610: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-00006620: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00006630: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-00006640: 6570 2046 4149 4c45 4427 2c0a 2020 2020  ep FAILED',.    
-00006650: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00006660: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00006670: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00006680: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00006690: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000066a0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-000066b0: 6370 5f73 7461 6c65 5f6a 6f62 5f6d 616e  cp_stale_job_man
-000066c0: 7561 6c5f 7265 7374 6172 7428 293a 0a20  ual_restart():. 
-000066d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-000066e0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-000066f0: 2020 7a6f 6e65 203d 2027 7573 2d77 6573    zone = 'us-wes
-00006700: 7432 2d61 270a 2020 2020 7175 6572 795f  t2-a'.    query_
-00006710: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
-00006720: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
-00006730: 7320 6c69 7374 202d 2d66 696c 7465 723d  s list --filter=
-00006740: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00006750: 2020 2066 2722 286c 6162 656c 732e 7261     f'"(labels.ra
-00006760: 792d 636c 7573 7465 722d 6e61 6d65 3d7b  y-cluster-name={
-00006770: 6e61 6d65 7d29 2220 270a 2020 2020 2020  name})" '.      
-00006780: 2020 2020 2020 2020 2020 2066 272d 2d7a             f'--z
-00006790: 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d 666f  ones={zone} --fo
-000067a0: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
-000067b0: 2922 2729 0a20 2020 2073 746f 705f 636d  )"').    stop_cm
-000067c0: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
-000067d0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-000067e0: 7374 6f70 202d 2d7a 6f6e 653d 7b7a 6f6e  stop --zone={zon
-000067f0: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
-00006800: 2020 2020 6627 202d 2d71 7569 6574 2024      f' --quiet $
-00006810: 287b 7175 6572 795f 636d 647d 2927 290a  ({query_cmd})').
-00006820: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00006830: 0a20 2020 2020 2020 2027 6763 705f 7374  .        'gcp_st
-00006840: 616c 655f 6a6f 625f 6d61 6e75 616c 5f72  ale_job_manual_r
-00006850: 6573 7461 7274 272c 0a20 2020 2020 2020  estart',.       
-00006860: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00006870: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00006880: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00006890: 2067 6370 202d 2d7a 6f6e 6520 7b7a 6f6e   gcp --zone {zon
-000068a0: 657d 2022 6563 686f 2068 6922 272c 0a20  e} "echo hi"',. 
-000068b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000068c0: 2065 7865 6320 7b6e 616d 657d 202d 6420   exec {name} -d 
-000068d0: 2265 6368 6f20 7374 6172 743b 2073 6c65  "echo start; sle
-000068e0: 6570 2031 3030 3030 2227 2c0a 2020 2020  ep 10000"',.    
-000068f0: 2020 2020 2020 2020 2320 5374 6f70 2074          # Stop t
-00006900: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
-00006910: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-00006920: 2073 746f 705f 636d 642c 0a20 2020 2020   stop_cmd,.     
-00006930: 2020 2020 2020 2027 736c 6565 7020 3430         'sleep 40
-00006940: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006950: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-00006960: 6e61 6d65 7d20 2d79 2022 6563 686f 2068  name} -y "echo h
-00006970: 6922 272c 0a20 2020 2020 2020 2020 2020  i"',.           
-00006980: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00006990: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-000069a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000069b0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-000069c0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000069d0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-000069e0: 7468 6520 736b 796c 6574 2075 7064 6174  the skylet updat
-000069f0: 6564 2074 6865 2073 7461 6c65 206a 6f62  ed the stale job
-00006a00: 2073 7461 7475 732e 0a20 2020 2020 2020   status..       
-00006a10: 2020 2020 2066 2773 6c65 6570 207b 6576       f'sleep {ev
-00006a20: 656e 7473 2e4a 6f62 5363 6865 6475 6c65  ents.JobSchedule
-00006a30: 7245 7665 6e74 2e45 5645 4e54 5f49 4e54  rEvent.EVENT_INT
-00006a40: 4552 5641 4c5f 5345 434f 4e44 537d 272c  ERVAL_SECONDS}',
-00006a50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006a60: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-00006a70: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-00006a80: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-00006a90: 6f20 2224 7322 207c 2067 7265 7020 4641  o "$s" | grep FA
-00006aa0: 494c 4544 272c 0a20 2020 2020 2020 205d  ILED',.        ]
-00006ab0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00006ac0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00006ad0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00006ae0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00006af0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2043 6865  # ---------- Che
-00006b00: 636b 2053 6b79 2773 2065 6e76 6972 6f6e  ck Sky's environ
-00006b10: 6d65 6e74 2076 6172 6961 626c 6573 3b20  ment variables; 
-00006b20: 776f 726b 6469 722e 202d 2d2d 2d2d 2d2d  workdir. -------
-00006b30: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00006b40: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-00006b50: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00006b60: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
-00006b70: 740a 6465 6620 7465 7374 5f65 6e76 5f63  t.def test_env_c
-00006b80: 6865 636b 2867 656e 6572 6963 5f63 6c6f  heck(generic_clo
-00006b90: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00006ba0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00006bb0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00006bc0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00006bd0: 2020 2765 6e76 5f63 6865 636b 272c 0a20    'env_check',. 
-00006be0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00006bf0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00006c00: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00006c10: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00006c20: 636c 6f75 647d 202d 2d64 6574 6163 682d  cloud} --detach-
-00006c30: 7365 7475 7020 6578 616d 706c 6573 2f65  setup examples/e
-00006c40: 6e76 5f63 6865 636b 2e79 616d 6c27 2c0a  nv_check.yaml',.
-00006c50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006c60: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00006c70: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00006c80: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00006c90: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-00006ca0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00006cb0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00006cc0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00006cd0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00006ce0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 6669  .# ---------- fi
-00006cf0: 6c65 5f6d 6f75 6e74 7320 2d2d 2d2d 2d2d  le_mounts ------
-00006d00: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00006d10: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
-00006d20: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00006d30: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
-00006d40: 6574 2e20 5275 6e20 7465 7374 5f73 6370  et. Run test_scp
-00006d50: 5f66 696c 655f 6d6f 756e 7473 2069 6e73  _file_mounts ins
-00006d60: 7465 6164 2e0a 6465 6620 7465 7374 5f66  tead..def test_f
-00006d70: 696c 655f 6d6f 756e 7473 2867 656e 6572  ile_mounts(gener
-00006d80: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-00006d90: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00006da0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00006db0: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
-00006dc0: 203d 205b 0a20 2020 2020 2020 202a 7374   = [.        *st
-00006dd0: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
-00006de0: 616e 6473 2c0a 2020 2020 2020 2020 6627  ands,.        f'
-00006df0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00006e00: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00006e10: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00006e20: 6578 616d 706c 6573 2f75 7369 6e67 5f66  examples/using_f
-00006e30: 696c 655f 6d6f 756e 7473 2e79 616d 6c27  ile_mounts.yaml'
-00006e40: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00006e50: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00006e60: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00006e70: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00006e80: 6564 6564 2e0a 2020 2020 5d0a 2020 2020  eded..    ].    
-00006e90: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00006ea0: 2020 2020 2027 7573 696e 675f 6669 6c65       'using_file
-00006eb0: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
-00006ec0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-00006ed0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00006ee0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00006ef0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00006f00: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
-00006f10: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
-00006f20: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00006f30: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00006f40: 7363 700a 6465 6620 7465 7374 5f73 6370  scp.def test_scp
-00006f50: 5f66 696c 655f 6d6f 756e 7473 2829 3a0a  _file_mounts():.
-00006f60: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00006f70: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00006f80: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
-00006f90: 203d 205b 0a20 2020 2020 2020 202a 7374   = [.        *st
-00006fa0: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
-00006fb0: 616e 6473 2c0a 2020 2020 2020 2020 6627  ands,.        f'
-00006fc0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00006fd0: 207b 6e61 6d65 7d20 7b53 4350 5f54 5950   {name} {SCP_TYP
-00006fe0: 457d 202d 2d6e 756d 2d6e 6f64 6573 2031  E} --num-nodes 1
-00006ff0: 2065 7861 6d70 6c65 732f 7573 696e 675f   examples/using_
-00007000: 6669 6c65 5f6d 6f75 6e74 732e 7961 6d6c  file_mounts.yaml
-00007010: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
-00007020: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00007030: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00007040: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00007050: 6565 6465 642e 0a20 2020 205d 0a20 2020  eeded..    ].   
-00007060: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00007070: 2020 2020 2020 2753 4350 5f75 7369 6e67        'SCP_using
-00007080: 5f66 696c 655f 6d6f 756e 7473 272c 0a20  _file_mounts',. 
-00007090: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-000070a0: 616e 6473 2c0a 2020 2020 2020 2020 6627  ands,.        f'
-000070b0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-000070c0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-000070d0: 656f 7574 3d32 3020 2a20 3630 2c20 2023  eout=20 * 60,  #
-000070e0: 2032 3020 6d69 6e73 0a20 2020 2029 0a20   20 mins.    ). 
-000070f0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00007100: 7465 7374 290a 0a0a 6465 6620 7465 7374  test)...def test
-00007110: 5f75 7369 6e67 5f66 696c 655f 6d6f 756e  _using_file_moun
-00007120: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
-00007130: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00007140: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00007150: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00007160: 6d65 2829 0a20 2020 2074 6573 745f 636f  me().    test_co
-00007170: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
-00007180: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
-00007190: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
-000071a0: 2020 2020 2866 2773 6b79 206c 6175 6e63      (f'sky launc
-000071b0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-000071c0: 2d63 7075 7320 322b 202d 2d63 6c6f 7564  -cpus 2+ --cloud
-000071d0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-000071e0: 2027 0a20 2020 2020 2020 2020 2765 7861   '.         'exa
-000071f0: 6d70 6c65 732f 7573 696e 675f 6669 6c65  mples/using_file
-00007200: 5f6d 6f75 6e74 735f 7769 7468 5f65 6e76  _mounts_with_env
-00007210: 5f76 6172 732e 7961 6d6c 2729 2c0a 2020  _vars.yaml'),.  
-00007220: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00007230: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-00007240: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-00007250: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-00007260: 2e0a 2020 2020 2020 2020 2320 4f76 6572  ..        # Over
-00007270: 7269 6465 2077 6974 6820 2d2d 656e 763a  ride with --env:
-00007280: 0a20 2020 2020 2020 2028 6627 736b 7920  .        (f'sky 
-00007290: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-000072a0: 6d65 7d2d 3220 2d2d 6370 7573 2032 2b20  me}-2 --cpus 2+ 
-000072b0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000072c0: 5f63 6c6f 7564 7d20 270a 2020 2020 2020  _cloud} '.      
-000072d0: 2020 2027 6578 616d 706c 6573 2f75 7369     'examples/usi
-000072e0: 6e67 5f66 696c 655f 6d6f 756e 7473 5f77  ng_file_mounts_w
-000072f0: 6974 685f 656e 765f 7661 7273 2e79 616d  ith_env_vars.yam
-00007300: 6c20 270a 2020 2020 2020 2020 2027 2d2d  l '.         '--
-00007310: 656e 7620 4d59 5f4c 4f43 414c 5f50 4154  env MY_LOCAL_PAT
-00007320: 483d 746d 7066 696c 6527 292c 0a20 2020  H=tmpfile'),.   
-00007330: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00007340: 7b6e 616d 657d 2d32 2031 202d 2d73 7461  {name}-2 1 --sta
-00007350: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00007360: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00007370: 642e 0a20 2020 205d 0a20 2020 2074 6573  d..    ].    tes
-00007380: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00007390: 2020 2775 7369 6e67 5f66 696c 655f 6d6f    'using_file_mo
-000073a0: 756e 7473 5f77 6974 685f 656e 765f 7661  unts_with_env_va
-000073b0: 7273 272c 0a20 2020 2020 2020 2074 6573  rs',.        tes
-000073c0: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
-000073d0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-000073e0: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
-000073f0: 3227 2c0a 2020 2020 2020 2020 7469 6d65  2',.        time
-00007400: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-00007410: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
-00007420: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00007430: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00007440: 2d2d 2d20 7374 6f72 6167 6520 2d2d 2d2d  --- storage ----
-00007450: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00007460: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
-00007470: 5f61 7773 5f73 746f 7261 6765 5f6d 6f75  _aws_storage_mou
-00007480: 6e74 7328 293a 0a20 2020 206e 616d 6520  nts():.    name 
-00007490: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000074a0: 616d 6528 290a 2020 2020 7374 6f72 6167  ame().    storag
-000074b0: 655f 6e61 6d65 203d 2066 2773 6b79 2d74  e_name = f'sky-t
-000074c0: 6573 742d 7b69 6e74 2874 696d 652e 7469  est-{int(time.ti
-000074d0: 6d65 2829 297d 270a 2020 2020 7465 6d70  me())}'.    temp
-000074e0: 6c61 7465 5f73 7472 203d 2070 6174 686c  late_str = pathl
-000074f0: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
-00007500: 2027 7465 7374 732f 7465 7374 5f79 616d   'tests/test_yam
-00007510: 6c73 2f74 6573 745f 7374 6f72 6167 655f  ls/test_storage_
-00007520: 6d6f 756e 7469 6e67 2e79 616d 6c27 292e  mounting.yaml').
-00007530: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
-00007540: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
-00007550: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
-00007560: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
-00007570: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
-00007580: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
-00007590: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
-000075a0: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
-000075b0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
-000075c0: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
-000075d0: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
-000075e0: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
-000075f0: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
-00007600: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
-00007610: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
-00007620: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
-00007630: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
-00007640: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
-00007650: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
-00007660: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
-00007670: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00007680: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00007690: 7d20 2d2d 636c 6f75 6420 6177 7320 7b66  } --cloud aws {f
-000076a0: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
-000076b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000076c0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-000076d0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-000076e0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-000076f0: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
-00007700: 7320 7333 206c 7320 7b73 746f 7261 6765  s s3 ls {storage
-00007710: 5f6e 616d 657d 2f68 656c 6c6f 2e74 7874  _name}/hello.txt
-00007720: 272c 0a20 2020 2020 2020 205d 0a20 2020  ',.        ].   
-00007730: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-00007740: 280a 2020 2020 2020 2020 2020 2020 2761  (.            'a
-00007750: 7773 5f73 746f 7261 6765 5f6d 6f75 6e74  ws_storage_mount
-00007760: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00007770: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
-00007780: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00007790: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d3b   down -y {name};
-000077a0: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
-000077b0: 6574 6520 7b73 746f 7261 6765 5f6e 616d  ete {storage_nam
-000077c0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-000077d0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-000077e0: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
-000077f0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00007800: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00007810: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00007820: 2e67 6370 0a64 6566 2074 6573 745f 6763  .gcp.def test_gc
-00007830: 705f 7374 6f72 6167 655f 6d6f 756e 7473  p_storage_mounts
-00007840: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00007850: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00007860: 2829 0a20 2020 2073 746f 7261 6765 5f6e  ().    storage_n
-00007870: 616d 6520 3d20 6627 736b 792d 7465 7374  ame = f'sky-test
-00007880: 2d7b 696e 7428 7469 6d65 2e74 696d 6528  -{int(time.time(
-00007890: 2929 7d27 0a20 2020 2074 656d 706c 6174  ))}'.    templat
-000078a0: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
-000078b0: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
-000078c0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-000078d0: 7465 7374 5f73 746f 7261 6765 5f6d 6f75  test_storage_mou
-000078e0: 6e74 696e 672e 7961 6d6c 2729 2e72 6561  nting.yaml').rea
-000078f0: 645f 7465 7874 2829 0a20 2020 2074 656d  d_text().    tem
-00007900: 706c 6174 6520 3d20 6a69 6e6a 6132 2e54  plate = jinja2.T
-00007910: 656d 706c 6174 6528 7465 6d70 6c61 7465  emplate(template
-00007920: 5f73 7472 290a 2020 2020 636f 6e74 656e  _str).    conten
-00007930: 7420 3d20 7465 6d70 6c61 7465 2e72 656e  t = template.ren
-00007940: 6465 7228 7374 6f72 6167 655f 6e61 6d65  der(storage_name
-00007950: 3d73 746f 7261 6765 5f6e 616d 6529 0a20  =storage_name). 
-00007960: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
-00007970: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
-00007980: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
-00007990: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
-000079a0: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
-000079b0: 6974 6528 636f 6e74 656e 7429 0a20 2020  ite(content).   
-000079c0: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
-000079d0: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
-000079e0: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
-000079f0: 2020 7465 7374 5f63 6f6d 6d61 6e64 7320    test_commands 
-00007a00: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00007a10: 2a73 746f 7261 6765 5f73 6574 7570 5f63  *storage_setup_c
-00007a20: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
-00007a30: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00007a40: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00007a50: 2d63 6c6f 7564 2067 6370 207b 6669 6c65  -cloud gcp {file
-00007a60: 5f70 6174 687d 272c 0a20 2020 2020 2020  _path}',.       
-00007a70: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00007a80: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00007a90: 7327 2c20 2023 2045 6e73 7572 6520 6a6f  s',  # Ensure jo
-00007aa0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00007ab0: 2020 2020 2020 2020 2066 2767 7375 7469           f'gsuti
-00007ac0: 6c20 6c73 2067 733a 2f2f 7b73 746f 7261  l ls gs://{stora
-00007ad0: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
-00007ae0: 7874 272c 0a20 2020 2020 2020 205d 0a20  xt',.        ]. 
-00007af0: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
-00007b00: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00007b10: 2767 6370 5f73 746f 7261 6765 5f6d 6f75  'gcp_storage_mou
-00007b20: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
-00007b30: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-00007b40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007b50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00007b60: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
-00007b70: 656c 6574 6520 7b73 746f 7261 6765 5f6e  elete {storage_n
-00007b80: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00007b90: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00007ba0: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
-00007bb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00007bc0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00007bd0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00007be0: 726b 2e63 6c6f 7564 666c 6172 650a 6465  rk.cloudflare.de
-00007bf0: 6620 7465 7374 5f63 6c6f 7564 666c 6172  f test_cloudflar
-00007c00: 655f 7374 6f72 6167 655f 6d6f 756e 7473  e_storage_mounts
-00007c10: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00007c20: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00007c30: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00007c40: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
-00007c50: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
-00007c60: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
-00007c70: 6528 2929 7d27 0a20 2020 2074 656d 706c  e())}'.    templ
-00007c80: 6174 655f 7374 7220 3d20 7061 7468 6c69  ate_str = pathli
-00007c90: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
-00007ca0: 2774 6573 7473 2f74 6573 745f 7961 6d6c  'tests/test_yaml
-00007cb0: 732f 7465 7374 5f72 325f 7374 6f72 6167  s/test_r2_storag
-00007cc0: 655f 6d6f 756e 7469 6e67 2e79 616d 6c27  e_mounting.yaml'
-00007cd0: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
-00007ce0: 2020 7465 6d70 6c61 7465 203d 206a 696e    template = jin
-00007cf0: 6a61 322e 5465 6d70 6c61 7465 2874 656d  ja2.Template(tem
-00007d00: 706c 6174 655f 7374 7229 0a20 2020 2063  plate_str).    c
-00007d10: 6f6e 7465 6e74 203d 2074 656d 706c 6174  ontent = templat
-00007d20: 652e 7265 6e64 6572 2873 746f 7261 6765  e.render(storage
-00007d30: 5f6e 616d 653d 7374 6f72 6167 655f 6e61  _name=storage_na
-00007d40: 6d65 290a 2020 2020 656e 6470 6f69 6e74  me).    endpoint
-00007d50: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
-00007d60: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
-00007d70: 7428 290a 2020 2020 7769 7468 2074 656d  t().    with tem
-00007d80: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
-00007d90: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
-00007da0: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
-00007db0: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-00007dc0: 2066 2e77 7269 7465 2863 6f6e 7465 6e74   f.write(content
-00007dd0: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
-00007de0: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
-00007df0: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
-00007e00: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-00007e10: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
-00007e20: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
-00007e30: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
-00007e40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00007e50: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00007e60: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00007e70: 6572 6963 5f63 6c6f 7564 7d20 7b66 696c  eric_cloud} {fil
-00007e80: 655f 7061 7468 7d27 2c0a 2020 2020 2020  e_path}',.      
-00007e90: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00007ea0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-00007eb0: 7573 272c 2020 2320 456e 7375 7265 206a  us',  # Ensure j
-00007ec0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00007ed0: 2020 2020 2020 2020 2020 6627 4157 535f            f'AWS_
-00007ee0: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
-00007ef0: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
-00007f00: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
-00007f10: 4c53 5f50 4154 487d 2061 7773 2073 3320  LS_PATH} aws s3 
-00007f20: 6c73 2073 333a 2f2f 7b73 746f 7261 6765  ls s3://{storage
-00007f30: 5f6e 616d 657d 2f68 656c 6c6f 2e74 7874  _name}/hello.txt
-00007f40: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
-00007f50: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
-00007f60: 6669 6c65 3d72 3227 0a20 2020 2020 2020  file=r2'.       
-00007f70: 205d 0a0a 2020 2020 2020 2020 7465 7374   ]..        test
-00007f80: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00007f90: 2020 2020 2027 636c 6f75 6466 6c61 7265       'cloudflare
-00007fa0: 5f73 746f 7261 6765 5f6d 6f75 6e74 7327  _storage_mounts'
-00007fb0: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-00007fc0: 7374 5f63 6f6d 6d61 6e64 732c 0a20 2020  st_commands,.   
-00007fd0: 2020 2020 2020 2020 2066 2773 6b79 2064           f'sky d
-00007fe0: 6f77 6e20 2d79 207b 6e61 6d65 7d3b 2073  own -y {name}; s
-00007ff0: 6b79 2073 746f 7261 6765 2064 656c 6574  ky storage delet
-00008000: 6520 7b73 746f 7261 6765 5f6e 616d 657d  e {storage_name}
-00008010: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
-00008020: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
-00008030: 2023 2032 3020 6d69 6e73 0a20 2020 2020   # 20 mins.     
-00008040: 2020 2029 0a20 2020 2020 2020 2072 756e     ).        run
-00008050: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00008060: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2043  ..# ---------- C
-00008070: 4c49 206c 6f67 7320 2d2d 2d2d 2d2d 2d2d  LI logs --------
-00008080: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00008090: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-000080a0: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-000080b0: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-000080c0: 2e20 5275 6e20 7465 7374 5f73 6370 5f6c  . Run test_scp_l
-000080d0: 6f67 7320 696e 7374 6561 642e 0a64 6566  ogs instead..def
-000080e0: 2074 6573 745f 636c 695f 6c6f 6773 2867   test_cli_logs(g
-000080f0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-00008100: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-00008110: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00008120: 2829 0a20 2020 2074 696d 6573 7461 6d70  ().    timestamp
-00008130: 203d 2074 696d 652e 7469 6d65 2829 0a20   = time.time(). 
-00008140: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00008150: 2020 2020 2020 2020 2763 6c69 5f6c 6f67          'cli_log
-00008160: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-00008170: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00008180: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00008190: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-000081a0: 6572 6963 5f63 6c6f 7564 7d20 2d2d 6e75  eric_cloud} --nu
-000081b0: 6d2d 6e6f 6465 7320 3220 2265 6368 6f20  m-nodes 2 "echo 
-000081c0: 7b74 696d 6573 7461 6d70 7d20 3122 272c  {timestamp} 1"',
-000081d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000081e0: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-000081f0: 6563 686f 207b 7469 6d65 7374 616d 707d  echo {timestamp}
-00008200: 2032 2227 2c0a 2020 2020 2020 2020 2020   2"',.          
-00008210: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00008220: 6d65 7d20 2265 6368 6f20 7b74 696d 6573  me} "echo {times
-00008230: 7461 6d70 7d20 3322 272c 0a20 2020 2020  tamp} 3"',.     
-00008240: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00008250: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
-00008260: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
-00008270: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00008280: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00008290: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000082a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000082b0: 7320 7b6e 616d 657d 2033 2034 202d 2d73  s {name} 3 4 --s
-000082c0: 796e 632d 646f 776e 272c 0a20 2020 2020  ync-down',.     
-000082d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000082e0: 7320 7b6e 616d 657d 202a 202d 2d73 796e  s {name} * --syn
-000082f0: 632d 646f 776e 272c 0a20 2020 2020 2020  c-down',.       
-00008300: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00008310: 7b6e 616d 657d 2031 207c 2067 7265 7020  {name} 1 | grep 
-00008320: 227b 7469 6d65 7374 616d 707d 2031 2227  "{timestamp} 1"'
-00008330: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00008340: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00008350: 7c20 6772 6570 2022 7b74 696d 6573 7461  | grep "{timesta
-00008360: 6d70 7d20 3422 272c 0a20 2020 2020 2020  mp} 4"',.       
-00008370: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-00008380: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-00008390: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-000083a0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000083b0: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-000083c0: 6370 0a64 6566 2074 6573 745f 7363 705f  cp.def test_scp_
-000083d0: 6c6f 6773 2829 3a0a 2020 2020 6e61 6d65  logs():.    name
-000083e0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000083f0: 6e61 6d65 2829 0a20 2020 2074 696d 6573  name().    times
-00008400: 7461 6d70 203d 2074 696d 652e 7469 6d65  tamp = time.time
-00008410: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00008420: 7374 280a 2020 2020 2020 2020 2753 4350  st(.        'SCP
-00008430: 5f63 6c69 5f6c 6f67 7327 2c0a 2020 2020  _cli_logs',.    
-00008440: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00008450: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00008460: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
-00008470: 5f54 5950 457d 2022 6563 686f 207b 7469  _TYPE} "echo {ti
-00008480: 6d65 7374 616d 707d 2031 2227 2c0a 2020  mestamp} 1"',.  
-00008490: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000084a0: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
-000084b0: 6f20 7b74 696d 6573 7461 6d70 7d20 3222  o {timestamp} 2"
-000084c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000084d0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000084e0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-000084f0: 707d 2033 2227 2c0a 2020 2020 2020 2020  p} 3"',.        
-00008500: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00008510: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
-00008520: 6573 7461 6d70 7d20 3422 272c 0a20 2020  estamp} 4"',.   
-00008530: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00008540: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00008550: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00008560: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00008570: 6e61 6d65 7d20 3320 3420 2d2d 7379 6e63  name} 3 4 --sync
-00008580: 2d64 6f77 6e27 2c0a 2020 2020 2020 2020  -down',.        
-00008590: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000085a0: 6e61 6d65 7d20 2a20 2d2d 7379 6e63 2d64  name} * --sync-d
-000085b0: 6f77 6e27 2c0a 2020 2020 2020 2020 2020  own',.          
-000085c0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000085d0: 6d65 7d20 3120 7c20 6772 6570 2022 7b74  me} 1 | grep "{t
-000085e0: 696d 6573 7461 6d70 7d20 3122 272c 0a20  imestamp} 1"',. 
-000085f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008600: 206c 6f67 7320 7b6e 616d 657d 207c 2067   logs {name} | g
-00008610: 7265 7020 227b 7469 6d65 7374 616d 707d  rep "{timestamp}
-00008620: 2034 2227 2c0a 2020 2020 2020 2020 5d2c   4"',.        ],
-00008630: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00008640: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00008650: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00008660: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00008670: 202d 2d2d 2d2d 2d2d 2d2d 2d20 4a6f 6220   ---------- Job 
-00008680: 5175 6575 652e 202d 2d2d 2d2d 2d2d 2d2d  Queue. ---------
-00008690: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-000086a0: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-000086b0: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-000086c0: 6f65 7320 6e6f 7420 6861 7665 204b 3830  oes not have K80
-000086d0: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-000086e0: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-000086f0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-00008700: 6861 7665 204b 3830 2067 7075 732e 2072  have K80 gpus. r
-00008710: 756e 2074 6573 745f 6962 6d5f 6a6f 625f  un test_ibm_job_
-00008720: 7175 6575 6520 696e 7374 6561 640a 4070  queue instead.@p
-00008730: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-00008740: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-00008750: 7420 6861 7665 204b 3830 2067 7075 732e  t have K80 gpus.
-00008760: 2052 756e 2074 6573 745f 7363 705f 6a6f   Run test_scp_jo
-00008770: 625f 7175 6575 6520 696e 7374 6561 640a  b_queue instead.
-00008780: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00008790: 6f63 6920 2023 204f 4349 2064 6f65 7320  oci  # OCI does 
-000087a0: 6e6f 7420 6861 7665 204b 3830 2067 7075  not have K80 gpu
-000087b0: 730a 6465 6620 7465 7374 5f6a 6f62 5f71  s.def test_job_q
-000087c0: 7565 7565 2867 656e 6572 6963 5f63 6c6f  ueue(generic_clo
-000087d0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-000087e0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000087f0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00008800: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00008810: 2020 276a 6f62 5f71 7565 7565 272c 0a20    'job_queue',. 
-00008820: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00008830: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00008840: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00008850: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00008860: 636c 6f75 647d 2065 7861 6d70 6c65 732f  cloud} examples/
-00008870: 6a6f 625f 7175 6575 652f 636c 7573 7465  job_queue/cluste
-00008880: 722e 7961 6d6c 272c 0a20 2020 2020 2020  r.yaml',.       
-00008890: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-000088a0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-000088b0: 2d31 202d 6420 6578 616d 706c 6573 2f6a  -1 -d examples/j
-000088c0: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
-000088d0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000088e0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-000088f0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d64  } -n {name}-2 -d
-00008900: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-00008910: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
-00008920: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008930: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-00008940: 7b6e 616d 657d 2d33 202d 6420 6578 616d  {name}-3 -d exam
-00008950: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-00008960: 6f62 2e79 616d 6c27 2c0a 2020 2020 2020  ob.yaml',.      
-00008970: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-00008980: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-00008990: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-000089a0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-000089b0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-000089c0: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-000089d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000089e0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-000089f0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-00008a00: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-00008a10: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-00008a20: 616d 657d 2d32 207c 2067 7265 7020 5255  ame}-2 | grep RU
-00008a30: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-00008a40: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-00008a50: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-00008a60: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-00008a70: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-00008a80: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-00008a90: 6772 6570 2050 454e 4449 4e47 272c 0a20  grep PENDING',. 
-00008aa0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008ab0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-00008ac0: 7d20 3227 2c0a 2020 2020 2020 2020 2020  } 2',.          
-00008ad0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
-00008ae0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00008af0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-00008b00: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00008b10: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00008b20: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-00008b30: 2d33 207c 2067 7265 7020 5255 4e4e 494e  -3 | grep RUNNIN
-00008b40: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-00008b50: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-00008b60: 7b6e 616d 657d 2033 272c 0a20 2020 2020  {name} 3',.     
-00008b70: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00008b80: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-00008b90: 4b38 303a 302e 3220 225b 5b20 5c24 534b  K80:0.2 "[[ \$SK
-00008ba0: 5950 494c 4f54 5f4e 554d 5f47 5055 535f  YPILOT_NUM_GPUS_
-00008bb0: 5045 525f 4e4f 4445 202d 6571 2031 205d  PER_NODE -eq 1 ]
-00008bc0: 5d20 7c7c 2065 7869 7420 3122 272c 0a20  ] || exit 1"',. 
-00008bd0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008be0: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
-00008bf0: 7075 7320 4b38 303a 3120 225b 5b20 5c24  pus K80:1 "[[ \$
-00008c00: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
-00008c10: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
-00008c20: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
-00008c30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008c40: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
-00008c50: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00008c60: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00008c70: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
-00008c80: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00008c90: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00008ca0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00008cb0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00008cc0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00008cd0: 4070 7974 6573 742e 6d61 726b 2e6c 616d  @pytest.mark.lam
-00008ce0: 6264 615f 636c 6f75 640a 6465 6620 7465  bda_cloud.def te
-00008cf0: 7374 5f6c 616d 6264 615f 6a6f 625f 7175  st_lambda_job_qu
-00008d00: 6575 6528 293a 0a20 2020 206e 616d 6520  eue():.    name 
-00008d10: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00008d20: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00008d30: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00008d40: 6c61 6d62 6461 5f6a 6f62 5f71 7565 7565  lambda_job_queue
-00008d50: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00008d60: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00008d70: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00008d80: 657d 207b 4c41 4d42 4441 5f54 5950 457d  e} {LAMBDA_TYPE}
-00008d90: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-00008da0: 6575 652f 636c 7573 7465 722e 7961 6d6c  eue/cluster.yaml
-00008db0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008dc0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00008dd0: 202d 6e20 7b6e 616d 657d 2d31 202d 2d67   -n {name}-1 --g
-00008de0: 7075 7320 4131 303a 302e 3520 2d64 2065  pus A10:0.5 -d e
-00008df0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-00008e00: 652f 6a6f 622e 7961 6d6c 272c 0a20 2020  e/job.yaml',.   
-00008e10: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00008e20: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-00008e30: 616d 657d 2d32 202d 2d67 7075 7320 4131  ame}-2 --gpus A1
-00008e40: 303a 302e 3520 2d64 2065 7861 6d70 6c65  0:0.5 -d example
-00008e50: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
-00008e60: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00008e70: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00008e80: 616d 657d 202d 6e20 7b6e 616d 657d 2d33  ame} -n {name}-3
-00008e90: 202d 2d67 7075 7320 4131 303a 302e 3520   --gpus A10:0.5 
-00008ea0: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-00008eb0: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
-00008ec0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008ed0: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-00008ee0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-00008ef0: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-00008f00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008f10: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-00008f20: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-00008f30: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
-00008f40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008f50: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-00008f60: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-00008f70: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
-00008f80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008f90: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
-00008fa0: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
-00008fb0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-00008fc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008fd0: 2071 7565 7565 207b 6e61 6d65 7d20 7c20   queue {name} | 
-00008fe0: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-00008ff0: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
-00009000: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009010: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-00009020: 7d20 3327 2c0a 2020 2020 2020 2020 5d2c  } 3',.        ],
-00009030: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00009040: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00009050: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00009060: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00009070: 7079 7465 7374 2e6d 6172 6b2e 6962 6d0a  pytest.mark.ibm.
-00009080: 6465 6620 7465 7374 5f69 626d 5f6a 6f62  def test_ibm_job
-00009090: 5f71 7565 7565 2829 3a0a 2020 2020 6e61  _queue():.    na
-000090a0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000090b0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000090c0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000090d0: 2020 2769 626d 5f6a 6f62 5f71 7565 7565    'ibm_job_queue
-000090e0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000090f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00009100: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00009110: 657d 202d 2d63 6c6f 7564 2069 626d 202d  e} --cloud ibm -
-00009120: 2d67 7075 7320 7631 3030 272c 0a20 2020  -gpus v100',.   
-00009130: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00009140: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-00009150: 616d 657d 2d31 202d 2d63 6c6f 7564 2069  ame}-1 --cloud i
-00009160: 626d 202d 6420 6578 616d 706c 6573 2f6a  bm -d examples/j
-00009170: 6f62 5f71 7565 7565 2f6a 6f62 5f69 626d  ob_queue/job_ibm
-00009180: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00009190: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-000091a0: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
-000091b0: 3220 2d2d 636c 6f75 6420 6962 6d20 2d64  2 --cloud ibm -d
-000091c0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-000091d0: 6575 652f 6a6f 625f 6962 6d2e 7961 6d6c  eue/job_ibm.yaml
-000091e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000091f0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00009200: 202d 6e20 7b6e 616d 657d 2d33 202d 2d63   -n {name}-3 --c
-00009210: 6c6f 7564 2069 626d 202d 6420 6578 616d  loud ibm -d exam
-00009220: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-00009230: 6f62 5f69 626d 2e79 616d 6c27 2c0a 2020  ob_ibm.yaml',.  
-00009240: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009250: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
-00009260: 7265 7020 7b6e 616d 657d 2d31 207c 2067  rep {name}-1 | g
-00009270: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-00009280: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009290: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
-000092a0: 7265 7020 7b6e 616d 657d 2d32 207c 2067  rep {name}-2 | g
-000092b0: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
-000092c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000092d0: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
-000092e0: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
-000092f0: 7265 7020 5045 4e44 494e 4727 2c0a 2020  rep PENDING',.  
-00009300: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009310: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-00009320: 2032 272c 0a20 2020 2020 2020 2020 2020   2',.           
-00009330: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-00009340: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
-00009350: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
-00009360: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-00009370: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
-00009380: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-00009390: 6e63 656c 202d 7920 7b6e 616d 657d 2033  ncel -y {name} 3
-000093a0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-000093b0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000093c0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-000093d0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-000093e0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000093f0: 6573 742e 6d61 726b 2e73 6370 0a64 6566  est.mark.scp.def
-00009400: 2074 6573 745f 7363 705f 6a6f 625f 7175   test_scp_job_qu
-00009410: 6575 6528 293a 0a20 2020 206e 616d 6520  eue():.    name 
-00009420: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00009430: 616d 6528 290a 2020 2020 6e75 6d5f 6f66  ame().    num_of
-00009440: 5f67 7075 5f6c 6175 6e63 6820 3d20 310a  _gpu_launch = 1.
-00009450: 2020 2020 6e75 6d5f 6f66 5f67 7075 5f65      num_of_gpu_e
-00009460: 7865 6320 3d20 302e 350a 2020 2020 7465  xec = 0.5.    te
-00009470: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00009480: 2020 2027 5343 505f 6a6f 625f 7175 6575     'SCP_job_queu
-00009490: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-000094a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000094b0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-000094c0: 6d65 7d20 7b53 4350 5f54 5950 457d 207b  me} {SCP_TYPE} {
-000094d0: 5343 505f 4750 555f 5631 3030 7d3a 7b6e  SCP_GPU_V100}:{n
-000094e0: 756d 5f6f 665f 6770 755f 6c61 756e 6368  um_of_gpu_launch
-000094f0: 7d20 6578 616d 706c 6573 2f6a 6f62 5f71  } examples/job_q
-00009500: 7565 7565 2f63 6c75 7374 6572 2e79 616d  ueue/cluster.yam
-00009510: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00009520: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00009530: 7d20 2d6e 207b 6e61 6d65 7d2d 3120 7b53  } -n {name}-1 {S
-00009540: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
-00009550: 6d5f 6f66 5f67 7075 5f65 7865 637d 202d  m_of_gpu_exec} -
-00009560: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-00009570: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
-00009580: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009590: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-000095a0: 207b 6e61 6d65 7d2d 3220 7b53 4350 5f47   {name}-2 {SCP_G
-000095b0: 5055 5f56 3130 307d 3a7b 6e75 6d5f 6f66  PU_V100}:{num_of
-000095c0: 5f67 7075 5f65 7865 637d 202d 6420 6578  _gpu_exec} -d ex
-000095d0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-000095e0: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
-000095f0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00009600: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-00009610: 6d65 7d2d 3320 7b53 4350 5f47 5055 5f56  me}-3 {SCP_GPU_V
-00009620: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
-00009630: 5f65 7865 637d 202d 6420 6578 616d 706c  _exec} -d exampl
-00009640: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
-00009650: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00009660: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-00009670: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-00009680: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-00009690: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-000096a0: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-000096b0: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-000096c0: 616d 657d 2d32 207c 2067 7265 7020 5255  ame}-2 | grep RU
-000096d0: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-000096e0: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-000096f0: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-00009700: 616d 657d 2d33 207c 2067 7265 7020 5045  ame}-3 | grep PE
-00009710: 4e44 494e 4727 2c0a 2020 2020 2020 2020  NDING',.        
-00009720: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-00009730: 202d 7920 7b6e 616d 657d 2032 272c 0a20   -y {name} 2',. 
-00009740: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00009750: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00001e30: 2020 2020 2020 2020 2020 2020 2061 6363               acc
+00001e40: 656c 6572 6174 6f72 733d 7b27 4131 3030  elerators={'A100
+00001e50: 2d38 3047 4227 3a20 317d 2c0a 2020 2020  -80GB': 1},.    
+00001e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e70: 2020 2020 2020 2020 2020 7573 655f 7370            use_sp
+00001e80: 6f74 3d54 7275 6529 293a 0a20 2020 2020  ot=True)):.     
+00001e90: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00001ea0: 6769 6f6e 2e6e 616d 650a 0a20 2020 2072  gion.name..    r
+00001eb0: 6574 7572 6e20 4e6f 6e65 0a0a 0a23 202d  eturn None...# -
+00001ec0: 2d2d 2d2d 2d2d 2d2d 2d20 4472 7920 7275  --------- Dry ru
+00001ed0: 6e3a 2032 2054 6173 6b73 2069 6e20 6120  n: 2 Tasks in a 
+00001ee0: 6368 6169 6e2e 202d 2d2d 2d2d 2d2d 2d2d  chain. ---------
+00001ef0: 2d0a 6465 6620 7465 7374 5f65 7861 6d70  -.def test_examp
+00001f00: 6c65 5f61 7070 2829 3a0a 2020 2020 7465  le_app():.    te
+00001f10: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00001f20: 2020 2027 6578 616d 706c 655f 6170 7027     'example_app'
+00001f30: 2c0a 2020 2020 2020 2020 5b27 7079 7468  ,.        ['pyth
+00001f40: 6f6e 2065 7861 6d70 6c65 732f 6578 616d  on examples/exam
+00001f50: 706c 655f 6170 702e 7079 275d 2c0a 2020  ple_app.py'],.  
+00001f60: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00001f70: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+00001f80: 2d2d 2d2d 2d2d 2d2d 2d20 4120 6d69 6e69  --------- A mini
+00001f90: 6d61 6c20 7461 736b 202d 2d2d 2d2d 2d2d  mal task -------
+00001fa0: 2d2d 2d0a 6465 6620 7465 7374 5f6d 696e  ---.def test_min
+00001fb0: 696d 616c 2867 656e 6572 6963 5f63 6c6f  imal(generic_clo
+00001fc0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00001fd0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00001fe0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00001ff0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00002000: 2020 276d 696e 696d 616c 272c 0a20 2020    'minimal',.   
+00002010: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00002020: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00002030: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00002040: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00002050: 6f75 647d 2074 6573 7473 2f74 6573 745f  oud} tests/test_
+00002060: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00002070: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00002080: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00002090: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+000020a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000020b0: 7920 6c6f 6773 207b 6e61 6d65 7d20 2d2d  y logs {name} --
+000020c0: 7374 6174 7573 207c 2067 7265 7020 224a  status | grep "J
+000020d0: 6f62 2031 3a20 5355 4343 4545 4445 4422  ob 1: SUCCEEDED"
+000020e0: 272c 2020 2320 4571 7569 7661 6c65 6e74  ',  # Equivalent
+000020f0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00002100: 4368 6563 6b20 7468 6520 6c6f 6773 2064  Check the logs d
+00002110: 6f77 6e6c 6f61 6469 6e67 0a20 2020 2020  ownloading.     
+00002120: 2020 2020 2020 2066 276c 6f67 5f70 6174         f'log_pat
+00002130: 683d 2428 736b 7920 6c6f 6773 207b 6e61  h=$(sky logs {na
+00002140: 6d65 7d20 3120 2d2d 7379 6e63 2d64 6f77  me} 1 --sync-dow
+00002150: 6e20 7c20 6772 6570 2022 4a6f 6220 3120  n | grep "Job 1 
+00002160: 6c6f 6773 3a22 207c 2073 6564 202d 4520  logs:" | sed -E 
+00002170: 2273 2f5e 2e2a 4a6f 6220 3120 6c6f 6773  "s/^.*Job 1 logs
+00002180: 3a20 282e 2a29 5c5c 7831 625c 5c5b 306d  : (.*)\\x1b\\[0m
+00002190: 2f5c 5c31 2f67 2229 2026 2620 6563 686f  /\\1/g") && echo
+000021a0: 2024 6c6f 675f 7061 7468 2026 2620 7465   $log_path && te
+000021b0: 7374 202d 6620 246c 6f67 5f70 6174 682f  st -f $log_path/
+000021c0: 7275 6e2e 6c6f 6727 2c0a 2020 2020 2020  run.log',.      
+000021d0: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+000021e0: 6865 2072 6179 6c65 7420 7072 6f63 6573  he raylet proces
+000021f0: 7320 6861 7320 7468 6520 636f 7272 6563  s has the correc
+00002200: 7420 6669 6c65 2064 6573 6372 6970 746f  t file descripto
+00002210: 7220 6c69 6d69 742e 0a20 2020 2020 2020  r limit..       
+00002220: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00002230: 7b6e 616d 657d 2022 7072 6c69 6d69 7420  {name} "prlimit 
+00002240: 2d6e 202d 2d70 6964 3d5c 2428 7067 7265  -n --pid=\$(pgre
+00002250: 7020 2d66 205c 2772 6179 6c65 742f 7261  p -f \'raylet/ra
+00002260: 796c 6574 202d 2d72 6179 6c65 745f 736f  ylet --raylet_so
+00002270: 636b 6574 5f6e 616d 655c 2729 207c 2067  cket_name\') | g
+00002280: 7265 7020 5c27 225c 2731 3034 3835 3736  rep \'"\'1048576
+00002290: 2031 3034 3835 3736 5c27 225c 2722 272c   1048576\'"\'"',
+000022a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000022b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+000022c0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000022d0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000022e0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+000022f0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00002300: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00002310: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00002320: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00002330: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+00002340: 6573 7420 7265 6769 6f6e 202d 2d2d 2d2d  est region -----
+00002350: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00002360: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+00002370: 6177 735f 7265 6769 6f6e 2829 3a0a 2020  aws_region():.  
+00002380: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00002390: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000023a0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000023b0: 2020 2020 2020 2761 7773 5f72 6567 696f        'aws_regio
+000023c0: 6e27 2c0a 2020 2020 2020 2020 5b0a 2020  n',.        [.  
+000023d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000023e0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000023f0: 6d65 7d20 2d2d 7265 6769 6f6e 2075 732d  me} --region us-
+00002400: 7765 7374 2d32 2065 7861 6d70 6c65 732f  west-2 examples/
+00002410: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00002420: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00002430: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+00002440: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+00002450: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00002460: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00002470: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00002480: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00002490: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+000024a0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000024b0: 7461 7475 7320 2d2d 616c 6c20 7c20 6772  tatus --all | gr
+000024c0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+000024d0: 2075 732d 7765 7374 2d32 272c 2020 2320   us-west-2',  # 
+000024e0: 456e 7375 7265 2074 6865 2072 6567 696f  Ensure the regio
+000024f0: 6e20 6973 2063 6f72 7265 6374 2e0a 2020  n is correct..  
+00002500: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00002510: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00002520: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00002530: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00002540: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00002550: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00002560: 5f67 6370 5f72 6567 696f 6e28 293a 0a20  _gcp_region():. 
+00002570: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00002580: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00002590: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000025a0: 2020 2020 2020 2027 6763 705f 7265 6769         'gcp_regi
+000025b0: 6f6e 272c 0a20 2020 2020 2020 205b 0a20  on',.        [. 
+000025c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000025d0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000025e0: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
+000025f0: 2d63 656e 7472 616c 3120 2d2d 636c 6f75  -central1 --clou
+00002600: 6420 6763 7020 7465 7374 732f 7465 7374  d gcp tests/test
+00002610: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00002620: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00002630: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00002640: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+00002650: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00002660: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00002670: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00002680: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00002690: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+000026a0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+000026b0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+000026c0: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
+000026d0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+000026e0: 7573 2d63 656e 7472 616c 3127 2c20 2023  us-central1',  #
+000026f0: 2045 6e73 7572 6520 7468 6520 7265 6769   Ensure the regi
+00002700: 6f6e 2069 7320 636f 7272 6563 742e 0a20  on is correct.. 
+00002710: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00002720: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00002730: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00002740: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00002750: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00002760: 6d61 726b 2e69 626d 0a64 6566 2074 6573  mark.ibm.def tes
+00002770: 745f 6962 6d5f 7265 6769 6f6e 2829 3a0a  t_ibm_region():.
+00002780: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00002790: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000027a0: 2020 2072 6567 696f 6e20 3d20 2765 752d     region = 'eu-
+000027b0: 6465 270a 2020 2020 7465 7374 203d 2054  de'.    test = T
+000027c0: 6573 7428 0a20 2020 2020 2020 2027 7265  est(.        're
+000027d0: 6769 6f6e 272c 0a20 2020 2020 2020 205b  gion',.        [
+000027e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000027f0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00002800: 7b6e 616d 657d 202d 2d63 6c6f 7564 2069  {name} --cloud i
+00002810: 626d 202d 2d72 6567 696f 6e20 7b72 6567  bm --region {reg
+00002820: 696f 6e7d 2065 7861 6d70 6c65 732f 6d69  ion} examples/mi
+00002830: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00002840: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00002850: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
+00002860: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
+00002870: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00002880: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00002890: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000028a0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000028b0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000028c0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+000028d0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+000028e0: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
+000028f0: 6d65 7d20 7c20 6772 6570 207b 7265 6769  me} | grep {regi
+00002900: 6f6e 7d27 2c20 2023 2045 6e73 7572 6520  on}',  # Ensure 
+00002910: 7468 6520 7265 6769 6f6e 2069 7320 636f  the region is co
+00002920: 7272 6563 742e 0a20 2020 2020 2020 205d  rrect..        ]
+00002930: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00002940: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00002950: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00002960: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00002970: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
+00002980: 7265 0a64 6566 2074 6573 745f 617a 7572  re.def test_azur
+00002990: 655f 7265 6769 6f6e 2829 3a0a 2020 2020  e_region():.    
+000029a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000029b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000029c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000029d0: 2020 2020 2761 7a75 7265 5f72 6567 696f      'azure_regio
+000029e0: 6e27 2c0a 2020 2020 2020 2020 5b0a 2020  n',.        [.  
+000029f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00002a00: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00002a10: 6d65 7d20 2d2d 7265 6769 6f6e 2065 6173  me} --region eas
+00002a20: 7475 7332 202d 2d63 6c6f 7564 2061 7a75  tus2 --cloud azu
+00002a30: 7265 2074 6573 7473 2f74 6573 745f 7961  re tests/test_ya
+00002a40: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00002a50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00002a60: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00002a70: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00002a80: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00002a90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00002aa0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00002ab0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00002ac0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00002ad0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00002ae0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00002af0: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
+00002b00: 6e61 6d65 7d20 7c20 6772 6570 2065 6173  name} | grep eas
+00002b10: 7475 7332 272c 2020 2320 456e 7375 7265  tus2',  # Ensure
+00002b20: 2074 6865 2072 6567 696f 6e20 6973 2063   the region is c
+00002b30: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
+00002b40: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00002b50: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00002b60: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00002b70: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00002b80: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00002b90: 7374 207a 6f6e 6520 2d2d 2d2d 2d2d 2d2d  st zone --------
+00002ba0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00002bb0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00002bc0: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
+00002bd0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00002be0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00002bf0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00002c00: 2027 6177 735f 7a6f 6e65 272c 0a20 2020   'aws_zone',.   
+00002c10: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00002c20: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00002c30: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
+00002c40: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+00002c50: 6d6c 202d 2d7a 6f6e 6520 7573 2d77 6573  ml --zone us-wes
+00002c60: 742d 3262 272c 0a20 2020 2020 2020 2020  t-2b',.         
+00002c70: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00002c80: 616d 657d 2065 7861 6d70 6c65 732f 6d69  ame} examples/mi
+00002c90: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
+00002ca0: 6520 7573 2d77 6573 742d 3262 272c 0a20  e us-west-2b',. 
+00002cb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00002cc0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00002cd0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00002ce0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00002cf0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+00002d00: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00002d10: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
+00002d20: 6d65 7d20 7c20 6772 6570 2075 732d 7765  me} | grep us-we
+00002d30: 7374 2d32 6227 2c20 2023 2045 6e73 7572  st-2b',  # Ensur
+00002d40: 6520 7468 6520 7a6f 6e65 2069 7320 636f  e the zone is co
+00002d50: 7272 6563 742e 0a20 2020 2020 2020 205d  rrect..        ]
+00002d60: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00002d70: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00002d80: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00002d90: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00002da0: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
+00002db0: 0a64 6566 2074 6573 745f 6962 6d5f 7a6f  .def test_ibm_zo
+00002dc0: 6e65 2829 3a0a 2020 2020 6e61 6d65 203d  ne():.    name =
+00002dd0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00002de0: 6d65 2829 0a20 2020 207a 6f6e 6520 3d20  me().    zone = 
+00002df0: 2765 752d 6465 2d32 270a 2020 2020 7465  'eu-de-2'.    te
+00002e00: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00002e10: 2020 2027 7a6f 6e65 272c 0a20 2020 2020     'zone',.     
+00002e20: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00002e30: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00002e40: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+00002e50: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
+00002e60: 6d69 6e69 6d61 6c2e 7961 6d6c 202d 2d7a  minimal.yaml --z
+00002e70: 6f6e 6520 7b7a 6f6e 657d 272c 0a20 2020  one {zone}',.   
+00002e80: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00002e90: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
+00002ea0: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
+00002eb0: 6d69 6e69 6d61 6c2e 7961 6d6c 202d 2d7a  minimal.yaml --z
+00002ec0: 6f6e 6520 7b7a 6f6e 657d 272c 0a20 2020  one {zone}',.   
+00002ed0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00002ee0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00002ef0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00002f00: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00002f10: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00002f20: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
+00002f30: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
+00002f40: 7d20 7c20 6772 6570 207b 7a6f 6e65 7d27  } | grep {zone}'
+00002f50: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00002f60: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
+00002f70: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00002f80: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00002f90: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
+00002fa0: 3220 7b6e 616d 657d 2d33 272c 0a20 2020  2 {name}-3',.   
+00002fb0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00002fc0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00002fd0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00002fe0: 2074 6573 745f 6763 705f 7a6f 6e65 2829   test_gcp_zone()
+00002ff0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00003000: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00003010: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00003020: 280a 2020 2020 2020 2020 2767 6370 5f7a  (.        'gcp_z
+00003030: 6f6e 6527 2c0a 2020 2020 2020 2020 5b0a  one',.        [.
+00003040: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003050: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00003060: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
+00003070: 6365 6e74 7261 6c31 2d61 202d 2d63 6c6f  central1-a --clo
+00003080: 7564 2067 6370 2074 6573 7473 2f74 6573  ud gcp tests/tes
+00003090: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+000030a0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000030b0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000030c0: 616d 657d 202d 2d7a 6f6e 6520 7573 2d63  ame} --zone us-c
+000030d0: 656e 7472 616c 312d 6120 2d2d 636c 6f75  entral1-a --clou
+000030e0: 6420 6763 7020 7465 7374 732f 7465 7374  d gcp tests/test
+000030f0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00003100: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00003110: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00003120: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00003130: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00003140: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00003150: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003160: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
+00003170: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00003180: 7020 7573 2d63 656e 7472 616c 312d 6127  p us-central1-a'
+00003190: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000031a0: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
+000031b0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000031c0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+000031d0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+000031e0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+000031f0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00003200: 2d2d 2d2d 2d2d 2054 6573 7420 7468 6520  ------ Test the 
+00003210: 696d 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d  image ----------
+00003220: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00003230: 730a 6465 6620 7465 7374 5f61 7773 5f69  s.def test_aws_i
+00003240: 6d61 6765 7328 293a 0a20 2020 206e 616d  mages():.    nam
+00003250: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00003260: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00003270: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00003280: 2027 6177 735f 696d 6167 6573 272c 0a20   'aws_images',. 
+00003290: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000032a0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000032b0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+000032c0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+000032d0: 6f74 3a67 7075 2d75 6275 6e74 752d 3138  ot:gpu-ubuntu-18
+000032e0: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
+000032f0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00003300: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00003310: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00003320: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00003330: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00003340: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00003350: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+00003360: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
+00003370: 2073 6b79 7069 6c6f 743a 6770 752d 7562   skypilot:gpu-ub
+00003380: 756e 7475 2d32 3030 3420 6578 616d 706c  untu-2004 exampl
+00003390: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
+000033a0: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+000033b0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+000033c0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000033d0: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
+000033e0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+000033f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00003400: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00003410: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00003420: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003430: 6f67 7320 7b6e 616d 657d 202d 2d73 7461  ogs {name} --sta
+00003440: 7475 7320 7c20 6772 6570 2022 4a6f 6220  tus | grep "Job 
+00003450: 323a 2053 5543 4345 4544 4544 2227 2c20  2: SUCCEEDED"', 
+00003460: 2023 2045 7175 6976 616c 656e 742e 0a20   # Equivalent.. 
+00003470: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00003480: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00003490: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+000034a0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000034b0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+000034c0: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+000034d0: 745f 6763 705f 696d 6167 6573 2829 3a0a  t_gcp_images():.
+000034e0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000034f0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00003500: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00003510: 2020 2020 2020 2020 2767 6370 5f69 6d61          'gcp_ima
+00003520: 6765 7327 2c0a 2020 2020 2020 2020 5b0a  ges',.        [.
+00003530: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003540: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00003550: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
+00003560: 2073 6b79 7069 6c6f 743a 6770 752d 6465   skypilot:gpu-de
+00003570: 6269 616e 2d31 3020 2d2d 636c 6f75 6420  bian-10 --cloud 
+00003580: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
+00003590: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+000035a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000035b0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000035c0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+000035d0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+000035e0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+000035f0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00003600: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
+00003610: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+00003620: 6f74 3a63 7075 2d64 6562 6961 6e2d 3130  ot:cpu-debian-10
+00003630: 202d 2d63 6c6f 7564 2067 6370 2074 6573   --cloud gcp tes
+00003640: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00003650: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
+00003660: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00003670: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003680: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00003690: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+000036a0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+000036b0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000036c0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000036d0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+000036e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000036f0: 7920 6c6f 6773 207b 6e61 6d65 7d20 2d2d  y logs {name} --
+00003700: 7374 6174 7573 207c 2067 7265 7020 224a  status | grep "J
+00003710: 6f62 2032 3a20 5355 4343 4545 4445 4422  ob 2: SUCCEEDED"
+00003720: 272c 2020 2320 4571 7569 7661 6c65 6e74  ',  # Equivalent
+00003730: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
+00003740: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00003750: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00003760: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00003770: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00003780: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00003790: 7465 7374 5f61 7773 5f69 6d61 6765 5f69  test_aws_image_i
+000037a0: 645f 6469 6374 2829 3a0a 2020 2020 6e61  d_dict():.    na
+000037b0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000037c0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000037d0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000037e0: 2020 2761 7773 5f69 6d61 6765 5f69 645f    'aws_image_id_
+000037f0: 6469 6374 272c 0a20 2020 2020 2020 205b  dict',.        [
+00003800: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00003810: 7365 2069 6d61 6765 2069 6420 6469 6374  se image id dict
+00003820: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00003830: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00003840: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00003850: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+00003860: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00003870: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00003880: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00003890: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+000038a0: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+000038b0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+000038c0: 207b 6e61 6d65 7d20 226c 7320 7e22 272c   {name} "ls ~"',
+000038d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000038e0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000038f0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00003900: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00003910: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00003920: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00003930: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00003940: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+00003950: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00003960: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00003970: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00003980: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00003990: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+000039a0: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+000039b0: 7465 7374 5f67 6370 5f69 6d61 6765 5f69  test_gcp_image_i
+000039c0: 645f 6469 6374 2829 3a0a 2020 2020 6e61  d_dict():.    na
+000039d0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000039e0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000039f0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00003a00: 2020 2767 6370 5f69 6d61 6765 5f69 645f    'gcp_image_id_
+00003a10: 6469 6374 272c 0a20 2020 2020 2020 205b  dict',.        [
+00003a20: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00003a30: 7365 2069 6d61 6765 2069 6420 6469 6374  se image id dict
+00003a40: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00003a50: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00003a60: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00003a70: 7374 5f79 616d 6c73 2f67 6370 5f70 6572  st_yamls/gcp_per
+00003a80: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00003a90: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00003aa0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00003ab0: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+00003ac0: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
+00003ad0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00003ae0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00003af0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00003b00: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+00003b10: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00003b20: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00003b30: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00003b40: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00003b50: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00003b60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003b70: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+00003b80: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00003b90: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00003ba0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00003bb0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00003bc0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00003bd0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00003be0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00003bf0: 5f69 6d61 6765 5f69 645f 6469 6374 5f72  _image_id_dict_r
+00003c00: 6567 696f 6e28 293a 0a20 2020 206e 616d  egion():.    nam
+00003c10: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00003c20: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00003c30: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00003c40: 2027 6177 735f 696d 6167 655f 6964 5f64   'aws_image_id_d
+00003c50: 6963 745f 7265 6769 6f6e 272c 0a20 2020  ict_region',.   
+00003c60: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00003c70: 2020 2023 2055 7365 2072 6567 696f 6e20     # Use region 
+00003c80: 746f 2066 696c 7465 7220 696d 6167 655f  to filter image_
+00003c90: 6964 2064 6963 742e 0a20 2020 2020 2020  id dict..       
+00003ca0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00003cb0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00003cc0: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
+00003cd0: 3120 6578 616d 706c 6573 2f70 6572 5f72  1 examples/per_r
+00003ce0: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+00003cf0: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
+00003d00: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
+00003d10: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+00003d20: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
+00003d30: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00003d40: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+00003d50: 6c75 7374 6572 2069 7320 6e6f 7420 6372  luster is not cr
+00003d60: 6561 7465 642e 0a20 2020 2020 2020 2020  eated..         
+00003d70: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00003d80: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
+00003d90: 6567 696f 6e20 7573 2d77 6573 742d 3220  egion us-west-2 
+00003da0: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+00003db0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00003dc0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00003dd0: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
+00003de0: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
+00003df0: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
+00003e00: 6520 7265 6769 6f6e 2e0a 2020 2020 2020  e region..      
+00003e10: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00003e20: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
+00003e30: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00003e40: 3a67 7075 2d75 6275 6e74 752d 3138 3034  :gpu-ubuntu-1804
+00003e50: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
+00003e60: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00003e70: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00003e80: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
+00003e90: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
+00003ea0: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
+00003eb0: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+00003ec0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00003ed0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00003ee0: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
+00003ef0: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00003f00: 3230 3034 2065 7861 6d70 6c65 732f 6d69  2004 examples/mi
+00003f10: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
+00003f20: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00003f30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003f40: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00003f50: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00003f60: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00003f70: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00003f80: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00003f90: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00003fa0: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+00003fb0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003fc0: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
+00003fd0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00003fe0: 7265 7020 7573 2d77 6573 742d 3227 2c20  rep us-west-2', 
+00003ff0: 2023 2045 6e73 7572 6520 7468 6520 7265   # Ensure the re
+00004000: 6769 6f6e 2069 7320 636f 7272 6563 742e  gion is correct.
+00004010: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00004020: 6e73 7572 6520 6578 6563 2077 6f72 6b73  nsure exec works
+00004030: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00004040: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00004050: 2d2d 7265 6769 6f6e 2075 732d 7765 7374  --region us-west
+00004060: 2d32 2065 7861 6d70 6c65 732f 7065 725f  -2 examples/per_
+00004070: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
+00004080: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00004090: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000040a0: 657d 2065 7861 6d70 6c65 732f 7065 725f  e} examples/per_
+000040b0: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
+000040c0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000040d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000040e0: 657d 202d 2d63 6c6f 7564 2061 7773 202d  e} --cloud aws -
+000040f0: 2d72 6567 696f 6e20 7573 2d77 6573 742d  -region us-west-
+00004100: 3220 226c 7320 7e22 272c 0a20 2020 2020  2 "ls ~"',.     
+00004110: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00004120: 6320 7b6e 616d 657d 2022 6c73 207e 2227  c {name} "ls ~"'
+00004130: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004140: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00004150: 3420 2d2d 7374 6174 7573 272c 0a20 2020  4 --status',.   
+00004160: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004170: 6f67 7320 7b6e 616d 657d 2035 202d 2d73  ogs {name} 5 --s
+00004180: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00004190: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+000041a0: 6e61 6d65 7d20 3620 2d2d 7374 6174 7573  name} 6 --status
+000041b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000041c0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000041d0: 2037 202d 2d73 7461 7475 7327 2c0a 2020   7 --status',.  
+000041e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000041f0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00004200: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00004210: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00004220: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00004230: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00004240: 5f67 6370 5f69 6d61 6765 5f69 645f 6469  _gcp_image_id_di
+00004250: 6374 5f72 6567 696f 6e28 293a 0a20 2020  ct_region():.   
+00004260: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00004270: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00004280: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00004290: 2020 2020 2027 6763 705f 696d 6167 655f       'gcp_image_
+000042a0: 6964 5f64 6963 745f 7265 6769 6f6e 272c  id_dict_region',
+000042b0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000042c0: 2020 2020 2020 2023 2055 7365 2072 6567         # Use reg
+000042d0: 696f 6e20 746f 2066 696c 7465 7220 696d  ion to filter im
+000042e0: 6167 655f 6964 2064 6963 742e 0a20 2020  age_id dict..   
+000042f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004300: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00004310: 657d 202d 2d72 6567 696f 6e20 7573 2d65  e} --region us-e
+00004320: 6173 7431 2074 6573 7473 2f74 6573 745f  ast1 tests/test_
+00004330: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
+00004340: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00004350: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
+00004360: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
+00004370: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
+00004380: 6772 6570 207b 6e61 6d65 7d20 2626 2065  grep {name} && e
+00004390: 7869 7420 3120 7c7c 2074 7275 6527 2c20  xit 1 || true', 
+000043a0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+000043b0: 7573 7465 7220 6973 206e 6f74 2063 7265  uster is not cre
+000043c0: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
+000043d0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000043e0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7265  y -c {name} --re
+000043f0: 6769 6f6e 2075 732d 7765 7374 3320 7465  gion us-west3 te
+00004400: 7374 732f 7465 7374 5f79 616d 6c73 2f67  sts/test_yamls/g
+00004410: 6370 5f70 6572 5f72 6567 696f 6e5f 696d  cp_per_region_im
+00004420: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
+00004430: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
+00004440: 2073 7563 6365 7373 2062 6563 6175 7365   success because
+00004450: 2074 6865 2069 6d61 6765 2069 6420 6d61   the image id ma
+00004460: 7463 6820 666f 7220 7468 6520 7265 6769  tch for the regi
+00004470: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
+00004480: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+00004490: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+000044a0: 6370 202d 2d69 6d61 6765 2d69 6420 7072  cp --image-id pr
+000044b0: 6f6a 6563 7473 2f75 6275 6e74 752d 6f73  ojects/ubuntu-os
+000044c0: 2d63 6c6f 7564 2f67 6c6f 6261 6c2f 696d  -cloud/global/im
+000044d0: 6167 6573 2f75 6275 6e74 752d 3138 3034  ages/ubuntu-1804
+000044e0: 2d62 696f 6e69 632d 7632 3032 3330 3131  -bionic-v2023011
+000044f0: 3220 7465 7374 732f 7465 7374 5f79 616d  2 tests/test_yam
+00004500: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00004510: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004520: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00004530: 2d2d 636c 6f75 6420 6763 7020 2d2d 696d  --cloud gcp --im
+00004540: 6167 652d 6964 2070 726f 6a65 6374 732f  age-id projects/
+00004550: 7562 756e 7475 2d6f 732d 636c 6f75 642f  ubuntu-os-cloud/
+00004560: 676c 6f62 616c 2f69 6d61 6765 732f 7562  global/images/ub
+00004570: 756e 7475 2d31 3830 342d 6269 6f6e 6963  untu-1804-bionic
+00004580: 2d76 3230 3233 3031 3132 2074 6573 7473  -v20230112 tests
+00004590: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+000045a0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+000045b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000045c0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000045d0: 2067 6370 202d 2d69 6d61 6765 2d69 6420   gcp --image-id 
+000045e0: 736b 7970 696c 6f74 3a63 7075 2d64 6562  skypilot:cpu-deb
+000045f0: 6961 6e2d 3130 2074 6573 7473 2f74 6573  ian-10 tests/tes
+00004600: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+00004610: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
+00004620: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
+00004630: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004640: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00004650: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00004660: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00004670: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00004680: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004690: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+000046a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000046b0: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+000046c0: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
+000046d0: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
+000046e0: 2d77 6573 7433 272c 2020 2320 456e 7375  -west3',  # Ensu
+000046f0: 7265 2074 6865 2072 6567 696f 6e20 6973  re the region is
+00004700: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
+00004710: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
+00004720: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
+00004730: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00004740: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
+00004750: 6e20 7573 2d77 6573 7433 2074 6573 7473  n us-west3 tests
+00004760: 2f74 6573 745f 7961 6d6c 732f 6763 705f  /test_yamls/gcp_
+00004770: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
+00004780: 732e 7961 6d6c 272c 0a20 2020 2020 2020  s.yaml',.       
+00004790: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+000047a0: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+000047b0: 745f 7961 6d6c 732f 6763 705f 7065 725f  t_yamls/gcp_per_
+000047c0: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
+000047d0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000047e0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000047f0: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
+00004800: 2d72 6567 696f 6e20 7573 2d77 6573 7433  -region us-west3
+00004810: 2022 6c73 207e 2227 2c0a 2020 2020 2020   "ls ~"',.      
+00004820: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004830: 207b 6e61 6d65 7d20 226c 7320 7e22 272c   {name} "ls ~"',
+00004840: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004850: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
+00004860: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00004870: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00004880: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
+00004890: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+000048a0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000048b0: 616d 657d 2036 202d 2d73 7461 7475 7327  ame} 6 --status'
+000048c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000048d0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000048e0: 3720 2d2d 7374 6174 7573 272c 0a20 2020  7 --status',.   
+000048f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00004900: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00004910: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00004920: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00004930: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00004940: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+00004950: 6177 735f 696d 6167 655f 6964 5f64 6963  aws_image_id_dic
+00004960: 745f 7a6f 6e65 2829 3a0a 2020 2020 6e61  t_zone():.    na
+00004970: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00004980: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00004990: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000049a0: 2020 2761 7773 5f69 6d61 6765 5f69 645f    'aws_image_id_
+000049b0: 6469 6374 5f7a 6f6e 6527 2c0a 2020 2020  dict_zone',.    
+000049c0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+000049d0: 2020 2320 5573 6520 7a6f 6e65 2074 6f20    # Use zone to 
+000049e0: 6669 6c74 6572 2069 6d61 6765 5f69 6420  filter image_id 
+000049f0: 6469 6374 2e0a 2020 2020 2020 2020 2020  dict..          
+00004a00: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00004a10: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7a6f  y -c {name} --zo
+00004a20: 6e65 2075 732d 6561 7374 2d31 6220 6578  ne us-east-1b ex
+00004a30: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
+00004a40: 6e5f 696d 6167 6573 2e79 616d 6c20 2626  n_images.yaml &&
+00004a50: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
+00004a60: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004a70: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00004a80: 7020 7b6e 616d 657d 2026 2620 6578 6974  p {name} && exit
+00004a90: 2031 207c 7c20 7472 7565 272c 2020 2320   1 || true',  # 
+00004aa0: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
+00004ab0: 6572 2069 7320 6e6f 7420 6372 6561 7465  er is not create
+00004ac0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00004ad0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00004ae0: 6320 7b6e 616d 657d 202d 2d7a 6f6e 6520  c {name} --zone 
+00004af0: 7573 2d77 6573 742d 3261 2065 7861 6d70  us-west-2a examp
+00004b00: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
+00004b10: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
+00004b20: 2020 2020 2020 2020 2023 2053 686f 756c           # Shoul
+00004b30: 6420 7375 6363 6573 7320 6265 6361 7573  d success becaus
+00004b40: 6520 7468 6520 696d 6167 6520 6964 206d  e the image id m
+00004b50: 6174 6368 2066 6f72 2074 6865 207a 6f6e  atch for the zon
+00004b60: 652e 0a20 2020 2020 2020 2020 2020 2066  e..            f
+00004b70: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00004b80: 6320 7b6e 616d 657d 202d 2d69 6d61 6765  c {name} --image
+00004b90: 2d69 6420 736b 7970 696c 6f74 3a67 7075  -id skypilot:gpu
+00004ba0: 2d75 6275 6e74 752d 3138 3034 2065 7861  -ubuntu-1804 exa
+00004bb0: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+00004bc0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00004bd0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00004be0: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
+00004bf0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
+00004c00: 752d 3138 3034 2065 7861 6d70 6c65 732f  u-1804 examples/
+00004c10: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00004c20: 2020 2020 2020 2020 2020 2023 2046 6169             # Fai
+00004c30: 6c20 6475 6520 746f 2069 6d61 6765 2069  l due to image i
+00004c40: 6420 6d69 736d 6174 6368 2e0a 2020 2020  d mismatch..    
+00004c50: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00004c60: 6563 207b 6e61 6d65 7d20 2d2d 696d 6167  ec {name} --imag
+00004c70: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
+00004c80: 752d 7562 756e 7475 2d32 3030 3420 6578  u-ubuntu-2004 ex
+00004c90: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
+00004ca0: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
+00004cb0: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
+00004cc0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00004cd0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00004ce0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00004cf0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00004d00: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
+00004d10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004d20: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
+00004d30: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00004d40: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00004d50: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
+00004d60: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
+00004d70: 7765 7374 2d32 6127 2c20 2023 2045 6e73  west-2a',  # Ens
+00004d80: 7572 6520 7468 6520 7a6f 6e65 2069 7320  ure the zone is 
+00004d90: 636f 7272 6563 742e 0a20 2020 2020 2020  correct..       
+00004da0: 2020 2020 2023 2045 6e73 7572 6520 6578       # Ensure ex
+00004db0: 6563 2077 6f72 6b73 2e0a 2020 2020 2020  ec works..      
+00004dc0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004dd0: 207b 6e61 6d65 7d20 2d2d 7a6f 6e65 2075   {name} --zone u
+00004de0: 732d 7765 7374 2d32 6120 6578 616d 706c  s-west-2a exampl
+00004df0: 6573 2f70 6572 5f72 6567 696f 6e5f 696d  es/per_region_im
+00004e00: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
+00004e10: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00004e20: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+00004e30: 6573 2f70 6572 5f72 6567 696f 6e5f 696d  es/per_region_im
+00004e40: 6167 6573 2e79 616d 6c27 2c0a 2020 2020  ages.yaml',.    
+00004e50: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00004e60: 6563 207b 6e61 6d65 7d20 2d2d 636c 6f75  ec {name} --clou
+00004e70: 6420 6177 7320 2d2d 7265 6769 6f6e 2075  d aws --region u
+00004e80: 732d 7765 7374 2d32 2022 6c73 207e 2227  s-west-2 "ls ~"'
+00004e90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004ea0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00004eb0: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+00004ec0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004ed0: 7b6e 616d 657d 2034 202d 2d73 7461 7475  {name} 4 --statu
+00004ee0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00004ef0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00004f00: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
+00004f10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004f20: 206c 6f67 7320 7b6e 616d 657d 2036 202d   logs {name} 6 -
+00004f30: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00004f40: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00004f50: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
+00004f60: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+00004f70: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00004f80: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00004f90: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00004fa0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00004fb0: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+00004fc0: 6566 2074 6573 745f 6763 705f 696d 6167  ef test_gcp_imag
+00004fd0: 655f 6964 5f64 6963 745f 7a6f 6e65 2829  e_id_dict_zone()
+00004fe0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00004ff0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00005000: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00005010: 280a 2020 2020 2020 2020 2767 6370 5f69  (.        'gcp_i
+00005020: 6d61 6765 5f69 645f 6469 6374 5f7a 6f6e  mage_id_dict_zon
+00005030: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+00005040: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+00005050: 7a6f 6e65 2074 6f20 6669 6c74 6572 2069  zone to filter i
+00005060: 6d61 6765 5f69 6420 6469 6374 2e0a 2020  mage_id dict..  
+00005070: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005080: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00005090: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 6561  me} --zone us-ea
+000050a0: 7374 312d 6120 7465 7374 732f 7465 7374  st1-a tests/test
+000050b0: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
+000050c0: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+000050d0: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
+000050e0: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
+000050f0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+00005100: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
+00005110: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00005120: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+00005130: 6c75 7374 6572 2069 7320 6e6f 7420 6372  luster is not cr
+00005140: 6561 7465 642e 0a20 2020 2020 2020 2020  eated..         
+00005150: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00005160: 2d79 202d 6320 7b6e 616d 657d 202d 2d7a  -y -c {name} --z
+00005170: 6f6e 6520 7573 2d63 656e 7472 616c 312d  one us-central1-
+00005180: 6120 7465 7374 732f 7465 7374 5f79 616d  a tests/test_yam
+00005190: 6c73 2f67 6370 5f70 6572 5f72 6567 696f  ls/gcp_per_regio
+000051a0: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
+000051b0: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
+000051c0: 6f75 6c64 2073 7563 6365 7373 2062 6563  ould success bec
+000051d0: 6175 7365 2074 6865 2069 6d61 6765 2069  ause the image i
+000051e0: 6420 6d61 7463 6820 666f 7220 7468 6520  d match for the 
+000051f0: 7a6f 6e65 2e0a 2020 2020 2020 2020 2020  zone..          
+00005200: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00005210: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00005220: 6f75 6420 6763 7020 2d2d 696d 6167 652d  oud gcp --image-
+00005230: 6964 2073 6b79 7069 6c6f 743a 6370 752d  id skypilot:cpu-
+00005240: 6465 6269 616e 2d31 3020 7465 7374 732f  debian-10 tests/
+00005250: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
+00005260: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+00005270: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00005280: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00005290: 6763 7020 2d2d 696d 6167 652d 6964 2073  gcp --image-id s
+000052a0: 6b79 7069 6c6f 743a 6370 752d 6465 6269  kypilot:cpu-debi
+000052b0: 616e 2d31 3020 7465 7374 732f 7465 7374  an-10 tests/test
+000052c0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+000052d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000052e0: 2020 2320 4661 696c 2064 7565 2074 6f20    # Fail due to 
+000052f0: 696d 6167 6520 6964 206d 6973 6d61 7463  image id mismatc
+00005300: 682e 0a20 2020 2020 2020 2020 2020 2066  h..            f
+00005310: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00005320: 202d 2d63 6c6f 7564 2067 6370 202d 2d69   --cloud gcp --i
+00005330: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00005340: 3a67 7075 2d64 6562 6961 6e2d 3130 2074  :gpu-debian-10 t
+00005350: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00005360: 6d69 6e69 6d61 6c2e 7961 6d6c 2026 2620  minimal.yaml && 
+00005370: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00005380: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005390: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000053a0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+000053b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000053c0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+000053d0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+000053e0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000053f0: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+00005400: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005410: 736b 7920 7374 6174 7573 202d 2d61 6c6c  sky status --all
+00005420: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00005430: 2067 7265 7020 7573 2d63 656e 7472 616c   grep us-central
+00005440: 3127 2c20 2023 2045 6e73 7572 6520 7468  1',  # Ensure th
+00005450: 6520 7a6f 6e65 2069 7320 636f 7272 6563  e zone is correc
+00005460: 742e 0a20 2020 2020 2020 2020 2020 2023  t..            #
+00005470: 2045 6e73 7572 6520 6578 6563 2077 6f72   Ensure exec wor
+00005480: 6b73 2e0a 2020 2020 2020 2020 2020 2020  ks..            
+00005490: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+000054a0: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
+000054b0: 7a6f 6e65 2075 732d 6365 6e74 7261 6c31  zone us-central1
+000054c0: 2d61 2074 6573 7473 2f74 6573 745f 7961  -a tests/test_ya
+000054d0: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
+000054e0: 6f6e 5f69 6d61 6765 732e 7961 6d6c 272c  on_images.yaml',
+000054f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005500: 6b79 2065 7865 6320 7b6e 616d 657d 2074  ky exec {name} t
+00005510: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00005520: 6763 705f 7065 725f 7265 6769 6f6e 5f69  gcp_per_region_i
+00005530: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
+00005540: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00005550: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
+00005560: 7564 2067 6370 202d 2d72 6567 696f 6e20  ud gcp --region 
+00005570: 7573 2d63 656e 7472 616c 3120 226c 7320  us-central1 "ls 
+00005580: 7e22 272c 0a20 2020 2020 2020 2020 2020  ~"',.           
+00005590: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000055a0: 657d 2022 6c73 207e 2227 2c0a 2020 2020  e} "ls ~"',.    
+000055b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000055c0: 6773 207b 6e61 6d65 7d20 3420 2d2d 7374  gs {name} 4 --st
+000055d0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+000055e0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000055f0: 616d 657d 2035 202d 2d73 7461 7475 7327  ame} 5 --status'
+00005600: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005610: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005620: 3620 2d2d 7374 6174 7573 272c 0a20 2020  6 --status',.   
+00005630: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005640: 6f67 7320 7b6e 616d 657d 2037 202d 2d73  ogs {name} 7 --s
+00005650: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00005660: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00005670: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00005680: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00005690: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000056a0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+000056b0: 730a 6465 6620 7465 7374 5f63 6c6f 6e65  s.def test_clone
+000056c0: 5f64 6973 6b5f 6177 7328 293a 0a20 2020  _disk_aws():.   
+000056d0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000056e0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000056f0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00005700: 2020 2020 2027 636c 6f6e 655f 6469 736b       'clone_disk
+00005710: 5f61 7773 272c 0a20 2020 2020 2020 205b  _aws',.        [
+00005720: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005730: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00005740: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+00005750: 7773 202d 2d72 6567 696f 6e20 7573 2d65  ws --region us-e
+00005760: 6173 742d 3220 2d2d 7265 7472 792d 756e  ast-2 --retry-un
+00005770: 7469 6c2d 7570 2022 6563 686f 2068 656c  til-up "echo hel
+00005780: 6c6f 203e 207e 2f75 7365 725f 6669 6c65  lo > ~/user_file
+00005790: 2e74 7874 2227 2c0a 2020 2020 2020 2020  .txt"',.        
+000057a0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000057b0: 202d 2d63 6c6f 6e65 2d64 6973 6b2d 6672   --clone-disk-fr
+000057c0: 6f6d 207b 6e61 6d65 7d20 2d79 202d 6320  om {name} -y -c 
+000057d0: 7b6e 616d 657d 2d63 6c6f 6e65 2026 2620  {name}-clone && 
+000057e0: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+000057f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005800: 6b79 2073 746f 7020 7b6e 616d 657d 202d  ky stop {name} -
+00005810: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00005820: 2773 6c65 6570 2036 3027 2c0a 2020 2020  'sleep 60',.    
+00005830: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00005840: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
+00005850: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
+00005860: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
+00005870: 202d 2d63 6c6f 7564 2061 7773 202d 6420   --cloud aws -d 
+00005880: 2d2d 7265 6769 6f6e 2075 732d 7765 7374  --region us-west
+00005890: 2d32 2022 6361 7420 7e2f 7573 6572 5f66  -2 "cat ~/user_f
+000058a0: 696c 652e 7478 7420 7c20 6772 6570 2068  ile.txt | grep h
+000058b0: 656c 6c6f 2227 2c0a 2020 2020 2020 2020  ello"',.        
+000058c0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000058d0: 202d 2d63 6c6f 6e65 2d64 6973 6b2d 6672   --clone-disk-fr
+000058e0: 6f6d 207b 6e61 6d65 7d20 2d79 202d 6320  om {name} -y -c 
+000058f0: 7b6e 616d 657d 2d63 6c6f 6e65 2d32 202d  {name}-clone-2 -
+00005900: 2d63 6c6f 7564 2061 7773 202d 6420 2d2d  -cloud aws -d --
+00005910: 7265 6769 6f6e 2075 732d 6561 7374 2d32  region us-east-2
+00005920: 2022 6361 7420 7e2f 7573 6572 5f66 696c   "cat ~/user_fil
+00005930: 652e 7478 7420 7c20 6772 6570 2068 656c  e.txt | grep hel
+00005940: 6c6f 2227 2c0a 2020 2020 2020 2020 2020  lo"',.          
+00005950: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00005960: 6d65 7d2d 636c 6f6e 6520 3120 2d2d 7374  me}-clone 1 --st
+00005970: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00005980: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00005990: 616d 657d 2d63 6c6f 6e65 2d32 2031 202d  ame}-clone-2 1 -
+000059a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000059b0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+000059c0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+000059d0: 7d20 7b6e 616d 657d 2d63 6c6f 6e65 207b  } {name}-clone {
+000059e0: 6e61 6d65 7d2d 636c 6f6e 652d 3227 2c0a  name}-clone-2',.
+000059f0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00005a00: 3330 202a 2036 302c 0a20 2020 2029 0a20  30 * 60,.    ). 
+00005a10: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00005a20: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00005a30: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00005a40: 745f 636c 6f6e 655f 6469 736b 5f67 6370  t_clone_disk_gcp
+00005a50: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00005a60: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00005a70: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00005a80: 7374 280a 2020 2020 2020 2020 2763 6c6f  st(.        'clo
+00005a90: 6e65 5f64 6973 6b5f 6763 7027 2c0a 2020  ne_disk_gcp',.  
+00005aa0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00005ab0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00005ac0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00005ad0: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
+00005ae0: 2075 732d 6561 7374 312d 6220 2d2d 7265   us-east1-b --re
+00005af0: 7472 792d 756e 7469 6c2d 7570 2022 6563  try-until-up "ec
+00005b00: 686f 2068 656c 6c6f 203e 207e 2f75 7365  ho hello > ~/use
+00005b10: 725f 6669 6c65 2e74 7874 2227 2c0a 2020  r_file.txt"',.  
+00005b20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005b30: 6c61 756e 6368 202d 2d63 6c6f 6e65 2d64  launch --clone-d
+00005b40: 6973 6b2d 6672 6f6d 207b 6e61 6d65 7d20  isk-from {name} 
+00005b50: 2d79 202d 6320 7b6e 616d 657d 2d63 6c6f  -y -c {name}-clo
+00005b60: 6e65 2026 2620 6578 6974 2031 207c 7c20  ne && exit 1 || 
+00005b70: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
+00005b80: 2020 2066 2773 6b79 2073 746f 7020 7b6e     f'sky stop {n
+00005b90: 616d 657d 202d 7927 2c0a 2020 2020 2020  ame} -y',.      
+00005ba0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00005bb0: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
+00005bc0: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
+00005bd0: 6320 7b6e 616d 657d 2d63 6c6f 6e65 202d  c {name}-clone -
+00005be0: 2d63 6c6f 7564 2067 6370 202d 2d7a 6f6e  -cloud gcp --zon
+00005bf0: 6520 7573 2d63 656e 7472 616c 312d 6120  e us-central1-a 
+00005c00: 2263 6174 207e 2f75 7365 725f 6669 6c65  "cat ~/user_file
+00005c10: 2e74 7874 207c 2067 7265 7020 6865 6c6c  .txt | grep hell
+00005c20: 6f22 272c 0a20 2020 2020 2020 2020 2020  o"',.           
+00005c30: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
+00005c40: 636c 6f6e 652d 6469 736b 2d66 726f 6d20  clone-disk-from 
+00005c50: 7b6e 616d 657d 202d 7920 2d63 207b 6e61  {name} -y -c {na
+00005c60: 6d65 7d2d 636c 6f6e 652d 3220 2d2d 636c  me}-clone-2 --cl
+00005c70: 6f75 6420 6763 7020 2d2d 7a6f 6e65 2075  oud gcp --zone u
+00005c80: 732d 6561 7374 312d 6220 2263 6174 207e  s-east1-b "cat ~
+00005c90: 2f75 7365 725f 6669 6c65 2e74 7874 207c  /user_file.txt |
+00005ca0: 2067 7265 7020 6865 6c6c 6f22 272c 0a20   grep hello"',. 
+00005cb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005cc0: 206c 6f67 7320 7b6e 616d 657d 2d63 6c6f   logs {name}-clo
+00005cd0: 6e65 2031 202d 2d73 7461 7475 7327 2c0a  ne 1 --status',.
+00005ce0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005cf0: 7920 6c6f 6773 207b 6e61 6d65 7d2d 636c  y logs {name}-cl
+00005d00: 6f6e 652d 3220 3120 2d2d 7374 6174 7573  one-2 1 --status
+00005d10: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00005d20: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00005d30: 202d 7920 7b6e 616d 657d 207b 6e61 6d65   -y {name} {name
+00005d40: 7d2d 636c 6f6e 6520 7b6e 616d 657d 2d63  }-clone {name}-c
+00005d50: 6c6f 6e65 2d32 272c 0a20 2020 2029 0a20  lone-2',.    ). 
+00005d60: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00005d70: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00005d80: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+00005d90: 745f 696d 6167 655f 6e6f 5f63 6f6e 6461  t_image_no_conda
+00005da0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00005db0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00005dc0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00005dd0: 7374 280a 2020 2020 2020 2020 2769 6d61  st(.        'ima
+00005de0: 6765 5f6e 6f5f 636f 6e64 6127 2c0a 2020  ge_no_conda',.  
+00005df0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00005e00: 2020 2020 2320 5573 6520 696d 6167 6520      # Use image 
+00005e10: 6964 2064 6963 742e 0a20 2020 2020 2020  id dict..       
+00005e20: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00005e30: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00005e40: 2d72 6567 696f 6e20 7573 2d65 6173 742d  -region us-east-
+00005e50: 3220 6578 616d 706c 6573 2f70 6572 5f72  2 examples/per_r
+00005e60: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+00005e70: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00005e80: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00005e90: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
+00005ea0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005eb0: 2073 746f 7020 7b6e 616d 657d 202d 7927   stop {name} -y'
+00005ec0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005ed0: 736b 7920 7374 6172 7420 7b6e 616d 657d  sky start {name}
+00005ee0: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
+00005ef0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00005f00: 6d65 7d20 6578 616d 706c 6573 2f70 6572  me} examples/per
+00005f10: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00005f20: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00005f30: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00005f40: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+00005f50: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00005f60: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00005f70: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00005f80: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00005f90: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00005fa0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7420 7374  -------- Test st
+00005fb0: 616c 6520 6a6f 6220 2d2d 2d2d 2d2d 2d2d  ale job --------
+00005fc0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00005fd0: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+00005fe0: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
+00005ff0: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+00006000: 7274 2073 746f 7070 696e 6720 696e 7374  rt stopping inst
+00006010: 616e 6365 730a 6465 6620 7465 7374 5f73  ances.def test_s
+00006020: 7461 6c65 5f6a 6f62 2867 656e 6572 6963  tale_job(generic
+00006030: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00006040: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00006050: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00006060: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00006070: 2020 2020 2020 2773 7461 6c65 5f6a 6f62        'stale_job
+00006080: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00006090: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000060a0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000060b0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+000060c0: 7269 635f 636c 6f75 647d 2022 6563 686f  ric_cloud} "echo
+000060d0: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
+000060e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000060f0: 616d 657d 202d 6420 2265 6368 6f20 7374  ame} -d "echo st
+00006100: 6172 743b 2073 6c65 6570 2031 3030 3030  art; sleep 10000
+00006110: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00006120: 6627 736b 7920 7374 6f70 207b 6e61 6d65  f'sky stop {name
+00006130: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
+00006140: 2020 2027 736c 6565 7020 3130 3027 2c20     'sleep 100', 
+00006150: 2023 2045 6e73 7572 6520 7468 6973 2069   # Ensure this i
+00006160: 7320 6c61 7267 6520 656e 6f75 6768 2c20  s large enough, 
+00006170: 656c 7365 2047 4350 206c 6561 6b73 2e0a  else GCP leaks..
+00006180: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006190: 7920 7374 6172 7420 7b6e 616d 657d 202d  y start {name} -
+000061a0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+000061b0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000061c0: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
+000061d0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+000061e0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+000061f0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+00006200: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+00006210: 2224 7322 207c 2067 7265 7020 4641 494c  "$s" | grep FAIL
+00006220: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
+00006230: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00006240: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00006250: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00006260: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00006270: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
+00006280: 6566 2074 6573 745f 6177 735f 7374 616c  ef test_aws_stal
+00006290: 655f 6a6f 625f 6d61 6e75 616c 5f72 6573  e_job_manual_res
+000062a0: 7461 7274 2829 3a0a 2020 2020 6e61 6d65  tart():.    name
+000062b0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000062c0: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
+000062d0: 6e20 3d20 2775 732d 7765 7374 2d32 270a  n = 'us-west-2'.
+000062e0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+000062f0: 0a20 2020 2020 2020 2027 6177 735f 7374  .        'aws_st
+00006300: 616c 655f 6a6f 625f 6d61 6e75 616c 5f72  ale_job_manual_r
+00006310: 6573 7461 7274 272c 0a20 2020 2020 2020  estart',.       
+00006320: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00006330: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00006340: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00006350: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+00006360: 6567 696f 6e7d 2022 6563 686f 2068 6922  egion} "echo hi"
+00006370: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006380: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00006390: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
+000063a0: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
+000063b0: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+000063c0: 6f70 2074 6865 2063 6c75 7374 6572 206d  op the cluster m
+000063d0: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
+000063e0: 2020 2020 2066 2769 643d 6061 7773 2065       f'id=`aws e
+000063f0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+00006400: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+00006410: 7265 6769 6f6e 7d20 2d2d 6669 6c74 6572  region} --filter
+00006420: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+00006430: 6627 4e61 6d65 3d74 6167 3a72 6179 2d63  f'Name=tag:ray-c
+00006440: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
+00006450: 6573 3d7b 6e61 6d65 7d20 270a 2020 2020  es={name} '.    
+00006460: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
+00006470: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
+00006480: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
+00006490: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
+000064a0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+000064b0: 7465 7874 603b 2027 0a20 2020 2020 2020  text`; '.       
+000064c0: 2020 2020 2066 2761 7773 2065 6332 2073       f'aws ec2 s
+000064d0: 746f 702d 696e 7374 616e 6365 7320 2d2d  top-instances --
+000064e0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+000064f0: 270a 2020 2020 2020 2020 2020 2020 272d  '.            '-
+00006500: 2d69 6e73 7461 6e63 652d 6964 7320 2469  -instance-ids $i
+00006510: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00006520: 2773 6c65 6570 2034 3027 2c0a 2020 2020  'sleep 40',.    
+00006530: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00006540: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
+00006550: 7920 2265 6368 6f20 6869 2227 2c0a 2020  y "echo hi"',.  
+00006560: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006570: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00006580: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006590: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000065a0: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+000065b0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000065c0: 2320 456e 7375 7265 2074 6865 2073 6b79  # Ensure the sky
+000065d0: 6c65 7420 7570 6461 7465 6420 7468 6520  let updated the 
+000065e0: 7374 616c 6520 6a6f 6220 7374 6174 7573  stale job status
+000065f0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00006600: 736c 6565 7020 7b65 7665 6e74 732e 4a6f  sleep {events.Jo
+00006610: 6253 6368 6564 756c 6572 4576 656e 742e  bSchedulerEvent.
+00006620: 4556 454e 545f 494e 5445 5256 414c 5f53  EVENT_INTERVAL_S
+00006630: 4543 4f4e 4453 7d27 2c0a 2020 2020 2020  ECONDS}',.      
+00006640: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+00006650: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+00006660: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+00006670: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+00006680: 7c20 6772 6570 2046 4149 4c45 4427 2c0a  | grep FAILED',.
+00006690: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+000066a0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+000066b0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+000066c0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000066d0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+000066e0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
+000066f0: 7374 5f67 6370 5f73 7461 6c65 5f6a 6f62  st_gcp_stale_job
+00006700: 5f6d 616e 7561 6c5f 7265 7374 6172 7428  _manual_restart(
+00006710: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00006720: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00006730: 290a 2020 2020 7a6f 6e65 203d 2027 7573  ).    zone = 'us
+00006740: 2d77 6573 7432 2d61 270a 2020 2020 7175  -west2-a'.    qu
+00006750: 6572 795f 636d 6420 3d20 2866 2767 636c  ery_cmd = (f'gcl
+00006760: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+00006770: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
+00006780: 7465 723d 270a 2020 2020 2020 2020 2020  ter='.          
+00006790: 2020 2020 2020 2066 2722 286c 6162 656c         f'"(label
+000067a0: 732e 7261 792d 636c 7573 7465 722d 6e61  s.ray-cluster-na
+000067b0: 6d65 3d7b 6e61 6d65 7d29 2220 270a 2020  me={name})" '.  
+000067c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000067d0: 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20  '--zones={zone} 
+000067e0: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
+000067f0: 6e61 6d65 2922 2729 0a20 2020 2073 746f  name)"').    sto
+00006800: 705f 636d 6420 3d20 2866 2767 636c 6f75  p_cmd = (f'gclou
+00006810: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00006820: 6365 7320 7374 6f70 202d 2d7a 6f6e 653d  ces stop --zone=
+00006830: 7b7a 6f6e 657d 270a 2020 2020 2020 2020  {zone}'.        
+00006840: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
+00006850: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
+00006860: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
+00006870: 6573 7428 0a20 2020 2020 2020 2027 6763  est(.        'gc
+00006880: 705f 7374 616c 655f 6a6f 625f 6d61 6e75  p_stale_job_manu
+00006890: 616c 5f72 6573 7461 7274 272c 0a20 2020  al_restart',.   
+000068a0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+000068b0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000068c0: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+000068d0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+000068e0: 7b7a 6f6e 657d 2022 6563 686f 2068 6922  {zone} "echo hi"
+000068f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006900: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00006910: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
+00006920: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
+00006930: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+00006940: 6f70 2074 6865 2063 6c75 7374 6572 206d  op the cluster m
+00006950: 616e 7561 6c6c 792e 0a20 2020 2020 2020  anually..       
+00006960: 2020 2020 2073 746f 705f 636d 642c 0a20       stop_cmd,. 
+00006970: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00006980: 7020 3430 272c 0a20 2020 2020 2020 2020  p 40',.         
+00006990: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000069a0: 2d63 207b 6e61 6d65 7d20 2d79 2022 6563  -c {name} -y "ec
+000069b0: 686f 2068 6922 272c 0a20 2020 2020 2020  ho hi"',.       
+000069c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000069d0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+000069e0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000069f0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00006a00: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+00006a10: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+00006a20: 7572 6520 7468 6520 736b 796c 6574 2075  ure the skylet u
+00006a30: 7064 6174 6564 2074 6865 2073 7461 6c65  pdated the stale
+00006a40: 206a 6f62 2073 7461 7475 732e 0a20 2020   job status..   
+00006a50: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+00006a60: 207b 6576 656e 7473 2e4a 6f62 5363 6865   {events.JobSche
+00006a70: 6475 6c65 7245 7665 6e74 2e45 5645 4e54  dulerEvent.EVENT
+00006a80: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+00006a90: 537d 272c 0a20 2020 2020 2020 2020 2020  S}',.           
+00006aa0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+00006ab0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+00006ac0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+00006ad0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00006ae0: 7020 4641 494c 4544 272c 0a20 2020 2020  p FAILED',.     
+00006af0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00006b00: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00006b10: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00006b20: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00006b30: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00006b40: 2043 6865 636b 2053 6b79 2773 2065 6e76   Check Sky's env
+00006b50: 6972 6f6e 6d65 6e74 2076 6172 6961 626c  ironment variabl
+00006b60: 6573 3b20 776f 726b 6469 722e 202d 2d2d  es; workdir. ---
+00006b70: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00006b80: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00006b90: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00006ba0: 6f72 7420 6e75 6d5f 6e6f 6465 7320 3e20  ort num_nodes > 
+00006bb0: 3120 7965 740a 6465 6620 7465 7374 5f65  1 yet.def test_e
+00006bc0: 6e76 5f63 6865 636b 2867 656e 6572 6963  nv_check(generic
+00006bd0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00006be0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00006bf0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00006c00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00006c10: 2020 2020 2020 2765 6e76 5f63 6865 636b        'env_check
+00006c20: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00006c30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006c40: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00006c50: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00006c60: 7269 635f 636c 6f75 647d 202d 2d64 6574  ric_cloud} --det
+00006c70: 6163 682d 7365 7475 7020 6578 616d 706c  ach-setup exampl
+00006c80: 6573 2f65 6e76 5f63 6865 636b 2e79 616d  es/env_check.yam
+00006c90: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00006ca0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00006cb0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00006cc0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00006cd0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00006ce0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00006cf0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00006d00: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00006d10: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00006d20: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+00006d30: 2d20 6669 6c65 5f6d 6f75 6e74 7320 2d2d  - file_mounts --
+00006d40: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00006d50: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+00006d60: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+00006d70: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+00006d80: 2031 2079 6574 2e20 5275 6e20 7465 7374   1 yet. Run test
+00006d90: 5f73 6370 5f66 696c 655f 6d6f 756e 7473  _scp_file_mounts
+00006da0: 2069 6e73 7465 6164 2e0a 6465 6620 7465   instead..def te
+00006db0: 7374 5f66 696c 655f 6d6f 756e 7473 2867  st_file_mounts(g
+00006dc0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00006dd0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+00006de0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00006df0: 2829 0a20 2020 2074 6573 745f 636f 6d6d  ().    test_comm
+00006e00: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
+00006e10: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+00006e20: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00006e30: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00006e40: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00006e50: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00006e60: 7564 7d20 6578 616d 706c 6573 2f75 7369  ud} examples/usi
+00006e70: 6e67 5f66 696c 655f 6d6f 756e 7473 2e79  ng_file_mounts.y
+00006e80: 616d 6c27 2c0a 2020 2020 2020 2020 6627  aml',.        f'
+00006e90: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00006ea0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+00006eb0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00006ec0: 7563 6365 6564 6564 2e0a 2020 2020 5d0a  ucceeded..    ].
+00006ed0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00006ee0: 0a20 2020 2020 2020 2027 7573 696e 675f  .        'using_
+00006ef0: 6669 6c65 5f6d 6f75 6e74 7327 2c0a 2020  file_mounts',.  
+00006f00: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+00006f10: 6e64 732c 0a20 2020 2020 2020 2066 2773  nds,.        f's
+00006f20: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00006f30: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+00006f40: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
+00006f50: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
+00006f60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00006f70: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00006f80: 6172 6b2e 7363 700a 6465 6620 7465 7374  ark.scp.def test
+00006f90: 5f73 6370 5f66 696c 655f 6d6f 756e 7473  _scp_file_mounts
+00006fa0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00006fb0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00006fc0: 2829 0a20 2020 2074 6573 745f 636f 6d6d  ().    test_comm
+00006fd0: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
+00006fe0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+00006ff0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00007000: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00007010: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
+00007020: 5f54 5950 457d 202d 2d6e 756d 2d6e 6f64  _TYPE} --num-nod
+00007030: 6573 2031 2065 7861 6d70 6c65 732f 7573  es 1 examples/us
+00007040: 696e 675f 6669 6c65 5f6d 6f75 6e74 732e  ing_file_mounts.
+00007050: 7961 6d6c 272c 0a20 2020 2020 2020 2066  yaml',.        f
+00007060: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00007070: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00007080: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00007090: 7375 6363 6565 6465 642e 0a20 2020 205d  succeeded..    ]
+000070a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000070b0: 280a 2020 2020 2020 2020 2753 4350 5f75  (.        'SCP_u
+000070c0: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+000070d0: 272c 0a20 2020 2020 2020 2074 6573 745f  ',.        test_
+000070e0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+000070f0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00007100: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+00007110: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+00007120: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
+00007130: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00007140: 6573 7428 7465 7374 290a 0a0a 6465 6620  est(test)...def 
+00007150: 7465 7374 5f75 7369 6e67 5f66 696c 655f  test_using_file_
+00007160: 6d6f 756e 7473 5f77 6974 685f 656e 765f  mounts_with_env_
+00007170: 7661 7273 2867 656e 6572 6963 5f63 6c6f  vars(generic_clo
+00007180: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00007190: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000071a0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000071b0: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
+000071c0: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
+000071d0: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
+000071e0: 2020 2020 2020 2020 2866 2773 6b79 206c          (f'sky l
+000071f0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00007200: 657d 202d 2d63 7075 7320 322b 202d 2d63  e} --cpus 2+ --c
+00007210: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00007220: 6f75 647d 2027 0a20 2020 2020 2020 2020  oud} '.         
+00007230: 2765 7861 6d70 6c65 732f 7573 696e 675f  'examples/using_
+00007240: 6669 6c65 5f6d 6f75 6e74 735f 7769 7468  file_mounts_with
+00007250: 5f65 6e76 5f76 6172 732e 7961 6d6c 2729  _env_vars.yaml')
+00007260: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00007270: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00007280: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00007290: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+000072a0: 6564 6564 2e0a 2020 2020 2020 2020 2320  eded..        # 
+000072b0: 4f76 6572 7269 6465 2077 6974 6820 2d2d  Override with --
+000072c0: 656e 763a 0a20 2020 2020 2020 2028 6627  env:.        (f'
+000072d0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000072e0: 207b 6e61 6d65 7d2d 3220 2d2d 6370 7573   {name}-2 --cpus
+000072f0: 2032 2b20 2d2d 636c 6f75 6420 7b67 656e   2+ --cloud {gen
+00007300: 6572 6963 5f63 6c6f 7564 7d20 270a 2020  eric_cloud} '.  
+00007310: 2020 2020 2020 2027 6578 616d 706c 6573         'examples
+00007320: 2f75 7369 6e67 5f66 696c 655f 6d6f 756e  /using_file_moun
+00007330: 7473 5f77 6974 685f 656e 765f 7661 7273  ts_with_env_vars
+00007340: 2e79 616d 6c20 270a 2020 2020 2020 2020  .yaml '.        
+00007350: 2027 2d2d 656e 7620 4d59 5f4c 4f43 414c   '--env MY_LOCAL
+00007360: 5f50 4154 483d 746d 7066 696c 6527 292c  _PATH=tmpfile'),
+00007370: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
+00007380: 6f67 7320 7b6e 616d 657d 2d32 2031 202d  ogs {name}-2 1 -
+00007390: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000073a0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000073b0: 6565 6465 642e 0a20 2020 205d 0a20 2020  eeded..    ].   
+000073c0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000073d0: 2020 2020 2020 2775 7369 6e67 5f66 696c        'using_fil
+000073e0: 655f 6d6f 756e 7473 5f77 6974 685f 656e  e_mounts_with_en
+000073f0: 765f 7661 7273 272c 0a20 2020 2020 2020  v_vars',.       
+00007400: 2074 6573 745f 636f 6d6d 616e 6473 2c0a   test_commands,.
+00007410: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00007420: 776e 202d 7920 7b6e 616d 657d 207b 6e61  wn -y {name} {na
+00007430: 6d65 7d2d 3227 2c0a 2020 2020 2020 2020  me}-2',.        
+00007440: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00007450: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
+00007460: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00007470: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00007480: 2d2d 2d2d 2d2d 2d20 7374 6f72 6167 6520  ------- storage 
+00007490: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+000074a0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+000074b0: 7465 7374 5f61 7773 5f73 746f 7261 6765  test_aws_storage
+000074c0: 5f6d 6f75 6e74 7328 293a 0a20 2020 206e  _mounts():.    n
+000074d0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000074e0: 6572 5f6e 616d 6528 290a 2020 2020 7374  er_name().    st
+000074f0: 6f72 6167 655f 6e61 6d65 203d 2066 2773  orage_name = f's
+00007500: 6b79 2d74 6573 742d 7b69 6e74 2874 696d  ky-test-{int(tim
+00007510: 652e 7469 6d65 2829 297d 270a 2020 2020  e.time())}'.    
+00007520: 7465 6d70 6c61 7465 5f73 7472 203d 2070  template_str = p
+00007530: 6174 686c 6962 2e50 6174 6828 0a20 2020  athlib.Path(.   
+00007540: 2020 2020 2027 7465 7374 732f 7465 7374       'tests/test
+00007550: 5f79 616d 6c73 2f74 6573 745f 7374 6f72  _yamls/test_stor
+00007560: 6167 655f 6d6f 756e 7469 6e67 2e79 616d  age_mounting.yam
+00007570: 6c27 292e 7265 6164 5f74 6578 7428 290a  l').read_text().
+00007580: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
+00007590: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
+000075a0: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
+000075b0: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
+000075c0: 6174 652e 7265 6e64 6572 2873 746f 7261  ate.render(stora
+000075d0: 6765 5f6e 616d 653d 7374 6f72 6167 655f  ge_name=storage_
+000075e0: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
+000075f0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+00007600: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+00007610: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+00007620: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+00007630: 2020 2066 2e77 7269 7465 2863 6f6e 7465     f.write(conte
+00007640: 6e74 290a 2020 2020 2020 2020 662e 666c  nt).        f.fl
+00007650: 7573 6828 290a 2020 2020 2020 2020 6669  ush().        fi
+00007660: 6c65 5f70 6174 6820 3d20 662e 6e61 6d65  le_path = f.name
+00007670: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
+00007680: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
+00007690: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
+000076a0: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
+000076b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000076c0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+000076d0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
+000076e0: 7320 7b66 696c 655f 7061 7468 7d27 2c0a  s {file_path}',.
+000076f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00007700: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00007710: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00007720: 7375 7265 206a 6f62 2073 7563 6365 6564  sure job succeed
+00007730: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00007740: 6627 6177 7320 7333 206c 7320 7b73 746f  f'aws s3 ls {sto
+00007750: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
+00007760: 2e74 7874 272c 0a20 2020 2020 2020 205d  .txt',.        ]
+00007770: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
+00007780: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
+00007790: 2020 2761 7773 5f73 746f 7261 6765 5f6d    'aws_storage_m
+000077a0: 6f75 6e74 7327 2c0a 2020 2020 2020 2020  ounts',.        
+000077b0: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+000077c0: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
+000077d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000077e0: 6d65 7d3b 2073 6b79 2073 746f 7261 6765  me}; sky storage
+000077f0: 2064 656c 6574 6520 7b73 746f 7261 6765   delete {storage
+00007800: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
+00007810: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00007820: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
+00007830: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00007840: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00007850: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00007860: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00007870: 745f 6763 705f 7374 6f72 6167 655f 6d6f  t_gcp_storage_mo
+00007880: 756e 7473 2829 3a0a 2020 2020 6e61 6d65  unts():.    name
+00007890: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000078a0: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
+000078b0: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
+000078c0: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
+000078d0: 696d 6528 2929 7d27 0a20 2020 2074 656d  ime())}'.    tem
+000078e0: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
+000078f0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
+00007900: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
+00007910: 6d6c 732f 7465 7374 5f73 746f 7261 6765  mls/test_storage
+00007920: 5f6d 6f75 6e74 696e 672e 7961 6d6c 2729  _mounting.yaml')
+00007930: 2e72 6561 645f 7465 7874 2829 0a20 2020  .read_text().   
+00007940: 2074 656d 706c 6174 6520 3d20 6a69 6e6a   template = jinj
+00007950: 6132 2e54 656d 706c 6174 6528 7465 6d70  a2.Template(temp
+00007960: 6c61 7465 5f73 7472 290a 2020 2020 636f  late_str).    co
+00007970: 6e74 656e 7420 3d20 7465 6d70 6c61 7465  ntent = template
+00007980: 2e72 656e 6465 7228 7374 6f72 6167 655f  .render(storage_
+00007990: 6e61 6d65 3d73 746f 7261 6765 5f6e 616d  name=storage_nam
+000079a0: 6529 0a20 2020 2077 6974 6820 7465 6d70  e).    with temp
+000079b0: 6669 6c65 2e4e 616d 6564 5465 6d70 6f72  file.NamedTempor
+000079c0: 6172 7946 696c 6528 7375 6666 6978 3d27  aryFile(suffix='
+000079d0: 2e79 616d 6c27 2c20 6d6f 6465 3d27 7727  .yaml', mode='w'
+000079e0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+000079f0: 662e 7772 6974 6528 636f 6e74 656e 7429  f.write(content)
+00007a00: 0a20 2020 2020 2020 2066 2e66 6c75 7368  .        f.flush
+00007a10: 2829 0a20 2020 2020 2020 2066 696c 655f  ().        file_
+00007a20: 7061 7468 203d 2066 2e6e 616d 650a 2020  path = f.name.  
+00007a30: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+00007a40: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
+00007a50: 2020 2020 2a73 746f 7261 6765 5f73 6574      *storage_set
+00007a60: 7570 5f63 6f6d 6d61 6e64 732c 0a20 2020  up_commands,.   
+00007a70: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00007a80: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00007a90: 657d 202d 2d63 6c6f 7564 2067 6370 207b  e} --cloud gcp {
+00007aa0: 6669 6c65 5f70 6174 687d 272c 0a20 2020  file_path}',.   
+00007ab0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00007ac0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00007ad0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00007ae0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00007af0: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
+00007b00: 7375 7469 6c20 6c73 2067 733a 2f2f 7b73  sutil ls gs://{s
+00007b10: 746f 7261 6765 5f6e 616d 657d 2f68 656c  torage_name}/hel
+00007b20: 6c6f 2e74 7874 272c 0a20 2020 2020 2020  lo.txt',.       
+00007b30: 205d 0a20 2020 2020 2020 2074 6573 7420   ].        test 
+00007b40: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00007b50: 2020 2020 2767 6370 5f73 746f 7261 6765      'gcp_storage
+00007b60: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
+00007b70: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+00007b80: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
+00007b90: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00007ba0: 6e61 6d65 7d3b 2073 6b79 2073 746f 7261  name}; sky stora
+00007bb0: 6765 2064 656c 6574 6520 7b73 746f 7261  ge delete {stora
+00007bc0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
+00007bd0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00007be0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+00007bf0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
+00007c00: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+00007c10: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00007c20: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+00007c30: 650a 6465 6620 7465 7374 5f63 6c6f 7564  e.def test_cloud
+00007c40: 666c 6172 655f 7374 6f72 6167 655f 6d6f  flare_storage_mo
+00007c50: 756e 7473 2867 656e 6572 6963 5f63 6c6f  unts(generic_clo
+00007c60: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00007c70: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00007c80: 725f 6e61 6d65 2829 0a20 2020 2073 746f  r_name().    sto
+00007c90: 7261 6765 5f6e 616d 6520 3d20 6627 736b  rage_name = f'sk
+00007ca0: 792d 7465 7374 2d7b 696e 7428 7469 6d65  y-test-{int(time
+00007cb0: 2e74 696d 6528 2929 7d27 0a20 2020 2074  .time())}'.    t
+00007cc0: 656d 706c 6174 655f 7374 7220 3d20 7061  emplate_str = pa
+00007cd0: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
+00007ce0: 2020 2020 2774 6573 7473 2f74 6573 745f      'tests/test_
+00007cf0: 7961 6d6c 732f 7465 7374 5f72 325f 7374  yamls/test_r2_st
+00007d00: 6f72 6167 655f 6d6f 756e 7469 6e67 2e79  orage_mounting.y
+00007d10: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
+00007d20: 290a 2020 2020 7465 6d70 6c61 7465 203d  ).    template =
+00007d30: 206a 696e 6a61 322e 5465 6d70 6c61 7465   jinja2.Template
+00007d40: 2874 656d 706c 6174 655f 7374 7229 0a20  (template_str). 
+00007d50: 2020 2063 6f6e 7465 6e74 203d 2074 656d     content = tem
+00007d60: 706c 6174 652e 7265 6e64 6572 2873 746f  plate.render(sto
+00007d70: 7261 6765 5f6e 616d 653d 7374 6f72 6167  rage_name=storag
+00007d80: 655f 6e61 6d65 290a 2020 2020 656e 6470  e_name).    endp
+00007d90: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
+00007da0: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
+00007db0: 706f 696e 7428 290a 2020 2020 7769 7468  point().    with
+00007dc0: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
+00007dd0: 656d 706f 7261 7279 4669 6c65 2873 7566  emporaryFile(suf
+00007de0: 6669 783d 272e 7961 6d6c 272c 206d 6f64  fix='.yaml', mod
+00007df0: 653d 2777 2729 2061 7320 663a 0a20 2020  e='w') as f:.   
+00007e00: 2020 2020 2066 2e77 7269 7465 2863 6f6e       f.write(con
+00007e10: 7465 6e74 290a 2020 2020 2020 2020 662e  tent).        f.
+00007e20: 666c 7573 6828 290a 2020 2020 2020 2020  flush().        
+00007e30: 6669 6c65 5f70 6174 6820 3d20 662e 6e61  file_path = f.na
+00007e40: 6d65 0a20 2020 2020 2020 2074 6573 745f  me.        test_
+00007e50: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
+00007e60: 2020 2020 2020 2020 202a 7374 6f72 6167           *storag
+00007e70: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
+00007e80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00007e90: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00007ea0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00007eb0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00007ec0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
+00007ed0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00007ee0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00007ef0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00007f00: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
+00007f10: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00007f20: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
+00007f30: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
+00007f40: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
+00007f50: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
+00007f60: 2073 3320 6c73 2073 333a 2f2f 7b73 746f   s3 ls s3://{sto
+00007f70: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
+00007f80: 2e74 7874 202d 2d65 6e64 706f 696e 7420  .txt --endpoint 
+00007f90: 7b65 6e64 706f 696e 745f 7572 6c7d 202d  {endpoint_url} -
+00007fa0: 2d70 726f 6669 6c65 3d72 3227 0a20 2020  -profile=r2'.   
+00007fb0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+00007fc0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00007fd0: 2020 2020 2020 2020 2027 636c 6f75 6466           'cloudf
+00007fe0: 6c61 7265 5f73 746f 7261 6765 5f6d 6f75  lare_storage_mou
+00007ff0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
+00008000: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
+00008010: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008020: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00008030: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
+00008040: 656c 6574 6520 7b73 746f 7261 6765 5f6e  elete {storage_n
+00008050: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00008060: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00008070: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
+00008080: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00008090: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000080a0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+000080b0: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
+000080c0: 6962 6d5f 7374 6f72 6167 655f 6d6f 756e  ibm_storage_moun
+000080d0: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
+000080e0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000080f0: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
+00008100: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
+00008110: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
+00008120: 6528 2929 7d27 0a20 2020 2062 7563 6b65  e())}'.    bucke
+00008130: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
+00008140: 203d 2052 636c 6f6e 652e 6765 6e65 7261   = Rclone.genera
+00008150: 7465 5f72 636c 6f6e 655f 6275 636b 6574  te_rclone_bucket
+00008160: 5f70 726f 6669 6c65 5f6e 616d 6528 0a20  _profile_name(. 
+00008170: 2020 2020 2020 2073 746f 7261 6765 5f6e         storage_n
+00008180: 616d 652c 2052 636c 6f6e 652e 5263 6c6f  ame, Rclone.Rclo
+00008190: 6e65 436c 6f75 6473 2e49 424d 290a 2020  neClouds.IBM).  
+000081a0: 2020 7465 6d70 6c61 7465 5f73 7472 203d    template_str =
+000081b0: 2070 6174 686c 6962 2e50 6174 6828 0a20   pathlib.Path(. 
+000081c0: 2020 2020 2020 2027 7465 7374 732f 7465         'tests/te
+000081d0: 7374 5f79 616d 6c73 2f74 6573 745f 6962  st_yamls/test_ib
+000081e0: 6d5f 636f 735f 7374 6f72 6167 655f 6d6f  m_cos_storage_mo
+000081f0: 756e 7469 6e67 2e79 616d 6c27 292e 7265  unting.yaml').re
+00008200: 6164 5f74 6578 7428 290a 2020 2020 7465  ad_text().    te
+00008210: 6d70 6c61 7465 203d 206a 696e 6a61 322e  mplate = jinja2.
+00008220: 5465 6d70 6c61 7465 2874 656d 706c 6174  Template(templat
+00008230: 655f 7374 7229 0a20 2020 2063 6f6e 7465  e_str).    conte
+00008240: 6e74 203d 2074 656d 706c 6174 652e 7265  nt = template.re
+00008250: 6e64 6572 2873 746f 7261 6765 5f6e 616d  nder(storage_nam
+00008260: 653d 7374 6f72 6167 655f 6e61 6d65 290a  e=storage_name).
+00008270: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
+00008280: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
+00008290: 4669 6c65 2873 7566 6669 783d 272e 7961  File(suffix='.ya
+000082a0: 6d6c 272c 206d 6f64 653d 2777 2729 2061  ml', mode='w') a
+000082b0: 7320 663a 0a20 2020 2020 2020 2066 2e77  s f:.        f.w
+000082c0: 7269 7465 2863 6f6e 7465 6e74 290a 2020  rite(content).  
+000082d0: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
+000082e0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+000082f0: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
+00008300: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+00008310: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00008320: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+00008330: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00008340: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00008350: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00008360: 2d2d 636c 6f75 6420 6962 6d20 7b66 696c  --cloud ibm {fil
+00008370: 655f 7061 7468 7d27 2c0a 2020 2020 2020  e_path}',.      
+00008380: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00008390: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+000083a0: 7573 272c 2020 2320 456e 7375 7265 206a  us',  # Ensure j
+000083b0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+000083c0: 2020 2020 2020 2020 2020 6627 7263 6c6f            f'rclo
+000083d0: 6e65 206c 7320 7b62 7563 6b65 745f 7263  ne ls {bucket_rc
+000083e0: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b73  lone_profile}:{s
+000083f0: 746f 7261 6765 5f6e 616d 657d 2f68 656c  torage_name}/hel
+00008400: 6c6f 2e74 7874 272c 0a20 2020 2020 2020  lo.txt',.       
+00008410: 205d 0a20 2020 2020 2020 2074 6573 7420   ].        test 
+00008420: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00008430: 2020 2020 2769 626d 5f73 746f 7261 6765      'ibm_storage
+00008440: 5f6d 6f75 6e74 7327 2c0a 2020 2020 2020  _mounts',.      
+00008450: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
+00008460: 6e64 732c 0a20 2020 2020 2020 2020 2020  nds,.           
+00008470: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00008480: 6e61 6d65 7d3b 2073 6b79 2073 746f 7261  name}; sky stora
+00008490: 6765 2064 656c 6574 6520 7b73 746f 7261  ge delete {stora
+000084a0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
+000084b0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+000084c0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+000084d0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
+000084e0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+000084f0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00008500: 2d2d 2d2d 2d2d 2043 4c49 206c 6f67 7320  ------ CLI logs 
+00008510: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00008520: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00008530: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00008540: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+00008550: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
+00008560: 7374 5f73 6370 5f6c 6f67 7320 696e 7374  st_scp_logs inst
+00008570: 6561 642e 0a64 6566 2074 6573 745f 636c  ead..def test_cl
+00008580: 695f 6c6f 6773 2867 656e 6572 6963 5f63  i_logs(generic_c
+00008590: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000085a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000085b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000085c0: 696d 6573 7461 6d70 203d 2074 696d 652e  imestamp = time.
+000085d0: 7469 6d65 2829 0a20 2020 2074 6573 7420  time().    test 
+000085e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000085f0: 2763 6c69 5f6c 6f67 7327 2c0a 2020 2020  'cli_logs',.    
+00008600: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00008610: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00008620: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00008630: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+00008640: 7564 7d20 2d2d 6e75 6d2d 6e6f 6465 7320  ud} --num-nodes 
+00008650: 3220 2265 6368 6f20 7b74 696d 6573 7461  2 "echo {timesta
+00008660: 6d70 7d20 3122 272c 0a20 2020 2020 2020  mp} 1"',.       
+00008670: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00008680: 7b6e 616d 657d 2022 6563 686f 207b 7469  {name} "echo {ti
+00008690: 6d65 7374 616d 707d 2032 2227 2c0a 2020  mestamp} 2"',.  
+000086a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000086b0: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
+000086c0: 6f20 7b74 696d 6573 7461 6d70 7d20 3322  o {timestamp} 3"
+000086d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000086e0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000086f0: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
+00008700: 707d 2034 2227 2c0a 2020 2020 2020 2020  p} 4"',.        
+00008710: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00008720: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00008730: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008740: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00008750: 2033 2034 202d 2d73 796e 632d 646f 776e   3 4 --sync-down
+00008760: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008770: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00008780: 202a 202d 2d73 796e 632d 646f 776e 272c   * --sync-down',
+00008790: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000087a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000087b0: 207c 2067 7265 7020 227b 7469 6d65 7374   | grep "{timest
+000087c0: 616d 707d 2031 2227 2c0a 2020 2020 2020  amp} 1"',.      
+000087d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000087e0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
+000087f0: 7b74 696d 6573 7461 6d70 7d20 3422 272c  {timestamp} 4"',
+00008800: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00008810: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00008820: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00008830: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00008840: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00008850: 742e 6d61 726b 2e73 6370 0a64 6566 2074  t.mark.scp.def t
+00008860: 6573 745f 7363 705f 6c6f 6773 2829 3a0a  est_scp_logs():.
+00008870: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00008880: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00008890: 2020 2074 696d 6573 7461 6d70 203d 2074     timestamp = t
+000088a0: 696d 652e 7469 6d65 2829 0a20 2020 2074  ime.time().    t
+000088b0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000088c0: 2020 2020 2753 4350 5f63 6c69 5f6c 6f67      'SCP_cli_log
+000088d0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+000088e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000088f0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00008900: 6d65 7d20 7b53 4350 5f54 5950 457d 2022  me} {SCP_TYPE} "
+00008910: 6563 686f 207b 7469 6d65 7374 616d 707d  echo {timestamp}
+00008920: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+00008930: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00008940: 6d65 7d20 2265 6368 6f20 7b74 696d 6573  me} "echo {times
+00008950: 7461 6d70 7d20 3222 272c 0a20 2020 2020  tamp} 2"',.     
+00008960: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00008970: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
+00008980: 7469 6d65 7374 616d 707d 2033 2227 2c0a  timestamp} 3"',.
+00008990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000089a0: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
+000089b0: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
+000089c0: 3422 272c 0a20 2020 2020 2020 2020 2020  4"',.           
+000089d0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000089e0: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
+000089f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008a00: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00008a10: 3420 2d2d 7379 6e63 2d64 6f77 6e27 2c0a  4 --sync-down',.
+00008a20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008a30: 7920 6c6f 6773 207b 6e61 6d65 7d20 2a20  y logs {name} * 
+00008a40: 2d2d 7379 6e63 2d64 6f77 6e27 2c0a 2020  --sync-down',.  
+00008a50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008a60: 6c6f 6773 207b 6e61 6d65 7d20 3120 7c20  logs {name} 1 | 
+00008a70: 6772 6570 2022 7b74 696d 6573 7461 6d70  grep "{timestamp
+00008a80: 7d20 3122 272c 0a20 2020 2020 2020 2020  } 1"',.         
+00008a90: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00008aa0: 616d 657d 207c 2067 7265 7020 227b 7469  ame} | grep "{ti
+00008ab0: 6d65 7374 616d 707d 2034 2227 2c0a 2020  mestamp} 4"',.  
+00008ac0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00008ad0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00008ae0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00008af0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00008b00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00008b10: 2d2d 2d20 4a6f 6220 5175 6575 652e 202d  --- Job Queue. -
+00008b20: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+00008b30: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+00008b40: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+00008b50: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+00008b60: 6861 7665 204b 3830 2067 7075 730a 4070  have K80 gpus.@p
+00008b70: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
+00008b80: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
+00008b90: 6f65 7320 6e6f 7420 6861 7665 204b 3830  oes not have K80
+00008ba0: 2067 7075 732e 2072 756e 2074 6573 745f   gpus. run test_
+00008bb0: 6962 6d5f 6a6f 625f 7175 6575 6520 696e  ibm_job_queue in
+00008bc0: 7374 6561 640a 4070 7974 6573 742e 6d61  stead.@pytest.ma
+00008bd0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+00008be0: 2064 6f65 7320 6e6f 7420 6861 7665 204b   does not have K
+00008bf0: 3830 2067 7075 732e 2052 756e 2074 6573  80 gpus. Run tes
+00008c00: 745f 7363 705f 6a6f 625f 7175 6575 6520  t_scp_job_queue 
+00008c10: 696e 7374 6561 640a 4070 7974 6573 742e  instead.@pytest.
+00008c20: 6d61 726b 2e6e 6f5f 6f63 6920 2023 204f  mark.no_oci  # O
+00008c30: 4349 2064 6f65 7320 6e6f 7420 6861 7665  CI does not have
+00008c40: 204b 3830 2067 7075 730a 6465 6620 7465   K80 gpus.def te
+00008c50: 7374 5f6a 6f62 5f71 7565 7565 2867 656e  st_job_queue(gen
+00008c60: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00008c70: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00008c80: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00008c90: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00008ca0: 280a 2020 2020 2020 2020 276a 6f62 5f71  (.        'job_q
+00008cb0: 7565 7565 272c 0a20 2020 2020 2020 205b  ueue',.        [
+00008cc0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008cd0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00008ce0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00008cf0: 6765 6e65 7269 635f 636c 6f75 647d 2065  generic_cloud} e
+00008d00: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+00008d10: 652f 636c 7573 7465 722e 7961 6d6c 272c  e/cluster.yaml',
+00008d20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008d30: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00008d40: 6e20 7b6e 616d 657d 2d31 202d 6420 6578  n {name}-1 -d ex
+00008d50: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+00008d60: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+00008d70: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00008d80: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+00008d90: 6d65 7d2d 3220 2d64 2065 7861 6d70 6c65  me}-2 -d example
+00008da0: 732f 6a6f 625f 7175 6575 652f 6a6f 622e  s/job_queue/job.
+00008db0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00008dc0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00008dd0: 616d 657d 202d 6e20 7b6e 616d 657d 2d33  ame} -n {name}-3
+00008de0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+00008df0: 5f71 7565 7565 2f6a 6f62 2e79 616d 6c27  _queue/job.yaml'
+00008e00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00008e10: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+00008e20: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+00008e30: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00008e40: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+00008e50: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
+00008e60: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+00008e70: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+00008e80: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+00008e90: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00008ea0: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+00008eb0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+00008ec0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+00008ed0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00008ee0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+00008ef0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00008f00: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+00008f10: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+00008f20: 6d65 7d2d 3320 7c20 6772 6570 2050 454e  me}-3 | grep PEN
+00008f30: 4449 4e47 272c 0a20 2020 2020 2020 2020  DING',.         
+00008f40: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+00008f50: 2d79 207b 6e61 6d65 7d20 3227 2c0a 2020  -y {name} 2',.  
+00008f60: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00008f70: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+00008f80: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+00008f90: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+00008fa0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+00008fb0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+00008fc0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
+00008fd0: 7020 5255 4e4e 494e 4727 2c0a 2020 2020  p RUNNING',.    
+00008fe0: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
+00008ff0: 6e63 656c 202d 7920 7b6e 616d 657d 2033  ncel -y {name} 3
+00009000: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00009010: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00009020: 202d 2d67 7075 7320 4b38 303a 302e 3220   --gpus K80:0.2 
+00009030: 225b 5b20 5c24 534b 5950 494c 4f54 5f4e  "[[ \$SKYPILOT_N
+00009040: 554d 5f47 5055 535f 5045 525f 4e4f 4445  UM_GPUS_PER_NODE
+00009050: 202d 6571 2031 205d 5d20 7c7c 2065 7869   -eq 1 ]] || exi
+00009060: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+00009070: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00009080: 616d 657d 202d 2d67 7075 7320 4b38 303a  ame} --gpus K80:
+00009090: 3120 225b 5b20 5c24 534b 5950 494c 4f54  1 "[[ \$SKYPILOT
+000090a0: 5f4e 554d 5f47 5055 535f 5045 525f 4e4f  _NUM_GPUS_PER_NO
+000090b0: 4445 202d 6571 2031 205d 5d20 7c7c 2065  DE -eq 1 ]] || e
+000090c0: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
+000090d0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000090e0: 7b6e 616d 657d 2034 202d 2d73 7461 7475  {name} 4 --statu
+000090f0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00009100: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00009110: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
+00009120: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00009130: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00009140: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00009150: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00009160: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00009170: 6d61 726b 2e6c 616d 6264 615f 636c 6f75  mark.lambda_clou
+00009180: 640a 6465 6620 7465 7374 5f6c 616d 6264  d.def test_lambd
+00009190: 615f 6a6f 625f 7175 6575 6528 293a 0a20  a_job_queue():. 
+000091a0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+000091b0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000091c0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000091d0: 2020 2020 2020 2027 6c61 6d62 6461 5f6a         'lambda_j
+000091e0: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
+000091f0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00009200: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00009210: 202d 6320 7b6e 616d 657d 207b 4c41 4d42   -c {name} {LAMB
+00009220: 4441 5f54 5950 457d 2065 7861 6d70 6c65  DA_TYPE} example
+00009230: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
+00009240: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
+00009250: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00009260: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+00009270: 657d 2d31 202d 2d67 7075 7320 4131 303a  e}-1 --gpus A10:
+00009280: 302e 3520 2d64 2065 7861 6d70 6c65 732f  0.5 -d examples/
+00009290: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
+000092a0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+000092b0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000092c0: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
+000092d0: 2d67 7075 7320 4131 303a 302e 3520 2d64  -gpus A10:0.5 -d
+000092e0: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+000092f0: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
+00009300: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009310: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+00009320: 7b6e 616d 657d 2d33 202d 2d67 7075 7320  {name}-3 --gpus 
+00009330: 4131 303a 302e 3520 2d64 2065 7861 6d70  A10:0.5 -d examp
+00009340: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+00009350: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
+00009360: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+00009370: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+00009380: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
+00009390: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+000093a0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+000093b0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+000093c0: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
+000093d0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+000093e0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+000093f0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+00009400: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
+00009410: 454e 4449 4e47 272c 0a20 2020 2020 2020  ENDING',.       
+00009420: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+00009430: 6c20 2d79 207b 6e61 6d65 7d20 3227 2c0a  l -y {name} 2',.
+00009440: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00009450: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00009460: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+00009470: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+00009480: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
+00009490: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+000094a0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+000094b0: 2d79 207b 6e61 6d65 7d20 3327 2c0a 2020  -y {name} 3',.  
+000094c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000094d0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+000094e0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+000094f0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00009500: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00009510: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
+00009520: 5f69 626d 5f6a 6f62 5f71 7565 7565 2829  _ibm_job_queue()
+00009530: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00009540: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00009550: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00009560: 280a 2020 2020 2020 2020 2769 626d 5f6a  (.        'ibm_j
+00009570: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
+00009580: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00009590: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000095a0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+000095b0: 7564 2069 626d 202d 2d67 7075 7320 7631  ud ibm --gpus v1
+000095c0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+000095d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+000095e0: 657d 202d 6e20 7b6e 616d 657d 2d31 202d  e} -n {name}-1 -
+000095f0: 2d63 6c6f 7564 2069 626d 202d 6420 6578  -cloud ibm -d ex
+00009600: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+00009610: 2f6a 6f62 5f69 626d 2e79 616d 6c27 2c0a  /job_ibm.yaml',.
+00009620: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009630: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+00009640: 207b 6e61 6d65 7d2d 3220 2d2d 636c 6f75   {name}-2 --clou
+00009650: 6420 6962 6d20 2d64 2065 7861 6d70 6c65  d ibm -d example
+00009660: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+00009670: 6962 6d2e 7961 6d6c 272c 0a20 2020 2020  ibm.yaml',.     
+00009680: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00009690: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+000096a0: 657d 2d33 202d 2d63 6c6f 7564 2069 626d  e}-3 --cloud ibm
+000096b0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+000096c0: 5f71 7565 7565 2f6a 6f62 5f69 626d 2e79  _queue/job_ibm.y
+000096d0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000096e0: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+000096f0: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+00009700: 657d 2d31 207c 2067 7265 7020 5255 4e4e  e}-1 | grep RUNN
+00009710: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+00009720: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+00009730: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+00009740: 657d 2d32 207c 2067 7265 7020 5255 4e4e  e}-2 | grep RUNN
+00009750: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
 00009760: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
 00009770: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
-00009780: 657d 2d33 207c 2067 7265 7020 5255 4e4e  e}-3 | grep RUNN
+00009780: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
 00009790: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
 000097a0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-000097b0: 7920 7b6e 616d 657d 2033 272c 0a20 2020  y {name} 3',.   
-000097c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000097d0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-000097e0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-000097f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00009800: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00009810: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-00009820: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-00009830: 7564 2064 6f65 7320 6e6f 7420 6861 7665  ud does not have
-00009840: 2054 3420 6770 7573 0a40 7079 7465 7374   T4 gpus.@pytest
-00009850: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
-00009860: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
-00009870: 6f74 2068 6176 6520 5434 2067 7075 732e  ot have T4 gpus.
-00009880: 2072 756e 2074 6573 745f 6962 6d5f 6a6f   run test_ibm_jo
-00009890: 625f 7175 6575 655f 6d75 6c74 696e 6f64  b_queue_multinod
-000098a0: 6520 696e 7374 6561 640a 4070 7974 6573  e instead.@pytes
-000098b0: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-000098c0: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-000098d0: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
-000098e0: 3e20 3120 7965 740a 4070 7974 6573 742e  > 1 yet.@pytest.
-000098f0: 6d61 726b 2e6e 6f5f 6f63 6920 2023 204f  mark.no_oci  # O
-00009900: 4349 2043 6c6f 7564 2064 6f65 7320 6e6f  CI Cloud does no
-00009910: 7420 6861 7665 2054 3420 6770 7573 2e0a  t have T4 gpus..
-00009920: 6465 6620 7465 7374 5f6a 6f62 5f71 7565  def test_job_que
-00009930: 7565 5f6d 756c 7469 6e6f 6465 2867 656e  ue_multinode(gen
-00009940: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00009950: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00009960: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00009970: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00009980: 280a 2020 2020 2020 2020 276a 6f62 5f71  (.        'job_q
-00009990: 7565 7565 5f6d 756c 7469 6e6f 6465 272c  ueue_multinode',
-000099a0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-000099b0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-000099c0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-000099d0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-000099e0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
-000099f0: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
-00009a00: 7465 725f 6d75 6c74 696e 6f64 652e 7961  ter_multinode.ya
-00009a10: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00009a20: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00009a30: 657d 202d 6e20 7b6e 616d 657d 2d31 202d  e} -n {name}-1 -
-00009a40: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-00009a50: 7565 7565 2f6a 6f62 5f6d 756c 7469 6e6f  ueue/job_multino
-00009a60: 6465 2e79 616d 6c27 2c0a 2020 2020 2020  de.yaml',.      
-00009a70: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00009a80: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-00009a90: 7d2d 3220 2d64 2065 7861 6d70 6c65 732f  }-2 -d examples/
-00009aa0: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
-00009ab0: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
-00009ac0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009ad0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00009ae0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
-00009af0: 6465 7461 6368 2d73 6574 7570 202d 6420  detach-setup -d 
-00009b00: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-00009b10: 7565 2f6a 6f62 5f6d 756c 7469 6e6f 6465  ue/job_multinode
-00009b20: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00009b30: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-00009b40: 6575 6520 7b6e 616d 657d 2920 2626 2065  eue {name}) && e
-00009b50: 6368 6f20 2224 7322 2026 2620 2865 6368  cho "$s" && (ech
-00009b60: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-00009b70: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-00009b80: 4e4e 494e 4729 272c 0a20 2020 2020 2020  NNING)',.       
-00009b90: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-00009ba0: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-00009bb0: 6563 686f 2022 2473 2220 2626 2028 6563  echo "$s" && (ec
-00009bc0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-00009bd0: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
-00009be0: 554e 4e49 4e47 2927 2c0a 2020 2020 2020  UNNING)',.      
-00009bf0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-00009c00: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
-00009c10: 2065 6368 6f20 2224 7322 2026 2620 2865   echo "$s" && (e
-00009c20: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00009c30: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
-00009c40: 5045 4e44 494e 4729 272c 0a20 2020 2020  PENDING)',.     
-00009c50: 2020 2020 2020 2027 736c 6565 7020 3930         'sleep 90
-00009c60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00009c70: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
-00009c80: 6e61 6d65 7d20 3127 2c0a 2020 2020 2020  name} 1',.      
-00009c90: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
-00009ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009cb0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-00009cc0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-00009cd0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-00009ce0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-00009cf0: 616d 657d 2d33 207c 2067 7265 7020 5345  ame}-3 | grep SE
-00009d00: 5454 494e 475f 5550 272c 0a20 2020 2020  TTING_UP',.     
-00009d10: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-00009d20: 6365 6c20 2d79 207b 6e61 6d65 7d20 3120  cel -y {name} 1 
-00009d30: 3220 3327 2c0a 2020 2020 2020 2020 2020  2 3',.          
-00009d40: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00009d50: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-00009d60: 657d 2d34 202d 2d64 6574 6163 682d 7365  e}-4 --detach-se
-00009d70: 7475 7020 2d64 2065 7861 6d70 6c65 732f  tup -d examples/
-00009d80: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
-00009d90: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
-00009da0: 2020 2020 2020 2020 2020 2023 2054 6573             # Tes
-00009db0: 7420 7468 6520 6a6f 6220 7374 6174 7573  t the job status
-00009dc0: 2069 7320 636f 7272 6563 746c 7920 7365   is correctly se
-00009dd0: 7420 746f 2053 4554 5449 4e47 5f55 502c  t to SETTING_UP,
-00009de0: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
-00009df0: 7020 6973 2072 756e 6e69 6e67 2c0a 2020  p is running,.  
-00009e00: 2020 2020 2020 2020 2020 2320 616e 6420            # and 
-00009e10: 7468 6520 6a6f 6220 6361 6e20 6265 2063  the job can be c
-00009e20: 616e 6365 6c6c 6564 2064 7572 696e 6720  ancelled during 
-00009e30: 7468 6520 7365 7475 702e 0a20 2020 2020  the setup..     
-00009e40: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-00009e50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00009e60: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-00009e70: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
-00009e80: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
-00009e90: 207c 2067 7265 7020 7b6e 616d 657d 2d34   | grep {name}-4
-00009ea0: 207c 2067 7265 7020 5345 5454 494e 475f   | grep SETTING_
-00009eb0: 5550 2927 2c0a 2020 2020 2020 2020 2020  UP)',.          
-00009ec0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-00009ed0: 7920 7b6e 616d 657d 2034 272c 0a20 2020  y {name} 4',.   
-00009ee0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00009ef0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-00009f00: 2026 2620 6563 686f 2022 2473 2220 2626   && echo "$s" &&
-00009f10: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
-00009f20: 6570 207b 6e61 6d65 7d2d 3420 7c20 6772  ep {name}-4 | gr
-00009f30: 6570 2043 414e 4345 4c4c 4544 2927 2c0a  ep CANCELLED)',.
-00009f40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009f50: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00009f60: 6770 7573 2054 343a 302e 3220 225b 5b20  gpus T4:0.2 "[[ 
-00009f70: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
-00009f80: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
-00009f90: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
-00009fa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00009fb0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00009fc0: 202d 2d67 7075 7320 5434 3a30 2e32 202d   --gpus T4:0.2 -
-00009fd0: 2d6e 756d 2d6e 6f64 6573 2032 2022 5b5b  -num-nodes 2 "[[
-00009fe0: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
-00009ff0: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
-0000a000: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
-0000a010: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000a020: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000a030: 7d20 2d2d 6770 7573 2054 343a 3120 2d2d  } --gpus T4:1 --
-0000a040: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
-0000a050: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
-0000a060: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
-0000a070: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
-0000a080: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000a090: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000a0a0: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
-0000a0b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000a0c0: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
-0000a0d0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-0000a0e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000a0f0: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
-0000a100: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-0000a110: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0000a120: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0000a130: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0000a140: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0000a150: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-0000a160: 6264 615f 636c 6f75 6420 2023 204e 6f20  bda_cloud  # No 
-0000a170: 4c61 6d62 6461 2043 6c6f 7564 2056 4d20  Lambda Cloud VM 
-0000a180: 6861 7320 3820 4350 5573 0a64 6566 2074  has 8 CPUs.def t
-0000a190: 6573 745f 6c61 7267 655f 6a6f 625f 7175  est_large_job_qu
-0000a1a0: 6575 6528 6765 6e65 7269 635f 636c 6f75  eue(generic_clou
-0000a1b0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-0000a1c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000a1d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0000a1e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000a1f0: 2027 6c61 7267 655f 6a6f 625f 7175 6575   'large_job_queu
-0000a200: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-0000a210: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000a220: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000a230: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-0000a240: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
-0000a250: 2020 2020 2020 2020 2020 6627 666f 7220            f'for 
-0000a260: 6920 696e 2060 7365 7120 3120 3735 603b  i in `seq 1 75`;
-0000a270: 2064 6f20 736b 7920 6578 6563 207b 6e61   do sky exec {na
-0000a280: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 2469  me} -n {name}-$i
-0000a290: 202d 6420 2265 6368 6f20 2469 3b20 736c   -d "echo $i; sl
-0000a2a0: 6565 7020 3130 3030 3030 3030 3022 3b20  eep 100000000"; 
-0000a2b0: 646f 6e65 272c 0a20 2020 2020 2020 2020  done',.         
-0000a2c0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-0000a2d0: 2d79 207b 6e61 6d65 7d20 3120 3220 3320  -y {name} 1 2 3 
-0000a2e0: 3420 3520 3620 3720 3820 3920 3130 2031  4 5 6 7 8 9 10 1
-0000a2f0: 3120 3132 2031 3320 3134 2031 3520 3136  1 12 13 14 15 16
-0000a300: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000a310: 736c 6565 7020 3735 272c 0a20 2020 2020  sleep 75',.     
-0000a320: 2020 2020 2020 2023 2045 6163 6820 6a6f         # Each jo
-0000a330: 6220 7461 6b65 7320 302e 3520 4350 5520  b takes 0.5 CPU 
-0000a340: 616e 6420 7468 6520 6465 6661 756c 7420  and the default 
-0000a350: 564d 2068 6173 2038 2043 5055 732c 2073  VM has 8 CPUs, s
-0000a360: 6f20 7468 6572 6520 7368 6f75 6c64 2062  o there should b
-0000a370: 6520 3820 2f20 302e 3520 3d20 3136 206a  e 8 / 0.5 = 16 j
-0000a380: 6f62 7320 7275 6e6e 696e 672e 0a20 2020  obs running..   
-0000a390: 2020 2020 2020 2020 2023 2054 6865 2066           # The f
-0000a3a0: 6972 7374 2031 3620 6a6f 6273 2061 7265  irst 16 jobs are
-0000a3b0: 2063 616e 6365 6c65 642c 2073 6f20 7468   canceled, so th
-0000a3c0: 6572 6520 7368 6f75 6c64 2062 6520 3735  ere should be 75
-0000a3d0: 202d 2033 3220 3d20 3433 206a 6f62 7320   - 32 = 43 jobs 
-0000a3e0: 5045 4e44 494e 472e 0a20 2020 2020 2020  PENDING..       
-0000a3f0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000a400: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000a410: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000a420: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000a430: 2067 7265 7020 2d76 2067 7265 7020 7c20   grep -v grep | 
-0000a440: 6772 6570 2050 454e 4449 4e47 207c 2077  grep PENDING | w
-0000a450: 6320 2d6c 207c 2067 7265 7020 3433 272c  c -l | grep 43',
-0000a460: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
-0000a470: 616b 6520 7375 7265 2074 6865 206a 6f62  ake sure the job
-0000a480: 7320 6172 6520 7363 6865 6475 6c65 6420  s are scheduled 
-0000a490: 696e 2046 4946 4f20 6f72 6465 720a 2020  in FIFO order.  
-0000a4a0: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
-0000a4b0: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-0000a4c0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000a4d0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-0000a4e0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-0000a4f0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000a500: 616d 657d 2d7b 697d 207c 2067 7265 7020  ame}-{i} | grep 
-0000a510: 4341 4e43 454c 4c45 4427 0a20 2020 2020  CANCELLED'.     
-0000a520: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0000a530: 2069 6e20 7261 6e67 6528 312c 2031 3729   in range(1, 17)
-0000a540: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
-0000a550: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
-0000a560: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000a570: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000a580: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000a590: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000a5a0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000a5b0: 7b6e 616d 657d 2d7b 697d 207c 2067 7265  {name}-{i} | gre
-0000a5c0: 7020 5255 4e4e 494e 4727 0a20 2020 2020  p RUNNING'.     
-0000a5d0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0000a5e0: 2069 6e20 7261 6e67 6528 3137 2c20 3333   in range(17, 33
-0000a5f0: 290a 2020 2020 2020 2020 2020 2020 5d2c  ).            ],
-0000a600: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
-0000a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a620: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000a630: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-0000a640: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-0000a650: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000a660: 207b 6e61 6d65 7d2d 7b69 7d20 7c20 6772   {name}-{i} | gr
-0000a670: 6570 2050 454e 4449 4e47 270a 2020 2020  ep PENDING'.    
-0000a680: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000a690: 6920 696e 2072 616e 6765 2833 332c 2037  i in range(33, 7
-0000a6a0: 3529 0a20 2020 2020 2020 2020 2020 205d  5).            ]
-0000a6b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a6c0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000a6d0: 616d 657d 2033 3320 3335 2033 3720 3339  ame} 33 35 37 39
-0000a6e0: 2031 3720 3138 2031 3927 2c0a 2020 2020   17 18 19',.    
-0000a6f0: 2020 2020 2020 2020 2a5b 0a20 2020 2020          *[.     
-0000a700: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000a710: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000a720: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-0000a730: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-0000a740: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000a750: 657d 2d7b 697d 207c 2067 7265 7020 4341  e}-{i} | grep CA
-0000a760: 4e43 454c 4c45 4427 0a20 2020 2020 2020  NCELLED'.       
-0000a770: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-0000a780: 6e20 7261 6e67 6528 3333 2c20 3430 2c20  n range(33, 40, 
-0000a790: 3229 0a20 2020 2020 2020 2020 2020 205d  2).            ]
-0000a7a0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000a7b0: 6c65 6570 2031 3027 2c0a 2020 2020 2020  leep 10',.      
-0000a7c0: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
-0000a7d0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000a7e0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-0000a7f0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-0000a800: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-0000a810: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000a820: 2d7b 697d 207c 2067 7265 7020 5255 4e4e  -{i} | grep RUNN
-0000a830: 494e 4727 0a20 2020 2020 2020 2020 2020  ING'.           
-0000a840: 2020 2020 2066 6f72 2069 2069 6e20 5b33       for i in [3
-0000a850: 342c 2033 362c 2033 385d 0a20 2020 2020  4, 36, 38].     
-0000a860: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000a870: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0000a880: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0000a890: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-0000a8a0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
-0000a8b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000a8c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-0000a8d0: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-0000a8e0: 6461 5f63 6c6f 7564 2020 2320 4e6f 204c  da_cloud  # No L
-0000a8f0: 616d 6264 6120 436c 6f75 6420 564d 2068  ambda Cloud VM h
-0000a900: 6173 2038 2043 5055 730a 6465 6620 7465  as 8 CPUs.def te
-0000a910: 7374 5f66 6173 745f 6c61 7267 655f 6a6f  st_fast_large_jo
-0000a920: 625f 7175 6575 6528 6765 6e65 7269 635f  b_queue(generic_
-0000a930: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-0000a940: 2023 2054 6869 7320 6973 2074 6f20 7465   # This is to te
-0000a950: 7374 2074 6865 206a 6f62 7320 6361 6e20  st the jobs can 
-0000a960: 6265 2073 6368 6564 756c 6564 2071 7569  be scheduled qui
-0000a970: 636b 6c79 2077 6865 6e20 7468 6572 6520  ckly when there 
-0000a980: 6172 6520 6d61 6e79 206a 6f62 7320 696e  are many jobs in
-0000a990: 2074 6865 2071 7565 7565 2e0a 2020 2020   the queue..    
-0000a9a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0000a9b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0000a9c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000a9d0: 2020 2020 2766 6173 745f 6c61 7267 655f      'fast_large_
-0000a9e0: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
-0000a9f0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000aa00: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000aa10: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000aa20: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000aa30: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
-0000aa40: 2020 6627 666f 7220 6920 696e 2060 7365    f'for i in `se
-0000aa50: 7120 3120 3332 603b 2064 6f20 736b 7920  q 1 32`; do sky 
-0000aa60: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000aa70: 6e61 6d65 7d2d 2469 202d 6420 2265 6368  name}-$i -d "ech
-0000aa80: 6f20 2469 223b 2064 6f6e 6527 2c0a 2020  o $i"; done',.  
-0000aa90: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000aaa0: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-0000aab0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000aac0: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-0000aad0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000aae0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-0000aaf0: 6570 202d 7620 6772 6570 207c 2067 7265  ep -v grep | gre
-0000ab00: 7020 5355 4343 4545 4445 4420 7c20 7763  p SUCCEEDED | wc
-0000ab10: 202d 6c20 7c20 6772 6570 2033 3227 2c0a   -l | grep 32',.
-0000ab20: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000ab30: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000ab40: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000ab50: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000ab60: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0000ab70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000ab80: 0a0a 4070 7974 6573 742e 6d61 726b 2e69  ..@pytest.mark.i
-0000ab90: 626d 0a64 6566 2074 6573 745f 6962 6d5f  bm.def test_ibm_
-0000aba0: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
-0000abb0: 6f64 6528 293a 0a20 2020 206e 616d 6520  ode():.    name 
-0000abc0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000abd0: 616d 6528 290a 2020 2020 7461 736b 5f66  ame().    task_f
-0000abe0: 696c 6520 3d20 2765 7861 6d70 6c65 732f  ile = 'examples/
-0000abf0: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
-0000ac00: 6c74 696e 6f64 655f 6962 6d2e 7961 6d6c  ltinode_ibm.yaml
-0000ac10: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
-0000ac20: 7428 0a20 2020 2020 2020 2027 6962 6d5f  t(.        'ibm_
-0000ac30: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
-0000ac40: 6f64 6527 2c0a 2020 2020 2020 2020 5b0a  ode',.        [.
-0000ac50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000ac60: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000ac70: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6962  name} --cloud ib
-0000ac80: 6d20 2d2d 6770 7573 2076 3130 3020 2d2d  m --gpus v100 --
-0000ac90: 6e75 6d2d 6e6f 6465 7320 3227 2c0a 2020  num-nodes 2',.  
-0000aca0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000acb0: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000acc0: 6e61 6d65 7d2d 3120 2d64 207b 7461 736b  name}-1 -d {task
-0000acd0: 5f66 696c 657d 272c 0a20 2020 2020 2020  _file}',.       
-0000ace0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000acf0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000ad00: 2d32 202d 6420 7b74 6173 6b5f 6669 6c65  -2 -d {task_file
-0000ad10: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0000ad20: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000ad30: 2d63 207b 6e61 6d65 7d20 2d6e 207b 6e61  -c {name} -n {na
-0000ad40: 6d65 7d2d 3320 2d2d 6465 7461 6368 2d73  me}-3 --detach-s
-0000ad50: 6574 7570 202d 6420 7b74 6173 6b5f 6669  etup -d {task_fi
-0000ad60: 6c65 7d27 2c0a 2020 2020 2020 2020 2020  le}',.          
-0000ad70: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000ad80: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
-0000ad90: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
-0000ada0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000adb0: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-0000adc0: 4e4e 494e 4729 272c 0a20 2020 2020 2020  NNING)',.       
-0000add0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000ade0: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-0000adf0: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
-0000ae00: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000ae10: 207b 6e61 6d65 7d2d 3220 7c20 6772 6570   {name}-2 | grep
-0000ae20: 2052 554e 4e49 4e47 2927 2c0a 2020 2020   RUNNING)',.    
-0000ae30: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000ae40: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
-0000ae50: 2626 2070 7269 6e74 6620 2224 7322 2026  && printf "$s" &
-0000ae60: 2620 2865 6368 6f20 2224 7322 207c 2067  & (echo "$s" | g
-0000ae70: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
-0000ae80: 7265 7020 5345 5454 494e 475f 5550 2927  rep SETTING_UP)'
-0000ae90: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000aea0: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
-0000aeb0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000aec0: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
-0000aed0: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
-0000aee0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
-0000aef0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000af00: 7020 5045 4e44 494e 4729 272c 0a20 2020  p PENDING)',.   
-0000af10: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000af20: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000af30: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
-0000af40: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0000af50: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000af60: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000af70: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000af80: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000af90: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000afa0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3120  cel -y {name} 1 
-0000afb0: 3220 3327 2c0a 2020 2020 2020 2020 2020  2 3',.          
-0000afc0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000afd0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000afe0: 657d 2d34 202d 2d64 6574 6163 682d 7365  e}-4 --detach-se
-0000aff0: 7475 7020 2d64 207b 7461 736b 5f66 696c  tup -d {task_fil
-0000b000: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0000b010: 2023 2054 6573 7420 7468 6520 6a6f 6220   # Test the job 
-0000b020: 7374 6174 7573 2069 7320 636f 7272 6563  status is correc
-0000b030: 746c 7920 7365 7420 746f 2053 4554 5449  tly set to SETTI
-0000b040: 4e47 5f55 502c 2064 7572 696e 6720 7468  NG_UP, during th
-0000b050: 6520 7365 7475 7020 6973 2072 756e 6e69  e setup is runni
-0000b060: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-0000b070: 2320 616e 6420 7468 6520 6a6f 6220 6361  # and the job ca
-0000b080: 6e20 6265 2063 616e 6365 6c6c 6564 2064  n be cancelled d
-0000b090: 7572 696e 6720 7468 6520 7365 7475 702e  uring the setup.
-0000b0a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b0b0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000b0c0: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
-0000b0d0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-0000b0e0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000b0f0: 3420 7c20 6772 6570 2053 4554 5449 4e47  4 | grep SETTING
-0000b100: 5f55 5029 272c 0a20 2020 2020 2020 2020  _UP)',.         
-0000b110: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-0000b120: 2d79 207b 6e61 6d65 7d20 3427 2c0a 2020  -y {name} 4',.  
-0000b130: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000b140: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000b150: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
-0000b160: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-0000b170: 2067 7265 7020 7b6e 616d 657d 2d34 207c   grep {name}-4 |
-0000b180: 2067 7265 7020 4341 4e43 454c 4c45 4429   grep CANCELLED)
-0000b190: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000b1a0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000b1b0: 202d 2d67 7075 7320 7631 3030 3a30 2e32   --gpus v100:0.2
-0000b1c0: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-0000b1d0: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-0000b1e0: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-0000b1f0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0000b200: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000b210: 6e61 6d65 7d20 2d2d 6770 7573 2076 3130  name} --gpus v10
-0000b220: 303a 302e 3220 2d2d 6e75 6d2d 6e6f 6465  0:0.2 --num-node
-0000b230: 7320 3220 225b 5b20 5c24 534b 5950 494c  s 2 "[[ \$SKYPIL
-0000b240: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000b250: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000b260: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000b270: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000b280: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000b290: 7631 3030 3a31 202d 2d6e 756d 2d6e 6f64  v100:1 --num-nod
-0000b2a0: 6573 2032 2022 5b5b 205c 2453 4b59 5049  es 2 "[[ \$SKYPI
-0000b2b0: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000b2c0: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000b2d0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000b2e0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000b2f0: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
-0000b300: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0000b310: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000b320: 616d 657d 2036 202d 2d73 7461 7475 7327  ame} 6 --status'
-0000b330: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b340: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000b350: 3720 2d2d 7374 6174 7573 272c 0a20 2020  7 --status',.   
-0000b360: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000b370: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000b380: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0000b390: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
-0000b3a0: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
-0000b3b0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000b3c0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0000b3d0: 2d2d 2d2d 2d2d 2053 7562 6d69 7474 696e  ------ Submittin
-0000b3e0: 6720 6d75 6c74 6970 6c65 2074 6173 6b73  g multiple tasks
-0000b3f0: 2074 6f20 7468 6520 7361 6d65 2063 6c75   to the same clu
-0000b400: 7374 6572 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  ster. ----------
-0000b410: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000b420: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-0000b430: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-0000b440: 6573 206e 6f74 2068 6176 6520 4b38 3020  es not have K80 
-0000b450: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
-0000b460: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-0000b470: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
-0000b480: 6176 6520 4b38 3020 6770 7573 0a40 7079  ave K80 gpus.@py
-0000b490: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-0000b4a0: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-0000b4b0: 2073 7570 706f 7274 206e 756d 5f6e 6f64   support num_nod
-0000b4c0: 6573 203e 2031 2079 6574 0a40 7079 7465  es > 1 yet.@pyte
-0000b4d0: 7374 2e6d 6172 6b2e 6e6f 5f6f 6369 2020  st.mark.no_oci  
-0000b4e0: 2320 4f43 4920 436c 6f75 6420 646f 6573  # OCI Cloud does
-0000b4f0: 206e 6f74 2068 6176 6520 4b38 3020 6770   not have K80 gp
-0000b500: 7573 0a64 6566 2074 6573 745f 6d75 6c74  us.def test_mult
-0000b510: 695f 6563 686f 2867 656e 6572 6963 5f63  i_echo(generic_c
-0000b520: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-0000b530: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0000b540: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0000b550: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000b560: 2020 2020 276d 756c 7469 5f65 6368 6f27      'multi_echo'
-0000b570: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000b580: 2020 2020 2020 2020 6627 7079 7468 6f6e          f'python
-0000b590: 2065 7861 6d70 6c65 732f 6d75 6c74 695f   examples/multi_
-0000b5a0: 6563 686f 2e70 7920 7b6e 616d 657d 207b  echo.py {name} {
-0000b5b0: 6765 6e65 7269 635f 636c 6f75 647d 272c  generic_cloud}',
-0000b5c0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000b5d0: 6565 7020 3132 3027 2c0a 2020 2020 2020  eep 120',.      
-0000b5e0: 2020 5d20 2b0a 2020 2020 2020 2020 2320    ] +.        # 
-0000b5f0: 456e 7375 7265 206a 6f62 7320 7375 6363  Ensure jobs succ
-0000b600: 6565 6465 642e 0a20 2020 2020 2020 205b  eeded..        [
-0000b610: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000b620: 7d20 7b69 202b 2031 7d20 2d2d 7374 6174  } {i + 1} --stat
-0000b630: 7573 2720 666f 7220 6920 696e 2072 616e  us' for i in ran
-0000b640: 6765 2833 3229 5d20 2b0a 2020 2020 2020  ge(32)] +.      
-0000b650: 2020 2320 456e 7375 7265 206d 6f6e 6974    # Ensure monit
-0000b660: 6f72 2f61 7574 6f73 6361 6c65 7220 6469  or/autoscaler di
-0000b670: 646e 2774 2063 7261 7368 206f 6e20 7468  dn't crash on th
-0000b680: 6520 2761 7373 6572 7420 6e6f 740a 2020  e 'assert not.  
-0000b690: 2020 2020 2020 2320 756e 6675 6c66 696c        # unfulfil
-0000b6a0: 6c65 6427 2065 7272 6f72 2e20 2049 6620  led' error.  If 
-0000b6b0: 7072 6f63 6573 7320 6e6f 7420 666f 756e  process not foun
-0000b6c0: 642c 2067 7265 702d 3e73 7368 2072 6574  d, grep->ssh ret
-0000b6d0: 7572 6e73 2031 2e0a 2020 2020 2020 2020  urns 1..        
-0000b6e0: 5b66 2773 7368 207b 6e61 6d65 7d20 5c27  [f'ssh {name} \'
-0000b6f0: 7073 2061 7578 207c 2067 7265 7020 225b  ps aux | grep "[
-0000b700: 2f5d 226d 6f6e 6974 6f72 2e70 795c 2727  /]"monitor.py\''
-0000b710: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000b720: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000b730: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0000b740: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-0000b750: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000b760: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0000b770: 2d2d 2d2d 2d2d 2054 6173 6b3a 2031 206e  ------ Task: 1 n
-0000b780: 6f64 6520 7472 6169 6e69 6e67 2e20 2d2d  ode training. --
-0000b790: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0000b7a0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
-0000b7b0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
-0000b7c0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
-0000b7d0: 6176 6520 5631 3030 2067 7075 730a 4070  ave V100 gpus.@p
-0000b7e0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-0000b7f0: 6d20 2023 2049 424d 2063 6c6f 7564 2063  m  # IBM cloud c
-0000b800: 7572 7265 6e74 6c79 2064 6f65 736e 2774  urrently doesn't
-0000b810: 2070 726f 7669 6465 2070 7562 6c69 6320   provide public 
-0000b820: 696d 6167 6520 7769 7468 2043 5544 410a  image with CUDA.
-0000b830: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000b840: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-0000b850: 6e6f 7420 6861 7665 2056 3130 3020 2831  not have V100 (1
-0000b860: 3647 4229 2047 5055 732e 2052 756e 2074  6GB) GPUs. Run t
-0000b870: 6573 745f 7363 705f 6875 6767 696e 6766  est_scp_huggingf
-0000b880: 6163 6520 696e 7374 6561 642e 0a64 6566  ace instead..def
-0000b890: 2074 6573 745f 6875 6767 696e 6766 6163   test_huggingfac
-0000b8a0: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000b8b0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000b8c0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000b8d0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000b8e0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000b8f0: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
-0000b900: 5f69 6d64 625f 6170 7027 2c0a 2020 2020  _imdb_app',.    
-0000b910: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000b920: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000b930: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-0000b940: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000b950: 7564 7d20 6578 616d 706c 6573 2f68 7567  ud} examples/hug
-0000b960: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
-0000b970: 6462 5f61 7070 2e79 616d 6c27 2c0a 2020  db_app.yaml',.  
-0000b980: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000b990: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-0000b9a0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000b9b0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000b9c0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-0000b9d0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000b9e0: 6d65 7d20 6578 616d 706c 6573 2f68 7567  me} examples/hug
-0000b9f0: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
-0000ba00: 6462 5f61 7070 2e79 616d 6c27 2c0a 2020  db_app.yaml',.  
-0000ba10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ba20: 6c6f 6773 207b 6e61 6d65 7d20 3220 2d2d  logs {name} 2 --
-0000ba30: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000ba40: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000ba50: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-0000ba60: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000ba70: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000ba80: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000ba90: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000baa0: 7079 7465 7374 2e6d 6172 6b2e 6c61 6d62  pytest.mark.lamb
-0000bab0: 6461 5f63 6c6f 7564 0a64 6566 2074 6573  da_cloud.def tes
-0000bac0: 745f 6c61 6d62 6461 5f68 7567 6769 6e67  t_lambda_hugging
-0000bad0: 6661 6365 2867 656e 6572 6963 5f63 6c6f  face(generic_clo
-0000bae0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-0000baf0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000bb00: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000bb10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000bb20: 2020 276c 616d 6264 615f 6875 6767 696e    'lambda_huggin
-0000bb30: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
-0000bb40: 6170 7027 2c0a 2020 2020 2020 2020 5b0a  app',.        [.
-0000bb50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000bb60: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000bb70: 6e61 6d65 7d20 7b4c 414d 4244 415f 5459  name} {LAMBDA_TY
-0000bb80: 5045 7d20 6578 616d 706c 6573 2f68 7567  PE} examples/hug
-0000bb90: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
-0000bba0: 6462 5f61 7070 2e79 616d 6c27 2c0a 2020  db_app.yaml',.  
-0000bbb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000bbc0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-0000bbd0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000bbe0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000bbf0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-0000bc00: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000bc10: 6d65 7d20 7b4c 414d 4244 415f 5459 5045  me} {LAMBDA_TYPE
-0000bc20: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
-0000bc30: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
-0000bc40: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
-0000bc50: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000bc60: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-0000bc70: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-0000bc80: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-0000bc90: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
-0000bca0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0000bcb0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0000bcc0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0000bcd0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0000bce0: 7465 7374 2e6d 6172 6b2e 7363 700a 6465  test.mark.scp.de
-0000bcf0: 6620 7465 7374 5f73 6370 5f68 7567 6769  f test_scp_huggi
-0000bd00: 6e67 6661 6365 2867 656e 6572 6963 5f63  ngface(generic_c
-0000bd10: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-0000bd20: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0000bd30: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-0000bd40: 756d 5f6f 665f 6770 755f 6c61 756e 6368  um_of_gpu_launch
-0000bd50: 203d 2031 0a20 2020 2074 6573 7420 3d20   = 1.    test = 
-0000bd60: 5465 7374 280a 2020 2020 2020 2020 2753  Test(.        'S
-0000bd70: 4350 5f68 7567 6769 6e67 6661 6365 5f67  CP_huggingface_g
-0000bd80: 6c75 655f 696d 6462 5f61 7070 272c 0a20  lue_imdb_app',. 
-0000bd90: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000bda0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000bdb0: 6820 2d79 202d 6320 7b6e 616d 657d 207b  h -y -c {name} {
-0000bdc0: 5343 505f 5459 5045 7d20 7b53 4350 5f47  SCP_TYPE} {SCP_G
-0000bdd0: 5055 5f56 3130 307d 3a7b 6e75 6d5f 6f66  PU_V100}:{num_of
-0000bde0: 5f67 7075 5f6c 6175 6e63 687d 2065 7861  _gpu_launch} exa
-0000bdf0: 6d70 6c65 732f 6875 6767 696e 6766 6163  mples/huggingfac
-0000be00: 655f 676c 7565 5f69 6d64 625f 6170 702e  e_glue_imdb_app.
-0000be10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000be20: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000be30: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-0000be40: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000be50: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0000be60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000be70: 2065 7865 6320 7b6e 616d 657d 207b 5343   exec {name} {SC
-0000be80: 505f 5459 5045 7d20 7b53 4350 5f47 5055  P_TYPE} {SCP_GPU
-0000be90: 5f56 3130 307d 3a7b 6e75 6d5f 6f66 5f67  _V100}:{num_of_g
-0000bea0: 7075 5f6c 6175 6e63 687d 2065 7861 6d70  pu_launch} examp
-0000beb0: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
-0000bec0: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
-0000bed0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000bee0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000bef0: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
-0000bf00: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-0000bf10: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-0000bf20: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000bf30: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000bf40: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-0000bf50: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000bf60: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-0000bf70: 2d2d 2054 5055 2e20 2d2d 2d2d 2d2d 2d2d  -- TPU. --------
-0000bf80: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0000bf90: 6763 700a 6465 6620 7465 7374 5f74 7075  gcp.def test_tpu
-0000bfa0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0000bfb0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000bfc0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000bfd0: 7374 280a 2020 2020 2020 2020 2774 7075  st(.        'tpu
-0000bfe0: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
-0000bff0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c000: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000c010: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0000c020: 7470 752f 7470 755f 6170 702e 7961 6d6c  tpu/tpu_app.yaml
-0000c030: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c040: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000c050: 2031 272c 2020 2320 456e 7375 7265 2074   1',  # Ensure t
-0000c060: 6865 206a 6f62 2066 696e 6973 6865 642e  he job finished.
-0000c070: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c080: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0000c090: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000c0a0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000c0b0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000c0c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000c0d0: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
-0000c0e0: 7861 6d70 6c65 732f 7470 752f 7470 755f  xamples/tpu/tpu_
-0000c0f0: 6170 702e 7961 6d6c 207c 2067 7265 7020  app.yaml | grep 
-0000c100: 2254 5055 202e 2a20 616c 7265 6164 7920  "TPU .* already 
-0000c110: 6578 6973 7473 2227 2c20 2023 2045 6e73  exists"',  # Ens
-0000c120: 7572 6520 736b 7920 6c61 756e 6368 2077  ure sky launch w
-0000c130: 6f6e 2774 2063 7265 6174 6520 616e 6f74  on't create anot
-0000c140: 6865 7220 5450 552e 0a20 2020 2020 2020  her TPU..       
-0000c150: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000c160: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000c170: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
-0000c180: 7574 3d33 3020 2a20 3630 2c20 2023 2063  ut=30 * 60,  # c
-0000c190: 616e 2074 616b 6520 3e32 3020 6d69 6e73  an take >20 mins
-0000c1a0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0000c1b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000c1c0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055  # ---------- TPU
-0000c1d0: 2056 4d2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a   VM. ----------.
-0000c1e0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-0000c1f0: 0a64 6566 2074 6573 745f 7470 755f 766d  .def test_tpu_vm
-0000c200: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0000c210: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000c220: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000c230: 7374 280a 2020 2020 2020 2020 2774 7075  st(.        'tpu
-0000c240: 5f76 6d5f 6170 7027 2c0a 2020 2020 2020  _vm_app',.      
-0000c250: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000c260: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000c270: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
-0000c280: 6573 2f74 7075 2f74 7075 766d 5f6d 6e69  es/tpu/tpuvm_mni
-0000c290: 7374 2e79 616d 6c27 2c0a 2020 2020 2020  st.yaml',.      
-0000c2a0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000c2b0: 207b 6e61 6d65 7d20 3127 2c20 2023 2045   {name} 1',  # E
-0000c2c0: 6e73 7572 6520 7468 6520 6a6f 6220 6669  nsure the job fi
-0000c2d0: 6e69 7368 6564 2e0a 2020 2020 2020 2020  nished..        
-0000c2e0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000c2f0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0000c300: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000c310: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000c320: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c330: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
-0000c340: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c350: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
-0000c360: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
-0000c370: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000c380: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000c390: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
-0000c3a0: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
-0000c3b0: 4427 2c20 2023 2045 6e73 7572 6520 7468  D',  # Ensure th
-0000c3c0: 6520 636c 7573 7465 7220 6973 2053 544f  e cluster is STO
-0000c3d0: 5050 4544 2e0a 2020 2020 2020 2020 2020  PPED..          
-0000c3e0: 2020 2320 5573 6520 7265 7472 793a 2067    # Use retry: g
-0000c3f0: 7561 7264 2061 6761 696e 7374 2074 7261  uard against tra
-0000c400: 6e73 6965 6e74 2065 7272 6f72 7320 6f62  nsient errors ob
-0000c410: 7365 7276 6564 2066 6f72 0a20 2020 2020  served for.     
-0000c420: 2020 2020 2020 2023 206a 7573 742d 7374         # just-st
-0000c430: 6f70 7065 6420 5450 5520 564d 7320 2823  opped TPU VMs (#
-0000c440: 3936 3229 2e0a 2020 2020 2020 2020 2020  962)..          
-0000c450: 2020 6627 736b 7920 7374 6172 7420 2d2d    f'sky start --
-0000c460: 7265 7472 792d 756e 7469 6c2d 7570 202d  retry-until-up -
-0000c470: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000c480: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000c490: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000c4a0: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
-0000c4b0: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
-0000c4c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000c4d0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-0000c4e0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000c4f0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000c500: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000c510: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
-0000c520: 7d27 2c0a 2020 2020 2020 2020 5d2c 0a20  }',.        ],. 
-0000c530: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-0000c540: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-0000c550: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
-0000c560: 202a 2036 302c 2020 2320 6361 6e20 7461   * 60,  # can ta
-0000c570: 6b65 2033 3020 6d69 6e73 0a20 2020 2029  ke 30 mins.    )
-0000c580: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000c590: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0000c5a0: 2d2d 2d2d 2d2d 2054 5055 2056 4d20 506f  ------ TPU VM Po
-0000c5b0: 642e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  d. ----------.@p
-0000c5c0: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
-0000c5d0: 6566 2074 6573 745f 7470 755f 766d 5f70  ef test_tpu_vm_p
-0000c5e0: 6f64 2829 3a0a 2020 2020 6e61 6d65 203d  od():.    name =
-0000c5f0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000c600: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000c610: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-0000c620: 7075 5f70 6f64 272c 0a20 2020 2020 2020  pu_pod',.       
-0000c630: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000c640: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000c650: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000c660: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
-0000c670: 742e 7961 6d6c 202d 2d67 7075 7320 7470  t.yaml --gpus tp
-0000c680: 752d 7632 2d33 3220 2d2d 7573 652d 7370  u-v2-32 --use-sp
-0000c690: 6f74 202d 2d7a 6f6e 6520 6575 726f 7065  ot --zone europe
-0000c6a0: 2d77 6573 7434 2d61 272c 0a20 2020 2020  -west4-a',.     
-0000c6b0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000c6c0: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
-0000c6d0: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
-0000c6e0: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
-0000c6f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000c700: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0000c710: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000c720: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000c730: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0000c740: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000c750: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000c760: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-0000c770: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
-0000c780: 3330 206d 696e 730a 2020 2020 290a 2020  30 mins.    ).  
-0000c790: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000c7a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000c7b0: 2d2d 2d20 5369 6d70 6c65 2061 7070 732e  --- Simple apps.
-0000c7c0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-0000c7d0: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-0000c7e0: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-0000c7f0: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
-0000c800: 7320 3e20 3120 7965 740a 6465 6620 7465  s > 1 yet.def te
-0000c810: 7374 5f6d 756c 7469 5f68 6f73 746e 616d  st_multi_hostnam
-0000c820: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000c830: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000c840: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000c850: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000c860: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000c870: 6d75 6c74 695f 686f 7374 6e61 6d65 272c  multi_hostname',
-0000c880: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000c890: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000c8a0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000c8b0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000c8c0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
-0000c8d0: 732f 6d75 6c74 695f 686f 7374 6e61 6d65  s/multi_hostname
-0000c8e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000c8f0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000c900: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0000c910: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000c920: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000c930: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c940: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000c950: 7c20 6772 6570 2022 4d79 2068 6f73 746e  | grep "My hostn
-0000c960: 616d 653a 2220 7c20 7763 202d 6c20 7c20  ame:" | wc -l | 
-0000c970: 6772 6570 2032 272c 2020 2320 456e 7375  grep 2',  # Ensu
-0000c980: 7265 2074 6865 7265 2061 7265 2032 2068  re there are 2 h
-0000c990: 6f73 7473 2e0a 2020 2020 2020 2020 2020  osts..          
-0000c9a0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000c9b0: 6d65 7d20 6578 616d 706c 6573 2f6d 756c  me} examples/mul
-0000c9c0: 7469 5f68 6f73 746e 616d 652e 7961 6d6c  ti_hostname.yaml
-0000c9d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000c9e0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000c9f0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-0000ca00: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000ca10: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000ca20: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0000ca30: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0000ca40: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-0000ca50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000ca60: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0000ca70: 2054 6173 6b3a 206e 3d32 206e 6f64 6573   Task: n=2 nodes
-0000ca80: 2077 6974 6820 7365 7475 7073 2e20 2d2d   with setups. --
-0000ca90: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-0000caa0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
-0000cab0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
-0000cac0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
-0000cad0: 6176 6520 5631 3030 2067 7075 730a 4070  ave V100 gpus.@p
-0000cae0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-0000caf0: 6d20 2023 2049 424d 2063 6c6f 7564 2063  m  # IBM cloud c
-0000cb00: 7572 7265 6e74 6c79 2064 6f65 736e 2774  urrently doesn't
-0000cb10: 2070 726f 7669 6465 2070 7562 6c69 6320   provide public 
-0000cb20: 696d 6167 6520 7769 7468 2043 5544 410a  image with CUDA.
-0000cb30: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000cb40: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-0000cb50: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-0000cb60: 6e6f 6465 7320 3e20 3120 7965 740a 4070  nodes > 1 yet.@p
-0000cb70: 7974 6573 742e 6d61 726b 2e73 6b69 7028  ytest.mark.skip(
-0000cb80: 0a20 2020 2072 6561 736f 6e3d 0a20 2020  .    reason=.   
-0000cb90: 2027 5468 6520 7265 736e 6574 5f64 6973   'The resnet_dis
-0000cba0: 7472 6962 7574 6564 5f74 665f 6170 7020  tributed_tf_app 
-0000cbb0: 6973 2066 6c61 6b79 2c20 6475 6520 746f  is flaky, due to
-0000cbc0: 2069 7420 6661 696c 696e 6720 746f 2064   it failing to d
-0000cbd0: 6574 6563 7420 4750 5573 2e27 290a 6465  etect GPUs.').de
-0000cbe0: 6620 7465 7374 5f64 6973 7472 6962 7574  f test_distribut
-0000cbf0: 6564 5f74 6628 6765 6e65 7269 635f 636c  ed_tf(generic_cl
-0000cc00: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-0000cc10: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000cc20: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0000cc30: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000cc40: 2020 2027 7265 736e 6574 5f64 6973 7472     'resnet_distr
-0000cc50: 6962 7574 6564 5f74 665f 6170 7027 2c0a  ibuted_tf_app',.
-0000cc60: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000cc70: 2020 2020 2020 2320 4e4f 5445 3a20 7275        # NOTE: ru
-0000cc80: 6e6e 696e 6720 6974 2074 7769 6365 2077  nning it twice w
-0000cc90: 696c 6c20 6861 6e67 2028 736f 6d65 7469  ill hang (someti
-0000cca0: 6d65 733f 2920 2d20 616e 2061 7070 2d6c  mes?) - an app-l
-0000ccb0: 6576 656c 2062 7567 2e0a 2020 2020 2020  evel bug..      
-0000ccc0: 2020 2020 2020 6627 7079 7468 6f6e 2065        f'python e
-0000ccd0: 7861 6d70 6c65 732f 7265 736e 6574 5f64  xamples/resnet_d
-0000cce0: 6973 7472 6962 7574 6564 5f74 665f 6170  istributed_tf_ap
-0000ccf0: 702e 7079 207b 6e61 6d65 7d20 7b67 656e  p.py {name} {gen
-0000cd00: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
-0000cd10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000cd20: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-0000cd30: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000cd40: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000cd50: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
-0000cd60: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000cd70: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000cd80: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0000cd90: 3235 202a 2036 302c 2020 2320 3235 206d  25 * 60,  # 25 m
-0000cda0: 696e 7320 2869 7420 7461 6b65 7320 6172  ins (it takes ar
-0000cdb0: 6f75 6e64 207e 3139 206d 696e 7329 0a20  ound ~19 mins). 
-0000cdc0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000cdd0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0000cde0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-0000cdf0: 6e67 2047 4350 2073 7461 7274 2061 6e64  ng GCP start and
-0000ce00: 2073 746f 7020 696e 7374 616e 6365 7320   stop instances 
-0000ce10: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0000ce20: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
-0000ce30: 7465 7374 5f67 6370 5f73 7461 7274 5f73  test_gcp_start_s
-0000ce40: 746f 7028 293a 0a20 2020 206e 616d 6520  top():.    name 
-0000ce50: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000ce60: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000ce70: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000ce80: 6763 702d 7374 6172 742d 7374 6f70 272c  gcp-start-stop',
-0000ce90: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000cea0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000ceb0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000cec0: 2065 7861 6d70 6c65 732f 6763 705f 7374   examples/gcp_st
-0000ced0: 6172 745f 7374 6f70 2e79 616d 6c27 2c0a  art_stop.yaml',.
-0000cee0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000cef0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0000cf00: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000cf10: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000cf20: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000cf30: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000cf40: 6e61 6d65 7d20 6578 616d 706c 6573 2f67  name} examples/g
-0000cf50: 6370 5f73 7461 7274 5f73 746f 702e 7961  cp_start_stop.ya
-0000cf60: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000cf70: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000cf80: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
-0000cf90: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-0000cfa0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-0000cfb0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000cfc0: 7865 6320 7b6e 616d 657d 2022 7072 6c69  xec {name} "prli
-0000cfd0: 6d69 7420 2d6e 202d 2d70 6964 3d5c 2428  mit -n --pid=\$(
-0000cfe0: 7067 7265 7020 2d66 205c 2772 6179 6c65  pgrep -f \'rayle
-0000cff0: 742f 7261 796c 6574 202d 2d72 6179 6c65  t/raylet --rayle
-0000d000: 745f 736f 636b 6574 5f6e 616d 655c 2729  t_socket_name\')
-0000d010: 207c 2067 7265 7020 5c27 225c 2731 3034   | grep \'"\'104
-0000d020: 3835 3736 2031 3034 3835 3736 5c27 225c  8576 1048576\'"\
-0000d030: 2722 272c 2020 2320 456e 7375 7265 2074  '"',  # Ensure t
-0000d040: 6865 2072 6179 6c65 7420 7072 6f63 6573  he raylet proces
-0000d050: 7320 6861 7320 7468 6520 636f 7272 6563  s has the correc
-0000d060: 7420 6669 6c65 2064 6573 6372 6970 746f  t file descripto
-0000d070: 7220 6c69 6d69 742e 0a20 2020 2020 2020  r limit..       
-0000d080: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000d090: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
-0000d0a0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000d0b0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000d0c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d0d0: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
-0000d0e0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0000d0f0: 6627 736c 6565 7020 3230 272c 0a20 2020  f'sleep 20',.   
-0000d100: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000d110: 7461 7274 202d 7920 7b6e 616d 657d 202d  tart -y {name} -
-0000d120: 6920 3127 2c0a 2020 2020 2020 2020 2020  i 1',.          
-0000d130: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000d140: 6d65 7d20 6578 616d 706c 6573 2f67 6370  me} examples/gcp
-0000d150: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-0000d160: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d170: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000d180: 2034 202d 2d73 7461 7475 7327 2c20 2023   4 --status',  #
-0000d190: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000d1a0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000d1b0: 2020 2020 2020 2027 736c 6565 7020 3138         'sleep 18
-0000d1c0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000d1d0: 6627 736b 7920 7374 6174 7573 202d 7220  f'sky status -r 
-0000d1e0: 7b6e 616d 657d 207c 2067 7265 7020 2249  {name} | grep "I
-0000d1f0: 4e49 545c 7c53 544f 5050 4544 2227 2c0a  NIT\|STOPPED"',.
-0000d200: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000d210: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000d220: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-0000d230: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000d240: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0000d250: 2d2d 2d2d 2d20 5465 7374 696e 6720 417a  ----- Testing Az
-0000d260: 7572 6520 7374 6172 7420 616e 6420 7374  ure start and st
-0000d270: 6f70 2069 6e73 7461 6e63 6573 202d 2d2d  op instances ---
-0000d280: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-0000d290: 6d61 726b 2e61 7a75 7265 0a64 6566 2074  mark.azure.def t
-0000d2a0: 6573 745f 617a 7572 655f 7374 6172 745f  est_azure_start_
-0000d2b0: 7374 6f70 2829 3a0a 2020 2020 6e61 6d65  stop():.    name
-0000d2c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0000d2d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0000d2e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0000d2f0: 2761 7a75 7265 2d73 7461 7274 2d73 746f  'azure-start-sto
-0000d300: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
-0000d310: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000d320: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000d330: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
-0000d340: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
-0000d350: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000d360: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000d370: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
-0000d380: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
-0000d390: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000d3a0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000d3b0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-0000d3c0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-0000d3d0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000d3e0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000d3f0: 6563 207b 6e61 6d65 7d20 2270 726c 696d  ec {name} "prlim
-0000d400: 6974 202d 6e20 2d2d 7069 643d 5c24 2870  it -n --pid=\$(p
-0000d410: 6772 6570 202d 6620 5c27 7261 796c 6574  grep -f \'raylet
-0000d420: 2f72 6179 6c65 7420 2d2d 7261 796c 6574  /raylet --raylet
-0000d430: 5f73 6f63 6b65 745f 6e61 6d65 5c27 2920  _socket_name\') 
-0000d440: 7c20 6772 6570 205c 2722 5c27 3130 3438  | grep \'"\'1048
-0000d450: 3537 3620 3130 3438 3537 365c 2722 5c27  576 1048576\'"\'
-0000d460: 2227 2c20 2023 2045 6e73 7572 6520 7468  "',  # Ensure th
-0000d470: 6520 7261 796c 6574 2070 726f 6365 7373  e raylet process
-0000d480: 2068 6173 2074 6865 2063 6f72 7265 6374   has the correct
-0000d490: 2066 696c 6520 6465 7363 7269 7074 6f72   file descriptor
-0000d4a0: 206c 696d 6974 2e0a 2020 2020 2020 2020   limit..        
-0000d4b0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000d4c0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-0000d4d0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000d4e0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000d4f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000d500: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
-0000d510: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d520: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
-0000d530: 616d 657d 202d 6920 3127 2c0a 2020 2020  ame} -i 1',.    
-0000d540: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000d550: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
-0000d560: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
-0000d570: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
-0000d580: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000d590: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-0000d5a0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-0000d5b0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-0000d5c0: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
-0000d5d0: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
-0000d5e0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000d5f0: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
-0000d600: 657d 2920 2626 2065 6368 6f20 2473 2026  e}) && echo $s &
-0000d610: 2620 6563 686f 2024 7320 7c20 6772 6570  & echo $s | grep
-0000d620: 2022 494e 4954 5c7c 5354 4f50 5045 4422   "INIT\|STOPPED"
-0000d630: 270a 2020 2020 2020 2020 5d2c 0a20 2020  '.        ],.   
-0000d640: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000d650: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000d660: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
-0000d670: 2036 302c 2020 2320 3330 206d 696e 730a   60,  # 30 mins.
-0000d680: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000d690: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0000d6a0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-0000d6b0: 696e 6720 4175 746f 7374 6f70 7069 6e67  ing Autostopping
-0000d6c0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-0000d6d0: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-0000d6e0: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-0000d6f0: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-0000d700: 7420 7375 7070 6f72 7420 7374 6f70 7069  t support stoppi
-0000d710: 6e67 2069 6e73 7461 6e63 6573 0a40 7079  ng instances.@py
-0000d720: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-0000d730: 2020 2320 4649 5828 4942 4d29 2073 706f    # FIX(IBM) spo
-0000d740: 7261 6469 6361 6c6c 7920 6661 696c 732c  radically fails,
-0000d750: 2061 7320 7265 7374 6172 7465 6420 776f   as restarted wo
-0000d760: 726b 6572 7320 7374 6179 2075 6e69 6e69  rkers stay unini
-0000d770: 7469 616c 697a 6564 2069 6e64 6566 696e  tialized indefin
-0000d780: 6974 656c 790a 4070 7974 6573 742e 6d61  itely.@pytest.ma
-0000d790: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-0000d7a0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0000d7b0: 7420 6e75 6d5f 6e6f 6465 7320 3e20 3120  t num_nodes > 1 
-0000d7c0: 7965 740a 6465 6620 7465 7374 5f61 7574  yet.def test_aut
-0000d7d0: 6f73 746f 7028 6765 6e65 7269 635f 636c  ostop(generic_cl
-0000d7e0: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-0000d7f0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000d800: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0000d810: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0000d820: 2020 2027 6175 746f 7374 6f70 272c 0a20     'autostop',. 
-0000d830: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000d840: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000d850: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
-0000d860: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
-0000d870: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-0000d880: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
-0000d890: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-0000d8a0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000d8b0: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
-0000d8c0: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
-0000d8d0: 3127 2c0a 0a20 2020 2020 2020 2020 2020  1',..           
-0000d8e0: 2023 2045 6e73 7572 6520 6175 746f 7374   # Ensure autost
-0000d8f0: 6f70 2069 7320 7365 742e 0a20 2020 2020  op is set..     
-0000d900: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-0000d910: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
-0000d920: 7d20 7c20 6772 6570 2022 316d 2227 2c0a  } | grep "1m"',.
-0000d930: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-0000d940: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-0000d950: 7220 6973 206e 6f74 2073 746f 7070 6564  r is not stopped
-0000d960: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
-0000d970: 2020 2020 2773 6c65 6570 2034 3527 2c0a      'sleep 45',.
-0000d980: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000d990: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-0000d9a0: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-0000d9b0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000d9c0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000d9d0: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-0000d9e0: 7c20 6772 6570 2055 5027 2c0a 0a20 2020  | grep UP',..   
-0000d9f0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-0000da00: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-0000da10: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
-0000da20: 2020 2020 2020 2773 6c65 6570 2032 3530        'sleep 250
-0000da30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000da40: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
-0000da50: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
-0000da60: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000da70: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000da80: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
-0000da90: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
-0000daa0: 4427 2c0a 0a20 2020 2020 2020 2020 2020  D',..           
-0000dab0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-0000dac0: 7573 7465 7220 6973 2055 5020 616e 6420  uster is UP and 
-0000dad0: 7468 6520 6175 746f 7374 6f70 2073 6574  the autostop set
-0000dae0: 7469 6e67 2069 7320 7265 7365 7420 2827  ting is reset ('
-0000daf0: 2d27 292e 0a20 2020 2020 2020 2020 2020  -')..           
-0000db00: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-0000db10: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0000db20: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-0000db30: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
-0000db40: 7c20 6772 6570 202d 4520 2255 505c 732b  | grep -E "UP\s+
-0000db50: 2d22 272c 0a0a 2020 2020 2020 2020 2020  -"',..          
-0000db60: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000db70: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000db80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000db90: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
-0000dba0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-0000dbb0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-0000dbc0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000dbd0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-0000dbe0: 6174 7573 272c 0a0a 2020 2020 2020 2020  atus',..        
-0000dbf0: 2020 2020 2320 5465 7374 2072 6573 7461      # Test resta
-0000dc00: 7274 696e 6720 7468 6520 6964 6c65 6e65  rting the idlene
-0000dc10: 7373 2074 696d 6572 2076 6961 2063 616e  ss timer via can
-0000dc20: 6365 6c20 2b20 7265 7365 743a 0a20 2020  cel + reset:.   
-0000dc30: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-0000dc40: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-0000dc50: 7d20 2d69 2031 272c 2020 2320 4964 6c65  } -i 1',  # Idle
-0000dc60: 6e65 7373 2073 7461 7274 7320 636f 756e  ness starts coun
-0000dc70: 7469 6e67 2e0a 2020 2020 2020 2020 2020  ting..          
-0000dc80: 2020 2773 6c65 6570 2034 3527 2c20 2023    'sleep 45',  #
-0000dc90: 2041 6c6d 6f73 7420 7265 6163 6865 6420   Almost reached 
-0000dca0: 7468 6520 7468 7265 7368 6f6c 642e 0a20  the threshold.. 
-0000dcb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000dcc0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
-0000dcd0: 6d65 7d20 2d2d 6361 6e63 656c 272c 0a20  me} --cancel',. 
-0000dce0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000dcf0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
-0000dd00: 6d65 7d20 2d69 2031 272c 2020 2320 5368  me} -i 1',  # Sh
-0000dd10: 6f75 6c64 2072 6573 7461 7274 2074 6865  ould restart the
-0000dd20: 2074 696d 6572 2e0a 2020 2020 2020 2020   timer..        
-0000dd30: 2020 2020 2773 6c65 6570 2034 3527 2c0a      'sleep 45',.
-0000dd40: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000dd50: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-0000dd60: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-0000dd70: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000dd80: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000dd90: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-0000dda0: 2067 7265 7020 5550 272c 0a20 2020 2020   grep UP',.     
-0000ddb0: 2020 2020 2020 2027 736c 6565 7020 3235         'sleep 25
-0000ddc0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000ddd0: 6627 733d 2428 736b 7920 7374 6174 7573  f's=$(sky status
-0000dde0: 207b 6e61 6d65 7d20 2d2d 7265 6672 6573   {name} --refres
-0000ddf0: 6829 3b20 6563 686f 2022 2473 223b 2065  h); echo "$s"; e
-0000de00: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-0000de10: 2224 7322 2020 7c20 6772 6570 207b 6e61  "$s"  | grep {na
-0000de20: 6d65 7d20 7c20 6772 6570 2053 544f 5050  me} | grep STOPP
-0000de30: 4544 272c 0a0a 2020 2020 2020 2020 2020  ED',..          
-0000de40: 2020 2320 5465 7374 2072 6573 7461 7274    # Test restart
-0000de50: 696e 6720 7468 6520 6964 6c65 6e65 7373  ing the idleness
-0000de60: 2074 696d 6572 2076 6961 2065 7865 633a   timer via exec:
-0000de70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000de80: 6b79 2073 7461 7274 202d 7920 7b6e 616d  ky start -y {nam
-0000de90: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0000dea0: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
-0000deb0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-0000dec0: 6570 202d 4520 2255 505c 732b 2d22 272c  ep -E "UP\s+-"',
-0000ded0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000dee0: 6b79 2061 7574 6f73 746f 7020 2d79 207b  ky autostop -y {
-0000def0: 6e61 6d65 7d20 2d69 2031 272c 2020 2320  name} -i 1',  # 
-0000df00: 4964 6c65 6e65 7373 2073 7461 7274 7320  Idleness starts 
-0000df10: 636f 756e 7469 6e67 2e0a 2020 2020 2020  counting..      
-0000df20: 2020 2020 2020 2773 6c65 6570 2034 3527        'sleep 45'
-0000df30: 2c20 2023 2041 6c6d 6f73 7420 7265 6163  ,  # Almost reac
-0000df40: 6865 6420 7468 6520 7468 7265 7368 6f6c  hed the threshol
-0000df50: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-0000df60: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000df70: 2065 6368 6f20 6869 272c 2020 2320 5368   echo hi',  # Sh
-0000df80: 6f75 6c64 2072 6573 7461 7274 2074 6865  ould restart the
-0000df90: 2074 696d 6572 2e0a 2020 2020 2020 2020   timer..        
-0000dfa0: 2020 2020 2773 6c65 6570 2034 3527 2c0a      'sleep 45',.
-0000dfb0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000dfc0: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-0000dfd0: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-0000dfe0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000dff0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000e000: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-0000e010: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
-0000e020: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-0000e030: 3530 272c 0a20 2020 2020 2020 2020 2020  50',.           
-0000e040: 2066 2773 3d24 2873 6b79 2073 7461 7475   f's=$(sky statu
-0000e050: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
-0000e060: 7368 293b 2065 6368 6f20 2224 7322 3b20  sh); echo "$s"; 
-0000e070: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-0000e080: 2022 2473 2220 207c 2067 7265 7020 7b6e   "$s"  | grep {n
-0000e090: 616d 657d 207c 2067 7265 7020 5354 4f50  ame} | grep STOP
-0000e0a0: 5045 4427 2c0a 2020 2020 2020 2020 5d2c  PED',.        ],
-0000e0b0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000e0c0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000e0d0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0000e0e0: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-0000e0f0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000e100: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0000e110: 2d2d 2d2d 2054 6573 7469 6e67 2041 7574  ---- Testing Aut
-0000e120: 6f64 6f77 6e69 6e67 202d 2d2d 2d2d 2d2d  odowning -------
-0000e130: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-0000e140: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-0000e150: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0000e160: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
-0000e170: 742e 2052 756e 2074 6573 745f 7363 705f  t. Run test_scp_
-0000e180: 6175 746f 646f 776e 2069 6e73 7465 6164  autodown instead
-0000e190: 2e0a 6465 6620 7465 7374 5f61 7574 6f64  ..def test_autod
-0000e1a0: 6f77 6e28 6765 6e65 7269 635f 636c 6f75  own(generic_clou
-0000e1b0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-0000e1c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000e1d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0000e1e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000e1f0: 2027 6175 746f 646f 776e 272c 0a20 2020   'autodown',.   
-0000e200: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0000e210: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000e220: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
-0000e230: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2d2d  --num-nodes 2 --
-0000e240: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0000e250: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
-0000e260: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-0000e270: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000e280: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
-0000e290: 202d 7920 7b6e 616d 657d 202d 2d64 6f77   -y {name} --dow
-0000e2a0: 6e20 2d69 2031 272c 0a20 2020 2020 2020  n -i 1',.       
-0000e2b0: 2020 2020 2023 2045 6e73 7572 6520 6175       # Ensure au
-0000e2c0: 746f 7374 6f70 2069 7320 7365 742e 0a20  tostop is set.. 
-0000e2d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000e2e0: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
-0000e2f0: 6e61 6d65 7d20 7c20 6772 6570 2022 316d  name} | grep "1m
-0000e300: 2028 646f 776e 2922 272c 0a20 2020 2020   (down)"',.     
-0000e310: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-0000e320: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
-0000e330: 6f74 2074 6572 6d69 6e61 7465 6420 6561  ot terminated ea
-0000e340: 726c 792e 0a20 2020 2020 2020 2020 2020  rly..           
-0000e350: 2027 736c 6565 7020 3435 272c 0a20 2020   'sleep 45',.   
-0000e360: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-0000e370: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
-0000e380: 202d 2d72 6566 7265 7368 293b 2065 6368   --refresh); ech
-0000e390: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-0000e3a0: 686f 3b20 6563 686f 2022 2473 2220 207c  ho; echo "$s"  |
-0000e3b0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-0000e3c0: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
-0000e3d0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-0000e3e0: 6520 636c 7573 7465 7220 6973 2074 6572  e cluster is ter
-0000e3f0: 6d69 6e61 7465 642e 0a20 2020 2020 2020  minated..       
-0000e400: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
-0000e410: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000e420: 733d 2428 534b 5950 494c 4f54 5f44 4542  s=$(SKYPILOT_DEB
-0000e430: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
-0000e440: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
-0000e450: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-0000e460: 2620 7b7b 2065 6368 6f20 2224 7322 207c  & {{ echo "$s" |
-0000e470: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-0000e480: 7265 7020 2241 7574 6f64 6f77 6e65 6420  rep "Autodowned 
-0000e490: 636c 7573 7465 725c 7c74 6572 6d69 6e61  cluster\|termina
-0000e4a0: 7465 6420 6f6e 2074 6865 2063 6c6f 7564  ted on the cloud
-0000e4b0: 223b 207d 7d20 7c7c 207b 7b20 6563 686f  "; }} || {{ echo
-0000e4c0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000e4d0: 6d65 7d20 2626 2065 7869 7420 3120 7c7c  me} && exit 1 ||
-0000e4e0: 2065 7869 7420 303b 207d 7d27 2c0a 2020   exit 0; }}',.  
-0000e4f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000e500: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
-0000e510: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-0000e520: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-0000e530: 2d6e 756d 2d6e 6f64 6573 2032 202d 2d64  -num-nodes 2 --d
-0000e540: 6f77 6e20 7465 7374 732f 7465 7374 5f79  own tests/test_y
-0000e550: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-0000e560: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000e570: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-0000e580: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000e590: 7020 5550 272c 2020 2320 456e 7375 7265  p UP',  # Ensure
-0000e5a0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-0000e5b0: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
-0000e5c0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000e5d0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-0000e5e0: 6963 5f63 6c6f 7564 7d20 7465 7374 732f  ic_cloud} tests/
-0000e5f0: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
-0000e600: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
-0000e610: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-0000e620: 7573 207c 2067 7265 7020 7b6e 616d 657d  us | grep {name}
-0000e630: 207c 2067 7265 7020 2231 6d20 2864 6f77   | grep "1m (dow
-0000e640: 6e29 2227 2c0a 2020 2020 2020 2020 2020  n)"',.          
-0000e650: 2020 2773 6c65 6570 2032 3430 272c 0a20    'sleep 240',. 
-0000e660: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-0000e670: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
-0000e680: 6973 2074 6572 6d69 6e61 7465 642e 0a20  is terminated.. 
-0000e690: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000e6a0: 2853 4b59 5049 4c4f 545f 4445 4255 473d  (SKYPILOT_DEBUG=
-0000e6b0: 3020 736b 7920 7374 6174 7573 207b 6e61  0 sky status {na
-0000e6c0: 6d65 7d20 2d2d 7265 6672 6573 6829 2026  me} --refresh) &
-0000e6d0: 2620 6563 686f 2022 2473 2220 2626 207b  & echo "$s" && {
-0000e6e0: 7b20 6563 686f 2022 2473 2220 7c20 6772  { echo "$s" | gr
-0000e6f0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-0000e700: 2022 4175 746f 646f 776e 6564 2063 6c75   "Autodowned clu
-0000e710: 7374 6572 5c7c 7465 726d 696e 6174 6564  ster\|terminated
-0000e720: 206f 6e20 7468 6520 636c 6f75 6422 3b20   on the cloud"; 
-0000e730: 7d7d 207c 7c20 7b7b 2065 6368 6f20 2224  }} || {{ echo "$
-0000e740: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000e750: 2026 2620 6578 6974 2031 207c 7c20 6578   && exit 1 || ex
-0000e760: 6974 2030 3b20 7d7d 272c 0a20 2020 2020  it 0; }}',.     
-0000e770: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000e780: 6e63 6820 2d79 202d 6420 2d63 207b 6e61  nch -y -d -c {na
-0000e790: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-0000e7a0: 6572 6963 5f63 6c6f 7564 7d20 2d2d 6e75  eric_cloud} --nu
-0000e7b0: 6d2d 6e6f 6465 7320 3220 2d2d 646f 776e  m-nodes 2 --down
-0000e7c0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-0000e7d0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-0000e7e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000e7f0: 6b79 2061 7574 6f73 746f 7020 2d79 207b  ky autostop -y {
-0000e800: 6e61 6d65 7d20 2d2d 6361 6e63 656c 272c  name} --cancel',
-0000e810: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000e820: 6565 7020 3234 3027 2c0a 2020 2020 2020  eep 240',.      
-0000e830: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-0000e840: 6865 2063 6c75 7374 6572 2069 7320 7374  he cluster is st
-0000e850: 696c 6c20 5550 2e0a 2020 2020 2020 2020  ill UP..        
-0000e860: 2020 2020 6627 733d 2428 534b 5950 494c      f's=$(SKYPIL
-0000e870: 4f54 5f44 4542 5547 3d30 2073 6b79 2073  OT_DEBUG=0 sky s
-0000e880: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
-0000e890: 6566 7265 7368 2920 2626 2065 6368 6f20  efresh) && echo 
-0000e8a0: 2224 7322 2026 2620 6563 686f 2022 2473  "$s" && echo "$s
-0000e8b0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-0000e8c0: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
-0000e8d0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000e8e0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000e8f0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-0000e900: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-0000e910: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000e920: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000e930: 7974 6573 742e 6d61 726b 2e73 6370 0a64  ytest.mark.scp.d
-0000e940: 6566 2074 6573 745f 7363 705f 6175 746f  ef test_scp_auto
-0000e950: 646f 776e 2829 3a0a 2020 2020 6e61 6d65  down():.    name
-0000e960: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0000e970: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0000e980: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0000e990: 2753 4350 5f61 7574 6f64 6f77 6e27 2c0a  'SCP_autodown',.
-0000e9a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000e9b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000e9c0: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-0000e9d0: 657d 207b 5343 505f 5459 5045 7d20 7465  e} {SCP_TYPE} te
-0000e9e0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-0000e9f0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-0000ea00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ea10: 6175 746f 7374 6f70 202d 7920 7b6e 616d  autostop -y {nam
-0000ea20: 657d 202d 2d64 6f77 6e20 2d69 2031 272c  e} --down -i 1',
-0000ea30: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-0000ea40: 6e73 7572 6520 6175 746f 7374 6f70 2069  nsure autostop i
-0000ea50: 7320 7365 742e 0a20 2020 2020 2020 2020  s set..         
-0000ea60: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-0000ea70: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0000ea80: 6772 6570 2022 316d 2028 646f 776e 2922  grep "1m (down)"
-0000ea90: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0000eaa0: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-0000eab0: 7465 7220 6973 206e 6f74 2074 6572 6d69  ter is not termi
-0000eac0: 6e61 7465 6420 6561 726c 792e 0a20 2020  nated early..   
-0000ead0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000eae0: 3435 272c 0a20 2020 2020 2020 2020 2020  45',.           
-0000eaf0: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-0000eb00: 7265 6672 6573 6820 7c20 6772 6570 207b  refresh | grep {
-0000eb10: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
-0000eb20: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0000eb30: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-0000eb40: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
-0000eb50: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-0000eb60: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
-0000eb70: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-0000eb80: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-0000eb90: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
-0000eba0: 7368 2920 2626 2070 7269 6e74 6620 2224  sh) && printf "$
-0000ebb0: 7322 2026 2620 7b7b 2065 6368 6f20 2224  s" && {{ echo "$
-0000ebc0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000ebd0: 207c 2067 7265 7020 2241 7574 6f64 6f77   | grep "Autodow
-0000ebe0: 6e65 6420 636c 7573 7465 725c 7c74 6572  ned cluster\|ter
-0000ebf0: 6d69 6e61 7465 6420 6f6e 2074 6865 2063  minated on the c
-0000ec00: 6c6f 7564 223b 207d 7d20 7c7c 207b 7b20  loud"; }} || {{ 
-0000ec10: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000ec20: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
-0000ec30: 3120 7c7c 2065 7869 7420 303b 207d 7d27  1 || exit 0; }}'
-0000ec40: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000ec50: 736b 7920 6c61 756e 6368 202d 7920 2d64  sky launch -y -d
-0000ec60: 202d 6320 7b6e 616d 657d 207b 5343 505f   -c {name} {SCP_
-0000ec70: 5459 5045 7d20 2d2d 646f 776e 2074 6573  TYPE} --down tes
-0000ec80: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-0000ec90: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-0000eca0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000ecb0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-0000ecc0: 6d65 7d20 7c20 6772 6570 2055 5027 2c20  me} | grep UP', 
-0000ecd0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-0000ece0: 7573 7465 7220 6973 2055 502e 0a20 2020  uster is UP..   
-0000ecf0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000ed00: 7865 6320 7b6e 616d 657d 207b 5343 505f  xec {name} {SCP_
-0000ed10: 5459 5045 7d20 7465 7374 732f 7465 7374  TYPE} tests/test
-0000ed20: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-0000ed30: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000ed40: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-0000ed50: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-0000ed60: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
-0000ed70: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000ed80: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
-0000ed90: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-0000eda0: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
-0000edb0: 6572 6d69 6e61 7465 642e 0a20 2020 2020  erminated..     
-0000edc0: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-0000edd0: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-0000ede0: 7920 7374 6174 7573 202d 2d72 6566 7265  y status --refre
-0000edf0: 7368 2920 2626 2070 7269 6e74 6620 2224  sh) && printf "$
-0000ee00: 7322 2026 2620 7b7b 2065 6368 6f20 2224  s" && {{ echo "$
-0000ee10: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000ee20: 207c 2067 7265 7020 2241 7574 6f64 6f77   | grep "Autodow
-0000ee30: 6e65 6420 636c 7573 7465 725c 7c74 6572  ned cluster\|ter
-0000ee40: 6d69 6e61 7465 6420 6f6e 2074 6865 2063  minated on the c
-0000ee50: 6c6f 7564 223b 207d 7d20 7c7c 207b 7b20  loud"; }} || {{ 
-0000ee60: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000ee70: 207b 6e61 6d65 7d20 2626 2065 7869 7420   {name} && exit 
-0000ee80: 3120 7c7c 2065 7869 7420 303b 207d 7d27  1 || exit 0; }}'
-0000ee90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000eea0: 736b 7920 6c61 756e 6368 202d 7920 2d64  sky launch -y -d
-0000eeb0: 202d 6320 7b6e 616d 657d 207b 5343 505f   -c {name} {SCP_
-0000eec0: 5459 5045 7d20 2d2d 646f 776e 2074 6573  TYPE} --down tes
-0000eed0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-0000eee0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-0000eef0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-0000ef00: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-0000ef10: 7d20 2d2d 6361 6e63 656c 272c 0a20 2020  } --cancel',.   
-0000ef20: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000ef30: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-0000ef40: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-0000ef50: 6c75 7374 6572 2069 7320 7374 696c 6c20  luster is still 
-0000ef60: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
-0000ef70: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
-0000ef80: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
-0000ef90: 7320 2d2d 7265 6672 6573 6829 2026 2620  s --refresh) && 
-0000efa0: 7072 696e 7466 2022 2473 2220 2626 2065  printf "$s" && e
-0000efb0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000efc0: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-0000efd0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0000efe0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000eff0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000f000: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-0000f010: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0000f020: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000f030: 7429 0a0a 0a64 6566 205f 6765 745f 6361  t)...def _get_ca
-0000f040: 6e63 656c 5f74 6173 6b5f 7769 7468 5f63  ncel_task_with_c
-0000f050: 6c6f 7564 286e 616d 652c 2063 6c6f 7564  loud(name, cloud
-0000f060: 2c20 7469 6d65 6f75 743d 3135 202a 2036  , timeout=15 * 6
-0000f070: 3029 3a0a 2020 2020 7465 7374 203d 2054  0):.    test = T
-0000f080: 6573 7428 0a20 2020 2020 2020 2066 277b  est(.        f'{
-0000f090: 636c 6f75 647d 2d63 616e 6365 6c2d 7461  cloud}-cancel-ta
-0000f0a0: 736b 272c 0a20 2020 2020 2020 205b 0a20  sk',.        [. 
-0000f0b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000f0c0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-0000f0d0: 7d20 6578 616d 706c 6573 2f72 6573 6e65  } examples/resne
-0000f0e0: 745f 6170 702e 7961 6d6c 202d 2d63 6c6f  t_app.yaml --clo
-0000f0f0: 7564 207b 636c 6f75 647d 202d 7920 2d64  ud {cloud} -y -d
-0000f100: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-0000f110: 2057 6169 7420 7468 6520 4750 5520 7072   Wait the GPU pr
-0000f120: 6f63 6573 7320 746f 2073 7461 7274 2e0a  ocess to start..
-0000f130: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000f140: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-0000f150: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000f160: 6e61 6d65 7d20 226e 7669 6469 612d 736d  name} "nvidia-sm
-0000f170: 6920 7c20 6772 6570 2070 7974 686f 6e22  i | grep python"
-0000f180: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000f190: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000f1a0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-0000f1b0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0000f1c0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0000f1d0: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000f1e0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3127  cel -y {name} 1'
-0000f1f0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000f200: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
-0000f210: 2020 2020 2020 2320 6368 6563 6b20 6966        # check if
-0000f220: 2074 6865 2070 7974 686f 6e20 6a6f 6220   the python job 
-0000f230: 6973 2067 6f6e 652e 0a20 2020 2020 2020  is gone..       
-0000f240: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000f250: 7b6e 616d 657d 2022 2120 6e76 6964 6961  {name} "! nvidia
-0000f260: 2d73 6d69 207c 2067 7265 7020 7079 7468  -smi | grep pyth
-0000f270: 6f6e 2227 2c0a 2020 2020 2020 2020 2020  on"',.          
-0000f280: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000f290: 6d65 7d20 3320 2d2d 7374 6174 7573 272c  me} 3 --status',
-0000f2a0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000f2b0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000f2c0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000f2d0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000f2e0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0000f2f0: 7469 6d65 6f75 743d 7469 6d65 6f75 742c  timeout=timeout,
-0000f300: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
-0000f310: 6e20 7465 7374 0a0a 0a23 202d 2d2d 2d2d  n test...# -----
-0000f320: 2d2d 2d2d 2d20 5465 7374 696e 6720 6073  ----- Testing `s
-0000f330: 6b79 2063 616e 6365 6c60 202d 2d2d 2d2d  ky cancel` -----
-0000f340: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000f350: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
-0000f360: 6172 6b2e 736b 6970 280a 2020 2020 7265  ark.skip(.    re
-0000f370: 6173 6f6e 3d27 5468 6520 7265 736e 6574  ason='The resnet
-0000f380: 5f61 7070 2069 7320 666c 616b 792c 2064  _app is flaky, d
-0000f390: 7565 2074 6f20 5446 2066 6169 6c69 6e67  ue to TF failing
-0000f3a0: 2074 6f20 6465 7465 6374 2047 5055 732e   to detect GPUs.
-0000f3b0: 2729 0a64 6566 2074 6573 745f 6361 6e63  ').def test_canc
-0000f3c0: 656c 5f61 7773 2829 3a0a 2020 2020 6e61  el_aws():.    na
-0000f3d0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000f3e0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000f3f0: 7420 3d20 5f67 6574 5f63 616e 6365 6c5f  t = _get_cancel_
-0000f400: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
-0000f410: 6e61 6d65 2c20 2761 7773 2729 0a20 2020  name, 'aws').   
-0000f420: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000f430: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0000f440: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-0000f450: 6172 6b2e 736b 6970 280a 2020 2020 7265  ark.skip(.    re
-0000f460: 6173 6f6e 3d27 5468 6520 7265 736e 6574  ason='The resnet
-0000f470: 5f61 7070 2069 7320 666c 616b 792c 2064  _app is flaky, d
-0000f480: 7565 2074 6f20 5446 2066 6169 6c69 6e67  ue to TF failing
-0000f490: 2074 6f20 6465 7465 6374 2047 5055 732e   to detect GPUs.
-0000f4a0: 2729 0a64 6566 2074 6573 745f 6361 6e63  ').def test_canc
-0000f4b0: 656c 5f67 6370 2829 3a0a 2020 2020 6e61  el_gcp():.    na
-0000f4c0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000f4d0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000f4e0: 7420 3d20 5f67 6574 5f63 616e 6365 6c5f  t = _get_cancel_
-0000f4f0: 7461 736b 5f77 6974 685f 636c 6f75 6428  task_with_cloud(
-0000f500: 6e61 6d65 2c20 2767 6370 2729 0a20 2020  name, 'gcp').   
-0000f510: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000f520: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0000f530: 726b 2e61 7a75 7265 0a40 7079 7465 7374  rk.azure.@pytest
-0000f540: 2e6d 6172 6b2e 736b 6970 280a 2020 2020  .mark.skip(.    
-0000f550: 7265 6173 6f6e 3d27 5468 6520 7265 736e  reason='The resn
-0000f560: 6574 5f61 7070 2069 7320 666c 616b 792c  et_app is flaky,
-0000f570: 2064 7565 2074 6f20 5446 2066 6169 6c69   due to TF faili
-0000f580: 6e67 2074 6f20 6465 7465 6374 2047 5055  ng to detect GPU
-0000f590: 732e 2729 0a64 6566 2074 6573 745f 6361  s.').def test_ca
-0000f5a0: 6e63 656c 5f61 7a75 7265 2829 3a0a 2020  ncel_azure():.  
-0000f5b0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000f5c0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000f5d0: 2074 6573 7420 3d20 5f67 6574 5f63 616e   test = _get_can
-0000f5e0: 6365 6c5f 7461 736b 5f77 6974 685f 636c  cel_task_with_cl
-0000f5f0: 6f75 6428 6e61 6d65 2c20 2761 7a75 7265  oud(name, 'azure
-0000f600: 272c 2074 696d 656f 7574 3d33 3020 2a20  ', timeout=30 * 
-0000f610: 3630 290a 2020 2020 7275 6e5f 6f6e 655f  60).    run_one_
-0000f620: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-0000f630: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-0000f640: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-0000f650: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-0000f660: 6f74 2068 6176 6520 5631 3030 2067 7075  ot have V100 gpu
-0000f670: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-0000f680: 6f5f 6962 6d20 2023 2049 424d 2063 6c6f  o_ibm  # IBM clo
-0000f690: 7564 2063 7572 7265 6e74 6c79 2064 6f65  ud currently doe
-0000f6a0: 736e 2774 2070 726f 7669 6465 2070 7562  sn't provide pub
-0000f6b0: 6c69 6320 696d 6167 6520 7769 7468 2043  lic image with C
-0000f6c0: 5544 410a 4070 7974 6573 742e 6d61 726b  UDA.@pytest.mark
-0000f6d0: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-0000f6e0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0000f6f0: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
-0000f700: 740a 6465 6620 7465 7374 5f63 616e 6365  t.def test_cance
-0000f710: 6c5f 7079 746f 7263 6828 6765 6e65 7269  l_pytorch(generi
-0000f720: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000f730: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000f740: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000f750: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000f760: 2020 2020 2020 2027 6361 6e63 656c 2d70         'cancel-p
-0000f770: 7974 6f72 6368 272c 0a20 2020 2020 2020  ytorch',.       
-0000f780: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000f790: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-0000f7a0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-0000f7b0: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
-0000f7c0: 616d 706c 6573 2f72 6573 6e65 745f 6469  amples/resnet_di
-0000f7d0: 7374 7269 6275 7465 645f 746f 7263 682e  stributed_torch.
-0000f7e0: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
-0000f7f0: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-0000f800: 7468 6520 4750 5520 7072 6f63 6573 7320  the GPU process 
-0000f810: 746f 2073 7461 7274 2e0a 2020 2020 2020  to start..      
-0000f820: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
-0000f830: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000f840: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000f850: 226e 7669 6469 612d 736d 6920 7c20 6772  "nvidia-smi | gr
-0000f860: 6570 2070 7974 686f 6e22 272c 0a20 2020  ep python"',.   
-0000f870: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000f880: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-0000f890: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000f8a0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000f8b0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000f8c0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000f8d0: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
-0000f8e0: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
-0000f8f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000f900: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000f910: 7d20 2228 6e76 6964 6961 2d73 6d69 207c  } "(nvidia-smi |
-0000f920: 2067 7265 7020 5c27 4e6f 2072 756e 6e69   grep \'No runni
-0000f930: 6e67 2070 726f 6365 7373 5c27 2920 7c7c  ng process\') ||
-0000f940: 2027 0a20 2020 2020 2020 2020 2020 2023   '.            #
-0000f950: 2045 6e73 7572 6520 586f 7267 2069 7320   Ensure Xorg is 
-0000f960: 7468 6520 6f6e 6c79 2070 726f 6365 7373  the only process
-0000f970: 2072 756e 6e69 6e67 2e0a 2020 2020 2020   running..      
-0000f980: 2020 2020 2020 275b 205c 2428 6e76 6964        '[ \$(nvid
-0000f990: 6961 2d73 6d69 207c 2067 7265 7020 2d41  ia-smi | grep -A
-0000f9a0: 2031 3020 5072 6f63 6573 7365 7320 7c20   10 Processes | 
-0000f9b0: 6772 6570 202d 4120 3130 203d 3d3d 207c  grep -A 10 === |
-0000f9c0: 2067 7265 7020 2d76 2058 6f72 6729 202d   grep -v Xorg) -
-0000f9d0: 6571 2032 205d 2227 2c0a 2020 2020 2020  eq 2 ]"',.      
-0000f9e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000f9f0: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
-0000fa00: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0000fa10: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0000fa20: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
-0000fa30: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000fa40: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000fa50: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-0000fa60: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-0000fa70: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000fa80: 290a 0a0a 2320 6361 6e27 7420 7573 6520  )...# can't use 
-0000fa90: 605f 6765 745f 6361 6e63 656c 5f74 6173  `_get_cancel_tas
-0000faa0: 6b5f 7769 7468 5f63 6c6f 7564 2829 602c  k_with_cloud()`,
-0000fab0: 2061 7320 636f 6d6d 616e 6420 606e 7669   as command `nvi
-0000fac0: 6469 612d 736d 6960 0a23 2072 6571 7569  dia-smi`.# requi
-0000fad0: 7265 7320 6120 4355 4441 2070 7562 6c69  res a CUDA publi
-0000fae0: 6320 696d 6167 652c 2077 6869 6368 2049  c image, which I
-0000faf0: 424d 2064 6f65 736e 2774 206f 6666 6572  BM doesn't offer
-0000fb00: 0a40 7079 7465 7374 2e6d 6172 6b2e 6962  .@pytest.mark.ib
-0000fb10: 6d0a 6465 6620 7465 7374 5f63 616e 6365  m.def test_cance
-0000fb20: 6c5f 6962 6d28 293a 0a20 2020 206e 616d  l_ibm():.    nam
-0000fb30: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000fb40: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0000fb50: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000fb60: 2027 6962 6d2d 6361 6e63 656c 2d74 6173   'ibm-cancel-tas
-0000fb70: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
-0000fb80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000fb90: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0000fba0: 6d65 7d20 2d2d 636c 6f75 6420 6962 6d20  me} --cloud ibm 
-0000fbb0: 6578 616d 706c 6573 2f6d 696e 696d 616c  examples/minimal
-0000fbc0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000fbd0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000fbe0: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
-0000fbf0: 3120 2d64 2020 2277 6869 6c65 2074 7275  1 -d  "while tru
-0000fc00: 653b 2064 6f20 6563 686f 205c 2748 656c  e; do echo \'Hel
-0000fc10: 6c6f 2053 6b79 5069 6c6f 745c 273b 2073  lo SkyPilot\'; s
-0000fc20: 6c65 6570 2032 3b20 646f 6e65 2227 2c0a  leep 2; done"',.
-0000fc30: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000fc40: 6570 2032 3027 2c0a 2020 2020 2020 2020  ep 20',.        
-0000fc50: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-0000fc60: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-0000fc70: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-0000fc80: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-0000fc90: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-0000fca0: 202d 7920 7b6e 616d 657d 2032 272c 0a20   -y {name} 2',. 
-0000fcb0: 2020 2020 2020 2020 2020 2066 2773 6c65             f'sle
-0000fcc0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0000fcd0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
-0000fce0: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
-0000fcf0: 6d65 7d2d 3120 7c20 6772 6570 2043 414e  me}-1 | grep CAN
-0000fd00: 4345 4c4c 4544 272c 0a20 2020 2020 2020  CELLED',.       
-0000fd10: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000fd20: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000fd30: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-0000fd40: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000fd50: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-0000fd60: 6573 7469 6e67 2075 7365 2d73 706f 7420  esting use-spot 
-0000fd70: 6f70 7469 6f6e 202d 2d2d 2d2d 2d2d 2d2d  option ---------
-0000fd80: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-0000fd90: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-0000fda0: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-0000fdb0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0000fdc0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-0000fdd0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
-0000fde0: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
-0000fdf0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0000fe00: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0000fe10: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000fe20: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-0000fe30: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0000fe40: 2069 6e73 7461 6e63 6573 0a64 6566 2074   instances.def t
-0000fe50: 6573 745f 7573 655f 7370 6f74 2867 656e  est_use_spot(gen
-0000fe60: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-0000fe70: 3a0a 2020 2020 2222 2254 6573 7420 7573  :.    """Test us
-0000fe80: 652d 7370 6f74 2061 6e64 2073 6b79 2065  e-spot and sky e
-0000fe90: 7865 632e 2222 220a 2020 2020 6e61 6d65  xec.""".    name
-0000fea0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-0000feb0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-0000fec0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0000fed0: 2775 7365 2d73 706f 7427 2c0a 2020 2020  'use-spot',.    
-0000fee0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000fef0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000ff00: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-0000ff10: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-0000ff20: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-0000ff30: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 202d  s/minimal.yaml -
-0000ff40: 2d75 7365 2d73 706f 7420 2d79 272c 0a20  -use-spot -y',. 
-0000ff50: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000ff60: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-0000ff70: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-0000ff80: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000ff90: 207b 6e61 6d65 7d20 6563 686f 2068 6927   {name} echo hi'
-0000ffa0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000ffb0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000ffc0: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-0000ffd0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000ffe0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000fff0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00010000: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00010010: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00010020: 2d2d 2054 6573 7469 6e67 206d 616e 6167  -- Testing manag
-00010030: 6564 2073 706f 7420 2d2d 2d2d 2d2d 2d2d  ed spot --------
-00010040: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00010050: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-00010060: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-00010070: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00010080: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00010090: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000100a0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-000100b0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-000100c0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-000100d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000100e0: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-000100f0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00010100: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00010110: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-00010120: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-00010130: 706f 7428 6765 6e65 7269 635f 636c 6f75  pot(generic_clou
-00010140: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00010150: 5465 7374 2074 6865 2073 706f 7420 7961  Test the spot ya
-00010160: 6d6c 2e22 2222 0a20 2020 206e 616d 6520  ml.""".    name 
-00010170: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00010180: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00010190: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000101a0: 6d61 6e61 6765 642d 7370 6f74 272c 0a20  managed-spot',. 
-000101b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000101c0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-000101d0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-000101e0: 2d31 202d 2d63 6c6f 7564 207b 6765 6e65  -1 --cloud {gene
-000101f0: 7269 635f 636c 6f75 647d 2065 7861 6d70  ric_cloud} examp
-00010200: 6c65 732f 6d61 6e61 6765 645f 7370 6f74  les/managed_spot
-00010210: 2e79 616d 6c20 2d79 202d 6427 2c0a 2020  .yaml -y -d',.  
-00010220: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00010230: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-00010240: 6e61 6d65 7d2d 3220 2d2d 636c 6f75 6420  name}-2 --cloud 
-00010250: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00010260: 6578 616d 706c 6573 2f6d 616e 6167 6564  examples/managed
-00010270: 5f73 706f 742e 7961 6d6c 202d 7920 2d64  _spot.yaml -y -d
-00010280: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00010290: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-000102a0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-000102b0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-000102c0: 207b 6e61 6d65 7d2d 3120 7c20 6865 6164   {name}-1 | head
-000102d0: 202d 6e31 207c 2067 7265 7020 2253 5441   -n1 | grep "STA
-000102e0: 5254 494e 475c 7c52 554e 4e49 4e47 2227  RTING\|RUNNING"'
-000102f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010300: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00010310: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-00010320: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
-00010330: 7265 7020 2253 5441 5254 494e 475c 7c52  rep "STARTING\|R
-00010340: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00010350: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
-00010360: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-00010370: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
-00010380: 2d31 2729 2c0a 2020 2020 2020 2020 2020  -1'),.          
-00010390: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
-000103a0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-000103b0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-000103c0: 7265 7020 7b6e 616d 657d 2d31 207c 2068  rep {name}-1 | h
-000103d0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-000103e0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-000103f0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00010400: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
-00010410: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010420: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00010430: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-00010440: 3120 7c20 6865 6164 202d 6e31 207c 2067  1 | head -n1 | g
-00010450: 7265 7020 4341 4e43 454c 4c45 4427 2c0a  rep CANCELLED',.
-00010460: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00010470: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00010480: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-00010490: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-000104a0: 7020 2252 554e 4e49 4e47 5c7c 5355 4343  p "RUNNING\|SUCC
-000104b0: 4545 4445 4422 272c 0a20 2020 2020 2020  EEDED"',.       
-000104c0: 205d 2c0a 2020 2020 2020 2020 2320 544f   ],.        # TO
-000104d0: 444f 287a 6877 7529 3a20 4368 616e 6765  DO(zhwu): Change
-000104e0: 2074 6f20 5f53 504f 545f 4341 4e43 454c   to _SPOT_CANCEL
-000104f0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00010500: 5f6e 616d 653d 6627 7b6e 616d 657d 2d31  _name=f'{name}-1
-00010510: 202d 6e20 7b6e 616d 657d 2d32 2729 2077   -n {name}-2') w
-00010520: 6865 6e0a 2020 2020 2020 2020 2320 6361  hen.        # ca
-00010530: 6e63 656c 696e 6720 6d75 6c74 6970 6c65  nceling multiple
-00010540: 206a 6f62 206e 616d 6573 2069 7320 7375   job names is su
-00010550: 7070 6f72 7465 642e 0a20 2020 2020 2020  pported..       
-00010560: 2028 5f53 504f 545f 4341 4e43 454c 5f57   (_SPOT_CANCEL_W
-00010570: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00010580: 616d 653d 6627 7b6e 616d 657d 2d31 2729  ame=f'{name}-1')
-00010590: 202b 2027 3b20 2720 2b0a 2020 2020 2020   + '; ' +.      
-000105a0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-000105b0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-000105c0: 6e61 6d65 3d66 277b 6e61 6d65 7d2d 3227  name=f'{name}-2'
-000105d0: 2929 2c0a 2020 2020 2020 2020 2320 496e  )),.        # In
-000105e0: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-000105f0: 696e 6365 2073 6b79 2073 706f 7420 7175  ince sky spot qu
-00010600: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-00010610: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-00010620: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-00010630: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00010640: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00010650: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00010660: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00010670: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-00010680: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-00010690: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000106a0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-000106b0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000106c0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-000106d0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-000106e0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-000106f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00010700: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00010710: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00010720: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00010730: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-00010740: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-00010750: 706f 745f 7069 7065 6c69 6e65 2867 656e  pot_pipeline(gen
-00010760: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00010770: 3a0a 2020 2020 2222 2254 6573 7420 6120  :.    """Test a 
-00010780: 7370 6f74 c2a0 7069 7065 6c69 6e65 2e22  spot..pipeline."
-00010790: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-000107a0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-000107b0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-000107c0: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
-000107d0: 2d70 6970 656c 696e 6527 2c0a 2020 2020  -pipeline',.    
-000107e0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000107f0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-00010800: 6e63 6820 2d6e 207b 6e61 6d65 7d20 7465  nch -n {name} te
-00010810: 7374 732f 7465 7374 5f79 616d 6c73 2f70  sts/test_yamls/p
-00010820: 6970 656c 696e 652e 7961 6d6c 202d 7920  ipeline.yaml -y 
-00010830: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00010840: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-00010850: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00010860: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00010870: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00010880: 202d 6e31 207c 2067 7265 7020 2253 5441   -n1 | grep "STA
-00010890: 5254 494e 475c 7c52 554e 4e49 4e47 2227  RTING\|RUNNING"'
-000108a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000108b0: 6067 7265 7020 2d41 2034 207b 6e61 6d65  `grep -A 4 {name
-000108c0: 7d60 2066 696e 6473 2074 6865 206a 6f62  }` finds the job
-000108d0: 2077 6974 6820 7b6e 616d 657d 2061 6e64   with {name} and
-000108e0: 2074 6865 2034 206c 696e 6573 0a20 2020   the 4 lines.   
-000108f0: 2020 2020 2020 2020 2023 2061 6674 6572           # after
-00010900: 2069 742c 2069 2e65 2e20 7468 6520 3420   it, i.e. the 4 
-00010910: 7461 736b 7320 7769 7468 696e 2074 6865  tasks within the
-00010920: 206a 6f62 2e0a 2020 2020 2020 2020 2020   job..          
-00010930: 2020 2320 6073 6564 202d 6e20 3270 6020    # `sed -n 2p` 
-00010940: 6765 7473 2074 6865 2073 6563 6f6e 6420  gets the second 
-00010950: 6c69 6e65 206f 6620 7468 6520 3420 6c69  line of the 4 li
-00010960: 6e65 732c 2069 2e65 2e20 7468 6520 6669  nes, i.e. the fi
-00010970: 7273 740a 2020 2020 2020 2020 2020 2020  rst.            
-00010980: 2320 7461 736b 2077 6974 6869 6e20 7468  # task within th
-00010990: 6520 6a6f 622e 0a20 2020 2020 2020 2020  e job..         
-000109a0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-000109b0: 455f 5741 4954 7d7c 2067 7265 7020 2d41  E_WAIT}| grep -A
-000109c0: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
-000109d0: 6e20 3270 207c 2067 7265 7020 2253 5441  n 2p | grep "STA
-000109e0: 5254 494e 475c 7c52 554e 4e49 4e47 2227  RTING\|RUNNING"'
-000109f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010a00: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00010a10: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
-00010a20: 616d 657d 7c20 7365 6420 2d6e 2033 7020  ame}| sed -n 3p 
-00010a30: 7c20 6772 6570 2022 5045 4e44 494e 4722  | grep "PENDING"
-00010a40: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
-00010a50: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00010a60: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00010a70: 3d66 277b 6e61 6d65 7d27 292c 0a20 2020  =f'{name}'),.   
-00010a80: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00010a90: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-00010aa0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00010ab0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
-00010ac0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2032  {name}| sed -n 2
-00010ad0: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
-00010ae0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-00010af0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00010b00: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00010b10: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
-00010b20: 6e61 6d65 7d7c 2073 6564 202d 6e20 3370  name}| sed -n 3p
-00010b30: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00010b40: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
-00010b50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010b60: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00010b70: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
-00010b80: 616d 657d 7c20 7365 6420 2d6e 2034 7020  ame}| sed -n 4p 
-00010b90: 7c20 6772 6570 2022 4341 4e43 454c 4c49  | grep "CANCELLI
-00010ba0: 4e47 5c7c 4341 4e43 454c 4c45 4422 272c  NG\|CANCELLED"',
-00010bb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00010bc0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00010bd0: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
-00010be0: 6d65 7d7c 2073 6564 202d 6e20 3570 207c  me}| sed -n 5p |
-00010bf0: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
-00010c00: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
-00010c10: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00010c20: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
-00010c30: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00010c40: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00010c50: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-00010c60: 202d 6e20 3270 207c 2067 7265 7020 2243   -n 2p | grep "C
-00010c70: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-00010c80: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00010c90: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00010ca0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00010cb0: 7365 6420 2d6e 2033 7020 7c20 6772 6570  sed -n 3p | grep
-00010cc0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-00010cd0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00010ce0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00010cf0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
-00010d00: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
-00010d10: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-00010d20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010d30: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00010d40: 547d 7c20 6772 6570 202d 4120 3420 7b6e  T}| grep -A 4 {n
-00010d50: 616d 657d 7c20 7365 6420 2d6e 2035 7020  ame}| sed -n 5p 
-00010d60: 7c20 6772 6570 2022 4341 4e43 454c 4c45  | grep "CANCELLE
-00010d70: 4422 272c 0a20 2020 2020 2020 205d 2c0a  D"',.        ],.
-00010d80: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-00010d90: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-00010da0: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
-00010db0: 657d 2729 2c0a 2020 2020 2020 2020 2320  e}'),.        # 
-00010dc0: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
-00010dd0: 2073 696e 6365 2073 6b79 2073 706f 7420   since sky spot 
-00010de0: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
-00010df0: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
-00010e00: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
-00010e10: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
-00010e20: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00010e30: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00010e40: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00010e50: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-00010e60: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-00010e70: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-00010e80: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00010e90: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00010ea0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
-00010eb0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-00010ec0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00010ed0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00010ee0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00010ef0: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00010f00: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-00010f10: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-00010f20: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-00010f30: 5f73 706f 745f 6661 696c 6564 5f73 6574  _spot_failed_set
-00010f40: 7570 2867 656e 6572 6963 5f63 6c6f 7564  up(generic_cloud
-00010f50: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-00010f60: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00010f70: 206a 6f62 2077 6974 6820 6661 696c 6564   job with failed
-00010f80: 2073 6574 7570 2e22 2222 0a20 2020 206e   setup.""".    n
-00010f90: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00010fa0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00010fb0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00010fc0: 2020 2027 7370 6f74 5f66 6169 6c65 645f     'spot_failed_
-00010fd0: 7365 7475 7027 2c0a 2020 2020 2020 2020  setup',.        
-00010fe0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00010ff0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-00011000: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-00011010: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00011020: 7d20 2d79 202d 6420 7465 7374 732f 7465  } -y -d tests/te
-00011030: 7374 5f79 616d 6c73 2f66 6169 6c65 645f  st_yamls/failed_
-00011040: 7365 7475 702e 7961 6d6c 272c 0a20 2020  setup.yaml',.   
-00011050: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00011060: 3333 3027 2c0a 2020 2020 2020 2020 2020  330',.          
-00011070: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
-00011080: 6520 6a6f 6220 6661 696c 6564 2071 7569  e job failed qui
-00011090: 636b 6c79 2e0a 2020 2020 2020 2020 2020  ckly..          
-000110a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000110b0: 5f57 4149 547d 207c 2067 7265 7020 7b6e  _WAIT} | grep {n
-000110c0: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-000110d0: 7c20 6772 6570 2022 4641 494c 4544 5f53  | grep "FAILED_S
-000110e0: 4554 5550 2227 2c0a 2020 2020 2020 2020  ETUP"',.        
-000110f0: 5d2c 0a20 2020 2020 2020 205f 5350 4f54  ],.        _SPOT
-00011100: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-00011110: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-00011120: 6529 2c0a 2020 2020 2020 2020 2320 496e  e),.        # In
-00011130: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-00011140: 696e 6365 2073 6b79 2073 706f 7420 7175  ince sky spot qu
-00011150: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-00011160: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-00011170: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-00011180: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00011190: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-000111a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000111b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000111c0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-000111d0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-000111e0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000111f0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-00011200: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00011210: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-00011220: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00011230: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00011240: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00011250: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00011260: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00011270: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00011280: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-00011290: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-000112a0: 706f 745f 7069 7065 6c69 6e65 5f66 6169  pot_pipeline_fai
-000112b0: 6c65 645f 7365 7475 7028 6765 6e65 7269  led_setup(generi
-000112c0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-000112d0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-000112e0: 6564 2073 706f 7420 6a6f 6220 7769 7468  ed spot job with
-000112f0: 2066 6169 6c65 6420 7365 7475 7020 666f   failed setup fo
-00011300: 7220 6120 7069 7065 6c69 6e65 2e22 2222  r a pipeline."""
-00011310: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00011320: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00011330: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00011340: 0a20 2020 2020 2020 2027 7370 6f74 5f70  .        'spot_p
-00011350: 6970 656c 696e 655f 6661 696c 6564 5f73  ipeline_failed_s
-00011360: 6574 7570 272c 0a20 2020 2020 2020 205b  etup',.        [
-00011370: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00011380: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00011390: 6e20 7b6e 616d 657d 202d 7920 2d64 2074  n {name} -y -d t
-000113a0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-000113b0: 6661 696c 6564 5f73 6574 7570 5f70 6970  failed_setup_pip
-000113c0: 656c 696e 652e 7961 6d6c 272c 0a20 2020  eline.yaml',.   
-000113d0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000113e0: 3830 3027 2c0a 2020 2020 2020 2020 2020  800',.          
-000113f0: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
-00011400: 6520 6a6f 6220 6661 696c 6564 2071 7569  e job failed qui
-00011410: 636b 6c79 2e0a 2020 2020 2020 2020 2020  ckly..          
-00011420: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00011430: 5f57 4149 547d 207c 2067 7265 7020 7b6e  _WAIT} | grep {n
-00011440: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00011450: 7c20 6772 6570 2022 4641 494c 4544 5f53  | grep "FAILED_S
-00011460: 4554 5550 2227 2c0a 2020 2020 2020 2020  ETUP"',.        
-00011470: 2020 2020 2320 5461 736b 2030 2073 686f      # Task 0 sho
-00011480: 756c 6420 6265 2053 5543 4345 4544 4544  uld be SUCCEEDED
-00011490: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000114a0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-000114b0: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-000114c0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
-000114d0: 207c 2067 7265 7020 2253 5543 4345 4544   | grep "SUCCEED
-000114e0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-000114f0: 2020 2320 5461 736b 2031 2073 686f 756c    # Task 1 shoul
-00011500: 6420 6265 2046 4149 4c45 445f 5345 5455  d be FAILED_SETU
-00011510: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
-00011520: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00011530: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
-00011540: 7b6e 616d 657d 7c20 7365 6420 2d6e 2033  {name}| sed -n 3
-00011550: 7020 7c20 6772 6570 2022 4641 494c 4544  p | grep "FAILED
-00011560: 5f53 4554 5550 2227 2c0a 2020 2020 2020  _SETUP"',.      
-00011570: 2020 2020 2020 2320 5461 736b 2032 2073        # Task 2 s
-00011580: 686f 756c 6420 6265 2043 414e 4345 4c4c  hould be CANCELL
-00011590: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
-000115a0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-000115b0: 4149 547d 207c 2067 7265 7020 2d41 2034  AIT} | grep -A 4
-000115c0: 207b 6e61 6d65 7d7c 2073 6564 202d 6e20   {name}| sed -n 
-000115d0: 3470 207c 2067 7265 7020 2243 414e 4345  4p | grep "CANCE
-000115e0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-000115f0: 2020 2020 2320 5461 736b 2033 2073 686f      # Task 3 sho
-00011600: 756c 6420 6265 2043 414e 4345 4c4c 4544  uld be CANCELLED
-00011610: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00011620: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00011630: 547d 207c 2067 7265 7020 2d41 2034 207b  T} | grep -A 4 {
-00011640: 6e61 6d65 7d7c 2073 6564 202d 6e20 3570  name}| sed -n 5p
-00011650: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00011660: 4544 2227 2c0a 2020 2020 2020 2020 5d2c  ED"',.        ],
-00011670: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-00011680: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-00011690: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-000116a0: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-000116b0: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-000116c0: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-000116d0: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-000116e0: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-000116f0: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-00011700: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-00011710: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00011720: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00011730: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-00011740: 7374 696e 6720 6d61 6e61 6765 6420 7370  sting managed sp
-00011750: 6f74 2072 6563 6f76 6572 7920 2d2d 2d2d  ot recovery ----
-00011760: 2d2d 2d2d 2d2d 0a0a 0a40 7079 7465 7374  ------...@pytest
-00011770: 2e6d 6172 6b2e 6177 730a 4070 7974 6573  .mark.aws.@pytes
-00011780: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-00011790: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-000117a0: 745f 7265 636f 7665 7279 5f61 7773 2861  t_recovery_aws(a
-000117b0: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
-000117c0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
-000117d0: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
-000117e0: 7665 7279 2e22 2222 0a20 2020 206e 616d  very.""".    nam
-000117f0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00011800: 5f6e 616d 6528 290a 2020 2020 7265 6769  _name().    regi
-00011810: 6f6e 203d 2061 7773 5f63 6f6e 6669 675f  on = aws_config_
-00011820: 7265 6769 6f6e 0a20 2020 2074 6573 7420  region.    test 
-00011830: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00011840: 2773 706f 745f 7265 636f 7665 7279 5f61  'spot_recovery_a
-00011850: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
-00011860: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00011870: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-00011880: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-00011890: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
-000118a0: 616d 657d 2022 6563 686f 2053 4b59 5049  ame} "echo SKYPI
-000118b0: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
-000118c0: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
-000118d0: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
-000118e0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-000118f0: 2020 2773 6c65 6570 2033 3630 272c 0a20    'sleep 360',. 
-00011900: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00011910: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00011920: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00011930: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00011940: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00011950: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-00011960: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
-00011970: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-00011980: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
-00011990: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
-000119a0: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
-000119b0: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
-000119c0: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-000119d0: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
-000119e0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
-000119f0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
-00011a00: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
-00011a10: 2020 2866 2761 7773 2065 6332 2074 6572    (f'aws ec2 ter
-00011a20: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
-00011a30: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00011a40: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
-00011a50: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
-00011a60: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
-00011a70: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-00011a80: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00011a90: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-00011aa0: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
-00011ab0: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-00011ac0: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
-00011ad0: 616d 657d 2a20 270a 2020 2020 2020 2020  ame}* '.        
-00011ae0: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
-00011af0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
-00011b00: 7374 616e 6365 735b 5d2e 496e 7374 616e  stances[].Instan
-00011b10: 6365 4964 2027 0a20 2020 2020 2020 2020  ceId '.         
-00011b20: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
-00011b30: 7874 2927 292c 0a20 2020 2020 2020 2020  xt)'),.         
-00011b40: 2020 2027 736c 6565 7020 3130 3027 2c0a     'sleep 100',.
-00011b50: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00011b60: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00011b70: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00011b80: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00011b90: 2252 4543 4f56 4552 494e 4722 272c 0a20  "RECOVERING"',. 
-00011ba0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00011bb0: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
-00011bc0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00011bd0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00011be0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00011bf0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-00011c00: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00011c10: 6627 5255 4e5f 4944 3d24 2863 6174 202f  f'RUN_ID=$(cat /
-00011c20: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00011c30: 6429 3b20 6563 686f 2024 5255 4e5f 4944  d); echo $RUN_ID
-00011c40: 3b20 736b 7920 7370 6f74 206c 6f67 7320  ; sky spot logs 
-00011c50: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-00011c60: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
-00011c70: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
-00011c80: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
-00011c90: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00011ca0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00011cb0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00011cc0: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-00011cd0: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-00011ce0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00011cf0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00011d00: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00011d10: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00011d20: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00011d30: 6465 6620 7465 7374 5f73 706f 745f 7265  def test_spot_re
-00011d40: 636f 7665 7279 5f67 6370 2829 3a0a 2020  covery_gcp():.  
-00011d50: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
-00011d60: 6420 7370 6f74 2072 6563 6f76 6572 792e  d spot recovery.
-00011d70: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00011d80: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00011d90: 2829 0a20 2020 207a 6f6e 6520 3d20 2775  ().    zone = 'u
-00011da0: 732d 6561 7374 342d 6227 0a20 2020 2071  s-east4-b'.    q
-00011db0: 7565 7279 5f63 6d64 203d 2028 6627 6763  uery_cmd = (f'gc
-00011dc0: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
-00011dd0: 7461 6e63 6573 206c 6973 7420 2d2d 6669  tances list --fi
-00011de0: 6c74 6572 3d27 0a20 2020 2020 2020 2020  lter='.         
-00011df0: 2020 2020 2020 2020 6627 2228 6c61 6265          f'"(labe
-00011e00: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
-00011e10: 616d 653a 7b6e 616d 657d 2922 2027 0a20  ame:{name})" '. 
-00011e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011e30: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
-00011e40: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
-00011e50: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
-00011e60: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
-00011e70: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-00011e80: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
-00011e90: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
-00011ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011eb0: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
-00011ec0: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
-00011ed0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00011ee0: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
-00011ef0: 7265 636f 7665 7279 5f67 6370 272c 0a20  recovery_gcp',. 
-00011f00: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00011f10: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-00011f20: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
-00011f30: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-00011f40: 202d 6e20 7b6e 616d 657d 2022 6563 686f   -n {name} "echo
-00011f50: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00011f60: 443a 205c 2453 4b59 5049 4c4f 545f 5441  D: \$SKYPILOT_TA
-00011f70: 534b 5f49 443b 2073 6c65 6570 2031 3830  SK_ID; sleep 180
-00011f80: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-00011f90: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-00011fa0: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
-00011fb0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00011fc0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00011fd0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00011fe0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-00011ff0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-00012000: 554e 5f49 443d 2428 736b 7920 7370 6f74  UN_ID=$(sky spot
-00012010: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-00012020: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-00012030: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-00012040: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
-00012050: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
-00012060: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
-00012070: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
-00012080: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
-00012090: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
-000120a0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-000120b0: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
-000120c0: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
-000120d0: 2020 2027 736c 6565 7020 3130 3027 2c0a     'sleep 100',.
-000120e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000120f0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00012100: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00012110: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00012120: 2252 4543 4f56 4552 494e 4722 272c 0a20  "RECOVERING"',. 
-00012130: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00012140: 7020 3230 3027 2c0a 2020 2020 2020 2020  p 200',.        
-00012150: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00012160: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00012170: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00012180: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-00012190: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000121a0: 6627 5255 4e5f 4944 3d24 2863 6174 202f  f'RUN_ID=$(cat /
-000121b0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-000121c0: 6429 3b20 6563 686f 2024 5255 4e5f 4944  d); echo $RUN_ID
-000121d0: 3b20 736b 7920 7370 6f74 206c 6f67 7320  ; sky spot logs 
-000121e0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-000121f0: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
-00012200: 5049 4c4f 545f 5441 534b 5f49 443a 207c  PILOT_TASK_ID: |
-00012210: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
-00012220: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00012230: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00012240: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00012250: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-00012260: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-00012270: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00012280: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00012290: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-000122a0: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
-000122b0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-000122c0: 0a64 6566 2074 6573 745f 7370 6f74 5f70  .def test_spot_p
-000122d0: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
-000122e0: 5f61 7773 2861 7773 5f63 6f6e 6669 675f  _aws(aws_config_
-000122f0: 7265 6769 6f6e 293a 0a20 2020 2022 2222  region):.    """
-00012300: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
-00012310: 7420 7265 636f 7665 7279 2066 6f72 2061  t recovery for a
-00012320: 2070 6970 656c 696e 652e 2222 220a 2020   pipeline.""".  
-00012330: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00012340: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00012350: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
-00012360: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
-00012370: 6966 2072 6567 696f 6e20 213d 2027 7573  if region != 'us
-00012380: 2d77 6573 742d 3227 3a0a 2020 2020 2020  -west-2':.      
-00012390: 2020 7079 7465 7374 2e73 6b69 7028 274f    pytest.skip('O
-000123a0: 6e6c 7920 7275 6e20 7370 6f74 2070 6970  nly run spot pip
-000123b0: 656c 696e 6520 7265 636f 7665 7279 2074  eline recovery t
-000123c0: 6573 7420 696e 2075 732d 7765 7374 2d32  est in us-west-2
-000123d0: 2729 0a20 2020 2074 6573 7420 3d20 5465  ').    test = Te
-000123e0: 7374 280a 2020 2020 2020 2020 2773 706f  st(.        'spo
-000123f0: 745f 7069 7065 6c69 6e65 5f72 6563 6f76  t_pipeline_recov
-00012400: 6572 795f 6177 7327 2c0a 2020 2020 2020  ery_aws',.      
-00012410: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00012420: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-00012430: 6820 2d6e 207b 6e61 6d65 7d20 7465 7374  h -n {name} test
-00012440: 732f 7465 7374 5f79 616d 6c73 2f70 6970  s/test_yamls/pip
-00012450: 656c 696e 655f 6177 732e 7961 6d6c 2020  eline_aws.yaml  
-00012460: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00012470: 2020 2020 2773 6c65 6570 2034 3030 272c      'sleep 400',
-00012480: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00012490: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-000124a0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-000124b0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-000124c0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-000124d0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-000124e0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-000124f0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-00012500: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-00012510: 4b59 5049 4c4f 545f 5441 534b 5f49 443a  KYPILOT_TASK_ID:
-00012520: 207c 2063 7574 202d 643a 202d 6632 293b   | cut -d: -f2);
-00012530: 2065 6368 6f20 2224 5255 4e5f 4944 2220   echo "$RUN_ID" 
-00012540: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
-00012550: 7d2d 7275 6e2d 6964 272c 0a20 2020 2020  }-run-id',.     
-00012560: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
-00012570: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
-00012580: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00012590: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
-000125a0: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
-000125b0: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
-000125c0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
-000125d0: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
-000125e0: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
-000125f0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00012600: 2054 6572 6d69 6e61 7465 2074 6865 2063   Terminate the c
-00012610: 6c75 7374 6572 206d 616e 7561 6c6c 792e  luster manually.
-00012620: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00012630: 6865 2060 6361 7420 2e2e 2e7c 2072 6576  he `cat ...| rev
-00012640: 6020 6973 2074 6f20 7265 7472 6965 7665  ` is to retrieve
-00012650: 2074 6865 206a 6f62 5f69 6420 6672 6f6d   the job_id from
-00012660: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-00012670: 2023 2053 4b59 5049 4c4f 545f 5441 534b   # SKYPILOT_TASK
-00012680: 5f49 442c 2077 6869 6368 2067 6574 7320  _ID, which gets 
-00012690: 7468 6520 7365 636f 6e64 2074 6f20 6c61  the second to la
-000126a0: 7374 2066 6965 6c64 0a20 2020 2020 2020  st field.       
-000126b0: 2020 2020 2023 2073 6570 6172 6174 6564       # separated
-000126c0: 2062 7920 602d 602e 0a20 2020 2020 2020   by `-`..       
-000126d0: 2020 2020 2028 6627 5350 4f54 5f4a 4f42       (f'SPOT_JOB
-000126e0: 5f49 443d 6063 6174 202f 746d 702f 7b6e  _ID=`cat /tmp/{n
-000126f0: 616d 657d 2d72 756e 2d69 6420 7c20 7265  ame}-run-id | re
-00012700: 7620 7c20 270a 2020 2020 2020 2020 2020  v | '.          
-00012710: 2020 2027 6375 7420 2d64 5c27 2d5c 2720     'cut -d\'-\' 
-00012720: 2d66 3220 7c20 7265 7660 3b27 0a20 2020  -f2 | rev`;'.   
-00012730: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
-00012740: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
-00012750: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
-00012760: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
-00012770: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
-00012780: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
-00012790: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
-000127a0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-000127b0: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
-000127c0: 2020 2020 2020 2020 272d 2d66 696c 7465          '--filte
-000127d0: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
-000127e0: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
-000127f0: 7565 733d 2a2d 247b 5350 4f54 5f4a 4f42  ues=*-${SPOT_JOB
-00012800: 5f49 447d 2027 0a20 2020 2020 2020 2020  _ID} '.         
-00012810: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-00012820: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00012830: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-00012840: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-00012850: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-00012860: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
-00012870: 2020 2773 6c65 6570 2031 3030 272c 0a20    'sleep 100',. 
-00012880: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00012890: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-000128a0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-000128b0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-000128c0: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-000128d0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000128e0: 2032 3030 272c 0a20 2020 2020 2020 2020   200',.         
-000128f0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00012900: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00012910: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00012920: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-00012930: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00012940: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
-00012950: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-00012960: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
-00012970: 2073 6b79 2073 706f 7420 6c6f 6773 202d   sky spot logs -
-00012980: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00012990: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-000129a0: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
-000129b0: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
-000129c0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-000129d0: 554e 5f49 4453 3d24 2873 6b79 2073 706f  UN_IDS=$(sky spo
-000129e0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-000129f0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-00012a00: 7265 7020 2d41 2034 2053 4b59 5049 4c4f  rep -A 4 SKYPILO
-00012a10: 545f 5441 534b 5f49 4453 207c 2063 7574  T_TASK_IDS | cut
-00012a20: 202d 6422 2922 202d 6632 293b 2065 6368   -d")" -f2); ech
-00012a30: 6f20 2224 5255 4e5f 4944 5322 207c 2074  o "$RUN_IDS" | t
-00012a40: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
-00012a50: 756e 2d69 6473 2d6e 6577 272c 0a20 2020  un-ids-new',.   
-00012a60: 2020 2020 2020 2020 2066 2764 6966 6620           f'diff 
-00012a70: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00012a80: 6964 7320 2f74 6d70 2f7b 6e61 6d65 7d2d  ids /tmp/{name}-
-00012a90: 7275 6e2d 6964 732d 6e65 7727 2c0a 2020  run-ids-new',.  
-00012aa0: 2020 2020 2020 2020 2020 6627 6361 7420            f'cat 
-00012ab0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00012ac0: 6964 7320 7c20 7365 6420 2d6e 2032 7020  ids | sed -n 2p 
-00012ad0: 7c20 6772 6570 2060 6361 7420 2f74 6d70  | grep `cat /tmp
-00012ae0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 6027  /{name}-run-id`'
-00012af0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00012b00: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00012b10: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00012b20: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-00012b30: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-00012b40: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00012b50: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00012b60: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00012b70: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-00012b80: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-00012b90: 0a64 6566 2074 6573 745f 7370 6f74 5f70  .def test_spot_p
-00012ba0: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
-00012bb0: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
-00012bc0: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00012bd0: 2072 6563 6f76 6572 7920 666f 7220 6120   recovery for a 
-00012be0: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
-00012bf0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00012c00: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00012c10: 7a6f 6e65 203d 2027 7573 2d65 6173 7434  zone = 'us-east4
-00012c20: 2d62 270a 2020 2020 7175 6572 795f 636d  -b'.    query_cm
-00012c30: 6420 3d20 2827 6763 6c6f 7564 2063 6f6d  d = ('gcloud com
-00012c40: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
-00012c50: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
-00012c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c70: 2722 286c 6162 656c 732e 7261 792d 636c  '"(labels.ray-cl
-00012c80: 7573 7465 722d 6e61 6d65 3a2a 2d24 7b53  uster-name:*-${S
-00012c90: 504f 545f 4a4f 425f 4944 7d29 2220 270a  POT_JOB_ID})" '.
-00012ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cb0: 2066 272d 2d7a 6f6e 6573 3d7b 7a6f 6e65   f'--zones={zone
-00012cc0: 7d20 2d2d 666f 726d 6174 3d22 7661 6c75  } --format="valu
-00012cd0: 6528 6e61 6d65 2922 2729 0a20 2020 2074  e(name)"').    t
-00012ce0: 6572 6d69 6e61 7465 5f63 6d64 203d 2028  erminate_cmd = (
-00012cf0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
-00012d00: 2069 6e73 7461 6e63 6573 2064 656c 6574   instances delet
-00012d10: 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65 7d27  e --zone={zone}'
-00012d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d30: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
-00012d40: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
-00012d50: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00012d60: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
-00012d70: 5f70 6970 656c 696e 655f 7265 636f 7665  _pipeline_recove
-00012d80: 7279 5f67 6370 272c 0a20 2020 2020 2020  ry_gcp',.       
-00012d90: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00012da0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-00012db0: 202d 6e20 7b6e 616d 657d 2074 6573 7473   -n {name} tests
-00012dc0: 2f74 6573 745f 7961 6d6c 732f 7069 7065  /test_yamls/pipe
-00012dd0: 6c69 6e65 5f67 6370 2e79 616d 6c20 202d  line_gcp.yaml  -
-00012de0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-00012df0: 2020 2027 736c 6565 7020 3430 3027 2c0a     'sleep 400',.
-00012e00: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00012e10: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00012e20: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00012e30: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00012e40: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-00012e50: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-00012e60: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
-00012e70: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00012e80: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-00012e90: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
-00012ea0: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-00012eb0: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-00012ec0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00012ed0: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-00012ee0: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
-00012ef0: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
-00012f00: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-00012f10: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
-00012f20: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
-00012f30: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
-00012f40: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
-00012f50: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
-00012f60: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 7327  /{name}-run-ids'
-00012f70: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00012f80: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
-00012f90: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-00012fa0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00012fb0: 6520 6063 6174 202e 2e2e 7c20 7265 7660  e `cat ...| rev`
-00012fc0: 2069 7320 746f 2072 6574 7269 6576 6520   is to retrieve 
-00012fd0: 7468 6520 6a6f 625f 6964 2066 726f 6d20  the job_id from 
-00012fe0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-00012ff0: 2320 534b 5950 494c 4f54 5f54 4153 4b5f  # SKYPILOT_TASK_
-00013000: 4944 2c20 7768 6963 6820 6765 7473 2074  ID, which gets t
-00013010: 6865 2073 6563 6f6e 6420 746f 206c 6173  he second to las
-00013020: 7420 6669 656c 640a 2020 2020 2020 2020  t field.        
-00013030: 2020 2020 2320 7365 7061 7261 7465 6420      # separated 
-00013040: 6279 2060 2d60 2e0a 2020 2020 2020 2020  by `-`..        
-00013050: 2020 2020 2866 2753 504f 545f 4a4f 425f      (f'SPOT_JOB_
-00013060: 4944 3d60 6361 7420 2f74 6d70 2f7b 6e61  ID=`cat /tmp/{na
-00013070: 6d65 7d2d 7275 6e2d 6964 207c 2072 6576  me}-run-id | rev
-00013080: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
-00013090: 2020 6627 6375 7420 2d64 5c27 2d5c 2720    f'cut -d\'-\' 
-000130a0: 2d66 3220 7c20 7265 7660 3b7b 7465 726d  -f2 | rev`;{term
-000130b0: 696e 6174 655f 636d 647d 2729 2c0a 2020  inate_cmd}'),.  
-000130c0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000130d0: 2031 3030 272c 0a20 2020 2020 2020 2020   100',.         
-000130e0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-000130f0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00013100: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00013110: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-00013120: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00013130: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
-00013140: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00013150: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00013160: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-00013170: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-00013180: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00013190: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-000131a0: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
-000131b0: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
-000131c0: 2452 554e 5f49 443b 2073 6b79 2073 706f  $RUN_ID; sky spo
-000131d0: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-000131e0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-000131f0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-00013200: 4b5f 4944 3a20 7c20 6772 6570 2022 2452  K_ID: | grep "$R
-00013210: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-00013220: 2020 2020 2066 2752 554e 5f49 4453 3d24       f'RUN_IDS=$
-00013230: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00013240: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00013250: 6c6c 6f77 207c 2067 7265 7020 2d41 2034  llow | grep -A 4
-00013260: 2053 4b59 5049 4c4f 545f 5441 534b 5f49   SKYPILOT_TASK_I
-00013270: 4453 207c 2063 7574 202d 6422 2922 202d  DS | cut -d")" -
-00013280: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-00013290: 4944 5322 207c 2074 6565 202f 746d 702f  IDS" | tee /tmp/
-000132a0: 7b6e 616d 657d 2d72 756e 2d69 6473 2d6e  {name}-run-ids-n
-000132b0: 6577 272c 0a20 2020 2020 2020 2020 2020  ew',.           
-000132c0: 2066 2764 6966 6620 2f74 6d70 2f7b 6e61   f'diff /tmp/{na
-000132d0: 6d65 7d2d 7275 6e2d 6964 7320 2f74 6d70  me}-run-ids /tmp
-000132e0: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
-000132f0: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
-00013300: 2020 6627 6361 7420 2f74 6d70 2f7b 6e61    f'cat /tmp/{na
-00013310: 6d65 7d2d 7275 6e2d 6964 7320 7c20 7365  me}-run-ids | se
-00013320: 6420 2d6e 2032 7020 7c20 6772 6570 2060  d -n 2p | grep `
-00013330: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
-00013340: 7275 6e2d 6964 6027 2c0a 2020 2020 2020  run-id`',.      
-00013350: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
-00013360: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00013370: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-00013380: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00013390: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
-000133a0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000133b0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000133c0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-000133d0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-000133e0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-000133f0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00013400: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00013410: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
-00013420: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
-00013430: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00013440: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00013450: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-00013460: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-00013470: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00013480: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00013490: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-000134a0: 0a64 6566 2074 6573 745f 7370 6f74 5f72  .def test_spot_r
-000134b0: 6563 6f76 6572 795f 6465 6661 756c 745f  ecovery_default_
-000134c0: 7265 736f 7572 6365 7328 6765 6e65 7269  resources(generi
-000134d0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-000134e0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
-000134f0: 6564 2073 706f 7420 7265 636f 7665 7279  ed spot recovery
-00013500: 2066 6f72 2064 6566 6175 6c74 2072 6573   for default res
-00013510: 6f75 7263 6573 2e22 2222 0a20 2020 206e  ources.""".    n
-00013520: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00013530: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00013540: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00013550: 2020 2027 6d61 6e61 6765 642d 7370 6f74     'managed-spot
-00013560: 2d72 6563 6f76 6572 792d 6465 6661 756c  -recovery-defaul
-00013570: 742d 7265 736f 7572 6365 7327 2c0a 2020  t-resources',.  
-00013580: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00013590: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-000135a0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
-000135b0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-000135c0: 5f63 6c6f 7564 7d20 2273 6c65 6570 2033  _cloud} "sleep 3
-000135d0: 3020 2626 2073 7564 6f20 7368 7574 646f  0 && sudo shutdo
-000135e0: 776e 206e 6f77 2026 2620 736c 6565 7020  wn now && sleep 
-000135f0: 3130 3030 2220 2d79 202d 6427 2c0a 2020  1000" -y -d',.  
-00013600: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-00013610: 2033 3630 272c 0a20 2020 2020 2020 2020   360',.         
-00013620: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00013630: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00013640: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00013650: 7c20 6772 6570 2022 5255 4e4e 494e 475c  | grep "RUNNING\
-00013660: 7c52 4543 4f56 4552 494e 4722 272c 0a20  |RECOVERING"',. 
-00013670: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00013680: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00013690: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-000136a0: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-000136b0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
-000136c0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-000136d0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-000136e0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-000136f0: 6177 730a 4070 7974 6573 742e 6d61 726b  aws.@pytest.mark
-00013700: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
-00013710: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
-00013720: 7665 7279 5f6d 756c 7469 5f6e 6f64 655f  very_multi_node_
-00013730: 6177 7328 6177 735f 636f 6e66 6967 5f72  aws(aws_config_r
-00013740: 6567 696f 6e29 3a0a 2020 2020 2222 2254  egion):.    """T
-00013750: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00013760: 2072 6563 6f76 6572 792e 2222 220a 2020   recovery.""".  
-00013770: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00013780: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00013790: 2072 6567 696f 6e20 3d20 6177 735f 636f   region = aws_co
-000137a0: 6e66 6967 5f72 6567 696f 6e0a 2020 2020  nfig_region.    
-000137b0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000137c0: 2020 2020 2027 7370 6f74 5f72 6563 6f76       'spot_recov
-000137d0: 6572 795f 6d75 6c74 695f 6e6f 6465 5f61  ery_multi_node_a
-000137e0: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
-000137f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00013800: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-00013810: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-00013820: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
-00013830: 616d 657d 202d 2d6e 756d 2d6e 6f64 6573  ame} --num-nodes
-00013840: 2032 2022 6563 686f 2053 4b59 5049 4c4f   2 "echo SKYPILO
-00013850: 545f 5441 534b 5f49 443a 205c 2453 4b59  T_TASK_ID: \$SKY
-00013860: 5049 4c4f 545f 5441 534b 5f49 443b 2073  PILOT_TASK_ID; s
-00013870: 6c65 6570 2031 3830 3022 2020 2d79 202d  leep 1800"  -y -
-00013880: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00013890: 2773 6c65 6570 2034 3530 272c 0a20 2020  'sleep 450',.   
-000138a0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-000138b0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-000138c0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-000138d0: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-000138e0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-000138f0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
-00013900: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-00013910: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00013920: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-00013930: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
-00013940: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
-00013950: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
-00013960: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-00013970: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
-00013980: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
-00013990: 6520 776f 726b 6572 206d 616e 7561 6c6c  e worker manuall
-000139a0: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
-000139b0: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
-000139c0: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
-000139d0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-000139e0: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-000139f0: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
-00013a00: 6627 6177 7320 6563 3220 6465 7363 7269  f'aws ec2 descri
-00013a10: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
-00013a20: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
-00013a30: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
-00013a40: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
-00013a50: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-00013a60: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-00013a70: 7d2a 2027 0a20 2020 2020 2020 2020 2020  }* '.           
-00013a80: 2020 274e 616d 653d 7461 673a 7261 792d    'Name=tag:ray-
-00013a90: 6e6f 6465 2d74 7970 652c 5661 6c75 6573  node-type,Values
-00013aa0: 3d77 6f72 6b65 7220 270a 2020 2020 2020  =worker '.      
-00013ab0: 2020 2020 2020 2066 272d 2d71 7565 7279         f'--query
-00013ac0: 2052 6573 6572 7661 7469 6f6e 735b 5d2e   Reservations[].
-00013ad0: 496e 7374 616e 6365 735b 5d2e 496e 7374  Instances[].Inst
-00013ae0: 616e 6365 4964 2027 0a20 2020 2020 2020  anceId '.       
-00013af0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
-00013b00: 7465 7874 2927 292c 0a20 2020 2020 2020  text)'),.       
-00013b10: 2020 2020 2027 736c 6565 7020 3530 272c       'sleep 50',
-00013b20: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00013b30: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00013b40: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00013b50: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00013b60: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
-00013b70: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00013b80: 6570 2035 3630 272c 0a20 2020 2020 2020  ep 560',.       
-00013b90: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00013ba0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00013bb0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-00013bc0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
-00013bd0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-00013be0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
-00013bf0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00013c00: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
-00013c10: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
-00013c20: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00013c30: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-00013c40: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
-00013c50: 2063 7574 202d 643a 202d 6632 207c 2067   cut -d: -f2 | g
-00013c60: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
-00013c70: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00013c80: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00013c90: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00013ca0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00013cb0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
-00013cc0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00013cd0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00013ce0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00013cf0: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
-00013d00: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-00013d10: 6566 2074 6573 745f 7370 6f74 5f72 6563  ef test_spot_rec
-00013d20: 6f76 6572 795f 6d75 6c74 695f 6e6f 6465  overy_multi_node
-00013d30: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
-00013d40: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00013d50: 2072 6563 6f76 6572 792e 2222 220a 2020   recovery.""".  
-00013d60: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00013d70: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00013d80: 207a 6f6e 6520 3d20 2775 732d 7765 7374   zone = 'us-west
-00013d90: 322d 6127 0a20 2020 2023 2055 7365 2027  2-a'.    # Use '
-00013da0: 3a27 2074 6f20 6d61 7463 6820 6173 2074  :' to match as t
-00013db0: 6865 2063 6c75 7374 6572 206e 616d 6520  he cluster name 
-00013dc0: 7769 6c6c 2063 6f6e 7461 696e 2074 6865  will contain the
-00013dd0: 2073 7566 6669 7820 7769 7468 206a 6f62   suffix with job
-00013de0: 2069 640a 2020 2020 7175 6572 795f 636d   id.    query_cm
-00013df0: 6420 3d20 280a 2020 2020 2020 2020 6627  d = (.        f'
-00013e00: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
-00013e10: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
-00013e20: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
-00013e30: 2066 2722 286c 6162 656c 732e 7261 792d   f'"(labels.ray-
-00013e40: 636c 7573 7465 722d 6e61 6d65 3a7b 6e61  cluster-name:{na
-00013e50: 6d65 7d20 414e 4420 6c61 6265 6c73 2e72  me} AND labels.r
-00013e60: 6179 2d6e 6f64 652d 7479 7065 3d77 6f72  ay-node-type=wor
-00013e70: 6b65 7229 2220 270a 2020 2020 2020 2020  ker)" '.        
-00013e80: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
-00013e90: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
-00013ea0: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
-00013eb0: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
-00013ec0: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-00013ed0: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
-00013ee0: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
-00013ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f00: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
-00013f10: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
-00013f20: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00013f30: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
-00013f40: 7265 636f 7665 7279 5f6d 756c 7469 5f6e  recovery_multi_n
-00013f50: 6f64 655f 6763 7027 2c0a 2020 2020 2020  ode_gcp',.      
-00013f60: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00013f70: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-00013f80: 6820 2d2d 636c 6f75 6420 6763 7020 2d2d  h --cloud gcp --
-00013f90: 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e 207b  zone {zone} -n {
-00013fa0: 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f 6465  name} --num-node
-00013fb0: 7320 3220 2265 6368 6f20 534b 5950 494c  s 2 "echo SKYPIL
-00013fc0: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
-00013fd0: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
-00013fe0: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
-00013ff0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00014000: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-00014010: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00014020: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00014030: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00014040: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00014050: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00014060: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00014070: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00014080: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00014090: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-000140a0: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
-000140b0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-000140c0: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-000140d0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-000140e0: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-000140f0: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-00014100: 6865 2077 6f72 6b65 7220 6d61 6e75 616c  he worker manual
-00014110: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-00014120: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
-00014130: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00014140: 7020 3530 272c 0a20 2020 2020 2020 2020  p 50',.         
-00014150: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-00014160: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-00014170: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00014180: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-00014190: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-000141a0: 2020 2773 6c65 6570 2034 3230 272c 0a20    'sleep 420',. 
-000141b0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-000141c0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-000141d0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-000141e0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-000141f0: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-00014200: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-00014210: 2428 6361 7420 2f74 6d70 2f7b 6e61 6d65  $(cat /tmp/{name
-00014220: 7d2d 7275 6e2d 6964 293b 2065 6368 6f20  }-run-id); echo 
-00014230: 2452 554e 5f49 443b 2073 6b79 2073 706f  $RUN_ID; sky spo
-00014240: 7420 6c6f 6773 202d 6e20 7b6e 616d 657d  t logs -n {name}
-00014250: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
-00014260: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
-00014270: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
-00014280: 6632 207c 2067 7265 7020 2224 5255 4e5f  f2 | grep "$RUN_
-00014290: 4944 2227 2c0a 2020 2020 2020 2020 5d2c  ID"',.        ],
-000142a0: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-000142b0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-000142c0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-000142d0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-000142e0: 743d 3235 202a 2036 302c 0a20 2020 2029  t=25 * 60,.    )
-000142f0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00014300: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00014310: 742e 6d61 726b 2e61 7773 0a40 7079 7465  t.mark.aws.@pyte
-00014320: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-00014330: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-00014340: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
-00014350: 6177 7328 6177 735f 636f 6e66 6967 5f72  aws(aws_config_r
-00014360: 6567 696f 6e29 3a0a 2020 2020 6e61 6d65  egion):.    name
-00014370: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00014380: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
-00014390: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
-000143a0: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
-000143b0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000143c0: 7370 6f74 5f63 616e 6365 6c6c 6174 696f  spot_cancellatio
-000143d0: 6e5f 6177 7327 2c0a 2020 2020 2020 2020  n_aws',.        
-000143e0: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-000143f0: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
-00014400: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
-00014410: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
-00014420: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
-00014430: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-00014440: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-00014450: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00014460: 7d20 2d6e 207b 6e61 6d65 7d20 2273 6c65  } -n {name} "sle
-00014470: 6570 2031 3030 3022 2020 2d79 202d 6427  ep 1000"  -y -d'
-00014480: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00014490: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
-000144a0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-000144b0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-000144c0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-000144d0: 6e31 207c 2067 7265 7020 2253 5441 5254  n1 | grep "START
-000144e0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-000144f0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00014500: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00014510: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00014520: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00014530: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00014540: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00014550: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00014560: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00014570: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-00014580: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00014590: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000145a0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-000145b0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000145c0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000145d0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-000145e0: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-000145f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00014600: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
-00014610: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
-00014620: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00014630: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00014640: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
-00014650: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
-00014660: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
-00014670: 7b6e 616d 657d 2d2a 2027 0a20 2020 2020  {name}-* '.     
-00014680: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-00014690: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-000146a0: 2e49 6e73 7461 6e63 6573 5b5d 2e53 7461  .Instances[].Sta
-000146b0: 7465 5b5d 2e4e 616d 6520 270a 2020 2020  te[].Name '.    
-000146c0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-000146d0: 7574 2074 6578 7429 2026 2620 6563 686f  ut text) && echo
-000146e0: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
-000146f0: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
-00014700: 5b5b 2022 2473 2220 3d20 2274 6572 6d69  [[ "$s" = "termi
-00014710: 6e61 7465 6422 205d 5d20 7c7c 205b 5b20  nated" ]] || [[ 
-00014720: 2224 7322 203d 2022 7368 7574 7469 6e67  "$s" = "shutting
-00014730: 2d64 6f77 6e22 205d 5d27 0a20 2020 2020  -down" ]]'.     
-00014740: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00014750: 2020 2020 2020 2320 5465 7374 2063 616e        # Test can
-00014760: 6365 6c6c 696e 6720 7468 6520 7370 6f74  celling the spot
-00014770: 2063 6c75 7374 6572 2064 7572 696e 6720   cluster during 
-00014780: 7370 6f74 206a 6f62 2062 6569 6e67 2073  spot job being s
-00014790: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
-000147a0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-000147b0: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-000147c0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-000147d0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 7465  } -n {name}-2 te
-000147e0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-000147f0: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
-00014800: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
-00014810: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00014820: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
-00014830: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00014840: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00014850: 616d 653d 6627 7b6e 616d 657d 2d32 2729  ame=f'{name}-2')
-00014860: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00014870: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-00014880: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00014890: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-000148a0: 7b6e 616d 657d 2d32 207c 2068 6561 6420  {name}-2 | head 
-000148b0: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-000148c0: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-000148d0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-000148e0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-000148f0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00014900: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00014910: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-00014920: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00014930: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-00014940: 2020 2020 2020 2020 2020 2866 2773 3d24            (f's=$
-00014950: 2861 7773 2065 6332 2064 6573 6372 6962  (aws ec2 describ
-00014960: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
-00014970: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
-00014980: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-00014990: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
-000149a0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-000149b0: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
-000149c0: 2d32 2d2a 2027 0a20 2020 2020 2020 2020  -2-* '.         
-000149d0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-000149e0: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-000149f0: 7461 6e63 6573 5b5d 2e53 7461 7465 5b5d  tances[].State[]
-00014a00: 2e4e 616d 6520 270a 2020 2020 2020 2020  .Name '.        
-00014a10: 2020 2020 2027 2d2d 6f75 7470 7574 2074       '--output t
-00014a20: 6578 7429 2026 2620 6563 686f 2022 2473  ext) && echo "$s
-00014a30: 2220 2626 2065 6368 6f3b 205b 5b20 2d7a  " && echo; [[ -z
-00014a40: 2022 2473 2220 5d5d 207c 7c20 5b5b 2022   "$s" ]] || [[ "
-00014a50: 2473 2220 3d20 2274 6572 6d69 6e61 7465  $s" = "terminate
-00014a60: 6422 205d 5d20 7c7c 205b 5b20 2224 7322  d" ]] || [[ "$s"
-00014a70: 203d 2022 7368 7574 7469 6e67 2d64 6f77   = "shutting-dow
-00014a80: 6e22 205d 5d27 0a20 2020 2020 2020 2020  n" ]]'.         
-00014a90: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00014aa0: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
-00014ab0: 6174 696f 6e20 6475 7269 6e67 2073 706f  ation during spo
-00014ac0: 7420 6a6f 6220 6973 2072 6563 6f76 6572  t job is recover
-00014ad0: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-00014ae0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
-00014af0: 6368 202d 2d63 6c6f 7564 2061 7773 202d  ch --cloud aws -
-00014b00: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-00014b10: 202d 6e20 7b6e 616d 657d 2d33 2022 736c   -n {name}-3 "sl
-00014b20: 6565 7020 3130 3030 2220 202d 7920 2d64  eep 1000"  -y -d
-00014b30: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00014b40: 736c 6565 7020 3330 3027 2c0a 2020 2020  sleep 300',.    
-00014b50: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00014b60: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00014b70: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-00014b80: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00014b90: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00014ba0: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-00014bb0: 6520 7468 6520 636c 7573 7465 7220 6d61  e the cluster ma
-00014bc0: 6e75 616c 6c79 2e0a 2020 2020 2020 2020  nually..        
-00014bd0: 2020 2020 2866 2761 7773 2065 6332 2074      (f'aws ec2 t
-00014be0: 6572 6d69 6e61 7465 2d69 6e73 7461 6e63  erminate-instanc
-00014bf0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-00014c00: 696f 6e7d 202d 2d69 6e73 7461 6e63 652d  ion} --instance-
-00014c10: 6964 7320 2428 270a 2020 2020 2020 2020  ids $('.        
-00014c20: 2020 2020 2066 2761 7773 2065 6332 2064       f'aws ec2 d
-00014c30: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
-00014c40: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00014c50: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00014c60: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
-00014c70: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
-00014c80: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
-00014c90: 7b6e 616d 657d 2d33 2d2a 2027 0a20 2020  {name}-3-* '.   
-00014ca0: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-00014cb0: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-00014cc0: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e49  [].Instances[].I
-00014cd0: 6e73 7461 6e63 6549 6420 270a 2020 2020  nstanceId '.    
-00014ce0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-00014cf0: 7574 2074 6578 7429 2729 2c0a 2020 2020  ut text)'),.    
-00014d00: 2020 2020 2020 2020 2773 6c65 6570 2031          'sleep 1
-00014d10: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-00014d20: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00014d30: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00014d40: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
-00014d50: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
-00014d60: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00014d70: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00014d80: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00014d90: 616d 653d 6627 7b6e 616d 657d 2d33 2729  ame=f'{name}-3')
-00014da0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00014db0: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-00014dc0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00014dd0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00014de0: 7b6e 616d 657d 2d33 207c 2068 6561 6420  {name}-3 | head 
-00014df0: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-00014e00: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-00014e10: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-00014e20: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-00014e30: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00014e40: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00014e50: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-00014e60: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00014e70: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-00014e80: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-00014e90: 636c 7573 7465 7220 7368 6f75 6c64 2062  cluster should b
-00014ea0: 6520 7465 726d 696e 6174 6564 2028 7368  e terminated (sh
-00014eb0: 7574 7469 6e67 2d64 6f77 6e29 2061 6674  utting-down) aft
-00014ec0: 6572 2063 616e 6365 6c6c 6174 696f 6e2e  er cancellation.
-00014ed0: 2057 6520 646f 6e27 7420 7573 6520 7468   We don't use th
-00014ee0: 6520 603d 6020 6f70 6572 6174 6f72 2068  e `=` operator h
-00014ef0: 6572 6520 6265 6361 7573 650a 2020 2020  ere because.    
-00014f00: 2020 2020 2020 2020 2320 7468 6572 6520          # there 
-00014f10: 6361 6e20 6265 206d 756c 7469 706c 6520  can be multiple 
-00014f20: 564d 2077 6974 6820 7468 6520 7361 6d65  VM with the same
-00014f30: 206e 616d 6520 6475 6520 746f 2074 6865   name due to the
-00014f40: 2072 6563 6f76 6572 792e 0a20 2020 2020   recovery..     
-00014f50: 2020 2020 2020 2028 6627 733d 2428 6177         (f's=$(aw
-00014f60: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
-00014f70: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
-00014f80: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-00014f90: 2020 2020 2020 2020 2020 6627 2d2d 6669            f'--fi
-00014fa0: 6c74 6572 7320 4e61 6d65 3d74 6167 3a72  lters Name=tag:r
-00014fb0: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-00014fc0: 5661 6c75 6573 3d7b 6e61 6d65 7d2d 332d  Values={name}-3-
-00014fd0: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
-00014fe0: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
-00014ff0: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-00015000: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
-00015010: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
-00015020: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-00015030: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-00015040: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
-00015050: 7322 205d 5d20 7c7c 2065 6368 6f20 2224  s" ]] || echo "$
-00015060: 7322 207c 2067 7265 7020 2d76 202d 4520  s" | grep -v -E 
-00015070: 2270 656e 6469 6e67 7c72 756e 6e69 6e67  "pending|running
-00015080: 7c73 746f 7070 6564 7c73 746f 7070 696e  |stopped|stoppin
-00015090: 6722 270a 2020 2020 2020 2020 2020 2020  g"'.            
-000150a0: 292c 0a20 2020 2020 2020 205d 2c0a 2020  ),.        ],.  
-000150b0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-000150c0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
-000150d0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000150e0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-000150f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-00015100: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00015110: 6573 745f 7370 6f74 5f63 616e 6365 6c6c  est_spot_cancell
-00015120: 6174 696f 6e5f 6763 7028 293a 0a20 2020  ation_gcp():.   
-00015130: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00015140: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00015150: 7a6f 6e65 203d 2027 7573 2d77 6573 7433  zone = 'us-west3
-00015160: 2d62 270a 2020 2020 7175 6572 795f 7374  -b'.    query_st
-00015170: 6174 655f 636d 6420 3d20 2827 6763 6c6f  ate_cmd = ('gclo
-00015180: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-00015190: 6e63 6573 206c 6973 7420 270a 2020 2020  nces list '.    
-000151a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151b0: 2020 2066 272d 2d66 696c 7465 723d 2228     f'--filter="(
-000151c0: 6c61 6265 6c73 2e72 6179 2d63 6c75 7374  labels.ray-clust
-000151d0: 6572 2d6e 616d 653a 7b6e 616d 657d 2922  er-name:{name})"
-000151e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000151f0: 2020 2020 2020 2020 2020 272d 2d66 6f72            '--for
-00015200: 6d61 743d 2276 616c 7565 2873 7461 7475  mat="value(statu
-00015210: 7329 2227 290a 2020 2020 7175 6572 795f  s)"').    query_
-00015220: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
-00015230: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
-00015240: 7320 6c69 7374 202d 2d66 696c 7465 723d  s list --filter=
-00015250: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00015260: 2020 2066 2722 286c 6162 656c 732e 7261     f'"(labels.ra
-00015270: 792d 636c 7573 7465 722d 6e61 6d65 3a7b  y-cluster-name:{
-00015280: 6e61 6d65 7d29 2220 270a 2020 2020 2020  name})" '.      
-00015290: 2020 2020 2020 2020 2020 2066 272d 2d7a             f'--z
-000152a0: 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d 666f  ones={zone} --fo
-000152b0: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
-000152c0: 2922 2729 0a20 2020 2074 6572 6d69 6e61  )"').    termina
-000152d0: 7465 5f63 6d64 203d 2028 6627 6763 6c6f  te_cmd = (f'gclo
-000152e0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-000152f0: 6e63 6573 2064 656c 6574 6520 2d2d 7a6f  nces delete --zo
-00015300: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
-00015310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015320: 6627 202d 2d71 7569 6574 2024 287b 7175  f' --quiet $({qu
-00015330: 6572 795f 636d 647d 2927 290a 2020 2020  ery_cmd})').    
-00015340: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00015350: 2020 2020 2027 7370 6f74 5f63 616e 6365       'spot_cance
-00015360: 6c6c 6174 696f 6e5f 6763 7027 2c0a 2020  llation_gcp',.  
-00015370: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00015380: 2020 2020 2320 5465 7374 2063 616e 6365      # Test cance
-00015390: 6c6c 6174 696f 6e20 6475 7269 6e67 2073  llation during s
-000153a0: 706f 7420 636c 7573 7465 7220 6265 696e  pot cluster bein
-000153b0: 6720 6c61 756e 6368 6564 2e0a 2020 2020  g launched..    
-000153c0: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-000153d0: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
-000153e0: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
-000153f0: 6e65 7d20 2d6e 207b 6e61 6d65 7d20 2273  ne} -n {name} "s
-00015400: 6c65 6570 2031 3030 3022 2020 2d79 202d  leep 1000"  -y -
-00015410: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-00015420: 2773 6c65 6570 2036 3027 2c0a 2020 2020  'sleep 60',.    
-00015430: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00015440: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00015450: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00015460: 202d 6e31 207c 2067 7265 7020 2253 5441   -n1 | grep "STA
-00015470: 5254 494e 4722 272c 0a20 2020 2020 2020  RTING"',.       
-00015480: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00015490: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-000154a0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-000154b0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000154c0: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
-000154d0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-000154e0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-000154f0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00015500: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-00015510: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-00015520: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00015530: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
-00015540: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00015550: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00015560: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00015570: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00015580: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00015590: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
-000155a0: 696e 6720 7468 6520 7370 6f74 2063 6c75  ing the spot clu
-000155b0: 7374 6572 2064 7572 696e 6720 7370 6f74  ster during spot
-000155c0: 206a 6f62 2062 6569 6e67 2073 6574 7570   job being setup
-000155d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-000155e0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-000155f0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-00015600: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
-00015610: 6d65 7d2d 3220 7465 7374 732f 7465 7374  me}-2 tests/test
-00015620: 5f79 616d 6c73 2f74 6573 745f 6c6f 6e67  _yamls/test_long
-00015630: 5f73 6574 7570 2e79 616d 6c20 202d 7920  _setup.yaml  -y 
-00015640: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00015650: 2027 736c 6565 7020 3330 3027 2c0a 2020   'sleep 300',.  
-00015660: 2020 2020 2020 2020 2020 5f53 504f 545f            _SPOT_
-00015670: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-00015680: 6174 286a 6f62 5f6e 616d 653d 6627 7b6e  at(job_name=f'{n
-00015690: 616d 657d 2d32 2729 2c0a 2020 2020 2020  ame}-2'),.      
-000156a0: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
-000156b0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000156c0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-000156d0: 7d7c 2067 7265 7020 7b6e 616d 657d 2d32  }| grep {name}-2
-000156e0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-000156f0: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-00015700: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00015710: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00015720: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-00015730: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00015740: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00015750: 6d65 7d2d 3220 7c20 6865 6164 202d 6e31  me}-2 | head -n1
-00015760: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00015770: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00015780: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
-00015790: 6174 696f 6e20 6475 7269 6e67 2073 706f  ation during spo
-000157a0: 7420 6a6f 6220 6973 2072 6563 6f76 6572  t job is recover
-000157b0: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-000157c0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
-000157d0: 6368 202d 2d63 6c6f 7564 2067 6370 202d  ch --cloud gcp -
-000157e0: 2d7a 6f6e 6520 7b7a 6f6e 657d 202d 6e20  -zone {zone} -n 
-000157f0: 7b6e 616d 657d 2d33 2022 736c 6565 7020  {name}-3 "sleep 
-00015800: 3130 3030 2220 202d 7920 2d64 272c 0a20  1000"  -y -d',. 
-00015810: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00015820: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
-00015830: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00015840: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00015850: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-00015860: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
-00015870: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00015880: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
-00015890: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
-000158a0: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-000158b0: 7465 726d 696e 6174 655f 636d 642c 0a20  terminate_cmd,. 
-000158c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-000158d0: 7020 3130 3027 2c0a 2020 2020 2020 2020  p 100',.        
-000158e0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-000158f0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00015900: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-00015910: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
-00015920: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
-00015930: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00015940: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00015950: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
-00015960: 3327 292c 0a20 2020 2020 2020 2020 2020  3'),.           
-00015970: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-00015980: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00015990: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-000159a0: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-000159b0: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
-000159c0: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
-000159d0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-000159e0: 2020 2020 2773 6c65 6570 2031 3230 272c      'sleep 120',
-000159f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00015a00: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00015a10: 7d7c 2067 7265 7020 7b6e 616d 657d 2d33  }| grep {name}-3
-00015a20: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00015a30: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
-00015a40: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00015a50: 6865 2063 6c75 7374 6572 2073 686f 756c  he cluster shoul
-00015a60: 6420 6265 2074 6572 6d69 6e61 7465 6420  d be terminated 
-00015a70: 2853 544f 5050 494e 4729 2061 6674 6572  (STOPPING) after
-00015a80: 2063 616e 6365 6c6c 6174 696f 6e2e 2057   cancellation. W
-00015a90: 6520 646f 6e27 7420 7573 6520 7468 6520  e don't use the 
-00015aa0: 603d 6020 6f70 6572 6174 6f72 2068 6572  `=` operator her
-00015ab0: 6520 6265 6361 7573 650a 2020 2020 2020  e because.      
-00015ac0: 2020 2020 2020 2320 7468 6572 6520 6361        # there ca
-00015ad0: 6e20 6265 206d 756c 7469 706c 6520 564d  n be multiple VM
-00015ae0: 2077 6974 6820 7468 6520 7361 6d65 206e   with the same n
-00015af0: 616d 6520 6475 6520 746f 2074 6865 2072  ame due to the r
-00015b00: 6563 6f76 6572 792e 0a20 2020 2020 2020  ecovery..       
-00015b10: 2020 2020 2028 6627 733d 2428 7b71 7565       (f's=$({que
-00015b20: 7279 5f73 7461 7465 5f63 6d64 7d29 2026  ry_state_cmd}) &
-00015b30: 2620 6563 686f 2022 2473 2220 2626 2065  & echo "$s" && e
-00015b40: 6368 6f3b 205b 5b20 2d7a 2022 2473 2220  cho; [[ -z "$s" 
-00015b50: 5d5d 207c 7c20 6563 686f 2022 2473 2220  ]] || echo "$s" 
-00015b60: 7c20 6772 6570 202d 7620 2d45 2022 5052  | grep -v -E "PR
-00015b70: 4f56 4953 494f 4e49 4e47 7c53 5441 4749  OVISIONING|STAGI
-00015b80: 4e47 7c52 554e 4e49 4e47 7c52 4550 4149  NG|RUNNING|REPAI
-00015b90: 5249 4e47 7c54 4552 4d49 4e41 5445 447c  RING|TERMINATED|
-00015ba0: 5355 5350 454e 4449 4e47 7c53 5553 5045  SUSPENDING|SUSPE
-00015bb0: 4e44 4544 7c53 5553 5045 4e44 4544 2227  NDED|SUSPENDED"'
-00015bc0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-00015bd0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00015be0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
-00015bf0: 3630 290a 2020 2020 7275 6e5f 6f6e 655f  60).    run_one_
-00015c00: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00015c10: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-00015c20: 6720 7374 6f72 6167 6520 666f 7220 6d61  g storage for ma
-00015c30: 6e61 6765 6420 7370 6f74 202d 2d2d 2d2d  naged spot -----
-00015c40: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-00015c50: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-00015c60: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-00015c70: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-00015c80: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00015c90: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00015ca0: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
-00015cb0: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-00015cc0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00015cd0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00015ce0: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
-00015cf0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-00015d00: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-00015d10: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-00015d20: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-00015d30: 745f 7370 6f74 5f73 746f 7261 6765 2867  t_spot_storage(g
-00015d40: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-00015d50: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
-00015d60: 7374 6f72 6167 6520 7769 7468 206d 616e  storage with man
-00015d70: 6167 6564 2073 706f 7422 2222 0a20 2020  aged spot""".   
-00015d80: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00015d90: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00015da0: 7961 6d6c 5f73 7472 203d 2070 6174 686c  yaml_str = pathl
-00015db0: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
-00015dc0: 2027 6578 616d 706c 6573 2f6d 616e 6167   'examples/manag
-00015dd0: 6564 5f73 706f 745f 7769 7468 5f73 746f  ed_spot_with_sto
-00015de0: 7261 6765 2e79 616d 6c27 292e 7265 6164  rage.yaml').read
-00015df0: 5f74 6578 7428 290a 2020 2020 7374 6f72  _text().    stor
-00015e00: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
-00015e10: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
-00015e20: 7469 6d65 2829 297d 270a 2020 2020 7961  time())}'.    ya
-00015e30: 6d6c 5f73 7472 203d 2079 616d 6c5f 7374  ml_str = yaml_st
-00015e40: 722e 7265 706c 6163 6528 2773 6b79 2d77  r.replace('sky-w
-00015e50: 6f72 6b64 6972 2d7a 6877 7527 2c20 7374  orkdir-zhwu', st
-00015e60: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
-00015e70: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
-00015e80: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
-00015e90: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
-00015ea0: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
-00015eb0: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
-00015ec0: 2879 616d 6c5f 7374 7229 0a20 2020 2020  (yaml_str).     
-00015ed0: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
-00015ee0: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
-00015ef0: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
-00015f00: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00015f10: 2020 2020 2020 2020 2027 7370 6f74 5f73           'spot_s
-00015f20: 746f 7261 6765 272c 0a20 2020 2020 2020  torage',.       
-00015f30: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00015f40: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
-00015f50: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
-00015f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f70: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-00015f80: 6820 2d6e 207b 6e61 6d65 7d20 2d2d 636c  h -n {name} --cl
-00015f90: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00015fa0: 7564 7d20 7b66 696c 655f 7061 7468 7d20  ud} {file_path} 
-00015fb0: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
-00015fc0: 2020 2020 2027 736c 6565 7020 3630 272c       'sleep 60',
-00015fd0: 2020 2320 5761 6974 2074 6865 2073 706f    # Wait the spo
-00015fe0: 7420 7175 6575 6520 746f 2062 6520 7570  t queue to be up
-00015ff0: 6461 7465 640a 2020 2020 2020 2020 2020  dated.          
-00016000: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00016010: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00016020: 207b 6e61 6d65 7d20 7c20 6772 6570 2053   {name} | grep S
-00016030: 5543 4345 4544 4544 272c 0a20 2020 2020  UCCEEDED',.     
-00016040: 2020 2020 2020 2020 2020 2066 275b 2024             f'[ $
-00016050: 2861 7773 2073 3361 7069 206c 6973 742d  (aws s3api list-
-00016060: 6275 636b 6574 7320 2d2d 7175 6572 7920  buckets --query 
-00016070: 2242 7563 6b65 7473 5b3f 636f 6e74 6169  "Buckets[?contai
-00016080: 6e73 284e 616d 652c 205c 277b 7374 6f72  ns(Name, \'{stor
-00016090: 6167 655f 6e61 6d65 7d5c 2729 5d2e 4e61  age_name}\')].Na
-000160a0: 6d65 2220 2d2d 6f75 7470 7574 2074 6578  me" --output tex
-000160b0: 7420 7c20 7763 202d 6c29 202d 6571 2030  t | wc -l) -eq 0
-000160c0: 205d 270a 2020 2020 2020 2020 2020 2020   ]'.            
-000160d0: 5d2c 0a20 2020 2020 2020 2020 2020 205f  ],.            _
-000160e0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-000160f0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00016100: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
-00016110: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
-00016120: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
-00016130: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
-00016140: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
-00016150: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
-00016160: 732e 0a20 2020 2020 2020 2020 2020 2074  s..            t
-00016170: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-00016180: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00016190: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-000161a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-000161b0: 2d2d 2d20 5465 7374 696e 6720 7370 6f74  --- Testing spot
-000161c0: 2054 5055 202d 2d2d 2d2d 2d2d 2d2d 2d0a   TPU ----------.
-000161d0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-000161e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
-000161f0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
-00016200: 6573 745f 7370 6f74 5f74 7075 2829 3a0a  est_spot_tpu():.
-00016210: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
-00016220: 6765 6420 7370 6f74 206f 6e20 5450 552e  ged spot on TPU.
-00016230: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-00016240: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00016250: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00016260: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
-00016270: 742d 7370 6f74 2d74 7075 272c 0a20 2020  t-spot-tpu',.   
-00016280: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00016290: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-000162a0: 756e 6368 202d 6e20 7b6e 616d 657d 2065  unch -n {name} e
-000162b0: 7861 6d70 6c65 732f 7470 752f 7470 7576  xamples/tpu/tpuv
-000162c0: 6d5f 6d6e 6973 742e 7961 6d6c 202d 7920  m_mnist.yaml -y 
-000162d0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-000162e0: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-000162f0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00016300: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-00016310: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-00016320: 202d 6e31 207c 2067 7265 7020 5354 4152   -n1 | grep STAR
-00016330: 5449 4e47 272c 0a20 2020 2020 2020 2020  TING',.         
-00016340: 2020 2027 736c 6565 7020 3834 3027 2c20     'sleep 840', 
-00016350: 2023 2054 5055 2074 616b 6573 2061 2077   # TPU takes a w
-00016360: 6869 6c65 2074 6f20 6c61 756e 6368 0a20  hile to launch. 
-00016370: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00016380: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00016390: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-000163a0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-000163b0: 5255 4e4e 494e 475c 7c53 5543 4345 4544  RUNNING\|SUCCEED
-000163c0: 4544 2227 2c0a 2020 2020 2020 2020 5d2c  ED"',.        ],
-000163d0: 0a20 2020 2020 2020 205f 5350 4f54 5f43  .        _SPOT_C
-000163e0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
-000163f0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
-00016400: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-00016410: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-00016420: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-00016430: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-00016440: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-00016450: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-00016460: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00016470: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00016480: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00016490: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-000164a0: 7374 696e 6720 656e 7620 666f 7220 7370  sting env for sp
-000164b0: 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ot ----------.@p
-000164c0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-000164d0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-000164e0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-000164f0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00016500: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00016510: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
-00016520: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
-00016530: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00016540: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00016550: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
-00016560: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
-00016570: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00016580: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00016590: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-000165a0: 0a64 6566 2074 6573 745f 7370 6f74 5f69  .def test_spot_i
-000165b0: 6e6c 696e 655f 656e 7628 6765 6e65 7269  nline_env(generi
-000165c0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-000165d0: 2020 2022 2222 5465 7374 2073 706f 7420     """Test spot 
-000165e0: 656e 7622 2222 0a20 2020 206e 616d 6520  env""".    name 
-000165f0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00016600: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00016610: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00016620: 7465 7374 2d73 706f 742d 696e 6c69 6e65  test-spot-inline
-00016630: 2d65 6e76 272c 0a20 2020 2020 2020 205b  -env',.        [
-00016640: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00016650: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-00016660: 6e20 7b6e 616d 657d 202d 7920 2d2d 636c  n {name} -y --cl
-00016670: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00016680: 7564 7d20 2d2d 656e 7620 5445 5354 5f45  ud} --env TEST_E
-00016690: 4e56 3d22 6865 6c6c 6f20 776f 726c 6422  NV="hello world"
-000166a0: 202d 2d20 2228 5b5b 2021 202d 7a20 5c5c   -- "([[ ! -z \\
-000166b0: 225c 2454 4553 545f 454e 565c 5c22 205d  "\$TEST_ENV\\" ]
-000166c0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-000166d0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-000166e0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
-000166f0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-00016700: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
-00016710: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
-00016720: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00016730: 6565 7020 3230 272c 0a20 2020 2020 2020  eep 20',.       
-00016740: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00016750: 4555 455f 5741 4954 7d20 7c20 6772 6570  EUE_WAIT} | grep
-00016760: 207b 6e61 6d65 7d20 7c20 6772 6570 2053   {name} | grep S
-00016770: 5543 4345 4544 4544 272c 0a20 2020 2020  UCCEEDED',.     
-00016780: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
-00016790: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-000167a0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-000167b0: 6e61 6d65 292c 0a20 2020 2020 2020 2023  name),.        #
-000167c0: 2049 6e63 7265 6173 6520 7469 6d65 6f75   Increase timeou
-000167d0: 7420 7369 6e63 6520 736b 7920 7370 6f74  t since sky spot
-000167e0: 2071 7565 7565 202d 7220 6361 6e20 6265   queue -r can be
-000167f0: 2062 6c6f 636b 6564 2062 7920 6f74 6865   blocked by othe
-00016800: 7220 7370 6f74 2074 6573 7473 2e0a 2020  r spot tests..  
-00016810: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00016820: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00016830: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00016840: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00016850: 2d2d 2054 6573 7469 6e67 2065 6e76 202d  -- Testing env -
-00016860: 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620 7465  ---------.def te
-00016870: 7374 5f69 6e6c 696e 655f 656e 7628 6765  st_inline_env(ge
-00016880: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00016890: 293a 0a20 2020 2022 2222 5465 7374 2065  ):.    """Test e
-000168a0: 6e76 2222 220a 2020 2020 6e61 6d65 203d  nv""".    name =
-000168b0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-000168c0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000168d0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-000168e0: 6573 742d 696e 6c69 6e65 2d65 6e76 272c  est-inline-env',
-000168f0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00016900: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00016910: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d79  nch -c {name} -y
-00016920: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00016930: 635f 636c 6f75 647d 202d 2d65 6e76 2054  c_cloud} --env T
-00016940: 4553 545f 454e 563d 2268 656c 6c6f 2077  EST_ENV="hello w
-00016950: 6f72 6c64 2220 2d2d 2022 285b 5b20 2120  orld" -- "([[ ! 
-00016960: 2d7a 205c 5c22 5c24 5445 5354 5f45 4e56  -z \\"\$TEST_ENV
-00016970: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
-00016980: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
-00016990: 4e4f 4445 5f49 5053 5c5c 2220 5d5d 2026  NODE_IPS\\" ]] &
-000169a0: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
-000169b0: 4b59 5049 4c4f 545f 4e4f 4445 5f52 414e  KYPILOT_NODE_RAN
-000169c0: 4b5c 5c22 205d 5d29 207c 7c20 6578 6974  K\\" ]]) || exit
-000169d0: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
-000169e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000169f0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00016a00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00016a10: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00016a20: 2d65 6e76 2054 4553 545f 454e 5632 3d22  -env TEST_ENV2="
-00016a30: 7375 6363 6573 7322 2022 285b 5b20 2120  success" "([[ ! 
-00016a40: 2d7a 205c 5c22 5c24 5445 5354 5f45 4e56  -z \\"\$TEST_ENV
-00016a50: 325c 5c22 205d 5d20 2626 205b 5b20 2120  2\\" ]] && [[ ! 
-00016a60: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
-00016a70: 5f4e 4f44 455f 4950 535c 5c22 205d 5d20  _NODE_IPS\\" ]] 
-00016a80: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
-00016a90: 534b 5950 494c 4f54 5f4e 4f44 455f 5241  SKYPILOT_NODE_RA
-00016aa0: 4e4b 5c5c 2220 5d5d 2920 7c7c 2065 7869  NK\\" ]]) || exi
-00016ab0: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
-00016ac0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00016ad0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00016ae0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00016af0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00016b00: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00016b10: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00016b20: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00016b30: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00016b40: 656e 7620 6669 6c65 202d 2d2d 2d2d 2d2d  env file -------
-00016b50: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
-00016b60: 696e 655f 656e 765f 6669 6c65 2867 656e  ine_env_file(gen
-00016b70: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
-00016b80: 3a0a 2020 2020 2222 2254 6573 7420 656e  :.    """Test en
-00016b90: 7622 2222 0a20 2020 206e 616d 6520 3d20  v""".    name = 
-00016ba0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00016bb0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00016bc0: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
-00016bd0: 7374 2d69 6e6c 696e 652d 656e 762d 6669  st-inline-env-fi
-00016be0: 6c65 272c 0a20 2020 2020 2020 205b 0a20  le',.        [. 
-00016bf0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00016c00: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00016c10: 7d20 2d79 202d 2d63 6c6f 7564 207b 6765  } -y --cloud {ge
-00016c20: 6e65 7269 635f 636c 6f75 647d 202d 2d65  neric_cloud} --e
-00016c30: 6e76 2054 4553 545f 454e 563d 2268 656c  nv TEST_ENV="hel
-00016c40: 6c6f 2077 6f72 6c64 2220 2d2d 2022 285b  lo world" -- "([
-00016c50: 5b20 2120 2d7a 205c 5c22 5c24 5445 5354  [ ! -z \\"\$TEST
-00016c60: 5f45 4e56 5c5c 2220 5d5d 2026 2620 5b5b  _ENV\\" ]] && [[
-00016c70: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-00016c80: 4c4f 545f 4e4f 4445 5f49 5053 5c5c 2220  LOT_NODE_IPS\\" 
-00016c90: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-00016ca0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-00016cb0: 5f52 414e 4b5c 5c22 205d 5d29 207c 7c20  _RANK\\" ]]) || 
-00016cc0: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
-00016cd0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00016ce0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-00016cf0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00016d00: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00016d10: 657d 202d 2d65 6e76 2d66 696c 6520 6578  e} --env-file ex
-00016d20: 616d 706c 6573 2f73 616d 706c 655f 646f  amples/sample_do
-00016d30: 7465 6e76 2022 285b 5b20 2120 2d7a 205c  tenv "([[ ! -z \
-00016d40: 5c22 5c24 5445 5354 5f45 4e56 325c 5c22  \"\$TEST_ENV2\\"
-00016d50: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-00016d60: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-00016d70: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
-00016d80: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-00016d90: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
-00016da0: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
-00016db0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00016dc0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00016dd0: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-00016de0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00016df0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00016e00: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00016e10: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00016e20: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-00016e30: 2d2d 2d20 5465 7374 696e 6720 6375 7374  --- Testing cust
-00016e40: 6f6d 2069 6d61 6765 202d 2d2d 2d2d 2d2d  om image -------
-00016e50: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00016e60: 2e61 7773 0a64 6566 2074 6573 745f 6375  .aws.def test_cu
-00016e70: 7374 6f6d 5f69 6d61 6765 2829 3a0a 2020  stom_image():.  
-00016e80: 2020 2222 2254 6573 7420 6375 7374 6f6d    """Test custom
-00016e90: 2069 6d61 6765 2222 220a 2020 2020 6e61   image""".    na
-00016ea0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00016eb0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00016ec0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00016ed0: 2020 2774 6573 742d 6375 7374 6f6d 2d69    'test-custom-i
-00016ee0: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
-00016ef0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00016f00: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-00016f10: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
-00016f20: 6c2d 7570 202d 7920 6578 616d 706c 6573  l-up -y examples
-00016f30: 2f63 7573 746f 6d5f 696d 6167 652e 7961  /custom_image.ya
-00016f40: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00016f50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00016f60: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00016f70: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00016f80: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00016f90: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-00016fa0: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
-00016fb0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00016fc0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00016fd0: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-00016fe0: 6c6f 770a 6465 6620 7465 7374 5f61 7a75  low.def test_azu
-00016ff0: 7265 5f73 7461 7274 5f73 746f 705f 7477  re_start_stop_tw
-00017000: 6f5f 6e6f 6465 7328 293a 0a20 2020 206e  o_nodes():.    n
-00017010: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00017020: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00017030: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00017040: 2020 2027 617a 7572 652d 7374 6172 742d     'azure-start-
-00017050: 7374 6f70 2d74 776f 2d6e 6f64 6573 272c  stop-two-nodes',
-00017060: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00017070: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00017080: 6e63 6820 2d2d 6e75 6d2d 6e6f 6465 733d  nch --num-nodes=
-00017090: 3220 2d79 202d 6320 7b6e 616d 657d 2065  2 -y -c {name} e
-000170a0: 7861 6d70 6c65 732f 617a 7572 655f 7374  xamples/azure_st
-000170b0: 6172 745f 7374 6f70 2e79 616d 6c27 2c0a  art_stop.yaml',.
-000170c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000170d0: 7920 6578 6563 202d 2d6e 756d 2d6e 6f64  y exec --num-nod
-000170e0: 6573 3d32 207b 6e61 6d65 7d20 6578 616d  es=2 {name} exam
-000170f0: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
-00017100: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-00017110: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00017120: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00017130: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00017140: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00017150: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00017160: 2066 2773 6b79 2073 746f 7020 2d79 207b   f'sky stop -y {
-00017170: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00017180: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
-00017190: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-000171a0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000171b0: 6563 202d 2d6e 756d 2d6e 6f64 6573 3d32  ec --num-nodes=2
-000171c0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-000171d0: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
-000171e0: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-000171f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00017200: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00017210: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00017220: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00017230: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00017240: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00017250: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00017260: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-00017270: 3630 2c20 2023 2033 3020 6d69 6e73 2020  60,  # 30 mins  
-00017280: 2869 7420 7461 6b65 7320 6172 6f75 6e64  (it takes around
-00017290: 207e 3233 206d 696e 7329 0a20 2020 2029   ~23 mins).    )
-000172a0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000172b0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-000172c0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2065  ------ Testing e
-000172d0: 6e76 2066 6f72 2064 6973 6b20 7469 6572  nv for disk tier
-000172e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-000172f0: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
-00017300: 2074 6573 745f 6177 735f 6469 736b 5f74   test_aws_disk_t
-00017310: 6965 7228 293a 0a0a 2020 2020 6465 6620  ier():..    def 
-00017320: 5f67 6574 5f61 7773 5f71 7565 7279 5f63  _get_aws_query_c
-00017330: 6f6d 6d61 6e64 2872 6567 696f 6e2c 2069  ommand(region, i
-00017340: 6e73 7461 6e63 655f 6964 2c20 6669 656c  nstance_id, fiel
-00017350: 642c 2065 7870 6563 7465 6429 3a0a 2020  d, expected):.  
-00017360: 2020 2020 2020 7265 7475 726e 2028 6627        return (f'
-00017370: 6177 7320 6563 3220 6465 7363 7269 6265  aws ec2 describe
-00017380: 2d76 6f6c 756d 6573 202d 2d72 6567 696f  -volumes --regio
-00017390: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
-000173a0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-000173b0: 2d66 696c 7465 7273 204e 616d 653d 6174  -filters Name=at
-000173c0: 7461 6368 6d65 6e74 2e69 6e73 7461 6e63  tachment.instanc
-000173d0: 652d 6964 2c56 616c 7565 733d 7b69 6e73  e-id,Values={ins
-000173e0: 7461 6e63 655f 6964 7d20 270a 2020 2020  tance_id} '.    
-000173f0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-00017400: 7175 6572 7920 566f 6c75 6d65 735b 2a5d  query Volumes[*]
-00017410: 2e7b 6669 656c 647d 207c 2067 7265 7020  .{field} | grep 
-00017420: 7b65 7870 6563 7465 647d 203b 2027 290a  {expected} ; ').
-00017430: 0a20 2020 2066 6f72 2064 6973 6b5f 7469  .    for disk_ti
-00017440: 6572 2069 6e20 5b27 6c6f 7727 2c20 276d  er in ['low', 'm
-00017450: 6564 6975 6d27 2c20 2768 6967 6827 5d3a  edium', 'high']:
-00017460: 0a20 2020 2020 2020 2073 7065 6373 203d  .        specs =
-00017470: 2041 5753 2e5f 6765 745f 6469 736b 5f73   AWS._get_disk_s
-00017480: 7065 6373 2864 6973 6b5f 7469 6572 290a  pecs(disk_tier).
-00017490: 2020 2020 2020 2020 6e61 6d65 203d 205f          name = _
-000174a0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000174b0: 2829 202b 2027 2d27 202b 2064 6973 6b5f  () + '-' + disk_
-000174c0: 7469 6572 0a20 2020 2020 2020 2072 6567  tier.        reg
-000174d0: 696f 6e20 3d20 2775 732d 7765 7374 2d32  ion = 'us-west-2
-000174e0: 270a 2020 2020 2020 2020 7465 7374 203d  '.        test =
-000174f0: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-00017500: 2020 2027 6177 732d 6469 736b 2d74 6965     'aws-disk-tie
-00017510: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
-00017520: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00017530: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00017540: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00017550: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
-00017560: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
-00017570: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-00017580: 6469 736b 2d74 6965 7220 7b64 6973 6b5f  disk-tier {disk_
-00017590: 7469 6572 7d20 6563 686f 2022 6865 6c6c  tier} echo "hell
-000175a0: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
-000175b0: 2020 2020 2020 2020 2066 2769 643d 6061           f'id=`a
-000175c0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-000175d0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-000175e0: 6f6e 207b 7265 6769 6f6e 7d20 2d2d 6669  on {region} --fi
-000175f0: 6c74 6572 7320 270a 2020 2020 2020 2020  lters '.        
-00017600: 2020 2020 2020 2020 6627 4e61 6d65 3d74          f'Name=t
-00017610: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
-00017620: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
-00017630: 7d20 2d2d 7175 6572 7920 270a 2020 2020  } --query '.    
-00017640: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
-00017650: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00017660: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-00017670: 6549 6420 2d2d 6f75 7470 7574 2074 6578  eId --output tex
-00017680: 7460 3b20 2720 2b0a 2020 2020 2020 2020  t`; ' +.        
-00017690: 2020 2020 2020 2020 5f67 6574 5f61 7773          _get_aws
-000176a0: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
-000176b0: 6567 696f 6e2c 2027 2469 6427 2c20 2756  egion, '$id', 'V
-000176c0: 6f6c 756d 6554 7970 6527 2c0a 2020 2020  olumeType',.    
-000176d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176f0: 2020 2073 7065 6373 5b27 6469 736b 5f74     specs['disk_t
-00017700: 6965 7227 5d29 202b 0a20 2020 2020 2020  ier']) +.       
-00017710: 2020 2020 2020 2020 2028 2727 2069 6620           ('' if 
-00017720: 6469 736b 5f74 6965 7220 3d3d 2027 6c6f  disk_tier == 'lo
-00017730: 7727 2065 6c73 650a 2020 2020 2020 2020  w' else.        
-00017740: 2020 2020 2020 2020 2028 5f67 6574 5f61           (_get_a
-00017750: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
-00017760: 2872 6567 696f 6e2c 2027 2469 6427 2c20  (region, '$id', 
-00017770: 2749 6f70 7327 2c0a 2020 2020 2020 2020  'Iops',.        
-00017780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177a0: 2073 7065 6373 5b27 6469 736b 5f69 6f70   specs['disk_iop
-000177b0: 7327 5d29 202b 0a20 2020 2020 2020 2020  s']) +.         
-000177c0: 2020 2020 2020 2020 205f 6765 745f 6177           _get_aw
-000177d0: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
-000177e0: 7265 6769 6f6e 2c20 2724 6964 272c 2027  region, '$id', '
-000177f0: 5468 726f 7567 6870 7574 272c 0a20 2020  Throughput',.   
-00017800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017820: 2020 2020 2020 7370 6563 735b 2764 6973        specs['dis
-00017830: 6b5f 7468 726f 7567 6870 7574 275d 2929  k_throughput']))
-00017840: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
-00017850: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00017860: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00017870: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00017880: 2074 696d 656f 7574 3d31 3020 2a20 3630   timeout=10 * 60
-00017890: 2c20 2023 2031 3020 6d69 6e73 2020 2869  ,  # 10 mins  (i
-000178a0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-000178b0: 3620 6d69 6e73 290a 2020 2020 2020 2020  6 mins).        
-000178c0: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-000178d0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-000178e0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-000178f0: 6465 6620 7465 7374 5f67 6370 5f64 6973  def test_gcp_dis
-00017900: 6b5f 7469 6572 2829 3a0a 2020 2020 666f  k_tier():.    fo
-00017910: 7220 6469 736b 5f74 6965 7220 696e 205b  r disk_tier in [
-00017920: 276c 6f77 272c 2027 6d65 6469 756d 272c  'low', 'medium',
-00017930: 2027 6869 6768 275d 3a0a 2020 2020 2020   'high']:.      
-00017940: 2020 7479 7065 203d 2047 4350 2e5f 6765    type = GCP._ge
-00017950: 745f 6469 736b 5f74 7970 6528 6469 736b  t_disk_type(disk
-00017960: 5f74 6965 7229 0a20 2020 2020 2020 206e  _tier).        n
-00017970: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00017980: 6572 5f6e 616d 6528 2920 2b20 272d 2720  er_name() + '-' 
-00017990: 2b20 6469 736b 5f74 6965 720a 2020 2020  + disk_tier.    
-000179a0: 2020 2020 7265 6769 6f6e 203d 2027 7573      region = 'us
-000179b0: 2d77 6573 7432 270a 2020 2020 2020 2020  -west2'.        
-000179c0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000179d0: 2020 2020 2020 2020 2027 6763 702d 6469           'gcp-di
-000179e0: 736b 2d74 6965 7227 2c0a 2020 2020 2020  sk-tier',.      
-000179f0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00017a00: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00017a10: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00017a20: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
-00017a30: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-00017a40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00017a50: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
-00017a60: 7b64 6973 6b5f 7469 6572 7d20 6563 686f  {disk_tier} echo
-00017a70: 2022 6865 6c6c 6f20 736b 7922 272c 0a20   "hello sky"',. 
-00017a80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017a90: 276e 616d 653d 6067 636c 6f75 6420 636f  'name=`gcloud co
-00017aa0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-00017ab0: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
-00017ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ad0: 6627 226c 6162 656c 732e 7261 792d 636c  f'"labels.ray-cl
-00017ae0: 7573 7465 722d 6e61 6d65 3a7b 6e61 6d65  uster-name:{name
-00017af0: 7d22 202d 2d66 6f72 6d61 743d 2276 616c  }" --format="val
-00017b00: 7565 286e 616d 6529 2260 3b20 270a 2020  ue(name)"`; '.  
-00017b10: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00017b20: 6763 6c6f 7564 2063 6f6d 7075 7465 2064  gcloud compute d
-00017b30: 6973 6b73 206c 6973 7420 2d2d 6669 6c74  isks list --filt
-00017b40: 6572 3d22 6e61 6d65 3d24 6e61 6d65 2220  er="name=$name" 
-00017b50: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00017b60: 2020 6627 2d2d 666f 726d 6174 3d22 7661    f'--format="va
-00017b70: 6c75 6528 7479 7065 2922 207c 2067 7265  lue(type)" | gre
-00017b80: 7020 7b74 7970 657d 2027 0a20 2020 2020  p {type} '.     
-00017b90: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00017ba0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00017bb0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00017bc0: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
-00017bd0: 3d36 202a 2036 302c 2020 2320 3620 6d69  =6 * 60,  # 6 mi
-00017be0: 6e73 2020 2869 7420 7461 6b65 7320 6172  ns  (it takes ar
-00017bf0: 6f75 6e64 207e 3320 6d69 6e73 290a 2020  ound ~3 mins).  
-00017c00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00017c10: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00017c20: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00017c30: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
-00017c40: 5f61 7a75 7265 5f64 6973 6b5f 7469 6572  _azure_disk_tier
-00017c50: 2829 3a0a 2020 2020 666f 7220 6469 736b  ():.    for disk
-00017c60: 5f74 6965 7220 696e 205b 276c 6f77 272c  _tier in ['low',
-00017c70: 2027 6d65 6469 756d 275d 3a0a 2020 2020   'medium']:.    
-00017c80: 2020 2020 7479 7065 203d 2041 7a75 7265      type = Azure
-00017c90: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
-00017ca0: 6469 736b 5f74 6965 7229 0a20 2020 2020  disk_tier).     
-00017cb0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00017cc0: 6c75 7374 6572 5f6e 616d 6528 2920 2b20  luster_name() + 
-00017cd0: 272d 2720 2b20 6469 736b 5f74 6965 720a  '-' + disk_tier.
-00017ce0: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
-00017cf0: 2027 7765 7374 7573 3227 0a20 2020 2020   'westus2'.     
-00017d00: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00017d10: 2020 2020 2020 2020 2020 2020 2761 7a75              'azu
-00017d20: 7265 2d64 6973 6b2d 7469 6572 272c 0a20  re-disk-tier',. 
-00017d30: 2020 2020 2020 2020 2020 205b 0a20 2020             [.   
-00017d40: 2020 2020 2020 2020 2020 2020 2066 2773               f's
-00017d50: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00017d60: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
-00017d70: 7a75 7265 202d 2d72 6567 696f 6e20 7b72  zure --region {r
-00017d80: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00017d90: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
-00017da0: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
-00017db0: 727d 2065 6368 6f20 2268 656c 6c6f 2073  r} echo "hello s
-00017dc0: 6b79 2227 2c0a 2020 2020 2020 2020 2020  ky"',.          
-00017dd0: 2020 2020 2020 6627 617a 2072 6573 6f75        f'az resou
-00017de0: 7263 6520 6c69 7374 202d 2d74 6167 2072  rce list --tag r
-00017df0: 6179 2d63 6c75 7374 6572 2d6e 616d 653d  ay-cluster-name=
-00017e00: 7b6e 616d 657d 202d 2d71 7565 7279 2027  {name} --query '
-00017e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017e20: 2066 2722 5b3f 7479 7065 3d3d 5c27 4d69   f'"[?type==\'Mi
-00017e30: 6372 6f73 6f66 742e 436f 6d70 7574 652f  crosoft.Compute/
-00017e40: 6469 736b 735c 275d 2e73 6b75 2e6e 616d  disks\'].sku.nam
-00017e50: 6522 2027 0a20 2020 2020 2020 2020 2020  e" '.           
-00017e60: 2020 2020 2066 272d 2d6f 7574 7075 7420       f'--output 
-00017e70: 7473 7620 7c20 6772 6570 207b 7479 7065  tsv | grep {type
-00017e80: 7d27 0a20 2020 2020 2020 2020 2020 205d  }'.            ]
-00017e90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00017ea0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00017eb0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00017ec0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00017ed0: 2c20 2023 2032 3020 6d69 6e73 2020 2869  ,  # 20 mins  (i
-00017ee0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-00017ef0: 3132 206d 696e 7329 0a20 2020 2020 2020  12 mins).       
-00017f00: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
-00017f10: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00017f20: 2320 2d2d 2d2d 2d2d 2054 6573 7469 6e67  # ------ Testing
-00017f30: 205a 6572 6f20 5175 6f74 6120 4661 696c   Zero Quota Fail
-00017f40: 6f76 6572 202d 2d2d 2d2d 2d0a 4070 7974  over ------.@pyt
-00017f50: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
-00017f60: 2074 6573 745f 6177 735f 7a65 726f 5f71   test_aws_zero_q
-00017f70: 756f 7461 5f66 6169 6c6f 7665 7228 293a  uota_failover():
-00017f80: 0a0a 2020 2020 6e61 6d65 203d 205f 6765  ..    name = _ge
-00017f90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00017fa0: 0a20 2020 2072 6567 696f 6e20 3d20 6765  .    region = ge
-00017fb0: 745f 6177 735f 7265 6769 6f6e 5f66 6f72  t_aws_region_for
-00017fc0: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
-00017fd0: 290a 0a20 2020 2069 6620 6e6f 7420 7265  )..    if not re
-00017fe0: 6769 6f6e 3a0a 2020 2020 2020 2020 7079  gion:.        py
-00017ff0: 7465 7374 2e78 6661 696c 280a 2020 2020  test.xfail(.    
-00018000: 2020 2020 2020 2020 2755 6e61 626c 6520          'Unable 
-00018010: 746f 2074 6573 7420 7a65 726f 2071 756f  to test zero quo
-00018020: 7461 2066 6169 6c6f 7665 7220 6f70 7469  ta failover opti
-00018030: 6d69 7a61 7469 6f6e 20e2 8094 2071 756f  mization ... quo
-00018040: 7461 7320 270a 2020 2020 2020 2020 2020  tas '.          
-00018050: 2020 2766 6f72 2045 4332 2050 3320 696e    'for EC2 P3 in
-00018060: 7374 616e 6365 7320 7765 7265 2066 6f75  stances were fou
-00018070: 6e64 206f 6e20 616c 6c20 4157 5320 7265  nd on all AWS re
-00018080: 6769 6f6e 732e 2049 7320 7468 6973 2027  gions. Is this '
-00018090: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
-000180a0: 7065 6374 6564 2066 6f72 2079 6f75 7220  pected for your 
-000180b0: 6163 636f 756e 743f 2729 0a20 2020 2020  account?').     
-000180c0: 2020 2072 6574 7572 6e0a 0a20 2020 2074     return..    t
-000180d0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000180e0: 2020 2020 2761 7773 2d7a 6572 6f2d 7175      'aws-zero-qu
-000180f0: 6f74 612d 6661 696c 6f76 6572 272c 0a20  ota-failover',. 
-00018100: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00018110: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00018120: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00018130: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
-00018140: 696f 6e20 7b72 6567 696f 6e7d 202d 2d67  ion {region} --g
-00018150: 7075 7320 5631 3030 3a38 202d 2d75 7365  pus V100:8 --use
-00018160: 2d73 706f 7420 7c20 6772 6570 2022 466f  -spot | grep "Fo
-00018170: 756e 6420 6e6f 2071 756f 7461 2227 2c0a  und no quota"',.
-00018180: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00018190: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-000181a0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-000181b0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000181c0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-000181d0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-000181e0: 7374 5f67 6370 5f7a 6572 6f5f 7175 6f74  st_gcp_zero_quot
-000181f0: 615f 6661 696c 6f76 6572 2829 3a0a 0a20  a_failover():.. 
-00018200: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00018210: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00018220: 2020 7265 6769 6f6e 203d 2067 6574 5f67    region = get_g
-00018230: 6370 5f72 6567 696f 6e5f 666f 725f 7175  cp_region_for_qu
-00018240: 6f74 615f 6661 696c 6f76 6572 2829 0a0a  ota_failover()..
-00018250: 2020 2020 6966 206e 6f74 2072 6567 696f      if not regio
-00018260: 6e3a 0a20 2020 2020 2020 2070 7974 6573  n:.        pytes
-00018270: 742e 7866 6169 6c28 0a20 2020 2020 2020  t.xfail(.       
-00018280: 2020 2020 2027 556e 6162 6c65 2074 6f20       'Unable to 
-00018290: 7465 7374 207a 6572 6f20 7175 6f74 6120  test zero quota 
-000182a0: 6661 696c 6f76 6572 206f 7074 696d 697a  failover optimiz
-000182b0: 6174 696f 6e20 e280 9420 7175 6f74 6173  ation ... quotas
-000182c0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-000182d0: 666f 7220 4131 3030 2d38 3047 4220 4750  for A100-80GB GP
-000182e0: 5573 2077 6572 6520 666f 756e 6420 6f6e  Us were found on
-000182f0: 2061 6c6c 2047 4350 2072 6567 696f 6e73   all GCP regions
-00018300: 2e20 4973 2074 6869 7320 270a 2020 2020  . Is this '.    
-00018310: 2020 2020 2020 2020 2765 7870 6563 7465          'expecte
-00018320: 6420 666f 7220 796f 7572 2061 6363 6f75  d for your accou
-00018330: 6e74 3f27 290a 2020 2020 2020 2020 7265  nt?').        re
-00018340: 7475 726e 0a0a 2020 2020 7465 7374 203d  turn..    test =
-00018350: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00018360: 6763 702d 7a65 726f 2d71 756f 7461 2d66  gcp-zero-quota-f
-00018370: 6169 6c6f 7665 7227 2c0a 2020 2020 2020  ailover',.      
-00018380: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00018390: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-000183a0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-000183b0: 6420 6763 7020 2d2d 7265 6769 6f6e 207b  d gcp --region {
-000183c0: 7265 6769 6f6e 7d20 2d2d 6770 7573 2041  region} --gpus A
-000183d0: 3130 302d 3830 4742 3a31 202d 2d75 7365  100-80GB:1 --use
-000183e0: 2d73 706f 7420 7c20 6772 6570 2022 466f  -spot | grep "Fo
-000183f0: 756e 6420 6e6f 2071 756f 7461 2227 2c0a  und no quota"',.
-00018400: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00018410: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00018420: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-00018430: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00018440: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00018450: 2d2d 2054 6573 7469 6e67 2075 7365 7220  -- Testing user 
-00018460: 7261 7920 636c 7573 7465 7220 2d2d 2d2d  ray cluster ----
-00018470: 2d2d 2d2d 0a64 6566 2074 6573 745f 7573  ----.def test_us
-00018480: 6572 5f72 6179 5f63 6c75 7374 6572 2829  er_ray_cluster()
-00018490: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-000184a0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-000184b0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-000184c0: 280a 2020 2020 2020 2020 2775 7365 722d  (.        'user-
-000184d0: 7261 792d 636c 7573 7465 7227 2c0a 2020  ray-cluster',.  
-000184e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000184f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00018500: 202d 7920 2d63 207b 6e61 6d65 7d20 2272   -y -c {name} "r
-00018510: 6179 2073 7461 7274 202d 2d68 6561 6422  ay start --head"
-00018520: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018530: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00018540: 2022 6563 686f 2068 6922 272c 0a20 2020   "echo hi"',.   
-00018550: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00018560: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00018570: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00018580: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00018590: 202d 7220 7c20 6772 6570 207b 6e61 6d65   -r | grep {name
-000185a0: 7d20 7c20 6772 6570 2055 5027 2c0a 2020  } | grep UP',.  
-000185b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000185c0: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
-000185d0: 6f20 6279 6522 272c 0a20 2020 2020 2020  o bye"',.       
-000185e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000185f0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00018600: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-00018610: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00018620: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00018630: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00018640: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00018650: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2074  ------ Testing t
-00018660: 6865 2063 6f72 6520 4150 4920 2d2d 2d2d  he core API ----
-00018670: 2d2d 2d2d 0a23 204d 6f73 7420 6f66 2074  ----.# Most of t
-00018680: 6865 2063 6f72 6520 4150 4973 2068 6176  he core APIs hav
-00018690: 6520 6265 656e 2074 6573 7465 6420 696e  e been tested in
-000186a0: 2074 6865 2043 4c49 2074 6573 7473 2e0a   the CLI tests..
-000186b0: 2320 5468 6573 6520 7465 7374 7320 6172  # These tests ar
-000186c0: 6520 666f 7220 7465 7374 696e 6720 7468  e for testing th
-000186d0: 6520 7265 7475 726e 2076 616c 7565 206f  e return value o
-000186e0: 6620 7468 6520 4150 4973 206e 6f74 2066  f the APIs not f
-000186f0: 756c 6c79 2075 7365 6420 696e 2043 4c49  ully used in CLI
-00018700: 2e0a 6465 6620 7465 7374 5f63 6f72 655f  ..def test_core_
-00018710: 6170 6928 293a 0a20 2020 206e 616d 6520  api():.    name 
-00018720: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00018730: 616d 6528 290a 2020 2020 736b 792e 6c61  ame().    sky.la
-00018740: 756e 6368 0a20 2020 2023 2054 4f44 4f28  unch.    # TODO(
-00018750: 7a68 7775 293a 2041 6464 2061 2074 6573  zhwu): Add a tes
-00018760: 7420 666f 7220 636f 7265 2061 7069 2e0a  t for core api..
-00018770: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-00018780: 6573 7469 6e67 2053 746f 7261 6765 202d  esting Storage -
-00018790: 2d2d 2d2d 2d2d 2d2d 2d0a 636c 6173 7320  ---------.class 
-000187a0: 5465 7374 5374 6f72 6167 6557 6974 6843  TestStorageWithC
-000187b0: 7265 6465 6e74 6961 6c73 3a0a 2020 2020  redentials:.    
-000187c0: 2222 2253 746f 7261 6765 2074 6573 7473  """Storage tests
-000187d0: 2077 6869 6368 2072 6571 7569 7265 2063   which require c
-000187e0: 7265 6465 6e74 6961 6c73 2061 6e64 206e  redentials and n
-000187f0: 6574 776f 726b 2063 6f6e 6e65 6374 696f  etwork connectio
-00018800: 6e22 2222 0a0a 2020 2020 4157 535f 494e  n"""..    AWS_IN
-00018810: 5641 4c49 445f 4e41 4d45 5320 3d20 5b0a  VALID_NAMES = [.
-00018820: 2020 2020 2020 2020 2761 6227 2c20 2023          'ab',  #
-00018830: 206c 6573 7320 7468 616e 2033 2063 6861   less than 3 cha
-00018840: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00018850: 2761 6263 6465 6667 6869 6a6b 6c6d 6e6f  'abcdefghijklmno
-00018860: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
-00018870: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-00018880: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00018890: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
-000188a0: 272c 0a20 2020 2020 2020 2023 206d 6f72  ',.        # mor
-000188b0: 6520 7468 616e 2036 3320 6368 6172 6163  e than 63 charac
-000188c0: 7465 7273 0a20 2020 2020 2020 2027 4162  ters.        'Ab
-000188d0: 6364 6566 272c 2020 2320 636f 6e74 6169  cdef',  # contai
-000188e0: 6e73 2061 6e20 7570 7065 7263 6173 6520  ns an uppercase 
-000188f0: 6c65 7474 6572 0a20 2020 2020 2020 2027  letter.        '
-00018900: 6162 6320 6465 6627 2c20 2023 2063 6f6e  abc def',  # con
-00018910: 7461 696e 7320 6120 7370 6163 650a 2020  tains a space.  
-00018920: 2020 2020 2020 2761 6263 2e2e 6465 6627        'abc..def'
-00018930: 2c20 2023 2074 776f 2061 646a 6163 656e  ,  # two adjacen
-00018940: 7420 7065 7269 6f64 730a 2020 2020 2020  t periods.      
-00018950: 2020 2731 3932 2e31 3638 2e35 2e34 272c    '192.168.5.4',
-00018960: 2020 2320 666f 726d 6174 7465 6420 6173    # formatted as
-00018970: 2061 6e20 4950 2061 6464 7265 7373 0a20   an IP address. 
-00018980: 2020 2020 2020 2027 786e 2d2d 6275 636b         'xn--buck
-00018990: 6574 272c 2020 2320 7374 6172 7473 2077  et',  # starts w
-000189a0: 6974 6820 2778 6e2d 2d27 2070 7265 6669  ith 'xn--' prefi
-000189b0: 780a 2020 2020 2020 2020 2762 7563 6b65  x.        'bucke
-000189c0: 742d 7333 616c 6961 7327 2c20 2023 2065  t-s3alias',  # e
-000189d0: 6e64 7320 7769 7468 2027 2d73 3361 6c69  nds with '-s3ali
-000189e0: 6173 2720 7375 6666 6978 0a20 2020 2020  as' suffix.     
-000189f0: 2020 2027 6275 636b 6574 2d2d 6f6c 2d73     'bucket--ol-s
-00018a00: 3327 2c20 2023 2065 6e64 7320 7769 7468  3',  # ends with
-00018a10: 2027 2d2d 6f6c 2d73 3327 2073 7566 6669   '--ol-s3' suffi
-00018a20: 780a 2020 2020 2020 2020 272e 6162 6327  x.        '.abc'
-00018a30: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
-00018a40: 2061 2064 6f74 0a20 2020 2020 2020 2027   a dot.        '
-00018a50: 6162 632e 272c 2020 2320 656e 6473 2077  abc.',  # ends w
-00018a60: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
-00018a70: 2020 272d 6162 6327 2c20 2023 2073 7461    '-abc',  # sta
-00018a80: 7274 7320 7769 7468 2061 2068 7970 6865  rts with a hyphe
-00018a90: 6e0a 2020 2020 2020 2020 2761 6263 2d27  n.        'abc-'
-00018aa0: 2c20 2023 2065 6e64 7320 7769 7468 2061  ,  # ends with a
-00018ab0: 2068 7970 6865 6e0a 2020 2020 5d0a 0a20   hyphen.    ].. 
-00018ac0: 2020 2047 4353 5f49 4e56 414c 4944 5f4e     GCS_INVALID_N
-00018ad0: 414d 4553 203d 205b 0a20 2020 2020 2020  AMES = [.       
-00018ae0: 2027 6162 272c 2020 2320 6c65 7373 2074   'ab',  # less t
-00018af0: 6861 6e20 3320 6368 6172 6163 7465 7273  han 3 characters
-00018b00: 0a20 2020 2020 2020 2027 6162 6364 6566  .        'abcdef
-00018b10: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
-00018b20: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
-00018b30: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
-00018b40: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
-00018b50: 7374 7576 7778 797a 3127 2c0a 2020 2020  stuvwxyz1',.    
-00018b60: 2020 2020 2320 6d6f 7265 2074 6861 6e20      # more than 
-00018b70: 3633 2063 6861 7261 6374 6572 7320 2877  63 characters (w
-00018b80: 6974 686f 7574 2064 6f74 7329 0a20 2020  ithout dots).   
-00018b90: 2020 2020 2027 4162 6364 6566 272c 2020       'Abcdef',  
-00018ba0: 2320 636f 6e74 6169 6e73 2061 6e20 7570  # contains an up
-00018bb0: 7065 7263 6173 6520 6c65 7474 6572 0a20  percase letter. 
-00018bc0: 2020 2020 2020 2027 6162 6320 6465 6627         'abc def'
-00018bd0: 2c20 2023 2063 6f6e 7461 696e 7320 6120  ,  # contains a 
-00018be0: 7370 6163 650a 2020 2020 2020 2020 2761  space.        'a
-00018bf0: 6263 2e2e 6465 6627 2c20 2023 2074 776f  bc..def',  # two
-00018c00: 2061 646a 6163 656e 7420 7065 7269 6f64   adjacent period
-00018c10: 730a 2020 2020 2020 2020 2761 6263 5f2e  s.        'abc_.
-00018c20: 6465 662e 6768 692e 6a6b 6c6d 6e6f 7071  def.ghi.jklmnopq
-00018c30: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00018c40: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00018c50: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
-00018c60: 6e6f 7071 7273 7475 7677 7879 7a31 270a  nopqrstuvwxyz1'.
-00018c70: 2020 2020 2020 2020 2320 4d6f 7265 2074          # More t
-00018c80: 6861 6e20 3633 2063 6861 7261 6374 6572  han 63 character
-00018c90: 7320 6265 7477 6565 6e20 646f 7473 0a20  s between dots. 
-00018ca0: 2020 2020 2020 2027 6162 635f 2e64 6566         'abc_.def
-00018cb0: 2e67 6869 2e6a 6b6c 6d6e 6f70 7172 7374  .ghi.jklmnopqrst
-00018cc0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00018cd0: 6b6c 6d6e 6f70 7166 6768 696a 6b6c 6d6e  klmnopqfghijklmn
-00018ce0: 6f70 7172 7374 7576 7727 202a 2035 2c0a  opqrstuvw' * 5,.
-00018cf0: 2020 2020 2020 2020 2320 6d6f 7265 2074          # more t
-00018d00: 6861 6e20 3232 3220 6368 6172 6163 7465  han 222 characte
-00018d10: 7273 2028 7769 7468 2064 6f74 7329 0a20  rs (with dots). 
-00018d20: 2020 2020 2020 2027 3139 322e 3136 382e         '192.168.
-00018d30: 352e 3427 2c20 2023 2066 6f72 6d61 7474  5.4',  # formatt
-00018d40: 6564 2061 7320 616e 2049 5020 6164 6472  ed as an IP addr
-00018d50: 6573 730a 2020 2020 2020 2020 2767 6f6f  ess.        'goo
-00018d60: 6762 7563 6b65 7427 2c20 2023 2073 7461  gbucket',  # sta
-00018d70: 7274 7320 7769 7468 2027 676f 6f67 2720  rts with 'goog' 
-00018d80: 7072 6566 6978 0a20 2020 2020 2020 2027  prefix.        '
-00018d90: 676f 6f67 6c65 6275 636b 6574 272c 2020  googlebucket',  
-00018da0: 2320 636f 6e74 6169 6e73 2027 676f 6f67  # contains 'goog
-00018db0: 6c65 270a 2020 2020 2020 2020 2767 3030  le'.        'g00
-00018dc0: 676c 6562 7563 6b65 7427 2c20 2023 2076  glebucket',  # v
-00018dd0: 6172 6961 6e74 206f 6620 2767 6f6f 676c  ariant of 'googl
-00018de0: 6527 0a20 2020 2020 2020 2027 676f 3067  e'.        'go0g
-00018df0: 6c65 6275 636b 6574 272c 2020 2320 7661  lebucket',  # va
-00018e00: 7269 616e 7420 6f66 2027 676f 6f67 6c65  riant of 'google
-00018e10: 270a 2020 2020 2020 2020 2767 306f 676c  '.        'g0ogl
-00018e20: 6562 7563 6b65 7427 2c20 2023 2076 6172  ebucket',  # var
-00018e30: 6961 6e74 206f 6620 2767 6f6f 676c 6527  iant of 'google'
-00018e40: 0a20 2020 2020 2020 2027 2e61 6263 272c  .        '.abc',
-00018e50: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
-00018e60: 6120 646f 740a 2020 2020 2020 2020 2761  a dot.        'a
-00018e70: 6263 2e27 2c20 2023 2065 6e64 7320 7769  bc.',  # ends wi
-00018e80: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00018e90: 2027 5f61 6263 272c 2020 2320 7374 6172   '_abc',  # star
-00018ea0: 7473 2077 6974 6820 616e 2075 6e64 6572  ts with an under
-00018eb0: 7363 6f72 650a 2020 2020 2020 2020 2761  score.        'a
-00018ec0: 6263 5f27 2c20 2023 2065 6e64 7320 7769  bc_',  # ends wi
-00018ed0: 7468 2061 6e20 756e 6465 7273 636f 7265  th an underscore
-00018ee0: 0a20 2020 205d 0a0a 2020 2020 4749 5449  .    ]..    GITI
-00018ef0: 474e 4f52 455f 5359 4e43 5f54 4553 545f  GNORE_SYNC_TEST_
-00018f00: 4449 525f 5354 5255 4354 5552 4520 3d20  DIR_STRUCTURE = 
-00018f10: 7b0a 2020 2020 2020 2020 2764 6f75 626c  {.        'doubl
-00018f20: 655f 6173 7465 7269 736b 273a 207b 0a20  e_asterisk': {. 
-00018f30: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
-00018f40: 6c65 5f61 7374 6572 6973 6b5f 6578 636c  le_asterisk_excl
-00018f50: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-00018f60: 2020 2020 2020 2020 2027 646f 7562 6c65           'double
-00018f70: 5f61 7374 6572 6973 6b5f 6578 636c 7564  _asterisk_exclud
-00018f80: 6564 5f64 6972 273a 207b 0a20 2020 2020  ed_dir': {.     
-00018f90: 2020 2020 2020 2020 2020 2027 6469 725f             'dir_
-00018fa0: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
-00018fb0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-00018fc0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00018fd0: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
-00018fe0: 6973 6b5f 7061 7265 6e74 273a 207b 0a20  isk_parent': {. 
-00018ff0: 2020 2020 2020 2020 2020 2027 7061 7265             'pare
-00019000: 6e74 273a 207b 0a20 2020 2020 2020 2020  nt': {.         
-00019010: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
-00019020: 6c75 6465 642e 7478 7427 3a20 4e6f 6e65  luded.txt': None
-00019030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00019040: 2020 2763 6869 6c64 273a 207b 0a20 2020    'child': {.   
-00019050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019060: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
-00019070: 6b5f 7061 7265 6e74 5f63 6869 6c64 5f65  k_parent_child_e
-00019080: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
-00019090: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000190a0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-000190b0: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-000190c0: 7374 6572 6973 6b5f 7061 7265 6e74 5f65  sterisk_parent_e
-000190d0: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
-000190e0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-000190f0: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
-00019100: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
-00019110: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
-00019120: 2020 2020 2765 7863 6c75 6465 645f 6469      'excluded_di
-00019130: 7227 3a20 7b0a 2020 2020 2020 2020 2020  r': {.          
-00019140: 2020 2765 7863 6c75 6465 642e 7478 7427    'excluded.txt'
-00019150: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00019160: 2020 2020 276e 6573 7465 645f 6578 636c      'nested_excl
-00019170: 7564 6564 273a 207b 0a20 2020 2020 2020  uded': {.       
-00019180: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00019190: 6564 273a 204e 6f6e 652c 0a20 2020 2020  ed': None,.     
-000191a0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000191b0: 2020 7d2c 0a20 2020 2020 2020 2027 6578    },.        'ex
-000191c0: 702d 3127 3a20 7b0a 2020 2020 2020 2020  p-1': {.        
-000191d0: 2020 2020 2762 655f 6578 636c 7564 6564      'be_excluded
-000191e0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-000191f0: 207d 2c0a 2020 2020 2020 2020 2765 7870   },.        'exp
-00019200: 2d32 273a 207b 0a20 2020 2020 2020 2020  -2': {.         
-00019210: 2020 2027 6265 5f65 7863 6c75 6465 6427     'be_excluded'
-00019220: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00019230: 7d2c 0a20 2020 2020 2020 2027 6672 6f6e  },.        'fron
-00019240: 745f 736c 6173 685f 6578 636c 7564 6564  t_slash_excluded
-00019250: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00019260: 2027 696e 636c 7564 6564 2e6c 6f67 273a   'included.log':
-00019270: 204e 6f6e 652c 0a20 2020 2020 2020 2027   None,.        '
-00019280: 696e 636c 7564 6564 2e74 7874 273a 204e  included.txt': N
-00019290: 6f6e 652c 0a20 2020 2020 2020 2027 696e  one,.        'in
-000192a0: 636c 7564 655f 6469 7227 3a20 7b0a 2020  clude_dir': {.  
-000192b0: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-000192c0: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
-000192d0: 2020 2020 2020 2020 2020 2020 2769 6e63              'inc
-000192e0: 6c75 6465 642e 6c6f 6727 3a20 4e6f 6e65  luded.log': None
-000192f0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
-00019300: 2020 2020 2027 6e65 7374 6564 5f64 6f75       'nested_dou
-00019310: 626c 655f 6173 7465 7269 736b 273a 207b  ble_asterisk': {
-00019320: 0a20 2020 2020 2020 2020 2020 2027 6f6e  .            'on
-00019330: 6527 3a20 7b0a 2020 2020 2020 2020 2020  e': {.          
-00019340: 2020 2020 2020 2761 6c73 6f5f 6578 636c        'also_excl
-00019350: 7564 652e 7478 7427 3a20 4e6f 6e65 2c0a  ude.txt': None,.
-00019360: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00019370: 2020 2020 2020 2020 2020 2027 7477 6f27             'two'
-00019380: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
-00019390: 2020 2020 2761 6c73 6f5f 6578 636c 7564      'also_exclud
-000193a0: 652e 7478 7427 3a20 4e6f 6e65 2c0a 2020  e.txt': None,.  
-000193b0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-000193c0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000193d0: 276e 6573 7465 645f 7769 6c64 6361 7264  'nested_wildcard
-000193e0: 5f64 6972 273a 207b 0a20 2020 2020 2020  _dir': {.       
-000193f0: 2020 2020 2027 6d6f 6e64 6179 273a 207b       'monday': {
-00019400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019410: 2027 616c 736f 5f65 7863 6c75 6465 2e74   'also_exclude.t
-00019420: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
-00019430: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-00019440: 2020 2020 2020 2774 7565 7364 6179 273a        'tuesday':
-00019450: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00019460: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
-00019470: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00019480: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00019490: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-000194a0: 6e6f 5f73 6c61 7368 5f65 7863 6c75 6465  no_slash_exclude
-000194b0: 6427 3a20 4e6f 6e65 2c0a 2020 2020 2020  d': None,.      
-000194c0: 2020 276e 6f5f 736c 6173 685f 7465 7374    'no_slash_test
-000194d0: 7327 3a20 7b0a 2020 2020 2020 2020 2020  s': {.          
-000194e0: 2020 276e 6f5f 736c 6173 685f 6578 636c    'no_slash_excl
-000194f0: 7564 6564 273a 207b 0a20 2020 2020 2020  uded': {.       
-00019500: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
-00019510: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
-00019520: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00019530: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
-00019540: 2020 2020 2020 2771 7565 7374 696f 6e5f        'question_
-00019550: 6d61 726b 273a 207b 0a20 2020 2020 2020  mark': {.       
-00019560: 2020 2020 2027 6578 636c 7564 6564 312e       'excluded1.
-00019570: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00019580: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-00019590: 6440 2e74 7874 273a 204e 6f6e 652c 0a20  d@.txt': None,. 
-000195a0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000195b0: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
-000195c0: 7427 3a20 7b0a 2020 2020 2020 2020 2020  t': {.          
-000195d0: 2020 2765 7863 6c75 6465 6431 2e74 7874    'excluded1.txt
-000195e0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-000195f0: 207d 2c0a 2020 2020 2020 2020 2773 7175   },.        'squ
-00019600: 6172 655f 6272 6163 6b65 745f 616c 7068  are_bracket_alph
-00019610: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
-00019620: 2020 2765 7863 6c75 6465 647a 2e74 7874    'excludedz.txt
-00019630: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00019640: 207d 2c0a 2020 2020 2020 2020 2773 7175   },.        'squ
-00019650: 6172 655f 6272 6163 6b65 745f 6578 636c  are_bracket_excl
-00019660: 6127 3a20 7b0a 2020 2020 2020 2020 2020  a': {.          
-00019670: 2020 2765 7863 6c75 6465 6432 2e74 7874    'excluded2.txt
-00019680: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00019690: 2020 2020 2027 6578 636c 7564 6564 402e       'excluded@.
-000196a0: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-000196b0: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-000196c0: 7371 7561 7265 5f62 7261 636b 6574 5f73  square_bracket_s
-000196d0: 696e 676c 6527 3a20 7b0a 2020 2020 2020  ingle': {.      
-000196e0: 2020 2020 2020 2765 7863 6c75 6465 6430        'excluded0
-000196f0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00019700: 2020 2020 207d 2c0a 2020 2020 7d0a 0a20       },.    }.. 
-00019710: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
-00019720: 0a20 2020 2064 6566 2063 7265 6174 655f  .    def create_
-00019730: 6469 725f 7374 7275 6374 7572 6528 6261  dir_structure(ba
-00019740: 7365 5f70 6174 682c 2073 7472 7563 7475  se_path, structu
-00019750: 7265 293a 0a20 2020 2020 2020 2023 2063  re):.        # c
-00019760: 7265 6174 6573 2061 2067 6976 656e 2066  reates a given f
-00019770: 696c 6520 5354 5255 4354 5552 4520 696e  ile STRUCTURE in
-00019780: 2042 4153 455f 5041 5448 0a20 2020 2020   BASE_PATH.     
-00019790: 2020 2066 6f72 206e 616d 652c 2073 7562     for name, sub
-000197a0: 7374 7275 6374 7572 6520 696e 2073 7472  structure in str
-000197b0: 7563 7475 7265 2e69 7465 6d73 2829 3a0a  ucture.items():.
-000197c0: 2020 2020 2020 2020 2020 2020 7061 7468              path
-000197d0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-000197e0: 6261 7365 5f70 6174 682c 206e 616d 6529  base_path, name)
-000197f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00019800: 7375 6273 7472 7563 7475 7265 2069 7320  substructure is 
-00019810: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00019820: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
-00019830: 2066 696c 650a 2020 2020 2020 2020 2020   file.          
-00019840: 2020 2020 2020 6f70 656e 2870 6174 682c        open(path,
-00019850: 2027 6127 292e 636c 6f73 6528 290a 2020   'a').close().  
-00019860: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00019870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019880: 2320 4372 6561 7465 2061 2073 7562 6469  # Create a subdi
-00019890: 7265 6374 6f72 790a 2020 2020 2020 2020  rectory.        
-000198a0: 2020 2020 2020 2020 6f73 2e6d 6b64 6972          os.mkdir
-000198b0: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
-000198c0: 2020 2020 2020 2054 6573 7453 746f 7261         TestStora
-000198d0: 6765 5769 7468 4372 6564 656e 7469 616c  geWithCredential
-000198e0: 732e 6372 6561 7465 5f64 6972 5f73 7472  s.create_dir_str
-000198f0: 7563 7475 7265 280a 2020 2020 2020 2020  ucture(.        
-00019900: 2020 2020 2020 2020 2020 2020 7061 7468              path
-00019910: 2c20 7375 6273 7472 7563 7475 7265 290a  , substructure).
-00019920: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-00019930: 6f64 0a20 2020 2064 6566 2063 6c69 5f64  od.    def cli_d
-00019940: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
-00019950: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-00019960: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
-00019970: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-00019980: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00019990: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
-000199a0: 2020 2075 726c 203d 2066 2773 333a 2f2f     url = f's3://
-000199b0: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-000199c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000199d0: 6e20 6627 6177 7320 7333 2072 6220 7b75  n f'aws s3 rb {u
-000199e0: 726c 7d20 2d2d 666f 7263 6527 0a20 2020  rl} --force'.   
-000199f0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00019a00: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00019a10: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
-00019a20: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-00019a30: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
-00019a40: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
-00019a50: 2020 2020 2067 7375 7469 6c5f 616c 6961       gsutil_alia
-00019a60: 732c 2061 6c69 6173 5f67 656e 203d 2064  s, alias_gen = d
-00019a70: 6174 615f 7574 696c 732e 6765 745f 6773  ata_utils.get_gs
-00019a80: 7574 696c 5f63 6f6d 6d61 6e64 2829 0a20  util_command(). 
-00019a90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00019aa0: 6e20 6627 7b61 6c69 6173 5f67 656e 7d3b  n f'{alias_gen};
-00019ab0: 207b 6773 7574 696c 5f61 6c69 6173 7d20   {gsutil_alias} 
-00019ac0: 726d 202d 7220 7b75 726c 7d27 0a20 2020  rm -r {url}'.   
-00019ad0: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00019ae0: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00019af0: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
-00019b00: 2020 2020 2020 2020 2020 2020 656e 6470              endp
-00019b10: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-00019b20: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-00019b30: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
-00019b40: 2020 2020 7572 6c20 3d20 6627 7333 3a2f      url = f's3:/
-00019b50: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
-00019b60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00019b70: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
-00019b80: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
-00019b90: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
-00019ba0: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
-00019bb0: 7d20 6177 7320 7333 2072 6220 7b75 726c  } aws s3 rb {url
-00019bc0: 7d20 2d2d 666f 7263 6520 2d2d 656e 6470  } --force --endp
-00019bd0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-00019be0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-00019bf0: 270a 0a20 2020 2040 7374 6174 6963 6d65  '..    @staticme
-00019c00: 7468 6f64 0a20 2020 2064 6566 2063 6c69  thod.    def cli
-00019c10: 5f6c 735f 636d 6428 7374 6f72 655f 7479  _ls_cmd(store_ty
-00019c20: 7065 2c20 6275 636b 6574 5f6e 616d 652c  pe, bucket_name,
-00019c30: 2073 7566 6669 783d 2727 293a 0a20 2020   suffix=''):.   
-00019c40: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00019c50: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00019c60: 622e 5374 6f72 6554 7970 652e 5333 3a0a  b.StoreType.S3:.
-00019c70: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00019c80: 7566 6669 783a 0a20 2020 2020 2020 2020  uffix:.         
-00019c90: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-00019ca0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-00019cb0: 7d2f 7b73 7566 6669 787d 270a 2020 2020  }/{suffix}'.    
-00019cc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00019cd0: 2020 2020 2020 2020 2020 2020 2020 7572                ur
-00019ce0: 6c20 3d20 6627 7333 3a2f 2f7b 6275 636b  l = f's3://{buck
-00019cf0: 6574 5f6e 616d 657d 270a 2020 2020 2020  et_name}'.      
-00019d00: 2020 2020 2020 7265 7475 726e 2066 2761        return f'a
-00019d10: 7773 2073 3320 6c73 207b 7572 6c7d 270a  ws s3 ls {url}'.
-00019d20: 2020 2020 2020 2020 6966 2073 746f 7265          if store
-00019d30: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-00019d40: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-00019d50: 4353 3a0a 2020 2020 2020 2020 2020 2020  CS:.            
-00019d60: 6966 2073 7566 6669 783a 0a20 2020 2020  if suffix:.     
-00019d70: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-00019d80: 2066 2767 733a 2f2f 7b62 7563 6b65 745f   f'gs://{bucket_
-00019d90: 6e61 6d65 7d2f 7b73 7566 6669 787d 270a  name}/{suffix}'.
-00019da0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00019db0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019dc0: 2020 7572 6c20 3d20 6627 6773 3a2f 2f7b    url = f'gs://{
-00019dd0: 6275 636b 6574 5f6e 616d 657d 270a 2020  bucket_name}'.  
-00019de0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00019df0: 2066 2767 7375 7469 6c20 6c73 207b 7572   f'gsutil ls {ur
-00019e00: 6c7d 270a 2020 2020 2020 2020 6966 2073  l}'.        if s
-00019e10: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
-00019e20: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00019e30: 7065 2e52 323a 0a20 2020 2020 2020 2020  pe.R2:.         
-00019e40: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
-00019e50: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
-00019e60: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
-00019e70: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-00019e80: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
-00019e90: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-00019ea0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-00019eb0: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
-00019ec0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00019ed0: 2020 2020 2020 2020 2020 2020 2075 726c               url
-00019ee0: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
-00019ef0: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
-00019f00: 2020 2020 2072 6574 7572 6e20 6627 4157       return f'AW
-00019f10: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
-00019f20: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
-00019f30: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
-00019f40: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
-00019f50: 3320 6c73 207b 7572 6c7d 202d 2d65 6e64  3 ls {url} --end
-00019f60: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
-00019f70: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
-00019f80: 3227 0a0a 2020 2020 4073 7461 7469 636d  2'..    @staticm
-00019f90: 6574 686f 640a 2020 2020 6465 6620 636c  ethod.    def cl
-00019fa0: 695f 636f 756e 745f 6e61 6d65 5f69 6e5f  i_count_name_in_
-00019fb0: 6275 636b 6574 2873 746f 7265 5f74 7970  bucket(store_typ
-00019fc0: 652c 2062 7563 6b65 745f 6e61 6d65 2c20  e, bucket_name, 
-00019fd0: 6669 6c65 5f6e 616d 652c 2073 7566 6669  file_name, suffi
-00019fe0: 783d 2727 293a 0a20 2020 2020 2020 2069  x=''):.        i
-00019ff0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-0001a000: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001a010: 6554 7970 652e 5333 3a0a 2020 2020 2020  eType.S3:.      
-0001a020: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
-0001a030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a040: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
-0001a050: 6170 6920 6c69 7374 2d6f 626a 6563 7473  api list-objects
-0001a060: 202d 2d62 7563 6b65 7420 227b 6275 636b   --bucket "{buck
-0001a070: 6574 5f6e 616d 657d 2220 2d2d 7072 6566  et_name}" --pref
-0001a080: 6978 207b 7375 6666 6978 7d20 2d2d 7175  ix {suffix} --qu
-0001a090: 6572 7920 226c 656e 6774 6828 436f 6e74  ery "length(Cont
-0001a0a0: 656e 7473 5b3f 636f 6e74 6169 6e73 284b  ents[?contains(K
-0001a0b0: 6579 2c5c 277b 6669 6c65 5f6e 616d 657d  ey,\'{file_name}
-0001a0c0: 5c27 295d 2e4b 6579 2922 270a 2020 2020  \')].Key)"'.    
-0001a0d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001a0e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001a0f0: 7475 726e 2066 2761 7773 2073 3361 7069  turn f'aws s3api
-0001a100: 206c 6973 742d 6f62 6a65 6374 7320 2d2d   list-objects --
-0001a110: 6275 636b 6574 2022 7b62 7563 6b65 745f  bucket "{bucket_
-0001a120: 6e61 6d65 7d22 202d 2d71 7565 7279 2022  name}" --query "
-0001a130: 6c65 6e67 7468 2843 6f6e 7465 6e74 735b  length(Contents[
-0001a140: 3f63 6f6e 7461 696e 7328 4b65 792c 5c27  ?contains(Key,\'
-0001a150: 7b66 696c 655f 6e61 6d65 7d5c 2729 5d2e  {file_name}\')].
-0001a160: 4b65 7929 2227 0a20 2020 2020 2020 2065  Key)"'.        e
-0001a170: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
-0001a180: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0001a190: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
-0001a1a0: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
-0001a1b0: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-0001a1c0: 2020 2020 7265 7475 726e 2066 2767 7375      return f'gsu
-0001a1d0: 7469 6c20 6c73 202d 7220 6773 3a2f 2f7b  til ls -r gs://{
-0001a1e0: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
-0001a1f0: 6666 6978 7d20 7c20 6772 6570 2022 7b66  ffix} | grep "{f
-0001a200: 696c 655f 6e61 6d65 7d22 207c 2077 6320  ile_name}" | wc 
-0001a210: 2d6c 270a 2020 2020 2020 2020 2020 2020  -l'.            
-0001a220: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001a230: 2020 2020 2020 7265 7475 726e 2066 2767        return f'g
-0001a240: 7375 7469 6c20 6c73 202d 7220 6773 3a2f  sutil ls -r gs:/
-0001a250: 2f7b 6275 636b 6574 5f6e 616d 657d 207c  /{bucket_name} |
-0001a260: 2067 7265 7020 227b 6669 6c65 5f6e 616d   grep "{file_nam
-0001a270: 657d 2220 7c20 7763 202d 6c27 0a20 2020  e}" | wc -l'.   
-0001a280: 2020 2020 2065 6c69 6620 7374 6f72 655f       elif store_
-0001a290: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-0001a2a0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0001a2b0: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
-0001a2c0: 6470 6f69 6e74 5f75 726c 203d 2063 6c6f  dpoint_url = clo
-0001a2d0: 7564 666c 6172 652e 6372 6561 7465 5f65  udflare.create_e
-0001a2e0: 6e64 706f 696e 7428 290a 2020 2020 2020  ndpoint().      
-0001a2f0: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
-0001a300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a310: 2072 6574 7572 6e20 6627 4157 535f 5348   return f'AWS_SH
-0001a320: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
-0001a330: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
-0001a340: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
-0001a350: 5f50 4154 487d 2061 7773 2073 3361 7069  _PATH} aws s3api
-0001a360: 206c 6973 742d 6f62 6a65 6374 7320 2d2d   list-objects --
-0001a370: 6275 636b 6574 2022 7b62 7563 6b65 745f  bucket "{bucket_
-0001a380: 6e61 6d65 7d22 202d 2d70 7265 6669 7820  name}" --prefix 
-0001a390: 7b73 7566 6669 787d 202d 2d71 7565 7279  {suffix} --query
-0001a3a0: 2022 6c65 6e67 7468 2843 6f6e 7465 6e74   "length(Content
-0001a3b0: 735b 3f63 6f6e 7461 696e 7328 4b65 792c  s[?contains(Key,
-0001a3c0: 5c27 7b66 696c 655f 6e61 6d65 7d5c 2729  \'{file_name}\')
-0001a3d0: 5d2e 4b65 7929 2220 2d2d 656e 6470 6f69  ].Key)" --endpoi
-0001a3e0: 6e74 207b 656e 6470 6f69 6e74 5f75 726c  nt {endpoint_url
-0001a3f0: 7d20 2d2d 7072 6f66 696c 653d 7232 270a  } --profile=r2'.
-0001a400: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001a410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a420: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
-0001a430: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-0001a440: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-0001a450: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-0001a460: 535f 5041 5448 7d20 6177 7320 7333 6170  S_PATH} aws s3ap
-0001a470: 6920 6c69 7374 2d6f 626a 6563 7473 202d  i list-objects -
-0001a480: 2d62 7563 6b65 7420 227b 6275 636b 6574  -bucket "{bucket
-0001a490: 5f6e 616d 657d 2220 2d2d 7175 6572 7920  _name}" --query 
-0001a4a0: 226c 656e 6774 6828 436f 6e74 656e 7473  "length(Contents
-0001a4b0: 5b3f 636f 6e74 6169 6e73 284b 6579 2c5c  [?contains(Key,\
-0001a4c0: 277b 6669 6c65 5f6e 616d 657d 5c27 295d  '{file_name}\')]
-0001a4d0: 2e4b 6579 2922 202d 2d65 6e64 706f 696e  .Key)" --endpoin
-0001a4e0: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
-0001a4f0: 202d 2d70 726f 6669 6c65 3d72 3227 0a0a   --profile=r2'..
-0001a500: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-0001a510: 640a 2020 2020 6465 6620 636c 695f 636f  d.    def cli_co
-0001a520: 756e 745f 6669 6c65 5f69 6e5f 6275 636b  unt_file_in_buck
-0001a530: 6574 2873 746f 7265 5f74 7970 652c 2062  et(store_type, b
-0001a540: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
-0001a550: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-0001a560: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-0001a570: 622e 5374 6f72 6554 7970 652e 5333 3a0a  b.StoreType.S3:.
-0001a580: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001a590: 726e 2066 2761 7773 2073 3320 6c73 2073  rn f'aws s3 ls s
-0001a5a0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-0001a5b0: 7d20 2d2d 7265 6375 7273 6976 6520 7c20  } --recursive | 
-0001a5c0: 7763 202d 6c27 0a20 2020 2020 2020 2065  wc -l'.        e
-0001a5d0: 6c69 6620 7374 6f72 655f 7479 7065 203d  lif store_type =
-0001a5e0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0001a5f0: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
-0001a600: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001a610: 6627 6773 7574 696c 206c 7320 2d72 2067  f'gsutil ls -r g
-0001a620: 733a 2f2f 7b62 7563 6b65 745f 6e61 6d65  s://{bucket_name
-0001a630: 7d2f 2a2a 207c 2077 6320 2d6c 270a 2020  }/** | wc -l'.  
-0001a640: 2020 2020 2020 656c 6966 2073 746f 7265        elif store
-0001a650: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
-0001a660: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
-0001a670: 323a 0a20 2020 2020 2020 2020 2020 2065  2:.            e
-0001a680: 6e64 706f 696e 745f 7572 6c20 3d20 636c  ndpoint_url = cl
-0001a690: 6f75 6466 6c61 7265 2e63 7265 6174 655f  oudflare.create_
-0001a6a0: 656e 6470 6f69 6e74 2829 0a20 2020 2020  endpoint().     
-0001a6b0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-0001a6c0: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
-0001a6d0: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
-0001a6e0: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
-0001a6f0: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
-0001a700: 2073 3320 6c73 2073 333a 2f2f 7b62 7563   s3 ls s3://{buc
-0001a710: 6b65 745f 6e61 6d65 7d20 2d2d 7265 6375  ket_name} --recu
-0001a720: 7273 6976 6520 2d2d 656e 6470 6f69 6e74  rsive --endpoint
-0001a730: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
-0001a740: 2d2d 7072 6f66 696c 653d 7232 207c 2077  --profile=r2 | w
-0001a750: 6320 2d6c 270a 0a20 2020 2040 7079 7465  c -l'..    @pyte
-0001a760: 7374 2e66 6978 7475 7265 0a20 2020 2064  st.fixture.    d
-0001a770: 6566 2074 6d70 5f73 6f75 7263 6528 7365  ef tmp_source(se
-0001a780: 6c66 2c20 746d 705f 7061 7468 293a 0a20  lf, tmp_path):. 
-0001a790: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0001a7a0: 2061 2074 656d 706f 7261 7279 2064 6972   a temporary dir
-0001a7b0: 6563 746f 7279 2077 6974 6820 6120 6669  ectory with a fi
-0001a7c0: 6c65 2069 6e20 6974 0a20 2020 2020 2020  le in it.       
-0001a7d0: 2074 6d70 5f64 6972 203d 2074 6d70 5f70   tmp_dir = tmp_p
-0001a7e0: 6174 6820 2f20 2774 6d70 2d73 6f75 7263  ath / 'tmp-sourc
-0001a7f0: 6527 0a20 2020 2020 2020 2074 6d70 5f64  e'.        tmp_d
-0001a800: 6972 2e6d 6b64 6972 2829 0a20 2020 2020  ir.mkdir().     
-0001a810: 2020 2074 6d70 5f66 696c 6520 3d20 746d     tmp_file = tm
-0001a820: 705f 6469 7220 2f20 2774 6d70 2d66 696c  p_dir / 'tmp-fil
-0001a830: 6527 0a20 2020 2020 2020 2074 6d70 5f66  e'.        tmp_f
-0001a840: 696c 652e 7772 6974 655f 7465 7874 2827  ile.write_text('
-0001a850: 7465 7374 2729 0a20 2020 2020 2020 2063  test').        c
-0001a860: 6972 636c 655f 6c69 6e6b 203d 2074 6d70  ircle_link = tmp
-0001a870: 5f64 6972 202f 2027 6369 7263 6c65 2d6c  _dir / 'circle-l
-0001a880: 696e 6b27 0a20 2020 2020 2020 2063 6972  ink'.        cir
-0001a890: 636c 655f 6c69 6e6b 2e73 796d 6c69 6e6b  cle_link.symlink
-0001a8a0: 5f74 6f28 746d 705f 6469 722c 2074 6172  _to(tmp_dir, tar
-0001a8b0: 6765 745f 6973 5f64 6972 6563 746f 7279  get_is_directory
-0001a8c0: 3d54 7275 6529 0a20 2020 2020 2020 2079  =True).        y
-0001a8d0: 6965 6c64 2073 7472 2874 6d70 5f64 6972  ield str(tmp_dir
-0001a8e0: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0001a8f0: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0001a900: 6d70 5f62 7563 6b65 745f 6e61 6d65 2873  mp_bucket_name(s
-0001a910: 656c 6629 3a0a 2020 2020 2020 2020 2320  elf):.        # 
-0001a920: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
-0001a930: 6172 7920 6275 636b 6574 206e 616d 650a  ary bucket name.
-0001a940: 2020 2020 2020 2020 2320 7469 6d65 2e74          # time.t
-0001a950: 696d 6528 2920 7265 7475 726e 7320 7661  ime() returns va
-0001a960: 7279 696e 6720 7072 6563 6973 696f 6e20  rying precision 
-0001a970: 6f6e 2064 6966 6665 7265 6e74 2073 7973  on different sys
-0001a980: 7465 6d73 2c20 736f 2077 650a 2020 2020  tems, so we.    
-0001a990: 2020 2020 2320 7265 706c 6163 6520 7468      # replace th
-0001a9a0: 6520 6465 6369 6d61 6c20 706f 696e 7420  e decimal point 
-0001a9b0: 616e 6420 7573 6520 7768 6174 6576 6572  and use whatever
-0001a9c0: 2070 7265 6369 7369 6f6e 2077 6520 6361   precision we ca
-0001a9d0: 6e20 6765 742e 0a20 2020 2020 2020 2074  n get..        t
-0001a9e0: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
-0001a9f0: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
-0001aa00: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
-0001aa10: 2020 2020 2079 6965 6c64 2066 2773 6b79       yield f'sky
-0001aa20: 2d74 6573 742d 7b74 696d 6573 7461 6d70  -test-{timestamp
-0001aa30: 7d27 0a0a 2020 2020 4073 7461 7469 636d  }'..    @staticm
-0001aa40: 6574 686f 640a 2020 2020 6465 6620 7969  ethod.    def yi
-0001aa50: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-0001aa60: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0001aa70: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
-0001aa80: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-0001aa90: 2020 2020 2020 2020 736f 7572 6365 3a20          source: 
-0001aaa0: 4f70 7469 6f6e 616c 5b73 746f 7261 6765  Optional[storage
-0001aab0: 5f6c 6962 2e50 6174 685d 203d 204e 6f6e  _lib.Path] = Non
-0001aac0: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
-0001aad0: 746f 7265 733a 204f 7074 696f 6e61 6c5b  tores: Optional[
-0001aae0: 4469 6374 5b73 746f 7261 6765 5f6c 6962  Dict[storage_lib
-0001aaf0: 2e53 746f 7265 5479 7065 2c0a 2020 2020  .StoreType,.    
-0001ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab10: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001ab20: 6f72 6167 655f 6c69 622e 4162 7374 7261  orage_lib.Abstra
-0001ab30: 6374 5374 6f72 655d 5d20 3d20 4e6f 6e65  ctStore]] = None
-0001ab40: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
-0001ab50: 7273 6973 7465 6e74 3a20 4f70 7469 6f6e  rsistent: Option
-0001ab60: 616c 5b62 6f6f 6c5d 203d 2054 7275 652c  al[bool] = True,
-0001ab70: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-0001ab80: 653a 2073 746f 7261 6765 5f6c 6962 2e53  e: storage_lib.S
-0001ab90: 746f 7261 6765 4d6f 6465 203d 2073 746f  torageMode = sto
-0001aba0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-0001abb0: 4d6f 6465 2e4d 4f55 4e54 293a 0a20 2020  Mode.MOUNT):.   
-0001abc0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0001abd0: 2074 656d 706f 7261 7279 2073 746f 7261   temporary stora
-0001abe0: 6765 206f 626a 6563 742e 2053 746f 7265  ge object. Store
-0001abf0: 7320 6d75 7374 2062 6520 6164 6465 6420  s must be added 
-0001ac00: 696e 2074 6865 2074 6573 742e 0a20 2020  in the test..   
-0001ac10: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0001ac20: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-0001ac30: 746f 7261 6765 286e 616d 653d 6e61 6d65  torage(name=name
-0001ac40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac60: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0001ac70: 6365 3d73 6f75 7263 652c 0a20 2020 2020  ce=source,.     
-0001ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aca0: 2020 2020 2073 746f 7265 733d 7374 6f72       stores=stor
-0001acb0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-0001acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acd0: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-0001ace0: 7273 6973 7465 6e74 3d70 6572 7369 7374  rsistent=persist
-0001acf0: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-0001ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad10: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001ad20: 6f64 653d 6d6f 6465 290a 2020 2020 2020  ode=mode).      
-0001ad30: 2020 7969 656c 6420 7374 6f72 6167 655f    yield storage_
-0001ad40: 6f62 6a0a 2020 2020 2020 2020 6861 6e64  obj.        hand
-0001ad50: 6c65 203d 2067 6c6f 6261 6c5f 7573 6572  le = global_user
-0001ad60: 5f73 7461 7465 2e67 6574 5f68 616e 646c  _state.get_handl
-0001ad70: 655f 6672 6f6d 5f73 746f 7261 6765 5f6e  e_from_storage_n
-0001ad80: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
-0001ad90: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
-0001ada0: 6529 0a20 2020 2020 2020 2069 6620 6861  e).        if ha
-0001adb0: 6e64 6c65 3a0a 2020 2020 2020 2020 2020  ndle:.          
-0001adc0: 2020 2320 4966 2068 616e 646c 6520 6578    # If handle ex
-0001add0: 6973 7473 2c20 6465 6c65 7465 206d 616e  ists, delete man
-0001ade0: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-0001adf0: 2020 2320 544f 444f 2872 6f6d 696c 6229    # TODO(romilb)
-0001ae00: 3a20 5468 6973 2069 7320 706f 7465 6e74  : This is potent
-0001ae10: 6961 6c6c 7920 7269 736b 7920 2d20 6966  ially risky - if
-0001ae20: 2074 6865 2064 656c 6574 6520 6d65 7468   the delete meth
-0001ae30: 6f64 2068 6173 0a20 2020 2020 2020 2020  od has.         
-0001ae40: 2020 2023 2020 2062 7567 732c 2074 6869     #   bugs, thi
-0001ae50: 7320 6361 6e20 6361 7573 6520 7265 736f  s can cause reso
-0001ae60: 7572 6365 206c 6561 6b73 2e20 4964 6561  urce leaks. Idea
-0001ae70: 6c6c 7920 7765 2073 686f 756c 6420 6d61  lly we should ma
-0001ae80: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
-0001ae90: 2020 2023 2020 2065 6a65 6374 2073 746f     #   eject sto
-0001aea0: 7261 6765 2066 726f 6d20 676c 6f62 616c  rage from global
-0001aeb0: 5f75 7365 725f 7374 6174 6520 616e 6420  _user_state and 
-0001aec0: 6465 6c65 7465 2074 6865 2062 7563 6b65  delete the bucke
-0001aed0: 7420 7573 696e 670a 2020 2020 2020 2020  t using.        
-0001aee0: 2020 2020 2320 2020 626f 746f 3320 6469      #   boto3 di
-0001aef0: 7265 6374 6c79 2e0a 2020 2020 2020 2020  rectly..        
-0001af00: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-0001af10: 6465 6c65 7465 2829 0a0a 2020 2020 4070  delete()..    @p
-0001af20: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-0001af30: 2020 6465 6620 746d 705f 7363 7261 7463    def tmp_scratc
-0001af40: 685f 7374 6f72 6167 655f 6f62 6a28 7365  h_storage_obj(se
-0001af50: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
-0001af60: 616d 6529 3a0a 2020 2020 2020 2020 2320  ame):.        # 
-0001af70: 4372 6561 7465 7320 6120 7374 6f72 6167  Creates a storag
-0001af80: 6520 6f62 6a65 6374 2077 6974 6820 6e6f  e object with no
-0001af90: 2073 6f75 7263 6520 746f 2063 7265 6174   source to creat
-0001afa0: 6520 6120 7363 7261 7463 6820 7374 6f72  e a scratch stor
-0001afb0: 6167 652e 0a20 2020 2020 2020 2023 2053  age..        # S
-0001afc0: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-0001afd0: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-0001afe0: 0a20 2020 2020 2020 2079 6965 6c64 2066  .        yield f
-0001aff0: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
-0001b000: 746f 7261 6765 5f6f 626a 6563 7428 6e61  torage_object(na
-0001b010: 6d65 3d74 6d70 5f62 7563 6b65 745f 6e61  me=tmp_bucket_na
-0001b020: 6d65 290a 0a20 2020 2040 7079 7465 7374  me)..    @pytest
-0001b030: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-0001b040: 2074 6d70 5f6d 756c 7469 706c 655f 7363   tmp_multiple_sc
-0001b050: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0001b060: 6a28 7365 6c66 293a 0a20 2020 2020 2020  j(self):.       
-0001b070: 2023 2043 7265 6174 6573 2061 206c 6973   # Creates a lis
-0001b080: 7420 6f66 2035 2073 746f 7261 6765 206f  t of 5 storage o
-0001b090: 626a 6563 7473 2077 6974 6820 6e6f 2073  bjects with no s
-0001b0a0: 6f75 7263 6520 746f 2063 7265 6174 650a  ource to create.
-0001b0b0: 2020 2020 2020 2020 2320 6d75 6c74 6970          # multip
-0001b0c0: 6c65 2073 6372 6174 6368 2073 746f 7261  le scratch stora
-0001b0d0: 6765 732e 0a20 2020 2020 2020 2023 2053  ges..        # S
-0001b0e0: 746f 7265 7320 666f 7220 6561 6368 206f  tores for each o
-0001b0f0: 626a 6563 7420 696e 2074 6865 206c 6973  bject in the lis
-0001b100: 7420 6d75 7374 2062 6520 6164 6465 6420  t must be added 
-0001b110: 696e 2074 6865 2074 6573 742e 0a20 2020  in the test..   
-0001b120: 2020 2020 2073 746f 7261 6765 5f6d 756c       storage_mul
-0001b130: 745f 6f62 6a20 3d20 5b5d 0a20 2020 2020  t_obj = [].     
-0001b140: 2020 2066 6f72 205f 2069 6e20 7261 6e67     for _ in rang
-0001b150: 6528 3529 3a0a 2020 2020 2020 2020 2020  e(5):.          
-0001b160: 2020 7469 6d65 7374 616d 7020 3d20 7374    timestamp = st
-0001b170: 7228 7469 6d65 2e74 696d 6528 2929 2e72  r(time.time()).r
-0001b180: 6570 6c61 6365 2827 2e27 2c20 2727 290a  eplace('.', '').
-0001b190: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0001b1a0: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-0001b1b0: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
-0001b1c0: 3d66 2773 6b79 2d74 6573 742d 7b74 696d  =f'sky-test-{tim
-0001b1d0: 6573 7461 6d70 7d27 290a 2020 2020 2020  estamp}').      
-0001b1e0: 2020 2020 2020 7374 6f72 6167 655f 6d75        storage_mu
-0001b1f0: 6c74 5f6f 626a 2e61 7070 656e 6428 7374  lt_obj.append(st
-0001b200: 6f72 655f 6f62 6a29 0a20 2020 2020 2020  ore_obj).       
-0001b210: 2079 6965 6c64 2073 746f 7261 6765 5f6d   yield storage_m
-0001b220: 756c 745f 6f62 6a0a 2020 2020 2020 2020  ult_obj.        
-0001b230: 666f 7220 7374 6f72 6167 655f 6f62 6a20  for storage_obj 
-0001b240: 696e 2073 746f 7261 6765 5f6d 756c 745f  in storage_mult_
-0001b250: 6f62 6a3a 0a20 2020 2020 2020 2020 2020  obj:.           
-0001b260: 2068 616e 646c 6520 3d20 676c 6f62 616c   handle = global
-0001b270: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-0001b280: 6861 6e64 6c65 5f66 726f 6d5f 7374 6f72  handle_from_stor
-0001b290: 6167 655f 6e61 6d65 280a 2020 2020 2020  age_name(.      
-0001b2a0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0001b2b0: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
-0001b2c0: 2020 2020 2020 2020 6966 2068 616e 646c          if handl
-0001b2d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001b2e0: 2020 2023 2049 6620 6861 6e64 6c65 2065     # If handle e
-0001b2f0: 7869 7374 732c 2064 656c 6574 6520 6d61  xists, delete ma
-0001b300: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
-0001b310: 2020 2020 2020 2023 2054 4f44 4f28 726f         # TODO(ro
-0001b320: 6d69 6c62 293a 2054 6869 7320 6973 2070  milb): This is p
-0001b330: 6f74 656e 7469 616c 6c79 2072 6973 6b79  otentially risky
-0001b340: 202d 2069 6620 7468 6520 6465 6c65 7465   - if the delete
-0001b350: 206d 6574 686f 6420 6861 730a 2020 2020   method has.    
-0001b360: 2020 2020 2020 2020 2020 2020 2320 6275              # bu
-0001b370: 6773 2c20 7468 6973 2063 616e 2063 6175  gs, this can cau
-0001b380: 7365 2072 6573 6f75 7263 6520 6c65 616b  se resource leak
-0001b390: 732e 2049 6465 616c 6c79 2077 6520 7368  s. Ideally we sh
-0001b3a0: 6f75 6c64 206d 616e 7561 6c6c 790a 2020  ould manually.  
-0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001b3c0: 656a 6563 7420 7374 6f72 6167 6520 6672  eject storage fr
-0001b3d0: 6f6d 2067 6c6f 6261 6c5f 7573 6572 5f73  om global_user_s
-0001b3e0: 7461 7465 2061 6e64 2064 656c 6574 6520  tate and delete 
-0001b3f0: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
-0001b400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b410: 2023 2062 6f74 6f33 2064 6972 6563 746c   # boto3 directl
-0001b420: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-0001b430: 2020 2073 746f 7261 6765 5f6f 626a 2e64     storage_obj.d
-0001b440: 656c 6574 6528 290a 0a20 2020 2040 7079  elete()..    @py
-0001b450: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-0001b460: 2064 6566 2074 6d70 5f6c 6f63 616c 5f73   def tmp_local_s
-0001b470: 746f 7261 6765 5f6f 626a 2873 656c 662c  torage_obj(self,
-0001b480: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0001b490: 2c20 746d 705f 736f 7572 6365 293a 0a20  , tmp_source):. 
-0001b4a0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
-0001b4b0: 2061 2074 656d 706f 7261 7279 2073 746f   a temporary sto
-0001b4c0: 7261 6765 206f 626a 6563 742e 2053 746f  rage object. Sto
-0001b4d0: 7265 7320 6d75 7374 2062 6520 6164 6465  res must be adde
-0001b4e0: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
-0001b4f0: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
-0001b500: 6d20 7365 6c66 2e79 6965 6c64 5f73 746f  m self.yield_sto
-0001b510: 7261 6765 5f6f 626a 6563 7428 6e61 6d65  rage_object(name
-0001b520: 3d74 6d70 5f62 7563 6b65 745f 6e61 6d65  =tmp_bucket_name
-0001b530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b550: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001b560: 6f75 7263 653d 746d 705f 736f 7572 6365  ource=tmp_source
-0001b570: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-0001b580: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-0001b590: 6d70 5f6c 6f63 616c 5f6c 6973 745f 7374  mp_local_list_st
-0001b5a0: 6f72 6167 655f 6f62 6a28 7365 6c66 2c20  orage_obj(self, 
-0001b5b0: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
-0001b5c0: 2074 6d70 5f73 6f75 7263 6529 3a0a 2020   tmp_source):.  
-0001b5d0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0001b5e0: 6120 7465 6d70 2073 746f 7261 6765 206f  a temp storage o
-0001b5f0: 626a 6563 7420 7768 6963 6820 7573 6573  bject which uses
-0001b600: 2061 206c 6973 7420 6f66 2070 6174 6873   a list of paths
-0001b610: 2061 7320 736f 7572 6365 2e0a 2020 2020   as source..    
-0001b620: 2020 2020 2320 5374 6f72 6573 206d 7573      # Stores mus
-0001b630: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
-0001b640: 6520 7465 7374 2e20 4166 7465 7220 7570  e test. After up
-0001b650: 6c6f 6164 2c20 7468 6520 6275 636b 6574  load, the bucket
-0001b660: 2073 686f 756c 640a 2020 2020 2020 2020   should.        
-0001b670: 2320 6861 7665 2074 776f 2066 696c 6573  # have two files
-0001b680: 202d 202f 746d 702d 6669 6c65 2061 6e64   - /tmp-file and
-0001b690: 202f 746d 702d 736f 7572 6365 2f74 6d70   /tmp-source/tmp
-0001b6a0: 2d66 696c 650a 2020 2020 2020 2020 6c69  -file.        li
-0001b6b0: 7374 5f73 6f75 7263 6520 3d20 5b74 6d70  st_source = [tmp
-0001b6c0: 5f73 6f75 7263 652c 2074 6d70 5f73 6f75  _source, tmp_sou
-0001b6d0: 7263 6520 2b20 272f 746d 702d 6669 6c65  rce + '/tmp-file
-0001b6e0: 275d 0a20 2020 2020 2020 2079 6965 6c64  '].        yield
-0001b6f0: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
-0001b700: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
-0001b710: 6e61 6d65 3d74 6d70 5f62 7563 6b65 745f  name=tmp_bucket_
-0001b720: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-0001b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b750: 2020 2073 6f75 7263 653d 6c69 7374 5f73     source=list_s
-0001b760: 6f75 7263 6529 0a0a 2020 2020 4070 7974  ource)..    @pyt
-0001b770: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
-0001b780: 6465 6620 746d 705f 6275 6c6b 5f64 656c  def tmp_bulk_del
-0001b790: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-0001b7a0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-0001b7b0: 6d65 293a 0a20 2020 2020 2020 2023 2043  me):.        # C
-0001b7c0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-0001b7d0: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
-0001b7e0: 7420 666f 7220 7465 7374 696e 6720 6275  t for testing bu
-0001b7f0: 6c6b 2064 656c 6574 696f 6e2e 0a20 2020  lk deletion..   
-0001b800: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
-0001b810: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
-0001b820: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
-0001b830: 2077 6974 6820 7465 6d70 6669 6c65 2e54   with tempfile.T
-0001b840: 656d 706f 7261 7279 4469 7265 6374 6f72  emporaryDirector
-0001b850: 7928 2920 6173 2074 6d70 6469 723a 0a20  y() as tmpdir:. 
-0001b860: 2020 2020 2020 2020 2020 2073 7562 7072             subpr
-0001b870: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0001b880: 7574 2866 276d 6b64 6972 202d 7020 7b74  ut(f'mkdir -p {t
-0001b890: 6d70 6469 727d 2f66 6f6c 6465 727b 7b30  mpdir}/folder{{0
-0001b8a0: 3030 2e2e 3235 357d 7d27 2c0a 2020 2020  00..255}}',.    
-0001b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8d0: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-0001b8e0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0001b8f0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0001b900: 6627 746f 7563 6820 7b74 6d70 6469 727d  f'touch {tmpdir}
-0001b910: 2f74 6573 747b 7b30 3030 2e2e 3235 357d  /test{{000..255}
-0001b920: 7d2e 7478 7427 2c0a 2020 2020 2020 2020  }.txt',.        
-0001b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b940: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-0001b950: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-0001b960: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0001b970: 6865 636b 5f6f 7574 7075 7428 0a20 2020  heck_output(.   
-0001b980: 2020 2020 2020 2020 2020 2020 2066 2774               f't
-0001b990: 6f75 6368 207b 746d 7064 6972 7d2f 666f  ouch {tmpdir}/fo
-0001b9a0: 6c64 6572 7b7b 3030 302e 2e32 3535 7d7d  lder{{000..255}}
-0001b9b0: 2f74 6573 742e 7478 7427 2c20 7368 656c  /test.txt', shel
-0001b9c0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-0001b9d0: 2020 2020 7969 656c 6420 6672 6f6d 2073      yield from s
-0001b9e0: 656c 662e 7969 656c 645f 7374 6f72 6167  elf.yield_storag
-0001b9f0: 655f 6f62 6a65 6374 286e 616d 653d 746d  e_object(name=tm
-0001ba00: 705f 6275 636b 6574 5f6e 616d 652c 0a20  p_bucket_name,. 
-0001ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba40: 736f 7572 6365 3d74 6d70 6469 7229 0a0a  source=tmpdir)..
-0001ba50: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0001ba60: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0001ba70: 636f 7079 5f6d 6e74 5f65 7869 7374 696e  copy_mnt_existin
-0001ba80: 675f 7374 6f72 6167 655f 6f62 6a28 7365  g_storage_obj(se
-0001ba90: 6c66 2c20 746d 705f 7363 7261 7463 685f  lf, tmp_scratch_
-0001baa0: 7374 6f72 6167 655f 6f62 6a29 3a0a 2020  storage_obj):.  
-0001bab0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0001bac0: 6120 636f 7079 206d 6f75 6e74 2073 746f  a copy mount sto
-0001bad0: 7261 6765 2077 6869 6368 2072 6575 7365  rage which reuse
-0001bae0: 7320 616e 2065 7869 7374 696e 6720 7374  s an existing st
-0001baf0: 6f72 6167 6520 6f62 6a65 6374 2e0a 2020  orage object..  
-0001bb00: 2020 2020 2020 746d 705f 7363 7261 7463        tmp_scratc
-0001bb10: 685f 7374 6f72 6167 655f 6f62 6a2e 6164  h_storage_obj.ad
-0001bb20: 645f 7374 6f72 6528 7374 6f72 6167 655f  d_store(storage_
-0001bb30: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-0001bb40: 290a 2020 2020 2020 2020 7374 6f72 6167  ).        storag
-0001bb50: 655f 6e61 6d65 203d 2074 6d70 5f73 6372  e_name = tmp_scr
-0001bb60: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-0001bb70: 2e6e 616d 650a 0a20 2020 2020 2020 2023  .name..        #
-0001bb80: 2054 7279 2074 6f20 696e 6974 6961 6c69   Try to initiali
-0001bb90: 7a65 2061 6e6f 7468 6572 2073 746f 7261  ze another stora
-0001bba0: 6765 2077 6974 6820 7468 6520 7374 6f72  ge with the stor
-0001bbb0: 6167 6520 6f62 6a65 6374 2063 7265 6174  age object creat
-0001bbc0: 6564 0a20 2020 2020 2020 2023 2061 626f  ed.        # abo
-0001bbd0: 7665 2c20 6275 7420 6e6f 7720 696e 2043  ve, but now in C
-0001bbe0: 4f50 5920 6d6f 6465 2e20 5468 6973 2073  OPY mode. This s
-0001bbf0: 686f 756c 6420 7375 6363 6565 642e 0a20  hould succeed.. 
-0001bc00: 2020 2020 2020 2079 6965 6c64 2066 726f         yield fro
-0001bc10: 6d20 7365 6c66 2e79 6965 6c64 5f73 746f  m self.yield_sto
-0001bc20: 7261 6765 5f6f 626a 6563 7428 6e61 6d65  rage_object(name
-0001bc30: 3d73 746f 7261 6765 5f6e 616d 652c 0a20  =storage_name,. 
-0001bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc60: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0001bc70: 3d73 746f 7261 6765 5f6c 6962 2e53 746f  =storage_lib.Sto
-0001bc80: 7261 6765 4d6f 6465 2e43 4f50 5929 0a0a  rageMode.COPY)..
-0001bc90: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0001bca0: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0001bcb0: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
-0001bcc0: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-0001bcd0: 6275 636b 6574 5f6e 616d 652c 2067 6974  bucket_name, git
-0001bce0: 6967 6e6f 7265 5f73 7472 7563 7475 7265  ignore_structure
-0001bcf0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0001bd00: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
-0001bd10: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-0001bd20: 666f 7220 7465 7374 696e 6720 2e67 6974  for testing .git
-0001bd30: 6967 6e6f 7265 2066 696c 7465 722e 0a20  ignore filter.. 
-0001bd40: 2020 2020 2020 2023 2047 4954 4947 494e         # GITIGIN
-0001bd50: 4f52 455f 5354 5255 4354 5552 4520 6973  ORE_STRUCTURE is
-0001bd60: 2072 6570 7265 7365 6e74 696e 6720 6120   representing a 
-0001bd70: 6669 6c65 2073 7472 7563 7475 7265 2069  file structure i
-0001bd80: 6e20 6120 6469 6374 696f 6e61 7279 0a20  n a dictionary. 
-0001bd90: 2020 2020 2020 2023 2066 6f72 616d 742e         # foramt.
-0001bda0: 2043 7265 6174 6564 2073 746f 7261 6765   Created storage
-0001bdb0: 206f 626a 6563 7420 7769 6c6c 2063 6f6e   object will con
-0001bdc0: 7461 696e 2074 6865 2066 696c 6520 7374  tain the file st
-0001bdd0: 7275 6374 7572 6520 616c 6f6e 670a 2020  ructure along.  
-0001bde0: 2020 2020 2020 2320 7769 7468 202e 6769        # with .gi
-0001bdf0: 7469 676e 6f72 6520 616e 6420 2e67 6974  tignore and .git
-0001be00: 2f69 6e66 6f2f 6578 636c 7564 6520 6669  /info/exclude fi
-0001be10: 6c65 7320 746f 2074 6573 7420 6578 636c  les to test excl
-0001be20: 7564 6520 6669 6c74 6572 2e0a 2020 2020  ude filter..    
-0001be30: 2020 2020 2320 5374 6f72 6573 206d 7573      # Stores mus
-0001be40: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
-0001be50: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
-0001be60: 7769 7468 2074 656d 7066 696c 652e 5465  with tempfile.Te
-0001be70: 6d70 6f72 6172 7944 6972 6563 746f 7279  mporaryDirectory
-0001be80: 2829 2061 7320 746d 7064 6972 3a0a 2020  () as tmpdir:.  
-0001be90: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-0001bea0: 7465 7320 6669 6c65 2073 7472 7563 7475  tes file structu
-0001beb0: 7265 2074 6f20 6265 2075 706c 6f61 6465  re to be uploade
-0001bec0: 6420 696e 2074 6865 2053 746f 7261 6765  d in the Storage
-0001bed0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001bee0: 662e 6372 6561 7465 5f64 6972 5f73 7472  f.create_dir_str
-0001bef0: 7563 7475 7265 2874 6d70 6469 722c 2067  ucture(tmpdir, g
-0001bf00: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
-0001bf10: 7265 290a 0a20 2020 2020 2020 2020 2020  re)..           
-0001bf20: 2023 2043 7265 6174 6520 2e67 6974 6967   # Create .gitig
-0001bf30: 6e6f 7265 2061 6e64 206c 6973 7420 6669  nore and list fi
-0001bf40: 6c65 732f 6469 7273 2074 6f20 6265 2065  les/dirs to be e
-0001bf50: 7863 6c75 6465 6420 696e 2069 740a 2020  xcluded in it.  
-0001bf60: 2020 2020 2020 2020 2020 736b 7970 696c            skypil
-0001bf70: 6f74 5f70 6174 6820 3d20 6f73 2e70 6174  ot_path = os.pat
-0001bf80: 682e 6469 726e 616d 6528 6f73 2e70 6174  h.dirname(os.pat
-0001bf90: 682e 6469 726e 616d 6528 736b 792e 5f5f  h.dirname(sky.__
-0001bfa0: 6669 6c65 5f5f 2929 0a20 2020 2020 2020  file__)).       
-0001bfb0: 2020 2020 2074 656d 705f 7061 7468 203d       temp_path =
-0001bfc0: 2066 277b 746d 7064 6972 7d2f 2e67 6974   f'{tmpdir}/.git
-0001bfd0: 6967 6e6f 7265 270a 2020 2020 2020 2020  ignore'.        
-0001bfe0: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
-0001bff0: 6f73 2e70 6174 682e 6a6f 696e 2873 6b79  os.path.join(sky
-0001c000: 7069 6c6f 745f 7061 7468 2c20 2774 6573  pilot_path, 'tes
-0001c010: 7473 2f67 6974 6967 6e6f 7265 5f74 6573  ts/gitignore_tes
-0001c020: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
-0001c030: 7368 7574 696c 2e63 6f70 7966 696c 6528  shutil.copyfile(
-0001c040: 6669 6c65 5f70 6174 682c 2074 656d 705f  file_path, temp_
-0001c050: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
-0001c060: 2020 2023 2043 7265 6174 6520 2e67 6974     # Create .git
-0001c070: 2f69 6e66 6f2f 6578 636c 7564 6520 616e  /info/exclude an
-0001c080: 6420 6c69 7374 2066 696c 6573 2f64 6972  d list files/dir
-0001c090: 7320 746f 2062 6520 6578 636c 7564 6564  s to be excluded
-0001c0a0: 2069 6e20 6974 0a20 2020 2020 2020 2020   in it.         
-0001c0b0: 2020 2074 656d 705f 7061 7468 203d 2066     temp_path = f
-0001c0c0: 277b 746d 7064 6972 7d2f 2e67 6974 2f69  '{tmpdir}/.git/i
-0001c0d0: 6e66 6f2f 270a 2020 2020 2020 2020 2020  nfo/'.          
-0001c0e0: 2020 6f73 2e6d 616b 6564 6972 7328 7465    os.makedirs(te
-0001c0f0: 6d70 5f70 6174 6829 0a20 2020 2020 2020  mp_path).       
-0001c100: 2020 2020 2074 656d 705f 6578 636c 7564       temp_exclud
-0001c110: 655f 7061 7468 203d 206f 732e 7061 7468  e_path = os.path
-0001c120: 2e6a 6f69 6e28 7465 6d70 5f70 6174 682c  .join(temp_path,
-0001c130: 2027 6578 636c 7564 6527 290a 2020 2020   'exclude').    
-0001c140: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
-0001c150: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
-0001c160: 2873 6b79 7069 6c6f 745f 7061 7468 2c0a  (skypilot_path,.
-0001c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c190: 2020 2020 2027 7465 7374 732f 6769 745f       'tests/git_
-0001c1a0: 696e 666f 5f65 7863 6c75 6465 5f74 6573  info_exclude_tes
-0001c1b0: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
-0001c1c0: 7368 7574 696c 2e63 6f70 7966 696c 6528  shutil.copyfile(
-0001c1d0: 6669 6c65 5f70 6174 682c 2074 656d 705f  file_path, temp_
-0001c1e0: 6578 636c 7564 655f 7061 7468 290a 0a20  exclude_path).. 
-0001c1f0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
-0001c200: 6174 6520 736b 7920 5374 6f72 6167 6520  ate sky Storage 
-0001c210: 7769 7468 2074 6865 2066 696c 6573 2063  with the files c
-0001c220: 7265 6174 6564 0a20 2020 2020 2020 2020  reated.         
-0001c230: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
-0001c240: 6c66 2e79 6965 6c64 5f73 746f 7261 6765  lf.yield_storage
-0001c250: 5f6f 626a 6563 7428 0a20 2020 2020 2020  _object(.       
-0001c260: 2020 2020 2020 2020 206e 616d 653d 746d           name=tm
-0001c270: 705f 6275 636b 6574 5f6e 616d 652c 0a20  p_bucket_name,. 
-0001c280: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001c290: 6f75 7263 653d 746d 7064 6972 2c0a 2020  ource=tmpdir,.  
-0001c2a0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0001c2b0: 6465 3d73 746f 7261 6765 5f6c 6962 2e53  de=storage_lib.S
-0001c2c0: 746f 7261 6765 4d6f 6465 2e43 4f50 5929  torageMode.COPY)
-0001c2d0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-0001c2e0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-0001c2f0: 705f 6177 7363 6c69 5f62 7563 6b65 7428  p_awscli_bucket(
-0001c300: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
-0001c310: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
-0001c320: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-0001c330: 6f72 6172 7920 6275 636b 6574 2075 7369  orary bucket usi
-0001c340: 6e67 2061 7773 636c 690a 2020 2020 2020  ng awscli.      
-0001c350: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0001c360: 636b 5f63 616c 6c28 5b27 6177 7327 2c20  ck_call(['aws', 
-0001c370: 2773 3327 2c20 276d 6227 2c20 6627 7333  's3', 'mb', f's3
-0001c380: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
-0001c390: 616d 657d 275d 290a 2020 2020 2020 2020  ame}']).        
-0001c3a0: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
-0001c3b0: 5f6e 616d 650a 2020 2020 2020 2020 7375  _name.        su
-0001c3c0: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
-0001c3d0: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
-0001c3e0: 205b 2761 7773 272c 2027 7333 272c 2027   ['aws', 's3', '
-0001c3f0: 7262 272c 2066 2773 333a 2f2f 7b74 6d70  rb', f's3://{tmp
-0001c400: 5f62 7563 6b65 745f 6e61 6d65 7d27 2c20  _bucket_name}', 
-0001c410: 272d 2d66 6f72 6365 275d 290a 0a20 2020  '--force'])..   
-0001c420: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-0001c430: 0a20 2020 2064 6566 2074 6d70 5f67 7375  .    def tmp_gsu
-0001c440: 7469 6c5f 6275 636b 6574 2873 656c 662c  til_bucket(self,
-0001c450: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
-0001c460: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-0001c470: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
-0001c480: 2062 7563 6b65 7420 7573 696e 6720 6773   bucket using gs
-0001c490: 7574 696c 0a20 2020 2020 2020 2073 7562  util.        sub
-0001c4a0: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
-0001c4b0: 6c6c 285b 2767 7375 7469 6c27 2c20 276d  ll(['gsutil', 'm
-0001c4c0: 6227 2c20 6627 6773 3a2f 2f7b 746d 705f  b', f'gs://{tmp_
-0001c4d0: 6275 636b 6574 5f6e 616d 657d 275d 290a  bucket_name}']).
-0001c4e0: 2020 2020 2020 2020 7969 656c 6420 746d          yield tm
-0001c4f0: 705f 6275 636b 6574 5f6e 616d 650a 2020  p_bucket_name.  
-0001c500: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0001c510: 2e63 6865 636b 5f63 616c 6c28 5b27 6773  .check_call(['gs
-0001c520: 7574 696c 272c 2027 726d 272c 2027 2d72  util', 'rm', '-r
-0001c530: 272c 2066 2767 733a 2f2f 7b74 6d70 5f62  ', f'gs://{tmp_b
-0001c540: 7563 6b65 745f 6e61 6d65 7d27 5d29 0a0a  ucket_name}'])..
-0001c550: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
-0001c560: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
-0001c570: 6177 7363 6c69 5f62 7563 6b65 745f 7232  awscli_bucket_r2
-0001c580: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-0001c590: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-0001c5a0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-0001c5b0: 706f 7261 7279 2062 7563 6b65 7420 7573  porary bucket us
-0001c5c0: 696e 6720 6177 7363 6c69 0a20 2020 2020  ing awscli.     
-0001c5d0: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
-0001c5e0: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
-0001c5f0: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
-0001c600: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0001c610: 732e 6368 6563 6b5f 6361 6c6c 280a 2020  s.check_call(.  
-0001c620: 2020 2020 2020 2020 2020 6627 4157 535f            f'AWS_
-0001c630: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
-0001c640: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
-0001c650: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
-0001c660: 4c53 5f50 4154 487d 2061 7773 2073 3320  LS_PATH} aws s3 
-0001c670: 6d62 2073 333a 2f2f 7b74 6d70 5f62 7563  mb s3://{tmp_buc
-0001c680: 6b65 745f 6e61 6d65 7d20 2d2d 656e 6470  ket_name} --endp
-0001c690: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-0001c6a0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-0001c6b0: 272c 0a20 2020 2020 2020 2020 2020 2073  ',.            s
-0001c6c0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-0001c6d0: 2020 2079 6965 6c64 2074 6d70 5f62 7563     yield tmp_buc
-0001c6e0: 6b65 745f 6e61 6d65 0a20 2020 2020 2020  ket_name.       
-0001c6f0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0001c700: 6b5f 6361 6c6c 280a 2020 2020 2020 2020  k_call(.        
-0001c710: 2020 2020 6627 4157 535f 5348 4152 4544      f'AWS_SHARED
-0001c720: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
-0001c730: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
-0001c740: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
-0001c750: 487d 2061 7773 2073 3320 7262 2073 333a  H} aws s3 rb s3:
-0001c760: 2f2f 7b74 6d70 5f62 7563 6b65 745f 6e61  //{tmp_bucket_na
-0001c770: 6d65 7d20 2d2d 666f 7263 6520 2d2d 656e  me} --force --en
-0001c780: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
-0001c790: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
-0001c7a0: 7232 272c 0a20 2020 2020 2020 2020 2020  r2',.           
-0001c7b0: 2073 6865 6c6c 3d54 7275 6529 0a0a 2020   shell=True)..  
-0001c7c0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-0001c7d0: 650a 2020 2020 6465 6620 746d 705f 7075  e.    def tmp_pu
-0001c7e0: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-0001c7f0: 2873 656c 662c 2072 6571 7565 7374 293a  (self, request):
-0001c800: 0a20 2020 2020 2020 2023 2049 6e69 7469  .        # Initi
-0001c810: 616c 697a 6573 2061 2073 746f 7261 6765  alizes a storage
-0001c820: 206f 626a 6563 7420 7769 7468 2061 2070   object with a p
-0001c830: 7562 6c69 6320 6275 636b 6574 0a20 2020  ublic bucket.   
-0001c840: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0001c850: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-0001c860: 746f 7261 6765 2873 6f75 7263 653d 7265  torage(source=re
-0001c870: 7175 6573 742e 7061 7261 6d29 0a20 2020  quest.param).   
-0001c880: 2020 2020 2079 6965 6c64 2073 746f 7261       yield stora
-0001c890: 6765 5f6f 626a 0a20 2020 2020 2020 2023  ge_obj.        #
-0001c8a0: 2054 6869 7320 646f 6573 206e 6f74 2072   This does not r
-0001c8b0: 6571 7569 7265 2061 6e79 2064 656c 6574  equire any delet
-0001c8c0: 696f 6e20 6c6f 6769 6320 6265 6361 7573  ion logic becaus
-0001c8d0: 6520 6974 2069 7320 6120 7075 626c 6963  e it is a public
-0001c8e0: 2062 7563 6b65 740a 2020 2020 2020 2020   bucket.        
-0001c8f0: 2320 616e 6420 7368 6f75 6c64 206e 6f74  # and should not
-0001c900: 2067 6574 2061 6464 6564 2074 6f20 676c   get added to gl
-0001c910: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-0001c920: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-0001c930: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-0001c940: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
-0001c950: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
-0001c960: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
-0001c970: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0001c980: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
-0001c990: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-0001c9a0: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-0001c9b0: 7265 5479 7065 2e52 322c 206d 6172 6b73  reType.R2, marks
-0001c9c0: 3d70 7974 6573 742e 6d61 726b 2e63 6c6f  =pytest.mark.clo
-0001c9d0: 7564 666c 6172 6529 0a20 2020 205d 290a  udflare).    ]).
-0001c9e0: 2020 2020 6465 6620 7465 7374 5f6e 6577      def test_new
-0001c9f0: 5f62 7563 6b65 745f 6372 6561 7469 6f6e  _bucket_creation
-0001ca00: 5f61 6e64 5f64 656c 6574 696f 6e28 7365  _and_deletion(se
-0001ca10: 6c66 2c20 746d 705f 6c6f 6361 6c5f 7374  lf, tmp_local_st
-0001ca20: 6f72 6167 655f 6f62 6a2c 0a20 2020 2020  orage_obj,.     
-0001ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca50: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-0001ca60: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
-0001ca70: 4372 6561 7465 7320 6120 6e65 7720 6275  Creates a new bu
-0001ca80: 636b 6574 2077 6974 6820 6120 6c6f 6361  cket with a loca
-0001ca90: 6c20 736f 7572 6365 2c20 7570 6c6f 6164  l source, upload
-0001caa0: 7320 6669 6c65 7320 746f 2069 740a 2020  s files to it.  
-0001cab0: 2020 2020 2020 2320 616e 6420 6465 6c65        # and dele
-0001cac0: 7465 7320 6974 2e0a 2020 2020 2020 2020  tes it..        
-0001cad0: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
-0001cae0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
-0001caf0: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
-0001cb00: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-0001cb10: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
-0001cb20: 636b 2069 6620 7374 6f72 6167 6520 6f62  ck if storage ob
-0001cb30: 6a65 6374 2065 7869 7374 7320 696e 2074  ject exists in t
-0001cb40: 6865 206f 7574 7075 740a 2020 2020 2020  he output.      
-0001cb50: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
-0001cb60: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-0001cb70: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
-0001cb80: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
-0001cb90: 2020 6173 7365 7274 2074 6d70 5f6c 6f63    assert tmp_loc
-0001cba0: 616c 5f73 746f 7261 6765 5f6f 626a 2e6e  al_storage_obj.n
-0001cbb0: 616d 6520 696e 206f 7574 2e64 6563 6f64  ame in out.decod
-0001cbc0: 6528 2775 7466 2d38 2729 0a0a 2020 2020  e('utf-8')..    
-0001cbd0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
-0001cbe0: 6f72 6167 6520 6465 6c65 7465 2074 6f20  orage delete to 
-0001cbf0: 6465 6c65 7465 2074 6865 2073 746f 7261  delete the stora
-0001cc00: 6765 206f 626a 6563 740a 2020 2020 2020  ge object.      
-0001cc10: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0001cc20: 636b 5f6f 7574 7075 7428 0a20 2020 2020  ck_output(.     
-0001cc30: 2020 2020 2020 205b 2773 6b79 272c 2027         ['sky', '
-0001cc40: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
-0001cc50: 6527 2c20 746d 705f 6c6f 6361 6c5f 7374  e', tmp_local_st
-0001cc60: 6f72 6167 655f 6f62 6a2e 6e61 6d65 5d29  orage_obj.name])
-0001cc70: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-0001cc80: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-0001cc90: 6f20 6368 6563 6b20 6966 2073 746f 7261  o check if stora
-0001cca0: 6765 206f 626a 6563 7420 6973 2064 656c  ge object is del
-0001ccb0: 6574 6564 0a20 2020 2020 2020 206f 7574  eted.        out
-0001ccc0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0001ccd0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0001cce0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0001ccf0: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0001cd00: 6572 7420 746d 705f 6c6f 6361 6c5f 7374  ert tmp_local_st
-0001cd10: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
-0001cd20: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
-0001cd30: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
-0001cd40: 7079 7465 7374 2e6d 6172 6b2e 7864 6973  pytest.mark.xdis
-0001cd50: 745f 6772 6f75 7028 276d 756c 7469 706c  t_group('multipl
-0001cd60: 655f 6275 636b 6574 5f64 656c 6574 696f  e_bucket_deletio
-0001cd70: 6e27 290a 2020 2020 4070 7974 6573 742e  n').    @pytest.
-0001cd80: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0001cd90: 2827 7374 6f72 655f 7479 7065 272c 205b  ('store_type', [
-0001cda0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-0001cdb0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0001cdc0: 332c 2073 746f 7261 6765 5f6c 6962 2e53  3, storage_lib.S
-0001cdd0: 746f 7265 5479 7065 2e47 4353 2c0a 2020  toreType.GCS,.  
-0001cde0: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-0001cdf0: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
-0001ce00: 746f 7265 5479 7065 2e52 322c 206d 6172  toreType.R2, mar
-0001ce10: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
-0001ce20: 6c6f 7564 666c 6172 6529 0a20 2020 205d  loudflare).    ]
-0001ce30: 290a 2020 2020 6465 6620 7465 7374 5f6d  ).    def test_m
-0001ce40: 756c 7469 706c 655f 6275 636b 6574 735f  ultiple_buckets_
-0001ce50: 6372 6561 7469 6f6e 5f61 6e64 5f64 656c  creation_and_del
-0001ce60: 6574 696f 6e28 0a20 2020 2020 2020 2020  etion(.         
-0001ce70: 2020 2073 656c 662c 2074 6d70 5f6d 756c     self, tmp_mul
-0001ce80: 7469 706c 655f 7363 7261 7463 685f 7374  tiple_scratch_st
-0001ce90: 6f72 6167 655f 6f62 6a2c 2073 746f 7265  orage_obj, store
-0001cea0: 5f74 7970 6529 3a0a 2020 2020 2020 2020  _type):.        
-0001ceb0: 2320 4372 6561 7465 7320 6d75 6c74 6970  # Creates multip
-0001cec0: 6c65 206e 6577 2062 7563 6b65 7473 2835  le new buckets(5
-0001ced0: 2062 7563 6b65 7473 2920 7769 7468 2061   buckets) with a
-0001cee0: 206c 6f63 616c 2073 6f75 7263 650a 2020   local source.  
-0001cef0: 2020 2020 2020 2320 616e 6420 6465 6c65        # and dele
-0001cf00: 7465 7320 7468 656d 2e0a 2020 2020 2020  tes them..      
-0001cf10: 2020 7374 6f72 6167 655f 6f62 6a5f 6e61    storage_obj_na
-0001cf20: 6d65 203d 205b 5d0a 2020 2020 2020 2020  me = [].        
-0001cf30: 666f 7220 7374 6f72 655f 6f62 6a20 696e  for store_obj in
-0001cf40: 2074 6d70 5f6d 756c 7469 706c 655f 7363   tmp_multiple_sc
-0001cf50: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-0001cf60: 6a3a 0a20 2020 2020 2020 2020 2020 2073  j:.            s
-0001cf70: 746f 7265 5f6f 626a 2e61 6464 5f73 746f  tore_obj.add_sto
-0001cf80: 7265 2873 746f 7265 5f74 7970 6529 0a20  re(store_type). 
-0001cf90: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0001cfa0: 6765 5f6f 626a 5f6e 616d 652e 6170 7065  ge_obj_name.appe
-0001cfb0: 6e64 2873 746f 7265 5f6f 626a 2e6e 616d  nd(store_obj.nam
-0001cfc0: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
-0001cfd0: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-0001cfe0: 2074 6f20 6368 6563 6b20 6966 2061 6c6c   to check if all
-0001cff0: 2073 746f 7261 6765 206f 626a 6563 7473   storage objects
-0001d000: 2065 7869 7374 7320 696e 2074 6865 0a20   exists in the. 
-0001d010: 2020 2020 2020 2023 206f 7574 7075 7420         # output 
-0001d020: 6669 6c74 6572 6564 2062 7920 7374 6f72  filtered by stor
-0001d030: 6520 7479 7065 0a20 2020 2020 2020 206f  e type.        o
-0001d040: 7574 5f61 6c6c 203d 2073 7562 7072 6f63  ut_all = subproc
-0001d050: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0001d060: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-0001d070: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-0001d080: 2020 206f 7574 203d 205b 0a20 2020 2020     out = [.     
-0001d090: 2020 2020 2020 2069 7465 6d2e 7370 6c69         item.spli
-0001d0a0: 7428 295b 305d 0a20 2020 2020 2020 2020  t()[0].         
-0001d0b0: 2020 2066 6f72 2069 7465 6d20 696e 206f     for item in o
-0001d0c0: 7574 5f61 6c6c 2e64 6563 6f64 6528 2775  ut_all.decode('u
-0001d0d0: 7466 2d38 2729 2e73 706c 6974 6c69 6e65  tf-8').splitline
-0001d0e0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0001d0f0: 6966 2073 746f 7265 5f74 7970 652e 7661  if store_type.va
-0001d100: 6c75 6520 696e 2069 7465 6d0a 2020 2020  lue in item.    
-0001d110: 2020 2020 5d0a 2020 2020 2020 2020 6173      ].        as
-0001d120: 7365 7274 2061 6c6c 285b 6974 656d 2069  sert all([item i
-0001d130: 6e20 6f75 7420 666f 7220 6974 656d 2069  n out for item i
-0001d140: 6e20 7374 6f72 6167 655f 6f62 6a5f 6e61  n storage_obj_na
-0001d150: 6d65 5d29 0a0a 2020 2020 2020 2020 2320  me])..        # 
-0001d160: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0001d170: 6465 6c65 7465 2061 6c6c 2074 6f20 6465  delete all to de
-0001d180: 6c65 7465 2061 6c6c 2073 746f 7261 6765  lete all storage
-0001d190: 206f 626a 6563 7473 0a20 2020 2020 2020   objects.       
-0001d1a0: 2064 656c 6574 655f 636d 6420 3d20 5b27   delete_cmd = ['
-0001d1b0: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
-0001d1c0: 2027 6465 6c65 7465 275d 0a20 2020 2020   'delete'].     
-0001d1d0: 2020 2064 656c 6574 655f 636d 6420 2b3d     delete_cmd +=
-0001d1e0: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
-0001d1f0: 650a 2020 2020 2020 2020 7375 6270 726f  e.        subpro
-0001d200: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-0001d210: 7428 6465 6c65 7465 5f63 6d64 290a 0a20  t(delete_cmd).. 
-0001d220: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-0001d230: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-0001d240: 6865 636b 2069 6620 616c 6c20 7374 6f72  heck if all stor
-0001d250: 6167 6520 6f62 6a65 6374 7320 6669 6c74  age objects filt
-0001d260: 6572 6564 2062 7920 7374 6f72 650a 2020  ered by store.  
-0001d270: 2020 2020 2020 2320 7479 7065 2061 7265        # type are
-0001d280: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
-0001d290: 206f 7574 5f61 6c6c 203d 2073 7562 7072   out_all = subpr
-0001d2a0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0001d2b0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-0001d2c0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-0001d2d0: 2020 2020 206f 7574 203d 205b 0a20 2020       out = [.   
-0001d2e0: 2020 2020 2020 2020 2069 7465 6d2e 7370           item.sp
-0001d2f0: 6c69 7428 295b 305d 0a20 2020 2020 2020  lit()[0].       
-0001d300: 2020 2020 2066 6f72 2069 7465 6d20 696e       for item in
-0001d310: 206f 7574 5f61 6c6c 2e64 6563 6f64 6528   out_all.decode(
-0001d320: 2775 7466 2d38 2729 2e73 706c 6974 6c69  'utf-8').splitli
-0001d330: 6e65 7328 290a 2020 2020 2020 2020 2020  nes().          
-0001d340: 2020 6966 2073 746f 7265 5f74 7970 652e    if store_type.
-0001d350: 7661 6c75 6520 696e 2069 7465 6d0a 2020  value in item.  
-0001d360: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0001d370: 6173 7365 7274 2061 6c6c 285b 6974 656d  assert all([item
-0001d380: 206e 6f74 2069 6e20 6f75 7420 666f 7220   not in out for 
-0001d390: 6974 656d 2069 6e20 7374 6f72 6167 655f  item in storage_
-0001d3a0: 6f62 6a5f 6e61 6d65 5d29 0a0a 2020 2020  obj_name])..    
-0001d3b0: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-0001d3c0: 616d 6574 7269 7a65 2827 7374 6f72 655f  ametrize('store_
-0001d3d0: 7479 7065 272c 205b 0a20 2020 2020 2020  type', [.       
-0001d3e0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0001d3f0: 7265 5479 7065 2e53 332c 2073 746f 7261  reType.S3, stora
-0001d400: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0001d410: 2e47 4353 2c0a 2020 2020 2020 2020 7079  .GCS,.        py
-0001d420: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
-0001d430: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0001d440: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
-0001d450: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-0001d460: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
-0001d470: 6620 7465 7374 5f62 7563 6b65 745f 6578  f test_bucket_ex
-0001d480: 7465 726e 616c 5f64 656c 6574 696f 6e28  ternal_deletion(
-0001d490: 7365 6c66 2c20 746d 705f 7363 7261 7463  self, tmp_scratc
-0001d4a0: 685f 7374 6f72 6167 655f 6f62 6a2c 0a20  h_storage_obj,. 
-0001d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d4d0: 2020 2020 2073 746f 7265 5f74 7970 6529       store_type)
-0001d4e0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-0001d4f0: 7465 7320 6120 6275 636b 6574 2c20 6465  tes a bucket, de
-0001d500: 6c65 7465 7320 6974 2065 7874 6572 6e61  letes it externa
-0001d510: 6c6c 7920 7573 696e 6720 636c 6f75 6420  lly using cloud 
-0001d520: 636c 6920 636f 6d6d 616e 6473 0a20 2020  cli commands.   
-0001d530: 2020 2020 2023 2061 6e64 2074 6865 6e20       # and then 
-0001d540: 7472 6965 7320 746f 2064 656c 6574 6520  tries to delete 
-0001d550: 6974 2075 7369 6e67 2073 6b79 2073 746f  it using sky sto
-0001d560: 7261 6765 2064 656c 6574 652e 0a20 2020  rage delete..   
-0001d570: 2020 2020 2074 6d70 5f73 6372 6174 6368       tmp_scratch
-0001d580: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
-0001d590: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
-0001d5a0: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
-0001d5b0: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-0001d5c0: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
-0001d5d0: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-0001d5e0: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
-0001d5f0: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-0001d600: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-0001d610: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-0001d620: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-0001d630: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001d640: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-0001d650: 6167 655f 6f62 6a2e 6e61 6d65 2069 6e20  age_obj.name in 
-0001d660: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-0001d670: 3827 290a 0a20 2020 2020 2020 2023 2044  8')..        # D
-0001d680: 656c 6574 6520 6275 636b 6574 2065 7874  elete bucket ext
-0001d690: 6572 6e61 6c6c 790a 2020 2020 2020 2020  ernally.        
-0001d6a0: 636d 6420 3d20 7365 6c66 2e63 6c69 5f64  cmd = self.cli_d
-0001d6b0: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
-0001d6c0: 7479 7065 2c20 746d 705f 7363 7261 7463  type, tmp_scratc
-0001d6d0: 685f 7374 6f72 6167 655f 6f62 6a2e 6e61  h_storage_obj.na
-0001d6e0: 6d65 290a 2020 2020 2020 2020 7375 6270  me).        subp
-0001d6f0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-0001d700: 7075 7428 636d 642c 2073 6865 6c6c 3d54  put(cmd, shell=T
-0001d710: 7275 6529 0a0a 2020 2020 2020 2020 2320  rue)..        # 
-0001d720: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-0001d730: 6465 6c65 7465 2074 6f20 6465 6c65 7465  delete to delete
-0001d740: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-0001d750: 6563 740a 2020 2020 2020 2020 6f75 7420  ect.        out 
-0001d760: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0001d770: 636b 5f6f 7574 7075 7428 0a20 2020 2020  ck_output(.     
-0001d780: 2020 2020 2020 205b 2773 6b79 272c 2027         ['sky', '
-0001d790: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
-0001d7a0: 6527 2c20 746d 705f 7363 7261 7463 685f  e', tmp_scratch_
-0001d7b0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0001d7c0: 5d29 0a20 2020 2020 2020 2023 204d 616b  ]).        # Mak
-0001d7d0: 6520 7375 7265 2062 7563 6b65 7420 7761  e sure bucket wa
-0001d7e0: 7320 6e6f 7420 6372 6561 7465 6420 6475  s not created du
-0001d7f0: 7269 6e67 2064 656c 6574 696f 6e20 2873  ring deletion (s
-0001d800: 6565 2069 7373 7565 2023 3133 3232 290a  ee issue #1322).
-0001d810: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-0001d820: 6372 6561 7465 6427 206e 6f74 2069 6e20  created' not in 
-0001d830: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-0001d840: 3827 292e 6c6f 7765 7228 290a 0a20 2020  8').lower()..   
-0001d850: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-0001d860: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
-0001d870: 636b 2069 6620 7374 6f72 6167 6520 6f62  ck if storage ob
-0001d880: 6a65 6374 2069 7320 6465 6c65 7465 640a  ject is deleted.
-0001d890: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-0001d8a0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0001d8b0: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
-0001d8c0: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
-0001d8d0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0001d8e0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-0001d8f0: 6765 5f6f 626a 2e6e 616d 6520 6e6f 7420  ge_obj.name not 
-0001d900: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-0001d910: 7466 2d38 2729 0a0a 2020 2020 4070 7974  tf-8')..    @pyt
-0001d920: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-0001d930: 7269 7a65 2827 7374 6f72 655f 7479 7065  rize('store_type
-0001d940: 272c 205b 0a20 2020 2020 2020 2073 746f  ', [.        sto
-0001d950: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0001d960: 7065 2e53 332c 2073 746f 7261 6765 5f6c  pe.S3, storage_l
-0001d970: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-0001d980: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-0001d990: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-0001d9a0: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-0001d9b0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0001d9c0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
-0001d9d0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
-0001d9e0: 7374 5f62 7563 6b65 745f 6275 6c6b 5f64  st_bucket_bulk_d
-0001d9f0: 656c 6574 696f 6e28 7365 6c66 2c20 7374  eletion(self, st
-0001da00: 6f72 655f 7479 7065 2c20 746d 705f 6275  ore_type, tmp_bu
-0001da10: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
-0001da20: 626a 293a 0a20 2020 2020 2020 2023 2043  bj):.        # C
-0001da30: 7265 6174 6573 2061 2074 656d 7020 666f  reates a temp fo
-0001da40: 6c64 6572 2077 6974 6820 6f76 6572 2032  lder with over 2
-0001da50: 3536 2066 696c 6573 2061 6e64 2066 6f6c  56 files and fol
-0001da60: 6465 7273 2c20 7570 6c6f 6164 0a20 2020  ders, upload.   
-0001da70: 2020 2020 2023 2066 696c 6573 2061 6e64       # files and
-0001da80: 2066 6f6c 6465 7273 2074 6f20 6120 6e65   folders to a ne
-0001da90: 7720 6275 636b 6574 2c20 7468 656e 2064  w bucket, then d
-0001daa0: 656c 6574 6520 6275 636b 6574 2e0a 2020  elete bucket..  
-0001dab0: 2020 2020 2020 746d 705f 6275 6c6b 5f64        tmp_bulk_d
-0001dac0: 656c 5f73 746f 7261 6765 5f6f 626a 2e61  el_storage_obj.a
-0001dad0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0001dae0: 7970 6529 0a0a 2020 2020 2020 2020 7375  ype)..        su
-0001daf0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0001db00: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
-0001db10: 2020 205b 2773 6b79 272c 2027 7374 6f72     ['sky', 'stor
-0001db20: 6167 6527 2c20 2764 656c 6574 6527 2c20  age', 'delete', 
-0001db30: 746d 705f 6275 6c6b 5f64 656c 5f73 746f  tmp_bulk_del_sto
-0001db40: 7261 6765 5f6f 626a 2e6e 616d 655d 290a  rage_obj.name]).
-0001db50: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
-0001db60: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-0001db70: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-0001db80: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-0001db90: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-0001dba0: 7274 2074 6d70 5f62 756c 6b5f 6465 6c5f  rt tmp_bulk_del_
-0001dbb0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0001dbc0: 206e 6f74 2069 6e20 6f75 7470 7574 2e64   not in output.d
-0001dbd0: 6563 6f64 6528 2775 7466 2d38 2729 0a0a  ecode('utf-8')..
-0001dbe0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-0001dbf0: 2e70 6172 616d 6574 7269 7a65 280a 2020  .parametrize(.  
-0001dc00: 2020 2020 2020 2774 6d70 5f70 7562 6c69        'tmp_publi
-0001dc10: 635f 7374 6f72 6167 655f 6f62 6a2c 2073  c_storage_obj, s
-0001dc20: 746f 7265 5f74 7970 6527 2c0a 2020 2020  tore_type',.    
-0001dc30: 2020 2020 5b28 2773 333a 2f2f 7463 6761      [('s3://tcga
-0001dc40: 2d32 2d6f 7065 6e27 2c20 7374 6f72 6167  -2-open', storag
-0001dc50: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001dc60: 5333 292c 0a20 2020 2020 2020 2020 2827  S3),.         ('
-0001dc70: 7333 3a2f 2f64 6967 6974 616c 636f 7270  s3://digitalcorp
-0001dc80: 6f72 6127 2c20 7374 6f72 6167 655f 6c69  ora', storage_li
-0001dc90: 622e 5374 6f72 6554 7970 652e 5333 292c  b.StoreType.S3),
-0001dca0: 0a20 2020 2020 2020 2020 2827 6773 3a2f  .         ('gs:/
-0001dcb0: 2f67 6370 2d70 7562 6c69 632d 6461 7461  /gcp-public-data
-0001dcc0: 2d73 656e 7469 6e65 6c2d 3227 2c20 7374  -sentinel-2', st
-0001dcd0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001dce0: 7970 652e 4743 5329 5d2c 0a20 2020 2020  ype.GCS)],.     
-0001dcf0: 2020 2069 6e64 6972 6563 743d 5b27 746d     indirect=['tm
-0001dd00: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
-0001dd10: 5f6f 626a 275d 290a 2020 2020 6465 6620  _obj']).    def 
-0001dd20: 7465 7374 5f70 7562 6c69 635f 6275 636b  test_public_buck
-0001dd30: 6574 2873 656c 662c 2074 6d70 5f70 7562  et(self, tmp_pub
-0001dd40: 6c69 635f 7374 6f72 6167 655f 6f62 6a2c  lic_storage_obj,
-0001dd50: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
-0001dd60: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-0001dd70: 6120 6e65 7720 6275 636b 6574 2077 6974  a new bucket wit
-0001dd80: 6820 6120 7075 626c 6963 2073 6f75 7263  h a public sourc
-0001dd90: 6520 616e 6420 7665 7269 6669 6573 2074  e and verifies t
-0001dda0: 6861 7420 6974 2069 7320 6e6f 740a 2020  hat it is not.  
-0001ddb0: 2020 2020 2020 2320 6164 6465 6420 746f        # added to
-0001ddc0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-0001ddd0: 7465 2e0a 2020 2020 2020 2020 746d 705f  te..        tmp_
-0001dde0: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
-0001ddf0: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
-0001de00: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
-0001de10: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-0001de20: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
-0001de30: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
-0001de40: 7420 6578 6973 7473 2069 6e20 7468 6520  t exists in the 
-0001de50: 6f75 7470 7574 0a20 2020 2020 2020 206f  output.        o
-0001de60: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-0001de70: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
-0001de80: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-0001de90: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
-0001dea0: 7373 6572 7420 746d 705f 7075 626c 6963  ssert tmp_public
-0001deb0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
-0001dec0: 6520 6e6f 7420 696e 206f 7574 2e64 6563  e not in out.dec
-0001ded0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
-0001dee0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-0001def0: 6172 616d 6574 7269 7a65 2827 6e6f 6e65  arametrize('none
-0001df00: 7869 7374 5f62 7563 6b65 745f 7572 6c27  xist_bucket_url'
-0001df10: 2c20 5b0a 2020 2020 2020 2020 2773 333a  , [.        's3:
-0001df20: 2f2f 7b72 616e 646f 6d5f 6e61 6d65 7d27  //{random_name}'
-0001df30: 2c20 2767 733a 2f2f 7b72 616e 646f 6d5f  , 'gs://{random_
-0001df40: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0001df50: 7079 7465 7374 2e70 6172 616d 2827 7232  pytest.param('r2
-0001df60: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
-0001df70: 272c 206d 6172 6b73 3d70 7974 6573 742e  ', marks=pytest.
-0001df80: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
-0001df90: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-0001dfa0: 7465 7374 5f6e 6f6e 6578 6973 7465 6e74  test_nonexistent
-0001dfb0: 5f62 7563 6b65 7428 7365 6c66 2c20 6e6f  _bucket(self, no
-0001dfc0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-0001dfd0: 6c29 3a0a 2020 2020 2020 2020 2320 4174  l):.        # At
-0001dfe0: 7465 6d70 7473 2074 6f20 6372 6561 7465  tempts to create
-0001dff0: 2066 6574 6368 2061 2073 7472 6f61 6765   fetch a stroage
-0001e000: 2077 6974 6820 6120 6e6f 6e2d 6578 6973   with a non-exis
-0001e010: 7465 6e74 2073 6f75 7263 652e 0a20 2020  tent source..   
-0001e020: 2020 2020 2023 2047 656e 6572 6174 6520       # Generate 
-0001e030: 6120 7261 6e64 6f6d 2062 7563 6b65 7420  a random bucket 
-0001e040: 6e61 6d65 2061 6e64 2076 6572 6966 7920  name and verify 
-0001e050: 6974 2064 6f65 736e 2774 2065 7869 7374  it doesn't exist
-0001e060: 3a0a 2020 2020 2020 2020 7265 7472 795f  :.        retry_
-0001e070: 636f 756e 7420 3d20 300a 2020 2020 2020  count = 0.      
-0001e080: 2020 7768 696c 6520 5472 7565 3a0a 2020    while True:.  
-0001e090: 2020 2020 2020 2020 2020 6e6f 6e65 7869            nonexi
-0001e0a0: 7374 5f62 7563 6b65 745f 6e61 6d65 203d  st_bucket_name =
-0001e0b0: 2073 7472 2875 7569 642e 7575 6964 3428   str(uuid.uuid4(
-0001e0c0: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-0001e0d0: 6620 6e6f 6e65 7869 7374 5f62 7563 6b65  f nonexist_bucke
-0001e0e0: 745f 7572 6c2e 7374 6172 7473 7769 7468  t_url.startswith
-0001e0f0: 2827 7333 2729 3a0a 2020 2020 2020 2020  ('s3'):.        
-0001e100: 2020 2020 2020 2020 636f 6d6d 616e 6420          command 
-0001e110: 3d20 6627 6177 7320 7333 6170 6920 6865  = f'aws s3api he
-0001e120: 6164 2d62 7563 6b65 7420 2d2d 6275 636b  ad-bucket --buck
-0001e130: 6574 207b 6e6f 6e65 7869 7374 5f62 7563  et {nonexist_buc
-0001e140: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-0001e150: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-0001e160: 7465 645f 6f75 7470 7574 203d 2027 3430  ted_output = '40
-0001e170: 3427 0a20 2020 2020 2020 2020 2020 2065  4'.            e
-0001e180: 6c69 6620 6e6f 6e65 7869 7374 5f62 7563  lif nonexist_buc
-0001e190: 6b65 745f 7572 6c2e 7374 6172 7473 7769  ket_url.startswi
-0001e1a0: 7468 2827 6773 2729 3a0a 2020 2020 2020  th('gs'):.      
-0001e1b0: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
-0001e1c0: 6420 3d20 6627 6773 7574 696c 206c 7320  d = f'gsutil ls 
-0001e1d0: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
-0001e1e0: 5f75 726c 2e66 6f72 6d61 7428 7261 6e64  _url.format(rand
-0001e1f0: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
-0001e200: 5f62 7563 6b65 745f 6e61 6d65 297d 270a  _bucket_name)}'.
-0001e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e220: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
-0001e230: 3d20 2742 7563 6b65 744e 6f74 466f 756e  = 'BucketNotFoun
-0001e240: 6445 7863 6570 7469 6f6e 270a 2020 2020  dException'.    
-0001e250: 2020 2020 2020 2020 656c 6966 206e 6f6e          elif non
-0001e260: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
-0001e270: 2e73 7461 7274 7377 6974 6828 2772 3227  .startswith('r2'
-0001e280: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001e290: 2020 2065 6e64 706f 696e 745f 7572 6c20     endpoint_url 
-0001e2a0: 3d20 636c 6f75 6466 6c61 7265 2e63 7265  = cloudflare.cre
-0001e2b0: 6174 655f 656e 6470 6f69 6e74 2829 0a20  ate_endpoint(). 
-0001e2c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e2d0: 6f6d 6d61 6e64 203d 2066 2741 5753 5f53  ommand = f'AWS_S
-0001e2e0: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-0001e2f0: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-0001e300: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-0001e310: 535f 5041 5448 7d20 6177 7320 7333 6170  S_PATH} aws s3ap
-0001e320: 6920 6865 6164 2d62 7563 6b65 7420 2d2d  i head-bucket --
-0001e330: 6275 636b 6574 207b 6e6f 6e65 7869 7374  bucket {nonexist
-0001e340: 5f62 7563 6b65 745f 6e61 6d65 7d20 2d2d  _bucket_name} --
-0001e350: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-0001e360: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-0001e370: 653d 7232 270a 2020 2020 2020 2020 2020  e=r2'.          
-0001e380: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
-0001e390: 7574 7075 7420 3d20 2734 3034 270a 2020  utput = '404'.  
-0001e3a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3c0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0001e3d0: 2827 556e 7375 7070 6f72 7465 6420 6275  ('Unsupported bu
-0001e3e0: 636b 6574 2074 7970 6520 270a 2020 2020  cket type '.    
-0001e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e400: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-0001e410: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-0001e420: 7572 6c7d 2729 0a0a 2020 2020 2020 2020  url}')..        
-0001e430: 2020 2020 2320 4368 6563 6b20 6966 2062      # Check if b
-0001e440: 7563 6b65 7420 6578 6973 7473 2075 7369  ucket exists usi
-0001e450: 6e67 2074 6865 2063 6c69 3a0a 2020 2020  ng the cli:.    
-0001e460: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0001e470: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0001e480: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0001e490: 6563 6b5f 6f75 7470 7574 2863 6f6d 6d61  eck_output(comma
-0001e4a0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-0001e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4d0: 2020 7374 6465 7272 3d73 7562 7072 6f63    stderr=subproc
-0001e4e0: 6573 732e 5354 444f 5554 2c0a 2020 2020  ess.STDOUT,.    
-0001e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e510: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-0001e520: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0001e530: 2020 6578 6365 7074 2073 7562 7072 6f63    except subproc
-0001e540: 6573 732e 4361 6c6c 6564 5072 6f63 6573  ess.CalledProces
-0001e550: 7345 7272 6f72 2061 7320 653a 0a20 2020  sError as e:.   
-0001e560: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0001e570: 203d 2065 2e6f 7574 7075 740a 2020 2020   = e.output.    
-0001e580: 2020 2020 2020 2020 6f75 7420 3d20 6f75          out = ou
-0001e590: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-0001e5a0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001e5b0: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
-0001e5c0: 2069 6e20 6f75 743a 0a20 2020 2020 2020   in out:.       
-0001e5d0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-0001e5e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001e5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e600: 2072 6574 7279 5f63 6f75 6e74 202b 3d20   retry_count += 
-0001e610: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0001e620: 2020 6966 2072 6574 7279 5f63 6f75 6e74    if retry_count
-0001e630: 203e 2033 3a0a 2020 2020 2020 2020 2020   > 3:.          
-0001e640: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001e650: 5275 6e74 696d 6545 7272 6f72 2827 556e  RuntimeError('Un
-0001e660: 6162 6c65 2074 6f20 6669 6e64 2061 206e  able to find a n
-0001e670: 6f6e 6578 6973 7465 6e74 2062 7563 6b65  onexistent bucke
-0001e680: 7420 270a 2020 2020 2020 2020 2020 2020  t '.            
-0001e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6a0: 2020 2020 2020 2020 2020 2027 746f 2075             'to u
-0001e6b0: 7365 2e20 5468 6973 2069 7320 6869 676c  se. This is higl
-0001e6c0: 7920 756e 6c69 6b65 6c79 202d 2027 0a20  y unlikely - '. 
-0001e6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e6f0: 2020 2020 2020 2763 6865 636b 2069 6620        'check if 
-0001e700: 7468 6520 7465 7374 7320 6172 6520 636f  the tests are co
-0001e710: 7272 6563 742e 2729 0a0a 2020 2020 2020  rrect.')..      
-0001e720: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
-0001e730: 6973 6573 280a 2020 2020 2020 2020 2020  ises(.          
-0001e740: 2020 2020 2020 736b 792e 6578 6365 7074        sky.except
-0001e750: 696f 6e73 2e53 746f 7261 6765 4275 636b  ions.StorageBuck
-0001e760: 6574 4765 7445 7272 6f72 2c0a 2020 2020  etGetError,.    
-0001e770: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-0001e780: 683d 2741 7474 656d 7074 6564 2074 6f20  h='Attempted to 
-0001e790: 636f 6e6e 6563 7420 746f 2061 206e 6f6e  connect to a non
-0001e7a0: 2d65 7869 7374 656e 7420 6275 636b 6574  -existent bucket
-0001e7b0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-0001e7c0: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
-0001e7d0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
-0001e7e0: 6528 736f 7572 6365 3d6e 6f6e 6578 6973  e(source=nonexis
-0001e7f0: 745f 6275 636b 6574 5f75 726c 2e66 6f72  t_bucket_url.for
-0001e800: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-0001e810: 2020 2020 2072 616e 646f 6d5f 6e61 6d65       random_name
-0001e820: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
-0001e830: 5f6e 616d 6529 290a 0a20 2020 2040 7079  _name))..    @py
-0001e840: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-0001e850: 7472 697a 6528 2770 7269 7661 7465 5f62  trize('private_b
-0001e860: 7563 6b65 7427 2c0a 2020 2020 2020 2020  ucket',.        
-0001e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e880: 2020 2020 205b 6627 7333 3a2f 2f69 6d61       [f's3://ima
-0001e890: 6765 6e65 7427 2c20 6627 6773 3a2f 2f69  genet', f'gs://i
-0001e8a0: 6d61 6765 6e65 7427 5d29 0a20 2020 2064  magenet']).    d
-0001e8b0: 6566 2074 6573 745f 7072 6976 6174 655f  ef test_private_
-0001e8c0: 6275 636b 6574 2873 656c 662c 2070 7269  bucket(self, pri
-0001e8d0: 7661 7465 5f62 7563 6b65 7429 3a0a 2020  vate_bucket):.  
-0001e8e0: 2020 2020 2020 2320 4174 7465 6d70 7473        # Attempts
-0001e8f0: 2074 6f20 6163 6365 7373 2070 7269 7661   to access priva
-0001e900: 7465 2062 7563 6b65 7473 206e 6f74 2062  te buckets not b
-0001e910: 656c 6f6e 6769 6e67 2074 6f20 7468 6520  elonging to the 
-0001e920: 7573 6572 2e0a 2020 2020 2020 2020 2320  user..        # 
-0001e930: 5468 6573 6520 6275 636b 6574 7320 6172  These buckets ar
-0001e940: 6520 6b6e 6f77 6e20 746f 2062 6520 7072  e known to be pr
-0001e950: 6976 6174 652c 2062 7574 206d 6179 206e  ivate, but may n
-0001e960: 6565 6420 746f 2062 6520 7570 6461 7465  eed to be update
-0001e970: 6420 6966 0a20 2020 2020 2020 2023 2074  d if.        # t
-0001e980: 6865 7920 6172 6520 7265 6d6f 7665 6420  hey are removed 
-0001e990: 6279 2074 6865 6972 206f 776e 6572 732e  by their owners.
-0001e9a0: 0a20 2020 2020 2020 2070 7269 7661 7465  .        private
-0001e9b0: 5f62 7563 6b65 745f 6e61 6d65 203d 2075  _bucket_name = u
-0001e9c0: 726c 6c69 622e 7061 7273 652e 7572 6c73  rllib.parse.urls
-0001e9d0: 706c 6974 2870 7269 7661 7465 5f62 7563  plit(private_buc
-0001e9e0: 6b65 7429 2e6e 6574 6c6f 630a 2020 2020  ket).netloc.    
-0001e9f0: 2020 2020 7769 7468 2070 7974 6573 742e      with pytest.
-0001ea00: 7261 6973 6573 280a 2020 2020 2020 2020  raises(.        
-0001ea10: 2020 2020 2020 2020 736b 792e 6578 6365          sky.exce
-0001ea20: 7074 696f 6e73 2e53 746f 7261 6765 4275  ptions.StorageBu
-0001ea30: 636b 6574 4765 7445 7272 6f72 2c0a 2020  cketGetError,.  
-0001ea40: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0001ea50: 7463 683d 7374 6f72 6167 655f 6c69 622e  tch=storage_lib.
-0001ea60: 5f42 5543 4b45 545f 4641 494c 5f54 4f5f  _BUCKET_FAIL_TO_
-0001ea70: 434f 4e4e 4543 545f 4d45 5353 4147 452e  CONNECT_MESSAGE.
-0001ea80: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
-0001ea90: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0001eaa0: 3d70 7269 7661 7465 5f62 7563 6b65 745f  =private_bucket_
-0001eab0: 6e61 6d65 2929 3a0a 2020 2020 2020 2020  name)):.        
-0001eac0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-0001ead0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0001eae0: 6f72 6167 6528 736f 7572 6365 3d70 7269  orage(source=pri
-0001eaf0: 7661 7465 5f62 7563 6b65 7429 0a0a 2020  vate_bucket)..  
-0001eb00: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-0001eb10: 6172 616d 6574 7269 7a65 2827 6578 745f  arametrize('ext_
-0001eb20: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
-0001eb30: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
-0001eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb50: 2020 2020 2020 2020 2020 5b28 2774 6d70            [('tmp
-0001eb60: 5f61 7773 636c 695f 6275 636b 6574 272c  _awscli_bucket',
-0001eb70: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0001eb80: 7265 5479 7065 2e53 3329 2c0a 2020 2020  reType.S3),.    
-0001eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eba0: 2020 2020 2020 2020 2020 2827 746d 705f            ('tmp_
-0001ebb0: 6773 7574 696c 5f62 7563 6b65 7427 2c20  gsutil_bucket', 
-0001ebc0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-0001ebd0: 6554 7970 652e 4743 5329 2c0a 2020 2020  eType.GCS),.    
-0001ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebf0: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
-0001ec00: 2e70 6172 616d 2827 746d 705f 6177 7363  .param('tmp_awsc
-0001ec10: 6c69 5f62 7563 6b65 745f 7232 272c 0a20  li_bucket_r2',. 
-0001ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec40: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-0001ec50: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0001ec60: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
-0001ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec80: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001ec90: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-0001eca0: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
-0001ecb0: 2020 2064 6566 2074 6573 745f 7570 6c6f     def test_uplo
-0001ecc0: 6164 5f74 6f5f 6578 6973 7469 6e67 5f62  ad_to_existing_b
-0001ecd0: 7563 6b65 7428 7365 6c66 2c20 6578 745f  ucket(self, ext_
-0001ece0: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
-0001ecf0: 7265 7175 6573 742c 0a20 2020 2020 2020  request,.       
-0001ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed20: 746d 705f 736f 7572 6365 2c20 7374 6f72  tmp_source, stor
-0001ed30: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
-0001ed40: 2023 2054 7269 6573 2075 706c 6f61 6469   # Tries uploadi
-0001ed50: 6e67 2065 7869 7374 696e 6720 6669 6c65  ng existing file
-0001ed60: 7320 746f 206e 6577 6c79 2063 7265 6174  s to newly creat
-0001ed70: 6564 2062 7563 6b65 7420 286f 7574 7369  ed bucket (outsi
-0001ed80: 6465 206f 660a 2020 2020 2020 2020 2320  de of.        # 
-0001ed90: 736b 7929 2061 6e64 2076 6572 6966 6965  sky) and verifie
-0001eda0: 7320 7468 6174 2066 696c 6573 2061 7265  s that files are
-0001edb0: 2077 7269 7474 656e 2e0a 2020 2020 2020   written..      
-0001edc0: 2020 6275 636b 6574 5f6e 616d 6520 3d20    bucket_name = 
-0001edd0: 7265 7175 6573 742e 6765 7466 6978 7475  request.getfixtu
-0001ede0: 7265 7661 6c75 6528 6578 745f 6275 636b  revalue(ext_buck
-0001edf0: 6574 5f66 6978 7475 7265 290a 2020 2020  et_fixture).    
-0001ee00: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-0001ee10: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-0001ee20: 6f72 6167 6528 6e61 6d65 3d62 7563 6b65  orage(name=bucke
-0001ee30: 745f 6e61 6d65 2c20 736f 7572 6365 3d74  t_name, source=t
-0001ee40: 6d70 5f73 6f75 7263 6529 0a20 2020 2020  mp_source).     
-0001ee50: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
-0001ee60: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-0001ee70: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
-0001ee80: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
-0001ee90: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
-0001eea0: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
-0001eeb0: 7420 7573 696e 6720 6177 7320 636c 690a  t using aws cli.
-0001eec0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-0001eed0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-0001eee0: 7574 7075 7428 7365 6c66 2e63 6c69 5f6c  utput(self.cli_l
-0001eef0: 735f 636d 6428 7374 6f72 655f 7479 7065  s_cmd(store_type
-0001ef00: 2c20 6275 636b 6574 5f6e 616d 6529 2c0a  , bucket_name),.
-0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef30: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-0001ef40: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0001ef50: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
-0001ef60: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0001ef70: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
-0001ef80: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
-0001ef90: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
-0001efa0: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
-0001efb0: 6f72 6d61 7428 6f75 742e 6465 636f 6465  ormat(out.decode
-0001efc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f000: 2028 2775 7466 2d38 2729 290a 0a20 2020   ('utf-8'))..   
-0001f010: 2020 2020 2023 2043 6865 636b 2073 796d       # Check sym
-0001f020: 6c69 6e6b 7320 2d20 7379 6d6c 696e 6b73  links - symlinks
-0001f030: 2064 6f6e 2774 2067 6574 2063 6f70 6965   don't get copie
-0001f040: 6420 6279 2073 6b79 2073 746f 7261 6765  d by sky storage
-0001f050: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001f060: 2870 6174 686c 6962 2e50 6174 6828 746d  (pathlib.Path(tm
-0001f070: 705f 736f 7572 6365 2920 2f20 2763 6972  p_source) / 'cir
-0001f080: 636c 652d 6c69 6e6b 2729 2e69 735f 7379  cle-link').is_sy
-0001f090: 6d6c 696e 6b28 292c 2028 0a20 2020 2020  mlink(), (.     
-0001f0a0: 2020 2020 2020 2027 6369 7263 6c65 2d6c         'circle-l
-0001f0b0: 696e 6b20 7761 7320 6e6f 7420 666f 756e  ink was not foun
-0001f0c0: 6420 696e 2074 6865 2075 706c 6f61 6420  d in the upload 
-0001f0d0: 736f 7572 6365 202d 2027 0a20 2020 2020  source - '.     
-0001f0e0: 2020 2020 2020 2027 6172 6520 7468 6520         'are the 
-0001f0f0: 7465 7374 2066 6978 7475 7265 7320 636f  test fixtures co
-0001f100: 7272 6563 743f 2729 0a20 2020 2020 2020  rrect?').       
-0001f110: 2061 7373 6572 7420 2763 6972 636c 652d   assert 'circle-
-0001f120: 6c69 6e6b 2720 6e6f 7420 696e 206f 7574  link' not in out
-0001f130: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-0001f140: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-0001f150: 2753 796d 6c69 6e6b 2066 6f75 6e64 2069  'Symlink found i
-0001f160: 6e20 6275 636b 6574 202d 206c 7320 6f75  n bucket - ls ou
-0001f170: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
-0001f180: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
-0001f190: 2020 2020 2020 206f 7574 2e64 6563 6f64         out.decod
-0001f1a0: 6528 2775 7466 2d38 2729 2929 0a0a 2020  e('utf-8')))..  
-0001f1b0: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-0001f1c0: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-0001f1d0: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
-0001f1e0: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
-0001f1f0: 7468 6520 6f75 7470 7574 2e0a 2020 2020  the output..    
-0001f200: 2020 2020 2320 4974 2073 686f 756c 6420      # It should 
-0001f210: 6e6f 7420 6578 6973 7420 6265 6361 7573  not exist becaus
-0001f220: 6520 7468 6520 6275 636b 6574 2077 6173  e the bucket was
-0001f230: 2063 7265 6174 6564 2065 7874 6572 6e61   created externa
-0001f240: 6c6c 792e 0a20 2020 2020 2020 206f 7574  lly..        out
-0001f250: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0001f260: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-0001f270: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-0001f280: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-0001f290: 6572 7420 7374 6f72 6167 655f 6f62 6a2e  ert storage_obj.
-0001f2a0: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
-0001f2b0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-0001f2c0: 0a20 2020 2064 6566 2074 6573 745f 636f  .    def test_co
-0001f2d0: 7079 5f6d 6f75 6e74 5f65 7869 7374 696e  py_mount_existin
-0001f2e0: 675f 7374 6f72 6167 6528 7365 6c66 2c0a  g_storage(self,.
-0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f310: 2020 2020 2020 2020 2074 6d70 5f63 6f70           tmp_cop
-0001f320: 795f 6d6e 745f 6578 6973 7469 6e67 5f73  y_mnt_existing_s
-0001f330: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
-0001f340: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-0001f350: 2062 7563 6b65 7420 7769 7468 206e 6f20   bucket with no 
-0001f360: 736f 7572 6365 2069 6e20 4d4f 554e 5420  source in MOUNT 
-0001f370: 6d6f 6465 2028 656d 7074 7920 6275 636b  mode (empty buck
-0001f380: 6574 292c 2061 6e64 0a20 2020 2020 2020  et), and.       
-0001f390: 2023 2074 6865 6e20 7472 6965 7320 746f   # then tries to
-0001f3a0: 206c 6f61 6420 7468 6520 7361 6d65 2073   load the same s
-0001f3b0: 746f 7261 6765 2069 6e20 434f 5059 206d  torage in COPY m
-0001f3c0: 6f64 652e 0a20 2020 2020 2020 2074 6d70  ode..        tmp
-0001f3d0: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
-0001f3e0: 6e67 5f73 746f 7261 6765 5f6f 626a 2e61  ng_storage_obj.a
-0001f3f0: 6464 5f73 746f 7265 2873 746f 7261 6765  dd_store(storage
-0001f400: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-0001f410: 3329 0a20 2020 2020 2020 2073 746f 7261  3).        stora
-0001f420: 6765 5f6e 616d 6520 3d20 746d 705f 636f  ge_name = tmp_co
-0001f430: 7079 5f6d 6e74 5f65 7869 7374 696e 675f  py_mnt_existing_
-0001f440: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0001f450: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-0001f460: 6b20 6073 6b79 2073 746f 7261 6765 206c  k `sky storage l
-0001f470: 7360 2074 6f20 656e 7375 7265 2073 746f  s` to ensure sto
-0001f480: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-0001f490: 7473 0a20 2020 2020 2020 206f 7574 203d  ts.        out =
-0001f4a0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-0001f4b0: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-0001f4c0: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-0001f4d0: 5d29 2e64 6563 6f64 6528 2775 7466 2d38  ]).decode('utf-8
-0001f4e0: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
-0001f4f0: 7420 7374 6f72 6167 655f 6e61 6d65 2069  t storage_name i
-0001f500: 6e20 6f75 742c 2066 2753 746f 7261 6765  n out, f'Storage
-0001f510: 207b 7374 6f72 6167 655f 6e61 6d65 7d20   {storage_name} 
-0001f520: 6e6f 7420 666f 756e 6420 696e 2073 6b79  not found in sky
-0001f530: 2073 746f 7261 6765 206c 732e 270a 0a20   storage ls.'.. 
-0001f540: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-0001f550: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
-0001f560: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
-0001f570: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-0001f580: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
-0001f590: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001f5a0: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
-0001f5b0: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
-0001f5c0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001f5d0: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
-0001f5e0: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
-0001f5f0: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
-0001f600: 2064 6566 2074 6573 745f 6c69 7374 5f73   def test_list_s
-0001f610: 6f75 7263 6528 7365 6c66 2c20 746d 705f  ource(self, tmp_
-0001f620: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
-0001f630: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
-0001f640: 7065 293a 0a20 2020 2020 2020 2023 2055  pe):.        # U
-0001f650: 7365 7320 6120 6c69 7374 2069 6e20 7468  ses a list in th
-0001f660: 6520 736f 7572 6365 2066 6965 6c64 2074  e source field t
-0001f670: 6f20 7370 6563 6966 7920 6120 6669 6c65  o specify a file
-0001f680: 2061 6e64 2061 2064 6972 6563 746f 7279   and a directory
-0001f690: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
-0001f6a0: 2075 706c 6f61 6465 6420 746f 2074 6865   uploaded to the
-0001f6b0: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
-0001f6c0: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
-0001f6d0: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
-0001f6e0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
-0001f6f0: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
-0001f700: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
-0001f710: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
-0001f720: 2074 6865 2062 7563 6b65 7420 726f 6f74   the bucket root
-0001f730: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
-0001f740: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0001f750: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-0001f760: 2873 656c 662e 636c 695f 6c73 5f63 6d64  (self.cli_ls_cmd
-0001f770: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-0001f780: 6f72 655f 7479 7065 2c20 746d 705f 6c6f  ore_type, tmp_lo
-0001f790: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
-0001f7a0: 5f6f 626a 2e6e 616d 6529 2c0a 2020 2020  _obj.name),.    
-0001f7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7d0: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
-0001f7e0: 2020 2020 2020 6173 7365 7274 2027 746d        assert 'tm
-0001f7f0: 702d 6669 6c65 2720 696e 206f 7574 2e64  p-file' in out.d
-0001f800: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
-0001f810: 5c0a 2020 2020 2020 2020 2020 2020 2746  \.            'F
-0001f820: 696c 6520 6e6f 7420 666f 756e 6420 696e  ile not found in
-0001f830: 2062 7563 6b65 7420 2d20 6f75 7470 7574   bucket - output
-0001f840: 2077 6173 203a 207b 7d27 2e66 6f72 6d61   was : {}'.forma
-0001f850: 7428 6f75 742e 6465 636f 6465 0a20 2020  t(out.decode.   
-0001f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f890: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
-0001f8a0: 7466 2d38 2729 290a 0a20 2020 2020 2020  tf-8'))..       
-0001f8b0: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
-0001f8c0: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-0001f8d0: 6865 2062 7563 6b65 742f 746d 702d 736f  he bucket/tmp-so
-0001f8e0: 7572 6365 2075 7369 6e67 2063 6c69 0a20  urce using cli. 
-0001f8f0: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
-0001f900: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-0001f910: 7470 7574 2873 656c 662e 636c 695f 6c73  tput(self.cli_ls
-0001f920: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
-0001f930: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
-0001f940: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
-0001f950: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
-0001f960: 746d 702d 736f 7572 6365 2f27 292c 0a20  tmp-source/'),. 
-0001f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f990: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
-0001f9a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001f9b0: 2774 6d70 2d66 696c 6527 2069 6e20 6f75  'tmp-file' in ou
-0001f9c0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-0001f9d0: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
-0001f9e0: 2027 4669 6c65 206e 6f74 2066 6f75 6e64   'File not found
-0001f9f0: 2069 6e20 6275 636b 6574 202d 206f 7574   in bucket - out
-0001fa00: 7075 7420 7761 7320 3a20 7b7d 272e 666f  put was : {}'.fo
-0001fa10: 726d 6174 286f 7574 2e64 6563 6f64 650a  rmat(out.decode.
-0001fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097b0: 7920 7b6e 616d 657d 2032 272c 0a20 2020  y {name} 2',.   
+000097c0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000097d0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+000097e0: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
+000097f0: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
+00009800: 2d33 207c 2067 7265 7020 5255 4e4e 494e  -3 | grep RUNNIN
+00009810: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
+00009820: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+00009830: 7b6e 616d 657d 2033 272c 0a20 2020 2020  {name} 3',.     
+00009840: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00009850: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00009860: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00009870: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00009880: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00009890: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
+000098a0: 705f 6a6f 625f 7175 6575 6528 293a 0a20  p_job_queue():. 
+000098b0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+000098c0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000098d0: 2020 6e75 6d5f 6f66 5f67 7075 5f6c 6175    num_of_gpu_lau
+000098e0: 6e63 6820 3d20 310a 2020 2020 6e75 6d5f  nch = 1.    num_
+000098f0: 6f66 5f67 7075 5f65 7865 6320 3d20 302e  of_gpu_exec = 0.
+00009900: 350a 2020 2020 7465 7374 203d 2054 6573  5.    test = Tes
+00009910: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
+00009920: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
+00009930: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00009940: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00009950: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
+00009960: 5f54 5950 457d 207b 5343 505f 4750 555f  _TYPE} {SCP_GPU_
+00009970: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
+00009980: 755f 6c61 756e 6368 7d20 6578 616d 706c  u_launch} exampl
+00009990: 6573 2f6a 6f62 5f71 7565 7565 2f63 6c75  es/job_queue/clu
+000099a0: 7374 6572 2e79 616d 6c27 2c0a 2020 2020  ster.yaml',.    
+000099b0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000099c0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+000099d0: 6d65 7d2d 3120 7b53 4350 5f47 5055 5f56  me}-1 {SCP_GPU_V
+000099e0: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
+000099f0: 5f65 7865 637d 202d 6420 6578 616d 706c  _exec} -d exampl
+00009a00: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+00009a10: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00009a20: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00009a30: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+00009a40: 3220 7b53 4350 5f47 5055 5f56 3130 307d  2 {SCP_GPU_V100}
+00009a50: 3a7b 6e75 6d5f 6f66 5f67 7075 5f65 7865  :{num_of_gpu_exe
+00009a60: 637d 202d 6420 6578 616d 706c 6573 2f6a  c} -d examples/j
+00009a70: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
+00009a80: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00009a90: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00009aa0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 7b53  } -n {name}-3 {S
+00009ab0: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
+00009ac0: 6d5f 6f66 5f67 7075 5f65 7865 637d 202d  m_of_gpu_exec} -
+00009ad0: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+00009ae0: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
+00009af0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009b00: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+00009b10: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+00009b20: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+00009b30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009b40: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+00009b50: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+00009b60: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+00009b70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009b80: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+00009b90: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+00009ba0: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
+00009bb0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009bc0: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+00009bd0: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
+00009be0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+00009bf0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009c00: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
+00009c10: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
+00009c20: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
+00009c30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009c40: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+00009c50: 2033 272c 0a20 2020 2020 2020 205d 2c0a   3',.        ],.
+00009c60: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00009c70: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00009c80: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00009c90: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00009ca0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+00009cb0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+00009cc0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+00009cd0: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+00009ce0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00009cf0: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
+00009d00: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
+00009d10: 5434 2067 7075 732e 2072 756e 2074 6573  T4 gpus. run tes
+00009d20: 745f 6962 6d5f 6a6f 625f 7175 6575 655f  t_ibm_job_queue_
+00009d30: 6d75 6c74 696e 6f64 6520 696e 7374 6561  multinode instea
+00009d40: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
+00009d50: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+00009d60: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
+00009d70: 6d5f 6e6f 6465 7320 3e20 3120 7965 740a  m_nodes > 1 yet.
+00009d80: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00009d90: 6f63 6920 2023 204f 4349 2043 6c6f 7564  oci  # OCI Cloud
+00009da0: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
+00009db0: 3420 6770 7573 2e0a 6465 6620 7465 7374  4 gpus..def test
+00009dc0: 5f6a 6f62 5f71 7565 7565 5f6d 756c 7469  _job_queue_multi
+00009dd0: 6e6f 6465 2867 656e 6572 6963 5f63 6c6f  node(generic_clo
+00009de0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00009df0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00009e00: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00009e10: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00009e20: 2020 276a 6f62 5f71 7565 7565 5f6d 756c    'job_queue_mul
+00009e30: 7469 6e6f 6465 272c 0a20 2020 2020 2020  tinode',.       
+00009e40: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00009e50: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00009e60: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00009e70: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+00009e80: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+00009e90: 6575 652f 636c 7573 7465 725f 6d75 6c74  eue/cluster_mult
+00009ea0: 696e 6f64 652e 7961 6d6c 272c 0a20 2020  inode.yaml',.   
+00009eb0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00009ec0: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
+00009ed0: 616d 657d 2d31 202d 6420 6578 616d 706c  ame}-1 -d exampl
+00009ee0: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+00009ef0: 5f6d 756c 7469 6e6f 6465 2e79 616d 6c27  _multinode.yaml'
+00009f00: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009f10: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00009f20: 2d6e 207b 6e61 6d65 7d2d 3220 2d64 2065  -n {name}-2 -d e
+00009f30: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+00009f40: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
+00009f50: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00009f60: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00009f70: 2d63 207b 6e61 6d65 7d20 2d6e 207b 6e61  -c {name} -n {na
+00009f80: 6d65 7d2d 3320 2d2d 6465 7461 6368 2d73  me}-3 --detach-s
+00009f90: 6574 7570 202d 6420 6578 616d 706c 6573  etup -d examples
+00009fa0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f6d  /job_queue/job_m
+00009fb0: 756c 7469 6e6f 6465 2e79 616d 6c27 2c0a  ultinode.yaml',.
+00009fc0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00009fd0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+00009fe0: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+00009ff0: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000a000: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000a010: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000a020: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a030: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000a040: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
+0000a050: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
+0000a060: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+0000a070: 7c20 6772 6570 2052 554e 4e49 4e47 2927  | grep RUNNING)'
+0000a080: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000a090: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000a0a0: 616d 657d 2920 2626 2065 6368 6f20 2224  ame}) && echo "$
+0000a0b0: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
+0000a0c0: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
+0000a0d0: 207c 2067 7265 7020 5045 4e44 494e 4729   | grep PENDING)
+0000a0e0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0000a0f0: 736c 6565 7020 3930 272c 0a20 2020 2020  sleep 90',.     
+0000a100: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
+0000a110: 6365 6c20 2d79 207b 6e61 6d65 7d20 3127  cel -y {name} 1'
+0000a120: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0000a130: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
+0000a140: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000a150: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+0000a160: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000a170: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000a180: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000a190: 2067 7265 7020 5345 5454 494e 475f 5550   grep SETTING_UP
+0000a1a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000a1b0: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000a1c0: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
+0000a1d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a1e0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+0000a1f0: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
+0000a200: 6574 6163 682d 7365 7475 7020 2d64 2065  etach-setup -d e
+0000a210: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000a220: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
+0000a230: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000a240: 2020 2023 2054 6573 7420 7468 6520 6a6f     # Test the jo
+0000a250: 6220 7374 6174 7573 2069 7320 636f 7272  b status is corr
+0000a260: 6563 746c 7920 7365 7420 746f 2053 4554  ectly set to SET
+0000a270: 5449 4e47 5f55 502c 2064 7572 696e 6720  TING_UP, during 
+0000a280: 7468 6520 7365 7475 7020 6973 2072 756e  the setup is run
+0000a290: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+0000a2a0: 2020 2320 616e 6420 7468 6520 6a6f 6220    # and the job 
+0000a2b0: 6361 6e20 6265 2063 616e 6365 6c6c 6564  can be cancelled
+0000a2c0: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
+0000a2d0: 702e 0a20 2020 2020 2020 2020 2020 2027  p..            '
+0000a2e0: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
+0000a2f0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000a300: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
+0000a310: 2065 6368 6f20 2224 7322 2026 2620 2865   echo "$s" && (e
+0000a320: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000a330: 7b6e 616d 657d 2d34 207c 2067 7265 7020  {name}-4 | grep 
+0000a340: 5345 5454 494e 475f 5550 2927 2c0a 2020  SETTING_UP)',.  
+0000a350: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a360: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+0000a370: 2034 272c 0a20 2020 2020 2020 2020 2020   4',.           
+0000a380: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000a390: 207b 6e61 6d65 7d29 2026 2620 6563 686f   {name}) && echo
+0000a3a0: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
+0000a3b0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000a3c0: 7d2d 3420 7c20 6772 6570 2043 414e 4345  }-4 | grep CANCE
+0000a3d0: 4c4c 4544 2927 2c0a 2020 2020 2020 2020  LLED)',.        
+0000a3e0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000a3f0: 6e61 6d65 7d20 2d2d 6770 7573 2054 343a  name} --gpus T4:
+0000a400: 302e 3220 225b 5b20 5c24 534b 5950 494c  0.2 "[[ \$SKYPIL
+0000a410: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
+0000a420: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
+0000a430: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0000a440: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000a450: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
+0000a460: 5434 3a30 2e32 202d 2d6e 756d 2d6e 6f64  T4:0.2 --num-nod
+0000a470: 6573 2032 2022 5b5b 205c 2453 4b59 5049  es 2 "[[ \$SKYPI
+0000a480: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
+0000a490: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
+0000a4a0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
+0000a4b0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000a4c0: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
+0000a4d0: 2054 343a 3120 2d2d 6e75 6d2d 6e6f 6465   T4:1 --num-node
+0000a4e0: 7320 3220 225b 5b20 5c24 534b 5950 494c  s 2 "[[ \$SKYPIL
+0000a4f0: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
+0000a500: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
+0000a510: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+0000a520: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000a530: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
+0000a540: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+0000a550: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000a560: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
+0000a570: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a580: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
+0000a590: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000a5a0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000a5b0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000a5c0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0000a5d0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000a5e0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0000a5f0: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+0000a600: 6420 2023 204e 6f20 4c61 6d62 6461 2043  d  # No Lambda C
+0000a610: 6c6f 7564 2056 4d20 6861 7320 3820 4350  loud VM has 8 CP
+0000a620: 5573 0a64 6566 2074 6573 745f 6c61 7267  Us.def test_larg
+0000a630: 655f 6a6f 625f 7175 6575 6528 6765 6e65  e_job_queue(gene
+0000a640: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+0000a650: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000a660: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000a670: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000a680: 0a20 2020 2020 2020 2027 6c61 7267 655f  .        'large_
+0000a690: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
+0000a6a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000a6b0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000a6c0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+0000a6d0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+0000a6e0: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
+0000a6f0: 2020 6627 666f 7220 6920 696e 2060 7365    f'for i in `se
+0000a700: 7120 3120 3735 603b 2064 6f20 736b 7920  q 1 75`; do sky 
+0000a710: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+0000a720: 6e61 6d65 7d2d 2469 202d 6420 2265 6368  name}-$i -d "ech
+0000a730: 6f20 2469 3b20 736c 6565 7020 3130 3030  o $i; sleep 1000
+0000a740: 3030 3030 3022 3b20 646f 6e65 272c 0a20  00000"; done',. 
+0000a750: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000a760: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000a770: 7d20 3120 3220 3320 3420 3520 3620 3720  } 1 2 3 4 5 6 7 
+0000a780: 3820 3920 3130 2031 3120 3132 2031 3320  8 9 10 11 12 13 
+0000a790: 3134 2031 3520 3136 272c 0a20 2020 2020  14 15 16',.     
+0000a7a0: 2020 2020 2020 2027 736c 6565 7020 3735         'sleep 75
+0000a7b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0000a7c0: 2045 6163 6820 6a6f 6220 7461 6b65 7320   Each job takes 
+0000a7d0: 302e 3520 4350 5520 616e 6420 7468 6520  0.5 CPU and the 
+0000a7e0: 6465 6661 756c 7420 564d 2068 6173 2038  default VM has 8
+0000a7f0: 2043 5055 732c 2073 6f20 7468 6572 6520   CPUs, so there 
+0000a800: 7368 6f75 6c64 2062 6520 3820 2f20 302e  should be 8 / 0.
+0000a810: 3520 3d20 3136 206a 6f62 7320 7275 6e6e  5 = 16 jobs runn
+0000a820: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
+0000a830: 2023 2054 6865 2066 6972 7374 2031 3620   # The first 16 
+0000a840: 6a6f 6273 2061 7265 2063 616e 6365 6c65  jobs are cancele
+0000a850: 642c 2073 6f20 7468 6572 6520 7368 6f75  d, so there shou
+0000a860: 6c64 2062 6520 3735 202d 2033 3220 3d20  ld be 75 - 32 = 
+0000a870: 3433 206a 6f62 7320 5045 4e44 494e 472e  43 jobs PENDING.
+0000a880: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000a890: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000a8a0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+0000a8b0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+0000a8c0: 6f20 2224 7322 207c 2067 7265 7020 2d76  o "$s" | grep -v
+0000a8d0: 2067 7265 7020 7c20 6772 6570 2050 454e   grep | grep PEN
+0000a8e0: 4449 4e47 207c 2077 6320 2d6c 207c 2067  DING | wc -l | g
+0000a8f0: 7265 7020 3433 272c 0a20 2020 2020 2020  rep 43',.       
+0000a900: 2020 2020 2023 204d 616b 6520 7375 7265       # Make sure
+0000a910: 2074 6865 206a 6f62 7320 6172 6520 7363   the jobs are sc
+0000a920: 6865 6475 6c65 6420 696e 2046 4946 4f20  heduled in FIFO 
+0000a930: 6f72 6465 720a 2020 2020 2020 2020 2020  order.          
+0000a940: 2020 2a5b 0a20 2020 2020 2020 2020 2020    *[.           
+0000a950: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000a960: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
+0000a970: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000a980: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000a990: 2067 7265 7020 7b6e 616d 657d 2d7b 697d   grep {name}-{i}
+0000a9a0: 207c 2067 7265 7020 4341 4e43 454c 4c45   | grep CANCELLE
+0000a9b0: 4427 0a20 2020 2020 2020 2020 2020 2020  D'.             
+0000a9c0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0000a9d0: 6528 312c 2031 3729 0a20 2020 2020 2020  e(1, 17).       
+0000a9e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000a9f0: 2020 2020 2a5b 0a20 2020 2020 2020 2020      *[.         
+0000aa00: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000aa10: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000aa20: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000aa30: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000aa40: 207c 2067 7265 7020 7b6e 616d 657d 2d7b   | grep {name}-{
+0000aa50: 697d 207c 2067 7265 7020 5255 4e4e 494e  i} | grep RUNNIN
+0000aa60: 4727 0a20 2020 2020 2020 2020 2020 2020  G'.             
+0000aa70: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0000aa80: 6528 3137 2c20 3333 290a 2020 2020 2020  e(17, 33).      
+0000aa90: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000aaa0: 2020 2020 202a 5b0a 2020 2020 2020 2020       *[.        
+0000aab0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000aac0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+0000aad0: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000aae0: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000aaf0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000ab00: 7b69 7d20 7c20 6772 6570 2050 454e 4449  {i} | grep PENDI
+0000ab10: 4e47 270a 2020 2020 2020 2020 2020 2020  NG'.            
+0000ab20: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000ab30: 6765 2833 332c 2037 3529 0a20 2020 2020  ge(33, 75).     
+0000ab40: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0000ab50: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+0000ab60: 656c 202d 7920 7b6e 616d 657d 2033 3320  el -y {name} 33 
+0000ab70: 3335 2033 3720 3339 2031 3720 3138 2031  35 37 39 17 18 1
+0000ab80: 3927 2c0a 2020 2020 2020 2020 2020 2020  9',.            
+0000ab90: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
+0000aba0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000abb0: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
+0000abc0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+0000abd0: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
+0000abe0: 7265 7020 7b6e 616d 657d 2d7b 697d 207c  rep {name}-{i} |
+0000abf0: 2067 7265 7020 4341 4e43 454c 4c45 4427   grep CANCELLED'
+0000ac00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ac10: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000ac20: 3333 2c20 3430 2c20 3229 0a20 2020 2020  33, 40, 2).     
+0000ac30: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0000ac40: 2020 2020 2020 2773 6c65 6570 2031 3027        'sleep 10'
+0000ac50: 2c0a 2020 2020 2020 2020 2020 2020 2a5b  ,.            *[
+0000ac60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ac70: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000ac80: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+0000ac90: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000aca0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000acb0: 7020 7b6e 616d 657d 2d7b 697d 207c 2067  p {name}-{i} | g
+0000acc0: 7265 7020 5255 4e4e 494e 4727 0a20 2020  rep RUNNING'.   
+0000acd0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000ace0: 2069 2069 6e20 5b33 342c 2033 362c 2033   i in [34, 36, 3
+0000acf0: 385d 0a20 2020 2020 2020 2020 2020 205d  8].            ]
+0000ad00: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0000ad10: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000ad20: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000ad30: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0000ad40: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0000ad50: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000ad60: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000ad70: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+0000ad80: 2020 2320 4e6f 204c 616d 6264 6120 436c    # No Lambda Cl
+0000ad90: 6f75 6420 564d 2068 6173 2038 2043 5055  oud VM has 8 CPU
+0000ada0: 730a 6465 6620 7465 7374 5f66 6173 745f  s.def test_fast_
+0000adb0: 6c61 7267 655f 6a6f 625f 7175 6575 6528  large_job_queue(
+0000adc0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+0000add0: 7472 293a 0a20 2020 2023 2054 6869 7320  tr):.    # This 
+0000ade0: 6973 2074 6f20 7465 7374 2074 6865 206a  is to test the j
+0000adf0: 6f62 7320 6361 6e20 6265 2073 6368 6564  obs can be sched
+0000ae00: 756c 6564 2071 7569 636b 6c79 2077 6865  uled quickly whe
+0000ae10: 6e20 7468 6572 6520 6172 6520 6d61 6e79  n there are many
+0000ae20: 206a 6f62 7320 696e 2074 6865 2071 7565   jobs in the que
+0000ae30: 7565 2e0a 2020 2020 6e61 6d65 203d 205f  ue..    name = _
+0000ae40: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000ae50: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000ae60: 7374 280a 2020 2020 2020 2020 2766 6173  st(.        'fas
+0000ae70: 745f 6c61 7267 655f 6a6f 625f 7175 6575  t_large_job_queu
+0000ae80: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+0000ae90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000aea0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000aeb0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+0000aec0: 6572 6963 5f63 6c6f 7564 7d27 2c0a 2020  eric_cloud}',.  
+0000aed0: 2020 2020 2020 2020 2020 6627 666f 7220            f'for 
+0000aee0: 6920 696e 2060 7365 7120 3120 3332 603b  i in `seq 1 32`;
+0000aef0: 2064 6f20 736b 7920 6578 6563 207b 6e61   do sky exec {na
+0000af00: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 2469  me} -n {name}-$i
+0000af10: 202d 6420 2265 6368 6f20 2469 223b 2064   -d "echo $i"; d
+0000af20: 6f6e 6527 2c0a 2020 2020 2020 2020 2020  one',.          
+0000af30: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0000af40: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000af50: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000af60: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000af70: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000af80: 2473 2220 7c20 6772 6570 202d 7620 6772  $s" | grep -v gr
+0000af90: 6570 207c 2067 7265 7020 5355 4343 4545  ep | grep SUCCEE
+0000afa0: 4445 4420 7c20 7763 202d 6c20 7c20 6772  DED | wc -l | gr
+0000afb0: 6570 2033 3227 2c0a 2020 2020 2020 2020  ep 32',.        
+0000afc0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0000afd0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0000afe0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0000aff0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+0000b000: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0000b010: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+0000b020: 742e 6d61 726b 2e69 626d 0a64 6566 2074  t.mark.ibm.def t
+0000b030: 6573 745f 6962 6d5f 6a6f 625f 7175 6575  est_ibm_job_queu
+0000b040: 655f 6d75 6c74 696e 6f64 6528 293a 0a20  e_multinode():. 
+0000b050: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000b060: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000b070: 2020 7461 736b 5f66 696c 6520 3d20 2765    task_file = 'e
+0000b080: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
+0000b090: 652f 6a6f 625f 6d75 6c74 696e 6f64 655f  e/job_multinode_
+0000b0a0: 6962 6d2e 7961 6d6c 270a 2020 2020 7465  ibm.yaml'.    te
+0000b0b0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0000b0c0: 2020 2027 6962 6d5f 6a6f 625f 7175 6575     'ibm_job_queu
+0000b0d0: 655f 6d75 6c74 696e 6f64 6527 2c0a 2020  e_multinode',.  
+0000b0e0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000b0f0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000b100: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+0000b110: 636c 6f75 6420 6962 6d20 2d2d 6770 7573  cloud ibm --gpus
+0000b120: 2076 3130 3020 2d2d 6e75 6d2d 6e6f 6465   v100 --num-node
+0000b130: 7320 3227 2c0a 2020 2020 2020 2020 2020  s 2',.          
+0000b140: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000b150: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
+0000b160: 2d64 207b 7461 736b 5f66 696c 657d 272c  -d {task_file}',
+0000b170: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b180: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000b190: 6e20 7b6e 616d 657d 2d32 202d 6420 7b74  n {name}-2 -d {t
+0000b1a0: 6173 6b5f 6669 6c65 7d27 2c0a 2020 2020  ask_file}',.    
+0000b1b0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000b1c0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000b1d0: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+0000b1e0: 6465 7461 6368 2d73 6574 7570 202d 6420  detach-setup -d 
+0000b1f0: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
+0000b200: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000b210: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000b220: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000b230: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000b240: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000b250: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
+0000b260: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000b270: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000b280: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
+0000b290: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
+0000b2a0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000b2b0: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
+0000b2c0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000b2d0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000b2e0: 7b6e 616d 657d 2920 2626 2070 7269 6e74  {name}) && print
+0000b2f0: 6620 2224 7322 2026 2620 2865 6368 6f20  f "$s" && (echo 
+0000b300: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000b310: 657d 2d33 207c 2067 7265 7020 5345 5454  e}-3 | grep SETT
+0000b320: 494e 475f 5550 2927 2c0a 2020 2020 2020  ING_UP)',.      
+0000b330: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
+0000b340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000b350: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000b360: 616d 657d 2920 2626 2070 7269 6e74 6620  ame}) && printf 
+0000b370: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000b380: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000b390: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
+0000b3a0: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
+0000b3b0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000b3c0: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
+0000b3d0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0000b3e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b3f0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+0000b400: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+0000b410: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
+0000b420: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b430: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000b440: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
+0000b450: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000b460: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+0000b470: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
+0000b480: 6574 6163 682d 7365 7475 7020 2d64 207b  etach-setup -d {
+0000b490: 7461 736b 5f66 696c 657d 272c 0a20 2020  task_file}',.   
+0000b4a0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+0000b4b0: 7468 6520 6a6f 6220 7374 6174 7573 2069  the job status i
+0000b4c0: 7320 636f 7272 6563 746c 7920 7365 7420  s correctly set 
+0000b4d0: 746f 2053 4554 5449 4e47 5f55 502c 2064  to SETTING_UP, d
+0000b4e0: 7572 696e 6720 7468 6520 7365 7475 7020  uring the setup 
+0000b4f0: 6973 2072 756e 6e69 6e67 2c0a 2020 2020  is running,.    
+0000b500: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
+0000b510: 6520 6a6f 6220 6361 6e20 6265 2063 616e  e job can be can
+0000b520: 6365 6c6c 6564 2064 7572 696e 6720 7468  celled during th
+0000b530: 6520 7365 7475 702e 0a20 2020 2020 2020  e setup..       
+0000b540: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
+0000b550: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
+0000b560: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
+0000b570: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000b580: 207b 6e61 6d65 7d2d 3420 7c20 6772 6570   {name}-4 | grep
+0000b590: 2053 4554 5449 4e47 5f55 5029 272c 0a20   SETTING_UP)',. 
+0000b5a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000b5b0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000b5c0: 7d20 3427 2c0a 2020 2020 2020 2020 2020  } 4',.          
+0000b5d0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000b5e0: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
+0000b5f0: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
+0000b600: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000b610: 616d 657d 2d34 207c 2067 7265 7020 4341  ame}-4 | grep CA
+0000b620: 4e43 454c 4c45 4429 272c 0a20 2020 2020  NCELLED)',.     
+0000b630: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000b640: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
+0000b650: 7631 3030 3a30 2e32 2022 5b5b 205c 2453  v100:0.2 "[[ \$S
+0000b660: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000b670: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000b680: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000b690: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000b6a0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000b6b0: 6770 7573 2076 3130 303a 302e 3220 2d2d  gpus v100:0.2 --
+0000b6c0: 6e75 6d2d 6e6f 6465 7320 3220 225b 5b20  num-nodes 2 "[[ 
+0000b6d0: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
+0000b6e0: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
+0000b6f0: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
+0000b700: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000b710: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000b720: 202d 2d67 7075 7320 7631 3030 3a31 202d   --gpus v100:1 -
+0000b730: 2d6e 756d 2d6e 6f64 6573 2032 2022 5b5b  -num-nodes 2 "[[
+0000b740: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
+0000b750: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
+0000b760: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
+0000b770: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000b780: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000b790: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
+0000b7a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000b7b0: 206c 6f67 7320 7b6e 616d 657d 2036 202d   logs {name} 6 -
+0000b7c0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0000b7d0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000b7e0: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
+0000b7f0: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
+0000b800: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000b810: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000b820: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000b830: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+0000b840: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+0000b850: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000b860: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053  ..# ---------- S
+0000b870: 7562 6d69 7474 696e 6720 6d75 6c74 6970  ubmitting multip
+0000b880: 6c65 2074 6173 6b73 2074 6f20 7468 6520  le tasks to the 
+0000b890: 7361 6d65 2063 6c75 7374 6572 2e20 2d2d  same cluster. --
+0000b8a0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+0000b8b0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+0000b8c0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+0000b8d0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
+0000b8e0: 6176 6520 4b38 3020 6770 7573 0a40 7079  ave K80 gpus.@py
+0000b8f0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+0000b900: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
+0000b910: 6573 206e 6f74 2068 6176 6520 4b38 3020  es not have K80 
+0000b920: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
+0000b930: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+0000b940: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0000b950: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+0000b960: 6574 0a40 7079 7465 7374 2e6d 6172 6b2e  et.@pytest.mark.
+0000b970: 6e6f 5f6f 6369 2020 2320 4f43 4920 436c  no_oci  # OCI Cl
+0000b980: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000b990: 6520 4b38 3020 6770 7573 0a64 6566 2074  e K80 gpus.def t
+0000b9a0: 6573 745f 6d75 6c74 695f 6563 686f 2867  est_multi_echo(g
+0000b9b0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000b9c0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000b9d0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000b9e0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000b9f0: 7374 280a 2020 2020 2020 2020 276d 756c  st(.        'mul
+0000ba00: 7469 5f65 6368 6f27 2c0a 2020 2020 2020  ti_echo',.      
+0000ba10: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000ba20: 6627 7079 7468 6f6e 2065 7861 6d70 6c65  f'python example
+0000ba30: 732f 6d75 6c74 695f 6563 686f 2e70 7920  s/multi_echo.py 
+0000ba40: 7b6e 616d 657d 207b 6765 6e65 7269 635f  {name} {generic_
+0000ba50: 636c 6f75 647d 272c 0a20 2020 2020 2020  cloud}',.       
+0000ba60: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+0000ba70: 2c0a 2020 2020 2020 2020 5d20 2b0a 2020  ,.        ] +.  
+0000ba80: 2020 2020 2020 2320 456e 7375 7265 206a        # Ensure j
+0000ba90: 6f62 7320 7375 6363 6565 6465 642e 0a20  obs succeeded.. 
+0000baa0: 2020 2020 2020 205b 6627 736b 7920 6c6f         [f'sky lo
+0000bab0: 6773 207b 6e61 6d65 7d20 7b69 202b 2031  gs {name} {i + 1
+0000bac0: 7d20 2d2d 7374 6174 7573 2720 666f 7220  } --status' for 
+0000bad0: 6920 696e 2072 616e 6765 2833 3229 5d20  i in range(32)] 
+0000bae0: 2b0a 2020 2020 2020 2020 2320 456e 7375  +.        # Ensu
+0000baf0: 7265 206d 6f6e 6974 6f72 2f61 7574 6f73  re monitor/autos
+0000bb00: 6361 6c65 7220 6469 646e 2774 2063 7261  caler didn't cra
+0000bb10: 7368 206f 6e20 7468 6520 2761 7373 6572  sh on the 'asser
+0000bb20: 7420 6e6f 740a 2020 2020 2020 2020 2320  t not.        # 
+0000bb30: 756e 6675 6c66 696c 6c65 6427 2065 7272  unfulfilled' err
+0000bb40: 6f72 2e20 2049 6620 7072 6f63 6573 7320  or.  If process 
+0000bb50: 6e6f 7420 666f 756e 642c 2067 7265 702d  not found, grep-
+0000bb60: 3e73 7368 2072 6574 7572 6e73 2031 2e0a  >ssh returns 1..
+0000bb70: 2020 2020 2020 2020 5b66 2773 7368 207b          [f'ssh {
+0000bb80: 6e61 6d65 7d20 5c27 7073 2061 7578 207c  name} \'ps aux |
+0000bb90: 2067 7265 7020 225b 2f5d 226d 6f6e 6974   grep "[/]"monit
+0000bba0: 6f72 2e70 795c 2727 5d2c 0a20 2020 2020  or.py\''],.     
+0000bbb0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000bbc0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+0000bbd0: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+0000bbe0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+0000bbf0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000bc00: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0000bc10: 6173 6b3a 2031 206e 6f64 6520 7472 6169  ask: 1 node trai
+0000bc20: 6e69 6e67 2e20 2d2d 2d2d 2d2d 2d2d 2d2d  ning. ----------
+0000bc30: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000bc40: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+0000bc50: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
+0000bc60: 6573 206e 6f74 2068 6176 6520 5631 3030  es not have V100
+0000bc70: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
+0000bc80: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
+0000bc90: 2063 6c6f 7564 2063 7572 7265 6e74 6c79   cloud currently
+0000bca0: 2064 6f65 736e 2774 2070 726f 7669 6465   doesn't provide
+0000bcb0: 2070 7562 6c69 6320 696d 6167 6520 7769   public image wi
+0000bcc0: 7468 2043 5544 410a 4070 7974 6573 742e  th CUDA.@pytest.
+0000bcd0: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+0000bce0: 4350 2064 6f65 7320 6e6f 7420 6861 7665  CP does not have
+0000bcf0: 2056 3130 3020 2831 3647 4229 2047 5055   V100 (16GB) GPU
+0000bd00: 732e 2052 756e 2074 6573 745f 7363 705f  s. Run test_scp_
+0000bd10: 6875 6767 696e 6766 6163 6520 696e 7374  huggingface inst
+0000bd20: 6561 642e 0a64 6566 2074 6573 745f 6875  ead..def test_hu
+0000bd30: 6767 696e 6766 6163 6528 6765 6e65 7269  ggingface(generi
+0000bd40: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000bd50: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000bd60: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000bd70: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000bd80: 2020 2020 2020 2027 6875 6767 696e 6766         'huggingf
+0000bd90: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
+0000bda0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+0000bdb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000bdc0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000bdd0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+0000bde0: 6572 6963 5f63 6c6f 7564 7d20 6578 616d  eric_cloud} exam
+0000bdf0: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000be00: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000be10: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000be20: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000be30: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0000be40: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000be50: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000be60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000be70: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+0000be80: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000be90: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000bea0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000beb0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000bec0: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+0000bed0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000bee0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000bef0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000bf00: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000bf10: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000bf20: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000bf30: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000bf40: 6172 6b2e 6c61 6d62 6461 5f63 6c6f 7564  ark.lambda_cloud
+0000bf50: 0a64 6566 2074 6573 745f 6c61 6d62 6461  .def test_lambda
+0000bf60: 5f68 7567 6769 6e67 6661 6365 2867 656e  _huggingface(gen
+0000bf70: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0000bf80: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000bf90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000bfa0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000bfb0: 280a 2020 2020 2020 2020 276c 616d 6264  (.        'lambd
+0000bfc0: 615f 6875 6767 696e 6766 6163 655f 676c  a_huggingface_gl
+0000bfd0: 7565 5f69 6d64 625f 6170 7027 2c0a 2020  ue_imdb_app',.  
+0000bfe0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000bff0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000c000: 202d 7920 2d63 207b 6e61 6d65 7d20 7b4c   -y -c {name} {L
+0000c010: 414d 4244 415f 5459 5045 7d20 6578 616d  AMBDA_TYPE} exam
+0000c020: 706c 6573 2f68 7567 6769 6e67 6661 6365  ples/huggingface
+0000c030: 5f67 6c75 655f 696d 6462 5f61 7070 2e79  _glue_imdb_app.y
+0000c040: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000c050: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000c060: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0000c070: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000c080: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000c090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c0a0: 6578 6563 207b 6e61 6d65 7d20 7b4c 414d  exec {name} {LAM
+0000c0b0: 4244 415f 5459 5045 7d20 6578 616d 706c  BDA_TYPE} exampl
+0000c0c0: 6573 2f68 7567 6769 6e67 6661 6365 5f67  es/huggingface_g
+0000c0d0: 6c75 655f 696d 6462 5f61 7070 2e79 616d  lue_imdb_app.yam
+0000c0e0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000c0f0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000c100: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
+0000c110: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000c120: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000c130: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000c140: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000c150: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0000c160: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000c170: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+0000c180: 6b2e 7363 700a 6465 6620 7465 7374 5f73  k.scp.def test_s
+0000c190: 6370 5f68 7567 6769 6e67 6661 6365 2867  cp_huggingface(g
+0000c1a0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000c1b0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000c1c0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000c1d0: 2829 0a20 2020 206e 756d 5f6f 665f 6770  ().    num_of_gp
+0000c1e0: 755f 6c61 756e 6368 203d 2031 0a20 2020  u_launch = 1.   
+0000c1f0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000c200: 2020 2020 2020 2753 4350 5f68 7567 6769        'SCP_huggi
+0000c210: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+0000c220: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
+0000c230: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c240: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000c250: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
+0000c260: 7d20 7b53 4350 5f47 5055 5f56 3130 307d  } {SCP_GPU_V100}
+0000c270: 3a7b 6e75 6d5f 6f66 5f67 7075 5f6c 6175  :{num_of_gpu_lau
+0000c280: 6e63 687d 2065 7861 6d70 6c65 732f 6875  nch} examples/hu
+0000c290: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
+0000c2a0: 6d64 625f 6170 702e 7961 6d6c 272c 0a20  mdb_app.yaml',. 
+0000c2b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c2c0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0000c2d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000c2e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000c2f0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0000c300: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000c310: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000c320: 7b53 4350 5f47 5055 5f56 3130 307d 3a7b  {SCP_GPU_V100}:{
+0000c330: 6e75 6d5f 6f66 5f67 7075 5f6c 6175 6e63  num_of_gpu_launc
+0000c340: 687d 2065 7861 6d70 6c65 732f 6875 6767  h} examples/hugg
+0000c350: 696e 6766 6163 655f 676c 7565 5f69 6d64  ingface_glue_imd
+0000c360: 625f 6170 702e 7961 6d6c 272c 0a20 2020  b_app.yaml',.   
+0000c370: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000c380: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+0000c390: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+0000c3a0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+0000c3b0: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
+0000c3c0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000c3d0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000c3e0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000c3f0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0000c400: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2e20  ---------- TPU. 
+0000c410: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+0000c420: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
+0000c430: 7465 7374 5f74 7075 2829 3a0a 2020 2020  test_tpu():.    
+0000c440: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000c450: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000c460: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000c470: 2020 2020 2774 7075 5f61 7070 272c 0a20      'tpu_app',. 
+0000c480: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000c490: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000c4a0: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
+0000c4b0: 7861 6d70 6c65 732f 7470 752f 7470 755f  xamples/tpu/tpu_
+0000c4c0: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
+0000c4d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000c4e0: 7320 7b6e 616d 657d 2031 272c 2020 2320  s {name} 1',  # 
+0000c4f0: 456e 7375 7265 2074 6865 206a 6f62 2066  Ensure the job f
+0000c500: 696e 6973 6865 642e 0a20 2020 2020 2020  inished..       
+0000c510: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000c520: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0000c530: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+0000c540: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+0000c550: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c560: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000c570: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+0000c580: 7470 752f 7470 755f 6170 702e 7961 6d6c  tpu/tpu_app.yaml
+0000c590: 207c 2067 7265 7020 2254 5055 202e 2a20   | grep "TPU .* 
+0000c5a0: 616c 7265 6164 7920 6578 6973 7473 2227  already exists"'
+0000c5b0: 2c20 2023 2045 6e73 7572 6520 736b 7920  ,  # Ensure sky 
+0000c5c0: 6c61 756e 6368 2077 6f6e 2774 2063 7265  launch won't cre
+0000c5d0: 6174 6520 616e 6f74 6865 7220 5450 552e  ate another TPU.
+0000c5e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000c5f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000c600: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000c610: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
+0000c620: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
+0000c630: 3e32 3020 6d69 6e73 0a20 2020 2029 0a20  >20 mins.    ). 
+0000c640: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000c650: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000c660: 2d2d 2d2d 2054 5055 2056 4d2e 202d 2d2d  ---- TPU VM. ---
+0000c670: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+0000c680: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+0000c690: 745f 7470 755f 766d 2829 3a0a 2020 2020  t_tpu_vm():.    
+0000c6a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000c6b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000c6c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000c6d0: 2020 2020 2774 7075 5f76 6d5f 6170 7027      'tpu_vm_app'
+0000c6e0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0000c6f0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000c700: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000c710: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
+0000c720: 7075 766d 5f6d 6e69 7374 2e79 616d 6c27  puvm_mnist.yaml'
+0000c730: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000c740: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000c750: 3127 2c20 2023 2045 6e73 7572 6520 7468  1',  # Ensure th
+0000c760: 6520 6a6f 6220 6669 6e69 7368 6564 2e0a  e job finished..
+0000c770: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c780: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0000c790: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+0000c7a0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+0000c7b0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000c7c0: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
+0000c7d0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000c7e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000c7f0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+0000c800: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+0000c810: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000c820: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+0000c830: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000c840: 7020 5354 4f50 5045 4427 2c20 2023 2045  p STOPPED',  # E
+0000c850: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+0000c860: 7220 6973 2053 544f 5050 4544 2e0a 2020  r is STOPPED..  
+0000c870: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+0000c880: 7265 7472 793a 2067 7561 7264 2061 6761  retry: guard aga
+0000c890: 696e 7374 2074 7261 6e73 6965 6e74 2065  inst transient e
+0000c8a0: 7272 6f72 7320 6f62 7365 7276 6564 2066  rrors observed f
+0000c8b0: 6f72 0a20 2020 2020 2020 2020 2020 2023  or.            #
+0000c8c0: 206a 7573 742d 7374 6f70 7065 6420 5450   just-stopped TP
+0000c8d0: 5520 564d 7320 2823 3936 3229 2e0a 2020  U VMs (#962)..  
+0000c8e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c8f0: 7374 6172 7420 2d2d 7265 7472 792d 756e  start --retry-un
+0000c900: 7469 6c2d 7570 202d 7920 7b6e 616d 657d  til-up -y {name}
+0000c910: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000c920: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000c930: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
+0000c940: 7576 6d5f 6d6e 6973 742e 7961 6d6c 272c  uvm_mnist.yaml',
+0000c950: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c960: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0000c970: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000c980: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000c990: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000c9a0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+0000c9b0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000c9c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000c9d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000c9e0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000c9f0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
+0000ca00: 2320 6361 6e20 7461 6b65 2033 3020 6d69  # can take 30 mi
+0000ca10: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+0000ca20: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000ca30: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0000ca40: 5055 2056 4d20 506f 642e 202d 2d2d 2d2d  PU VM Pod. -----
+0000ca50: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+0000ca60: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+0000ca70: 7470 755f 766d 5f70 6f64 2829 3a0a 2020  tpu_vm_pod():.  
+0000ca80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000ca90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0000caa0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000cab0: 2020 2020 2020 2774 7075 5f70 6f64 272c        'tpu_pod',
+0000cac0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0000cad0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000cae0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0000caf0: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
+0000cb00: 7576 6d5f 6d6e 6973 742e 7961 6d6c 202d  uvm_mnist.yaml -
+0000cb10: 2d67 7075 7320 7470 752d 7632 2d33 3220  -gpus tpu-v2-32 
+0000cb20: 2d2d 7573 652d 7370 6f74 202d 2d7a 6f6e  --use-spot --zon
+0000cb30: 6520 6575 726f 7065 2d77 6573 7434 2d61  e europe-west4-a
+0000cb40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000cb50: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000cb60: 2031 272c 2020 2320 456e 7375 7265 2074   1',  # Ensure t
+0000cb70: 6865 206a 6f62 2066 696e 6973 6865 642e  he job finished.
+0000cb80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000cb90: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000cba0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000cbb0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000cbc0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000cbd0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0000cbe0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000cbf0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0000cc00: 7574 3d33 3020 2a20 3630 2c20 2023 2063  ut=30 * 60,  # c
+0000cc10: 616e 2074 616b 6520 3330 206d 696e 730a  an take 30 mins.
+0000cc20: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000cc30: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+0000cc40: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5369 6d70   ---------- Simp
+0000cc50: 6c65 2061 7070 732e 202d 2d2d 2d2d 2d2d  le apps. -------
+0000cc60: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0000cc70: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+0000cc80: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0000cc90: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+0000cca0: 740a 6465 6620 7465 7374 5f6d 756c 7469  t.def test_multi
+0000ccb0: 5f68 6f73 746e 616d 6528 6765 6e65 7269  _hostname(generi
+0000ccc0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000ccd0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000cce0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000ccf0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000cd00: 2020 2020 2020 2027 6d75 6c74 695f 686f         'multi_ho
+0000cd10: 7374 6e61 6d65 272c 0a20 2020 2020 2020  stname',.       
+0000cd20: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000cd30: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000cd40: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+0000cd50: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
+0000cd60: 2065 7861 6d70 6c65 732f 6d75 6c74 695f   examples/multi_
+0000cd70: 686f 7374 6e61 6d65 2e79 616d 6c27 2c0a  hostname.yaml',.
+0000cd80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000cd90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0000cda0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+0000cdb0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+0000cdc0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000cdd0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000cde0: 6e61 6d65 7d20 3120 7c20 6772 6570 2022  name} 1 | grep "
+0000cdf0: 4d79 2068 6f73 746e 616d 653a 2220 7c20  My hostname:" | 
+0000ce00: 7763 202d 6c20 7c20 6772 6570 2032 272c  wc -l | grep 2',
+0000ce10: 2020 2320 456e 7375 7265 2074 6865 7265    # Ensure there
+0000ce20: 2061 7265 2032 2068 6f73 7473 2e0a 2020   are 2 hosts..  
+0000ce30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000ce40: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+0000ce50: 706c 6573 2f6d 756c 7469 5f68 6f73 746e  ples/multi_hostn
+0000ce60: 616d 652e 7961 6d6c 272c 0a20 2020 2020  ame.yaml',.     
+0000ce70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000ce80: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+0000ce90: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+0000cea0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+0000ceb0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+0000cec0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0000ced0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000cee0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000cef0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0000cf00: 2d2d 2d2d 2d2d 2d2d 2057 6562 2061 7070  -------- Web app
+0000cf10: 7320 7769 7468 2063 7573 746f 6d20 706f  s with custom po
+0000cf20: 7274 7320 6f6e 2047 4350 2e20 2d2d 2d2d  rts on GCP. ----
+0000cf30: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0000cf40: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+0000cf50: 5f67 6370 5f68 7474 705f 7365 7276 6572  _gcp_http_server
+0000cf60: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
+0000cf70: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
+0000cf80: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000cf90: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0000cfa0: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
+0000cfb0: 6370 5f68 7474 705f 7365 7276 6572 5f77  cp_http_server_w
+0000cfc0: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
+0000cfd0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0000cfe0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000cff0: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+0000d000: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+0000d010: 7020 6578 616d 706c 6573 2f68 7474 705f  p examples/http_
+0000d020: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
+0000d030: 6f6d 5f70 6f72 7473 2f74 6173 6b2e 7961  om_ports/task.ya
+0000d040: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000d050: 2027 736c 6565 7020 3130 272c 0a20 2020   'sleep 10',.   
+0000d060: 2020 2020 2020 2020 2027 6970 3d24 2867           'ip=$(g
+0000d070: 7265 7020 2d41 3120 2248 6f73 7420 2720  rep -A1 "Host ' 
+0000d080: 2b20 6e61 6d65 202b 0a20 2020 2020 2020  + name +.       
+0000d090: 2020 2020 2027 2220 7e2f 2e73 7368 2f63       '" ~/.ssh/c
+0000d0a0: 6f6e 6669 6720 7c20 6772 6570 2022 486f  onfig | grep "Ho
+0000d0b0: 7374 4e61 6d65 2220 7c20 6177 6b20 5c27  stName" | awk \'
+0000d0c0: 7b70 7269 6e74 2024 327d 5c27 293b 2063  {print $2}\'); c
+0000d0d0: 7572 6c20 2469 703a 3333 3832 3820 7c20  url $ip:33828 | 
+0000d0e0: 6772 6570 2022 3c68 313e 5468 6973 2069  grep "<h1>This i
+0000d0f0: 7320 6120 6465 6d6f 2048 544d 4c20 7061  s a demo HTML pa
+0000d100: 6765 2e3c 2f68 313e 2227 2c0a 2020 2020  ge.</h1>"',.    
+0000d110: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000d120: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000d130: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+0000d140: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000d150: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+0000d160: 2d20 5765 6220 6170 7073 2077 6974 6820  - Web apps with 
+0000d170: 6375 7374 6f6d 2070 6f72 7473 206f 6e20  custom ports on 
+0000d180: 4157 532e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  AWS. ----------.
+0000d190: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+0000d1a0: 0a64 6566 2074 6573 745f 6177 735f 6874  .def test_aws_ht
+0000d1b0: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
+0000d1c0: 7573 746f 6d5f 706f 7274 7328 293a 0a20  ustom_ports():. 
+0000d1d0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000d1e0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000d1f0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000d200: 2020 2020 2020 2027 6177 735f 6874 7470         'aws_http
+0000d210: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+0000d220: 746f 6d5f 706f 7274 7327 2c0a 2020 2020  tom_ports',.    
+0000d230: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000d240: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000d250: 7920 2d64 202d 6320 7b6e 616d 657d 202d  y -d -c {name} -
+0000d260: 2d63 6c6f 7564 2061 7773 2065 7861 6d70  -cloud aws examp
+0000d270: 6c65 732f 6874 7470 5f73 6572 7665 725f  les/http_server_
+0000d280: 7769 7468 5f63 7573 746f 6d5f 706f 7274  with_custom_port
+0000d290: 732f 7461 736b 2e79 616d 6c27 2c0a 2020  s/task.yaml',.  
+0000d2a0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000d2b0: 2031 3027 2c0a 2020 2020 2020 2020 2020   10',.          
+0000d2c0: 2020 2769 703d 2428 6772 6570 202d 4131    'ip=$(grep -A1
+0000d2d0: 2022 486f 7374 2027 202b 206e 616d 6520   "Host ' + name 
+0000d2e0: 2b0a 2020 2020 2020 2020 2020 2020 2722  +.            '"
+0000d2f0: 207e 2f2e 7373 682f 636f 6e66 6967 207c   ~/.ssh/config |
+0000d300: 2067 7265 7020 2248 6f73 744e 616d 6522   grep "HostName"
+0000d310: 207c 2061 776b 205c 277b 7072 696e 7420   | awk \'{print 
+0000d320: 2432 7d5c 2729 3b20 6375 726c 2024 6970  $2}\'); curl $ip
+0000d330: 3a33 3338 3238 207c 2067 7265 7020 223c  :33828 | grep "<
+0000d340: 6831 3e54 6869 7320 6973 2061 2064 656d  h1>This is a dem
+0000d350: 6f20 4854 4d4c 2070 6167 652e 3c2f 6831  o HTML page.</h1
+0000d360: 3e22 272c 0a20 2020 2020 2020 205d 2c0a  >"',.        ],.
+0000d370: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000d380: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000d390: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000d3a0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0000d3b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6173 6b3a  ---------- Task:
+0000d3c0: 206e 3d32 206e 6f64 6573 2077 6974 6820   n=2 nodes with 
+0000d3d0: 7365 7475 7073 2e20 2d2d 2d2d 2d2d 2d2d  setups. --------
+0000d3e0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+0000d3f0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+0000d400: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+0000d410: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
+0000d420: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
+0000d430: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+0000d440: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
+0000d450: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
+0000d460: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
+0000d470: 7769 7468 2043 5544 410a 4070 7974 6573  with CUDA.@pytes
+0000d480: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000d490: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+0000d4a0: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
+0000d4b0: 3e20 3120 7965 740a 4070 7974 6573 742e  > 1 yet.@pytest.
+0000d4c0: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
+0000d4d0: 6561 736f 6e3d 0a20 2020 2027 5468 6520  eason=.    'The 
+0000d4e0: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
+0000d4f0: 6564 5f74 665f 6170 7020 6973 2066 6c61  ed_tf_app is fla
+0000d500: 6b79 2c20 6475 6520 746f 2069 7420 6661  ky, due to it fa
+0000d510: 696c 696e 6720 746f 2064 6574 6563 7420  iling to detect 
+0000d520: 4750 5573 2e27 290a 6465 6620 7465 7374  GPUs.').def test
+0000d530: 5f64 6973 7472 6962 7574 6564 5f74 6628  _distributed_tf(
+0000d540: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+0000d550: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+0000d560: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000d570: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0000d580: 6573 7428 0a20 2020 2020 2020 2027 7265  est(.        're
+0000d590: 736e 6574 5f64 6973 7472 6962 7574 6564  snet_distributed
+0000d5a0: 5f74 665f 6170 7027 2c0a 2020 2020 2020  _tf_app',.      
+0000d5b0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000d5c0: 2320 4e4f 5445 3a20 7275 6e6e 696e 6720  # NOTE: running 
+0000d5d0: 6974 2074 7769 6365 2077 696c 6c20 6861  it twice will ha
+0000d5e0: 6e67 2028 736f 6d65 7469 6d65 733f 2920  ng (sometimes?) 
+0000d5f0: 2d20 616e 2061 7070 2d6c 6576 656c 2062  - an app-level b
+0000d600: 7567 2e0a 2020 2020 2020 2020 2020 2020  ug..            
+0000d610: 6627 7079 7468 6f6e 2065 7861 6d70 6c65  f'python example
+0000d620: 732f 7265 736e 6574 5f64 6973 7472 6962  s/resnet_distrib
+0000d630: 7574 6564 5f74 665f 6170 702e 7079 207b  uted_tf_app.py {
+0000d640: 6e61 6d65 7d20 7b67 656e 6572 6963 5f63  name} {generic_c
+0000d650: 6c6f 7564 7d27 2c0a 2020 2020 2020 2020  loud}',.        
+0000d660: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000d670: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000d680: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000d690: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+0000d6a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000d6b0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000d6c0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+0000d6d0: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
+0000d6e0: 302c 2020 2320 3235 206d 696e 7320 2869  0,  # 25 mins (i
+0000d6f0: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
+0000d700: 3139 206d 696e 7329 0a20 2020 2029 0a20  19 mins).    ). 
+0000d710: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000d720: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000d730: 2d2d 2d2d 2054 6573 7469 6e67 2047 4350  ---- Testing GCP
+0000d740: 2073 7461 7274 2061 6e64 2073 746f 7020   start and stop 
+0000d750: 696e 7374 616e 6365 7320 2d2d 2d2d 2d2d  instances ------
+0000d760: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+0000d770: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+0000d780: 6370 5f73 7461 7274 5f73 746f 7028 293a  cp_start_stop():
+0000d790: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000d7a0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000d7b0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000d7c0: 0a20 2020 2020 2020 2027 6763 702d 7374  .        'gcp-st
+0000d7d0: 6172 742d 7374 6f70 272c 0a20 2020 2020  art-stop',.     
+0000d7e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000d7f0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000d800: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
+0000d810: 6c65 732f 6763 705f 7374 6172 745f 7374  les/gcp_start_st
+0000d820: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
+0000d830: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000d840: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+0000d850: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+0000d860: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+0000d870: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000d880: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000d890: 6578 616d 706c 6573 2f67 6370 5f73 7461  examples/gcp_sta
+0000d8a0: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+0000d8b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000d8c0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+0000d8d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000d8e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000d8f0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0000d900: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000d910: 616d 657d 2022 7072 6c69 6d69 7420 2d6e  ame} "prlimit -n
+0000d920: 202d 2d70 6964 3d5c 2428 7067 7265 7020   --pid=\$(pgrep 
+0000d930: 2d66 205c 2772 6179 6c65 742f 7261 796c  -f \'raylet/rayl
+0000d940: 6574 202d 2d72 6179 6c65 745f 736f 636b  et --raylet_sock
+0000d950: 6574 5f6e 616d 655c 2729 207c 2067 7265  et_name\') | gre
+0000d960: 7020 5c27 225c 2731 3034 3835 3736 2031  p \'"\'1048576 1
+0000d970: 3034 3835 3736 5c27 225c 2722 272c 2020  048576\'"\'"',  
+0000d980: 2320 456e 7375 7265 2074 6865 2072 6179  # Ensure the ray
+0000d990: 6c65 7420 7072 6f63 6573 7320 6861 7320  let process has 
+0000d9a0: 7468 6520 636f 7272 6563 7420 6669 6c65  the correct file
+0000d9b0: 2064 6573 6372 6970 746f 7220 6c69 6d69   descriptor limi
+0000d9c0: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
+0000d9d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000d9e0: 2033 202d 2d73 7461 7475 7327 2c20 2023   3 --status',  #
+0000d9f0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+0000da00: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000da10: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
+0000da20: 7020 2d79 207b 6e61 6d65 7d27 2c0a 2020  p -y {name}',.  
+0000da30: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+0000da40: 7020 3230 272c 0a20 2020 2020 2020 2020  p 20',.         
+0000da50: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
+0000da60: 7920 7b6e 616d 657d 202d 6920 3127 2c0a  y {name} -i 1',.
+0000da70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000da80: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
+0000da90: 616d 706c 6573 2f67 6370 5f73 7461 7274  amples/gcp_start
+0000daa0: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
+0000dab0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000dac0: 6f67 7320 7b6e 616d 657d 2034 202d 2d73  ogs {name} 4 --s
+0000dad0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+0000dae0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+0000daf0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+0000db00: 2027 736c 6565 7020 3138 3027 2c0a 2020   'sleep 180',.  
+0000db10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000db20: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
+0000db30: 207c 2067 7265 7020 2249 4e49 545c 7c53   | grep "INIT\|S
+0000db40: 544f 5050 4544 2227 2c0a 2020 2020 2020  TOPPED"',.      
+0000db50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+0000db60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000db70: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+0000db80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000db90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0000dba0: 5465 7374 696e 6720 417a 7572 6520 7374  Testing Azure st
+0000dbb0: 6172 7420 616e 6420 7374 6f70 2069 6e73  art and stop ins
+0000dbc0: 7461 6e63 6573 202d 2d2d 2d2d 2d2d 2d2d  tances ---------
+0000dbd0: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
+0000dbe0: 7a75 7265 0a64 6566 2074 6573 745f 617a  zure.def test_az
+0000dbf0: 7572 655f 7374 6172 745f 7374 6f70 2829  ure_start_stop()
+0000dc00: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000dc10: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000dc20: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000dc30: 280a 2020 2020 2020 2020 2761 7a75 7265  (.        'azure
+0000dc40: 2d73 7461 7274 2d73 746f 7027 2c0a 2020  -start-stop',.  
+0000dc50: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000dc60: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000dc70: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+0000dc80: 616d 706c 6573 2f61 7a75 7265 5f73 7461  amples/azure_sta
+0000dc90: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
+0000dca0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000dcb0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+0000dcc0: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
+0000dcd0: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
+0000dce0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000dcf0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0000dd00: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+0000dd10: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+0000dd20: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+0000dd30: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000dd40: 6d65 7d20 2270 726c 696d 6974 202d 6e20  me} "prlimit -n 
+0000dd50: 2d2d 7069 643d 5c24 2870 6772 6570 202d  --pid=\$(pgrep -
+0000dd60: 6620 5c27 7261 796c 6574 2f72 6179 6c65  f \'raylet/rayle
+0000dd70: 7420 2d2d 7261 796c 6574 5f73 6f63 6b65  t --raylet_socke
+0000dd80: 745f 6e61 6d65 5c27 2920 7c20 6772 6570  t_name\') | grep
+0000dd90: 205c 2722 5c27 3130 3438 3537 3620 3130   \'"\'1048576 10
+0000dda0: 3438 3537 365c 2722 5c27 2227 2c20 2023  48576\'"\'"',  #
+0000ddb0: 2045 6e73 7572 6520 7468 6520 7261 796c   Ensure the rayl
+0000ddc0: 6574 2070 726f 6365 7373 2068 6173 2074  et process has t
+0000ddd0: 6865 2063 6f72 7265 6374 2066 696c 6520  he correct file 
+0000dde0: 6465 7363 7269 7074 6f72 206c 696d 6974  descriptor limit
+0000ddf0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000de00: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000de10: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
+0000de20: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+0000de30: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+0000de40: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
+0000de50: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000de60: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+0000de70: 7461 7274 202d 7920 7b6e 616d 657d 202d  tart -y {name} -
+0000de80: 6920 3127 2c0a 2020 2020 2020 2020 2020  i 1',.          
+0000de90: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000dea0: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
+0000deb0: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
+0000dec0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000ded0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000dee0: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
+0000def0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+0000df00: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000df10: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0000df20: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+0000df30: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
+0000df40: 7573 202d 7220 7b6e 616d 657d 2920 2626  us -r {name}) &&
+0000df50: 2065 6368 6f20 2473 2026 2620 6563 686f   echo $s && echo
+0000df60: 2024 7320 7c20 6772 6570 2022 494e 4954   $s | grep "INIT
+0000df70: 5c7c 5354 4f50 5045 4422 270a 2020 2020  \|STOPPED"'.    
+0000df80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000df90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000dfa0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000dfb0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
+0000dfc0: 2320 3330 206d 696e 730a 2020 2020 290a  # 30 mins.    ).
+0000dfd0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000dfe0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0000dff0: 2d2d 2d2d 2d20 5465 7374 696e 6720 4175  ----- Testing Au
+0000e000: 746f 7374 6f70 7069 6e67 202d 2d2d 2d2d  tostopping -----
+0000e010: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+0000e020: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
+0000e030: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
+0000e040: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+0000e050: 6f72 7420 7374 6f70 7069 6e67 2069 6e73  ort stopping ins
+0000e060: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0000e070: 6172 6b2e 6e6f 5f69 626d 2020 2320 4649  ark.no_ibm  # FI
+0000e080: 5828 4942 4d29 2073 706f 7261 6469 6361  X(IBM) sporadica
+0000e090: 6c6c 7920 6661 696c 732c 2061 7320 7265  lly fails, as re
+0000e0a0: 7374 6172 7465 6420 776f 726b 6572 7320  started workers 
+0000e0b0: 7374 6179 2075 6e69 6e69 7469 616c 697a  stay uninitializ
+0000e0c0: 6564 2069 6e64 6566 696e 6974 656c 790a  ed indefinitely.
+0000e0d0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000e0e0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+0000e0f0: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
+0000e100: 6e6f 6465 7320 3e20 3120 7965 740a 6465  nodes > 1 yet.de
+0000e110: 6620 7465 7374 5f61 7574 6f73 746f 7028  f test_autostop(
+0000e120: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+0000e130: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+0000e140: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000e150: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0000e160: 6573 7428 0a20 2020 2020 2020 2027 6175  est(.        'au
+0000e170: 746f 7374 6f70 272c 0a20 2020 2020 2020  tostop',.       
+0000e180: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000e190: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+0000e1a0: 6420 2d63 207b 6e61 6d65 7d20 2d2d 6e75  d -c {name} --nu
+0000e1b0: 6d2d 6e6f 6465 7320 3220 2d2d 636c 6f75  m-nodes 2 --clou
+0000e1c0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0000e1d0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+0000e1e0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+0000e1f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000e200: 736b 7920 6175 746f 7374 6f70 202d 7920  sky autostop -y 
+0000e210: 7b6e 616d 657d 202d 6920 3127 2c0a 0a20  {name} -i 1',.. 
+0000e220: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+0000e230: 7572 6520 6175 746f 7374 6f70 2069 7320  ure autostop is 
+0000e240: 7365 742e 0a20 2020 2020 2020 2020 2020  set..           
+0000e250: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
+0000e260: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+0000e270: 6570 2022 316d 2227 2c0a 0a20 2020 2020  ep "1m"',..     
+0000e280: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+0000e290: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
+0000e2a0: 6f74 2073 746f 7070 6564 2065 6172 6c79  ot stopped early
+0000e2b0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+0000e2c0: 6c65 6570 2034 3527 2c0a 2020 2020 2020  leep 45',.      
+0000e2d0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000e2e0: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
+0000e2f0: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
+0000e300: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000e310: 2065 6368 6f20 2224 7322 2020 7c20 6772   echo "$s"  | gr
+0000e320: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000e330: 2055 5027 2c0a 0a20 2020 2020 2020 2020   UP',..         
+0000e340: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
+0000e350: 636c 7573 7465 7220 6973 2053 544f 5050  cluster is STOPP
+0000e360: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
+0000e370: 2773 6c65 6570 2032 3530 272c 0a20 2020  'sleep 250',.   
+0000e380: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000e390: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
+0000e3a0: 202d 2d72 6566 7265 7368 293b 2065 6368   --refresh); ech
+0000e3b0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000e3c0: 686f 3b20 6563 686f 2022 2473 2220 207c  ho; echo "$s"  |
+0000e3d0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+0000e3e0: 7265 7020 5354 4f50 5045 4427 2c0a 0a20  rep STOPPED',.. 
+0000e3f0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+0000e400: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+0000e410: 6973 2055 5020 616e 6420 7468 6520 6175  is UP and the au
+0000e420: 746f 7374 6f70 2073 6574 7469 6e67 2069  tostop setting i
+0000e430: 7320 7265 7365 7420 2827 2d27 292e 0a20  s reset ('-').. 
+0000e440: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000e450: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
+0000e460: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000e470: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+0000e480: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000e490: 202d 4520 2255 505c 732b 2d22 272c 0a0a   -E "UP\s+-"',..
+0000e4a0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+0000e4b0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+0000e4c0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000e4d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000e4e0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+0000e4f0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+0000e500: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000e510: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000e520: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+0000e530: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000e540: 5465 7374 2072 6573 7461 7274 696e 6720  Test restarting 
+0000e550: 7468 6520 6964 6c65 6e65 7373 2074 696d  the idleness tim
+0000e560: 6572 2076 6961 2063 616e 6365 6c20 2b20  er via cancel + 
+0000e570: 7265 7365 743a 0a20 2020 2020 2020 2020  reset:.         
+0000e580: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
+0000e590: 7020 2d79 207b 6e61 6d65 7d20 2d69 2031  p -y {name} -i 1
+0000e5a0: 272c 2020 2320 4964 6c65 6e65 7373 2073  ',  # Idleness s
+0000e5b0: 7461 7274 7320 636f 756e 7469 6e67 2e0a  tarts counting..
+0000e5c0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000e5d0: 6570 2034 3527 2c20 2023 2041 6c6d 6f73  ep 45',  # Almos
+0000e5e0: 7420 7265 6163 6865 6420 7468 6520 7468  t reached the th
+0000e5f0: 7265 7368 6f6c 642e 0a20 2020 2020 2020  reshold..       
+0000e600: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+0000e610: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
+0000e620: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+0000e630: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+0000e640: 746f 7020 2d79 207b 6e61 6d65 7d20 2d69  top -y {name} -i
+0000e650: 2031 272c 2020 2320 5368 6f75 6c64 2072   1',  # Should r
+0000e660: 6573 7461 7274 2074 6865 2074 696d 6572  estart the timer
+0000e670: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+0000e680: 6c65 6570 2034 3527 2c0a 2020 2020 2020  leep 45',.      
+0000e690: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000e6a0: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
+0000e6b0: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
+0000e6c0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000e6d0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000e6e0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+0000e6f0: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
+0000e700: 2027 736c 6565 7020 3235 3027 2c0a 2020   'sleep 250',.  
+0000e710: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000e720: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+0000e730: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+0000e740: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000e750: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+0000e760: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000e770: 6772 6570 2053 544f 5050 4544 272c 0a0a  grep STOPPED',..
+0000e780: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0000e790: 7374 2072 6573 7461 7274 696e 6720 7468  st restarting th
+0000e7a0: 6520 6964 6c65 6e65 7373 2074 696d 6572  e idleness timer
+0000e7b0: 2076 6961 2065 7865 633a 0a20 2020 2020   via exec:.     
+0000e7c0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+0000e7d0: 7274 202d 7920 7b6e 616d 657d 272c 0a20  rt -y {name}',. 
+0000e7e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000e7f0: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
+0000e800: 6e61 6d65 7d20 7c20 6772 6570 202d 4520  name} | grep -E 
+0000e810: 2255 505c 732b 2d22 272c 0a20 2020 2020  "UP\s+-"',.     
+0000e820: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+0000e830: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
+0000e840: 2d69 2031 272c 2020 2320 4964 6c65 6e65  -i 1',  # Idlene
+0000e850: 7373 2073 7461 7274 7320 636f 756e 7469  ss starts counti
+0000e860: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+0000e870: 2773 6c65 6570 2034 3527 2c20 2023 2041  'sleep 45',  # A
+0000e880: 6c6d 6f73 7420 7265 6163 6865 6420 7468  lmost reached th
+0000e890: 6520 7468 7265 7368 6f6c 642e 0a20 2020  e threshold..   
+0000e8a0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000e8b0: 7865 6320 7b6e 616d 657d 2065 6368 6f20  xec {name} echo 
+0000e8c0: 6869 272c 2020 2320 5368 6f75 6c64 2072  hi',  # Should r
+0000e8d0: 6573 7461 7274 2074 6865 2074 696d 6572  estart the timer
+0000e8e0: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+0000e8f0: 6c65 6570 2034 3527 2c0a 2020 2020 2020  leep 45',.      
+0000e900: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000e910: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
+0000e920: 7265 6672 6573 6829 3b20 6563 686f 2022  refresh); echo "
+0000e930: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000e940: 2065 6368 6f20 2224 7322 2020 7c20 6772   echo "$s"  | gr
+0000e950: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000e960: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
+0000e970: 2020 2773 6c65 6570 2032 3530 272c 0a20    'sleep 250',. 
+0000e980: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000e990: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
+0000e9a0: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
+0000e9b0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000e9c0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000e9d0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000e9e0: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
+0000e9f0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000ea00: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000ea10: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+0000ea20: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+0000ea30: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+0000ea40: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000ea50: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0000ea60: 6573 7469 6e67 2041 7574 6f64 6f77 6e69  esting Autodowni
+0000ea70: 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ng ----------.@p
+0000ea80: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0000ea90: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0000eaa0: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+0000eab0: 6465 7320 3e20 3120 7965 742e 2052 756e  des > 1 yet. Run
+0000eac0: 2074 6573 745f 7363 705f 6175 746f 646f   test_scp_autodo
+0000ead0: 776e 2069 6e73 7465 6164 2e0a 6465 6620  wn instead..def 
+0000eae0: 7465 7374 5f61 7574 6f64 6f77 6e28 6765  test_autodown(ge
+0000eaf0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+0000eb00: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000eb10: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000eb20: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0000eb30: 7428 0a20 2020 2020 2020 2027 6175 746f  t(.        'auto
+0000eb40: 646f 776e 272c 0a20 2020 2020 2020 205b  down',.        [
+0000eb50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000eb60: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+0000eb70: 2d63 207b 6e61 6d65 7d20 2d2d 6e75 6d2d  -c {name} --num-
+0000eb80: 6e6f 6465 7320 3220 2d2d 636c 6f75 6420  nodes 2 --cloud 
+0000eb90: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+0000eba0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+0000ebb0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+0000ebc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ebd0: 7920 6175 746f 7374 6f70 202d 7920 7b6e  y autostop -y {n
+0000ebe0: 616d 657d 202d 2d64 6f77 6e20 2d69 2031  ame} --down -i 1
+0000ebf0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0000ec00: 2045 6e73 7572 6520 6175 746f 7374 6f70   Ensure autostop
+0000ec10: 2069 7320 7365 742e 0a20 2020 2020 2020   is set..       
+0000ec20: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+0000ec30: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+0000ec40: 7c20 6772 6570 2022 316d 2028 646f 776e  | grep "1m (down
+0000ec50: 2922 272c 0a20 2020 2020 2020 2020 2020  )"',.           
+0000ec60: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+0000ec70: 7573 7465 7220 6973 206e 6f74 2074 6572  uster is not ter
+0000ec80: 6d69 6e61 7465 6420 6561 726c 792e 0a20  minated early.. 
+0000ec90: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000eca0: 7020 3435 272c 0a20 2020 2020 2020 2020  p 45',.         
+0000ecb0: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+0000ecc0: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+0000ecd0: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+0000ece0: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000ecf0: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+0000ed00: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
+0000ed10: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0000ed20: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+0000ed30: 7465 7220 6973 2074 6572 6d69 6e61 7465  ter is terminate
+0000ed40: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+0000ed50: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+0000ed60: 2020 2020 2020 2020 6627 733d 2428 534b          f's=$(SK
+0000ed70: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
+0000ed80: 6b79 2073 7461 7475 7320 7b6e 616d 657d  ky status {name}
+0000ed90: 202d 2d72 6566 7265 7368 2920 2626 2065   --refresh) && e
+0000eda0: 6368 6f20 2224 7322 2026 2620 7b7b 2065  cho "$s" && {{ e
+0000edb0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000edc0: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
+0000edd0: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
+0000ede0: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
+0000edf0: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
+0000ee00: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
+0000ee10: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
+0000ee20: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
+0000ee30: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
+0000ee40: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000ee50: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
+0000ee60: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+0000ee70: 635f 636c 6f75 647d 202d 2d6e 756d 2d6e  c_cloud} --num-n
+0000ee80: 6f64 6573 2032 202d 2d64 6f77 6e20 7465  odes 2 --down te
+0000ee90: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+0000eea0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+0000eeb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000eec0: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
+0000eed0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
+0000eee0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
+0000eef0: 6c75 7374 6572 2069 7320 5550 2e0a 2020  luster is UP..  
+0000ef00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000ef10: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
+0000ef20: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+0000ef30: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
+0000ef40: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+0000ef50: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000ef60: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+0000ef70: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000ef80: 7020 2231 6d20 2864 6f77 6e29 2227 2c0a  p "1m (down)"',.
+0000ef90: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000efa0: 6570 2032 3430 272c 0a20 2020 2020 2020  ep 240',.       
+0000efb0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
+0000efc0: 6520 636c 7573 7465 7220 6973 2074 6572  e cluster is ter
+0000efd0: 6d69 6e61 7465 642e 0a20 2020 2020 2020  minated..       
+0000efe0: 2020 2020 2066 2773 3d24 2853 4b59 5049       f's=$(SKYPI
+0000eff0: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+0000f000: 7374 6174 7573 207b 6e61 6d65 7d20 2d2d  status {name} --
+0000f010: 7265 6672 6573 6829 2026 2620 6563 686f  refresh) && echo
+0000f020: 2022 2473 2220 2626 207b 7b20 6563 686f   "$s" && {{ echo
+0000f030: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000f040: 6d65 7d20 7c20 6772 6570 2022 4175 746f  me} | grep "Auto
+0000f050: 646f 776e 6564 2063 6c75 7374 6572 5c7c  downed cluster\|
+0000f060: 7465 726d 696e 6174 6564 206f 6e20 7468  terminated on th
+0000f070: 6520 636c 6f75 6422 3b20 7d7d 207c 7c20  e cloud"; }} || 
+0000f080: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
+0000f090: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
+0000f0a0: 6974 2031 207c 7c20 6578 6974 2030 3b20  it 1 || exit 0; 
+0000f0b0: 7d7d 272c 0a20 2020 2020 2020 2020 2020  }}',.           
+0000f0c0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000f0d0: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
+0000f0e0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0000f0f0: 6c6f 7564 7d20 2d2d 6e75 6d2d 6e6f 6465  loud} --num-node
+0000f100: 7320 3220 2d2d 646f 776e 2074 6573 7473  s 2 --down tests
+0000f110: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+0000f120: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+0000f130: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+0000f140: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
+0000f150: 2d2d 6361 6e63 656c 272c 0a20 2020 2020  --cancel',.     
+0000f160: 2020 2020 2020 2027 736c 6565 7020 3234         'sleep 24
+0000f170: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0000f180: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+0000f190: 7374 6572 2069 7320 7374 696c 6c20 5550  ster is still UP
+0000f1a0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000f1b0: 733d 2428 534b 5950 494c 4f54 5f44 4542  s=$(SKYPILOT_DEB
+0000f1c0: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+0000f1d0: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
+0000f1e0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0000f1f0: 2620 6563 686f 2022 2473 2220 7c20 6772  & echo "$s" | gr
+0000f200: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000f210: 2055 5027 2c0a 2020 2020 2020 2020 5d2c   UP',.        ],
+0000f220: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0000f230: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0000f240: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0000f250: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+0000f260: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000f270: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0000f280: 6d61 726b 2e73 6370 0a64 6566 2074 6573  mark.scp.def tes
+0000f290: 745f 7363 705f 6175 746f 646f 776e 2829  t_scp_autodown()
+0000f2a0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000f2b0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000f2c0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000f2d0: 280a 2020 2020 2020 2020 2753 4350 5f61  (.        'SCP_a
+0000f2e0: 7574 6f64 6f77 6e27 2c0a 2020 2020 2020  utodown',.      
+0000f2f0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000f300: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000f310: 2d64 202d 6320 7b6e 616d 657d 207b 5343  -d -c {name} {SC
+0000f320: 505f 5459 5045 7d20 7465 7374 732f 7465  P_TYPE} tests/te
+0000f330: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+0000f340: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000f350: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
+0000f360: 6f70 202d 7920 7b6e 616d 657d 202d 2d64  op -y {name} --d
+0000f370: 6f77 6e20 2d69 2031 272c 0a20 2020 2020  own -i 1',.     
+0000f380: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+0000f390: 6175 746f 7374 6f70 2069 7320 7365 742e  autostop is set.
+0000f3a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000f3b0: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
+0000f3c0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
+0000f3d0: 316d 2028 646f 776e 2922 272c 0a20 2020  1m (down)"',.   
+0000f3e0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+0000f3f0: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+0000f400: 206e 6f74 2074 6572 6d69 6e61 7465 6420   not terminated 
+0000f410: 6561 726c 792e 0a20 2020 2020 2020 2020  early..         
+0000f420: 2020 2027 736c 6565 7020 3435 272c 0a20     'sleep 45',. 
+0000f430: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000f440: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
+0000f450: 6820 7c20 6772 6570 207b 6e61 6d65 7d20  h | grep {name} 
+0000f460: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
+0000f470: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+0000f480: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+0000f490: 7465 726d 696e 6174 6564 2e0a 2020 2020  terminated..    
+0000f4a0: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
+0000f4b0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+0000f4c0: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
+0000f4d0: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
+0000f4e0: 7573 202d 2d72 6566 7265 7368 2920 2626  us --refresh) &&
+0000f4f0: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
+0000f500: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
+0000f510: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000f520: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
+0000f530: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
+0000f540: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
+0000f550: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
+0000f560: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000f570: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
+0000f580: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
+0000f590: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000f5a0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
+0000f5b0: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000f5c0: 2d2d 646f 776e 2074 6573 7473 2f74 6573  --down tests/tes
+0000f5d0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+0000f5e0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000f5f0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+0000f600: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000f610: 6772 6570 2055 5027 2c20 2023 2045 6e73  grep UP',  # Ens
+0000f620: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+0000f630: 6973 2055 502e 0a20 2020 2020 2020 2020  is UP..         
+0000f640: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000f650: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000f660: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+0000f670: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+0000f680: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f690: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+0000f6a0: 7b6e 616d 657d 207c 2067 7265 7020 2231  {name} | grep "1
+0000f6b0: 6d20 2864 6f77 6e29 2227 2c0a 2020 2020  m (down)"',.    
+0000f6c0: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
+0000f6d0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+0000f6e0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
+0000f6f0: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
+0000f700: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+0000f710: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
+0000f720: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
+0000f730: 7573 202d 2d72 6566 7265 7368 2920 2626  us --refresh) &&
+0000f740: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
+0000f750: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
+0000f760: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000f770: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
+0000f780: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
+0000f790: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
+0000f7a0: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
+0000f7b0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000f7c0: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
+0000f7d0: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
+0000f7e0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000f7f0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
+0000f800: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
+0000f810: 2d2d 646f 776e 2074 6573 7473 2f74 6573  --down tests/tes
+0000f820: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+0000f830: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000f840: 2020 2066 2773 6b79 2061 7574 6f73 746f     f'sky autosto
+0000f850: 7020 2d79 207b 6e61 6d65 7d20 2d2d 6361  p -y {name} --ca
+0000f860: 6e63 656c 272c 0a20 2020 2020 2020 2020  ncel',.         
+0000f870: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
+0000f880: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+0000f890: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+0000f8a0: 2069 7320 7374 696c 6c20 5550 2e0a 2020   is still UP..  
+0000f8b0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000f8c0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+0000f8d0: 2073 6b79 2073 7461 7475 7320 2d2d 7265   sky status --re
+0000f8e0: 6672 6573 6829 2026 2620 7072 696e 7466  fresh) && printf
+0000f8f0: 2022 2473 2220 2626 2065 6368 6f20 2224   "$s" && echo "$
+0000f900: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000f910: 207c 2067 7265 7020 5550 272c 0a20 2020   | grep UP',.   
+0000f920: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000f930: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0000f940: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+0000f950: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+0000f960: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000f970: 655f 7465 7374 2874 6573 7429 0a0a 0a64  e_test(test)...d
+0000f980: 6566 205f 6765 745f 6361 6e63 656c 5f74  ef _get_cancel_t
+0000f990: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
+0000f9a0: 616d 652c 2063 6c6f 7564 2c20 7469 6d65  ame, cloud, time
+0000f9b0: 6f75 743d 3135 202a 2036 3029 3a0a 2020  out=15 * 60):.  
+0000f9c0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000f9d0: 2020 2020 2020 2066 277b 636c 6f75 647d         f'{cloud}
+0000f9e0: 2d63 616e 6365 6c2d 7461 736b 272c 0a20  -cancel-task',. 
+0000f9f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000fa00: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000fa10: 6820 2d63 207b 6e61 6d65 7d20 6578 616d  h -c {name} exam
+0000fa20: 706c 6573 2f72 6573 6e65 745f 6170 702e  ples/resnet_app.
+0000fa30: 7961 6d6c 202d 2d63 6c6f 7564 207b 636c  yaml --cloud {cl
+0000fa40: 6f75 647d 202d 7920 2d64 272c 0a20 2020  oud} -y -d',.   
+0000fa50: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+0000fa60: 7468 6520 4750 5520 7072 6f63 6573 7320  the GPU process 
+0000fa70: 746f 2073 7461 7274 2e0a 2020 2020 2020  to start..      
+0000fa80: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
+0000fa90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000faa0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000fab0: 226e 7669 6469 612d 736d 6920 7c20 6772  "nvidia-smi | gr
+0000fac0: 6570 2070 7974 686f 6e22 272c 0a20 2020  ep python"',.   
+0000fad0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000fae0: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+0000faf0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+0000fb00: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+0000fb10: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+0000fb20: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000fb30: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
+0000fb40: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
+0000fb50: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0000fb60: 2320 6368 6563 6b20 6966 2074 6865 2070  # check if the p
+0000fb70: 7974 686f 6e20 6a6f 6220 6973 2067 6f6e  ython job is gon
+0000fb80: 652e 0a20 2020 2020 2020 2020 2020 2066  e..            f
+0000fb90: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000fba0: 2022 2120 6e76 6964 6961 2d73 6d69 207c   "! nvidia-smi |
+0000fbb0: 2067 7265 7020 7079 7468 6f6e 2227 2c0a   grep python"',.
+0000fbc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000fbd0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+0000fbe0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+0000fbf0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+0000fc00: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+0000fc10: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+0000fc20: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+0000fc30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+0000fc40: 743d 7469 6d65 6f75 742c 0a20 2020 2029  t=timeout,.    )
+0000fc50: 0a20 2020 2072 6574 7572 6e20 7465 7374  .    return test
+0000fc60: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0000fc70: 5465 7374 696e 6720 6073 6b79 2063 616e  Testing `sky can
+0000fc80: 6365 6c60 202d 2d2d 2d2d 2d2d 2d2d 2d0a  cel` ----------.
+0000fc90: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+0000fca0: 0a40 7079 7465 7374 2e6d 6172 6b2e 736b  .@pytest.mark.sk
+0000fcb0: 6970 280a 2020 2020 7265 6173 6f6e 3d27  ip(.    reason='
+0000fcc0: 5468 6520 7265 736e 6574 5f61 7070 2069  The resnet_app i
+0000fcd0: 7320 666c 616b 792c 2064 7565 2074 6f20  s flaky, due to 
+0000fce0: 5446 2066 6169 6c69 6e67 2074 6f20 6465  TF failing to de
+0000fcf0: 7465 6374 2047 5055 732e 2729 0a64 6566  tect GPUs.').def
+0000fd00: 2074 6573 745f 6361 6e63 656c 5f61 7773   test_cancel_aws
+0000fd10: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+0000fd20: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000fd30: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
+0000fd40: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
+0000fd50: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
+0000fd60: 2761 7773 2729 0a20 2020 2072 756e 5f6f  'aws').    run_o
+0000fd70: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000fd80: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+0000fd90: 0a40 7079 7465 7374 2e6d 6172 6b2e 736b  .@pytest.mark.sk
+0000fda0: 6970 280a 2020 2020 7265 6173 6f6e 3d27  ip(.    reason='
+0000fdb0: 5468 6520 7265 736e 6574 5f61 7070 2069  The resnet_app i
+0000fdc0: 7320 666c 616b 792c 2064 7565 2074 6f20  s flaky, due to 
+0000fdd0: 5446 2066 6169 6c69 6e67 2074 6f20 6465  TF failing to de
+0000fde0: 7465 6374 2047 5055 732e 2729 0a64 6566  tect GPUs.').def
+0000fdf0: 2074 6573 745f 6361 6e63 656c 5f67 6370   test_cancel_gcp
+0000fe00: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+0000fe10: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000fe20: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
+0000fe30: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
+0000fe40: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
+0000fe50: 2767 6370 2729 0a20 2020 2072 756e 5f6f  'gcp').    run_o
+0000fe60: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000fe70: 4070 7974 6573 742e 6d61 726b 2e61 7a75  @pytest.mark.azu
+0000fe80: 7265 0a40 7079 7465 7374 2e6d 6172 6b2e  re.@pytest.mark.
+0000fe90: 736b 6970 280a 2020 2020 7265 6173 6f6e  skip(.    reason
+0000fea0: 3d27 5468 6520 7265 736e 6574 5f61 7070  ='The resnet_app
+0000feb0: 2069 7320 666c 616b 792c 2064 7565 2074   is flaky, due t
+0000fec0: 6f20 5446 2066 6169 6c69 6e67 2074 6f20  o TF failing to 
+0000fed0: 6465 7465 6374 2047 5055 732e 2729 0a64  detect GPUs.').d
+0000fee0: 6566 2074 6573 745f 6361 6e63 656c 5f61  ef test_cancel_a
+0000fef0: 7a75 7265 2829 3a0a 2020 2020 6e61 6d65  zure():.    name
+0000ff00: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000ff10: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0000ff20: 3d20 5f67 6574 5f63 616e 6365 6c5f 7461  = _get_cancel_ta
+0000ff30: 736b 5f77 6974 685f 636c 6f75 6428 6e61  sk_with_cloud(na
+0000ff40: 6d65 2c20 2761 7a75 7265 272c 2074 696d  me, 'azure', tim
+0000ff50: 656f 7574 3d33 3020 2a20 3630 290a 2020  eout=30 * 60).  
+0000ff60: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000ff70: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000ff80: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0000ff90: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0000ffa0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000ffb0: 6520 5631 3030 2067 7075 730a 4070 7974  e V100 gpus.@pyt
+0000ffc0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+0000ffd0: 2023 2049 424d 2063 6c6f 7564 2063 7572   # IBM cloud cur
+0000ffe0: 7265 6e74 6c79 2064 6f65 736e 2774 2070  rently doesn't p
+0000fff0: 726f 7669 6465 2070 7562 6c69 6320 696d  rovide public im
+00010000: 6167 6520 7769 7468 2043 5544 410a 4070  age with CUDA.@p
+00010010: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+00010020: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+00010030: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+00010040: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
+00010050: 7465 7374 5f63 616e 6365 6c5f 7079 746f  test_cancel_pyto
+00010060: 7263 6828 6765 6e65 7269 635f 636c 6f75  rch(generic_clou
+00010070: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+00010080: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00010090: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+000100a0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000100b0: 2027 6361 6e63 656c 2d70 7974 6f72 6368   'cancel-pytorch
+000100c0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000100d0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000100e0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+000100f0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00010100: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
+00010110: 2f72 6573 6e65 745f 6469 7374 7269 6275  /resnet_distribu
+00010120: 7465 645f 746f 7263 682e 7961 6d6c 202d  ted_torch.yaml -
+00010130: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00010140: 2020 2023 2057 6169 7420 7468 6520 4750     # Wait the GP
+00010150: 5520 7072 6f63 6573 7320 746f 2073 7461  U process to sta
+00010160: 7274 2e0a 2020 2020 2020 2020 2020 2020  rt..            
+00010170: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
+00010180: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00010190: 6563 207b 6e61 6d65 7d20 226e 7669 6469  ec {name} "nvidi
+000101a0: 612d 736d 6920 7c20 6772 6570 2070 7974  a-smi | grep pyt
+000101b0: 686f 6e22 272c 0a20 2020 2020 2020 2020  hon"',.         
+000101c0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000101d0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+000101e0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000101f0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00010200: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00010210: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+00010220: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
+00010230: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+00010240: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00010250: 6578 6563 207b 6e61 6d65 7d20 2228 6e76  exec {name} "(nv
+00010260: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
+00010270: 5c27 4e6f 2072 756e 6e69 6e67 2070 726f  \'No running pro
+00010280: 6365 7373 5c27 2920 7c7c 2027 0a20 2020  cess\') || '.   
+00010290: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+000102a0: 6520 586f 7267 2069 7320 7468 6520 6f6e  e Xorg is the on
+000102b0: 6c79 2070 726f 6365 7373 2072 756e 6e69  ly process runni
+000102c0: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+000102d0: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
+000102e0: 207c 2067 7265 7020 2d41 2031 3020 5072   | grep -A 10 Pr
+000102f0: 6f63 6573 7365 7320 7c20 6772 6570 202d  ocesses | grep -
+00010300: 4120 3130 203d 3d3d 207c 2067 7265 7020  A 10 === | grep 
+00010310: 2d76 2058 6f72 6729 202d 6571 2032 205d  -v Xorg) -eq 2 ]
+00010320: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00010330: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00010340: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
+00010350: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00010360: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00010370: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00010380: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00010390: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+000103a0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+000103b0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+000103c0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+000103d0: 6361 6e27 7420 7573 6520 605f 6765 745f  can't use `_get_
+000103e0: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
+000103f0: 5f63 6c6f 7564 2829 602c 2061 7320 636f  _cloud()`, as co
+00010400: 6d6d 616e 6420 606e 7669 6469 612d 736d  mmand `nvidia-sm
+00010410: 6960 0a23 2072 6571 7569 7265 7320 6120  i`.# requires a 
+00010420: 4355 4441 2070 7562 6c69 6320 696d 6167  CUDA public imag
+00010430: 652c 2077 6869 6368 2049 424d 2064 6f65  e, which IBM doe
+00010440: 736e 2774 206f 6666 6572 0a40 7079 7465  sn't offer.@pyte
+00010450: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
+00010460: 7465 7374 5f63 616e 6365 6c5f 6962 6d28  test_cancel_ibm(
+00010470: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00010480: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00010490: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+000104a0: 7428 0a20 2020 2020 2020 2027 6962 6d2d  t(.        'ibm-
+000104b0: 6361 6e63 656c 2d74 6173 6b27 2c0a 2020  cancel-task',.  
+000104c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000104d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000104e0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+000104f0: 636c 6f75 6420 6962 6d20 6578 616d 706c  cloud ibm exampl
+00010500: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+00010510: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00010520: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00010530: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2020  -n {name}-1 -d  
+00010540: 2277 6869 6c65 2074 7275 653b 2064 6f20  "while true; do 
+00010550: 6563 686f 205c 2748 656c 6c6f 2053 6b79  echo \'Hello Sky
+00010560: 5069 6c6f 745c 273b 2073 6c65 6570 2032  Pilot\'; sleep 2
+00010570: 3b20 646f 6e65 2227 2c0a 2020 2020 2020  ; done"',.      
+00010580: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
+00010590: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000105a0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+000105b0: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+000105c0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+000105d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000105e0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+000105f0: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+00010600: 2020 2020 2066 2773 6c65 6570 2035 272c       f'sleep 5',
+00010610: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00010620: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
+00010630: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
+00010640: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
+00010650: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00010660: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00010670: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00010680: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00010690: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+000106a0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+000106b0: 2075 7365 2d73 706f 7420 6f70 7469 6f6e   use-spot option
+000106c0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+000106d0: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+000106e0: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+000106f0: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+00010700: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00010710: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00010720: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+00010730: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
+00010740: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00010750: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00010760: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+00010770: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+00010780: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00010790: 6e63 6573 0a64 6566 2074 6573 745f 7573  nces.def test_us
+000107a0: 655f 7370 6f74 2867 656e 6572 6963 5f63  e_spot(generic_c
+000107b0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000107c0: 2222 2254 6573 7420 7573 652d 7370 6f74  """Test use-spot
+000107d0: 2061 6e64 2073 6b79 2065 7865 632e 2222   and sky exec.""
+000107e0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+000107f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00010800: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00010810: 280a 2020 2020 2020 2020 2775 7365 2d73  (.        'use-s
+00010820: 706f 7427 2c0a 2020 2020 2020 2020 5b0a  pot',.        [.
+00010830: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010840: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+00010850: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00010860: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
+00010870: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+00010880: 6d61 6c2e 7961 6d6c 202d 2d75 7365 2d73  mal.yaml --use-s
+00010890: 706f 7420 2d79 272c 0a20 2020 2020 2020  pot -y',.       
+000108a0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000108b0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+000108c0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+000108d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+000108e0: 7d20 6563 686f 2068 6927 2c0a 2020 2020  } echo hi',.    
+000108f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00010900: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00010910: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+00010920: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00010930: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00010940: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00010950: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00010960: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00010970: 7469 6e67 206d 616e 6167 6564 2073 706f  ting managed spo
+00010980: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
+00010990: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+000109a0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+000109b0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+000109c0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+000109d0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+000109e0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+000109f0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00010a00: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00010a10: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00010a20: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00010a30: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00010a40: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00010a50: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00010a60: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00010a70: 6465 6620 7465 7374 5f73 706f 7428 6765  def test_spot(ge
+00010a80: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00010a90: 293a 0a20 2020 2022 2222 5465 7374 2074  ):.    """Test t
+00010aa0: 6865 2073 706f 7420 7961 6d6c 2e22 2222  he spot yaml."""
+00010ab0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00010ac0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00010ad0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00010ae0: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
+00010af0: 642d 7370 6f74 272c 0a20 2020 2020 2020  d-spot',.       
+00010b00: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00010b10: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+00010b20: 202d 6e20 7b6e 616d 657d 2d31 202d 2d63   -n {name}-1 --c
+00010b30: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00010b40: 6f75 647d 2065 7861 6d70 6c65 732f 6d61  oud} examples/ma
+00010b50: 6e61 6765 645f 7370 6f74 2e79 616d 6c20  naged_spot.yaml 
+00010b60: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00010b70: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+00010b80: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
+00010b90: 3220 2d2d 636c 6f75 6420 7b67 656e 6572  2 --cloud {gener
+00010ba0: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
+00010bb0: 6573 2f6d 616e 6167 6564 5f73 706f 742e  es/managed_spot.
+00010bc0: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
+00010bd0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00010be0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+00010bf0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00010c00: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00010c10: 7d2d 3120 7c20 6865 6164 202d 6e31 207c  }-1 | head -n1 |
+00010c20: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00010c30: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+00010c40: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00010c50: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00010c60: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
+00010c70: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
+00010c80: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
+00010c90: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00010ca0: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+00010cb0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+00010cc0: 653d 6627 7b6e 616d 657d 2d31 2729 2c0a  e=f'{name}-1'),.
+00010cd0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00010ce0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00010cf0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00010d00: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00010d10: 616d 657d 2d31 207c 2068 6561 6420 2d6e  ame}-1 | head -n
+00010d20: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+00010d30: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+00010d40: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00010d50: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00010d60: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00010d70: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00010d80: 6570 207b 6e61 6d65 7d2d 3120 7c20 6865  ep {name}-1 | he
+00010d90: 6164 202d 6e31 207c 2067 7265 7020 4341  ad -n1 | grep CA
+00010da0: 4e43 454c 4c45 4427 2c0a 2020 2020 2020  NCELLED',.      
+00010db0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00010dc0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00010dd0: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
+00010de0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+00010df0: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
+00010e00: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00010e10: 2020 2020 2020 2320 544f 444f 287a 6877        # TODO(zhw
+00010e20: 7529 3a20 4368 616e 6765 2074 6f20 5f53  u): Change to _S
+00010e30: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+00010e40: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00010e50: 6627 7b6e 616d 657d 2d31 202d 6e20 7b6e  f'{name}-1 -n {n
+00010e60: 616d 657d 2d32 2729 2077 6865 6e0a 2020  ame}-2') when.  
+00010e70: 2020 2020 2020 2320 6361 6e63 656c 696e        # cancelin
+00010e80: 6720 6d75 6c74 6970 6c65 206a 6f62 206e  g multiple job n
+00010e90: 616d 6573 2069 7320 7375 7070 6f72 7465  ames is supporte
+00010ea0: 642e 0a20 2020 2020 2020 2028 5f53 504f  d..        (_SPO
+00010eb0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00010ec0: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00010ed0: 7b6e 616d 657d 2d31 2729 202b 2027 3b20  {name}-1') + '; 
+00010ee0: 2720 2b0a 2020 2020 2020 2020 205f 5350  ' +.         _SP
+00010ef0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00010f00: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+00010f10: 277b 6e61 6d65 7d2d 3227 2929 2c0a 2020  '{name}-2')),.  
+00010f20: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00010f30: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00010f40: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00010f50: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00010f60: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00010f70: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00010f80: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00010f90: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00010fa0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00010fb0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00010fc0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00010fd0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00010fe0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00010ff0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00011000: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00011010: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00011020: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00011030: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00011040: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00011050: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00011060: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00011070: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00011080: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00011090: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
+000110a0: 7065 6c69 6e65 2867 656e 6572 6963 5f63  peline(generic_c
+000110b0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000110c0: 2222 2254 6573 7420 6120 7370 6f74 c2a0  """Test a spot..
+000110d0: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
+000110e0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+000110f0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00011100: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00011110: 2020 2020 2027 7370 6f74 2d70 6970 656c       'spot-pipel
+00011120: 696e 6527 2c0a 2020 2020 2020 2020 5b0a  ine',.        [.
+00011130: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00011140: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
+00011150: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+00011160: 7374 5f79 616d 6c73 2f70 6970 656c 696e  st_yamls/pipelin
+00011170: 652e 7961 6d6c 202d 7920 2d64 272c 0a20  e.yaml -y -d',. 
+00011180: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00011190: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+000111a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+000111b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000111c0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+000111d0: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+000111e0: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+000111f0: 2020 2020 2020 2020 2320 6067 7265 7020          # `grep 
+00011200: 2d41 2034 207b 6e61 6d65 7d60 2066 696e  -A 4 {name}` fin
+00011210: 6473 2074 6865 206a 6f62 2077 6974 6820  ds the job with 
+00011220: 7b6e 616d 657d 2061 6e64 2074 6865 2034  {name} and the 4
+00011230: 206c 696e 6573 0a20 2020 2020 2020 2020   lines.         
+00011240: 2020 2023 2061 6674 6572 2069 742c 2069     # after it, i
+00011250: 2e65 2e20 7468 6520 3420 7461 736b 7320  .e. the 4 tasks 
+00011260: 7769 7468 696e 2074 6865 206a 6f62 2e0a  within the job..
+00011270: 2020 2020 2020 2020 2020 2020 2320 6073              # `s
+00011280: 6564 202d 6e20 3270 6020 6765 7473 2074  ed -n 2p` gets t
+00011290: 6865 2073 6563 6f6e 6420 6c69 6e65 206f  he second line o
+000112a0: 6620 7468 6520 3420 6c69 6e65 732c 2069  f the 4 lines, i
+000112b0: 2e65 2e20 7468 6520 6669 7273 740a 2020  .e. the first.  
+000112c0: 2020 2020 2020 2020 2020 2320 7461 736b            # task
+000112d0: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
+000112e0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000112f0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00011300: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+00011310: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
+00011320: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00011330: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+00011340: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00011350: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00011360: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00011370: 7365 6420 2d6e 2033 7020 7c20 6772 6570  sed -n 3p | grep
+00011380: 2022 5045 4e44 494e 4722 272c 0a20 2020   "PENDING"',.   
+00011390: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+000113a0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+000113b0: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+000113c0: 6d65 7d27 292c 0a20 2020 2020 2020 2020  me}'),.         
+000113d0: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+000113e0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+000113f0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00011400: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00011410: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
+00011420: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+00011430: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+00011440: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00011450: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00011460: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00011470: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
+00011480: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
+00011490: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+000114a0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+000114b0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+000114c0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+000114d0: 7365 6420 2d6e 2034 7020 7c20 6772 6570  sed -n 4p | grep
+000114e0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+000114f0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00011500: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00011510: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00011520: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00011530: 6564 202d 6e20 3570 207c 2067 7265 7020  ed -n 5p | grep 
+00011540: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
+00011550: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00011560: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
+00011570: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00011580: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00011590: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
+000115a0: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
+000115b0: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+000115c0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+000115d0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+000115e0: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
+000115f0: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00011600: 2033 7020 7c20 6772 6570 2022 4341 4e43   3p | grep "CANC
+00011610: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00011620: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00011630: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00011640: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+00011650: 202d 6e20 3470 207c 2067 7265 7020 2243   -n 4p | grep "C
+00011660: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+00011670: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00011680: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00011690: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+000116a0: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
+000116b0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+000116c0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000116d0: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
+000116e0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+000116f0: 616d 653d 6627 7b6e 616d 657d 2729 2c0a  ame=f'{name}'),.
+00011700: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
+00011710: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
+00011720: 2073 6b79 2073 706f 7420 7175 6575 6520   sky spot queue 
+00011730: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
+00011740: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
+00011750: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
+00011760: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
+00011770: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00011780: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00011790: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+000117a0: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+000117b0: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+000117c0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+000117d0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+000117e0: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+000117f0: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
+00011800: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00011810: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00011820: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
+00011830: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
+00011840: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00011850: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00011860: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+00011870: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+00011880: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
+00011890: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+000118a0: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+000118b0: 6e61 6765 6420 7370 6f74 206a 6f62 2077  naged spot job w
+000118c0: 6974 6820 6661 696c 6564 2073 6574 7570  ith failed setup
+000118d0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+000118e0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000118f0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00011900: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00011910: 6f74 5f66 6169 6c65 645f 7365 7475 7027  ot_failed_setup'
+00011920: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00011930: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+00011940: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
+00011950: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00011960: 6572 6963 5f63 6c6f 7564 7d20 2d79 202d  eric_cloud} -y -
+00011970: 6420 7465 7374 732f 7465 7374 5f79 616d  d tests/test_yam
+00011980: 6c73 2f66 6169 6c65 645f 7365 7475 702e  ls/failed_setup.
+00011990: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000119a0: 2020 2027 736c 6565 7020 3333 3027 2c0a     'sleep 330',.
+000119b0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+000119c0: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
+000119d0: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
+000119e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000119f0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00011a00: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00011a10: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00011a20: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00011a30: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00011a40: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00011a50: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00011a60: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00011a70: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00011a80: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00011a90: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00011aa0: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00011ab0: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00011ac0: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00011ad0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00011ae0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00011af0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00011b00: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00011b10: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00011b20: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00011b30: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00011b40: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00011b50: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00011b60: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00011b70: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00011b80: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00011b90: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00011ba0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00011bb0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00011bc0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00011bd0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00011be0: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
+00011bf0: 7065 6c69 6e65 5f66 6169 6c65 645f 7365  peline_failed_se
+00011c00: 7475 7028 6765 6e65 7269 635f 636c 6f75  tup(generic_clou
+00011c10: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00011c20: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00011c30: 7420 6a6f 6220 7769 7468 2066 6169 6c65  t job with faile
+00011c40: 6420 7365 7475 7020 666f 7220 6120 7069  d setup for a pi
+00011c50: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
+00011c60: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00011c70: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00011c80: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00011c90: 2020 2027 7370 6f74 5f70 6970 656c 696e     'spot_pipelin
+00011ca0: 655f 6661 696c 6564 5f73 6574 7570 272c  e_failed_setup',
+00011cb0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00011cc0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+00011cd0: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+00011ce0: 657d 202d 7920 2d64 2074 6573 7473 2f74  e} -y -d tests/t
+00011cf0: 6573 745f 7961 6d6c 732f 6661 696c 6564  est_yamls/failed
+00011d00: 5f73 6574 7570 5f70 6970 656c 696e 652e  _setup_pipeline.
+00011d10: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00011d20: 2020 2027 736c 6565 7020 3830 3027 2c0a     'sleep 800',.
+00011d30: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+00011d40: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
+00011d50: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
+00011d60: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00011d70: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00011d80: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00011d90: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00011da0: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00011db0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00011dc0: 5461 736b 2030 2073 686f 756c 6420 6265  Task 0 should be
+00011dd0: 2053 5543 4345 4544 4544 2e0a 2020 2020   SUCCEEDED..    
+00011de0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00011df0: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
+00011e00: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00011e10: 2073 6564 202d 6e20 3270 207c 2067 7265   sed -n 2p | gre
+00011e20: 7020 2253 5543 4345 4544 4544 2227 2c0a  p "SUCCEEDED"',.
+00011e30: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
+00011e40: 736b 2031 2073 686f 756c 6420 6265 2046  sk 1 should be F
+00011e50: 4149 4c45 445f 5345 5455 502e 0a20 2020  AILED_SETUP..   
+00011e60: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00011e70: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
+00011e80: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00011e90: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
+00011ea0: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
+00011eb0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00011ec0: 2320 5461 736b 2032 2073 686f 756c 6420  # Task 2 should 
+00011ed0: 6265 2043 414e 4345 4c4c 4544 2e0a 2020  be CANCELLED..  
+00011ee0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00011ef0: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
+00011f00: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00011f10: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
+00011f20: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+00011f30: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00011f40: 5461 736b 2033 2073 686f 756c 6420 6265  Task 3 should be
+00011f50: 2043 414e 4345 4c4c 4544 2e0a 2020 2020   CANCELLED..    
+00011f60: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00011f70: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
+00011f80: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00011f90: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
+00011fa0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00011fb0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00011fc0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00011fd0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00011fe0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00011ff0: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
+00012000: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
+00012010: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
+00012020: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
+00012030: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
+00012040: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
+00012050: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
+00012060: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00012070: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00012080: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00012090: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
+000120a0: 6f76 6572 7920 2d2d 2d2d 2d2d 2d2d 2d2d  overy ----------
+000120b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000120c0: 6177 730a 4070 7974 6573 742e 6d61 726b  aws.@pytest.mark
+000120d0: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
+000120e0: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
+000120f0: 7665 7279 5f61 7773 2861 7773 5f63 6f6e  very_aws(aws_con
+00012100: 6669 675f 7265 6769 6f6e 293a 0a20 2020  fig_region):.   
+00012110: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
+00012120: 2073 706f 7420 7265 636f 7665 7279 2e22   spot recovery."
+00012130: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+00012140: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00012150: 290a 2020 2020 7265 6769 6f6e 203d 2061  ).    region = a
+00012160: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+00012170: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00012180: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
+00012190: 7265 636f 7665 7279 5f61 7773 272c 0a20  recovery_aws',. 
+000121a0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000121b0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+000121c0: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
+000121d0: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+000121e0: 696f 6e7d 202d 6e20 7b6e 616d 657d 2022  ion} -n {name} "
+000121f0: 6563 686f 2053 4b59 5049 4c4f 545f 5441  echo SKYPILOT_TA
+00012200: 534b 5f49 443a 205c 2453 4b59 5049 4c4f  SK_ID: \$SKYPILO
+00012210: 545f 5441 534b 5f49 443b 2073 6c65 6570  T_TASK_ID; sleep
+00012220: 2031 3830 3022 2020 2d79 202d 6427 2c0a   1800"  -y -d',.
+00012230: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00012240: 6570 2033 3630 272c 0a20 2020 2020 2020  ep 360',.       
+00012250: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00012260: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00012270: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00012280: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00012290: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+000122a0: 2066 2752 554e 5f49 443d 2428 736b 7920   f'RUN_ID=$(sky 
+000122b0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+000122c0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+000122d0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+000122e0: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
+000122f0: 3a20 2d66 3229 3b20 6563 686f 2022 2452  : -f2); echo "$R
+00012300: 554e 5f49 4422 207c 2074 6565 202f 746d  UN_ID" | tee /tm
+00012310: 702f 7b6e 616d 657d 2d72 756e 2d69 6427  p/{name}-run-id'
+00012320: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00012330: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
+00012340: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
+00012350: 2020 2020 2020 2020 2020 2020 2866 2761              (f'a
+00012360: 7773 2065 6332 2074 6572 6d69 6e61 7465  ws ec2 terminate
+00012370: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
+00012380: 696f 6e20 7b72 6567 696f 6e7d 202d 2d69  ion {region} --i
+00012390: 6e73 7461 6e63 652d 6964 7320 2428 270a  nstance-ids $('.
+000123a0: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
+000123b0: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+000123c0: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+000123d0: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+000123e0: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+000123f0: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
+00012400: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+00012410: 2c56 616c 7565 733d 7b6e 616d 657d 2a20  ,Values={name}* 
+00012420: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+00012430: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
+00012440: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
+00012450: 735b 5d2e 496e 7374 616e 6365 4964 2027  s[].InstanceId '
+00012460: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
+00012470: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
+00012480: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00012490: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+000124a0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+000124b0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+000124c0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+000124d0: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+000124e0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+000124f0: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+00012500: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00012510: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00012520: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00012530: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00012540: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00012550: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00012560: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+00012570: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+00012580: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+00012590: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+000125a0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+000125b0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+000125c0: 5441 534b 5f49 4420 7c20 6772 6570 2022  TASK_ID | grep "
+000125d0: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
+000125e0: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
+000125f0: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+00012600: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00012610: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00012620: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+00012630: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00012640: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00012650: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+00012660: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+00012670: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
+00012680: 7374 5f73 706f 745f 7265 636f 7665 7279  st_spot_recovery
+00012690: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
+000126a0: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
+000126b0: 2072 6563 6f76 6572 792e 2222 220a 2020   recovery.""".  
+000126c0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000126d0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000126e0: 207a 6f6e 6520 3d20 2775 732d 6561 7374   zone = 'us-east
+000126f0: 342d 6227 0a20 2020 2071 7565 7279 5f63  4-b'.    query_c
+00012700: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
+00012710: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+00012720: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
+00012730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012740: 2020 6627 2228 6c61 6265 6c73 2e72 6179    f'"(labels.ray
+00012750: 2d63 6c75 7374 6572 2d6e 616d 653a 7b6e  -cluster-name:{n
+00012760: 616d 657d 2922 2027 0a20 2020 2020 2020  ame})" '.       
+00012770: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
+00012780: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+00012790: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+000127a0: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
+000127b0: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
+000127c0: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+000127d0: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
+000127e0: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
+000127f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012800: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
+00012810: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
+00012820: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00012830: 2020 2020 2773 706f 745f 7265 636f 7665      'spot_recove
+00012840: 7279 5f67 6370 272c 0a20 2020 2020 2020  ry_gcp',.       
+00012850: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00012860: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+00012870: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
+00012880: 6f6e 6520 7b7a 6f6e 657d 202d 6e20 7b6e  one {zone} -n {n
+00012890: 616d 657d 2022 6563 686f 2053 4b59 5049  ame} "echo SKYPI
+000128a0: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
+000128b0: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
+000128c0: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
+000128d0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+000128e0: 2020 2773 6c65 6570 2033 3630 272c 0a20    'sleep 360',. 
+000128f0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00012900: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00012910: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+00012920: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00012930: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
+00012940: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
+00012950: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
+00012960: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+00012970: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+00012980: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
+00012990: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
+000129a0: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
+000129b0: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
+000129c0: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
+000129d0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+000129e0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+000129f0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+00012a00: 2020 7465 726d 696e 6174 655f 636d 642c    terminate_cmd,
+00012a10: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00012a20: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+00012a30: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00012a40: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00012a50: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00012a60: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00012a70: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00012a80: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+00012a90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00012aa0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00012ab0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00012ac0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00012ad0: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00012ae0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00012af0: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+00012b00: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+00012b10: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+00012b20: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00012b30: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00012b40: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+00012b50: 5441 534b 5f49 443a 207c 2067 7265 7020  TASK_ID: | grep 
+00012b60: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
+00012b70: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00012b80: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00012b90: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00012ba0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00012bb0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+00012bc0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00012bd0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00012be0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00012bf0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00012c00: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00012c10: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
+00012c20: 655f 7265 636f 7665 7279 5f61 7773 2861  e_recovery_aws(a
+00012c30: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+00012c40: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
+00012c50: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
+00012c60: 7665 7279 2066 6f72 2061 2070 6970 656c  very for a pipel
+00012c70: 696e 652e 2222 220a 2020 2020 6e61 6d65  ine.""".    name
+00012c80: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00012c90: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
+00012ca0: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
+00012cb0: 6567 696f 6e0a 2020 2020 6966 2072 6567  egion.    if reg
+00012cc0: 696f 6e20 213d 2027 7573 2d77 6573 742d  ion != 'us-west-
+00012cd0: 3227 3a0a 2020 2020 2020 2020 7079 7465  2':.        pyte
+00012ce0: 7374 2e73 6b69 7028 274f 6e6c 7920 7275  st.skip('Only ru
+00012cf0: 6e20 7370 6f74 2070 6970 656c 696e 6520  n spot pipeline 
+00012d00: 7265 636f 7665 7279 2074 6573 7420 696e  recovery test in
+00012d10: 2075 732d 7765 7374 2d32 2729 0a20 2020   us-west-2').   
+00012d20: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00012d30: 2020 2020 2020 2773 706f 745f 7069 7065        'spot_pipe
+00012d40: 6c69 6e65 5f72 6563 6f76 6572 795f 6177  line_recovery_aw
+00012d50: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+00012d60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00012d70: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+00012d80: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00012d90: 5f79 616d 6c73 2f70 6970 656c 696e 655f  _yamls/pipeline_
+00012da0: 6177 732e 7961 6d6c 2020 2d79 202d 6427  aws.yaml  -y -d'
+00012db0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00012dc0: 6c65 6570 2034 3030 272c 0a20 2020 2020  leep 400',.     
+00012dd0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00012de0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00012df0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+00012e00: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
+00012e10: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+00012e20: 2020 2066 2752 554e 5f49 443d 2428 736b     f'RUN_ID=$(sk
+00012e30: 7920 7370 6f74 206c 6f67 7320 2d6e 207b  y spot logs -n {
+00012e40: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
+00012e50: 7720 7c20 6772 6570 2053 4b59 5049 4c4f  w | grep SKYPILO
+00012e60: 545f 5441 534b 5f49 443a 207c 2063 7574  T_TASK_ID: | cut
+00012e70: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
+00012e80: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
+00012e90: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00012ea0: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
+00012eb0: 2066 2752 554e 5f49 4453 3d24 2873 6b79   f'RUN_IDS=$(sky
+00012ec0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+00012ed0: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+00012ee0: 207c 2067 7265 7020 2d41 2034 2053 4b59   | grep -A 4 SKY
+00012ef0: 5049 4c4f 545f 5441 534b 5f49 4453 207c  PILOT_TASK_IDS |
+00012f00: 2063 7574 202d 6422 2922 202d 6632 293b   cut -d")" -f2);
+00012f10: 2065 6368 6f20 2224 5255 4e5f 4944 5322   echo "$RUN_IDS"
+00012f20: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
+00012f30: 657d 2d72 756e 2d69 6473 272c 0a20 2020  e}-run-ids',.   
+00012f40: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
+00012f50: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
+00012f60: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+00012f70: 2020 2020 2020 2023 2054 6865 2060 6361         # The `ca
+00012f80: 7420 2e2e 2e7c 2072 6576 6020 6973 2074  t ...| rev` is t
+00012f90: 6f20 7265 7472 6965 7665 2074 6865 206a  o retrieve the j
+00012fa0: 6f62 5f69 6420 6672 6f6d 2074 6865 0a20  ob_id from the. 
+00012fb0: 2020 2020 2020 2020 2020 2023 2053 4b59             # SKY
+00012fc0: 5049 4c4f 545f 5441 534b 5f49 442c 2077  PILOT_TASK_ID, w
+00012fd0: 6869 6368 2067 6574 7320 7468 6520 7365  hich gets the se
+00012fe0: 636f 6e64 2074 6f20 6c61 7374 2066 6965  cond to last fie
+00012ff0: 6c64 0a20 2020 2020 2020 2020 2020 2023  ld.            #
+00013000: 2073 6570 6172 6174 6564 2062 7920 602d   separated by `-
+00013010: 602e 0a20 2020 2020 2020 2020 2020 2028  `..            (
+00013020: 6627 5350 4f54 5f4a 4f42 5f49 443d 6063  f'SPOT_JOB_ID=`c
+00013030: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+00013040: 756e 2d69 6420 7c20 7265 7620 7c20 270a  un-id | rev | '.
+00013050: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
+00013060: 7420 2d64 5c27 2d5c 2720 2d66 3220 7c20  t -d\'-\' -f2 | 
+00013070: 7265 7660 3b27 0a20 2020 2020 2020 2020  rev`;'.         
+00013080: 2020 2020 6627 6177 7320 6563 3220 7465      f'aws ec2 te
+00013090: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
+000130a0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+000130b0: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
+000130c0: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
+000130d0: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
+000130e0: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+000130f0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00013100: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+00013110: 2020 272d 2d66 696c 7465 7273 204e 616d    '--filters Nam
+00013120: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00013130: 722d 6e61 6d65 2c56 616c 7565 733d 2a2d  r-name,Values=*-
+00013140: 247b 5350 4f54 5f4a 4f42 5f49 447d 2027  ${SPOT_JOB_ID} '
+00013150: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+00013160: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
+00013170: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+00013180: 5b5d 2e49 6e73 7461 6e63 6549 6420 270a  [].InstanceId '.
+00013190: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+000131a0: 6f75 7470 7574 2074 6578 7429 2729 2c0a  output text)'),.
+000131b0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+000131c0: 6570 2031 3030 272c 0a20 2020 2020 2020  ep 100',.       
+000131d0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+000131e0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+000131f0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00013200: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
+00013210: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
+00013220: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+00013230: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00013240: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00013250: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00013260: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013270: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+00013280: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+00013290: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
+000132a0: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
+000132b0: 6f20 2452 554e 5f49 443b 2073 6b79 2073  o $RUN_ID; sky s
+000132c0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+000132d0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+000132e0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+000132f0: 4153 4b5f 4944 3a20 7c20 6772 6570 2022  ASK_ID: | grep "
+00013300: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
+00013310: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
+00013320: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+00013330: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00013340: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
+00013350: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
+00013360: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
+00013370: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+00013380: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
+00013390: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+000133a0: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+000133b0: 2020 2066 2764 6966 6620 2f74 6d70 2f7b     f'diff /tmp/{
+000133c0: 6e61 6d65 7d2d 7275 6e2d 6964 7320 2f74  name}-run-ids /t
+000133d0: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+000133e0: 732d 6e65 7727 2c0a 2020 2020 2020 2020  s-new',.        
+000133f0: 2020 2020 6627 6361 7420 2f74 6d70 2f7b      f'cat /tmp/{
+00013400: 6e61 6d65 7d2d 7275 6e2d 6964 7320 7c20  name}-run-ids | 
+00013410: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
+00013420: 2060 6361 7420 2f74 6d70 2f7b 6e61 6d65   `cat /tmp/{name
+00013430: 7d2d 7275 6e2d 6964 6027 2c0a 2020 2020  }-run-id`',.    
+00013440: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00013450: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00013460: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00013470: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00013480: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+00013490: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000134a0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000134b0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+000134c0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+000134d0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+000134e0: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
+000134f0: 655f 7265 636f 7665 7279 5f67 6370 2829  e_recovery_gcp()
+00013500: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00013510: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+00013520: 6572 7920 666f 7220 6120 7069 7065 6c69  ery for a pipeli
+00013530: 6e65 2e22 2222 0a20 2020 206e 616d 6520  ne.""".    name 
+00013540: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00013550: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
+00013560: 2027 7573 2d65 6173 7434 2d62 270a 2020   'us-east4-b'.  
+00013570: 2020 7175 6572 795f 636d 6420 3d20 2827    query_cmd = ('
+00013580: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
+00013590: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
+000135a0: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
+000135b0: 2020 2020 2020 2020 2020 2722 286c 6162            '"(lab
+000135c0: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+000135d0: 6e61 6d65 3a2a 2d24 7b53 504f 545f 4a4f  name:*-${SPOT_JO
+000135e0: 425f 4944 7d29 2220 270a 2020 2020 2020  B_ID})" '.      
+000135f0: 2020 2020 2020 2020 2020 2066 272d 2d7a             f'--z
+00013600: 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d 666f  ones={zone} --fo
+00013610: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
+00013620: 2922 2729 0a20 2020 2074 6572 6d69 6e61  )"').    termina
+00013630: 7465 5f63 6d64 203d 2028 6627 6763 6c6f  te_cmd = (f'gclo
+00013640: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+00013650: 6e63 6573 2064 656c 6574 6520 2d2d 7a6f  nces delete --zo
+00013660: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
+00013670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013680: 6627 202d 2d71 7569 6574 2024 287b 7175  f' --quiet $({qu
+00013690: 6572 795f 636d 647d 2927 290a 2020 2020  ery_cmd})').    
+000136a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000136b0: 2020 2020 2027 7370 6f74 5f70 6970 656c       'spot_pipel
+000136c0: 696e 655f 7265 636f 7665 7279 5f67 6370  ine_recovery_gcp
+000136d0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000136e0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+000136f0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
+00013700: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+00013710: 7961 6d6c 732f 7069 7065 6c69 6e65 5f67  yamls/pipeline_g
+00013720: 6370 2e79 616d 6c20 202d 7920 2d64 272c  cp.yaml  -y -d',
+00013730: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00013740: 6565 7020 3430 3027 2c0a 2020 2020 2020  eep 400',.      
+00013750: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00013760: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00013770: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00013780: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+00013790: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+000137a0: 2020 6627 5255 4e5f 4944 3d24 2873 6b79    f'RUN_ID=$(sky
+000137b0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+000137c0: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+000137d0: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+000137e0: 5f54 4153 4b5f 4944 3a20 7c20 6375 7420  _TASK_ID: | cut 
+000137f0: 2d64 3a20 2d66 3229 3b20 6563 686f 2022  -d: -f2); echo "
+00013800: 2452 554e 5f49 4422 207c 2074 6565 202f  $RUN_ID" | tee /
+00013810: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00013820: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00013830: 6627 5255 4e5f 4944 533d 2428 736b 7920  f'RUN_IDS=$(sky 
+00013840: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00013850: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00013860: 7c20 6772 6570 202d 4120 3420 534b 5950  | grep -A 4 SKYP
+00013870: 494c 4f54 5f54 4153 4b5f 4944 5320 7c20  ILOT_TASK_IDS | 
+00013880: 6375 7420 2d64 2229 2220 2d66 3229 3b20  cut -d")" -f2); 
+00013890: 6563 686f 2022 2452 554e 5f49 4453 2220  echo "$RUN_IDS" 
+000138a0: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
+000138b0: 7d2d 7275 6e2d 6964 7327 2c0a 2020 2020  }-run-ids',.    
+000138c0: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
+000138d0: 6174 6520 7468 6520 636c 7573 7465 7220  ate the cluster 
+000138e0: 6d61 6e75 616c 6c79 2e0a 2020 2020 2020  manually..      
+000138f0: 2020 2020 2020 2320 5468 6520 6063 6174        # The `cat
+00013900: 202e 2e2e 7c20 7265 7660 2069 7320 746f   ...| rev` is to
+00013910: 2072 6574 7269 6576 6520 7468 6520 6a6f   retrieve the jo
+00013920: 625f 6964 2066 726f 6d20 7468 650a 2020  b_id from the.  
+00013930: 2020 2020 2020 2020 2020 2320 534b 5950            # SKYP
+00013940: 494c 4f54 5f54 4153 4b5f 4944 2c20 7768  ILOT_TASK_ID, wh
+00013950: 6963 6820 6765 7473 2074 6865 2073 6563  ich gets the sec
+00013960: 6f6e 6420 746f 206c 6173 7420 6669 656c  ond to last fiel
+00013970: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00013980: 7365 7061 7261 7465 6420 6279 2060 2d60  separated by `-`
+00013990: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
+000139a0: 2753 504f 545f 4a4f 425f 4944 3d60 6361  'SPOT_JOB_ID=`ca
+000139b0: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+000139c0: 6e2d 6964 207c 2072 6576 207c 2027 0a20  n-id | rev | '. 
+000139d0: 2020 2020 2020 2020 2020 2020 6627 6375              f'cu
+000139e0: 7420 2d64 5c27 2d5c 2720 2d66 3220 7c20  t -d\'-\' -f2 | 
+000139f0: 7265 7660 3b7b 7465 726d 696e 6174 655f  rev`;{terminate_
+00013a00: 636d 647d 2729 2c0a 2020 2020 2020 2020  cmd}'),.        
+00013a10: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
+00013a20: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00013a30: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00013a40: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00013a50: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013a60: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00013a70: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00013a80: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+00013a90: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00013aa0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00013ab0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00013ac0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00013ad0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00013ae0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+00013af0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00013b00: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+00013b10: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+00013b20: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00013b30: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00013b40: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
+00013b50: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
+00013b60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013b70: 2752 554e 5f49 4453 3d24 2873 6b79 2073  'RUN_IDS=$(sky s
+00013b80: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00013b90: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00013ba0: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
+00013bb0: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
+00013bc0: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
+00013bd0: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
+00013be0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00013bf0: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+00013c00: 2020 2020 2020 2020 2020 2066 2764 6966             f'dif
+00013c10: 6620 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  f /tmp/{name}-ru
+00013c20: 6e2d 6964 7320 2f74 6d70 2f7b 6e61 6d65  n-ids /tmp/{name
+00013c30: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
+00013c40: 2020 2020 2020 2020 2020 2020 6627 6361              f'ca
+00013c50: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+00013c60: 6e2d 6964 7320 7c20 7365 6420 2d6e 2032  n-ids | sed -n 2
+00013c70: 7020 7c20 6772 6570 2060 6361 7420 2f74  p | grep `cat /t
+00013c80: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00013c90: 6027 2c0a 2020 2020 2020 2020 5d2c 0a20  `',.        ],. 
+00013ca0: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
+00013cb0: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+00013cc0: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
+00013cd0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00013ce0: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
+00013cf0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00013d00: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00013d10: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00013d20: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00013d30: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+00013d40: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00013d50: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00013d60: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+00013d70: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00013d80: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00013d90: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00013da0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+00013db0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00013dc0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00013dd0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00013de0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00013df0: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
+00013e00: 795f 6465 6661 756c 745f 7265 736f 7572  y_default_resour
+00013e10: 6365 7328 6765 6e65 7269 635f 636c 6f75  ces(generic_clou
+00013e20: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00013e30: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00013e40: 7420 7265 636f 7665 7279 2066 6f72 2064  t recovery for d
+00013e50: 6566 6175 6c74 2072 6573 6f75 7263 6573  efault resources
+00013e60: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+00013e70: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00013e80: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00013e90: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+00013ea0: 6e61 6765 642d 7370 6f74 2d72 6563 6f76  naged-spot-recov
+00013eb0: 6572 792d 6465 6661 756c 742d 7265 736f  ery-default-reso
+00013ec0: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
+00013ed0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00013ee0: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+00013ef0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+00013f00: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00013f10: 7d20 2273 6c65 6570 2033 3020 2626 2073  } "sleep 30 && s
+00013f20: 7564 6f20 7368 7574 646f 776e 206e 6f77  udo shutdown now
+00013f30: 2026 2620 736c 6565 7020 3130 3030 2220   && sleep 1000" 
+00013f40: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+00013f50: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
+00013f60: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00013f70: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00013f80: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00013f90: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013fa0: 2022 5255 4e4e 494e 475c 7c52 4543 4f56   "RUNNING\|RECOV
+00013fb0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00013fc0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+00013fd0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00013fe0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+00013ff0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00014000: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
+00014010: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00014020: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00014030: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
+00014040: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+00014050: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+00014060: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
+00014070: 756c 7469 5f6e 6f64 655f 6177 7328 6177  ulti_node_aws(aw
+00014080: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+00014090: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+000140a0: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+000140b0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+000140c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000140d0: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
+000140e0: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
+000140f0: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
+00014100: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00014110: 7370 6f74 5f72 6563 6f76 6572 795f 6d75  spot_recovery_mu
+00014120: 6c74 695f 6e6f 6465 5f61 7773 272c 0a20  lti_node_aws',. 
+00014130: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00014140: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00014150: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
+00014160: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+00014170: 696f 6e7d 202d 6e20 7b6e 616d 657d 202d  ion} -n {name} -
+00014180: 2d6e 756d 2d6e 6f64 6573 2032 2022 6563  -num-nodes 2 "ec
+00014190: 686f 2053 4b59 5049 4c4f 545f 5441 534b  ho SKYPILOT_TASK
+000141a0: 5f49 443a 205c 2453 4b59 5049 4c4f 545f  _ID: \$SKYPILOT_
+000141b0: 5441 534b 5f49 443b 2073 6c65 6570 2031  TASK_ID; sleep 1
+000141c0: 3830 3022 2020 2d79 202d 6427 2c0a 2020  800"  -y -d',.  
+000141d0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+000141e0: 2034 3530 272c 0a20 2020 2020 2020 2020   450',.         
+000141f0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00014200: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00014210: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+00014220: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+00014230: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014240: 2752 554e 5f49 443d 2428 736b 7920 7370  'RUN_ID=$(sky sp
+00014250: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
+00014260: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+00014270: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+00014280: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
+00014290: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+000142a0: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+000142b0: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+000142c0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+000142d0: 726d 696e 6174 6520 7468 6520 776f 726b  rminate the work
+000142e0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+000142f0: 2020 2020 2020 2020 2028 6627 6177 7320           (f'aws 
+00014300: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
+00014310: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+00014320: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
+00014330: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
+00014340: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
+00014350: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
+00014360: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+00014370: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+00014380: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
+00014390: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+000143a0: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+000143b0: 6c75 6573 3d7b 6e61 6d65 7d2a 2027 0a20  lues={name}* '. 
+000143c0: 2020 2020 2020 2020 2020 2020 274e 616d              'Nam
+000143d0: 653d 7461 673a 7261 792d 6e6f 6465 2d74  e=tag:ray-node-t
+000143e0: 7970 652c 5661 6c75 6573 3d77 6f72 6b65  ype,Values=worke
+000143f0: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
+00014400: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+00014410: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+00014420: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
+00014430: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00014440: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
+00014450: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
+00014460: 736c 6565 7020 3530 272c 0a20 2020 2020  sleep 50',.     
+00014470: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00014480: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00014490: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+000144a0: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
+000144b0: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
+000144c0: 2020 2020 2020 2773 6c65 6570 2035 3630        'sleep 560
+000144d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000144e0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000144f0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00014500: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00014510: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
+00014520: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
+00014530: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
+00014540: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
+00014550: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
+00014560: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+00014570: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+00014580: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+00014590: 5f54 4153 4b5f 4944 207c 2063 7574 202d  _TASK_ID | cut -
+000145a0: 643a 202d 6632 207c 2067 7265 7020 2224  d: -f2 | grep "$
+000145b0: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
+000145c0: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
+000145d0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+000145e0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+000145f0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00014600: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
+00014610: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00014620: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00014630: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+00014640: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+00014650: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
+00014660: 745f 7370 6f74 5f72 6563 6f76 6572 795f  t_spot_recovery_
+00014670: 6d75 6c74 695f 6e6f 6465 5f67 6370 2829  multi_node_gcp()
+00014680: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00014690: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+000146a0: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+000146b0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000146c0: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+000146d0: 3d20 2775 732d 7765 7374 322d 6127 0a20  = 'us-west2-a'. 
+000146e0: 2020 2023 2055 7365 2027 3a27 2074 6f20     # Use ':' to 
+000146f0: 6d61 7463 6820 6173 2074 6865 2063 6c75  match as the clu
+00014700: 7374 6572 206e 616d 6520 7769 6c6c 2063  ster name will c
+00014710: 6f6e 7461 696e 2074 6865 2073 7566 6669  ontain the suffi
+00014720: 7820 7769 7468 206a 6f62 2069 640a 2020  x with job id.  
+00014730: 2020 7175 6572 795f 636d 6420 3d20 280a    query_cmd = (.
+00014740: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
+00014750: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+00014760: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+00014770: 3d27 0a20 2020 2020 2020 2066 2722 286c  ='.        f'"(l
+00014780: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
+00014790: 722d 6e61 6d65 3a7b 6e61 6d65 7d20 414e  r-name:{name} AN
+000147a0: 4420 6c61 6265 6c73 2e72 6179 2d6e 6f64  D labels.ray-nod
+000147b0: 652d 7479 7065 3d77 6f72 6b65 7229 2220  e-type=worker)" 
+000147c0: 270a 2020 2020 2020 2020 6627 2d2d 7a6f  '.        f'--zo
+000147d0: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+000147e0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+000147f0: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
+00014800: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
+00014810: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00014820: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
+00014830: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
+00014840: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00014850: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
+00014860: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
+00014870: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00014880: 2020 2020 2773 706f 745f 7265 636f 7665      'spot_recove
+00014890: 7279 5f6d 756c 7469 5f6e 6f64 655f 6763  ry_multi_node_gc
+000148a0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+000148b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000148c0: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
+000148d0: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
+000148e0: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d20  zone} -n {name} 
+000148f0: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
+00014900: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
+00014910: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
+00014920: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
+00014930: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
+00014940: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00014950: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
+00014960: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00014970: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00014980: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+00014990: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+000149a0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000149b0: 6627 5255 4e5f 4944 3d24 2873 6b79 2073  f'RUN_ID=$(sky s
+000149c0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+000149d0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+000149e0: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+000149f0: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
+00014a00: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+00014a10: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
+00014a20: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
+00014a30: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00014a40: 6572 6d69 6e61 7465 2074 6865 2077 6f72  erminate the wor
+00014a50: 6b65 7220 6d61 6e75 616c 6c79 2e0a 2020  ker manually..  
+00014a60: 2020 2020 2020 2020 2020 7465 726d 696e            termin
+00014a70: 6174 655f 636d 642c 0a20 2020 2020 2020  ate_cmd,.       
+00014a80: 2020 2020 2027 736c 6565 7020 3530 272c       'sleep 50',
+00014a90: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00014aa0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00014ab0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00014ac0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00014ad0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00014ae0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00014af0: 6570 2034 3230 272c 0a20 2020 2020 2020  ep 420',.       
+00014b00: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00014b10: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00014b20: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00014b30: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00014b40: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00014b50: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+00014b60: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00014b70: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+00014b80: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+00014b90: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00014ba0: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00014bb0: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+00014bc0: 2063 7574 202d 643a 202d 6632 207c 2067   cut -d: -f2 | g
+00014bd0: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
+00014be0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00014bf0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00014c00: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00014c10: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00014c20: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+00014c30: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00014c40: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00014c50: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00014c60: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+00014c70: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+00014c80: 6566 2074 6573 745f 7370 6f74 5f63 616e  ef test_spot_can
+00014c90: 6365 6c6c 6174 696f 6e5f 6177 7328 6177  cellation_aws(aw
+00014ca0: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+00014cb0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00014cc0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00014cd0: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
+00014ce0: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
+00014cf0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00014d00: 0a20 2020 2020 2020 2027 7370 6f74 5f63  .        'spot_c
+00014d10: 616e 6365 6c6c 6174 696f 6e5f 6177 7327  ancellation_aws'
+00014d20: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00014d30: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
+00014d40: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
+00014d50: 6e67 2073 706f 7420 636c 7573 7465 7220  ng spot cluster 
+00014d60: 6265 696e 6720 6c61 756e 6368 6564 2e0a  being launched..
+00014d70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014d80: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+00014d90: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00014da0: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+00014db0: 6e61 6d65 7d20 2273 6c65 6570 2031 3030  name} "sleep 100
+00014dc0: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
+00014dd0: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
+00014de0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00014df0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00014e00: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00014e10: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00014e20: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
+00014e30: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
+00014e40: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00014e50: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+00014e60: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
+00014e70: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+00014e80: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00014e90: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00014ea0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00014eb0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+00014ec0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+00014ed0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00014ee0: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+00014ef0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00014f00: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00014f10: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014f20: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00014f30: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
+00014f40: 2020 2020 2020 2020 2020 2866 2773 3d24            (f's=$
+00014f50: 2861 7773 2065 6332 2064 6573 6372 6962  (aws ec2 describ
+00014f60: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
+00014f70: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+00014f80: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00014f90: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
+00014fa0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
+00014fb0: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
+00014fc0: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
+00014fd0: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
+00014fe0: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
+00014ff0: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
+00015000: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
+00015010: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+00015020: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
+00015030: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
+00015040: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
+00015050: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
+00015060: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
+00015070: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
+00015080: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
+00015090: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+000150a0: 2320 5465 7374 2063 616e 6365 6c6c 696e  # Test cancellin
+000150b0: 6720 7468 6520 7370 6f74 2063 6c75 7374  g the spot clust
+000150c0: 6572 2064 7572 696e 6720 7370 6f74 206a  er during spot j
+000150d0: 6f62 2062 6569 6e67 2073 6574 7570 2e0a  ob being setup..
+000150e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000150f0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+00015100: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00015110: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+00015120: 6e61 6d65 7d2d 3220 7465 7374 732f 7465  name}-2 tests/te
+00015130: 7374 5f79 616d 6c73 2f74 6573 745f 6c6f  st_yamls/test_lo
+00015140: 6e67 5f73 6574 7570 2e79 616d 6c20 202d  ng_setup.yaml  -
+00015150: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+00015160: 2020 2027 736c 6565 7020 3330 3027 2c0a     'sleep 300',.
+00015170: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+00015180: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00015190: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+000151a0: 7b6e 616d 657d 2d32 2729 2c0a 2020 2020  {name}-2'),.    
+000151b0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+000151c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000151d0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000151e0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+000151f0: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
+00015200: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+00015210: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+00015220: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015230: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+00015240: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00015250: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00015260: 6e61 6d65 7d2d 3220 7c20 6865 6164 202d  name}-2 | head -
+00015270: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+00015280: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00015290: 2020 2020 2866 2773 3d24 2861 7773 2065      (f's=$(aws e
+000152a0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+000152b0: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+000152c0: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+000152d0: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+000152e0: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
+000152f0: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+00015300: 7565 733d 7b6e 616d 657d 2d32 2d2a 2027  ues={name}-2-* '
+00015310: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+00015320: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
+00015330: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+00015340: 5b5d 2e53 7461 7465 5b5d 2e4e 616d 6520  [].State[].Name 
+00015350: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+00015360: 2d2d 6f75 7470 7574 2074 6578 7429 2026  --output text) &
+00015370: 2620 6563 686f 2022 2473 2220 2626 2065  & echo "$s" && e
+00015380: 6368 6f3b 205b 5b20 2d7a 2022 2473 2220  cho; [[ -z "$s" 
+00015390: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+000153a0: 2274 6572 6d69 6e61 7465 6422 205d 5d20  "terminated" ]] 
+000153b0: 7c7c 205b 5b20 2224 7322 203d 2022 7368  || [[ "$s" = "sh
+000153c0: 7574 7469 6e67 2d64 6f77 6e22 205d 5d27  utting-down" ]]'
+000153d0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+000153e0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+000153f0: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+00015400: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
+00015410: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
+00015420: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00015430: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+00015440: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+00015450: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+00015460: 616d 657d 2d33 2022 736c 6565 7020 3130  ame}-3 "sleep 10
+00015470: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+00015480: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00015490: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
+000154a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+000154b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000154c0: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
+000154d0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+000154e0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000154f0: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
+00015500: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
+00015510: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
+00015520: 2761 7773 2065 6332 2074 6572 6d69 6e61  'aws ec2 termina
+00015530: 7465 2d69 6e73 7461 6e63 6573 202d 2d72  te-instances --r
+00015540: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+00015550: 2d69 6e73 7461 6e63 652d 6964 7320 2428  -instance-ids $(
+00015560: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+00015570: 2761 7773 2065 6332 2064 6573 6372 6962  'aws ec2 describ
+00015580: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
+00015590: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+000155a0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+000155b0: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
+000155c0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
+000155d0: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
+000155e0: 2d33 2d2a 2027 0a20 2020 2020 2020 2020  -3-* '.         
+000155f0: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00015600: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00015610: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+00015620: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+00015630: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+00015640: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
+00015650: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
+00015660: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00015670: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00015680: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+00015690: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+000156a0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+000156b0: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+000156c0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+000156d0: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+000156e0: 7b6e 616d 657d 2d33 2729 2c0a 2020 2020  {name}-3'),.    
+000156f0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+00015700: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00015710: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00015720: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00015730: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+00015740: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+00015750: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+00015760: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015770: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+00015780: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00015790: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+000157a0: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+000157b0: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+000157c0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+000157d0: 2020 2020 2320 5468 6520 636c 7573 7465      # The cluste
+000157e0: 7220 7368 6f75 6c64 2062 6520 7465 726d  r should be term
+000157f0: 696e 6174 6564 2028 7368 7574 7469 6e67  inated (shutting
+00015800: 2d64 6f77 6e29 2061 6674 6572 2063 616e  -down) after can
+00015810: 6365 6c6c 6174 696f 6e2e 2057 6520 646f  cellation. We do
+00015820: 6e27 7420 7573 6520 7468 6520 603d 6020  n't use the `=` 
+00015830: 6f70 6572 6174 6f72 2068 6572 6520 6265  operator here be
+00015840: 6361 7573 650a 2020 2020 2020 2020 2020  cause.          
+00015850: 2020 2320 7468 6572 6520 6361 6e20 6265    # there can be
+00015860: 206d 756c 7469 706c 6520 564d 2077 6974   multiple VM wit
+00015870: 6820 7468 6520 7361 6d65 206e 616d 6520  h the same name 
+00015880: 6475 6520 746f 2074 6865 2072 6563 6f76  due to the recov
+00015890: 6572 792e 0a20 2020 2020 2020 2020 2020  ery..           
+000158a0: 2028 6627 733d 2428 6177 7320 6563 3220   (f's=$(aws ec2 
+000158b0: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+000158c0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+000158d0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+000158e0: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
+000158f0: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
+00015900: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+00015910: 3d7b 6e61 6d65 7d2d 332d 2a20 270a 2020  ={name}-3-* '.  
+00015920: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
+00015930: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
+00015940: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
+00015950: 5374 6174 655b 5d2e 4e61 6d65 2027 0a20  State[].Name '. 
+00015960: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
+00015970: 7574 7075 7420 7465 7874 2920 2626 2065  utput text) && e
+00015980: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
+00015990: 3b20 5b5b 202d 7a20 2224 7322 205d 5d20  ; [[ -z "$s" ]] 
+000159a0: 7c7c 2065 6368 6f20 2224 7322 207c 2067  || echo "$s" | g
+000159b0: 7265 7020 2d76 202d 4520 2270 656e 6469  rep -v -E "pendi
+000159c0: 6e67 7c72 756e 6e69 6e67 7c73 746f 7070  ng|running|stopp
+000159d0: 6564 7c73 746f 7070 696e 6722 270a 2020  ed|stopping"'.  
+000159e0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+000159f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00015a00: 7469 6d65 6f75 743d 3235 202a 2036 3029  timeout=25 * 60)
+00015a10: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00015a20: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00015a30: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
+00015a40: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00015a50: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00015a60: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
+00015a70: 6763 7028 293a 0a20 2020 206e 616d 6520  gcp():.    name 
+00015a80: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00015a90: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
+00015aa0: 2027 7573 2d77 6573 7433 2d62 270a 2020   'us-west3-b'.  
+00015ab0: 2020 7175 6572 795f 7374 6174 655f 636d    query_state_cm
+00015ac0: 6420 3d20 2827 6763 6c6f 7564 2063 6f6d  d = ('gcloud com
+00015ad0: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+00015ae0: 6973 7420 270a 2020 2020 2020 2020 2020  ist '.          
+00015af0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00015b00: 2d66 696c 7465 723d 2228 6c61 6265 6c73  -filter="(labels
+00015b10: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+00015b20: 653a 7b6e 616d 657d 2922 2027 0a20 2020  e:{name})" '.   
+00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b40: 2020 2020 272d 2d66 6f72 6d61 743d 2276      '--format="v
+00015b50: 616c 7565 2873 7461 7475 7329 2227 290a  alue(status)"').
+00015b60: 2020 2020 7175 6572 795f 636d 6420 3d20      query_cmd = 
+00015b70: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
+00015b80: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+00015b90: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
+00015ba0: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
+00015bb0: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
+00015bc0: 7465 722d 6e61 6d65 3a7b 6e61 6d65 7d29  ter-name:{name})
+00015bd0: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+00015be0: 2020 2020 2066 272d 2d7a 6f6e 6573 3d7b       f'--zones={
+00015bf0: 7a6f 6e65 7d20 2d2d 666f 726d 6174 3d22  zone} --format="
+00015c00: 7661 6c75 6528 6e61 6d65 2922 2729 0a20  value(name)"'). 
+00015c10: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+00015c20: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+00015c30: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
+00015c40: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
+00015c50: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
+00015c60: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
+00015c70: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
+00015c80: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
+00015c90: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00015ca0: 7370 6f74 5f63 616e 6365 6c6c 6174 696f  spot_cancellatio
+00015cb0: 6e5f 6763 7027 2c0a 2020 2020 2020 2020  n_gcp',.        
+00015cc0: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
+00015cd0: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
+00015ce0: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
+00015cf0: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
+00015d00: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
+00015d10: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+00015d20: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
+00015d30: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
+00015d40: 207b 6e61 6d65 7d20 2273 6c65 6570 2031   {name} "sleep 1
+00015d50: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
+00015d60: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00015d70: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+00015d80: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00015d90: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00015da0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00015db0: 2067 7265 7020 2253 5441 5254 494e 4722   grep "STARTING"
+00015dc0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00015dd0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00015de0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00015df0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00015e00: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+00015e10: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00015e20: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00015e30: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+00015e40: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00015e50: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+00015e60: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00015e70: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+00015e80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00015e90: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00015ea0: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00015eb0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00015ec0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00015ed0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+00015ee0: 7374 2063 616e 6365 6c6c 696e 6720 7468  st cancelling th
+00015ef0: 6520 7370 6f74 2063 6c75 7374 6572 2064  e spot cluster d
+00015f00: 7572 696e 6720 7370 6f74 206a 6f62 2062  uring spot job b
+00015f10: 6569 6e67 2073 6574 7570 2e0a 2020 2020  eing setup..    
+00015f20: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+00015f30: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
+00015f40: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
+00015f50: 6e65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  ne} -n {name}-2 
+00015f60: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00015f70: 2f74 6573 745f 6c6f 6e67 5f73 6574 7570  /test_long_setup
+00015f80: 2e79 616d 6c20 202d 7920 2d64 272c 0a20  .yaml  -y -d',. 
+00015f90: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015fa0: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
+00015fb0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+00015fc0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00015fd0: 5f6e 616d 653d 6627 7b6e 616d 657d 2d32  _name=f'{name}-2
+00015fe0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00015ff0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00016000: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00016010: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00016020: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+00016030: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+00016040: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+00016050: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00016060: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+00016070: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00016080: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00016090: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+000160a0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+000160b0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+000160c0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+000160d0: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+000160e0: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
+000160f0: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
+00016100: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00016110: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+00016120: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+00016130: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
+00016140: 2d33 2022 736c 6565 7020 3130 3030 2220  -3 "sleep 1000" 
+00016150: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00016160: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
+00016170: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00016180: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00016190: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+000161a0: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
+000161b0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+000161c0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+000161d0: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
+000161e0: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
+000161f0: 2020 2020 2020 2020 2020 7465 726d 696e            termin
+00016200: 6174 655f 636d 642c 0a20 2020 2020 2020  ate_cmd,.       
+00016210: 2020 2020 2027 736c 6565 7020 3130 3027       'sleep 100'
+00016220: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00016230: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00016240: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+00016250: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
+00016260: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
+00016270: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00016280: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00016290: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+000162a0: 3d66 277b 6e61 6d65 7d2d 3327 292c 0a20  =f'{name}-3'),. 
+000162b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000162c0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+000162d0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+000162e0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+000162f0: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
+00016300: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+00016310: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
+00016320: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00016330: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
+00016340: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00016350: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00016360: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+00016370: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+00016380: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00016390: 2020 2020 2020 2023 2054 6865 2063 6c75         # The clu
+000163a0: 7374 6572 2073 686f 756c 6420 6265 2074  ster should be t
+000163b0: 6572 6d69 6e61 7465 6420 2853 544f 5050  erminated (STOPP
+000163c0: 494e 4729 2061 6674 6572 2063 616e 6365  ING) after cance
+000163d0: 6c6c 6174 696f 6e2e 2057 6520 646f 6e27  llation. We don'
+000163e0: 7420 7573 6520 7468 6520 603d 6020 6f70  t use the `=` op
+000163f0: 6572 6174 6f72 2068 6572 6520 6265 6361  erator here beca
+00016400: 7573 650a 2020 2020 2020 2020 2020 2020  use.            
+00016410: 2320 7468 6572 6520 6361 6e20 6265 206d  # there can be m
+00016420: 756c 7469 706c 6520 564d 2077 6974 6820  ultiple VM with 
+00016430: 7468 6520 7361 6d65 206e 616d 6520 6475  the same name du
+00016440: 6520 746f 2074 6865 2072 6563 6f76 6572  e to the recover
+00016450: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
+00016460: 6627 733d 2428 7b71 7565 7279 5f73 7461  f's=$({query_sta
+00016470: 7465 5f63 6d64 7d29 2026 2620 6563 686f  te_cmd}) && echo
+00016480: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
+00016490: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
+000164a0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+000164b0: 202d 7620 2d45 2022 5052 4f56 4953 494f   -v -E "PROVISIO
+000164c0: 4e49 4e47 7c53 5441 4749 4e47 7c52 554e  NING|STAGING|RUN
+000164d0: 4e49 4e47 7c52 4550 4149 5249 4e47 7c54  NING|REPAIRING|T
+000164e0: 4552 4d49 4e41 5445 447c 5355 5350 454e  ERMINATED|SUSPEN
+000164f0: 4449 4e47 7c53 5553 5045 4e44 4544 7c53  DING|SUSPENDED|S
+00016500: 5553 5045 4e44 4544 2227 0a20 2020 2020  USPENDED"'.     
+00016510: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+00016520: 2020 5d2c 0a20 2020 2020 2020 2074 696d    ],.        tim
+00016530: 656f 7574 3d32 3520 2a20 3630 290a 2020  eout=25 * 60).  
+00016540: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00016550: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00016560: 2d2d 2d20 5465 7374 696e 6720 7374 6f72  --- Testing stor
+00016570: 6167 6520 666f 7220 6d61 6e61 6765 6420  age for managed 
+00016580: 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a  spot ----------.
+00016590: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000165a0: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+000165b0: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
+000165c0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+000165d0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+000165e0: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+000165f0: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
+00016600: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00016610: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00016620: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+00016630: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+00016640: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+00016650: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+00016660: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+00016670: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+00016680: 5f73 746f 7261 6765 2867 656e 6572 6963  _storage(generic
+00016690: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+000166a0: 2020 2222 2254 6573 7420 7374 6f72 6167    """Test storag
+000166b0: 6520 7769 7468 206d 616e 6167 6564 2073  e with managed s
+000166c0: 706f 7422 2222 0a20 2020 206e 616d 6520  pot""".    name 
+000166d0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000166e0: 616d 6528 290a 2020 2020 7961 6d6c 5f73  ame().    yaml_s
+000166f0: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+00016700: 6828 0a20 2020 2020 2020 2027 6578 616d  h(.        'exam
+00016710: 706c 6573 2f6d 616e 6167 6564 5f73 706f  ples/managed_spo
+00016720: 745f 7769 7468 5f73 746f 7261 6765 2e79  t_with_storage.y
+00016730: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
+00016740: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
+00016750: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
+00016760: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
+00016770: 297d 270a 2020 2020 7961 6d6c 5f73 7472  )}'.    yaml_str
+00016780: 203d 2079 616d 6c5f 7374 722e 7265 706c   = yaml_str.repl
+00016790: 6163 6528 2773 6b79 2d77 6f72 6b64 6972  ace('sky-workdir
+000167a0: 2d7a 6877 7527 2c20 7374 6f72 6167 655f  -zhwu', storage_
+000167b0: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
+000167c0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+000167d0: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+000167e0: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+000167f0: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+00016800: 2020 2066 2e77 7269 7465 2879 616d 6c5f     f.write(yaml_
+00016810: 7374 7229 0a20 2020 2020 2020 2066 2e66  str).        f.f
+00016820: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+00016830: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+00016840: 650a 2020 2020 2020 2020 7465 7374 203d  e.        test =
+00016850: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+00016860: 2020 2027 7370 6f74 5f73 746f 7261 6765     'spot_storage
+00016870: 272c 0a20 2020 2020 2020 2020 2020 205b  ',.            [
+00016880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016890: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+000168a0: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+000168b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000168c0: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+000168d0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+000168e0: 656e 6572 6963 5f63 6c6f 7564 7d20 7b66  eneric_cloud} {f
+000168f0: 696c 655f 7061 7468 7d20 2d79 272c 0a20  ile_path} -y',. 
+00016900: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00016910: 736c 6565 7020 3630 272c 2020 2320 5761  sleep 60',  # Wa
+00016920: 6974 2074 6865 2073 706f 7420 7175 6575  it the spot queu
+00016930: 6520 746f 2062 6520 7570 6461 7465 640a  e to be updated.
+00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016950: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00016960: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00016970: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+00016980: 4544 272c 0a20 2020 2020 2020 2020 2020  ED',.           
+00016990: 2020 2020 2066 275b 2024 2861 7773 2073       f'[ $(aws s
+000169a0: 3361 7069 206c 6973 742d 6275 636b 6574  3api list-bucket
+000169b0: 7320 2d2d 7175 6572 7920 2242 7563 6b65  s --query "Bucke
+000169c0: 7473 5b3f 636f 6e74 6169 6e73 284e 616d  ts[?contains(Nam
+000169d0: 652c 205c 277b 7374 6f72 6167 655f 6e61  e, \'{storage_na
+000169e0: 6d65 7d5c 2729 5d2e 4e61 6d65 2220 2d2d  me}\')].Name" --
+000169f0: 6f75 7470 7574 2074 6578 7420 7c20 7763  output text | wc
+00016a00: 202d 6c29 202d 6571 2030 205d 270a 2020   -l) -eq 0 ]'.  
+00016a10: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00016a20: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+00016a30: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+00016a40: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+00016a50: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00016a60: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
+00016a70: 2073 696e 6365 2073 6b79 2073 706f 7420   since sky spot 
+00016a80: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
+00016a90: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
+00016aa0: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
+00016ab0: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+00016ac0: 3d32 3020 2a20 3630 2c0a 2020 2020 2020  =20 * 60,.      
+00016ad0: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
+00016ae0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00016af0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00016b00: 7374 696e 6720 7370 6f74 2054 5055 202d  sting spot TPU -
+00016b10: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+00016b20: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
+00016b30: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00016b40: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00016b50: 6f74 5f74 7075 2829 3a0a 2020 2020 2222  ot_tpu():.    ""
+00016b60: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
+00016b70: 6f74 206f 6e20 5450 552e 2222 220a 2020  ot on TPU.""".  
+00016b80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00016b90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00016ba0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00016bb0: 2020 2020 2020 2774 6573 742d 7370 6f74        'test-spot
+00016bc0: 2d74 7075 272c 0a20 2020 2020 2020 205b  -tpu',.        [
+00016bd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016be0: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
+00016bf0: 6e20 7b6e 616d 657d 2065 7861 6d70 6c65  n {name} example
+00016c00: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
+00016c10: 742e 7961 6d6c 202d 7920 2d64 272c 0a20  t.yaml -y -d',. 
+00016c20: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00016c30: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00016c40: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00016c50: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00016c60: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00016c70: 2067 7265 7020 5354 4152 5449 4e47 272c   grep STARTING',
+00016c80: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00016c90: 6565 7020 3834 3027 2c20 2023 2054 5055  eep 840',  # TPU
+00016ca0: 2074 616b 6573 2061 2077 6869 6c65 2074   takes a while t
+00016cb0: 6f20 6c61 756e 6368 0a20 2020 2020 2020  o launch.       
+00016cc0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00016cd0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00016ce0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00016cf0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00016d00: 475c 7c53 5543 4345 4544 4544 2227 2c0a  G\|SUCCEEDED"',.
+00016d10: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00016d20: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00016d30: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00016d40: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00016d50: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
+00016d60: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
+00016d70: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
+00016d80: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
+00016d90: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
+00016da0: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
+00016db0: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00016dc0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00016dd0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00016de0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00016df0: 656e 7620 666f 7220 7370 6f74 202d 2d2d  env for spot ---
+00016e00: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00016e10: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00016e20: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00016e30: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+00016e40: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00016e50: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00016e60: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+00016e70: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00016e80: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00016e90: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00016ea0: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+00016eb0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00016ec0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00016ed0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00016ee0: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00016ef0: 6573 745f 7370 6f74 5f69 6e6c 696e 655f  est_spot_inline_
+00016f00: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
+00016f10: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00016f20: 5465 7374 2073 706f 7420 656e 7622 2222  Test spot env"""
+00016f30: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00016f40: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00016f50: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00016f60: 0a20 2020 2020 2020 2027 7465 7374 2d73  .        'test-s
+00016f70: 706f 742d 696e 6c69 6e65 2d65 6e76 272c  pot-inline-env',
+00016f80: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00016f90: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+00016fa0: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+00016fb0: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
+00016fc0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+00016fd0: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
+00016fe0: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
+00016ff0: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
+00017000: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
+00017010: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+00017020: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
+00017030: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+00017040: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+00017050: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
+00017060: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+00017070: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+00017080: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017090: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000170a0: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
+000170b0: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+000170c0: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
+000170d0: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+000170e0: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+000170f0: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+00017100: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+00017110: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00017120: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+00017130: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+00017140: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+00017150: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+00017160: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+00017170: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00017180: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00017190: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+000171a0: 7469 6e67 2065 6e76 202d 2d2d 2d2d 2d2d  ting env -------
+000171b0: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
+000171c0: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
+000171d0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+000171e0: 2022 2222 5465 7374 2065 6e76 2222 220a   """Test env""".
+000171f0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00017200: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00017210: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00017220: 2020 2020 2020 2020 2774 6573 742d 696e          'test-in
+00017230: 6c69 6e65 2d65 6e76 272c 0a20 2020 2020  line-env',.     
+00017240: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00017250: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+00017260: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
+00017270: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00017280: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
+00017290: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
+000172a0: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
+000172b0: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
+000172c0: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+000172d0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
+000172e0: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
+000172f0: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+00017300: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
+00017310: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
+00017320: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017330: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00017340: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00017350: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00017360: 6320 7b6e 616d 657d 202d 2d65 6e76 2054  c {name} --env T
+00017370: 4553 545f 454e 5632 3d22 7375 6363 6573  EST_ENV2="succes
+00017380: 7322 2022 285b 5b20 2120 2d7a 205c 5c22  s" "([[ ! -z \\"
+00017390: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
+000173a0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+000173b0: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+000173c0: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+000173d0: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+000173e0: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+000173f0: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+00017400: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00017410: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00017420: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00017430: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00017440: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00017450: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00017460: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00017470: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+00017480: 2d20 5465 7374 696e 6720 656e 7620 6669  - Testing env fi
+00017490: 6c65 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465  le ----------.de
+000174a0: 6620 7465 7374 5f69 6e6c 696e 655f 656e  f test_inline_en
+000174b0: 765f 6669 6c65 2867 656e 6572 6963 5f63  v_file(generic_c
+000174c0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000174d0: 2222 2254 6573 7420 656e 7622 2222 0a20  """Test env""". 
+000174e0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+000174f0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00017500: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00017510: 2020 2020 2020 2027 7465 7374 2d69 6e6c         'test-inl
+00017520: 696e 652d 656e 762d 6669 6c65 272c 0a20  ine-env-file',. 
+00017530: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00017540: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00017550: 6820 2d63 207b 6e61 6d65 7d20 2d79 202d  h -c {name} -y -
+00017560: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00017570: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
+00017580: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
+00017590: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
+000175a0: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
+000175b0: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
+000175c0: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
+000175d0: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
+000175e0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
+000175f0: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
+00017600: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
+00017610: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017620: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00017630: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
+00017640: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00017650: 2065 7865 6320 7b6e 616d 657d 202d 2d65   exec {name} --e
+00017660: 6e76 2d66 696c 6520 6578 616d 706c 6573  nv-file examples
+00017670: 2f73 616d 706c 655f 646f 7465 6e76 2022  /sample_dotenv "
+00017680: 285b 5b20 2120 2d7a 205c 5c22 5c24 5445  ([[ ! -z \\"\$TE
+00017690: 5354 5f45 4e56 325c 5c22 205d 5d20 2626  ST_ENV2\\" ]] &&
+000176a0: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
+000176b0: 5950 494c 4f54 5f4e 4f44 455f 4950 535c  YPILOT_NODE_IPS\
+000176c0: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
+000176d0: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
+000176e0: 4f44 455f 5241 4e4b 5c5c 2220 5d5d 2920  ODE_RANK\\" ]]) 
+000176f0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+00017700: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00017710: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00017720: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00017730: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00017740: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00017750: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00017760: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00017770: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00017780: 7374 696e 6720 6375 7374 6f6d 2069 6d61  sting custom ima
+00017790: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  ge ----------.@p
+000177a0: 7974 6573 742e 6d61 726b 2e61 7773 0a64  ytest.mark.aws.d
+000177b0: 6566 2074 6573 745f 6375 7374 6f6d 5f69  ef test_custom_i
+000177c0: 6d61 6765 2829 3a0a 2020 2020 2222 2254  mage():.    """T
+000177d0: 6573 7420 6375 7374 6f6d 2069 6d61 6765  est custom image
+000177e0: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
+000177f0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00017800: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00017810: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+00017820: 742d 6375 7374 6f6d 2d69 6d61 6765 272c  t-custom-image',
+00017830: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00017840: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00017850: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
+00017860: 7265 7472 792d 756e 7469 6c2d 7570 202d  retry-until-up -
+00017870: 7920 6578 616d 706c 6573 2f63 7573 746f  y examples/custo
+00017880: 6d5f 696d 6167 652e 7961 6d6c 272c 0a20  m_image.yaml',. 
+00017890: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000178a0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000178b0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000178c0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+000178d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+000178e0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+000178f0: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
+00017900: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00017910: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00017920: 6573 742e 6d61 726b 2e73 6c6f 770a 6465  est.mark.slow.de
+00017930: 6620 7465 7374 5f61 7a75 7265 5f73 7461  f test_azure_sta
+00017940: 7274 5f73 746f 705f 7477 6f5f 6e6f 6465  rt_stop_two_node
+00017950: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00017960: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00017970: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00017980: 6573 7428 0a20 2020 2020 2020 2027 617a  est(.        'az
+00017990: 7572 652d 7374 6172 742d 7374 6f70 2d74  ure-start-stop-t
+000179a0: 776f 2d6e 6f64 6573 272c 0a20 2020 2020  wo-nodes',.     
+000179b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000179c0: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
+000179d0: 6e75 6d2d 6e6f 6465 733d 3220 2d79 202d  num-nodes=2 -y -
+000179e0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
+000179f0: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
+00017a00: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
+00017a10: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00017a20: 202d 2d6e 756d 2d6e 6f64 6573 3d32 207b   --num-nodes=2 {
+00017a30: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
+00017a40: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
+00017a50: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00017a60: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00017a70: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00017a80: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00017a90: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00017aa0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00017ab0: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
+00017ac0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00017ad0: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
+00017ae0: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+00017af0: 2020 6627 736b 7920 6578 6563 202d 2d6e    f'sky exec --n
+00017b00: 756d 2d6e 6f64 6573 3d32 207b 6e61 6d65  um-nodes=2 {name
+00017b10: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
+00017b20: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+00017b30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017b40: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00017b50: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
+00017b60: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00017b70: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00017b80: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00017b90: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00017ba0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+00017bb0: 656f 7574 3d33 3020 2a20 3630 2c20 2023  eout=30 * 60,  #
+00017bc0: 2033 3020 6d69 6e73 2020 2869 7420 7461   30 mins  (it ta
+00017bd0: 6b65 7320 6172 6f75 6e64 207e 3233 206d  kes around ~23 m
+00017be0: 696e 7329 0a20 2020 2029 0a20 2020 2072  ins).    ).    r
+00017bf0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00017c00: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00017c10: 2054 6573 7469 6e67 2065 6e76 2066 6f72   Testing env for
+00017c20: 2064 6973 6b20 7469 6572 202d 2d2d 2d2d   disk tier -----
+00017c30: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00017c40: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+00017c50: 6177 735f 6469 736b 5f74 6965 7228 293a  aws_disk_tier():
+00017c60: 0a0a 2020 2020 6465 6620 5f67 6574 5f61  ..    def _get_a
+00017c70: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
+00017c80: 2872 6567 696f 6e2c 2069 6e73 7461 6e63  (region, instanc
+00017c90: 655f 6964 2c20 6669 656c 642c 2065 7870  e_id, field, exp
+00017ca0: 6563 7465 6429 3a0a 2020 2020 2020 2020  ected):.        
+00017cb0: 7265 7475 726e 2028 6627 6177 7320 6563  return (f'aws ec
+00017cc0: 3220 6465 7363 7269 6265 2d76 6f6c 756d  2 describe-volum
+00017cd0: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+00017ce0: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+00017cf0: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+00017d00: 7273 204e 616d 653d 6174 7461 6368 6d65  rs Name=attachme
+00017d10: 6e74 2e69 6e73 7461 6e63 652d 6964 2c56  nt.instance-id,V
+00017d20: 616c 7565 733d 7b69 6e73 7461 6e63 655f  alues={instance_
+00017d30: 6964 7d20 270a 2020 2020 2020 2020 2020  id} '.          
+00017d40: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
+00017d50: 566f 6c75 6d65 735b 2a5d 2e7b 6669 656c  Volumes[*].{fiel
+00017d60: 647d 207c 2067 7265 7020 7b65 7870 6563  d} | grep {expec
+00017d70: 7465 647d 203b 2027 290a 0a20 2020 2066  ted} ; ')..    f
+00017d80: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
+00017d90: 5b27 6c6f 7727 2c20 276d 6564 6975 6d27  ['low', 'medium'
+00017da0: 2c20 2768 6967 6827 5d3a 0a20 2020 2020  , 'high']:.     
+00017db0: 2020 2073 7065 6373 203d 2041 5753 2e5f     specs = AWS._
+00017dc0: 6765 745f 6469 736b 5f73 7065 6373 2864  get_disk_specs(d
+00017dd0: 6973 6b5f 7469 6572 290a 2020 2020 2020  isk_tier).      
+00017de0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00017df0: 7573 7465 725f 6e61 6d65 2829 202b 2027  uster_name() + '
+00017e00: 2d27 202b 2064 6973 6b5f 7469 6572 0a20  -' + disk_tier. 
+00017e10: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+00017e20: 2775 732d 7765 7374 2d32 270a 2020 2020  'us-west-2'.    
+00017e30: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00017e40: 0a20 2020 2020 2020 2020 2020 2027 6177  .            'aw
+00017e50: 732d 6469 736b 2d74 6965 7227 2c0a 2020  s-disk-tier',.  
+00017e60: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+00017e70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017e80: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00017e90: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6177  name} --cloud aw
+00017ea0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00017eb0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+00017ec0: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
+00017ed0: 6965 7220 7b64 6973 6b5f 7469 6572 7d20  ier {disk_tier} 
+00017ee0: 6563 686f 2022 6865 6c6c 6f20 736b 7922  echo "hello sky"
+00017ef0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00017f00: 2020 2066 2769 643d 6061 7773 2065 6332     f'id=`aws ec2
+00017f10: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
+00017f20: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
+00017f30: 6769 6f6e 7d20 2d2d 6669 6c74 6572 7320  gion} --filters 
+00017f40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00017f50: 2020 6627 4e61 6d65 3d74 6167 3a72 6179    f'Name=tag:ray
+00017f60: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+00017f70: 6c75 6573 3d7b 6e61 6d65 7d20 2d2d 7175  lues={name} --qu
+00017f80: 6572 7920 270a 2020 2020 2020 2020 2020  ery '.          
+00017f90: 2020 2020 2020 6627 5265 7365 7276 6174        f'Reservat
+00017fa0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+00017fb0: 5b5d 2e49 6e73 7461 6e63 6549 6420 2d2d  [].InstanceId --
+00017fc0: 6f75 7470 7574 2074 6578 7460 3b20 2720  output text`; ' 
+00017fd0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+00017fe0: 2020 5f67 6574 5f61 7773 5f71 7565 7279    _get_aws_query
+00017ff0: 5f63 6f6d 6d61 6e64 2872 6567 696f 6e2c  _command(region,
+00018000: 2027 2469 6427 2c20 2756 6f6c 756d 6554   '$id', 'VolumeT
+00018010: 7970 6527 2c0a 2020 2020 2020 2020 2020  ype',.          
+00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018030: 2020 2020 2020 2020 2020 2020 2073 7065               spe
+00018040: 6373 5b27 6469 736b 5f74 6965 7227 5d29  cs['disk_tier'])
+00018050: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
+00018060: 2020 2028 2727 2069 6620 6469 736b 5f74     ('' if disk_t
+00018070: 6965 7220 3d3d 2027 6c6f 7727 2065 6c73  ier == 'low' els
+00018080: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00018090: 2020 2028 5f67 6574 5f61 7773 5f71 7565     (_get_aws_que
+000180a0: 7279 5f63 6f6d 6d61 6e64 2872 6567 696f  ry_command(regio
+000180b0: 6e2c 2027 2469 6427 2c20 2749 6f70 7327  n, '$id', 'Iops'
+000180c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000180d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180e0: 2020 2020 2020 2020 2020 2073 7065 6373             specs
+000180f0: 5b27 6469 736b 5f69 6f70 7327 5d29 202b  ['disk_iops']) +
+00018100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018110: 2020 205f 6765 745f 6177 735f 7175 6572     _get_aws_quer
+00018120: 795f 636f 6d6d 616e 6428 7265 6769 6f6e  y_command(region
+00018130: 2c20 2724 6964 272c 2027 5468 726f 7567  , '$id', 'Throug
+00018140: 6870 7574 272c 0a20 2020 2020 2020 2020  hput',.         
+00018150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018170: 7370 6563 735b 2764 6973 6b5f 7468 726f  specs['disk_thro
+00018180: 7567 6870 7574 275d 2929 292c 0a20 2020  ughput']))),.   
+00018190: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000181a0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+000181b0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+000181c0: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+000181d0: 7574 3d31 3020 2a20 3630 2c20 2023 2031  ut=10 * 60,  # 1
+000181e0: 3020 6d69 6e73 2020 2869 7420 7461 6b65  0 mins  (it take
+000181f0: 7320 6172 6f75 6e64 207e 3620 6d69 6e73  s around ~6 mins
+00018200: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00018210: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00018220: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00018230: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
+00018240: 7374 5f67 6370 5f64 6973 6b5f 7469 6572  st_gcp_disk_tier
+00018250: 2829 3a0a 2020 2020 666f 7220 6469 736b  ():.    for disk
+00018260: 5f74 6965 7220 696e 205b 276c 6f77 272c  _tier in ['low',
+00018270: 2027 6d65 6469 756d 272c 2027 6869 6768   'medium', 'high
+00018280: 275d 3a0a 2020 2020 2020 2020 7479 7065  ']:.        type
+00018290: 203d 2047 4350 2e5f 6765 745f 6469 736b   = GCP._get_disk
+000182a0: 5f74 7970 6528 6469 736b 5f74 6965 7229  _type(disk_tier)
+000182b0: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+000182c0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000182d0: 6528 2920 2b20 272d 2720 2b20 6469 736b  e() + '-' + disk
+000182e0: 5f74 6965 720a 2020 2020 2020 2020 7265  _tier.        re
+000182f0: 6769 6f6e 203d 2027 7573 2d77 6573 7432  gion = 'us-west2
+00018300: 270a 2020 2020 2020 2020 7465 7374 203d  '.        test =
+00018310: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+00018320: 2020 2027 6763 702d 6469 736b 2d74 6965     'gcp-disk-tie
+00018330: 7227 2c0a 2020 2020 2020 2020 2020 2020  r',.            
+00018340: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00018350: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00018360: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+00018370: 6f75 6420 6763 7020 2d2d 7265 6769 6f6e  oud gcp --region
+00018380: 207b 7265 6769 6f6e 7d20 270a 2020 2020   {region} '.    
+00018390: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000183a0: 6469 736b 2d74 6965 7220 7b64 6973 6b5f  disk-tier {disk_
+000183b0: 7469 6572 7d20 6563 686f 2022 6865 6c6c  tier} echo "hell
+000183c0: 6f20 736b 7922 272c 0a20 2020 2020 2020  o sky"',.       
+000183d0: 2020 2020 2020 2020 2066 276e 616d 653d           f'name=
+000183e0: 6067 636c 6f75 6420 636f 6d70 7574 6520  `gcloud compute 
+000183f0: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
+00018400: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
+00018410: 2020 2020 2020 2020 2020 6627 226c 6162            f'"lab
+00018420: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+00018430: 6e61 6d65 3a7b 6e61 6d65 7d22 202d 2d66  name:{name}" --f
+00018440: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
+00018450: 6529 2260 3b20 270a 2020 2020 2020 2020  e)"`; '.        
+00018460: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
+00018470: 2063 6f6d 7075 7465 2064 6973 6b73 206c   compute disks l
+00018480: 6973 7420 2d2d 6669 6c74 6572 3d22 6e61  ist --filter="na
+00018490: 6d65 3d24 6e61 6d65 2220 270a 2020 2020  me=$name" '.    
+000184a0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000184b0: 666f 726d 6174 3d22 7661 6c75 6528 7479  format="value(ty
+000184c0: 7065 2922 207c 2067 7265 7020 7b74 7970  pe)" | grep {typ
+000184d0: 657d 2027 0a20 2020 2020 2020 2020 2020  e} '.           
+000184e0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+000184f0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00018500: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00018510: 2020 2074 696d 656f 7574 3d36 202a 2036     timeout=6 * 6
+00018520: 302c 2020 2320 3620 6d69 6e73 2020 2869  0,  # 6 mins  (i
+00018530: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
+00018540: 3320 6d69 6e73 290a 2020 2020 2020 2020  3 mins).        
+00018550: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
+00018560: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00018570: 7079 7465 7374 2e6d 6172 6b2e 617a 7572  pytest.mark.azur
+00018580: 650a 6465 6620 7465 7374 5f61 7a75 7265  e.def test_azure
+00018590: 5f64 6973 6b5f 7469 6572 2829 3a0a 2020  _disk_tier():.  
+000185a0: 2020 666f 7220 6469 736b 5f74 6965 7220    for disk_tier 
+000185b0: 696e 205b 276c 6f77 272c 2027 6d65 6469  in ['low', 'medi
+000185c0: 756d 275d 3a0a 2020 2020 2020 2020 7479  um']:.        ty
+000185d0: 7065 203d 2041 7a75 7265 2e5f 6765 745f  pe = Azure._get_
+000185e0: 6469 736b 5f74 7970 6528 6469 736b 5f74  disk_type(disk_t
+000185f0: 6965 7229 0a20 2020 2020 2020 206e 616d  ier).        nam
+00018600: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00018610: 5f6e 616d 6528 2920 2b20 272d 2720 2b20  _name() + '-' + 
+00018620: 6469 736b 5f74 6965 720a 2020 2020 2020  disk_tier.      
+00018630: 2020 7265 6769 6f6e 203d 2027 7765 7374    region = 'west
+00018640: 7573 3227 0a20 2020 2020 2020 2074 6573  us2'.        tes
+00018650: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00018660: 2020 2020 2020 2761 7a75 7265 2d64 6973        'azure-dis
+00018670: 6b2d 7469 6572 272c 0a20 2020 2020 2020  k-tier',.       
+00018680: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00018690: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+000186a0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000186b0: 202d 2d63 6c6f 7564 2061 7a75 7265 202d   --cloud azure -
+000186c0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+000186d0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000186e0: 2020 2066 272d 2d64 6973 6b2d 7469 6572     f'--disk-tier
+000186f0: 207b 6469 736b 5f74 6965 727d 2065 6368   {disk_tier} ech
+00018700: 6f20 2268 656c 6c6f 2073 6b79 2227 2c0a  o "hello sky"',.
+00018710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018720: 6627 617a 2072 6573 6f75 7263 6520 6c69  f'az resource li
+00018730: 7374 202d 2d74 6167 2072 6179 2d63 6c75  st --tag ray-clu
+00018740: 7374 6572 2d6e 616d 653d 7b6e 616d 657d  ster-name={name}
+00018750: 202d 2d71 7565 7279 2027 0a20 2020 2020   --query '.     
+00018760: 2020 2020 2020 2020 2020 2066 2722 5b3f             f'"[?
+00018770: 7479 7065 3d3d 5c27 4d69 6372 6f73 6f66  type==\'Microsof
+00018780: 742e 436f 6d70 7574 652f 6469 736b 735c  t.Compute/disks\
+00018790: 275d 2e73 6b75 2e6e 616d 6522 2027 0a20  '].sku.name" '. 
+000187a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000187b0: 272d 2d6f 7574 7075 7420 7473 7620 7c20  '--output tsv | 
+000187c0: 6772 6570 207b 7479 7065 7d27 0a20 2020  grep {type}'.   
+000187d0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+000187e0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+000187f0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00018800: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+00018810: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
+00018820: 3020 6d69 6e73 2020 2869 7420 7461 6b65  0 mins  (it take
+00018830: 7320 6172 6f75 6e64 207e 3132 206d 696e  s around ~12 min
+00018840: 7329 0a20 2020 2020 2020 2029 0a20 2020  s).        ).   
+00018850: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+00018860: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00018870: 2d2d 2054 6573 7469 6e67 205a 6572 6f20  -- Testing Zero 
+00018880: 5175 6f74 6120 4661 696c 6f76 6572 202d  Quota Failover -
+00018890: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+000188a0: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+000188b0: 6177 735f 7a65 726f 5f71 756f 7461 5f66  aws_zero_quota_f
+000188c0: 6169 6c6f 7665 7228 293a 0a0a 2020 2020  ailover():..    
+000188d0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000188e0: 7465 725f 6e61 6d65 2829 0a20 2020 2072  ter_name().    r
+000188f0: 6567 696f 6e20 3d20 6765 745f 6177 735f  egion = get_aws_
+00018900: 7265 6769 6f6e 5f66 6f72 5f71 756f 7461  region_for_quota
+00018910: 5f66 6169 6c6f 7665 7228 290a 0a20 2020  _failover()..   
+00018920: 2069 6620 6e6f 7420 7265 6769 6f6e 3a0a   if not region:.
+00018930: 2020 2020 2020 2020 7079 7465 7374 2e78          pytest.x
+00018940: 6661 696c 280a 2020 2020 2020 2020 2020  fail(.          
+00018950: 2020 2755 6e61 626c 6520 746f 2074 6573    'Unable to tes
+00018960: 7420 7a65 726f 2071 756f 7461 2066 6169  t zero quota fai
+00018970: 6c6f 7665 7220 6f70 7469 6d69 7a61 7469  lover optimizati
+00018980: 6f6e 20e2 8094 2071 756f 7461 7320 270a  on ... quotas '.
+00018990: 2020 2020 2020 2020 2020 2020 2766 6f72              'for
+000189a0: 2045 4332 2050 3320 696e 7374 616e 6365   EC2 P3 instance
+000189b0: 7320 7765 7265 2066 6f75 6e64 206f 6e20  s were found on 
+000189c0: 616c 6c20 4157 5320 7265 6769 6f6e 732e  all AWS regions.
+000189d0: 2049 7320 7468 6973 2027 0a20 2020 2020   Is this '.     
+000189e0: 2020 2020 2020 2027 6578 7065 6374 6564         'expected
+000189f0: 2066 6f72 2079 6f75 7220 6163 636f 756e   for your accoun
+00018a00: 743f 2729 0a20 2020 2020 2020 2072 6574  t?').        ret
+00018a10: 7572 6e0a 0a20 2020 2074 6573 7420 3d20  urn..    test = 
+00018a20: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+00018a30: 7773 2d7a 6572 6f2d 7175 6f74 612d 6661  ws-zero-quota-fa
+00018a40: 696c 6f76 6572 272c 0a20 2020 2020 2020  ilover',.       
+00018a50: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00018a60: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00018a70: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00018a80: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+00018a90: 6567 696f 6e7d 202d 2d67 7075 7320 5631  egion} --gpus V1
+00018aa0: 3030 3a38 202d 2d75 7365 2d73 706f 7420  00:8 --use-spot 
+00018ab0: 7c20 6772 6570 2022 466f 756e 6420 6e6f  | grep "Found no
+00018ac0: 2071 756f 7461 2227 2c0a 2020 2020 2020   quota"',.      
+00018ad0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00018ae0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00018af0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00018b00: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00018b10: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00018b20: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
+00018b30: 5f7a 6572 6f5f 7175 6f74 615f 6661 696c  _zero_quota_fail
+00018b40: 6f76 6572 2829 3a0a 0a20 2020 206e 616d  over():..    nam
+00018b50: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00018b60: 5f6e 616d 6528 290a 2020 2020 7265 6769  _name().    regi
+00018b70: 6f6e 203d 2067 6574 5f67 6370 5f72 6567  on = get_gcp_reg
+00018b80: 696f 6e5f 666f 725f 7175 6f74 615f 6661  ion_for_quota_fa
+00018b90: 696c 6f76 6572 2829 0a0a 2020 2020 6966  ilover()..    if
+00018ba0: 206e 6f74 2072 6567 696f 6e3a 0a20 2020   not region:.   
+00018bb0: 2020 2020 2070 7974 6573 742e 7866 6169       pytest.xfai
+00018bc0: 6c28 0a20 2020 2020 2020 2020 2020 2027  l(.            '
+00018bd0: 556e 6162 6c65 2074 6f20 7465 7374 207a  Unable to test z
+00018be0: 6572 6f20 7175 6f74 6120 6661 696c 6f76  ero quota failov
+00018bf0: 6572 206f 7074 696d 697a 6174 696f 6e20  er optimization 
+00018c00: e280 9420 7175 6f74 6173 2027 0a20 2020  ... quotas '.   
+00018c10: 2020 2020 2020 2020 2027 666f 7220 4131           'for A1
+00018c20: 3030 2d38 3047 4220 4750 5573 2077 6572  00-80GB GPUs wer
+00018c30: 6520 666f 756e 6420 6f6e 2061 6c6c 2047  e found on all G
+00018c40: 4350 2072 6567 696f 6e73 2e20 4973 2074  CP regions. Is t
+00018c50: 6869 7320 270a 2020 2020 2020 2020 2020  his '.          
+00018c60: 2020 2765 7870 6563 7465 6420 666f 7220    'expected for 
+00018c70: 796f 7572 2061 6363 6f75 6e74 3f27 290a  your account?').
+00018c80: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00018c90: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00018ca0: 0a20 2020 2020 2020 2027 6763 702d 7a65  .        'gcp-ze
+00018cb0: 726f 2d71 756f 7461 2d66 6169 6c6f 7665  ro-quota-failove
+00018cc0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+00018cd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00018ce0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00018cf0: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
+00018d00: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+00018d10: 7d20 2d2d 6770 7573 2041 3130 302d 3830  } --gpus A100-80
+00018d20: 4742 3a31 202d 2d75 7365 2d73 706f 7420  GB:1 --use-spot 
+00018d30: 7c20 6772 6570 2022 466f 756e 6420 6e6f  | grep "Found no
+00018d40: 2071 756f 7461 2227 2c0a 2020 2020 2020   quota"',.      
+00018d50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00018d60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00018d70: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00018d80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00018d90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2054 6573  ...# ------- Tes
+00018da0: 7469 6e67 2075 7365 7220 7261 7920 636c  ting user ray cl
+00018db0: 7573 7465 7220 2d2d 2d2d 2d2d 2d2d 0a64  uster --------.d
+00018dc0: 6566 2074 6573 745f 7573 6572 5f72 6179  ef test_user_ray
+00018dd0: 5f63 6c75 7374 6572 2829 3a0a 2020 2020  _cluster():.    
+00018de0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00018df0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00018e00: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00018e10: 2020 2020 2775 7365 722d 7261 792d 636c      'user-ray-cl
+00018e20: 7573 7465 7227 2c0a 2020 2020 2020 2020  uster',.        
+00018e30: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00018e40: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00018e50: 207b 6e61 6d65 7d20 2272 6179 2073 7461   {name} "ray sta
+00018e60: 7274 202d 2d68 6561 6422 272c 0a20 2020  rt --head"',.   
+00018e70: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00018e80: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
+00018e90: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
+00018ea0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00018eb0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00018ec0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00018ed0: 736b 7920 7374 6174 7573 202d 7220 7c20  sky status -r | 
+00018ee0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+00018ef0: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
+00018f00: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00018f10: 6e61 6d65 7d20 2265 6368 6f20 6279 6522  name} "echo bye"
+00018f20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00018f30: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00018f40: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
+00018f50: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00018f60: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00018f70: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00018f80: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00018f90: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00018fa0: 2054 6573 7469 6e67 2074 6865 2063 6f72   Testing the cor
+00018fb0: 6520 4150 4920 2d2d 2d2d 2d2d 2d2d 0a23  e API --------.#
+00018fc0: 204d 6f73 7420 6f66 2074 6865 2063 6f72   Most of the cor
+00018fd0: 6520 4150 4973 2068 6176 6520 6265 656e  e APIs have been
+00018fe0: 2074 6573 7465 6420 696e 2074 6865 2043   tested in the C
+00018ff0: 4c49 2074 6573 7473 2e0a 2320 5468 6573  LI tests..# Thes
+00019000: 6520 7465 7374 7320 6172 6520 666f 7220  e tests are for 
+00019010: 7465 7374 696e 6720 7468 6520 7265 7475  testing the retu
+00019020: 726e 2076 616c 7565 206f 6620 7468 6520  rn value of the 
+00019030: 4150 4973 206e 6f74 2066 756c 6c79 2075  APIs not fully u
+00019040: 7365 6420 696e 2043 4c49 2e0a 6465 6620  sed in CLI..def 
+00019050: 7465 7374 5f63 6f72 655f 6170 6928 293a  test_core_api():
+00019060: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00019070: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00019080: 2020 2020 736b 792e 6c61 756e 6368 0a20      sky.launch. 
+00019090: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+000190a0: 2041 6464 2061 2074 6573 7420 666f 7220   Add a test for 
+000190b0: 636f 7265 2061 7069 2e0a 0a0a 2320 2d2d  core api....# --
+000190c0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+000190d0: 2053 746f 7261 6765 202d 2d2d 2d2d 2d2d   Storage -------
+000190e0: 2d2d 2d0a 636c 6173 7320 5465 7374 5374  ---.class TestSt
+000190f0: 6f72 6167 6557 6974 6843 7265 6465 6e74  orageWithCredent
+00019100: 6961 6c73 3a0a 2020 2020 2222 2253 746f  ials:.    """Sto
+00019110: 7261 6765 2074 6573 7473 2077 6869 6368  rage tests which
+00019120: 2072 6571 7569 7265 2063 7265 6465 6e74   require credent
+00019130: 6961 6c73 2061 6e64 206e 6574 776f 726b  ials and network
+00019140: 2063 6f6e 6e65 6374 696f 6e22 2222 0a0a   connection"""..
+00019150: 2020 2020 4157 535f 494e 5641 4c49 445f      AWS_INVALID_
+00019160: 4e41 4d45 5320 3d20 5b0a 2020 2020 2020  NAMES = [.      
+00019170: 2020 2761 6227 2c20 2023 206c 6573 7320    'ab',  # less 
+00019180: 7468 616e 2033 2063 6861 7261 6374 6572  than 3 character
+00019190: 730a 2020 2020 2020 2020 2761 6263 6465  s.        'abcde
+000191a0: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+000191b0: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
+000191c0: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+000191d0: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+000191e0: 7273 7475 7677 7879 7a31 272c 0a20 2020  rstuvwxyz1',.   
+000191f0: 2020 2020 2023 206d 6f72 6520 7468 616e       # more than
+00019200: 2036 3320 6368 6172 6163 7465 7273 0a20   63 characters. 
+00019210: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
+00019220: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
+00019230: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
+00019240: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
+00019250: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
+00019260: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
+00019270: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
+00019280: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
+00019290: 6f64 730a 2020 2020 2020 2020 2731 3932  ods.        '192
+000192a0: 2e31 3638 2e35 2e34 272c 2020 2320 666f  .168.5.4',  # fo
+000192b0: 726d 6174 7465 6420 6173 2061 6e20 4950  rmatted as an IP
+000192c0: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
+000192d0: 2027 786e 2d2d 6275 636b 6574 272c 2020   'xn--bucket',  
+000192e0: 2320 7374 6172 7473 2077 6974 6820 2778  # starts with 'x
+000192f0: 6e2d 2d27 2070 7265 6669 780a 2020 2020  n--' prefix.    
+00019300: 2020 2020 2762 7563 6b65 742d 7333 616c      'bucket-s3al
+00019310: 6961 7327 2c20 2023 2065 6e64 7320 7769  ias',  # ends wi
+00019320: 7468 2027 2d73 3361 6c69 6173 2720 7375  th '-s3alias' su
+00019330: 6666 6978 0a20 2020 2020 2020 2027 6275  ffix.        'bu
+00019340: 636b 6574 2d2d 6f6c 2d73 3327 2c20 2023  cket--ol-s3',  #
+00019350: 2065 6e64 7320 7769 7468 2027 2d2d 6f6c   ends with '--ol
+00019360: 2d73 3327 2073 7566 6669 780a 2020 2020  -s3' suffix.    
+00019370: 2020 2020 272e 6162 6327 2c20 2023 2073      '.abc',  # s
+00019380: 7461 7274 7320 7769 7468 2061 2064 6f74  tarts with a dot
+00019390: 0a20 2020 2020 2020 2027 6162 632e 272c  .        'abc.',
+000193a0: 2020 2320 656e 6473 2077 6974 6820 6120    # ends with a 
+000193b0: 646f 740a 2020 2020 2020 2020 272d 6162  dot.        '-ab
+000193c0: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
+000193d0: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
+000193e0: 2020 2020 2761 6263 2d27 2c20 2023 2065      'abc-',  # e
+000193f0: 6e64 7320 7769 7468 2061 2068 7970 6865  nds with a hyphe
+00019400: 6e0a 2020 2020 5d0a 0a20 2020 2047 4353  n.    ]..    GCS
+00019410: 5f49 4e56 414c 4944 5f4e 414d 4553 203d  _INVALID_NAMES =
+00019420: 205b 0a20 2020 2020 2020 2027 6162 272c   [.        'ab',
+00019430: 2020 2320 6c65 7373 2074 6861 6e20 3320    # less than 3 
+00019440: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
+00019450: 2020 2027 6162 6364 6566 6768 696a 6b6c     'abcdefghijkl
+00019460: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
+00019470: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00019480: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+00019490: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+000194a0: 797a 3127 2c0a 2020 2020 2020 2020 2320  yz1',.        # 
+000194b0: 6d6f 7265 2074 6861 6e20 3633 2063 6861  more than 63 cha
+000194c0: 7261 6374 6572 7320 2877 6974 686f 7574  racters (without
+000194d0: 2064 6f74 7329 0a20 2020 2020 2020 2027   dots).        '
+000194e0: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
+000194f0: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
+00019500: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
+00019510: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
+00019520: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
+00019530: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
+00019540: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
+00019550: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
+00019560: 2020 2020 2761 6263 5f2e 6465 662e 6768      'abc_.def.gh
+00019570: 692e 6a6b 6c6d 6e6f 7071 7273 7475 7677  i.jklmnopqrstuvw
+00019580: 7879 7a61 6263 6465 6667 6869 6a6b 6c6d  xyzabcdefghijklm
+00019590: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+000195a0: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+000195b0: 7475 7677 7879 7a31 270a 2020 2020 2020  tuvwxyz1'.      
+000195c0: 2020 2320 4d6f 7265 2074 6861 6e20 3633    # More than 63
+000195d0: 2063 6861 7261 6374 6572 7320 6265 7477   characters betw
+000195e0: 6565 6e20 646f 7473 0a20 2020 2020 2020  een dots.       
+000195f0: 2027 6162 635f 2e64 6566 2e67 6869 2e6a   'abc_.def.ghi.j
+00019600: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
+00019610: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
+00019620: 7166 6768 696a 6b6c 6d6e 6f70 7172 7374  qfghijklmnopqrst
+00019630: 7576 7727 202a 2035 2c0a 2020 2020 2020  uvw' * 5,.      
+00019640: 2020 2320 6d6f 7265 2074 6861 6e20 3232    # more than 22
+00019650: 3220 6368 6172 6163 7465 7273 2028 7769  2 characters (wi
+00019660: 7468 2064 6f74 7329 0a20 2020 2020 2020  th dots).       
+00019670: 2027 3139 322e 3136 382e 352e 3427 2c20   '192.168.5.4', 
+00019680: 2023 2066 6f72 6d61 7474 6564 2061 7320   # formatted as 
+00019690: 616e 2049 5020 6164 6472 6573 730a 2020  an IP address.  
+000196a0: 2020 2020 2020 2767 6f6f 6762 7563 6b65        'googbucke
+000196b0: 7427 2c20 2023 2073 7461 7274 7320 7769  t',  # starts wi
+000196c0: 7468 2027 676f 6f67 2720 7072 6566 6978  th 'goog' prefix
+000196d0: 0a20 2020 2020 2020 2027 676f 6f67 6c65  .        'google
+000196e0: 6275 636b 6574 272c 2020 2320 636f 6e74  bucket',  # cont
+000196f0: 6169 6e73 2027 676f 6f67 6c65 270a 2020  ains 'google'.  
+00019700: 2020 2020 2020 2767 3030 676c 6562 7563        'g00glebuc
+00019710: 6b65 7427 2c20 2023 2076 6172 6961 6e74  ket',  # variant
+00019720: 206f 6620 2767 6f6f 676c 6527 0a20 2020   of 'google'.   
+00019730: 2020 2020 2027 676f 3067 6c65 6275 636b       'go0glebuck
+00019740: 6574 272c 2020 2320 7661 7269 616e 7420  et',  # variant 
+00019750: 6f66 2027 676f 6f67 6c65 270a 2020 2020  of 'google'.    
+00019760: 2020 2020 2767 306f 676c 6562 7563 6b65      'g0oglebucke
+00019770: 7427 2c20 2023 2076 6172 6961 6e74 206f  t',  # variant o
+00019780: 6620 2767 6f6f 676c 6527 0a20 2020 2020  f 'google'.     
+00019790: 2020 2027 2e61 6263 272c 2020 2320 7374     '.abc',  # st
+000197a0: 6172 7473 2077 6974 6820 6120 646f 740a  arts with a dot.
+000197b0: 2020 2020 2020 2020 2761 6263 2e27 2c20          'abc.', 
+000197c0: 2023 2065 6e64 7320 7769 7468 2061 2064   # ends with a d
+000197d0: 6f74 0a20 2020 2020 2020 2027 5f61 6263  ot.        '_abc
+000197e0: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
+000197f0: 6820 616e 2075 6e64 6572 7363 6f72 650a  h an underscore.
+00019800: 2020 2020 2020 2020 2761 6263 5f27 2c20          'abc_', 
+00019810: 2023 2065 6e64 7320 7769 7468 2061 6e20   # ends with an 
+00019820: 756e 6465 7273 636f 7265 0a20 2020 205d  underscore.    ]
+00019830: 0a0a 2020 2020 4942 4d5f 494e 5641 4c49  ..    IBM_INVALI
+00019840: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
+00019850: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
+00019860: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
+00019870: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
+00019880: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00019890: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+000198a0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+000198b0: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+000198c0: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
+000198d0: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
+000198e0: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
+000198f0: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
+00019900: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
+00019910: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
+00019920: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
+00019930: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
+00019940: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
+00019950: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
+00019960: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
+00019970: 7269 6f64 730a 2020 2020 2020 2020 2731  riods.        '1
+00019980: 3932 2e31 3638 2e35 2e34 272c 2020 2320  92.168.5.4',  # 
+00019990: 666f 726d 6174 7465 6420 6173 2061 6e20  formatted as an 
+000199a0: 4950 2061 6464 7265 7373 0a20 2020 2020  IP address.     
+000199b0: 2020 2027 786e 2d2d 6275 636b 6574 272c     'xn--bucket',
+000199c0: 2020 2320 7374 6172 7473 2077 6974 6820    # starts with 
+000199d0: 2778 6e2d 2d27 2070 7265 6669 780a 2020  'xn--' prefix.  
+000199e0: 2020 2020 2020 272e 6162 6327 2c20 2023        '.abc',  #
+000199f0: 2073 7461 7274 7320 7769 7468 2061 2064   starts with a d
+00019a00: 6f74 0a20 2020 2020 2020 2027 6162 632e  ot.        'abc.
+00019a10: 272c 2020 2320 656e 6473 2077 6974 6820  ',  # ends with 
+00019a20: 6120 646f 740a 2020 2020 2020 2020 272d  a dot.        '-
+00019a30: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
+00019a40: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
+00019a50: 2020 2020 2020 2761 6263 2d27 2c20 2023        'abc-',  #
+00019a60: 2065 6e64 7320 7769 7468 2061 2068 7970   ends with a hyp
+00019a70: 6865 6e0a 2020 2020 2020 2020 2761 2e2d  hen.        'a.-
+00019a80: 6263 272c 2020 2320 636f 6e74 6169 6e73  bc',  # contains
+00019a90: 2074 6865 2073 6571 7565 6e63 6520 272e   the sequence '.
+00019aa0: 2d27 0a20 2020 2020 2020 2027 612d 2e62  -'.        'a-.b
+00019ab0: 6327 2c20 2023 2063 6f6e 7461 696e 7320  c',  # contains 
+00019ac0: 7468 6520 7365 7175 656e 6365 2027 2d2e  the sequence '-.
+00019ad0: 270a 2020 2020 2020 2020 2761 2662 6327  '.        'a&bc'
+00019ae0: 2020 2320 636f 6e74 6169 6e73 2073 7065    # contains spe
+00019af0: 6369 616c 2063 6861 7261 6374 6572 730a  cial characters.
+00019b00: 2020 2020 2020 2020 2761 625e 6327 2020          'ab^c'  
+00019b10: 2320 636f 6e74 6169 6e73 2073 7065 6369  # contains speci
+00019b20: 616c 2063 6861 7261 6374 6572 730a 2020  al characters.  
+00019b30: 2020 5d0a 2020 2020 4749 5449 474e 4f52    ].    GITIGNOR
+00019b40: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
+00019b50: 5354 5255 4354 5552 4520 3d20 7b0a 2020  STRUCTURE = {.  
+00019b60: 2020 2020 2020 2764 6f75 626c 655f 6173        'double_as
+00019b70: 7465 7269 736b 273a 207b 0a20 2020 2020  terisk': {.     
+00019b80: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
+00019b90: 7374 6572 6973 6b5f 6578 636c 7564 6564  sterisk_excluded
+00019ba0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+00019bb0: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
+00019bc0: 6572 6973 6b5f 6578 636c 7564 6564 5f64  erisk_excluded_d
+00019bd0: 6972 273a 207b 0a20 2020 2020 2020 2020  ir': {.         
+00019be0: 2020 2020 2020 2027 6469 725f 6578 636c         'dir_excl
+00019bf0: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
+00019c00: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00019c10: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
+00019c20: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
+00019c30: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
+00019c40: 2020 2020 2020 2027 7061 7265 6e74 273a         'parent':
+00019c50: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00019c60: 2020 2027 616c 736f 5f65 7863 6c75 6465     'also_exclude
+00019c70: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+00019c80: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+00019c90: 6869 6c64 273a 207b 0a20 2020 2020 2020  hild': {.       
+00019ca0: 2020 2020 2020 2020 2020 2020 2027 646f               'do
+00019cb0: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
+00019cc0: 7265 6e74 5f63 6869 6c64 5f65 7863 6c75  rent_child_exclu
+00019cd0: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
+00019ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cf0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00019d00: 2020 2027 646f 7562 6c65 5f61 7374 6572     'double_aster
+00019d10: 6973 6b5f 7061 7265 6e74 5f65 7863 6c75  isk_parent_exclu
+00019d20: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
+00019d30: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+00019d40: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00019d50: 2020 2765 7863 6c75 6465 642e 6c6f 6727    'excluded.log'
+00019d60: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+00019d70: 2765 7863 6c75 6465 645f 6469 7227 3a20  'excluded_dir': 
+00019d80: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
+00019d90: 7863 6c75 6465 642e 7478 7427 3a20 4e6f  xcluded.txt': No
+00019da0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00019db0: 276e 6573 7465 645f 6578 636c 7564 6564  'nested_excluded
+00019dc0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+00019dd0: 2020 2020 2027 6578 636c 7564 6564 273a       'excluded':
+00019de0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00019df0: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
+00019e00: 0a20 2020 2020 2020 2027 6578 702d 3127  .        'exp-1'
+00019e10: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00019e20: 2762 655f 6578 636c 7564 6564 273a 204e  'be_excluded': N
+00019e30: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
+00019e40: 2020 2020 2020 2020 2765 7870 2d32 273a          'exp-2':
+00019e50: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
+00019e60: 6265 5f65 7863 6c75 6465 6427 3a20 4e6f  be_excluded': No
+00019e70: 6e65 2c0a 2020 2020 2020 2020 7d2c 0a20  ne,.        },. 
+00019e80: 2020 2020 2020 2027 6672 6f6e 745f 736c         'front_sl
+00019e90: 6173 685f 6578 636c 7564 6564 273a 204e  ash_excluded': N
+00019ea0: 6f6e 652c 0a20 2020 2020 2020 2027 696e  one,.        'in
+00019eb0: 636c 7564 6564 2e6c 6f67 273a 204e 6f6e  cluded.log': Non
+00019ec0: 652c 0a20 2020 2020 2020 2027 696e 636c  e,.        'incl
+00019ed0: 7564 6564 2e74 7874 273a 204e 6f6e 652c  uded.txt': None,
+00019ee0: 0a20 2020 2020 2020 2027 696e 636c 7564  .        'includ
+00019ef0: 655f 6469 7227 3a20 7b0a 2020 2020 2020  e_dir': {.      
+00019f00: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
+00019f10: 6c6f 6727 3a20 4e6f 6e65 2c0a 2020 2020  log': None,.    
+00019f20: 2020 2020 2020 2020 2769 6e63 6c75 6465          'include
+00019f30: 642e 6c6f 6727 3a20 4e6f 6e65 2c0a 2020  d.log': None,.  
+00019f40: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00019f50: 2027 6e65 7374 6564 5f64 6f75 626c 655f   'nested_double_
+00019f60: 6173 7465 7269 736b 273a 207b 0a20 2020  asterisk': {.   
+00019f70: 2020 2020 2020 2020 2027 6f6e 6527 3a20           'one': 
+00019f80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00019f90: 2020 2761 6c73 6f5f 6578 636c 7564 652e    'also_exclude.
+00019fa0: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
+00019fb0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00019fc0: 2020 2020 2020 2027 7477 6f27 3a20 7b0a         'two': {.
+00019fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fe0: 2761 6c73 6f5f 6578 636c 7564 652e 7478  'also_exclude.tx
+00019ff0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0001a000: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0001a010: 207d 2c0a 2020 2020 2020 2020 276e 6573   },.        'nes
+0001a020: 7465 645f 7769 6c64 6361 7264 5f64 6972  ted_wildcard_dir
+0001a030: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0001a040: 2027 6d6f 6e64 6179 273a 207b 0a20 2020   'monday': {.   
+0001a050: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+0001a060: 736f 5f65 7863 6c75 6465 2e74 7874 273a  so_exclude.txt':
+0001a070: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0001a080: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+0001a090: 2020 2774 7565 7364 6179 273a 207b 0a20    'tuesday': {. 
+0001a0a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0001a0b0: 616c 736f 5f65 7863 6c75 6465 2e74 7874  also_exclude.txt
+0001a0c0: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001a0d0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0001a0e0: 7d2c 0a20 2020 2020 2020 2027 6e6f 5f73  },.        'no_s
+0001a0f0: 6c61 7368 5f65 7863 6c75 6465 6427 3a20  lash_excluded': 
+0001a100: 4e6f 6e65 2c0a 2020 2020 2020 2020 276e  None,.        'n
+0001a110: 6f5f 736c 6173 685f 7465 7374 7327 3a20  o_slash_tests': 
+0001a120: 7b0a 2020 2020 2020 2020 2020 2020 276e  {.            'n
+0001a130: 6f5f 736c 6173 685f 6578 636c 7564 6564  o_slash_excluded
+0001a140: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0001a150: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
+0001a160: 6465 642e 7478 7427 3a20 4e6f 6e65 2c0a  ded.txt': None,.
+0001a170: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+0001a180: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0001a190: 2020 2771 7565 7374 696f 6e5f 6d61 726b    'question_mark
+0001a1a0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0001a1b0: 2027 6578 636c 7564 6564 312e 7478 7427   'excluded1.txt'
+0001a1c0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0001a1d0: 2020 2020 2765 7863 6c75 6465 6440 2e74      'excluded@.t
+0001a1e0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+0001a1f0: 2020 207d 2c0a 2020 2020 2020 2020 2773     },.        's
+0001a200: 7175 6172 655f 6272 6163 6b65 7427 3a20  quare_bracket': 
+0001a210: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
+0001a220: 7863 6c75 6465 6431 2e74 7874 273a 204e  xcluded1.txt': N
+0001a230: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
+0001a240: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
+0001a250: 6272 6163 6b65 745f 616c 7068 6127 3a20  bracket_alpha': 
+0001a260: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
+0001a270: 7863 6c75 6465 647a 2e74 7874 273a 204e  xcludedz.txt': N
+0001a280: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
+0001a290: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
+0001a2a0: 6272 6163 6b65 745f 6578 636c 6127 3a20  bracket_excla': 
+0001a2b0: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
+0001a2c0: 7863 6c75 6465 6432 2e74 7874 273a 204e  xcluded2.txt': N
+0001a2d0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001a2e0: 2027 6578 636c 7564 6564 402e 7478 7427   'excluded@.txt'
+0001a2f0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0001a300: 7d2c 0a20 2020 2020 2020 2027 7371 7561  },.        'squa
+0001a310: 7265 5f62 7261 636b 6574 5f73 696e 676c  re_bracket_singl
+0001a320: 6527 3a20 7b0a 2020 2020 2020 2020 2020  e': {.          
+0001a330: 2020 2765 7863 6c75 6465 6430 2e74 7874    'excluded0.txt
+0001a340: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
+0001a350: 207d 2c0a 2020 2020 7d0a 0a20 2020 2040   },.    }..    @
+0001a360: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0001a370: 2064 6566 2063 7265 6174 655f 6469 725f   def create_dir_
+0001a380: 7374 7275 6374 7572 6528 6261 7365 5f70  structure(base_p
+0001a390: 6174 682c 2073 7472 7563 7475 7265 293a  ath, structure):
+0001a3a0: 0a20 2020 2020 2020 2023 2063 7265 6174  .        # creat
+0001a3b0: 6573 2061 2067 6976 656e 2066 696c 6520  es a given file 
+0001a3c0: 5354 5255 4354 5552 4520 696e 2042 4153  STRUCTURE in BAS
+0001a3d0: 455f 5041 5448 0a20 2020 2020 2020 2066  E_PATH.        f
+0001a3e0: 6f72 206e 616d 652c 2073 7562 7374 7275  or name, substru
+0001a3f0: 6374 7572 6520 696e 2073 7472 7563 7475  cture in structu
+0001a400: 7265 2e69 7465 6d73 2829 3a0a 2020 2020  re.items():.    
+0001a410: 2020 2020 2020 2020 7061 7468 203d 206f          path = o
+0001a420: 732e 7061 7468 2e6a 6f69 6e28 6261 7365  s.path.join(base
+0001a430: 5f70 6174 682c 206e 616d 6529 0a20 2020  _path, name).   
+0001a440: 2020 2020 2020 2020 2069 6620 7375 6273           if subs
+0001a450: 7472 7563 7475 7265 2069 7320 4e6f 6e65  tructure is None
+0001a460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a470: 2020 2320 4372 6561 7465 2061 2066 696c    # Create a fil
+0001a480: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0001a490: 2020 6f70 656e 2870 6174 682c 2027 6127    open(path, 'a'
+0001a4a0: 292e 636c 6f73 6528 290a 2020 2020 2020  ).close().      
+0001a4b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001a4c0: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0001a4d0: 6561 7465 2061 2073 7562 6469 7265 6374  eate a subdirect
+0001a4e0: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+0001a4f0: 2020 2020 6f73 2e6d 6b64 6972 2870 6174      os.mkdir(pat
+0001a500: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+0001a510: 2020 2054 6573 7453 746f 7261 6765 5769     TestStorageWi
+0001a520: 7468 4372 6564 656e 7469 616c 732e 6372  thCredentials.cr
+0001a530: 6561 7465 5f64 6972 5f73 7472 7563 7475  eate_dir_structu
+0001a540: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+0001a550: 2020 2020 2020 2020 7061 7468 2c20 7375          path, su
+0001a560: 6273 7472 7563 7475 7265 290a 0a20 2020  bstructure)..   
+0001a570: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0001a580: 2020 2064 6566 2063 6c69 5f64 656c 6574     def cli_delet
+0001a590: 655f 636d 6428 7374 6f72 655f 7479 7065  e_cmd(store_type
+0001a5a0: 2c20 6275 636b 6574 5f6e 616d 6529 3a0a  , bucket_name):.
+0001a5b0: 2020 2020 2020 2020 6966 2073 746f 7265          if store
+0001a5c0: 5f74 7970 6520 3d3d 2073 746f 7261 6765  _type == storage
+0001a5d0: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+0001a5e0: 333a 0a20 2020 2020 2020 2020 2020 2075  3:.            u
+0001a5f0: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
+0001a600: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
+0001a610: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+0001a620: 6177 7320 7333 2072 6220 7b75 726c 7d20  aws s3 rb {url} 
+0001a630: 2d2d 666f 7263 6527 0a20 2020 2020 2020  --force'.       
+0001a640: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+0001a650: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+0001a660: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
+0001a670: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+0001a680: 2767 733a 2f2f 7b62 7563 6b65 745f 6e61  'gs://{bucket_na
+0001a690: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+0001a6a0: 2067 7375 7469 6c5f 616c 6961 732c 2061   gsutil_alias, a
+0001a6b0: 6c69 6173 5f67 656e 203d 2064 6174 615f  lias_gen = data_
+0001a6c0: 7574 696c 732e 6765 745f 6773 7574 696c  utils.get_gsutil
+0001a6d0: 5f63 6f6d 6d61 6e64 2829 0a20 2020 2020  _command().     
+0001a6e0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+0001a6f0: 7b61 6c69 6173 5f67 656e 7d3b 207b 6773  {alias_gen}; {gs
+0001a700: 7574 696c 5f61 6c69 6173 7d20 726d 202d  util_alias} rm -
+0001a710: 7220 7b75 726c 7d27 0a20 2020 2020 2020  r {url}'.       
+0001a720: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
+0001a730: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+0001a740: 6f72 6554 7970 652e 5232 3a0a 2020 2020  oreType.R2:.    
+0001a750: 2020 2020 2020 2020 656e 6470 6f69 6e74          endpoint
+0001a760: 5f75 726c 203d 2063 6c6f 7564 666c 6172  _url = cloudflar
+0001a770: 652e 6372 6561 7465 5f65 6e64 706f 696e  e.create_endpoin
+0001a780: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0001a790: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
+0001a7a0: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+0001a7b0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001a7c0: 2741 5753 5f53 4841 5245 445f 4352 4544  'AWS_SHARED_CRED
+0001a7d0: 454e 5449 414c 535f 4649 4c45 3d7b 636c  ENTIALS_FILE={cl
+0001a7e0: 6f75 6466 6c61 7265 2e52 325f 4352 4544  oudflare.R2_CRED
+0001a7f0: 454e 5449 414c 535f 5041 5448 7d20 6177  ENTIALS_PATH} aw
+0001a800: 7320 7333 2072 6220 7b75 726c 7d20 2d2d  s s3 rb {url} --
+0001a810: 666f 7263 6520 2d2d 656e 6470 6f69 6e74  force --endpoint
+0001a820: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0001a830: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
+0001a840: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+0001a850: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+0001a860: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+0001a870: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
+0001a880: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+0001a890: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
+0001a8a0: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
+0001a8b0: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
+0001a8c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001a8d0: 2020 6275 636b 6574 5f6e 616d 652c 2052    bucket_name, R
+0001a8e0: 636c 6f6e 652e 5263 6c6f 6e65 436c 6f75  clone.RcloneClou
+0001a8f0: 6473 2e49 424d 290a 2020 2020 2020 2020  ds.IBM).        
+0001a900: 2020 2020 7265 7475 726e 2066 2772 636c      return f'rcl
+0001a910: 6f6e 6520 7075 7267 6520 7b62 7563 6b65  one purge {bucke
+0001a920: 745f 7263 6c6f 6e65 5f70 726f 6669 6c65  t_rclone_profile
+0001a930: 7d3a 7b62 7563 6b65 745f 6e61 6d65 7d20  }:{bucket_name} 
+0001a940: 2626 2072 636c 6f6e 6520 636f 6e66 6967  && rclone config
+0001a950: 2064 656c 6574 6520 7b62 7563 6b65 745f   delete {bucket_
+0001a960: 7263 6c6f 6e65 5f70 726f 6669 6c65 7d27  rclone_profile}'
+0001a970: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+0001a980: 686f 640a 2020 2020 6465 6620 636c 695f  hod.    def cli_
+0001a990: 6c73 5f63 6d64 2873 746f 7265 5f74 7970  ls_cmd(store_typ
+0001a9a0: 652c 2062 7563 6b65 745f 6e61 6d65 2c20  e, bucket_name, 
+0001a9b0: 7375 6666 6978 3d27 2729 3a0a 2020 2020  suffix=''):.    
+0001a9c0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+0001a9d0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+0001a9e0: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
+0001a9f0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+0001aa00: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
+0001aa10: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
+0001aa20: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0001aa30: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
+0001aa40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001aa50: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0001aa60: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
+0001aa70: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+0001aa80: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
+0001aa90: 7320 7333 206c 7320 7b75 726c 7d27 0a20  s s3 ls {url}'. 
+0001aaa0: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0001aab0: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+0001aac0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0001aad0: 533a 0a20 2020 2020 2020 2020 2020 2069  S:.            i
+0001aae0: 6620 7375 6666 6978 3a0a 2020 2020 2020  f suffix:.      
+0001aaf0: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+0001ab00: 6627 6773 3a2f 2f7b 6275 636b 6574 5f6e  f'gs://{bucket_n
+0001ab10: 616d 657d 2f7b 7375 6666 6978 7d27 0a20  ame}/{suffix}'. 
+0001ab20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001ab30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ab40: 2075 726c 203d 2066 2767 733a 2f2f 7b62   url = f'gs://{b
+0001ab50: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+0001ab60: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001ab70: 6627 6773 7574 696c 206c 7320 7b75 726c  f'gsutil ls {url
+0001ab80: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
+0001ab90: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
+0001aba0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001abb0: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
+0001abc0: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
+0001abd0: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
+0001abe0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
+0001abf0: 2020 2020 2020 2020 2020 6966 2073 7566            if suf
+0001ac00: 6669 783a 0a20 2020 2020 2020 2020 2020  fix:.           
+0001ac10: 2020 2020 2075 726c 203d 2066 2773 333a       url = f's3:
+0001ac20: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d2f  //{bucket_name}/
+0001ac30: 7b73 7566 6669 787d 270a 2020 2020 2020  {suffix}'.      
+0001ac40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001ac50: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+0001ac60: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+0001ac70: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0001ac80: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
+0001ac90: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0001aca0: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0001acb0: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0001acc0: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0001acd0: 206c 7320 7b75 726c 7d20 2d2d 656e 6470   ls {url} --endp
+0001ace0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
+0001acf0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
+0001ad00: 270a 2020 2020 2020 2020 6966 2073 746f  '.        if sto
+0001ad10: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0001ad20: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0001ad30: 2e49 424d 3a0a 2020 2020 2020 2020 2020  .IBM:.          
+0001ad40: 2020 6275 636b 6574 5f72 636c 6f6e 655f    bucket_rclone_
+0001ad50: 7072 6f66 696c 6520 3d20 5263 6c6f 6e65  profile = Rclone
+0001ad60: 2e67 656e 6572 6174 655f 7263 6c6f 6e65  .generate_rclone
+0001ad70: 5f62 7563 6b65 745f 7072 6f66 696c 655f  _bucket_profile_
+0001ad80: 6e61 6d65 280a 2020 2020 2020 2020 2020  name(.          
+0001ad90: 2020 2020 2020 6275 636b 6574 5f6e 616d        bucket_nam
+0001ada0: 652c 2052 636c 6f6e 652e 5263 6c6f 6e65  e, Rclone.Rclone
+0001adb0: 436c 6f75 6473 2e49 424d 290a 2020 2020  Clouds.IBM).    
+0001adc0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
+0001add0: 2772 636c 6f6e 6520 6c73 207b 6275 636b  'rclone ls {buck
+0001ade0: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
+0001adf0: 657d 3a7b 6275 636b 6574 5f6e 616d 657d  e}:{bucket_name}
+0001ae00: 2f7b 7375 6666 6978 7d27 0a0a 2020 2020  /{suffix}'..    
+0001ae10: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0001ae20: 2020 6465 6620 636c 695f 636f 756e 745f    def cli_count_
+0001ae30: 6e61 6d65 5f69 6e5f 6275 636b 6574 2873  name_in_bucket(s
+0001ae40: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+0001ae50: 745f 6e61 6d65 2c20 6669 6c65 5f6e 616d  t_name, file_nam
+0001ae60: 652c 2073 7566 6669 783d 2727 293a 0a20  e, suffix=''):. 
+0001ae70: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0001ae80: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+0001ae90: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0001aea0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0001aeb0: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
+0001aec0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001aed0: 6627 6177 7320 7333 6170 6920 6c69 7374  f'aws s3api list
+0001aee0: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0001aef0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0001af00: 2220 2d2d 7072 6566 6978 207b 7375 6666  " --prefix {suff
+0001af10: 6978 7d20 2d2d 7175 6572 7920 226c 656e  ix} --query "len
+0001af20: 6774 6828 436f 6e74 656e 7473 5b3f 636f  gth(Contents[?co
+0001af30: 6e74 6169 6e73 284b 6579 2c5c 277b 6669  ntains(Key,\'{fi
+0001af40: 6c65 5f6e 616d 657d 5c27 295d 2e4b 6579  le_name}\')].Key
+0001af50: 2922 270a 2020 2020 2020 2020 2020 2020  )"'.            
+0001af60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001af70: 2020 2020 2020 7265 7475 726e 2066 2761        return f'a
+0001af80: 7773 2073 3361 7069 206c 6973 742d 6f62  ws s3api list-ob
+0001af90: 6a65 6374 7320 2d2d 6275 636b 6574 2022  jects --bucket "
+0001afa0: 7b62 7563 6b65 745f 6e61 6d65 7d22 202d  {bucket_name}" -
+0001afb0: 2d71 7565 7279 2022 6c65 6e67 7468 2843  -query "length(C
+0001afc0: 6f6e 7465 6e74 735b 3f63 6f6e 7461 696e  ontents[?contain
+0001afd0: 7328 4b65 792c 5c27 7b66 696c 655f 6e61  s(Key,\'{file_na
+0001afe0: 6d65 7d5c 2729 5d2e 4b65 7929 2227 0a20  me}\')].Key)"'. 
+0001aff0: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
+0001b000: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
+0001b010: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001b020: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
+0001b030: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0001b040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001b050: 726e 2066 2767 7375 7469 6c20 6c73 202d  rn f'gsutil ls -
+0001b060: 7220 6773 3a2f 2f7b 6275 636b 6574 5f6e  r gs://{bucket_n
+0001b070: 616d 657d 2f7b 7375 6666 6978 7d20 7c20  ame}/{suffix} | 
+0001b080: 6772 6570 2022 7b66 696c 655f 6e61 6d65  grep "{file_name
+0001b090: 7d22 207c 2077 6320 2d6c 270a 2020 2020  }" | wc -l'.    
+0001b0a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001b0b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001b0c0: 7475 726e 2066 2767 7375 7469 6c20 6c73  turn f'gsutil ls
+0001b0d0: 202d 7220 6773 3a2f 2f7b 6275 636b 6574   -r gs://{bucket
+0001b0e0: 5f6e 616d 657d 207c 2067 7265 7020 227b  _name} | grep "{
+0001b0f0: 6669 6c65 5f6e 616d 657d 2220 7c20 7763  file_name}" | wc
+0001b100: 202d 6c27 0a20 2020 2020 2020 2065 6c69   -l'.        eli
+0001b110: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
+0001b120: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001b130: 6554 7970 652e 5232 3a0a 2020 2020 2020  eType.R2:.      
+0001b140: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
+0001b150: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
+0001b160: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
+0001b170: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001b180: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
+0001b190: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b1a0: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
+0001b1b0: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
+0001b1c0: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
+0001b1d0: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
+0001b1e0: 7773 2073 3361 7069 206c 6973 742d 6f62  ws s3api list-ob
+0001b1f0: 6a65 6374 7320 2d2d 6275 636b 6574 2022  jects --bucket "
+0001b200: 7b62 7563 6b65 745f 6e61 6d65 7d22 202d  {bucket_name}" -
+0001b210: 2d70 7265 6669 7820 7b73 7566 6669 787d  -prefix {suffix}
+0001b220: 202d 2d71 7565 7279 2022 6c65 6e67 7468   --query "length
+0001b230: 2843 6f6e 7465 6e74 735b 3f63 6f6e 7461  (Contents[?conta
+0001b240: 696e 7328 4b65 792c 5c27 7b66 696c 655f  ins(Key,\'{file_
+0001b250: 6e61 6d65 7d5c 2729 5d2e 4b65 7929 2220  name}\')].Key)" 
+0001b260: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
+0001b270: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
+0001b280: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
+0001b290: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001b2a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001b2b0: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
+0001b2c0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
+0001b2d0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
+0001b2e0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
+0001b2f0: 6177 7320 7333 6170 6920 6c69 7374 2d6f  aws s3api list-o
+0001b300: 626a 6563 7473 202d 2d62 7563 6b65 7420  bjects --bucket 
+0001b310: 227b 6275 636b 6574 5f6e 616d 657d 2220  "{bucket_name}" 
+0001b320: 2d2d 7175 6572 7920 226c 656e 6774 6828  --query "length(
+0001b330: 436f 6e74 656e 7473 5b3f 636f 6e74 6169  Contents[?contai
+0001b340: 6e73 284b 6579 2c5c 277b 6669 6c65 5f6e  ns(Key,\'{file_n
+0001b350: 616d 657d 5c27 295d 2e4b 6579 2922 202d  ame}\')].Key)" -
+0001b360: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0001b370: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0001b380: 6c65 3d72 3227 0a0a 2020 2020 4073 7461  le=r2'..    @sta
+0001b390: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+0001b3a0: 6620 636c 695f 636f 756e 745f 6669 6c65  f cli_count_file
+0001b3b0: 5f69 6e5f 6275 636b 6574 2873 746f 7265  _in_bucket(store
+0001b3c0: 5f74 7970 652c 2062 7563 6b65 745f 6e61  _type, bucket_na
+0001b3d0: 6d65 293a 0a20 2020 2020 2020 2069 6620  me):.        if 
+0001b3e0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0001b3f0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001b400: 7970 652e 5333 3a0a 2020 2020 2020 2020  ype.S3:.        
+0001b410: 2020 2020 7265 7475 726e 2066 2761 7773      return f'aws
+0001b420: 2073 3320 6c73 2073 333a 2f2f 7b62 7563   s3 ls s3://{buc
+0001b430: 6b65 745f 6e61 6d65 7d20 2d2d 7265 6375  ket_name} --recu
+0001b440: 7273 6976 6520 7c20 7763 202d 6c27 0a20  rsive | wc -l'. 
+0001b450: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
+0001b460: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
+0001b470: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001b480: 4743 533a 0a20 2020 2020 2020 2020 2020  GCS:.           
+0001b490: 2072 6574 7572 6e20 6627 6773 7574 696c   return f'gsutil
+0001b4a0: 206c 7320 2d72 2067 733a 2f2f 7b62 7563   ls -r gs://{buc
+0001b4b0: 6b65 745f 6e61 6d65 7d2f 2a2a 207c 2077  ket_name}/** | w
+0001b4c0: 6320 2d6c 270a 2020 2020 2020 2020 656c  c -l'.        el
+0001b4d0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0001b4e0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0001b4f0: 7265 5479 7065 2e52 323a 0a20 2020 2020  reType.R2:.     
+0001b500: 2020 2020 2020 2065 6e64 706f 696e 745f         endpoint_
+0001b510: 7572 6c20 3d20 636c 6f75 6466 6c61 7265  url = cloudflare
+0001b520: 2e63 7265 6174 655f 656e 6470 6f69 6e74  .create_endpoint
+0001b530: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
+0001b540: 6574 7572 6e20 6627 4157 535f 5348 4152  eturn f'AWS_SHAR
+0001b550: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
+0001b560: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
+0001b570: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
+0001b580: 4154 487d 2061 7773 2073 3320 6c73 2073  ATH} aws s3 ls s
+0001b590: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
+0001b5a0: 7d20 2d2d 7265 6375 7273 6976 6520 2d2d  } --recursive --
+0001b5b0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
+0001b5c0: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
+0001b5d0: 653d 7232 207c 2077 6320 2d6c 270a 0a20  e=r2 | wc -l'.. 
+0001b5e0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0001b5f0: 7265 0a20 2020 2064 6566 2074 6d70 5f73  re.    def tmp_s
+0001b600: 6f75 7263 6528 7365 6c66 2c20 746d 705f  ource(self, tmp_
+0001b610: 7061 7468 293a 0a20 2020 2020 2020 2023  path):.        #
+0001b620: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
+0001b630: 7261 7279 2064 6972 6563 746f 7279 2077  rary directory w
+0001b640: 6974 6820 6120 6669 6c65 2069 6e20 6974  ith a file in it
+0001b650: 0a20 2020 2020 2020 2074 6d70 5f64 6972  .        tmp_dir
+0001b660: 203d 2074 6d70 5f70 6174 6820 2f20 2774   = tmp_path / 't
+0001b670: 6d70 2d73 6f75 7263 6527 0a20 2020 2020  mp-source'.     
+0001b680: 2020 2074 6d70 5f64 6972 2e6d 6b64 6972     tmp_dir.mkdir
+0001b690: 2829 0a20 2020 2020 2020 2074 6d70 5f66  ().        tmp_f
+0001b6a0: 696c 6520 3d20 746d 705f 6469 7220 2f20  ile = tmp_dir / 
+0001b6b0: 2774 6d70 2d66 696c 6527 0a20 2020 2020  'tmp-file'.     
+0001b6c0: 2020 2074 6d70 5f66 696c 652e 7772 6974     tmp_file.writ
+0001b6d0: 655f 7465 7874 2827 7465 7374 2729 0a20  e_text('test'). 
+0001b6e0: 2020 2020 2020 2063 6972 636c 655f 6c69         circle_li
+0001b6f0: 6e6b 203d 2074 6d70 5f64 6972 202f 2027  nk = tmp_dir / '
+0001b700: 6369 7263 6c65 2d6c 696e 6b27 0a20 2020  circle-link'.   
+0001b710: 2020 2020 2063 6972 636c 655f 6c69 6e6b       circle_link
+0001b720: 2e73 796d 6c69 6e6b 5f74 6f28 746d 705f  .symlink_to(tmp_
+0001b730: 6469 722c 2074 6172 6765 745f 6973 5f64  dir, target_is_d
+0001b740: 6972 6563 746f 7279 3d54 7275 6529 0a20  irectory=True). 
+0001b750: 2020 2020 2020 2079 6965 6c64 2073 7472         yield str
+0001b760: 2874 6d70 5f64 6972 290a 0a20 2020 2040  (tmp_dir)..    @
+0001b770: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0001b780: 2020 2064 6566 2074 6d70 5f62 7563 6b65     def tmp_bucke
+0001b790: 745f 6e61 6d65 2873 656c 6629 3a0a 2020  t_name(self):.  
+0001b7a0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0001b7b0: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
+0001b7c0: 6574 206e 616d 650a 2020 2020 2020 2020  et name.        
+0001b7d0: 2320 7469 6d65 2e74 696d 6528 2920 7265  # time.time() re
+0001b7e0: 7475 726e 7320 7661 7279 696e 6720 7072  turns varying pr
+0001b7f0: 6563 6973 696f 6e20 6f6e 2064 6966 6665  ecision on diffe
+0001b800: 7265 6e74 2073 7973 7465 6d73 2c20 736f  rent systems, so
+0001b810: 2077 650a 2020 2020 2020 2020 2320 7265   we.        # re
+0001b820: 706c 6163 6520 7468 6520 6465 6369 6d61  place the decima
+0001b830: 6c20 706f 696e 7420 616e 6420 7573 6520  l point and use 
+0001b840: 7768 6174 6576 6572 2070 7265 6369 7369  whatever precisi
+0001b850: 6f6e 2077 6520 6361 6e20 6765 742e 0a20  on we can get.. 
+0001b860: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
+0001b870: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
+0001b880: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
+0001b890: 2027 2729 0a20 2020 2020 2020 2079 6965   '').        yie
+0001b8a0: 6c64 2066 2773 6b79 2d74 6573 742d 7b74  ld f'sky-test-{t
+0001b8b0: 696d 6573 7461 6d70 7d27 0a0a 2020 2020  imestamp}'..    
+0001b8c0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
+0001b8d0: 2020 6465 6620 7969 656c 645f 7374 6f72    def yield_stor
+0001b8e0: 6167 655f 6f62 6a65 6374 280a 2020 2020  age_object(.    
+0001b8f0: 2020 2020 2020 2020 6e61 6d65 3a20 4f70          name: Op
+0001b900: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+0001b910: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001b920: 736f 7572 6365 3a20 4f70 7469 6f6e 616c  source: Optional
+0001b930: 5b73 746f 7261 6765 5f6c 6962 2e50 6174  [storage_lib.Pat
+0001b940: 685d 203d 204e 6f6e 652c 0a20 2020 2020  h] = None,.     
+0001b950: 2020 2020 2020 2073 746f 7265 733a 204f         stores: O
+0001b960: 7074 696f 6e61 6c5b 4469 6374 5b73 746f  ptional[Dict[sto
+0001b970: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0001b980: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+0001b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b9a0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+0001b9b0: 622e 4162 7374 7261 6374 5374 6f72 655d  b.AbstractStore]
+0001b9c0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0001b9d0: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
+0001b9e0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+0001b9f0: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+0001ba00: 2020 2020 206d 6f64 653a 2073 746f 7261       mode: stora
+0001ba10: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
+0001ba20: 6465 203d 2073 746f 7261 6765 5f6c 6962  de = storage_lib
+0001ba30: 2e53 746f 7261 6765 4d6f 6465 2e4d 4f55  .StorageMode.MOU
+0001ba40: 4e54 293a 0a20 2020 2020 2020 2023 2043  NT):.        # C
+0001ba50: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
+0001ba60: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
+0001ba70: 742e 2053 746f 7265 7320 6d75 7374 2062  t. Stores must b
+0001ba80: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+0001ba90: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
+0001baa0: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+0001bab0: 6765 5f6c 6962 2e53 746f 7261 6765 286e  ge_lib.Storage(n
+0001bac0: 616d 653d 6e61 6d65 2c0a 2020 2020 2020  ame=name,.      
+0001bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001baf0: 2020 2020 736f 7572 6365 3d73 6f75 7263      source=sourc
+0001bb00: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb20: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+0001bb30: 7265 733d 7374 6f72 6573 2c0a 2020 2020  res=stores,.    
+0001bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb60: 2020 2020 2020 7065 7273 6973 7465 6e74        persistent
+0001bb70: 3d70 6572 7369 7374 656e 742c 0a20 2020  =persistent,.   
+0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bba0: 2020 2020 2020 206d 6f64 653d 6d6f 6465         mode=mode
+0001bbb0: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0001bbc0: 7374 6f72 6167 655f 6f62 6a0a 2020 2020  storage_obj.    
+0001bbd0: 2020 2020 6861 6e64 6c65 203d 2067 6c6f      handle = glo
+0001bbe0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
+0001bbf0: 6574 5f68 616e 646c 655f 6672 6f6d 5f73  et_handle_from_s
+0001bc00: 746f 7261 6765 5f6e 616d 6528 0a20 2020  torage_name(.   
+0001bc10: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+0001bc20: 5f6f 626a 2e6e 616d 6529 0a20 2020 2020  _obj.name).     
+0001bc30: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
+0001bc40: 2020 2020 2020 2020 2020 2320 4966 2068            # If h
+0001bc50: 616e 646c 6520 6578 6973 7473 2c20 6465  andle exists, de
+0001bc60: 6c65 7465 206d 616e 7561 6c6c 790a 2020  lete manually.  
+0001bc70: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+0001bc80: 2872 6f6d 696c 6229 3a20 5468 6973 2069  (romilb): This i
+0001bc90: 7320 706f 7465 6e74 6961 6c6c 7920 7269  s potentially ri
+0001bca0: 736b 7920 2d20 6966 2074 6865 2064 656c  sky - if the del
+0001bcb0: 6574 6520 6d65 7468 6f64 2068 6173 0a20  ete method has. 
+0001bcc0: 2020 2020 2020 2020 2020 2023 2020 2062             #   b
+0001bcd0: 7567 732c 2074 6869 7320 6361 6e20 6361  ugs, this can ca
+0001bce0: 7573 6520 7265 736f 7572 6365 206c 6561  use resource lea
+0001bcf0: 6b73 2e20 4964 6561 6c6c 7920 7765 2073  ks. Ideally we s
+0001bd00: 686f 756c 6420 6d61 6e75 616c 6c79 0a20  hould manually. 
+0001bd10: 2020 2020 2020 2020 2020 2023 2020 2065             #   e
+0001bd20: 6a65 6374 2073 746f 7261 6765 2066 726f  ject storage fro
+0001bd30: 6d20 676c 6f62 616c 5f75 7365 725f 7374  m global_user_st
+0001bd40: 6174 6520 616e 6420 6465 6c65 7465 2074  ate and delete t
+0001bd50: 6865 2062 7563 6b65 7420 7573 696e 670a  he bucket using.
+0001bd60: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0001bd70: 626f 746f 3320 6469 7265 6374 6c79 2e0a  boto3 directly..
+0001bd80: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0001bd90: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
+0001bda0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0001bdb0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0001bdc0: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0001bdd0: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0001bde0: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0001bdf0: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0001be00: 6120 7374 6f72 6167 6520 6f62 6a65 6374  a storage object
+0001be10: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
+0001be20: 746f 2063 7265 6174 6520 6120 7363 7261  to create a scra
+0001be30: 7463 6820 7374 6f72 6167 652e 0a20 2020  tch storage..   
+0001be40: 2020 2020 2023 2053 746f 7265 7320 6d75       # Stores mu
+0001be50: 7374 2062 6520 6164 6465 6420 696e 2074  st be added in t
+0001be60: 6865 2074 6573 742e 0a20 2020 2020 2020  he test..       
+0001be70: 2079 6965 6c64 2066 726f 6d20 7365 6c66   yield from self
+0001be80: 2e79 6965 6c64 5f73 746f 7261 6765 5f6f  .yield_storage_o
+0001be90: 626a 6563 7428 6e61 6d65 3d74 6d70 5f62  bject(name=tmp_b
+0001bea0: 7563 6b65 745f 6e61 6d65 290a 0a20 2020  ucket_name)..   
+0001beb0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0001bec0: 0a20 2020 2064 6566 2074 6d70 5f6d 756c  .    def tmp_mul
+0001bed0: 7469 706c 655f 7363 7261 7463 685f 7374  tiple_scratch_st
+0001bee0: 6f72 6167 655f 6f62 6a28 7365 6c66 293a  orage_obj(self):
+0001bef0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001bf00: 6573 2061 206c 6973 7420 6f66 2035 2073  es a list of 5 s
+0001bf10: 746f 7261 6765 206f 626a 6563 7473 2077  torage objects w
+0001bf20: 6974 6820 6e6f 2073 6f75 7263 6520 746f  ith no source to
+0001bf30: 2063 7265 6174 650a 2020 2020 2020 2020   create.        
+0001bf40: 2320 6d75 6c74 6970 6c65 2073 6372 6174  # multiple scrat
+0001bf50: 6368 2073 746f 7261 6765 732e 0a20 2020  ch storages..   
+0001bf60: 2020 2020 2023 2053 746f 7265 7320 666f       # Stores fo
+0001bf70: 7220 6561 6368 206f 626a 6563 7420 696e  r each object in
+0001bf80: 2074 6865 206c 6973 7420 6d75 7374 2062   the list must b
+0001bf90: 6520 6164 6465 6420 696e 2074 6865 2074  e added in the t
+0001bfa0: 6573 742e 0a20 2020 2020 2020 2073 746f  est..        sto
+0001bfb0: 7261 6765 5f6d 756c 745f 6f62 6a20 3d20  rage_mult_obj = 
+0001bfc0: 5b5d 0a20 2020 2020 2020 2066 6f72 205f  [].        for _
+0001bfd0: 2069 6e20 7261 6e67 6528 3529 3a0a 2020   in range(5):.  
+0001bfe0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+0001bff0: 616d 7020 3d20 7374 7228 7469 6d65 2e74  amp = str(time.t
+0001c000: 696d 6528 2929 2e72 6570 6c61 6365 2827  ime()).replace('
+0001c010: 2e27 2c20 2727 290a 2020 2020 2020 2020  .', '').        
+0001c020: 2020 2020 7374 6f72 655f 6f62 6a20 3d20      store_obj = 
+0001c030: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001c040: 6167 6528 6e61 6d65 3d66 2773 6b79 2d74  age(name=f'sky-t
+0001c050: 6573 742d 7b74 696d 6573 7461 6d70 7d27  est-{timestamp}'
+0001c060: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0001c070: 6f72 6167 655f 6d75 6c74 5f6f 626a 2e61  orage_mult_obj.a
+0001c080: 7070 656e 6428 7374 6f72 655f 6f62 6a29  ppend(store_obj)
+0001c090: 0a20 2020 2020 2020 2079 6965 6c64 2073  .        yield s
+0001c0a0: 746f 7261 6765 5f6d 756c 745f 6f62 6a0a  torage_mult_obj.
+0001c0b0: 2020 2020 2020 2020 666f 7220 7374 6f72          for stor
+0001c0c0: 6167 655f 6f62 6a20 696e 2073 746f 7261  age_obj in stora
+0001c0d0: 6765 5f6d 756c 745f 6f62 6a3a 0a20 2020  ge_mult_obj:.   
+0001c0e0: 2020 2020 2020 2020 2068 616e 646c 6520           handle 
+0001c0f0: 3d20 676c 6f62 616c 5f75 7365 725f 7374  = global_user_st
+0001c100: 6174 652e 6765 745f 6861 6e64 6c65 5f66  ate.get_handle_f
+0001c110: 726f 6d5f 7374 6f72 6167 655f 6e61 6d65  rom_storage_name
+0001c120: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001c130: 2020 7374 6f72 6167 655f 6f62 6a2e 6e61    storage_obj.na
+0001c140: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0001c150: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
+0001c160: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0001c170: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
+0001c180: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
+0001c190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001c1a0: 2054 4f44 4f28 726f 6d69 6c62 293a 2054   TODO(romilb): T
+0001c1b0: 6869 7320 6973 2070 6f74 656e 7469 616c  his is potential
+0001c1c0: 6c79 2072 6973 6b79 202d 2069 6620 7468  ly risky - if th
+0001c1d0: 6520 6465 6c65 7465 206d 6574 686f 6420  e delete method 
+0001c1e0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+0001c1f0: 2020 2020 2320 6275 6773 2c20 7468 6973      # bugs, this
+0001c200: 2063 616e 2063 6175 7365 2072 6573 6f75   can cause resou
+0001c210: 7263 6520 6c65 616b 732e 2049 6465 616c  rce leaks. Ideal
+0001c220: 6c79 2077 6520 7368 6f75 6c64 206d 616e  ly we should man
+0001c230: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
+0001c240: 2020 2020 2020 2320 656a 6563 7420 7374        # eject st
+0001c250: 6f72 6167 6520 6672 6f6d 2067 6c6f 6261  orage from globa
+0001c260: 6c5f 7573 6572 5f73 7461 7465 2061 6e64  l_user_state and
+0001c270: 2064 656c 6574 6520 7468 6520 6275 636b   delete the buck
+0001c280: 6574 2075 7369 6e67 0a20 2020 2020 2020  et using.       
+0001c290: 2020 2020 2020 2020 2023 2062 6f74 6f33           # boto3
+0001c2a0: 2064 6972 6563 746c 792e 0a20 2020 2020   directly..     
+0001c2b0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0001c2c0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+0001c2d0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0001c2e0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0001c2f0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+0001c300: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
+0001c310: 6b65 745f 6e61 6d65 2c20 746d 705f 736f  ket_name, tmp_so
+0001c320: 7572 6365 293a 0a20 2020 2020 2020 2023  urce):.        #
+0001c330: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
+0001c340: 7261 7279 2073 746f 7261 6765 206f 626a  rary storage obj
+0001c350: 6563 742e 2053 746f 7265 7320 6d75 7374  ect. Stores must
+0001c360: 2062 6520 6164 6465 6420 696e 2074 6865   be added in the
+0001c370: 2074 6573 742e 0a20 2020 2020 2020 2079   test..        y
+0001c380: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0001c390: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0001c3a0: 6563 7428 6e61 6d65 3d74 6d70 5f62 7563  ect(name=tmp_buc
+0001c3b0: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3e0: 2020 2020 2020 2073 6f75 7263 653d 746d         source=tm
+0001c3f0: 705f 736f 7572 6365 290a 0a20 2020 2040  p_source)..    @
+0001c400: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0001c410: 2020 2064 6566 2074 6d70 5f6c 6f63 616c     def tmp_local
+0001c420: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
+0001c430: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
+0001c440: 6574 5f6e 616d 652c 2074 6d70 5f73 6f75  et_name, tmp_sou
+0001c450: 7263 6529 3a0a 2020 2020 2020 2020 2320  rce):.        # 
+0001c460: 4372 6561 7465 7320 6120 7465 6d70 2073  Creates a temp s
+0001c470: 746f 7261 6765 206f 626a 6563 7420 7768  torage object wh
+0001c480: 6963 6820 7573 6573 2061 206c 6973 7420  ich uses a list 
+0001c490: 6f66 2070 6174 6873 2061 7320 736f 7572  of paths as sour
+0001c4a0: 6365 2e0a 2020 2020 2020 2020 2320 5374  ce..        # St
+0001c4b0: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
+0001c4c0: 6564 2069 6e20 7468 6520 7465 7374 2e20  ed in the test. 
+0001c4d0: 4166 7465 7220 7570 6c6f 6164 2c20 7468  After upload, th
+0001c4e0: 6520 6275 636b 6574 2073 686f 756c 640a  e bucket should.
+0001c4f0: 2020 2020 2020 2020 2320 6861 7665 2074          # have t
+0001c500: 776f 2066 696c 6573 202d 202f 746d 702d  wo files - /tmp-
+0001c510: 6669 6c65 2061 6e64 202f 746d 702d 736f  file and /tmp-so
+0001c520: 7572 6365 2f74 6d70 2d66 696c 650a 2020  urce/tmp-file.  
+0001c530: 2020 2020 2020 6c69 7374 5f73 6f75 7263        list_sourc
+0001c540: 6520 3d20 5b74 6d70 5f73 6f75 7263 652c  e = [tmp_source,
+0001c550: 2074 6d70 5f73 6f75 7263 6520 2b20 272f   tmp_source + '/
+0001c560: 746d 702d 6669 6c65 275d 0a20 2020 2020  tmp-file'].     
+0001c570: 2020 2079 6965 6c64 2066 726f 6d20 7365     yield from se
+0001c580: 6c66 2e79 6965 6c64 5f73 746f 7261 6765  lf.yield_storage
+0001c590: 5f6f 626a 6563 7428 6e61 6d65 3d74 6d70  _object(name=tmp
+0001c5a0: 5f62 7563 6b65 745f 6e61 6d65 2c0a 2020  _bucket_name,.  
+0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5d0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0001c5e0: 653d 6c69 7374 5f73 6f75 7263 6529 0a0a  e=list_source)..
+0001c5f0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
+0001c600: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
+0001c610: 6275 6c6b 5f64 656c 5f73 746f 7261 6765  bulk_del_storage
+0001c620: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0001c630: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
+0001c640: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0001c650: 2074 656d 706f 7261 7279 2073 746f 7261   temporary stora
+0001c660: 6765 206f 626a 6563 7420 666f 7220 7465  ge object for te
+0001c670: 7374 696e 6720 6275 6c6b 2064 656c 6574  sting bulk delet
+0001c680: 696f 6e2e 0a20 2020 2020 2020 2023 2053  ion..        # S
+0001c690: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
+0001c6a0: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
+0001c6b0: 0a20 2020 2020 2020 2077 6974 6820 7465  .        with te
+0001c6c0: 6d70 6669 6c65 2e54 656d 706f 7261 7279  mpfile.Temporary
+0001c6d0: 4469 7265 6374 6f72 7928 2920 6173 2074  Directory() as t
+0001c6e0: 6d70 6469 723a 0a20 2020 2020 2020 2020  mpdir:.         
+0001c6f0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0001c700: 6563 6b5f 6f75 7470 7574 2866 276d 6b64  eck_output(f'mkd
+0001c710: 6972 202d 7020 7b74 6d70 6469 727d 2f66  ir -p {tmpdir}/f
+0001c720: 6f6c 6465 727b 7b30 3030 2e2e 3235 357d  older{{000..255}
+0001c730: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0001c740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c750: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
+0001c760: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0001c770: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001c780: 5f6f 7574 7075 7428 6627 746f 7563 6820  _output(f'touch 
+0001c790: 7b74 6d70 6469 727d 2f74 6573 747b 7b30  {tmpdir}/test{{0
+0001c7a0: 3030 2e2e 3235 357d 7d2e 7478 7427 2c0a  00..255}}.txt',.
+0001c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c7d0: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0001c7e0: 2020 2020 2020 2020 2020 2020 7375 6270              subp
+0001c7f0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0001c800: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+0001c810: 2020 2020 2066 2774 6f75 6368 207b 746d       f'touch {tm
+0001c820: 7064 6972 7d2f 666f 6c64 6572 7b7b 3030  pdir}/folder{{00
+0001c830: 302e 2e32 3535 7d7d 2f74 6573 742e 7478  0..255}}/test.tx
+0001c840: 7427 2c20 7368 656c 6c3d 5472 7565 290a  t', shell=True).
+0001c850: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+0001c860: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
+0001c870: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
+0001c880: 286e 616d 653d 746d 705f 6275 636b 6574  (name=tmp_bucket
+0001c890: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+0001c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8c0: 2020 2020 2020 2020 736f 7572 6365 3d74          source=t
+0001c8d0: 6d70 6469 7229 0a0a 2020 2020 4070 7974  mpdir)..    @pyt
+0001c8e0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0001c8f0: 6465 6620 746d 705f 636f 7079 5f6d 6e74  def tmp_copy_mnt
+0001c900: 5f65 7869 7374 696e 675f 7374 6f72 6167  _existing_storag
+0001c910: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0001c920: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
+0001c930: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+0001c940: 4372 6561 7465 7320 6120 636f 7079 206d  Creates a copy m
+0001c950: 6f75 6e74 2073 746f 7261 6765 2077 6869  ount storage whi
+0001c960: 6368 2072 6575 7365 7320 616e 2065 7869  ch reuses an exi
+0001c970: 7374 696e 6720 7374 6f72 6167 6520 6f62  sting storage ob
+0001c980: 6a65 6374 2e0a 2020 2020 2020 2020 746d  ject..        tm
+0001c990: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0001c9a0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+0001c9b0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001c9c0: 6554 7970 652e 5333 290a 2020 2020 2020  eType.S3).      
+0001c9d0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
+0001c9e0: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0001c9f0: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
+0001ca00: 2020 2020 2020 2023 2054 7279 2074 6f20         # Try to 
+0001ca10: 696e 6974 6961 6c69 7a65 2061 6e6f 7468  initialize anoth
+0001ca20: 6572 2073 746f 7261 6765 2077 6974 6820  er storage with 
+0001ca30: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
+0001ca40: 6374 2063 7265 6174 6564 0a20 2020 2020  ct created.     
+0001ca50: 2020 2023 2061 626f 7665 2c20 6275 7420     # above, but 
+0001ca60: 6e6f 7720 696e 2043 4f50 5920 6d6f 6465  now in COPY mode
+0001ca70: 2e20 5468 6973 2073 686f 756c 6420 7375  . This should su
+0001ca80: 6363 6565 642e 0a20 2020 2020 2020 2079  cceed..        y
+0001ca90: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0001caa0: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0001cab0: 6563 7428 6e61 6d65 3d73 746f 7261 6765  ect(name=storage
+0001cac0: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+0001cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001caf0: 2020 2020 6d6f 6465 3d73 746f 7261 6765      mode=storage
+0001cb00: 5f6c 6962 2e53 746f 7261 6765 4d6f 6465  _lib.StorageMode
+0001cb10: 2e43 4f50 5929 0a0a 2020 2020 4070 7974  .COPY)..    @pyt
+0001cb20: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0001cb30: 6465 6620 746d 705f 6769 7469 676e 6f72  def tmp_gitignor
+0001cb40: 655f 7374 6f72 6167 655f 6f62 6a28 7365  e_storage_obj(se
+0001cb50: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
+0001cb60: 616d 652c 2067 6974 6967 6e6f 7265 5f73  ame, gitignore_s
+0001cb70: 7472 7563 7475 7265 293a 0a20 2020 2020  tructure):.     
+0001cb80: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+0001cb90: 656d 706f 7261 7279 2073 746f 7261 6765  emporary storage
+0001cba0: 206f 626a 6563 7420 666f 7220 7465 7374   object for test
+0001cbb0: 696e 6720 2e67 6974 6967 6e6f 7265 2066  ing .gitignore f
+0001cbc0: 696c 7465 722e 0a20 2020 2020 2020 2023  ilter..        #
+0001cbd0: 2047 4954 4947 494e 4f52 455f 5354 5255   GITIGINORE_STRU
+0001cbe0: 4354 5552 4520 6973 2072 6570 7265 7365  CTURE is represe
+0001cbf0: 6e74 696e 6720 6120 6669 6c65 2073 7472  nting a file str
+0001cc00: 7563 7475 7265 2069 6e20 6120 6469 6374  ucture in a dict
+0001cc10: 696f 6e61 7279 0a20 2020 2020 2020 2023  ionary.        #
+0001cc20: 2066 6f72 616d 742e 2043 7265 6174 6564   foramt. Created
+0001cc30: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0001cc40: 7769 6c6c 2063 6f6e 7461 696e 2074 6865  will contain the
+0001cc50: 2066 696c 6520 7374 7275 6374 7572 6520   file structure 
+0001cc60: 616c 6f6e 670a 2020 2020 2020 2020 2320  along.        # 
+0001cc70: 7769 7468 202e 6769 7469 676e 6f72 6520  with .gitignore 
+0001cc80: 616e 6420 2e67 6974 2f69 6e66 6f2f 6578  and .git/info/ex
+0001cc90: 636c 7564 6520 6669 6c65 7320 746f 2074  clude files to t
+0001cca0: 6573 7420 6578 636c 7564 6520 6669 6c74  est exclude filt
+0001ccb0: 6572 2e0a 2020 2020 2020 2020 2320 5374  er..        # St
+0001ccc0: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
+0001ccd0: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
+0001cce0: 2020 2020 2020 2020 7769 7468 2074 656d          with tem
+0001ccf0: 7066 696c 652e 5465 6d70 6f72 6172 7944  pfile.TemporaryD
+0001cd00: 6972 6563 746f 7279 2829 2061 7320 746d  irectory() as tm
+0001cd10: 7064 6972 3a0a 2020 2020 2020 2020 2020  pdir:.          
+0001cd20: 2020 2320 4372 6561 7465 7320 6669 6c65    # Creates file
+0001cd30: 2073 7472 7563 7475 7265 2074 6f20 6265   structure to be
+0001cd40: 2075 706c 6f61 6465 6420 696e 2074 6865   uploaded in the
+0001cd50: 2053 746f 7261 6765 0a20 2020 2020 2020   Storage.       
+0001cd60: 2020 2020 2073 656c 662e 6372 6561 7465       self.create
+0001cd70: 5f64 6972 5f73 7472 7563 7475 7265 2874  _dir_structure(t
+0001cd80: 6d70 6469 722c 2067 6974 6967 6e6f 7265  mpdir, gitignore
+0001cd90: 5f73 7472 7563 7475 7265 290a 0a20 2020  _structure)..   
+0001cda0: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
+0001cdb0: 6520 2e67 6974 6967 6e6f 7265 2061 6e64  e .gitignore and
+0001cdc0: 206c 6973 7420 6669 6c65 732f 6469 7273   list files/dirs
+0001cdd0: 2074 6f20 6265 2065 7863 6c75 6465 6420   to be excluded 
+0001cde0: 696e 2069 740a 2020 2020 2020 2020 2020  in it.          
+0001cdf0: 2020 736b 7970 696c 6f74 5f70 6174 6820    skypilot_path 
+0001ce00: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
+0001ce10: 6528 6f73 2e70 6174 682e 6469 726e 616d  e(os.path.dirnam
+0001ce20: 6528 736b 792e 5f5f 6669 6c65 5f5f 2929  e(sky.__file__))
+0001ce30: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0001ce40: 705f 7061 7468 203d 2066 277b 746d 7064  p_path = f'{tmpd
+0001ce50: 6972 7d2f 2e67 6974 6967 6e6f 7265 270a  ir}/.gitignore'.
+0001ce60: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+0001ce70: 5f70 6174 6820 3d20 6f73 2e70 6174 682e  _path = os.path.
+0001ce80: 6a6f 696e 2873 6b79 7069 6c6f 745f 7061  join(skypilot_pa
+0001ce90: 7468 2c20 2774 6573 7473 2f67 6974 6967  th, 'tests/gitig
+0001cea0: 6e6f 7265 5f74 6573 7427 290a 2020 2020  nore_test').    
+0001ceb0: 2020 2020 2020 2020 7368 7574 696c 2e63          shutil.c
+0001cec0: 6f70 7966 696c 6528 6669 6c65 5f70 6174  opyfile(file_pat
+0001ced0: 682c 2074 656d 705f 7061 7468 290a 0a20  h, temp_path).. 
+0001cee0: 2020 2020 2020 2020 2020 2023 2043 7265             # Cre
+0001cef0: 6174 6520 2e67 6974 2f69 6e66 6f2f 6578  ate .git/info/ex
+0001cf00: 636c 7564 6520 616e 6420 6c69 7374 2066  clude and list f
+0001cf10: 696c 6573 2f64 6972 7320 746f 2062 6520  iles/dirs to be 
+0001cf20: 6578 636c 7564 6564 2069 6e20 6974 0a20  excluded in it. 
+0001cf30: 2020 2020 2020 2020 2020 2074 656d 705f             temp_
+0001cf40: 7061 7468 203d 2066 277b 746d 7064 6972  path = f'{tmpdir
+0001cf50: 7d2f 2e67 6974 2f69 6e66 6f2f 270a 2020  }/.git/info/'.  
+0001cf60: 2020 2020 2020 2020 2020 6f73 2e6d 616b            os.mak
+0001cf70: 6564 6972 7328 7465 6d70 5f70 6174 6829  edirs(temp_path)
+0001cf80: 0a20 2020 2020 2020 2020 2020 2074 656d  .            tem
+0001cf90: 705f 6578 636c 7564 655f 7061 7468 203d  p_exclude_path =
+0001cfa0: 206f 732e 7061 7468 2e6a 6f69 6e28 7465   os.path.join(te
+0001cfb0: 6d70 5f70 6174 682c 2027 6578 636c 7564  mp_path, 'exclud
+0001cfc0: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
+0001cfd0: 6669 6c65 5f70 6174 6820 3d20 6f73 2e70  file_path = os.p
+0001cfe0: 6174 682e 6a6f 696e 2873 6b79 7069 6c6f  ath.join(skypilo
+0001cff0: 745f 7061 7468 2c0a 2020 2020 2020 2020  t_path,.        
+0001d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d010: 2020 2020 2020 2020 2020 2020 2027 7465               'te
+0001d020: 7374 732f 6769 745f 696e 666f 5f65 7863  sts/git_info_exc
+0001d030: 6c75 6465 5f74 6573 7427 290a 2020 2020  lude_test').    
+0001d040: 2020 2020 2020 2020 7368 7574 696c 2e63          shutil.c
+0001d050: 6f70 7966 696c 6528 6669 6c65 5f70 6174  opyfile(file_pat
+0001d060: 682c 2074 656d 705f 6578 636c 7564 655f  h, temp_exclude_
+0001d070: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
+0001d080: 2020 2023 2043 7265 6174 6520 736b 7920     # Create sky 
+0001d090: 5374 6f72 6167 6520 7769 7468 2074 6865  Storage with the
+0001d0a0: 2066 696c 6573 2063 7265 6174 6564 0a20   files created. 
+0001d0b0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
+0001d0c0: 2066 726f 6d20 7365 6c66 2e79 6965 6c64   from self.yield
+0001d0d0: 5f73 746f 7261 6765 5f6f 626a 6563 7428  _storage_object(
+0001d0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d0f0: 206e 616d 653d 746d 705f 6275 636b 6574   name=tmp_bucket
+0001d100: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+0001d110: 2020 2020 2020 2073 6f75 7263 653d 746d         source=tm
+0001d120: 7064 6972 2c0a 2020 2020 2020 2020 2020  pdir,.          
+0001d130: 2020 2020 2020 6d6f 6465 3d73 746f 7261        mode=stora
+0001d140: 6765 5f6c 6962 2e53 746f 7261 6765 4d6f  ge_lib.StorageMo
+0001d150: 6465 2e43 4f50 5929 0a0a 2020 2020 4070  de.COPY)..    @p
+0001d160: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+0001d170: 2020 6465 6620 746d 705f 6177 7363 6c69    def tmp_awscli
+0001d180: 5f62 7563 6b65 7428 7365 6c66 2c20 746d  _bucket(self, tm
+0001d190: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
+0001d1a0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0001d1b0: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
+0001d1c0: 636b 6574 2075 7369 6e67 2061 7773 636c  cket using awscl
+0001d1d0: 690a 2020 2020 2020 2020 7375 6270 726f  i.        subpro
+0001d1e0: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0001d1f0: 5b27 6177 7327 2c20 2773 3327 2c20 276d  ['aws', 's3', 'm
+0001d200: 6227 2c20 6627 7333 3a2f 2f7b 746d 705f  b', f's3://{tmp_
+0001d210: 6275 636b 6574 5f6e 616d 657d 275d 290a  bucket_name}']).
+0001d220: 2020 2020 2020 2020 7969 656c 6420 746d          yield tm
+0001d230: 705f 6275 636b 6574 5f6e 616d 650a 2020  p_bucket_name.  
+0001d240: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0001d250: 2e63 6865 636b 5f63 616c 6c28 0a20 2020  .check_call(.   
+0001d260: 2020 2020 2020 2020 205b 2761 7773 272c           ['aws',
+0001d270: 2027 7333 272c 2027 7262 272c 2066 2773   's3', 'rb', f's
+0001d280: 333a 2f2f 7b74 6d70 5f62 7563 6b65 745f  3://{tmp_bucket_
+0001d290: 6e61 6d65 7d27 2c20 272d 2d66 6f72 6365  name}', '--force
+0001d2a0: 275d 290a 0a20 2020 2040 7079 7465 7374  '])..    @pytest
+0001d2b0: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
+0001d2c0: 2074 6d70 5f67 7375 7469 6c5f 6275 636b   tmp_gsutil_buck
+0001d2d0: 6574 2873 656c 662c 2074 6d70 5f62 7563  et(self, tmp_buc
+0001d2e0: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+0001d2f0: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+0001d300: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
+0001d310: 7573 696e 6720 6773 7574 696c 0a20 2020  using gsutil.   
+0001d320: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0001d330: 6368 6563 6b5f 6361 6c6c 285b 2767 7375  check_call(['gsu
+0001d340: 7469 6c27 2c20 276d 6227 2c20 6627 6773  til', 'mb', f'gs
+0001d350: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
+0001d360: 616d 657d 275d 290a 2020 2020 2020 2020  ame}']).        
+0001d370: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
+0001d380: 5f6e 616d 650a 2020 2020 2020 2020 7375  _name.        su
+0001d390: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0001d3a0: 616c 6c28 5b27 6773 7574 696c 272c 2027  all(['gsutil', '
+0001d3b0: 726d 272c 2027 2d72 272c 2066 2767 733a  rm', '-r', f'gs:
+0001d3c0: 2f2f 7b74 6d70 5f62 7563 6b65 745f 6e61  //{tmp_bucket_na
+0001d3d0: 6d65 7d27 5d29 0a0a 2020 2020 4070 7974  me}'])..    @pyt
+0001d3e0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0001d3f0: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
+0001d400: 7563 6b65 745f 7232 2873 656c 662c 2074  ucket_r2(self, t
+0001d410: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0001d420: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001d430: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
+0001d440: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
+0001d450: 6c69 0a20 2020 2020 2020 2065 6e64 706f  li.        endpo
+0001d460: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
+0001d470: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
+0001d480: 6f69 6e74 2829 0a20 2020 2020 2020 2073  oint().        s
+0001d490: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001d4a0: 6361 6c6c 280a 2020 2020 2020 2020 2020  call(.          
+0001d4b0: 2020 6627 4157 535f 5348 4152 4544 5f43    f'AWS_SHARED_C
+0001d4c0: 5245 4445 4e54 4941 4c53 5f46 494c 453d  REDENTIALS_FILE=
+0001d4d0: 7b63 6c6f 7564 666c 6172 652e 5232 5f43  {cloudflare.R2_C
+0001d4e0: 5245 4445 4e54 4941 4c53 5f50 4154 487d  REDENTIALS_PATH}
+0001d4f0: 2061 7773 2073 3320 6d62 2073 333a 2f2f   aws s3 mb s3://
+0001d500: 7b74 6d70 5f62 7563 6b65 745f 6e61 6d65  {tmp_bucket_name
+0001d510: 7d20 2d2d 656e 6470 6f69 6e74 207b 656e  } --endpoint {en
+0001d520: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0001d530: 6f66 696c 653d 7232 272c 0a20 2020 2020  ofile=r2',.     
+0001d540: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
+0001d550: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0001d560: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0001d570: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0001d580: 6573 732e 6368 6563 6b5f 6361 6c6c 280a  ess.check_call(.
+0001d590: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
+0001d5a0: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
+0001d5b0: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
+0001d5c0: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
+0001d5d0: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
+0001d5e0: 3320 7262 2073 333a 2f2f 7b74 6d70 5f62  3 rb s3://{tmp_b
+0001d5f0: 7563 6b65 745f 6e61 6d65 7d20 2d2d 666f  ucket_name} --fo
+0001d600: 7263 6520 2d2d 656e 6470 6f69 6e74 207b  rce --endpoint {
+0001d610: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
+0001d620: 7072 6f66 696c 653d 7232 272c 0a20 2020  profile=r2',.   
+0001d630: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+0001d640: 7275 6529 0a0a 2020 2020 4070 7974 6573  rue)..    @pytes
+0001d650: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0001d660: 6620 746d 705f 6962 6d5f 636f 735f 6275  f tmp_ibm_cos_bu
+0001d670: 636b 6574 2873 656c 662c 2074 6d70 5f62  cket(self, tmp_b
+0001d680: 7563 6b65 745f 6e61 6d65 293a 0a20 2020  ucket_name):.   
+0001d690: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+0001d6a0: 2074 656d 706f 7261 7279 2062 7563 6b65   temporary bucke
+0001d6b0: 7420 7573 696e 6720 4942 4d20 434f 5320  t using IBM COS 
+0001d6c0: 4150 490a 2020 2020 2020 2020 7374 6f72  API.        stor
+0001d6d0: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
+0001d6e0: 655f 6c69 622e 4942 4d43 6f73 5374 6f72  e_lib.IBMCosStor
+0001d6f0: 6528 736f 7572 6365 3d22 222c 206e 616d  e(source="", nam
+0001d700: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
+0001d710: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0001d720: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0001d730: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0001d740: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
+0001d750: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0001d760: 7265 0a20 2020 2064 6566 2074 6d70 5f70  re.    def tmp_p
+0001d770: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+0001d780: 6a28 7365 6c66 2c20 7265 7175 6573 7429  j(self, request)
+0001d790: 3a0a 2020 2020 2020 2020 2320 496e 6974  :.        # Init
+0001d7a0: 6961 6c69 7a65 7320 6120 7374 6f72 6167  ializes a storag
+0001d7b0: 6520 6f62 6a65 6374 2077 6974 6820 6120  e object with a 
+0001d7c0: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
+0001d7d0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0001d7e0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0001d7f0: 5374 6f72 6167 6528 736f 7572 6365 3d72  Storage(source=r
+0001d800: 6571 7565 7374 2e70 6172 616d 290a 2020  equest.param).  
+0001d810: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
+0001d820: 6167 655f 6f62 6a0a 2020 2020 2020 2020  age_obj.        
+0001d830: 2320 5468 6973 2064 6f65 7320 6e6f 7420  # This does not 
+0001d840: 7265 7175 6972 6520 616e 7920 6465 6c65  require any dele
+0001d850: 7469 6f6e 206c 6f67 6963 2062 6563 6175  tion logic becau
+0001d860: 7365 2069 7420 6973 2061 2070 7562 6c69  se it is a publi
+0001d870: 6320 6275 636b 6574 0a20 2020 2020 2020  c bucket.       
+0001d880: 2023 2061 6e64 2073 686f 756c 6420 6e6f   # and should no
+0001d890: 7420 6765 7420 6164 6465 6420 746f 2067  t get added to g
+0001d8a0: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+0001d8b0: 2e0a 0a20 2020 2040 7079 7465 7374 2e6d  ...    @pytest.m
+0001d8c0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0001d8d0: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
+0001d8e0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0001d8f0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0001d900: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0001d910: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
+0001d920: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0001d930: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+0001d940: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
+0001d950: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+0001d960: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+0001d970: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0001d980: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001d990: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0001d9a0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0001d9b0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0001d9c0: 2074 6573 745f 6e65 775f 6275 636b 6574   test_new_bucket
+0001d9d0: 5f63 7265 6174 696f 6e5f 616e 645f 6465  _creation_and_de
+0001d9e0: 6c65 7469 6f6e 2873 656c 662c 2074 6d70  letion(self, tmp
+0001d9f0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+0001da00: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
+0001da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da30: 2020 7374 6f72 655f 7479 7065 293a 0a20    store_type):. 
+0001da40: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0001da50: 2061 206e 6577 2062 7563 6b65 7420 7769   a new bucket wi
+0001da60: 7468 2061 206c 6f63 616c 2073 6f75 7263  th a local sourc
+0001da70: 652c 2075 706c 6f61 6473 2066 696c 6573  e, uploads files
+0001da80: 2074 6f20 6974 0a20 2020 2020 2020 2023   to it.        #
+0001da90: 2061 6e64 2064 656c 6574 6573 2069 742e   and deletes it.
+0001daa0: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
+0001dab0: 616c 5f73 746f 7261 6765 5f6f 626a 2e61  al_storage_obj.a
+0001dac0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
+0001dad0: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
+0001dae0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0001daf0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
+0001db00: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
+0001db10: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
+0001db20: 7574 0a20 2020 2020 2020 206f 7574 203d  ut.        out =
+0001db30: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0001db40: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
+0001db50: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
+0001db60: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
+0001db70: 7420 746d 705f 6c6f 6361 6c5f 7374 6f72  t tmp_local_stor
+0001db80: 6167 655f 6f62 6a2e 6e61 6d65 2069 6e20  age_obj.name in 
+0001db90: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0001dba0: 3827 290a 0a20 2020 2020 2020 2023 2052  8')..        # R
+0001dbb0: 756e 2073 6b79 2073 746f 7261 6765 2064  un sky storage d
+0001dbc0: 656c 6574 6520 746f 2064 656c 6574 6520  elete to delete 
+0001dbd0: 7468 6520 7374 6f72 6167 6520 6f62 6a65  the storage obje
+0001dbe0: 6374 0a20 2020 2020 2020 2073 7562 7072  ct.        subpr
+0001dbf0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0001dc00: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+0001dc10: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0001dc20: 272c 2027 6465 6c65 7465 272c 2074 6d70  ', 'delete', tmp
+0001dc30: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+0001dc40: 626a 2e6e 616d 655d 290a 0a20 2020 2020  bj.name])..     
+0001dc50: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0001dc60: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0001dc70: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0001dc80: 6374 2069 7320 6465 6c65 7465 640a 2020  ct is deleted.  
+0001dc90: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0001dca0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0001dcb0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0001dcc0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0001dcd0: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
+0001dce0: 5f6c 6f63 616c 5f73 746f 7261 6765 5f6f  _local_storage_o
+0001dcf0: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+0001dd00: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+0001dd10: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
+0001dd20: 6d61 726b 2e78 6469 7374 5f67 726f 7570  mark.xdist_group
+0001dd30: 2827 6d75 6c74 6970 6c65 5f62 7563 6b65  ('multiple_bucke
+0001dd40: 745f 6465 6c65 7469 6f6e 2729 0a20 2020  t_deletion').   
+0001dd50: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+0001dd60: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
+0001dd70: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
+0001dd80: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+0001dd90: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
+0001dda0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001ddb0: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
+0001ddc0: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0001ddd0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001dde0: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
+0001ddf0: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+0001de00: 7265 292c 0a20 2020 2020 2020 2070 7974  re),.        pyt
+0001de10: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0001de20: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001de30: 4942 4d2c 206d 6172 6b73 3d70 7974 6573  IBM, marks=pytes
+0001de40: 742e 6d61 726b 2e69 626d 290a 2020 2020  t.mark.ibm).    
+0001de50: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
+0001de60: 6d75 6c74 6970 6c65 5f62 7563 6b65 7473  multiple_buckets
+0001de70: 5f63 7265 6174 696f 6e5f 616e 645f 6465  _creation_and_de
+0001de80: 6c65 7469 6f6e 280a 2020 2020 2020 2020  letion(.        
+0001de90: 2020 2020 7365 6c66 2c20 746d 705f 6d75      self, tmp_mu
+0001dea0: 6c74 6970 6c65 5f73 6372 6174 6368 5f73  ltiple_scratch_s
+0001deb0: 746f 7261 6765 5f6f 626a 2c20 7374 6f72  torage_obj, stor
+0001dec0: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+0001ded0: 2023 2043 7265 6174 6573 206d 756c 7469   # Creates multi
+0001dee0: 706c 6520 6e65 7720 6275 636b 6574 7328  ple new buckets(
+0001def0: 3520 6275 636b 6574 7329 2077 6974 6820  5 buckets) with 
+0001df00: 6120 6c6f 6361 6c20 736f 7572 6365 0a20  a local source. 
+0001df10: 2020 2020 2020 2023 2061 6e64 2064 656c         # and del
+0001df20: 6574 6573 2074 6865 6d2e 0a20 2020 2020  etes them..     
+0001df30: 2020 2073 746f 7261 6765 5f6f 626a 5f6e     storage_obj_n
+0001df40: 616d 6520 3d20 5b5d 0a20 2020 2020 2020  ame = [].       
+0001df50: 2066 6f72 2073 746f 7265 5f6f 626a 2069   for store_obj i
+0001df60: 6e20 746d 705f 6d75 6c74 6970 6c65 5f73  n tmp_multiple_s
+0001df70: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0001df80: 626a 3a0a 2020 2020 2020 2020 2020 2020  bj:.            
+0001df90: 7374 6f72 655f 6f62 6a2e 6164 645f 7374  store_obj.add_st
+0001dfa0: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+0001dfb0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0001dfc0: 6167 655f 6f62 6a5f 6e61 6d65 2e61 7070  age_obj_name.app
+0001dfd0: 656e 6428 7374 6f72 655f 6f62 6a2e 6e61  end(store_obj.na
+0001dfe0: 6d65 290a 0a20 2020 2020 2020 2023 2052  me)..        # R
+0001dff0: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
+0001e000: 7320 746f 2063 6865 636b 2069 6620 616c  s to check if al
+0001e010: 6c20 7374 6f72 6167 6520 6f62 6a65 6374  l storage object
+0001e020: 7320 6578 6973 7473 2069 6e20 7468 650a  s exists in the.
+0001e030: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
+0001e040: 2066 696c 7465 7265 6420 6279 2073 746f   filtered by sto
+0001e050: 7265 2074 7970 650a 2020 2020 2020 2020  re type.        
+0001e060: 6f75 745f 616c 6c20 3d20 7375 6270 726f  out_all = subpro
+0001e070: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0001e080: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+0001e090: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
+0001e0a0: 2020 2020 6f75 7420 3d20 5b0a 2020 2020      out = [.    
+0001e0b0: 2020 2020 2020 2020 6974 656d 2e73 706c          item.spl
+0001e0c0: 6974 2829 5b30 5d0a 2020 2020 2020 2020  it()[0].        
+0001e0d0: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
+0001e0e0: 6f75 745f 616c 6c2e 6465 636f 6465 2827  out_all.decode('
+0001e0f0: 7574 662d 3827 292e 7370 6c69 746c 696e  utf-8').splitlin
+0001e100: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+0001e110: 2069 6620 7374 6f72 655f 7479 7065 2e76   if store_type.v
+0001e120: 616c 7565 2069 6e20 6974 656d 0a20 2020  alue in item.   
+0001e130: 2020 2020 205d 0a20 2020 2020 2020 2061       ].        a
+0001e140: 7373 6572 7420 616c 6c28 5b69 7465 6d20  ssert all([item 
+0001e150: 696e 206f 7574 2066 6f72 2069 7465 6d20  in out for item 
+0001e160: 696e 2073 746f 7261 6765 5f6f 626a 5f6e  in storage_obj_n
+0001e170: 616d 655d 290a 0a20 2020 2020 2020 2023  ame])..        #
+0001e180: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0001e190: 2064 656c 6574 6520 616c 6c20 746f 2064   delete all to d
+0001e1a0: 656c 6574 6520 616c 6c20 7374 6f72 6167  elete all storag
+0001e1b0: 6520 6f62 6a65 6374 730a 2020 2020 2020  e objects.      
+0001e1c0: 2020 6465 6c65 7465 5f63 6d64 203d 205b    delete_cmd = [
+0001e1d0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0001e1e0: 2c20 2764 656c 6574 6527 5d0a 2020 2020  , 'delete'].    
+0001e1f0: 2020 2020 6465 6c65 7465 5f63 6d64 202b      delete_cmd +
+0001e200: 3d20 7374 6f72 6167 655f 6f62 6a5f 6e61  = storage_obj_na
+0001e210: 6d65 0a20 2020 2020 2020 2073 7562 7072  me.        subpr
+0001e220: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0001e230: 7574 2864 656c 6574 655f 636d 6429 0a0a  ut(delete_cmd)..
+0001e240: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0001e250: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0001e260: 6368 6563 6b20 6966 2061 6c6c 2073 746f  check if all sto
+0001e270: 7261 6765 206f 626a 6563 7473 2066 696c  rage objects fil
+0001e280: 7465 7265 6420 6279 2073 746f 7265 0a20  tered by store. 
+0001e290: 2020 2020 2020 2023 2074 7970 6520 6172         # type ar
+0001e2a0: 6520 6465 6c65 7465 640a 2020 2020 2020  e deleted.      
+0001e2b0: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0001e2c0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0001e2d0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0001e2e0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0001e2f0: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0001e300: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0001e310: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0001e320: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0001e330: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0001e340: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0001e350: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0001e360: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0001e370: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0001e380: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0001e390: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0001e3a0: 6d20 6e6f 7420 696e 206f 7574 2066 6f72  m not in out for
+0001e3b0: 2069 7465 6d20 696e 2073 746f 7261 6765   item in storage
+0001e3c0: 5f6f 626a 5f6e 616d 655d 290a 0a20 2020  _obj_name])..   
+0001e3d0: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+0001e3e0: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
+0001e3f0: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
+0001e400: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
+0001e410: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
+0001e420: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001e430: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
+0001e440: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0001e450: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001e460: 652e 4942 4d2c 206d 6172 6b73 3d70 7974  e.IBM, marks=pyt
+0001e470: 6573 742e 6d61 726b 2e69 626d 292c 0a20  est.mark.ibm),. 
+0001e480: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0001e490: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0001e4a0: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
+0001e4b0: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0001e4c0: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
+0001e4d0: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
+0001e4e0: 6275 636b 6574 5f65 7874 6572 6e61 6c5f  bucket_external_
+0001e4f0: 6465 6c65 7469 6f6e 2873 656c 662c 2074  deletion(self, t
+0001e500: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0001e510: 6765 5f6f 626a 2c0a 2020 2020 2020 2020  ge_obj,.        
+0001e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e530: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001e540: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
+0001e550: 2020 2023 2043 7265 6174 6573 2061 2062     # Creates a b
+0001e560: 7563 6b65 742c 2064 656c 6574 6573 2069  ucket, deletes i
+0001e570: 7420 6578 7465 726e 616c 6c79 2075 7369  t externally usi
+0001e580: 6e67 2063 6c6f 7564 2063 6c69 2063 6f6d  ng cloud cli com
+0001e590: 6d61 6e64 730a 2020 2020 2020 2020 2320  mands.        # 
+0001e5a0: 616e 6420 7468 656e 2074 7269 6573 2074  and then tries t
+0001e5b0: 6f20 6465 6c65 7465 2069 7420 7573 696e  o delete it usin
+0001e5c0: 6720 736b 7920 7374 6f72 6167 6520 6465  g sky storage de
+0001e5d0: 6c65 7465 2e0a 2020 2020 2020 2020 746d  lete..        tm
+0001e5e0: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+0001e5f0: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+0001e600: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
+0001e610: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
+0001e620: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
+0001e630: 636b 2069 6620 7374 6f72 6167 6520 6f62  ck if storage ob
+0001e640: 6a65 6374 2065 7869 7374 7320 696e 2074  ject exists in t
+0001e650: 6865 206f 7574 7075 740a 2020 2020 2020  he output.      
+0001e660: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+0001e670: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0001e680: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0001e690: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0001e6a0: 2020 6173 7365 7274 2074 6d70 5f73 6372    assert tmp_scr
+0001e6b0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0001e6c0: 2e6e 616d 6520 696e 206f 7574 2e64 6563  .name in out.dec
+0001e6d0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
+0001e6e0: 2020 2020 2020 2320 4465 6c65 7465 2062        # Delete b
+0001e6f0: 7563 6b65 7420 6578 7465 726e 616c 6c79  ucket externally
+0001e700: 0a20 2020 2020 2020 2063 6d64 203d 2073  .        cmd = s
+0001e710: 656c 662e 636c 695f 6465 6c65 7465 5f63  elf.cli_delete_c
+0001e720: 6d64 2873 746f 7265 5f74 7970 652c 2074  md(store_type, t
+0001e730: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0001e740: 6765 5f6f 626a 2e6e 616d 6529 0a20 2020  ge_obj.name).   
+0001e750: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0001e760: 6368 6563 6b5f 6f75 7470 7574 2863 6d64  check_output(cmd
+0001e770: 2c20 7368 656c 6c3d 5472 7565 290a 0a20  , shell=True).. 
+0001e780: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0001e790: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
+0001e7a0: 746f 2064 656c 6574 6520 7468 6520 7374  to delete the st
+0001e7b0: 6f72 6167 6520 6f62 6a65 6374 0a20 2020  orage object.   
+0001e7c0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0001e7d0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0001e7e0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+0001e7f0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0001e800: 272c 2027 6465 6c65 7465 272c 2074 6d70  ', 'delete', tmp
+0001e810: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0001e820: 5f6f 626a 2e6e 616d 655d 290a 2020 2020  _obj.name]).    
+0001e830: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
+0001e840: 6275 636b 6574 2077 6173 206e 6f74 2063  bucket was not c
+0001e850: 7265 6174 6564 2064 7572 696e 6720 6465  reated during de
+0001e860: 6c65 7469 6f6e 2028 7365 6520 6973 7375  letion (see issu
+0001e870: 6520 2331 3332 3229 0a20 2020 2020 2020  e #1322).       
+0001e880: 2061 7373 6572 7420 2763 7265 6174 6564   assert 'created
+0001e890: 2720 6e6f 7420 696e 206f 7574 2e64 6563  ' not in out.dec
+0001e8a0: 6f64 6528 2775 7466 2d38 2729 2e6c 6f77  ode('utf-8').low
+0001e8b0: 6572 2829 0a0a 2020 2020 2020 2020 2320  er()..        # 
+0001e8c0: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0001e8d0: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
+0001e8e0: 746f 7261 6765 206f 626a 6563 7420 6973  torage object is
+0001e8f0: 2064 656c 6574 6564 0a20 2020 2020 2020   deleted.       
+0001e900: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0001e910: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0001e920: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0001e930: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0001e940: 2061 7373 6572 7420 746d 705f 7363 7261   assert tmp_scra
+0001e950: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
+0001e960: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
+0001e970: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+0001e980: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0001e990: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
+0001e9a0: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
+0001e9b0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+0001e9c0: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
+0001e9d0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001e9e0: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
+0001e9f0: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0001ea00: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001ea10: 6554 7970 652e 4942 4d2c 206d 6172 6b73  eType.IBM, marks
+0001ea20: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+0001ea30: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
+0001ea40: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0001ea50: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0001ea60: 2c20 6d61 726b 733d 7079 7465 7374 2e6d  , marks=pytest.m
+0001ea70: 6172 6b2e 636c 6f75 6466 6c61 7265 290a  ark.cloudflare).
+0001ea80: 2020 2020 5d29 0a20 2020 2064 6566 2074      ]).    def t
+0001ea90: 6573 745f 6275 636b 6574 5f62 756c 6b5f  est_bucket_bulk_
+0001eaa0: 6465 6c65 7469 6f6e 2873 656c 662c 2073  deletion(self, s
+0001eab0: 746f 7265 5f74 7970 652c 2074 6d70 5f62  tore_type, tmp_b
+0001eac0: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
+0001ead0: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+0001eae0: 4372 6561 7465 7320 6120 7465 6d70 2066  Creates a temp f
+0001eaf0: 6f6c 6465 7220 7769 7468 206f 7665 7220  older with over 
+0001eb00: 3235 3620 6669 6c65 7320 616e 6420 666f  256 files and fo
+0001eb10: 6c64 6572 732c 2075 706c 6f61 640a 2020  lders, upload.  
+0001eb20: 2020 2020 2020 2320 6669 6c65 7320 616e        # files an
+0001eb30: 6420 666f 6c64 6572 7320 746f 2061 206e  d folders to a n
+0001eb40: 6577 2062 7563 6b65 742c 2074 6865 6e20  ew bucket, then 
+0001eb50: 6465 6c65 7465 2062 7563 6b65 742e 0a20  delete bucket.. 
+0001eb60: 2020 2020 2020 2074 6d70 5f62 756c 6b5f         tmp_bulk_
+0001eb70: 6465 6c5f 7374 6f72 6167 655f 6f62 6a2e  del_storage_obj.
+0001eb80: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+0001eb90: 7479 7065 290a 0a20 2020 2020 2020 2073  type)..        s
+0001eba0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001ebb0: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0001ebc0: 2020 2020 5b27 736b 7927 2c20 2773 746f      ['sky', 'sto
+0001ebd0: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
+0001ebe0: 2074 6d70 5f62 756c 6b5f 6465 6c5f 7374   tmp_bulk_del_st
+0001ebf0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 5d29  orage_obj.name])
+0001ec00: 0a0a 2020 2020 2020 2020 6f75 7470 7574  ..        output
+0001ec10: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0001ec20: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0001ec30: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0001ec40: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
+0001ec50: 6572 7420 746d 705f 6275 6c6b 5f64 656c  ert tmp_bulk_del
+0001ec60: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0001ec70: 6520 6e6f 7420 696e 206f 7574 7075 742e  e not in output.
+0001ec80: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+0001ec90: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0001eca0: 6b2e 7061 7261 6d65 7472 697a 6528 0a20  k.parametrize(. 
+0001ecb0: 2020 2020 2020 2027 746d 705f 7075 626c         'tmp_publ
+0001ecc0: 6963 5f73 746f 7261 6765 5f6f 626a 2c20  ic_storage_obj, 
+0001ecd0: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
+0001ece0: 2020 2020 205b 2827 7333 3a2f 2f74 6367       [('s3://tcg
+0001ecf0: 612d 322d 6f70 656e 272c 2073 746f 7261  a-2-open', stora
+0001ed00: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0001ed10: 2e53 3329 2c0a 2020 2020 2020 2020 2028  .S3),.         (
+0001ed20: 2773 333a 2f2f 6469 6769 7461 6c63 6f72  's3://digitalcor
+0001ed30: 706f 7261 272c 2073 746f 7261 6765 5f6c  pora', storage_l
+0001ed40: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+0001ed50: 2c0a 2020 2020 2020 2020 2028 2767 733a  ,.         ('gs:
+0001ed60: 2f2f 6763 702d 7075 626c 6963 2d64 6174  //gcp-public-dat
+0001ed70: 612d 7365 6e74 696e 656c 2d32 272c 2073  a-sentinel-2', s
+0001ed80: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0001ed90: 5479 7065 2e47 4353 295d 2c0a 2020 2020  Type.GCS)],.    
+0001eda0: 2020 2020 696e 6469 7265 6374 3d5b 2774      indirect=['t
+0001edb0: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
+0001edc0: 655f 6f62 6a27 5d29 0a20 2020 2064 6566  e_obj']).    def
+0001edd0: 2074 6573 745f 7075 626c 6963 5f62 7563   test_public_buc
+0001ede0: 6b65 7428 7365 6c66 2c20 746d 705f 7075  ket(self, tmp_pu
+0001edf0: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
+0001ee00: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
+0001ee10: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0001ee20: 2061 206e 6577 2062 7563 6b65 7420 7769   a new bucket wi
+0001ee30: 7468 2061 2070 7562 6c69 6320 736f 7572  th a public sour
+0001ee40: 6365 2061 6e64 2076 6572 6966 6965 7320  ce and verifies 
+0001ee50: 7468 6174 2069 7420 6973 206e 6f74 0a20  that it is not. 
+0001ee60: 2020 2020 2020 2023 2061 6464 6564 2074         # added t
+0001ee70: 6f20 676c 6f62 616c 5f75 7365 725f 7374  o global_user_st
+0001ee80: 6174 652e 0a20 2020 2020 2020 2074 6d70  ate..        tmp
+0001ee90: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0001eea0: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0001eeb0: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0001eec0: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0001eed0: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0001eee0: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0001eef0: 6374 2065 7869 7374 7320 696e 2074 6865  ct exists in the
+0001ef00: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
+0001ef10: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+0001ef20: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+0001ef30: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+0001ef40: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+0001ef50: 6173 7365 7274 2074 6d70 5f70 7562 6c69  assert tmp_publi
+0001ef60: 635f 7374 6f72 6167 655f 6f62 6a2e 6e61  c_storage_obj.na
+0001ef70: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
+0001ef80: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
+0001ef90: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+0001efa0: 7061 7261 6d65 7472 697a 6528 276e 6f6e  parametrize('non
+0001efb0: 6578 6973 745f 6275 636b 6574 5f75 726c  exist_bucket_url
+0001efc0: 272c 205b 0a20 2020 2020 2020 2027 7333  ', [.        's3
+0001efd0: 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d 657d  ://{random_name}
+0001efe0: 272c 2027 6773 3a2f 2f7b 7261 6e64 6f6d  ', 'gs://{random
+0001eff0: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
+0001f000: 2070 7974 6573 742e 7061 7261 6d28 2763   pytest.param('c
+0001f010: 6f73 3a2f 2f75 732d 6561 7374 2f7b 7261  os://us-east/{ra
+0001f020: 6e64 6f6d 5f6e 616d 657d 272c 206d 6172  ndom_name}', mar
+0001f030: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+0001f040: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+0001f050: 6573 742e 7061 7261 6d28 2772 323a 2f2f  est.param('r2://
+0001f060: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
+0001f070: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+0001f080: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
+0001f090: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
+0001f0a0: 745f 6e6f 6e65 7869 7374 656e 745f 6275  t_nonexistent_bu
+0001f0b0: 636b 6574 2873 656c 662c 206e 6f6e 6578  cket(self, nonex
+0001f0c0: 6973 745f 6275 636b 6574 5f75 726c 293a  ist_bucket_url):
+0001f0d0: 0a20 2020 2020 2020 2023 2041 7474 656d  .        # Attem
+0001f0e0: 7074 7320 746f 2063 7265 6174 6520 6665  pts to create fe
+0001f0f0: 7463 6820 6120 7374 726f 6167 6520 7769  tch a stroage wi
+0001f100: 7468 2061 206e 6f6e 2d65 7869 7374 656e  th a non-existen
+0001f110: 7420 736f 7572 6365 2e0a 2020 2020 2020  t source..      
+0001f120: 2020 2320 4765 6e65 7261 7465 2061 2072    # Generate a r
+0001f130: 616e 646f 6d20 6275 636b 6574 206e 616d  andom bucket nam
+0001f140: 6520 616e 6420 7665 7269 6679 2069 7420  e and verify it 
+0001f150: 646f 6573 6e27 7420 6578 6973 743a 0a20  doesn't exist:. 
+0001f160: 2020 2020 2020 2072 6574 7279 5f63 6f75         retry_cou
+0001f170: 6e74 203d 2030 0a20 2020 2020 2020 2077  nt = 0.        w
+0001f180: 6869 6c65 2054 7275 653a 0a20 2020 2020  hile True:.     
+0001f190: 2020 2020 2020 206e 6f6e 6578 6973 745f         nonexist_
+0001f1a0: 6275 636b 6574 5f6e 616d 6520 3d20 7374  bucket_name = st
+0001f1b0: 7228 7575 6964 2e75 7569 6434 2829 290a  r(uuid.uuid4()).
+0001f1c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0001f1d0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+0001f1e0: 726c 2e73 7461 7274 7377 6974 6828 2773  rl.startswith('s
+0001f1f0: 3327 293a 0a20 2020 2020 2020 2020 2020  3'):.           
+0001f200: 2020 2020 2063 6f6d 6d61 6e64 203d 2066       command = f
+0001f210: 2761 7773 2073 3361 7069 2068 6561 642d  'aws s3api head-
+0001f220: 6275 636b 6574 202d 2d62 7563 6b65 7420  bucket --bucket 
+0001f230: 7b6e 6f6e 6578 6973 745f 6275 636b 6574  {nonexist_bucket
+0001f240: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0001f250: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+0001f260: 5f6f 7574 7075 7420 3d20 2734 3034 270a  _output = '404'.
+0001f270: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0001f280: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
+0001f290: 5f75 726c 2e73 7461 7274 7377 6974 6828  _url.startswith(
+0001f2a0: 2767 7327 293a 0a20 2020 2020 2020 2020  'gs'):.         
+0001f2b0: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
+0001f2c0: 2066 2767 7375 7469 6c20 6c73 207b 6e6f   f'gsutil ls {no
+0001f2d0: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0001f2e0: 6c2e 666f 726d 6174 2872 616e 646f 6d5f  l.format(random_
+0001f2f0: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
+0001f300: 636b 6574 5f6e 616d 6529 7d27 0a20 2020  cket_name)}'.   
+0001f310: 2020 2020 2020 2020 2020 2020 2065 7870               exp
+0001f320: 6563 7465 645f 6f75 7470 7574 203d 2027  ected_output = '
+0001f330: 4275 636b 6574 4e6f 7446 6f75 6e64 4578  BucketNotFoundEx
+0001f340: 6365 7074 696f 6e27 0a20 2020 2020 2020  ception'.       
+0001f350: 2020 2020 2065 6c69 6620 6e6f 6e65 7869       elif nonexi
+0001f360: 7374 5f62 7563 6b65 745f 7572 6c2e 7374  st_bucket_url.st
+0001f370: 6172 7473 7769 7468 2827 7232 2729 3a0a  artswith('r2'):.
+0001f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f390: 656e 6470 6f69 6e74 5f75 726c 203d 2063  endpoint_url = c
+0001f3a0: 6c6f 7564 666c 6172 652e 6372 6561 7465  loudflare.create
+0001f3b0: 5f65 6e64 706f 696e 7428 290a 2020 2020  _endpoint().    
+0001f3c0: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+0001f3d0: 616e 6420 3d20 6627 4157 535f 5348 4152  and = f'AWS_SHAR
+0001f3e0: 4544 5f43 5245 4445 4e54 4941 4c53 5f46  ED_CREDENTIALS_F
+0001f3f0: 494c 453d 7b63 6c6f 7564 666c 6172 652e  ILE={cloudflare.
+0001f400: 5232 5f43 5245 4445 4e54 4941 4c53 5f50  R2_CREDENTIALS_P
+0001f410: 4154 487d 2061 7773 2073 3361 7069 2068  ATH} aws s3api h
+0001f420: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
+0001f430: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
+0001f440: 636b 6574 5f6e 616d 657d 202d 2d65 6e64  cket_name} --end
+0001f450: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+0001f460: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0001f470: 3227 0a20 2020 2020 2020 2020 2020 2020  2'.             
+0001f480: 2020 2065 7870 6563 7465 645f 6f75 7470     expected_outp
+0001f490: 7574 203d 2027 3430 3427 0a20 2020 2020  ut = '404'.     
+0001f4a0: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
+0001f4b0: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
+0001f4c0: 7374 6172 7473 7769 7468 2827 636f 7327  startswith('cos'
+0001f4d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001f4e0: 2020 2023 2055 7369 6e67 2041 5049 2063     # Using API c
+0001f4f0: 616c 6c73 2c20 7369 6e63 6520 7573 696e  alls, since usin
+0001f500: 6720 7263 6c6f 6e65 2072 6571 7569 7265  g rclone require
+0001f510: 7320 6120 7072 6f66 696c 6527 7320 6e61  s a profile's na
+0001f520: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
+0001f530: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001f540: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+0001f550: 6374 6564 5f6f 7574 7075 7420 3d20 636f  cted_output = co
+0001f560: 6d6d 616e 6420 3d20 2265 6368 6f22 2020  mmand = "echo"  
+0001f570: 2320 6176 6f69 6420 756e 7265 6c61 7465  # avoid unrelate
+0001f580: 6420 6578 6365 7074 696f 6e20 696e 2063  d exception in c
+0001f590: 6173 6520 6f66 2066 6169 6c75 7265 2e0a  ase of failure..
+0001f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5b0: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
+0001f5c0: 3d20 7572 6c6c 6962 2e70 6172 7365 2e75  = urllib.parse.u
+0001f5d0: 726c 7370 6c69 7428 0a20 2020 2020 2020  rlsplit(.       
+0001f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5f0: 206e 6f6e 6578 6973 745f 6275 636b 6574   nonexist_bucket
+0001f600: 5f75 726c 2e66 6f72 6d61 7428 0a20 2020  _url.format(.   
+0001f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f620: 2020 2020 2020 2020 2072 616e 646f 6d5f           random_
+0001f630: 6e61 6d65 3d6e 6f6e 6578 6973 745f 6275  name=nonexist_bu
+0001f640: 636b 6574 5f6e 616d 6529 292e 7061 7468  cket_name)).path
+0001f650: 2e73 7472 6970 2827 2f27 290a 2020 2020  .strip('/').    
+0001f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f670: 636c 6965 6e74 203d 2069 626d 2e67 6574  client = ibm.get
+0001f680: 5f63 6f73 5f63 6c69 656e 7428 2775 732d  _cos_client('us-
+0001f690: 6561 7374 2729 0a20 2020 2020 2020 2020  east').         
+0001f6a0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0001f6b0: 742e 6865 6164 5f62 7563 6b65 7428 4275  t.head_bucket(Bu
+0001f6c0: 636b 6574 3d62 7563 6b65 745f 6e61 6d65  cket=bucket_name
+0001f6d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001f6e0: 2020 6578 6365 7074 2069 626d 2e69 626d    except ibm.ibm
+0001f6f0: 5f62 6f74 6f63 6f72 652e 6578 6365 7074  _botocore.except
+0001f700: 696f 6e73 2e43 6c69 656e 7445 7272 6f72  ions.ClientError
+0001f710: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+0001f720: 2020 2020 2020 2020 2020 2069 6620 652e             if e.
+0001f730: 7265 7370 6f6e 7365 5b27 4572 726f 7227  response['Error'
+0001f740: 5d5b 2743 6f64 6527 5d20 3d3d 2027 3430  ]['Code'] == '40
+0001f750: 3427 3a0a 2020 2020 2020 2020 2020 2020  4':.            
+0001f760: 2020 2020 2020 2020 2020 2020 2320 7375              # su
+0001f770: 6363 6573 730a 2020 2020 2020 2020 2020  ccess.          
+0001f780: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001f790: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0001f7a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001f7b0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0001f7c0: 7565 4572 726f 7228 2755 6e73 7570 706f  ueError('Unsuppo
+0001f7d0: 7274 6564 2062 7563 6b65 7420 7479 7065  rted bucket type
+0001f7e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f800: 2020 2020 6627 7b6e 6f6e 6578 6973 745f      f'{nonexist_
+0001f810: 6275 636b 6574 5f75 726c 7d27 290a 0a20  bucket_url}').. 
+0001f820: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+0001f830: 636b 2069 6620 6275 636b 6574 2065 7869  ck if bucket exi
+0001f840: 7374 7320 7573 696e 6720 7468 6520 636c  sts using the cl
+0001f850: 693a 0a20 2020 2020 2020 2020 2020 2074  i:.            t
+0001f860: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001f870: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+0001f880: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+0001f890: 7428 636f 6d6d 616e 642c 0a20 2020 2020  t(command,.     
+0001f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f8c0: 2020 2020 2020 2020 2073 7464 6572 723d           stderr=
+0001f8d0: 7375 6270 726f 6365 7373 2e53 5444 4f55  subprocess.STDOU
+0001f8e0: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
+0001f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f910: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+0001f920: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0001f930: 7375 6270 726f 6365 7373 2e43 616c 6c65  subprocess.Calle
+0001f940: 6450 726f 6365 7373 4572 726f 7220 6173  dProcessError as
+0001f950: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0001f960: 2020 2020 6f75 7420 3d20 652e 6f75 7470      out = e.outp
+0001f970: 7574 0a20 2020 2020 2020 2020 2020 206f  ut.            o
+0001f980: 7574 203d 206f 7574 2e64 6563 6f64 6528  ut = out.decode(
+0001f990: 2775 7466 2d38 2729 0a20 2020 2020 2020  'utf-8').       
+0001f9a0: 2020 2020 2069 6620 6578 7065 6374 6564       if expected
+0001f9b0: 5f6f 7574 7075 7420 696e 206f 7574 3a0a  _output in out:.
+0001f9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f9d0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+0001f9e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001f9f0: 2020 2020 2020 2020 7265 7472 795f 636f          retry_co
+0001fa00: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
+0001fa10: 2020 2020 2020 2020 2069 6620 7265 7472           if retr
+0001fa20: 795f 636f 756e 7420 3e20 333a 0a20 2020  y_count > 3:.   
 0001fa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa60: 2827 7574 662d 3827 2929 0a0a 2020 2020  ('utf-8'))..    
-0001fa70: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-0001fa80: 616d 6574 7269 7a65 2827 696e 7661 6c69  ametrize('invali
-0001fa90: 645f 6e61 6d65 5f6c 6973 742c 2073 746f  d_name_list, sto
-0001faa0: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
-0001fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fac0: 2020 2020 2020 205b 2841 5753 5f49 4e56         [(AWS_INV
-0001fad0: 414c 4944 5f4e 414d 4553 2c20 7374 6f72  ALID_NAMES, stor
-0001fae0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-0001faf0: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
-0001fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb10: 2020 2020 2028 4743 535f 494e 5641 4c49       (GCS_INVALI
-0001fb20: 445f 4e41 4d45 532c 2073 746f 7261 6765  D_NAMES, storage
-0001fb30: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-0001fb40: 4353 292c 0a20 2020 2020 2020 2020 2020  CS),.           
-0001fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb60: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
-0001fb70: 4157 535f 494e 5641 4c49 445f 4e41 4d45  AWS_INVALID_NAME
-0001fb80: 532c 0a20 2020 2020 2020 2020 2020 2020  S,.             
-0001fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fba0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001fbb0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001fbc0: 7970 652e 5232 2c0a 2020 2020 2020 2020  ype.R2,.        
-0001fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbf0: 2020 206d 6172 6b73 3d70 7974 6573 742e     marks=pytest.
-0001fc00: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
-0001fc10: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
-0001fc20: 696e 7661 6c69 645f 6e61 6d65 7328 7365  invalid_names(se
-0001fc30: 6c66 2c20 696e 7661 6c69 645f 6e61 6d65  lf, invalid_name
-0001fc40: 5f6c 6973 742c 2073 746f 7265 5f74 7970  _list, store_typ
-0001fc50: 6529 3a0a 2020 2020 2020 2020 2320 5573  e):.        # Us
-0001fc60: 6573 2061 206c 6973 7420 696e 2074 6865  es a list in the
-0001fc70: 2073 6f75 7263 6520 6669 656c 6420 746f   source field to
-0001fc80: 2073 7065 6369 6679 2061 2066 696c 6520   specify a file 
-0001fc90: 616e 6420 6120 6469 7265 6374 6f72 7920  and a directory 
-0001fca0: 746f 0a20 2020 2020 2020 2023 2062 6520  to.        # be 
-0001fcb0: 7570 6c6f 6164 6564 2074 6f20 7468 6520  uploaded to the 
-0001fcc0: 7374 6f72 6167 6520 6f62 6a65 6374 2e0a  storage object..
-0001fcd0: 2020 2020 2020 2020 666f 7220 6e61 6d65          for name
-0001fce0: 2069 6e20 696e 7661 6c69 645f 6e61 6d65   in invalid_name
-0001fcf0: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
-0001fd00: 2020 2077 6974 6820 7079 7465 7374 2e72     with pytest.r
-0001fd10: 6169 7365 7328 736b 792e 6578 6365 7074  aises(sky.except
-0001fd20: 696f 6e73 2e53 746f 7261 6765 4e61 6d65  ions.StorageName
-0001fd30: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0001fd40: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0001fd50: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
-0001fd60: 622e 5374 6f72 6167 6528 6e61 6d65 3d6e  b.Storage(name=n
-0001fd70: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0001fd80: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0001fd90: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0001fda0: 5f74 7970 6529 0a0a 2020 2020 4070 7974  _type)..    @pyt
-0001fdb0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-0001fdc0: 7269 7a65 280a 2020 2020 2020 2020 2767  rize(.        'g
-0001fdd0: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
-0001fde0: 7265 2c20 7374 6f72 655f 7479 7065 272c  re, store_type',
-0001fdf0: 0a20 2020 2020 2020 205b 2847 4954 4947  .        [(GITIG
-0001fe00: 4e4f 5245 5f53 594e 435f 5445 5354 5f44  NORE_SYNC_TEST_D
-0001fe10: 4952 5f53 5452 5543 5455 5245 2c20 7374  IR_STRUCTURE, st
-0001fe20: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0001fe30: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
-0001fe40: 2020 2847 4954 4947 4e4f 5245 5f53 594e    (GITIGNORE_SYN
-0001fe50: 435f 5445 5354 5f44 4952 5f53 5452 5543  C_TEST_DIR_STRUC
-0001fe60: 5455 5245 2c20 7374 6f72 6167 655f 6c69  TURE, storage_li
-0001fe70: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
-0001fe80: 2c0a 2020 2020 2020 2020 2070 7974 6573  ,.         pytes
-0001fe90: 742e 7061 7261 6d28 4749 5449 474e 4f52  t.param(GITIGNOR
-0001fea0: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
-0001feb0: 5354 5255 4354 5552 452c 0a20 2020 2020  STRUCTURE,.     
-0001fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fed0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-0001fee0: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
-0001fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff00: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-0001ff10: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
-0001ff20: 0a20 2020 2064 6566 2074 6573 745f 6578  .    def test_ex
-0001ff30: 636c 7564 6564 5f66 696c 655f 636c 6f75  cluded_file_clou
-0001ff40: 645f 7374 6f72 6167 655f 7570 6c6f 6164  d_storage_upload
-0001ff50: 5f63 6f70 7928 7365 6c66 2c20 6769 7469  _copy(self, giti
-0001ff60: 676e 6f72 655f 7374 7275 6374 7572 652c  gnore_structure,
-0001ff70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffa0: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
-0001ffb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffe0: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
-0001fff0: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
-00020000: 293a 0a20 2020 2020 2020 2023 2074 6573  ):.        # tes
-00020010: 7473 2069 6620 6669 6c65 7320 696e 636c  ts if files incl
-00020020: 7564 6564 2069 6e20 2e67 6974 6967 6e6f  uded in .gitigno
-00020030: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
-00020040: 2f65 7863 6c75 6465 2061 7265 0a20 2020  /exclude are.   
-00020050: 2020 2020 2023 2065 7863 6c75 6465 6420       # excluded 
-00020060: 6672 6f6d 2062 6569 6e67 2074 7261 6e73  from being trans
-00020070: 6665 7272 6564 2074 6f20 5374 6f72 6167  ferred to Storag
-00020080: 650a 0a20 2020 2020 2020 2074 6d70 5f67  e..        tmp_g
-00020090: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
-000200a0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
-000200b0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
-000200c0: 2020 2020 7570 6c6f 6164 5f66 696c 655f      upload_file_
-000200d0: 6e61 6d65 203d 2027 696e 636c 7564 6564  name = 'included
-000200e0: 270a 2020 2020 2020 2020 2320 436f 756e  '.        # Coun
-000200f0: 7420 7468 6520 6e75 6d62 6572 206f 6620  t the number of 
-00020100: 6669 6c65 7320 7769 7468 2074 6865 2067  files with the g
-00020110: 6976 656e 2066 696c 6520 6e61 6d65 0a20  iven file name. 
-00020120: 2020 2020 2020 2075 705f 636d 6420 3d20         up_cmd = 
-00020130: 7365 6c66 2e63 6c69 5f63 6f75 6e74 5f6e  self.cli_count_n
-00020140: 616d 655f 696e 5f62 7563 6b65 7428 7374  ame_in_bucket(st
-00020150: 6f72 655f 7479 7065 2c20 5c0a 2020 2020  ore_type, \.    
-00020160: 2020 2020 2020 2020 746d 705f 6769 7469          tmp_giti
-00020170: 676e 6f72 655f 7374 6f72 6167 655f 6f62  gnore_storage_ob
-00020180: 6a2e 6e61 6d65 2c20 6669 6c65 5f6e 616d  j.name, file_nam
-00020190: 653d 7570 6c6f 6164 5f66 696c 655f 6e61  e=upload_file_na
-000201a0: 6d65 290a 2020 2020 2020 2020 6769 745f  me).        git_
-000201b0: 6578 636c 7564 655f 636d 6420 3d20 7365  exclude_cmd = se
-000201c0: 6c66 2e63 6c69 5f63 6f75 6e74 5f6e 616d  lf.cli_count_nam
-000201d0: 655f 696e 5f62 7563 6b65 7428 7374 6f72  e_in_bucket(stor
-000201e0: 655f 7479 7065 2c20 5c0a 2020 2020 2020  e_type, \.      
-000201f0: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
-00020200: 6f72 655f 7374 6f72 6167 655f 6f62 6a2e  ore_storage_obj.
-00020210: 6e61 6d65 2c20 6669 6c65 5f6e 616d 653d  name, file_name=
-00020220: 272e 6769 7427 290a 2020 2020 2020 2020  '.git').        
-00020230: 636e 745f 6e75 6d5f 6669 6c65 5f63 6d64  cnt_num_file_cmd
-00020240: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
-00020250: 745f 6669 6c65 5f69 6e5f 6275 636b 6574  t_file_in_bucket
-00020260: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
-00020270: 6f72 655f 7479 7065 2c20 746d 705f 6769  ore_type, tmp_gi
-00020280: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
-00020290: 6f62 6a2e 6e61 6d65 290a 0a20 2020 2020  obj.name)..     
-000202a0: 2020 2075 705f 6f75 7470 7574 203d 2073     up_output = s
-000202b0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-000202c0: 6f75 7470 7574 2875 705f 636d 642c 2073  output(up_cmd, s
-000202d0: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
-000202e0: 2020 2067 6974 5f65 7863 6c75 6465 5f6f     git_exclude_o
-000202f0: 7574 7075 7420 3d20 7375 6270 726f 6365  utput = subproce
-00020300: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-00020310: 6769 745f 6578 636c 7564 655f 636d 642c  git_exclude_cmd,
-00020320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020350: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-00020360: 290a 2020 2020 2020 2020 636e 745f 6f75  ).        cnt_ou
-00020370: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
-00020380: 732e 6368 6563 6b5f 6f75 7470 7574 2863  s.check_output(c
-00020390: 6e74 5f6e 756d 5f66 696c 655f 636d 642c  nt_num_file_cmd,
-000203a0: 2073 6865 6c6c 3d54 7275 6529 0a0a 2020   shell=True)..  
-000203b0: 2020 2020 2020 6173 7365 7274 2027 3327        assert '3'
-000203c0: 2069 6e20 7570 5f6f 7574 7075 742e 6465   in up_output.de
-000203d0: 636f 6465 2827 7574 662d 3827 292c 205c  code('utf-8'), \
-000203e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000203f0: 2027 4669 6c65 7320 746f 2062 6520 696e   'Files to be in
-00020400: 636c 7564 6564 2061 7265 206e 6f74 2063  cluded are not c
-00020410: 6f6d 706c 6574 656c 7920 7570 6c6f 6164  ompletely upload
-00020420: 6564 2e27 0a20 2020 2020 2020 2023 2031  ed.'.        # 1
-00020430: 2069 7320 7265 6164 2061 7320 2e67 6974   is read as .git
-00020440: 6967 6e6f 7265 2069 7320 7570 6c6f 6164  ignore is upload
-00020450: 6564 0a20 2020 2020 2020 2061 7373 6572  ed.        asser
-00020460: 7420 2731 2720 696e 2067 6974 5f65 7863  t '1' in git_exc
-00020470: 6c75 6465 5f6f 7574 7075 742e 6465 636f  lude_output.deco
-00020480: 6465 2827 7574 662d 3827 292c 205c 0a20  de('utf-8'), \. 
-00020490: 2020 2020 2020 2020 2020 2020 2020 272e                '.
-000204a0: 6769 7420 6469 7265 6374 6f72 7920 7368  git directory sh
-000204b0: 6f75 6c64 206e 6f74 2062 6520 7570 6c6f  ould not be uplo
-000204c0: 6164 6564 2e27 0a20 2020 2020 2020 2023  aded.'.        #
-000204d0: 2034 2066 696c 6573 2069 6e63 6c75 6465   4 files include
-000204e0: 202e 6769 7469 676e 6f72 652c 2069 6e63   .gitignore, inc
-000204f0: 6c75 6465 642e 6c6f 672c 2069 6e63 6c75  luded.log, inclu
-00020500: 6465 642e 7478 742c 2069 6e63 6c75 6465  ded.txt, include
-00020510: 5f64 6972 2f69 6e63 6c75 6465 642e 6c6f  _dir/included.lo
-00020520: 670a 2020 2020 2020 2020 6173 7365 7274  g.        assert
-00020530: 2027 3427 2069 6e20 636e 745f 6f75 7470   '4' in cnt_outp
-00020540: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-00020550: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
-00020560: 2020 2020 2027 536f 6d65 2069 7465 6d73       'Some items
-00020570: 206c 6973 7465 6420 696e 202e 6769 7469   listed in .giti
-00020580: 676e 6f72 6520 616e 6420 2e67 6974 2f69  gnore and .git/i
-00020590: 6e66 6f2f 6578 636c 7564 6520 6172 6520  nfo/exclude are 
-000205a0: 6e6f 7420 6578 636c 7564 6564 2e27 0a0a  not excluded.'..
-000205b0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-000205c0: 7374 696e 6720 5941 4d4c 2053 7065 6373  sting YAML Specs
-000205d0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2320 4f75   ----------.# Ou
-000205e0: 7220 736b 7920 7374 6f72 6167 6520 7265  r sky storage re
-000205f0: 7175 6972 6573 2063 7265 6465 6e74 6961  quires credentia
-00020600: 6c73 2074 6f20 6368 6563 6b20 7468 6520  ls to check the 
-00020610: 6275 636b 6574 2065 7869 7374 616e 6365  bucket existance
-00020620: 2077 6865 6e0a 2320 6c6f 6164 696e 6720   when.# loading 
-00020630: 6120 7461 736b 2066 726f 6d20 7468 6520  a task from the 
-00020640: 7961 6d6c 2066 696c 652c 2073 6f20 7765  yaml file, so we
-00020650: 2063 616e 6e6f 7420 6d61 6b65 2069 7420   cannot make it 
-00020660: 6120 756e 6974 2074 6573 742e 0a63 6c61  a unit test..cla
-00020670: 7373 2054 6573 7459 616d 6c53 7065 6373  ss TestYamlSpecs
-00020680: 3a0a 2020 2020 2320 544f 444f 287a 6877  :.    # TODO(zhw
-00020690: 7529 3a20 4164 6420 7465 7374 2066 6f72  u): Add test for
-000206a0: 2060 746f 5f79 616d 6c5f 636f 6e66 6967   `to_yaml_config
-000206b0: 6020 666f 7220 7468 6520 5374 6f72 6167  ` for the Storag
-000206c0: 6520 6f62 6a65 6374 2e0a 2020 2020 2320  e object..    # 
-000206d0: 2057 6520 7368 6f75 6c64 206e 6f74 2075   We should not u
-000206e0: 7365 2060 6578 616d 706c 6573 2f73 746f  se `examples/sto
-000206f0: 7261 6765 5f64 656d 6f2e 7961 6d6c 6020  rage_demo.yaml` 
-00020700: 6865 7265 2c20 7369 6e63 6520 6974 2072  here, since it r
-00020710: 6571 7569 7265 730a 2020 2020 2320 2075  equires.    #  u
-00020720: 7365 7273 2074 6f20 656e 7375 7265 2062  sers to ensure b
-00020730: 7563 6b65 7420 6e61 6d65 7320 746f 206e  ucket names to n
-00020740: 6f74 2065 7869 7374 2061 6e64 2f6f 7220  ot exist and/or 
-00020750: 6265 2075 6e69 7175 652e 0a20 2020 205f  be unique..    _
-00020760: 5445 5354 5f59 414d 4c5f 5041 5448 5320  TEST_YAML_PATHS 
-00020770: 3d20 5b0a 2020 2020 2020 2020 2765 7861  = [.        'exa
-00020780: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
-00020790: 6d6c 272c 2027 6578 616d 706c 6573 2f6d  ml', 'examples/m
-000207a0: 616e 6167 6564 5f73 706f 742e 7961 6d6c  anaged_spot.yaml
-000207b0: 272c 0a20 2020 2020 2020 2027 6578 616d  ',.        'exam
-000207c0: 706c 6573 2f75 7369 6e67 5f66 696c 655f  ples/using_file_
-000207d0: 6d6f 756e 7473 2e79 616d 6c27 2c20 2765  mounts.yaml', 'e
-000207e0: 7861 6d70 6c65 732f 7265 736e 6574 5f61  xamples/resnet_a
-000207f0: 7070 2e79 616d 6c27 2c0a 2020 2020 2020  pp.yaml',.      
-00020800: 2020 2765 7861 6d70 6c65 732f 6d75 6c74    'examples/mult
-00020810: 695f 686f 7374 6e61 6d65 2e79 616d 6c27  i_hostname.yaml'
-00020820: 0a20 2020 205d 0a0a 2020 2020 6465 6620  .    ]..    def 
-00020830: 5f69 735f 6469 6374 5f73 7562 7365 7428  _is_dict_subset(
-00020840: 7365 6c66 2c20 6431 2c20 6432 293a 0a20  self, d1, d2):. 
-00020850: 2020 2020 2020 2022 2222 4368 6563 6b20         """Check 
-00020860: 6966 2064 3120 6973 2074 6865 2073 7562  if d1 is the sub
-00020870: 7365 7420 6f66 2064 322e 2222 220a 2020  set of d2.""".  
-00020880: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
-00020890: 6e20 6431 2e69 7465 6d73 2829 3a0a 2020  n d1.items():.  
-000208a0: 2020 2020 2020 2020 2020 6966 206b 206e            if k n
-000208b0: 6f74 2069 6e20 6432 3a0a 2020 2020 2020  ot in d2:.      
-000208c0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
-000208d0: 6e73 7461 6e63 6528 762c 206c 6973 7429  nstance(v, list)
-000208e0: 206f 7220 6973 696e 7374 616e 6365 2876   or isinstance(v
-000208f0: 2c20 6469 6374 293a 0a20 2020 2020 2020  , dict):.       
-00020900: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-00020910: 6572 7420 6c65 6e28 7629 203d 3d20 302c  ert len(v) == 0,
-00020920: 2028 6b2c 2076 290a 2020 2020 2020 2020   (k, v).        
-00020930: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00020940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020950: 2020 6173 7365 7274 2046 616c 7365 2c20    assert False, 
-00020960: 286b 2c20 7629 0a20 2020 2020 2020 2020  (k, v).         
-00020970: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00020980: 6365 2876 2c20 6469 6374 293a 0a20 2020  ce(v, dict):.   
-00020990: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-000209a0: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
-000209b0: 325b 6b5d 2c20 6469 6374 292c 2028 6b2c  2[k], dict), (k,
-000209c0: 2076 2c20 6432 290a 2020 2020 2020 2020   v, d2).        
-000209d0: 2020 2020 2020 2020 7365 6c66 2e5f 6973          self._is
-000209e0: 5f64 6963 745f 7375 6273 6574 2876 2c20  _dict_subset(v, 
-000209f0: 6432 5b6b 5d29 0a20 2020 2020 2020 2020  d2[k]).         
-00020a00: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
-00020a10: 6365 2876 2c20 7374 7229 3a0a 2020 2020  ce(v, str):.    
-00020a20: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00020a30: 203d 3d20 2761 6363 656c 6572 6174 6f72   == 'accelerator
-00020a40: 7327 3a0a 2020 2020 2020 2020 2020 2020  s':.            
-00020a50: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00020a60: 7320 3d20 736b 792e 5265 736f 7572 6365  s = sky.Resource
-00020a70: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00020a80: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00020a90: 732e 5f73 6574 5f61 6363 656c 6572 6174  s._set_accelerat
-00020aa0: 6f72 7328 762c 204e 6f6e 6529 0a20 2020  ors(v, None).   
-00020ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ac0: 2061 7373 6572 7420 7265 736f 7572 6365   assert resource
-00020ad0: 732e 6163 6365 6c65 7261 746f 7273 203d  s.accelerators =
-00020ae0: 3d20 6432 5b6b 5d2c 2028 6b2c 2076 2c20  = d2[k], (k, v, 
-00020af0: 6432 290a 2020 2020 2020 2020 2020 2020  d2).            
-00020b00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00020b10: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00020b20: 7365 7274 2076 2e6c 6f77 6572 2829 203d  sert v.lower() =
-00020b30: 3d20 6432 5b6b 5d2e 6c6f 7765 7228 292c  = d2[k].lower(),
-00020b40: 2028 6b2c 2076 2c20 6432 5b6b 5d29 0a20   (k, v, d2[k]). 
-00020b50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00020b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020b70: 2061 7373 6572 7420 7620 3d3d 2064 325b   assert v == d2[
-00020b80: 6b5d 2c20 286b 2c20 762c 2064 325b 6b5d  k], (k, v, d2[k]
-00020b90: 290a 0a20 2020 2064 6566 205f 6368 6563  )..    def _chec
-00020ba0: 6b5f 6571 7569 7661 6c65 6e74 2873 656c  k_equivalent(sel
-00020bb0: 662c 2079 616d 6c5f 7061 7468 293a 0a20  f, yaml_path):. 
-00020bc0: 2020 2020 2020 2022 2222 4368 6563 6b20         """Check 
-00020bd0: 6966 2074 6865 2079 616d 6c20 6973 2065  if the yaml is e
-00020be0: 7175 6976 616c 656e 7420 6166 7465 7220  quivalent after 
-00020bf0: 6c6f 6164 2061 6e64 2064 756d 7020 6167  load and dump ag
-00020c00: 6169 6e2e 2222 220a 2020 2020 2020 2020  ain.""".        
-00020c10: 6f72 6967 696e 5f74 6173 6b5f 636f 6e66  origin_task_conf
-00020c20: 6967 203d 2063 6f6d 6d6f 6e5f 7574 696c  ig = common_util
-00020c30: 732e 7265 6164 5f79 616d 6c28 7961 6d6c  s.read_yaml(yaml
-00020c40: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00020c50: 7461 736b 203d 2073 6b79 2e54 6173 6b2e  task = sky.Task.
-00020c60: 6672 6f6d 5f79 616d 6c28 7961 6d6c 5f70  from_yaml(yaml_p
-00020c70: 6174 6829 0a20 2020 2020 2020 206e 6577  ath).        new
-00020c80: 5f74 6173 6b5f 636f 6e66 6967 203d 2074  _task_config = t
-00020c90: 6173 6b2e 746f 5f79 616d 6c5f 636f 6e66  ask.to_yaml_conf
-00020ca0: 6967 2829 0a20 2020 2020 2020 2023 2064  ig().        # d
-00020cb0: 3120 3c3d 2064 320a 2020 2020 2020 2020  1 <= d2.        
-00020cc0: 7365 6c66 2e5f 6973 5f64 6963 745f 7375  self._is_dict_su
-00020cd0: 6273 6574 286f 7269 6769 6e5f 7461 736b  bset(origin_task
-00020ce0: 5f63 6f6e 6669 672c 206e 6577 5f74 6173  _config, new_tas
-00020cf0: 6b5f 636f 6e66 6967 290a 0a20 2020 2064  k_config)..    d
-00020d00: 6566 2074 6573 745f 6c6f 6164 5f64 756d  ef test_load_dum
-00020d10: 705f 7961 6d6c 5f63 6f6e 6669 675f 6571  p_yaml_config_eq
-00020d20: 7569 7661 6c65 6e74 2873 656c 6629 3a0a  uivalent(self):.
-00020d30: 2020 2020 2020 2020 2222 2254 6573 7420          """Test 
-00020d40: 6966 2074 6865 2079 616d 6c20 636f 6e66  if the yaml conf
-00020d50: 6967 2069 7320 6571 7569 7661 6c65 6e74  ig is equivalent
-00020d60: 2061 6674 6572 206c 6f61 6420 616e 6420   after load and 
-00020d70: 6475 6d70 2061 6761 696e 2e22 2222 0a20  dump again.""". 
-00020d80: 2020 2020 2020 2070 6174 686c 6962 2e50         pathlib.P
-00020d90: 6174 6828 277e 2f64 6174 6173 6574 7327  ath('~/datasets'
-00020da0: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
-00020db0: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
-00020dc0: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
-00020dd0: 6c69 622e 5061 7468 2827 7e2f 746d 7066  lib.Path('~/tmpf
-00020de0: 696c 6527 292e 6578 7061 6e64 7573 6572  ile').expanduser
-00020df0: 2829 2e74 6f75 6368 2829 0a20 2020 2020  ().touch().     
-00020e00: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-00020e10: 277e 2f2e 7373 6827 292e 6578 7061 6e64  '~/.ssh').expand
-00020e20: 7573 6572 2829 2e6d 6b64 6972 2865 7869  user().mkdir(exi
-00020e30: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
-00020e40: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
-00020e50: 2827 7e2f 2e73 7368 2f69 645f 7273 612e  ('~/.ssh/id_rsa.
-00020e60: 7075 6227 292e 6578 7061 6e64 7573 6572  pub').expanduser
-00020e70: 2829 2e74 6f75 6368 2829 0a20 2020 2020  ().touch().     
-00020e80: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
-00020e90: 277e 2f74 6d70 2d77 6f72 6b64 6972 2729  '~/tmp-workdir')
-00020ea0: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
-00020eb0: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
-00020ec0: 6529 0a20 2020 2020 2020 2070 6174 686c  e).        pathl
-00020ed0: 6962 2e50 6174 6828 277e 2f44 6f77 6e6c  ib.Path('~/Downl
-00020ee0: 6f61 6473 2f74 7075 2729 2e65 7870 616e  oads/tpu').expan
-00020ef0: 6475 7365 7228 292e 6d6b 6469 7228 7061  duser().mkdir(pa
-00020f00: 7265 6e74 733d 5472 7565 2c0a 2020 2020  rents=True,.    
-00020f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f40: 2020 2020 2020 2065 7869 7374 5f6f 6b3d         exist_ok=
-00020f50: 5472 7565 290a 2020 2020 2020 2020 666f  True).        fo
-00020f60: 7220 7961 6d6c 5f70 6174 6820 696e 2073  r yaml_path in s
-00020f70: 656c 662e 5f54 4553 545f 5941 4d4c 5f50  elf._TEST_YAML_P
-00020f80: 4154 4853 3a0a 2020 2020 2020 2020 2020  ATHS:.          
-00020f90: 2020 7365 6c66 2e5f 6368 6563 6b5f 6571    self._check_eq
-00020fa0: 7569 7661 6c65 6e74 2879 616d 6c5f 7061  uivalent(yaml_pa
-00020fb0: 7468 290a                                th).
+0001fa40: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0001fa50: 726f 7228 2755 6e61 626c 6520 746f 2066  ror('Unable to f
+0001fa60: 696e 6420 6120 6e6f 6e65 7869 7374 656e  ind a nonexisten
+0001fa70: 7420 6275 636b 6574 2027 0a20 2020 2020  t bucket '.     
+0001fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001faa0: 2020 2774 6f20 7573 652e 2054 6869 7320    'to use. This 
+0001fab0: 6973 2068 6967 6c79 2075 6e6c 696b 656c  is higly unlikel
+0001fac0: 7920 2d20 270a 2020 2020 2020 2020 2020  y - '.          
+0001fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fae0: 2020 2020 2020 2020 2020 2020 2027 6368               'ch
+0001faf0: 6563 6b20 6966 2074 6865 2074 6573 7473  eck if the tests
+0001fb00: 2061 7265 2063 6f72 7265 6374 2e27 290a   are correct.').
+0001fb10: 0a20 2020 2020 2020 2077 6974 6820 7079  .        with py
+0001fb20: 7465 7374 2e72 6169 7365 7328 0a20 2020  test.raises(.   
+0001fb30: 2020 2020 2020 2020 2020 2020 2073 6b79               sky
+0001fb40: 2e65 7863 6570 7469 6f6e 732e 5374 6f72  .exceptions.Stor
+0001fb50: 6167 6542 7563 6b65 7447 6574 4572 726f  ageBucketGetErro
+0001fb60: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0001fb70: 2020 206d 6174 6368 3d27 4174 7465 6d70     match='Attemp
+0001fb80: 7465 6420 746f 2063 6f6e 6e65 6374 2074  ted to connect t
+0001fb90: 6f20 6120 6e6f 6e2d 6578 6973 7465 6e74  o a non-existent
+0001fba0: 2062 7563 6b65 7427 293a 0a20 2020 2020   bucket'):.     
+0001fbb0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0001fbc0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+0001fbd0: 2e53 746f 7261 6765 2873 6f75 7263 653d  .Storage(source=
+0001fbe0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0001fbf0: 7572 6c2e 666f 726d 6174 280a 2020 2020  url.format(.    
+0001fc00: 2020 2020 2020 2020 2020 2020 7261 6e64              rand
+0001fc10: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
+0001fc20: 5f62 7563 6b65 745f 6e61 6d65 2929 0a0a  _bucket_name))..
+0001fc30: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0001fc40: 2e70 6172 616d 6574 7269 7a65 2827 7072  .parametrize('pr
+0001fc50: 6976 6174 655f 6275 636b 6574 272c 205b  ivate_bucket', [
+0001fc60: 0a20 2020 2020 2020 2066 2773 333a 2f2f  .        f's3://
+0001fc70: 696d 6167 656e 6574 272c 2066 2767 733a  imagenet', f'gs:
+0001fc80: 2f2f 696d 6167 656e 6574 272c 0a20 2020  //imagenet',.   
+0001fc90: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0001fca0: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
+0001fcb0: 2f62 7563 6b65 7431 272c 206d 6172 6b73  /bucket1', marks
+0001fcc0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+0001fcd0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0001fce0: 2074 6573 745f 7072 6976 6174 655f 6275   test_private_bu
+0001fcf0: 636b 6574 2873 656c 662c 2070 7269 7661  cket(self, priva
+0001fd00: 7465 5f62 7563 6b65 7429 3a0a 2020 2020  te_bucket):.    
+0001fd10: 2020 2020 2320 4174 7465 6d70 7473 2074      # Attempts t
+0001fd20: 6f20 6163 6365 7373 2070 7269 7661 7465  o access private
+0001fd30: 2062 7563 6b65 7473 206e 6f74 2062 656c   buckets not bel
+0001fd40: 6f6e 6769 6e67 2074 6f20 7468 6520 7573  onging to the us
+0001fd50: 6572 2e0a 2020 2020 2020 2020 2320 5468  er..        # Th
+0001fd60: 6573 6520 6275 636b 6574 7320 6172 6520  ese buckets are 
+0001fd70: 6b6e 6f77 6e20 746f 2062 6520 7072 6976  known to be priv
+0001fd80: 6174 652c 2062 7574 206d 6179 206e 6565  ate, but may nee
+0001fd90: 6420 746f 2062 6520 7570 6461 7465 6420  d to be updated 
+0001fda0: 6966 0a20 2020 2020 2020 2023 2074 6865  if.        # the
+0001fdb0: 7920 6172 6520 7265 6d6f 7665 6420 6279  y are removed by
+0001fdc0: 2074 6865 6972 206f 776e 6572 732e 0a20   their owners.. 
+0001fdd0: 2020 2020 2020 2070 7269 7661 7465 5f62         private_b
+0001fde0: 7563 6b65 745f 6e61 6d65 203d 2075 726c  ucket_name = url
+0001fdf0: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
+0001fe00: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
+0001fe10: 7429 2e6e 6574 6c6f 6320 6966 205c 0a20  t).netloc if \. 
+0001fe20: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0001fe30: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
+0001fe40: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
+0001fe50: 7429 2e73 6368 656d 6520 213d 2027 636f  t).scheme != 'co
+0001fe60: 7327 2065 6c73 6520 5c0a 2020 2020 2020  s' else \.      
+0001fe70: 2020 2020 2020 2020 2020 2020 7572 6c6c              urll
+0001fe80: 6962 2e70 6172 7365 2e75 726c 7370 6c69  ib.parse.urlspli
+0001fe90: 7428 7072 6976 6174 655f 6275 636b 6574  t(private_bucket
+0001fea0: 292e 7061 7468 2e73 7472 6970 2827 2f27  ).path.strip('/'
+0001feb0: 290a 2020 2020 2020 2020 7769 7468 2070  ).        with p
+0001fec0: 7974 6573 742e 7261 6973 6573 280a 2020  ytest.raises(.  
+0001fed0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
+0001fee0: 792e 6578 6365 7074 696f 6e73 2e53 746f  y.exceptions.Sto
+0001fef0: 7261 6765 4275 636b 6574 4765 7445 7272  rageBucketGetErr
+0001ff00: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0001ff10: 2020 2020 6d61 7463 683d 7374 6f72 6167      match=storag
+0001ff20: 655f 6c69 622e 5f42 5543 4b45 545f 4641  e_lib._BUCKET_FA
+0001ff30: 494c 5f54 4f5f 434f 4e4e 4543 545f 4d45  IL_TO_CONNECT_ME
+0001ff40: 5353 4147 452e 666f 726d 6174 280a 2020  SSAGE.format(.  
+0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff60: 2020 6e61 6d65 3d70 7269 7661 7465 5f62    name=private_b
+0001ff70: 7563 6b65 745f 6e61 6d65 2929 3a0a 2020  ucket_name)):.  
+0001ff80: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0001ff90: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
+0001ffa0: 6c69 622e 5374 6f72 6167 6528 736f 7572  lib.Storage(sour
+0001ffb0: 6365 3d70 7269 7661 7465 5f62 7563 6b65  ce=private_bucke
+0001ffc0: 7429 0a0a 2020 2020 4070 7974 6573 742e  t)..    @pytest.
+0001ffd0: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+0001ffe0: 2827 6578 745f 6275 636b 6574 5f66 6978  ('ext_bucket_fix
+0001fff0: 7475 7265 2c20 7374 6f72 655f 7479 7065  ture, store_type
+00020000: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00020010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020020: 5b28 2774 6d70 5f61 7773 636c 695f 6275  [('tmp_awscli_bu
+00020030: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
+00020040: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
+00020050: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020070: 2827 746d 705f 6773 7574 696c 5f62 7563  ('tmp_gsutil_buc
+00020080: 6b65 7427 2c20 7374 6f72 6167 655f 6c69  ket', storage_li
+00020090: 622e 5374 6f72 6554 7970 652e 4743 5329  b.StoreType.GCS)
+000200a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000200b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200c0: 7079 7465 7374 2e70 6172 616d 2827 746d  pytest.param('tm
+000200d0: 705f 6962 6d5f 636f 735f 6275 636b 6574  p_ibm_cos_bucket
+000200e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000200f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020100: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00020110: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00020120: 7970 652e 4942 4d2c 0a20 2020 2020 2020  ype.IBM,.       
+00020130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020150: 2020 2020 6d61 726b 733d 7079 7465 7374      marks=pytest
+00020160: 2e6d 6172 6b2e 6962 6d29 2c0a 2020 2020  .mark.ibm),.    
+00020170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020180: 2020 2020 2020 2020 2020 7079 7465 7374            pytest
+00020190: 2e70 6172 616d 2827 746d 705f 6177 7363  .param('tmp_awsc
+000201a0: 6c69 5f62 7563 6b65 745f 7232 272c 0a20  li_bucket_r2',. 
+000201b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201d0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+000201e0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+000201f0: 5232 2c0a 2020 2020 2020 2020 2020 2020  R2,.            
+00020200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020210: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00020220: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+00020230: 2e63 6c6f 7564 666c 6172 6529 5d29 0a20  .cloudflare)]). 
+00020240: 2020 2064 6566 2074 6573 745f 7570 6c6f     def test_uplo
+00020250: 6164 5f74 6f5f 6578 6973 7469 6e67 5f62  ad_to_existing_b
+00020260: 7563 6b65 7428 7365 6c66 2c20 6578 745f  ucket(self, ext_
+00020270: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
+00020280: 7265 7175 6573 742c 0a20 2020 2020 2020  request,.       
+00020290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000202b0: 746d 705f 736f 7572 6365 2c20 7374 6f72  tmp_source, stor
+000202c0: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+000202d0: 2023 2054 7269 6573 2075 706c 6f61 6469   # Tries uploadi
+000202e0: 6e67 2065 7869 7374 696e 6720 6669 6c65  ng existing file
+000202f0: 7320 746f 206e 6577 6c79 2063 7265 6174  s to newly creat
+00020300: 6564 2062 7563 6b65 7420 286f 7574 7369  ed bucket (outsi
+00020310: 6465 206f 660a 2020 2020 2020 2020 2320  de of.        # 
+00020320: 736b 7929 2061 6e64 2076 6572 6966 6965  sky) and verifie
+00020330: 7320 7468 6174 2066 696c 6573 2061 7265  s that files are
+00020340: 2077 7269 7474 656e 2e0a 2020 2020 2020   written..      
+00020350: 2020 6275 636b 6574 5f6e 616d 6520 3d20    bucket_name = 
+00020360: 7265 7175 6573 742e 6765 7466 6978 7475  request.getfixtu
+00020370: 7265 7661 6c75 6528 6578 745f 6275 636b  revalue(ext_buck
+00020380: 6574 5f66 6978 7475 7265 290a 2020 2020  et_fixture).    
+00020390: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
+000203a0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+000203b0: 6f72 6167 6528 6e61 6d65 3d62 7563 6b65  orage(name=bucke
+000203c0: 745f 6e61 6d65 2c20 736f 7572 6365 3d74  t_name, source=t
+000203d0: 6d70 5f73 6f75 7263 6529 0a20 2020 2020  mp_source).     
+000203e0: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
+000203f0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
+00020400: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
+00020410: 4368 6563 6b20 6966 2074 6d70 5f73 6f75  Check if tmp_sou
+00020420: 7263 652f 746d 702d 6669 6c65 2065 7869  rce/tmp-file exi
+00020430: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
+00020440: 7420 7573 696e 6720 6177 7320 636c 690a  t using aws cli.
+00020450: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+00020460: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00020470: 7574 7075 7428 7365 6c66 2e63 6c69 5f6c  utput(self.cli_l
+00020480: 735f 636d 6428 7374 6f72 655f 7479 7065  s_cmd(store_type
+00020490: 2c20 6275 636b 6574 5f6e 616d 6529 2c0a  , bucket_name),.
+000204a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204c0: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
+000204d0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+000204e0: 2027 746d 702d 6669 6c65 2720 696e 206f   'tmp-file' in o
+000204f0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00020500: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
+00020510: 2020 2746 696c 6520 6e6f 7420 666f 756e    'File not foun
+00020520: 6420 696e 2062 7563 6b65 7420 2d20 6f75  d in bucket - ou
+00020530: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
+00020540: 6f72 6d61 7428 6f75 742e 6465 636f 6465  ormat(out.decode
+00020550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020590: 2028 2775 7466 2d38 2729 290a 0a20 2020   ('utf-8'))..   
+000205a0: 2020 2020 2023 2043 6865 636b 2073 796d       # Check sym
+000205b0: 6c69 6e6b 7320 2d20 7379 6d6c 696e 6b73  links - symlinks
+000205c0: 2064 6f6e 2774 2067 6574 2063 6f70 6965   don't get copie
+000205d0: 6420 6279 2073 6b79 2073 746f 7261 6765  d by sky storage
+000205e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000205f0: 2870 6174 686c 6962 2e50 6174 6828 746d  (pathlib.Path(tm
+00020600: 705f 736f 7572 6365 2920 2f20 2763 6972  p_source) / 'cir
+00020610: 636c 652d 6c69 6e6b 2729 2e69 735f 7379  cle-link').is_sy
+00020620: 6d6c 696e 6b28 292c 2028 0a20 2020 2020  mlink(), (.     
+00020630: 2020 2020 2020 2027 6369 7263 6c65 2d6c         'circle-l
+00020640: 696e 6b20 7761 7320 6e6f 7420 666f 756e  ink was not foun
+00020650: 6420 696e 2074 6865 2075 706c 6f61 6420  d in the upload 
+00020660: 736f 7572 6365 202d 2027 0a20 2020 2020  source - '.     
+00020670: 2020 2020 2020 2027 6172 6520 7468 6520         'are the 
+00020680: 7465 7374 2066 6978 7475 7265 7320 636f  test fixtures co
+00020690: 7272 6563 743f 2729 0a20 2020 2020 2020  rrect?').       
+000206a0: 2061 7373 6572 7420 2763 6972 636c 652d   assert 'circle-
+000206b0: 6c69 6e6b 2720 6e6f 7420 696e 206f 7574  link' not in out
+000206c0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+000206d0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+000206e0: 2753 796d 6c69 6e6b 2066 6f75 6e64 2069  'Symlink found i
+000206f0: 6e20 6275 636b 6574 202d 206c 7320 6f75  n bucket - ls ou
+00020700: 7470 7574 2077 6173 203a 207b 7d27 2e66  tput was : {}'.f
+00020710: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
+00020720: 2020 2020 2020 206f 7574 2e64 6563 6f64         out.decod
+00020730: 6528 2775 7466 2d38 2729 2929 0a0a 2020  e('utf-8')))..  
+00020740: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
+00020750: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
+00020760: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
+00020770: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
+00020780: 7468 6520 6f75 7470 7574 2e0a 2020 2020  the output..    
+00020790: 2020 2020 2320 4974 2073 686f 756c 6420      # It should 
+000207a0: 6e6f 7420 6578 6973 7420 6265 6361 7573  not exist becaus
+000207b0: 6520 7468 6520 6275 636b 6574 2077 6173  e the bucket was
+000207c0: 2063 7265 6174 6564 2065 7874 6572 6e61   created externa
+000207d0: 6c6c 792e 0a20 2020 2020 2020 206f 7574  lly..        out
+000207e0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+000207f0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+00020800: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+00020810: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
+00020820: 6572 7420 7374 6f72 6167 655f 6f62 6a2e  ert storage_obj.
+00020830: 6e61 6d65 206e 6f74 2069 6e20 6f75 742e  name not in out.
+00020840: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
+00020850: 0a20 2020 2064 6566 2074 6573 745f 636f  .    def test_co
+00020860: 7079 5f6d 6f75 6e74 5f65 7869 7374 696e  py_mount_existin
+00020870: 675f 7374 6f72 6167 6528 7365 6c66 2c0a  g_storage(self,.
+00020880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208a0: 2020 2020 2020 2020 2074 6d70 5f63 6f70           tmp_cop
+000208b0: 795f 6d6e 745f 6578 6973 7469 6e67 5f73  y_mnt_existing_s
+000208c0: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
+000208d0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
+000208e0: 2062 7563 6b65 7420 7769 7468 206e 6f20   bucket with no 
+000208f0: 736f 7572 6365 2069 6e20 4d4f 554e 5420  source in MOUNT 
+00020900: 6d6f 6465 2028 656d 7074 7920 6275 636b  mode (empty buck
+00020910: 6574 292c 2061 6e64 0a20 2020 2020 2020  et), and.       
+00020920: 2023 2074 6865 6e20 7472 6965 7320 746f   # then tries to
+00020930: 206c 6f61 6420 7468 6520 7361 6d65 2073   load the same s
+00020940: 746f 7261 6765 2069 6e20 434f 5059 206d  torage in COPY m
+00020950: 6f64 652e 0a20 2020 2020 2020 2074 6d70  ode..        tmp
+00020960: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
+00020970: 6e67 5f73 746f 7261 6765 5f6f 626a 2e61  ng_storage_obj.a
+00020980: 6464 5f73 746f 7265 2873 746f 7261 6765  dd_store(storage
+00020990: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
+000209a0: 3329 0a20 2020 2020 2020 2073 746f 7261  3).        stora
+000209b0: 6765 5f6e 616d 6520 3d20 746d 705f 636f  ge_name = tmp_co
+000209c0: 7079 5f6d 6e74 5f65 7869 7374 696e 675f  py_mnt_existing_
+000209d0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+000209e0: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
+000209f0: 6b20 6073 6b79 2073 746f 7261 6765 206c  k `sky storage l
+00020a00: 7360 2074 6f20 656e 7375 7265 2073 746f  s` to ensure sto
+00020a10: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
+00020a20: 7473 0a20 2020 2020 2020 206f 7574 203d  ts.        out =
+00020a30: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00020a40: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
+00020a50: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
+00020a60: 5d29 2e64 6563 6f64 6528 2775 7466 2d38  ]).decode('utf-8
+00020a70: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
+00020a80: 7420 7374 6f72 6167 655f 6e61 6d65 2069  t storage_name i
+00020a90: 6e20 6f75 742c 2066 2753 746f 7261 6765  n out, f'Storage
+00020aa0: 207b 7374 6f72 6167 655f 6e61 6d65 7d20   {storage_name} 
+00020ab0: 6e6f 7420 666f 756e 6420 696e 2073 6b79  not found in sky
+00020ac0: 2073 746f 7261 6765 206c 732e 270a 0a20   storage ls.'.. 
+00020ad0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
+00020ae0: 7061 7261 6d65 7472 697a 6528 2773 746f  parametrize('sto
+00020af0: 7265 5f74 7970 6527 2c20 5b0a 2020 2020  re_type', [.    
+00020b00: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+00020b10: 5374 6f72 6554 7970 652e 5333 2c20 7374  StoreType.S3, st
+00020b20: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00020b30: 7970 652e 4743 532c 0a20 2020 2020 2020  ype.GCS,.       
+00020b40: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+00020b50: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00020b60: 7970 652e 4942 4d2c 206d 6172 6b73 3d70  ype.IBM, marks=p
+00020b70: 7974 6573 742e 6d61 726b 2e69 626d 292c  ytest.mark.ibm),
+00020b80: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00020b90: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+00020ba0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
+00020bb0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+00020bc0: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
+00020bd0: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
+00020be0: 745f 6c69 7374 5f73 6f75 7263 6528 7365  t_list_source(se
+00020bf0: 6c66 2c20 746d 705f 6c6f 6361 6c5f 6c69  lf, tmp_local_li
+00020c00: 7374 5f73 746f 7261 6765 5f6f 626a 2c20  st_storage_obj, 
+00020c10: 7374 6f72 655f 7479 7065 293a 0a20 2020  store_type):.   
+00020c20: 2020 2020 2023 2055 7365 7320 6120 6c69       # Uses a li
+00020c30: 7374 2069 6e20 7468 6520 736f 7572 6365  st in the source
+00020c40: 2066 6965 6c64 2074 6f20 7370 6563 6966   field to specif
+00020c50: 7920 6120 6669 6c65 2061 6e64 2061 2064  y a file and a d
+00020c60: 6972 6563 746f 7279 2074 6f0a 2020 2020  irectory to.    
+00020c70: 2020 2020 2320 6265 2075 706c 6f61 6465      # be uploade
+00020c80: 6420 746f 2074 6865 2073 746f 7261 6765  d to the storage
+00020c90: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
+00020ca0: 2074 6d70 5f6c 6f63 616c 5f6c 6973 745f   tmp_local_list_
+00020cb0: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
+00020cc0: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+00020cd0: 290a 0a20 2020 2020 2020 2023 2043 6865  )..        # Che
+00020ce0: 636b 2069 6620 746d 702d 6669 6c65 2065  ck if tmp-file e
+00020cf0: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
+00020d00: 6b65 7420 726f 6f74 2075 7369 6e67 2063  ket root using c
+00020d10: 6c69 0a20 2020 2020 2020 206f 7574 203d  li.        out =
+00020d20: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00020d30: 6b5f 6f75 7470 7574 2873 656c 662e 636c  k_output(self.cl
+00020d40: 695f 6c73 5f63 6d64 280a 2020 2020 2020  i_ls_cmd(.      
+00020d50: 2020 2020 2020 7374 6f72 655f 7479 7065        store_type
+00020d60: 2c20 746d 705f 6c6f 6361 6c5f 6c69 7374  , tmp_local_list
+00020d70: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+00020d80: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00020d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020da0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
+00020db0: 5472 7565 290a 2020 2020 2020 2020 6173  True).        as
+00020dc0: 7365 7274 2027 746d 702d 6669 6c65 2720  sert 'tmp-file' 
+00020dd0: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
+00020de0: 7466 2d38 2729 2c20 5c0a 2020 2020 2020  tf-8'), \.      
+00020df0: 2020 2020 2020 2746 696c 6520 6e6f 7420        'File not 
+00020e00: 666f 756e 6420 696e 2062 7563 6b65 7420  found in bucket 
+00020e10: 2d20 6f75 7470 7574 2077 6173 203a 207b  - output was : {
+00020e20: 7d27 2e66 6f72 6d61 7428 6f75 742e 6465  }'.format(out.de
+00020e30: 636f 6465 0a20 2020 2020 2020 2020 2020  code.           
+00020e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e70: 2020 2020 2028 2775 7466 2d38 2729 290a       ('utf-8')).
+00020e80: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00020e90: 2069 6620 746d 702d 6669 6c65 2065 7869   if tmp-file exi
+00020ea0: 7374 7320 696e 2074 6865 2062 7563 6b65  sts in the bucke
+00020eb0: 742f 746d 702d 736f 7572 6365 2075 7369  t/tmp-source usi
+00020ec0: 6e67 2063 6c69 0a20 2020 2020 2020 206f  ng cli.        o
+00020ed0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+00020ee0: 6368 6563 6b5f 6f75 7470 7574 2873 656c  check_output(sel
+00020ef0: 662e 636c 695f 6c73 5f63 6d64 280a 2020  f.cli_ls_cmd(.  
+00020f00: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+00020f10: 7479 7065 2c20 746d 705f 6c6f 6361 6c5f  type, tmp_local_
+00020f20: 6c69 7374 5f73 746f 7261 6765 5f6f 626a  list_storage_obj
+00020f30: 2e6e 616d 652c 2027 746d 702d 736f 7572  .name, 'tmp-sour
+00020f40: 6365 2f27 292c 0a20 2020 2020 2020 2020  ce/'),.         
+00020f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020f60: 2020 2020 2020 2020 2020 2020 2073 6865               she
+00020f70: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
+00020f80: 2061 7373 6572 7420 2774 6d70 2d66 696c   assert 'tmp-fil
+00020f90: 6527 2069 6e20 6f75 742e 6465 636f 6465  e' in out.decode
+00020fa0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
+00020fb0: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
+00020fc0: 6f74 2066 6f75 6e64 2069 6e20 6275 636b  ot found in buck
+00020fd0: 6574 202d 206f 7574 7075 7420 7761 7320  et - output was 
+00020fe0: 3a20 7b7d 272e 666f 726d 6174 286f 7574  : {}'.format(out
+00020ff0: 2e64 6563 6f64 650a 2020 2020 2020 2020  .decode.        
+00021000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021030: 2020 2020 2020 2020 2827 7574 662d 3827          ('utf-8'
+00021040: 2929 0a0a 2020 2020 4070 7974 6573 742e  ))..    @pytest.
+00021050: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00021060: 2827 696e 7661 6c69 645f 6e61 6d65 5f6c  ('invalid_name_l
+00021070: 6973 742c 2073 746f 7265 5f74 7970 6527  ist, store_type'
+00021080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021090: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+000210a0: 2841 5753 5f49 4e56 414c 4944 5f4e 414d  (AWS_INVALID_NAM
+000210b0: 4553 2c20 7374 6f72 6167 655f 6c69 622e  ES, storage_lib.
+000210c0: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
+000210d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000210e0: 2020 2020 2020 2020 2020 2020 2028 4743               (GC
+000210f0: 535f 494e 5641 4c49 445f 4e41 4d45 532c  S_INVALID_NAMES,
+00021100: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00021110: 7265 5479 7065 2e47 4353 292c 0a20 2020  reType.GCS),.   
+00021120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021130: 2020 2020 2020 2020 2020 2070 7974 6573             pytes
+00021140: 742e 7061 7261 6d28 4942 4d5f 494e 5641  t.param(IBM_INVA
+00021150: 4c49 445f 4e41 4d45 532c 0a20 2020 2020  LID_NAMES,.     
+00021160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021180: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+00021190: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+000211a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000211b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211c0: 2020 2020 2020 2020 2020 2020 6d61 726b              mark
+000211d0: 733d 7079 7465 7374 2e6d 6172 6b2e 6962  s=pytest.mark.ib
+000211e0: 6d29 2c0a 2020 2020 2020 2020 2020 2020  m),.            
+000211f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021200: 2020 7079 7465 7374 2e70 6172 616d 2841    pytest.param(A
+00021210: 5753 5f49 4e56 414c 4944 5f4e 414d 4553  WS_INVALID_NAMES
+00021220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00021230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021240: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+00021250: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00021260: 7065 2e52 322c 0a20 2020 2020 2020 2020  pe.R2,.         
+00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021290: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
+000212a0: 6172 6b2e 636c 6f75 6466 6c61 7265 295d  ark.cloudflare)]
+000212b0: 290a 2020 2020 6465 6620 7465 7374 5f69  ).    def test_i
+000212c0: 6e76 616c 6964 5f6e 616d 6573 2873 656c  nvalid_names(sel
+000212d0: 662c 2069 6e76 616c 6964 5f6e 616d 655f  f, invalid_name_
+000212e0: 6c69 7374 2c20 7374 6f72 655f 7479 7065  list, store_type
+000212f0: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
+00021300: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
+00021310: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
+00021320: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
+00021330: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
+00021340: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
+00021350: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
+00021360: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
+00021370: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
+00021380: 696e 2069 6e76 616c 6964 5f6e 616d 655f  in invalid_name_
+00021390: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+000213a0: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
+000213b0: 6973 6573 2873 6b79 2e65 7863 6570 7469  ises(sky.excepti
+000213c0: 6f6e 732e 5374 6f72 6167 654e 616d 6545  ons.StorageNameE
+000213d0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+000213e0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+000213f0: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
+00021400: 2e53 746f 7261 6765 286e 616d 653d 6e61  .Storage(name=na
+00021410: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00021420: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
+00021430: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
+00021440: 7479 7065 290a 0a20 2020 2040 7079 7465  type)..    @pyte
+00021450: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+00021460: 697a 6528 0a20 2020 2020 2020 2027 6769  ize(.        'gi
+00021470: 7469 676e 6f72 655f 7374 7275 6374 7572  tignore_structur
+00021480: 652c 2073 746f 7265 5f74 7970 6527 2c0a  e, store_type',.
+00021490: 2020 2020 2020 2020 5b28 4749 5449 474e          [(GITIGN
+000214a0: 4f52 455f 5359 4e43 5f54 4553 545f 4449  ORE_SYNC_TEST_DI
+000214b0: 525f 5354 5255 4354 5552 452c 2073 746f  R_STRUCTURE, sto
+000214c0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+000214d0: 7065 2e53 3329 2c0a 2020 2020 2020 2020  pe.S3),.        
+000214e0: 2028 4749 5449 474e 4f52 455f 5359 4e43   (GITIGNORE_SYNC
+000214f0: 5f54 4553 545f 4449 525f 5354 5255 4354  _TEST_DIR_STRUCT
+00021500: 5552 452c 2073 746f 7261 6765 5f6c 6962  URE, storage_lib
+00021510: 2e53 746f 7265 5479 7065 2e47 4353 292c  .StoreType.GCS),
+00021520: 0a20 2020 2020 2020 2020 7079 7465 7374  .         pytest
+00021530: 2e70 6172 616d 2847 4954 4947 4e4f 5245  .param(GITIGNORE
+00021540: 5f53 594e 435f 5445 5354 5f44 4952 5f53  _SYNC_TEST_DIR_S
+00021550: 5452 5543 5455 5245 2c0a 2020 2020 2020  TRUCTURE,.      
+00021560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021570: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00021580: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
+00021590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215a0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+000215b0: 6b2e 636c 6f75 6466 6c61 7265 295d 290a  k.cloudflare)]).
+000215c0: 2020 2020 6465 6620 7465 7374 5f65 7863      def test_exc
+000215d0: 6c75 6465 645f 6669 6c65 5f63 6c6f 7564  luded_file_cloud
+000215e0: 5f73 746f 7261 6765 5f75 706c 6f61 645f  _storage_upload_
+000215f0: 636f 7079 2873 656c 662c 2067 6974 6967  copy(self, gitig
+00021600: 6e6f 7265 5f73 7472 7563 7475 7265 2c0a  nore_structure,.
+00021610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021640: 2020 2020 2073 746f 7265 5f74 7970 652c       store_type,
+00021650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021680: 2020 2020 2020 746d 705f 6769 7469 676e        tmp_gitign
+00021690: 6f72 655f 7374 6f72 6167 655f 6f62 6a29  ore_storage_obj)
+000216a0: 3a0a 2020 2020 2020 2020 2320 7465 7374  :.        # test
+000216b0: 7320 6966 2066 696c 6573 2069 6e63 6c75  s if files inclu
+000216c0: 6465 6420 696e 202e 6769 7469 676e 6f72  ded in .gitignor
+000216d0: 6520 616e 6420 2e67 6974 2f69 6e66 6f2f  e and .git/info/
+000216e0: 6578 636c 7564 6520 6172 650a 2020 2020  exclude are.    
+000216f0: 2020 2020 2320 6578 636c 7564 6564 2066      # excluded f
+00021700: 726f 6d20 6265 696e 6720 7472 616e 7366  rom being transf
+00021710: 6572 7265 6420 746f 2053 746f 7261 6765  erred to Storage
+00021720: 0a0a 2020 2020 2020 2020 746d 705f 6769  ..        tmp_gi
+00021730: 7469 676e 6f72 655f 7374 6f72 6167 655f  tignore_storage_
+00021740: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+00021750: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+00021760: 2020 2075 706c 6f61 645f 6669 6c65 5f6e     upload_file_n
+00021770: 616d 6520 3d20 2769 6e63 6c75 6465 6427  ame = 'included'
+00021780: 0a20 2020 2020 2020 2023 2043 6f75 6e74  .        # Count
+00021790: 2074 6865 206e 756d 6265 7220 6f66 2066   the number of f
+000217a0: 696c 6573 2077 6974 6820 7468 6520 6769  iles with the gi
+000217b0: 7665 6e20 6669 6c65 206e 616d 650a 2020  ven file name.  
+000217c0: 2020 2020 2020 7570 5f63 6d64 203d 2073        up_cmd = s
+000217d0: 656c 662e 636c 695f 636f 756e 745f 6e61  elf.cli_count_na
+000217e0: 6d65 5f69 6e5f 6275 636b 6574 2873 746f  me_in_bucket(sto
+000217f0: 7265 5f74 7970 652c 205c 0a20 2020 2020  re_type, \.     
+00021800: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
+00021810: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
+00021820: 2e6e 616d 652c 2066 696c 655f 6e61 6d65  .name, file_name
+00021830: 3d75 706c 6f61 645f 6669 6c65 5f6e 616d  =upload_file_nam
+00021840: 6529 0a20 2020 2020 2020 2067 6974 5f65  e).        git_e
+00021850: 7863 6c75 6465 5f63 6d64 203d 2073 656c  xclude_cmd = sel
+00021860: 662e 636c 695f 636f 756e 745f 6e61 6d65  f.cli_count_name
+00021870: 5f69 6e5f 6275 636b 6574 2873 746f 7265  _in_bucket(store
+00021880: 5f74 7970 652c 205c 0a20 2020 2020 2020  _type, \.       
+00021890: 2020 2020 2074 6d70 5f67 6974 6967 6e6f       tmp_gitigno
+000218a0: 7265 5f73 746f 7261 6765 5f6f 626a 2e6e  re_storage_obj.n
+000218b0: 616d 652c 2066 696c 655f 6e61 6d65 3d27  ame, file_name='
+000218c0: 2e67 6974 2729 0a20 2020 2020 2020 2063  .git').        c
+000218d0: 6e74 5f6e 756d 5f66 696c 655f 636d 6420  nt_num_file_cmd 
+000218e0: 3d20 7365 6c66 2e63 6c69 5f63 6f75 6e74  = self.cli_count
+000218f0: 5f66 696c 655f 696e 5f62 7563 6b65 7428  _file_in_bucket(
+00021900: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+00021910: 7265 5f74 7970 652c 2074 6d70 5f67 6974  re_type, tmp_git
+00021920: 6967 6e6f 7265 5f73 746f 7261 6765 5f6f  ignore_storage_o
+00021930: 626a 2e6e 616d 6529 0a0a 2020 2020 2020  bj.name)..      
+00021940: 2020 7570 5f6f 7574 7075 7420 3d20 7375    up_output = su
+00021950: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00021960: 7574 7075 7428 7570 5f63 6d64 2c20 7368  utput(up_cmd, sh
+00021970: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+00021980: 2020 6769 745f 6578 636c 7564 655f 6f75    git_exclude_ou
+00021990: 7470 7574 203d 2073 7562 7072 6f63 6573  tput = subproces
+000219a0: 732e 6368 6563 6b5f 6f75 7470 7574 2867  s.check_output(g
+000219b0: 6974 5f65 7863 6c75 6465 5f63 6d64 2c0a  it_exclude_cmd,.
+000219c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219f0: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00021a00: 0a20 2020 2020 2020 2063 6e74 5f6f 7574  .        cnt_out
+00021a10: 7075 7420 3d20 7375 6270 726f 6365 7373  put = subprocess
+00021a20: 2e63 6865 636b 5f6f 7574 7075 7428 636e  .check_output(cn
+00021a30: 745f 6e75 6d5f 6669 6c65 5f63 6d64 2c20  t_num_file_cmd, 
+00021a40: 7368 656c 6c3d 5472 7565 290a 0a20 2020  shell=True)..   
+00021a50: 2020 2020 2061 7373 6572 7420 2733 2720       assert '3' 
+00021a60: 696e 2075 705f 6f75 7470 7574 2e64 6563  in up_output.dec
+00021a70: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
+00021a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021a90: 2746 696c 6573 2074 6f20 6265 2069 6e63  'Files to be inc
+00021aa0: 6c75 6465 6420 6172 6520 6e6f 7420 636f  luded are not co
+00021ab0: 6d70 6c65 7465 6c79 2075 706c 6f61 6465  mpletely uploade
+00021ac0: 642e 270a 2020 2020 2020 2020 2320 3120  d.'.        # 1 
+00021ad0: 6973 2072 6561 6420 6173 202e 6769 7469  is read as .giti
+00021ae0: 676e 6f72 6520 6973 2075 706c 6f61 6465  gnore is uploade
+00021af0: 640a 2020 2020 2020 2020 6173 7365 7274  d.        assert
+00021b00: 2027 3127 2069 6e20 6769 745f 6578 636c   '1' in git_excl
+00021b10: 7564 655f 6f75 7470 7574 2e64 6563 6f64  ude_output.decod
+00021b20: 6528 2775 7466 2d38 2729 2c20 5c0a 2020  e('utf-8'), \.  
+00021b30: 2020 2020 2020 2020 2020 2020 2027 2e67               '.g
+00021b40: 6974 2064 6972 6563 746f 7279 2073 686f  it directory sho
+00021b50: 756c 6420 6e6f 7420 6265 2075 706c 6f61  uld not be uploa
+00021b60: 6465 642e 270a 2020 2020 2020 2020 2320  ded.'.        # 
+00021b70: 3420 6669 6c65 7320 696e 636c 7564 6520  4 files include 
+00021b80: 2e67 6974 6967 6e6f 7265 2c20 696e 636c  .gitignore, incl
+00021b90: 7564 6564 2e6c 6f67 2c20 696e 636c 7564  uded.log, includ
+00021ba0: 6564 2e74 7874 2c20 696e 636c 7564 655f  ed.txt, include_
+00021bb0: 6469 722f 696e 636c 7564 6564 2e6c 6f67  dir/included.log
+00021bc0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00021bd0: 2734 2720 696e 2063 6e74 5f6f 7574 7075  '4' in cnt_outpu
+00021be0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00021bf0: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
+00021c00: 2020 2020 2753 6f6d 6520 6974 656d 7320      'Some items 
+00021c10: 6c69 7374 6564 2069 6e20 2e67 6974 6967  listed in .gitig
+00021c20: 6e6f 7265 2061 6e64 202e 6769 742f 696e  nore and .git/in
+00021c30: 666f 2f65 7863 6c75 6465 2061 7265 206e  fo/exclude are n
+00021c40: 6f74 2065 7863 6c75 6465 642e 270a 0a0a  ot excluded.'...
+00021c50: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00021c60: 7469 6e67 2059 414d 4c20 5370 6563 7320  ting YAML Specs 
+00021c70: 2d2d 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572  ----------.# Our
+00021c80: 2073 6b79 2073 746f 7261 6765 2072 6571   sky storage req
+00021c90: 7569 7265 7320 6372 6564 656e 7469 616c  uires credential
+00021ca0: 7320 746f 2063 6865 636b 2074 6865 2062  s to check the b
+00021cb0: 7563 6b65 7420 6578 6973 7461 6e63 6520  ucket existance 
+00021cc0: 7768 656e 0a23 206c 6f61 6469 6e67 2061  when.# loading a
+00021cd0: 2074 6173 6b20 6672 6f6d 2074 6865 2079   task from the y
+00021ce0: 616d 6c20 6669 6c65 2c20 736f 2077 6520  aml file, so we 
+00021cf0: 6361 6e6e 6f74 206d 616b 6520 6974 2061  cannot make it a
+00021d00: 2075 6e69 7420 7465 7374 2e0a 636c 6173   unit test..clas
+00021d10: 7320 5465 7374 5961 6d6c 5370 6563 733a  s TestYamlSpecs:
+00021d20: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
+00021d30: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
+00021d40: 6074 6f5f 7961 6d6c 5f63 6f6e 6669 6760  `to_yaml_config`
+00021d50: 2066 6f72 2074 6865 2053 746f 7261 6765   for the Storage
+00021d60: 206f 626a 6563 742e 0a20 2020 2023 2020   object..    #  
+00021d70: 5765 2073 686f 756c 6420 6e6f 7420 7573  We should not us
+00021d80: 6520 6065 7861 6d70 6c65 732f 7374 6f72  e `examples/stor
+00021d90: 6167 655f 6465 6d6f 2e79 616d 6c60 2068  age_demo.yaml` h
+00021da0: 6572 652c 2073 696e 6365 2069 7420 7265  ere, since it re
+00021db0: 7175 6972 6573 0a20 2020 2023 2020 7573  quires.    #  us
+00021dc0: 6572 7320 746f 2065 6e73 7572 6520 6275  ers to ensure bu
+00021dd0: 636b 6574 206e 616d 6573 2074 6f20 6e6f  cket names to no
+00021de0: 7420 6578 6973 7420 616e 642f 6f72 2062  t exist and/or b
+00021df0: 6520 756e 6971 7565 2e0a 2020 2020 5f54  e unique..    _T
+00021e00: 4553 545f 5941 4d4c 5f50 4154 4853 203d  EST_YAML_PATHS =
+00021e10: 205b 0a20 2020 2020 2020 2027 6578 616d   [.        'exam
+00021e20: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+00021e30: 6c27 2c20 2765 7861 6d70 6c65 732f 6d61  l', 'examples/ma
+00021e40: 6e61 6765 645f 7370 6f74 2e79 616d 6c27  naged_spot.yaml'
+00021e50: 2c0a 2020 2020 2020 2020 2765 7861 6d70  ,.        'examp
+00021e60: 6c65 732f 7573 696e 675f 6669 6c65 5f6d  les/using_file_m
+00021e70: 6f75 6e74 732e 7961 6d6c 272c 2027 6578  ounts.yaml', 'ex
+00021e80: 616d 706c 6573 2f72 6573 6e65 745f 6170  amples/resnet_ap
+00021e90: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+00021ea0: 2027 6578 616d 706c 6573 2f6d 756c 7469   'examples/multi
+00021eb0: 5f68 6f73 746e 616d 652e 7961 6d6c 270a  _hostname.yaml'.
+00021ec0: 2020 2020 5d0a 0a20 2020 2064 6566 205f      ]..    def _
+00021ed0: 6973 5f64 6963 745f 7375 6273 6574 2873  is_dict_subset(s
+00021ee0: 656c 662c 2064 312c 2064 3229 3a0a 2020  elf, d1, d2):.  
+00021ef0: 2020 2020 2020 2222 2243 6865 636b 2069        """Check i
+00021f00: 6620 6431 2069 7320 7468 6520 7375 6273  f d1 is the subs
+00021f10: 6574 206f 6620 6432 2e22 2222 0a20 2020  et of d2.""".   
+00021f20: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+00021f30: 2064 312e 6974 656d 7328 293a 0a20 2020   d1.items():.   
+00021f40: 2020 2020 2020 2020 2069 6620 6b20 6e6f           if k no
+00021f50: 7420 696e 2064 323a 0a20 2020 2020 2020  t in d2:.       
+00021f60: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00021f70: 7374 616e 6365 2876 2c20 6c69 7374 2920  stance(v, list) 
+00021f80: 6f72 2069 7369 6e73 7461 6e63 6528 762c  or isinstance(v,
+00021f90: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00021fa0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00021fb0: 7274 206c 656e 2876 2920 3d3d 2030 2c20  rt len(v) == 0, 
+00021fc0: 286b 2c20 7629 0a20 2020 2020 2020 2020  (k, v).         
+00021fd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00021fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021ff0: 2061 7373 6572 7420 4661 6c73 652c 2028   assert False, (
+00022000: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
+00022010: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+00022020: 6528 762c 2064 6963 7429 3a0a 2020 2020  e(v, dict):.    
+00022030: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00022040: 7274 2069 7369 6e73 7461 6e63 6528 6432  rt isinstance(d2
+00022050: 5b6b 5d2c 2064 6963 7429 2c20 286b 2c20  [k], dict), (k, 
+00022060: 762c 2064 3229 0a20 2020 2020 2020 2020  v, d2).         
+00022070: 2020 2020 2020 2073 656c 662e 5f69 735f         self._is_
+00022080: 6469 6374 5f73 7562 7365 7428 762c 2064  dict_subset(v, d
+00022090: 325b 6b5d 290a 2020 2020 2020 2020 2020  2[k]).          
+000220a0: 2020 656c 6966 2069 7369 6e73 7461 6e63    elif isinstanc
+000220b0: 6528 762c 2073 7472 293a 0a20 2020 2020  e(v, str):.     
+000220c0: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
+000220d0: 3d3d 2027 6163 6365 6c65 7261 746f 7273  == 'accelerators
+000220e0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+000220f0: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+00022100: 203d 2073 6b79 2e52 6573 6f75 7263 6573   = sky.Resources
+00022110: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00022120: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
+00022130: 2e5f 7365 745f 6163 6365 6c65 7261 746f  ._set_accelerato
+00022140: 7273 2876 2c20 4e6f 6e65 290a 2020 2020  rs(v, None).    
+00022150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022160: 6173 7365 7274 2072 6573 6f75 7263 6573  assert resources
+00022170: 2e61 6363 656c 6572 6174 6f72 7320 3d3d  .accelerators ==
+00022180: 2064 325b 6b5d 2c20 286b 2c20 762c 2064   d2[k], (k, v, d
+00022190: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
+000221a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000221b0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+000221c0: 6572 7420 762e 6c6f 7765 7228 2920 3d3d  ert v.lower() ==
+000221d0: 2064 325b 6b5d 2e6c 6f77 6572 2829 2c20   d2[k].lower(), 
+000221e0: 286b 2c20 762c 2064 325b 6b5d 290a 2020  (k, v, d2[k]).  
+000221f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00022200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022210: 6173 7365 7274 2076 203d 3d20 6432 5b6b  assert v == d2[k
+00022220: 5d2c 2028 6b2c 2076 2c20 6432 5b6b 5d29  ], (k, v, d2[k])
+00022230: 0a0a 2020 2020 6465 6620 5f63 6865 636b  ..    def _check
+00022240: 5f65 7175 6976 616c 656e 7428 7365 6c66  _equivalent(self
+00022250: 2c20 7961 6d6c 5f70 6174 6829 3a0a 2020  , yaml_path):.  
+00022260: 2020 2020 2020 2222 2243 6865 636b 2069        """Check i
+00022270: 6620 7468 6520 7961 6d6c 2069 7320 6571  f the yaml is eq
+00022280: 7569 7661 6c65 6e74 2061 6674 6572 206c  uivalent after l
+00022290: 6f61 6420 616e 6420 6475 6d70 2061 6761  oad and dump aga
+000222a0: 696e 2e22 2222 0a20 2020 2020 2020 206f  in.""".        o
+000222b0: 7269 6769 6e5f 7461 736b 5f63 6f6e 6669  rigin_task_confi
+000222c0: 6720 3d20 636f 6d6d 6f6e 5f75 7469 6c73  g = common_utils
+000222d0: 2e72 6561 645f 7961 6d6c 2879 616d 6c5f  .read_yaml(yaml_
+000222e0: 7061 7468 290a 0a20 2020 2020 2020 2074  path)..        t
+000222f0: 6173 6b20 3d20 736b 792e 5461 736b 2e66  ask = sky.Task.f
+00022300: 726f 6d5f 7961 6d6c 2879 616d 6c5f 7061  rom_yaml(yaml_pa
+00022310: 7468 290a 2020 2020 2020 2020 6e65 775f  th).        new_
+00022320: 7461 736b 5f63 6f6e 6669 6720 3d20 7461  task_config = ta
+00022330: 736b 2e74 6f5f 7961 6d6c 5f63 6f6e 6669  sk.to_yaml_confi
+00022340: 6728 290a 2020 2020 2020 2020 2320 6431  g().        # d1
+00022350: 203c 3d20 6432 0a20 2020 2020 2020 2073   <= d2.        s
+00022360: 656c 662e 5f69 735f 6469 6374 5f73 7562  elf._is_dict_sub
+00022370: 7365 7428 6f72 6967 696e 5f74 6173 6b5f  set(origin_task_
+00022380: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
+00022390: 5f63 6f6e 6669 6729 0a0a 2020 2020 6465  _config)..    de
+000223a0: 6620 7465 7374 5f6c 6f61 645f 6475 6d70  f test_load_dump
+000223b0: 5f79 616d 6c5f 636f 6e66 6967 5f65 7175  _yaml_config_equ
+000223c0: 6976 616c 656e 7428 7365 6c66 293a 0a20  ivalent(self):. 
+000223d0: 2020 2020 2020 2022 2222 5465 7374 2069         """Test i
+000223e0: 6620 7468 6520 7961 6d6c 2063 6f6e 6669  f the yaml confi
+000223f0: 6720 6973 2065 7175 6976 616c 656e 7420  g is equivalent 
+00022400: 6166 7465 7220 6c6f 6164 2061 6e64 2064  after load and d
+00022410: 756d 7020 6167 6169 6e2e 2222 220a 2020  ump again.""".  
+00022420: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
+00022430: 7468 2827 7e2f 6461 7461 7365 7473 2729  th('~/datasets')
+00022440: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
+00022450: 6469 7228 6578 6973 745f 6f6b 3d54 7275  dir(exist_ok=Tru
+00022460: 6529 0a20 2020 2020 2020 2070 6174 686c  e).        pathl
+00022470: 6962 2e50 6174 6828 277e 2f74 6d70 6669  ib.Path('~/tmpfi
+00022480: 6c65 2729 2e65 7870 616e 6475 7365 7228  le').expanduser(
+00022490: 292e 746f 7563 6828 290a 2020 2020 2020  ).touch().      
+000224a0: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
+000224b0: 7e2f 2e73 7368 2729 2e65 7870 616e 6475  ~/.ssh').expandu
+000224c0: 7365 7228 292e 6d6b 6469 7228 6578 6973  ser().mkdir(exis
+000224d0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
+000224e0: 2020 2070 6174 686c 6962 2e50 6174 6828     pathlib.Path(
+000224f0: 277e 2f2e 7373 682f 6964 5f72 7361 2e70  '~/.ssh/id_rsa.p
+00022500: 7562 2729 2e65 7870 616e 6475 7365 7228  ub').expanduser(
+00022510: 292e 746f 7563 6828 290a 2020 2020 2020  ).touch().      
+00022520: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
+00022530: 7e2f 746d 702d 776f 726b 6469 7227 292e  ~/tmp-workdir').
+00022540: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
+00022550: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
+00022560: 290a 2020 2020 2020 2020 7061 7468 6c69  ).        pathli
+00022570: 622e 5061 7468 2827 7e2f 446f 776e 6c6f  b.Path('~/Downlo
+00022580: 6164 732f 7470 7527 292e 6578 7061 6e64  ads/tpu').expand
+00022590: 7573 6572 2829 2e6d 6b64 6972 2870 6172  user().mkdir(par
+000225a0: 656e 7473 3d54 7275 652c 0a20 2020 2020  ents=True,.     
+000225b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225e0: 2020 2020 2020 6578 6973 745f 6f6b 3d54        exist_ok=T
+000225f0: 7275 6529 0a20 2020 2020 2020 2066 6f72  rue).        for
+00022600: 2079 616d 6c5f 7061 7468 2069 6e20 7365   yaml_path in se
+00022610: 6c66 2e5f 5445 5354 5f59 414d 4c5f 5041  lf._TEST_YAML_PA
+00022620: 5448 533a 0a20 2020 2020 2020 2020 2020  THS:.           
+00022630: 2073 656c 662e 5f63 6865 636b 5f65 7175   self._check_equ
+00022640: 6976 616c 656e 7428 7961 6d6c 5f70 6174  ivalent(yaml_pat
+00022650: 6829 0a                                  h).
```

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_spot.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_spot.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_storage.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-nightly-1.0.0.dev20230801/tests/test_wheels.py` & `skypilot-nightly-1.0.0.dev20230802/tests/test_wheels.py`

 * *Files identical despite different names*

